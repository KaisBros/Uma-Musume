<!doctype html>

<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Truy·ªÅn Thuy·∫øt H·ªçc vi·ªán Tracen</title>

    <meta name="description" content="H·ªçc vi·ªán Tracen: Chuy·ªán l·∫° - Giao di·ªán ti·ªÉu thuy·∫øt tr·ª±c quan kinh d·ªã" />

    <script>
      (function () {
        const perfData = {
          pageLoadStart: performance.timing ? performance.timing.navigationStart : performance.now(),
          resourceTimings: [],
        };
        if ('PerformanceObserver' in window) {
          const observer = new PerformanceObserver(list => {
            for (const entry of list.getEntries()) {
              if (entry.entryType === 'resource') {
                perfData.resourceTimings.push({
                  name: entry.name,
                  duration: entry.duration.toFixed(2),
                  size: entry.transferSize || 0,
                });
              }
            }
          });
          observer.observe({ entryTypes: ['resource'] });
        }
        window.addEventListener('load', () => {
          setTimeout(() => {
            const loadTime = performance.timing
              ? performance.timing.loadEventEnd - performance.timing.navigationStart
              : performance.now() - perfData.pageLoadStart;

            console.log('‚è±Ô∏è [Hi·ªáu nƒÉng] ========== B√°o c√°o hi·ªáu nƒÉng t·∫£i trang ==========');
            console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] T·ªïng th·ªùi gian t·∫£i trang: ${loadTime.toFixed(2)}ms`);

            if (performance.timing) {
              const timing = performance.timing;
              console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] Truy v·∫•n DNS: ${(timing.domainLookupEnd - timing.domainLookupStart).toFixed(2)}ms`);
              console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] K·∫øt n·ªëi TCP: ${(timing.connectEnd - timing.connectStart).toFixed(2)}ms`);
              console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] Ph·∫£n h·ªìi y√™u c·∫ßu: ${(timing.responseEnd - timing.requestStart).toFixed(2)}ms`);
              console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] Ph√¢n t√≠ch DOM: ${(timing.domComplete - timing.domInteractive).toFixed(2)}ms`);
            }

            if (perfData.resourceTimings.length > 0) {
              console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] Th·ªëng k√™ t·∫£i t√†i nguy√™n (${perfData.resourceTimings.length} t√†i nguy√™n):`);
              perfData.resourceTimings
                .sort((a, b) => parseFloat(b.duration) - parseFloat(a.duration))
                .slice(0, 5)
                .forEach(resource => {
                  console.log(
                    `  - ${resource.name.split('/').pop()}: ${resource.duration}ms (${(resource.size / 1024).toFixed(2)}KB)`,
                  );
                });
            }
            console.log('‚è±Ô∏è [Hi·ªáu nƒÉng] ============================================');
          }, 100);
        });
      })();
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Noto+Serif+SC:wght@400;500;600&display=swap"
      rel="stylesheet"
      media="print"
      onload="this.media='all'; this.onload=null;"
    />

    <noscript>
      <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Noto+Serif+SC:wght@400;500;600&display=swap"
        rel="stylesheet"
      />
    </noscript>

    <link rel="preload" href="/app.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <noscript><link rel="stylesheet" href="/app.css" /></noscript>

    <script>
      var e = Object.defineProperty,
        t = (t, n, s) => (
          ((t, n, s) => {
            n in t ? e(t, n, { enumerable: !0, configurable: !0, writable: !0, value: s }) : (t[n] = s);
          })(t, 'symbol' != typeof n ? n + '' : n, s),
          s
        );

      !(function () {
        const e = document.createElement('link').relList;

        if (!(e && e.supports && e.supports('modulepreload'))) {
          for (const e of document.querySelectorAll('link[rel="modulepreload"]')) t(e);

          new MutationObserver(e => {
            for (const n of e)
              if ('childList' === n.type)
                for (const e of n.addedNodes) 'LINK' === e.tagName && 'modulepreload' === e.rel && t(e);
          }).observe(document, { childList: !0, subtree: !0 });
        }

        function t(e) {
          if (e.ep) return;

          e.ep = !0;

          const t = (function (e) {
            const t = {};

            return (
              e.integrity && (t.integrity = e.integrity),
              e.referrerPolicy && (t.referrerPolicy = e.referrerPolicy),
              'use-credentials' === e.crossOrigin
                ? (t.credentials = 'include')
                : 'anonymous' === e.crossOrigin
                  ? (t.credentials = 'omit')
                  : (t.credentials = 'same-origin'),
              t
            );
          })(e);

          fetch(e.href, t);
        }
      })();

      const n = new (class {
        constructor() {
          if (typeof window.eventEmit === 'undefined' || typeof window.eventOn === 'undefined') {
            console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y h√†m to√†n c·ª•c MVU, c√≥ th·ªÉ ·∫£nh h∆∞·ªüng ƒë·∫øn ch·ª©c nƒÉng MVU');
            console.log(
              'C√°c h√†m to√†n c·ª•c kh·∫£ d·ª•ng:',
              Object.keys(window).filter(key => typeof window[key] === 'function'),
            );
          }
          this.statusAnimationActive = false;
          this.lastExtractedJourney = null; 
          this.lastExtractedCoreMemory = null; 
          this.lastWrittenJourney = null; 
          this.lastWrittenCoreMemory = null; 
          this.isAutoWriteEnabled = true; 
          this.unifiedIndex = 1; 
          this.autoWriteIntervalId = null; 
          const savedAutoSaveState = localStorage.getItem('teresen_auto_save_enabled');
          this.isAutoSaveEnabled = savedAutoSaveState !== 'false'; 
          this.pendingAutoSave = null; 
          this.lastValidStoryContentBeforeGeneration = ''; 
          this.chatHistoryCache = []; 
          this.historyViewIndex = -1; 
          this.isStreaming = false; 

          (t(this, 'updateInterval', null),
            t(this, 'isInitialized', !1),
            console.log('üéÆ Tr√¨nh qu·∫£n l√Ω giao di·ªán MVU H·ªçc vi·ªán Tracen: Chuy·ªán l·∫° ƒë√£ ƒë∆∞·ª£c t·∫°o'));
        }

        async init() {
          const initStart = performance.now();
          console.log('‚è±Ô∏è [Hi·ªáu nƒÉng] ========== B·∫Øt ƒë·∫ßu kh·ªüi t·∫°o ==========');

          if (!this.isInitialized) {
            if ((console.group('üöÄ Kh·ªüi t·∫°o giao di·ªán MVU H·ªçc vi·ªán Tracen: Chuy·ªán l·∫°'), void 0 === window.TavernHelper)) {
              const initEnd = performance.now();
              console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] Kh·ªüi t·∫°o th·∫•t b·∫°i (Kh√¥ng t√¨m th·∫•y TavernHelper), t·ªën: ${(initEnd - initStart).toFixed(2)}ms`);
              return (console.error('‚ùå Kh√¥ng t√¨m th·∫•y m√¥i tr∆∞·ªùng TavernHelper'), void console.groupEnd());
            }

            console.log('‚úÖ ƒê√£ t√¨m th·∫•y m√¥i tr∆∞·ªùng TavernHelper');

            console.log('üîß Thi·∫øt l·∫≠p tr√¨nh l·∫Øng nghe s·ª± ki·ªán...');
            this.setupEventListeners();

            console.log('üîß Thi·∫øt l·∫≠p l·ªánh console...');
            this.setupConsoleCommands();

            console.log('üîÑ Thi·∫øt l·∫≠p l·∫Øng nghe c·∫≠p nh·∫≠t lu·ªìng...');
            this.setupStreamListeners();
            const checkStart = performance.now();
            await this._checkNewGameSession();
            const checkEnd = performance.now();
            console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] _checkNewGameSession t·ªën: ${(checkEnd - checkStart).toFixed(2)}ms`);
            console.log('üîÑ Kh√¥i ph·ª•c tr·∫°ng th√°i bi·∫øn...');
            const restoreStart = performance.now();
            await this.restoreVariableStateFromLastMessage();
            const restoreEnd = performance.now();
            console.log(
              `‚è±Ô∏è [Hi·ªáu nƒÉng] restoreVariableStateFromLastMessage t·ªën: ${(restoreEnd - restoreStart).toFixed(2)}ms`,
            );

            console.log('üîÑ C·∫≠p nh·∫≠t giao di·ªán...');
            const interfaceStart = performance.now();
            await this.updateInterface();
            const interfaceEnd = performance.now();
            console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] updateInterface t·ªïng th·ªùi gian: ${(interfaceEnd - interfaceStart).toFixed(2)}ms`);
            this.loadSettings && this.loadSettings();
            this.checkAutoFullscreen();

            console.log('‚è∞ Kh·ªüi ƒë·ªông b·ªô ƒë·∫øm th·ªùi gian ph·∫£n h·ªìi...');
            this.startReplyTimer();
            this.setupStoryActionButtons();

            this.updateInterval = setInterval(async () => {
              await this.updateInterface();
            }, 2e3);

            this.isInitialized = !0;

            console.log('‚úÖ Ho√†n t·∫•t kh·ªüi t·∫°o giao di·ªán MVU');

            const initEnd = performance.now();
            const totalInitTime = (initEnd - initStart).toFixed(2);
            console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] ========== Ho√†n t·∫•t kh·ªüi t·∫°o, t·ªïng th·ªùi gian: ${totalInitTime}ms ==========`);
            console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] Th·ªëng k√™ th·ªùi gian t·ª´ng b∆∞·ªõc kh·ªüi t·∫°o:`);
            console.log(`  - _checkNewGameSession: ${(checkEnd - checkStart).toFixed(2)}ms`);
            if (typeof restoreEnd !== 'undefined' && typeof restoreStart !== 'undefined') {
              console.log(`  - restoreVariableStateFromLastMessage: ${(restoreEnd - restoreStart).toFixed(2)}ms`);
            }
            console.log(`  - updateInterface: ${(interfaceEnd - interfaceStart).toFixed(2)}ms`);

            console.groupEnd();
          }
        }
        debugMVUEnvironment() {
          console.group('üîç Ch·∫©n ƒëo√°n m√¥i tr∆∞·ªùng MVU');
          console.log('window.eventEmit:', typeof window.eventEmit);
          console.log('window.eventOn:', typeof window.eventOn);
          console.log('getAllVariables:', typeof this.getAllVariables);
          console.log('window.Mvu:', window.Mvu);
          console.log('window.mag_invoke_mvu:', typeof window.mag_invoke_mvu);
          console.log('window.TavernHelper:', window.TavernHelper);
          try {
            const currentVars = this.getAllVariables();
            console.log('Tr·∫°ng th√°i bi·∫øn hi·ªán t·∫°i:', currentVars);
          } catch (e) {
            console.error('L·∫•y bi·∫øn th·∫•t b·∫°i:', e);
          }

          console.groupEnd();
        }
        setupMVUListeners() {
          console.log('üîß Thi·∫øt l·∫≠p tr√¨nh l·∫Øng nghe s·ª± ki·ªán MVU...');
          if (typeof window.eventOn === 'function') {
            window.eventOn('mag_variable_updated', (statData, path, oldValue, newValue) => {
              console.log('‚úÖ S·ª± ki·ªán c·∫≠p nh·∫≠t bi·∫øn MVU:', path, oldValue, '‚Üí', newValue);
            });

            window.eventOn('mag_variable_update_ended', variables => {
              console.log('‚úÖ S·ª± ki·ªán ho√†n t·∫•t c·∫≠p nh·∫≠t bi·∫øn MVU:', variables);
            });

            window.eventOn('mag_variable_update_started', variables => {
              console.log('üîÑ S·ª± ki·ªán b·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t bi·∫øn MVU:', variables);
            });

            console.log('‚úÖ Ho√†n t·∫•t thi·∫øt l·∫≠p tr√¨nh l·∫Øng nghe s·ª± ki·ªán MVU');
          } else {
            console.warn('‚ö†Ô∏è H√†m window.eventOn kh√¥ng kh·∫£ d·ª•ng, kh√¥ng th·ªÉ thi·∫øt l·∫≠p tr√¨nh l·∫Øng nghe s·ª± ki·ªán MVU');
            console.log(
              'C√°c h√†m to√†n c·ª•c kh·∫£ d·ª•ng:',
              Object.keys(window).filter(key => typeof window[key] === 'function'),
            );
          }
        }

        setupEventListeners() {
          $(document).ready(() => {
            (console.log('üîß S·ª≠ d·ª•ng jQuery ƒë·ªÉ thi·∫øt l·∫≠p tr√¨nh l·∫Øng nghe s·ª± ki·ªán...'),
              $('#fullscreen-btn').on('click', () => this.toggleFullscreen()),
              $('#fullscreen-btn-right').on('click', () => this.toggleFullscreen()),
              $('#debug-btn').on('click', () => this.debugVariables()),
              $('#btn-send-action').on('click', async () => {
                await this.handleActionSubmit();
              }),
              this.setupEnterToSend(),
              this.initQuickActionModal(),
              this.initQuickPositionModal(),
              $('#profile-expand').on('click', () => this.toggleProfile()),
              $('#sex-position-expand').on('click', () => this.toggleSexPosition()),
              $('#task-list-expand').on('click', () => this.toggleTaskList()),
              $(document).on('click', '#profile-avatar', () => {
                this.showAvatarSelector();
              }),
              $('#card-display-btn').on('click', () => this.showCardDisplayModal()),
              $('#close-card-display-btn').on('click', () => {
                const modal = document.getElementById('card-display-modal');
                if (modal) {
                  modal.style.display = 'none';
                  const overlay = document.getElementById('teresen-fullscreen-overlay');
                  if (overlay && modal.parentNode === overlay) {
                    const originalParent = modal.dataset.originalParent;
                    if (originalParent === 'BODY' || !originalParent) {
                      document.body.appendChild(modal);
                    }
                  }
                }
              }),
              $('#manage-talents-btn').on('click', () => this.showTalentsModal()),
              $('#manage-talents-btn-inner').on('click', () => this.showTalentsModal()),
              $('#close-talents-btn').on('click', () => {
                this.closeTalentsModal();
              }),
              $('#talents-modal').on('click', e => {
                if (e.target.id === 'talents-modal') {
                  this.closeTalentsModal();
                }
              }),
              $('#settings-btn').on('click', () => {
                console.log('üéØ N√∫t c√†i ƒë·∫∑t ƒë√£ ƒë∆∞·ª£c nh·∫•n!');
                const e = document.getElementById('settings-modal');
                if (e) {
                  console.log('‚úÖ Hi·ªÉn th·ªã modal c√†i ƒë·∫∑t');
                  (() => {
                    const overlay = document.getElementById('teresen-fullscreen-overlay');
                    if (overlay && e.parentNode !== overlay) {
                      e.dataset.originalParent = e.parentNode?.tagName || 'BODY';
                      overlay.appendChild(e);
                      console.log('‚úÖ settings-modal ƒë√£ ƒë∆∞·ª£c di chuy·ªÉn v√†o b√™n trong l·ªõp ph·ªß');
                    }
                  })();
                  e.style.display = 'flex';
                  this.restoreSettingsToUI();
                } else {
                  console.error('‚ùå Kh√¥ng t√¨m th·∫•y modal c√†i ƒë·∫∑t');
                }
              }),
              $('#teresen-settings-close-btn').on('click', () => {
                $('#settings-modal').hide();
              }),
              $('#settings-modal').on('click', e => {
                e.target === e.currentTarget && $('#settings-modal').hide();
              }),
              $('#settings-modal .font-option-btn').on('click', function () {
                $('#settings-modal .font-option-btn').removeClass('selected').css({
                  background: 'rgba(139, 105, 20, 0.05)',
                  'border-color': 'rgba(139, 105, 20, 0.3)',
                });
                $(this).addClass('selected').css({
                  background: 'rgba(139, 105, 20, 0.2)',
                  'border-color': 'rgba(139, 105, 20, 0.6)',
                });
                const font = $(this).data('font');
                $('#font-preview').css('font-family', font);
              }),
              $('#settings-modal .font-size-btn').on('click', function () {
                $('#settings-modal .font-size-btn').removeClass('selected').css({
                  background: 'rgba(139, 105, 20, 0.05)',
                  'border-color': 'rgba(139, 105, 20, 0.3)',
                });
                $(this).addClass('selected').css({
                  background: 'rgba(139, 105, 20, 0.2)',
                  'border-color': 'rgba(139, 105, 20, 0.6)',
                });
                const size = $(this).data('size');
                $('#font-preview').css('font-size', size + 'em');
              }),
              $('#settings-modal .bg-option-btn').on('click', function () {
                $('#settings-modal .bg-option-btn').removeClass('selected').css({
                  background: 'rgba(139, 105, 20, 0.05)',
                  'border-color': 'rgba(139, 105, 20, 0.3)',
                  color: '#2d2d2d',
                });
                $(this).addClass('selected');
                const bgType = $(this).data('bg-type');
                if (bgType === 'black') {
                  $(this).css({
                    background: 'rgba(0, 0, 0, 0.85)',
                    color: '#fff',
                  });
                } else {
                  $(this).css({
                    background: 'rgba(139, 105, 20, 0.2)',
                    'border-color': 'rgba(139, 105, 20, 0.6)',
                  });
                }
                if (bgType === 'image') {
                  $('#bg-image-upload').show();
                } else {
                  $('#bg-image-upload').hide();
                }
              }),
              (() => {
                const presetImages = [
                  'https://i.ibb.co/ZC5d43W/7gjs8m.webp',
                  'https://i.ibb.co/SDHnTQ16/oq2h66.jpg',
                  'https://i.ibb.co/5hPdPJ3K/539zn7.jpg',
                  'https://i.ibb.co/fVtKNzPz/lgxdwg.png',
                  'https://i.ibb.co/gFM1ZQNh/91sb56.png',
                  'https://i.ibb.co/CpcnhfMM/xg93zf.jpg',
                  'https://i.ibb.co/5XBmfybS/fo0wn5.jpg',
                  'https://i.ibb.co/VWD4wM4V/cs0ovj.jpg',
                  'https://i.ibb.co/8LvKmBkS/fdk1y8.jpg',
                  'https://i.ibb.co/PvDg0Pss/pa9p00.jpg',
                  'https://i.ibb.co/ymP5yxGy/2wpwlg.jpg',
                  'https://i.ibb.co/rGKyMWdz/yux828.jpg',
                  'https://i.ibb.co/8nyfKMKR/dedwqz.jpg',
                  'https://i.ibb.co/C5Gh2ySB/v8bbky.jpg',
                  'https://i.ibb.co/7J9JdC4S/k6xrci.jpg',
                  'https://i.ibb.co/5hYrh4pF/yls8nv.jpg',
                  'https://i.ibb.co/DPjm1Pg8/wn4s3w.jpg',
                  'https://i.ibb.co/MxxWnfsJ/rjchsc.jpg',
                  'https://i.ibb.co/PSgVSDh/sdyxal.jpg',
                  'https://i.ibb.co/Pv1cfd9J/j6s7vg.jpg',
                  'https://i.ibb.co/DNHbBG2/vtn448.jpg',
                  'https://i.ibb.co/JjGKC7rM/08474v.jpg',
                  'https://i.ibb.co/G4XDn0Gf/uqvwrx.jpg',
                  'https://i.ibb.co/zVmQTGz0/anzvoc.jpg',
                ];

                const grid = $('#preset-images-grid');
                presetImages.forEach((url, index) => {
                  const imgItem = $(`
                    <div class="preset-image-item" data-url="${url}" style="
                      position: relative;
                      width: 100%;
                      aspect-ratio: 1;
                      border: 2px solid rgba(139, 105, 20, 0.3);
                      border-radius: 6px;
                      overflow: hidden;
                      cursor: pointer;
                      transition: all 0.2s;
                      background: rgba(139, 105, 20, 0.05);
                    ">
                      <img src="${url}" style="
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                        display: block;
                      " onerror="this.parentElement.style.display='none'">
                    </div>
                  `);

                  imgItem.on('click', function () {
                    $('.preset-image-item').css({
                      'border-color': 'rgba(139, 105, 20, 0.3)',
                      transform: 'scale(1)',
                      'box-shadow': 'none',
                    });
                    $(this).css({
                      'border-color': 'rgba(139, 105, 20, 0.8)',
                      transform: 'scale(1.05)',
                      'box-shadow': '0 4px 8px rgba(139, 105, 20, 0.4)',
                    });
                    const selectedUrl = $(this).data('url');
                    $('#bg-image-url').val(selectedUrl);
                    $('#bg-preview-img').attr('src', selectedUrl);
                    $('#bg-image-preview').show();
                  });

                  imgItem.on('mouseenter', function () {
                    if (!$(this).css('border-color').includes('0.8')) {
                      $(this).css('border-color', 'rgba(139, 105, 20, 0.5)');
                    }
                  });

                  imgItem.on('mouseleave', function () {
                    if (!$(this).css('border-color').includes('0.8')) {
                      $(this).css('border-color', 'rgba(139, 105, 20, 0.3)');
                    }
                  });

                  grid.append(imgItem);
                });
              })(),
              $('#bg-image-load-btn').on('click', function () {
                const url = $('#bg-image-url').val();
                if (url) {
                  $('#bg-preview-img').attr('src', url);
                  $('#bg-image-preview').show();
                  $('.preset-image-item').css({
                    'border-color': 'rgba(139, 105, 20, 0.3)',
                    transform: 'scale(1)',
                    'box-shadow': 'none',
                  });
                }
              }),
              $('#bg-image-delete-btn').on('click', function () {
                $('#bg-preview-img').attr('src', '');
                $('#bg-image-url').val('');
                $('#bg-image-preview').hide();
                localStorage.removeItem('teresen_fullscreen_background_image');
                $('.preset-image-item').css({
                  'border-color': 'rgba(139, 105, 20, 0.3)',
                  transform: 'scale(1)',
                  'box-shadow': 'none',
                });
                if ($('.bg-option-btn.selected').data('bg-type') === 'image') {
                  $('.bg-option-btn[data-bg-type="black"]').click();
                }
              }),
              $('#apply-settings-btn').on('click', async () => {
                await this.applySettings();
                $('#settings-modal').hide();
              }),
              $('#reset-settings-btn').on('click', () => {
                this.resetSettings();
              }),
              $('#clear-cache-btn').on('click', () => {
                this.clearCache();
              }),
              this.setupRulesModal(),
              this.setupLoadModal(),
              this.setupHistoryModal(),
              this.setupSettingsModal(),
              this.loadProfileAvatar(),
              this.setupMVUListeners(),
              document.addEventListener('fullscreenchange', () => this.handleFullscreenChange()),
              document.addEventListener('webkitfullscreenchange', () => this.handleFullscreenChange()),
              document.addEventListener('mozfullscreenchange', () => this.handleFullscreenChange()),
              document.addEventListener('MSFullscreenChange', () => this.handleFullscreenChange()),
              console.log('‚úÖ Ho√†n t·∫•t thi·∫øt l·∫≠p tr√¨nh l·∫Øng nghe s·ª± ki·ªán'));
          });
        }

        async updateInterface() {
          try {

            const rightPanelContent = document.querySelector('.right-panel .panel-content');

            const leftPanelContent = document.querySelector('.left-panel .panel-content');

            const savedRightScrollTop = rightPanelContent ? rightPanelContent.scrollTop : 0;

            const savedLeftScrollTop = leftPanelContent ? leftPanelContent.scrollTop : 0;

            (this.updateTrainerStatus(),
              this.updateUmaStatus(),
              this.updateTimeDisplay(),
              this.updateReplyTimer(),
              this.updateLocationImage(),
              this.initSexPositionSection(),
              this.updateSexPositionImage(),
              this.updateTaskList());
            await this.updateBackRerollButtonsState();

            const e = Date.now();

            const lastUpdate = parseInt(localStorage.getItem('teresen_last_full_update') || '0');

            const isFirstLoad = lastUpdate === 0;

            const shouldUpdate = isFirstLoad || e - lastUpdate > 1e4;

            if (shouldUpdate) {
              console.log('üîÑ Th·ª±c hi·ªán c·∫≠p nh·∫≠t giao di·ªán ƒë·∫ßy ƒë·ªß...');
              const updateStart = performance.now();

              await this.updateStoryContent();

              const updateEnd = performance.now();
              console.log(
                `‚è±Ô∏è [Hi·ªáu nƒÉng] updateStoryContent trong updateInterface t·ªën: ${(updateEnd - updateStart).toFixed(2)}ms`,
              );

              this.updateInventory();

              this.updateRules();

              this.updateCurrencySystem();

              this.updateFestivalNotice();

              this.updateRulesCountdown();

              this.updateLocation();

              this.updateGachaCoin();

              localStorage.setItem('teresen_last_full_update', e.toString());

              console.log('‚úÖ Ho√†n t·∫•t c·∫≠p nh·∫≠t giao di·ªán ƒë·∫ßy ƒë·ªß');
            }

            setTimeout(() => {
              if (rightPanelContent && savedRightScrollTop > 0) {
                rightPanelContent.scrollTop = savedRightScrollTop;
              }

              if (leftPanelContent && savedLeftScrollTop > 0) {
                leftPanelContent.scrollTop = savedLeftScrollTop;
              }
            }, 0);
          } catch (e) {
            console.error('L·ªói khi c·∫≠p nh·∫≠t giao di·ªán:', e);
          }
        }

        async updateDynamicData() {
          try {
            console.log('üîÑ B·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t d·ªØ li·ªáu ƒë·ªông...');

            this.updateTrainerStatus();

            this.updateUmaStatus();

            this.updateLocationImage();

            this.updateTaskList();

            this.updateSexPositionImage();
            this.showUmaExpression(null);

            this.updateTimeDisplay();

            this.updateReplyTimer();
            this.updateTaskList();

            await this.updateStoryContent();

            this.updateInventory();

            this.updateRules();

            this.updateCurrencySystem();

            this.updateFestivalNotice();

            this.updateRulesCountdown();

            this.updateLocation();

            this.updateGachaCoin();

            console.log('‚úÖ Ho√†n t·∫•t c·∫≠p nh·∫≠t d·ªØ li·ªáu ƒë·ªông');
          } catch (error) {
            console.error('‚ùå L·ªói khi c·∫≠p nh·∫≠t d·ªØ li·ªáu ƒë·ªông:', error);
          }
        }

        getAllVariables() {
          if (this.currentMvuState && this.currentMvuState.stat_data) {
            console.log('‚úÖ S·ª≠ d·ª•ng d·ªØ li·ªáu m·ªõi nh·∫•t tr·∫£ v·ªÅ t·ª´ MVU');
            return this.currentMvuState;
          }

          if ((console.group('üîç L·∫•y th√¥ng tin g·ª° l·ªói bi·∫øn'), 'function' == typeof getAllVariables)) {
            console.log('‚úÖ H√†m getAllVariables t·ªìn t·∫°i, ƒëang g·ªçi...');

            const e = getAllVariables();

            return (
              console.log('üìä D·ªØ li·ªáu bi·∫øn l·∫•y ƒë∆∞·ª£c:', e),
              e && e.stat_data
                ? (console.log('‚úÖ T√¨m th·∫•y c·∫•u tr√∫c stat_data'),
                  console.log('üèÉ D·ªØ li·ªáu Hu·∫•n luy·ªán vi√™n:', e.stat_data.trainer),
                  console.log('üåç D·ªØ li·ªáu Th·∫ø gi·ªõi:', e.stat_data.world),
                  console.log('üêé D·ªØ li·ªáu Uma Musume:', e.stat_data.umaMusume),
                  e.stat_data.rules && console.log('üìú D·ªØ li·ªáu Quy t·∫Øc:', e.stat_data.rules),
                  e.stat_data.outerGods && console.log('üëπ D·ªØ li·ªáu Ngo·∫°i th·∫ßn:', e.stat_data.outerGods))
                : (console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y c·∫•u tr√∫c stat_data'), console.log('üîç K·∫øt qu·∫£ tr·∫£ v·ªÅ ƒë·∫ßy ƒë·ªß:', e)),
              console.groupEnd(),
              e
            );
          }

          return (
            console.error('‚ùå H√†m getAllVariables kh√¥ng t·ªìn t·∫°i'),
            console.log(
              'üîç H√†m to√†n c·ª•c hi·ªán t·∫°i:',

              Object.keys(window).filter(e => 'function' == typeof window[e]),
            ),
            console.groupEnd(),
            {}
          );
        }
        renderUI(data) {
          if (!data) {
            console.warn('RenderUI g·ªçi th·∫•t b·∫°i: Kh√¥ng c√≥ d·ªØ li·ªáu ƒë∆∞·ª£c cung c·∫•p.');
            return;
          }

          console.log('üîÑ B·∫Øt ƒë·∫ßu render UI, d·ªØ li·ªáu:', data);

          try {
            if (this.currentMvuState && this.currentMvuState.stat_data) {
              console.log('‚úÖ S·ª≠ d·ª•ng d·ªØ li·ªáu m·ªõi nh·∫•t tr·∫£ v·ªÅ t·ª´ MVU ƒë·ªÉ render UI');
              this._forceRefreshVariables();
            }
            this.updateTrainerStatus();
            this.updateUmaStatus();
            this.updateTimeDisplay();
            this.updateReplyTimer();
            this.updateTaskList();
            this.updateStoryContent();
            this.updateInventory();
            this.updateRules();
            this.updateCurrencySystem();
            this.updateFestivalNotice();
            this.updateRulesCountdown();
            this.updateLocation();
            this.updateGachaCoin();

            console.log('‚úÖ Ho√†n t·∫•t render UI');
          } catch (error) {
            console.error('‚ùå Render UI th·∫•t b·∫°i:', error);
          }
        }
        _forceRefreshVariables() {
          try {
            console.log('üîÑ B·∫Øt bu·ªôc l√†m m·ªõi tr·∫°ng th√°i bi·∫øn...');
            if (this.currentMvuState && this.currentMvuState.stat_data) {
              console.log('‚úÖ Ph√°t hi·ªán tr·∫°ng th√°i MVU m·ªõi, b·∫Øt bu·ªôc l√†m m·ªõi bi·∫øn');

              console.log('üìä D·ªØ li·ªáu tr·∫°ng th√°i MVU m·ªõi:', this.currentMvuState.stat_data);
            }
          } catch (error) {
            console.error('‚ùå B·∫Øt bu·ªôc l√†m m·ªõi bi·∫øn th·∫•t b·∫°i:', error);
          }
        }

        updateTrainerStatus() {
          const e = this.getAllVariables(),
            t = this.getVariable(e, 'stat_data.trainer.stamina', 100),
            n = this.getVariable(e, 'stat_data.trainer.sanity', 100),
            s = this.getVariable(e, 'stat_data.trainer.luck', 50),
            o = this.getVariable(e, 'stat_data.trainer.daysInSchool', 0),
            b = this.getVariable(e, 'stat_data.trainer.background', 'Kh√¥ng'),
            talent = this.getVariable(e, 'stat_data.trainer.talent.majorTalent.name', 'Kh√¥ng'),
            title = this.getVariable(e, 'stat_data.trainer.title', 'M·ªõi v√†o th·∫ø gi·ªõi');
          const selfControl = this.getVariable(e, 'stat_data.trainer.selfControl', 100);
          const power = this.getVariable(e, 'stat_data.trainer.power', 5);
          const skill = this.getVariable(e, 'stat_data.trainer.technique', 5);
          const crystalsValue = this.getVariable(e, 'stat_data.trainer.twistedAffectionCrystals', 0);
          const crystals = parseInt(crystalsValue) || 0;
          if (crystals === 0 && e && e.stat_data && e.stat_data.trainer) {
            console.log('üíé G·ª° l·ªói ƒë·ªçc k·∫øt tinh:', {
              crystalsValue: crystalsValue,
              parsed: crystals,
              hasTrainer: !!e.stat_data.trainer,
              crystalsArray: e.stat_data.trainer.twistedAffectionCrystals,
              crystalsArrayType: typeof e.stat_data.trainer.twistedAffectionCrystals,
              isArray: Array.isArray(e.stat_data.trainer.twistedAffectionCrystals),
            });
          }

          this.updateProgressBar('stamina-bar', 'stamina-value', t, this.getStaminaColor(t));

          this.updateProgressBar('sanity-bar', 'sanity-value', n, this.getSanityColor(n));

          this.updateProgressBar(
            'self-control-bar',
            'self-control-value',
            selfControl,
            this.getSelfControlColor(selfControl),
          );

          this.updateProgressBar('luck-bar', 'luck-value', s, this.getLuckColor(s));
          const powerValueEl = document.getElementById('power-value');
          if (powerValueEl) powerValueEl.textContent = power;

          const skillValueEl = document.getElementById('skill-value');
          if (skillValueEl) skillValueEl.textContent = skill;

          const a = document.getElementById('trainer-status'),
            l = document.getElementById('days-in-park'),
            bg = document.getElementById('trainer-background'),
            cry = document.getElementById('trainer-crystals'),
            titleEl = document.getElementById('trainer-title');

          if (a) {
            const statusText = this.getTrainerStatusText(n, t);

            a.textContent = statusText;

            a.className = `value ${this.getTrainerStatusClass(n, t)}`;
          }

          if (l) {
            l.textContent = `${o} ng√†y`;
          }

          if (titleEl) {
            titleEl.textContent = title || 'M·ªõi v√†o th·∫ø gi·ªõi';
          }

          if (bg) {
            bg.textContent = b;
          }

          if (cry) {
            cry.textContent = crystals;
          }
        }

        updateUmaStatus() {
          const e = document.getElementById('uma-status');

          if (!e) return;

          const t = this.getAllVariables();

          console.log('üîç T·∫•t c·∫£ bi·∫øn:', t);

          const n = this.getVariable(t, 'stat_data.umaMusume', {});

          if ((console.log('üêé D·ªØ li·ªáu Uma Musume:', n), !n || 0 === Object.keys(n).length))
            return void (e.innerHTML = '<div class="empty-uma">T·∫°m kh√¥ng c√≥ d·ªØ li·ªáu Uma Musume</div>');

          let umaContent = e.querySelector('.uma-content');

          if (!umaContent) {
            e.innerHTML = '<div class="uma-content"></div>';

            umaContent = e.querySelector('.uma-content');
          }

          Object.keys(n).forEach((umaName, index) => {
            const n = this.getVariable(t, `stat_data.umaMusume.${umaName}.affection`, 20),
              o = this.getVariable(t, `stat_data.umaMusume.${umaName}.status`, 'B√¨nh th∆∞·ªùng'),
              a = this.getUmaDescription(umaName, n, o),
              l = this.getUmaStatusClass(o),
              r = Math.max(1, Math.floor(n / 20)),
              i = this.getUmaAvatar(umaName),
              c = this.getVariable(t, 'stat_data.world.currentTime', '06:00'),
              d = this.getTimeDangerLevel(c),
              g = this.getVariable(t, `stat_data.umaMusume.${umaName}.possessiveness`, 0),
              u = this.getAvatarStyle(g, d);

            let umaItem = umaContent.children[index];

            if (!umaItem) {
              umaItem = document.createElement('div');

              umaItem.className = 'uma-item';

              umaContent.appendChild(umaItem);
            }

            const nameColor = this.getUmaNameColor(n, g);

            const statusColor = this.getUmaStatusColor(o, g, index);

            const statusBackground = this.getStatusBackgroundColor(o, g, index);

            umaItem.innerHTML = `

              <div class="uma-header">

                                  <div class="uma-info">

                    ${i ? `<img src="${i}" alt="${umaName}" class="uma-avatar" style="${u}">` : ''}

                    <div class="uma-text-info">

                      <div class="uma-name" style="color: ${nameColor}">${umaName}</div>
                      <div class="uma-status-text" style="color: ${statusColor}">${o}</div>

                    </div>

                  </div>

              </div>

              <div class="uma-desc">${a}</div>

              <div class="uma-hearts">

                ${this.generateHeartIcons(r)}

              </div>

            `;
            umaItem.style.setProperty('background', '#fdfbf7', 'important');
            umaItem.style.setProperty('background-color', '#fdfbf7', 'important');

            if (g > 30) {

              const canvas = document.createElement('canvas');

              canvas.width = 200;

              canvas.height = 200;

              canvas.style.cssText = `

                position: absolute;

                top: 50%;

                right: -20px;

                transform: translateY(-50%);

                width: 80px;

                height: 80px;

                pointer-events: none;

                z-index: 1;

                opacity: 0.4;

                filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.6));

              `;

              const ctx = canvas.getContext('2d');

              const progress = g / 100;

              ctx.save();

              ctx.translate(100, 100);

              let flowerColor, petalCount, petalSize;

              if (g > 90) {

                flowerColor = '#8B0000';

                petalCount = 8;

                petalSize = 25;
              } else if (g > 80) {

                flowerColor = '#DC143C';

                petalCount = 7;

                petalSize = 25;
              } else if (g > 70) {

                flowerColor = '#EF4444';

                petalCount = 6;

                petalSize = 25;
              } else if (g > 60) {

                flowerColor = '#F87171';

                petalCount = 6;

                petalSize = 25;
              } else if (g > 50) {

                flowerColor = '#FCA5A5';

                petalCount = 5;

                petalSize = 25;
              } else if (g > 40) {

                flowerColor = '#FFFFFF';

                petalCount = 5;

                petalSize = 25;
              } else {

                flowerColor = '#FFFFFF';

                petalCount = 4;

                petalSize = 25;
              }

              for (let i = 0; i < petalCount; i++) {
                ctx.save();

                ctx.rotate(((Math.PI * 2) / petalCount) * i);

                ctx.beginPath();

                ctx.moveTo(0, 0);

                ctx.bezierCurveTo(
                  petalSize * 0.3,
                  -petalSize * 0.4,

                  petalSize * 0.7,
                  -petalSize * 0.3,

                  petalSize * 0.8,
                  0,
                );

                ctx.bezierCurveTo(
                  petalSize * 0.7,
                  petalSize * 0.3,

                  petalSize * 0.3,
                  petalSize * 0.4,

                  0,
                  0,
                );

                ctx.fillStyle = flowerColor;

                ctx.fill();

                ctx.strokeStyle = flowerColor;

                ctx.lineWidth = 1;

                ctx.stroke();

                ctx.restore();
              }

              ctx.beginPath();

              ctx.arc(0, 0, 8, 0, Math.PI * 2);

              ctx.fillStyle = flowerColor;

              ctx.fill();

              ctx.beginPath();

              ctx.arc(0, 0, 4, 0, Math.PI * 2);

              ctx.fillStyle = '#FFF';

              ctx.fill();

              ctx.restore();

              const descElement = umaItem.querySelector('.uma-desc');

              if (descElement) {
                descElement.style.position = 'relative';

                descElement.appendChild(canvas);
              } else {

                umaItem.style.position = 'relative';

                umaItem.appendChild(canvas);
              }
            }
            umaItem.style.cursor = 'pointer';
            umaItem.setAttribute('data-uma-name', umaName);
            const newUmaItem = umaItem.cloneNode(true);
            umaItem.parentNode.replaceChild(newUmaItem, umaItem);
            newUmaItem.addEventListener('click', e => {
              if (window.giftSelectionMode && window.giftSelectionMode.active) {
                return;
              }
              if (window.skillSelectionMode && window.skillSelectionMode.active) {
                return;
              }
              e.stopPropagation();
              this.showUmaExpression(umaName);
            });
          });

          while (umaContent.children.length > Object.keys(n).length) {
            umaContent.removeChild(umaContent.lastChild);
          }

          this.updateQTESection();
        }
        getStatusDecoration(status, exclusiveLevel) {
          const decorations = {
            'B√¨nh th∆∞·ªùng': 'üå∏', 
            'ƒê·ªôc chi·∫øm': 'üåπ', 
            'M·∫•t t√≠ch': 'üåô', 
            'H·ªón lo·∫°n': 'üåÄ', 
            'C·∫£nh gi√°c': '‚ö†Ô∏è', 
            'Yandere': 'üíÄ', 
            default: '‚ú®', 
          };
          if (exclusiveLevel > 80) {
            return 'üî•'; 
          } else if (exclusiveLevel > 60) {
            return '‚≠ê'; 
          } else if (exclusiveLevel > 40) {
            return 'üíé'; 
          }

          return decorations[status] || decorations['default'];
        }

        getUmaAvatar(e) {
          return (
            {
              'Ines Fujin': 'https://i.ibb.co/B2CtyPbD/image.png',
              'Agnes Digital': 'https://i.ibb.co/ksffMxb2/image.png',
              'Agnes Tachyon': 'https://i.ibb.co/QsBkWDg/image.png',
              'Admire Vega': 'https://i.ibb.co/kV6FmzqL/image.png',
              'Still in Love': 'https://i.ibb.co/CcWZtVt/image.png',
              'Yaeno Muteki': 'https://i.ibb.co/zHxMgncr/image.png',
              'Byerley Turk': 'https://i.ibb.co/sJsVG3Kc/image.png',
              'Kitasan Black': 'https://i.ibb.co/KcN2SnXd/image.png',
              'Hokko Tarumae': 'https://i.ibb.co/ks0P8hrB/image.png',
              'Grass Wonder': 'https://i.ibb.co/M5GrFXRq/image.png',
              'Biko Pegasus': 'https://i.ibb.co/fYG883D0/image.png',
              'Super Creek': 'https://i.ibb.co/1fm39MMG/image.png',
              'Narita Brian': 'https://i.ibb.co/d0nGx53H/image.png',
              'Narita Top Road': 'https://i.ibb.co/xn7v4zr/image.png',
              'Transcend': 'https://i.ibb.co/MkGGsdsC/image.png',
              'Chrono Genesis': 'https://i.ibb.co/WNt01jHm/image.png',
              'Haru Urara': 'https://i.ibb.co/7Jn7bBrF/image.png',
              'Darley Arabian': 'https://i.ibb.co/FLLqgpx2/image.png',
              'Daiwa Scarlet': 'https://i.ibb.co/YTKMDHGH/image.png',
              'Duramente': 'https://i.ibb.co/mFTBxjSR/image.png',
              'Taiki Shuttle': 'https://i.ibb.co/3yScrx0V/image.png',
              'Daitaku Helios': 'https://i.ibb.co/SD184c21/image.png',
              'Matikanefukukitaru': 'https://i.ibb.co/nMqV35j1/image.png',
              'King Halo': 'https://i.ibb.co/hRJPgJjY/image.png',
              'Daiichi Ruby': 'https://i.ibb.co/0yrMpr89/image.png',
              'Tokai Teio': 'https://i.ibb.co/MynWxJGC/image.png',
              'Sweep Tosho': 'https://i.ibb.co/QRwvVrJ/image.png',
              'Durandal': 'https://i.ibb.co/21Ywg7z5/image.png',
              'Vodka': 'https://i.ibb.co/8gjJKrzb/image.png',
              'Fuji Kiseki': 'https://i.ibb.co/vvCCDGCN/image.png',
              'Godolphin Arabian': 'https://i.ibb.co/tMKM0pRc/image.png',
              'Cheval Grand': 'https://i.ibb.co/BHSWM0m6/image.png',
              'Katsuragi Ace': 'https://i.ibb.co/LDnRPNBr/image.png',
              'Gentildonna': 'https://i.ibb.co/kgvJccHw/image.png',
              'T.M. Opera O': 'https://i.ibb.co/VFFcGrn/image.png',
              'Zenno Rob Roy': 'https://i.ibb.co/27jBVvJ0/image.png',
              'Gold City': 'https://i.ibb.co/GvxFtDD0/image.png',
              'Gold Ship': 'https://i.ibb.co/tMDRMMGS/image.png',
              'Orfevre': 'https://i.ibb.co/m3QPbR4/image.png',
              'Stay Gold': 'https://i.ibb.co/m5kfWN1x/image.png',
              'Verxina': 'https://i.ibb.co/pvD3vXpd/image.png',
              'Calstone Light O': 'https://i.ibb.co/PvDQxTVb/image.png',
              'Tazuna Hayakawa': 'https://i.ibb.co/d0bq1gxL/image.png',
              'Win Variation': 'https://i.ibb.co/MkhYb37g/image.png',
              'Satono Diamond': 'https://i.ibb.co/G6Wzczx/image.png',
              'Satono Crown': 'https://i.ibb.co/Pvqfn9vQ/image.png',
              'Hishi Amazon': 'https://i.ibb.co/K4PW4yf/image.png',
              'Hishi Miracle': 'https://i.ibb.co/Pv2XF9Sv/image.png',
              'Symboli Rudolf': 'https://i.ibb.co/KcLmSgRw/image.png',
              'Manhattan Cafe': 'https://i.ibb.co/yFx4Rgxr/image.png',
              'Fine Motion': 'https://i.ibb.co/JjRtG2qf/image.png',
              'Mihono Bourbon': 'https://i.ibb.co/73Nbwtg/image.png',
              'Dream Journey': 'https://i.ibb.co/7NdH5zcJ/image.png',
              'Buena Vista': 'https://i.ibb.co/TDhhZsKt/image.png',
              'Rice Shower': 'https://i.ibb.co/jPpgthz2/image.png',
              'Meisho Doto': 'https://i.ibb.co/hxhTXSG6/image.png',
              'Mayano Top Gun': 'https://i.ibb.co/1GV9pQcK/image.png',
              'Daring Tact': 'https://i.ibb.co/qMVDc885/image.png',
              'Mejiro Ardan': 'https://i.ibb.co/jPN65g9L/image.png',
              'Mejiro Dober': 'https://i.ibb.co/ynCKCRTp/image.png',
              'Mejiro Ramonu': 'https://i.ibb.co/ksKkZsfc/image.png',
              'Mejiro Bright': 'https://i.ibb.co/KcTgK0Zn/image.png',
              'Mejiro McQueen': 'https://i.ibb.co/BVkJLRPD/image.png',
              'Mejiro Palmer': 'https://i.ibb.co/PvCFZnWG/image.png',
              'Wonder Acute': 'https://i.ibb.co/Df6DydNq/image.png',
              'Air Groove': 'https://i.ibb.co/8LCF2Jvx/image.png',
              'Mr. C.B.': 'https://i.ibb.co/qMWd1hzy/image.png',
              'Symboli Kris S': 'https://i.ibb.co/5XLFXpgJ/image.png',
              'Seiun Sky': 'https://i.ibb.co/1fxW68Hf/image.png',
              'Yayoi Akikawa': 'https://i.ibb.co/SXvGkYvF/image.png',
              'Eishin Flash': 'https://i.ibb.co/6R80xkhg/image.png',
              'Jungle Pocket': 'https://i.ibb.co/Mk6zTzLx/image.png',
              'El Condor Pasa': 'https://i.ibb.co/r2NHbD3j/image.png',
              'Winning Ticket': 'https://i.ibb.co/S7ftJQgr/image.png',
              'Twin Turbo': 'https://i.ibb.co/S7ftJQgr/image.png',
              'Special Week': 'https://i.ibb.co/B2c8Kpbz/image.png',
              'Sirius Symboli': 'https://i.ibb.co/Jjzk28B0/image.png',
              'Maruzensky': 'https://i.ibb.co/b5CGf99Z/image.png',
              'Silence Suzuka': 'https://i.ibb.co/cSk3fJyk/image.png',
              'Nishino Flower': 'https://i.ibb.co/HTPf6PZw/image.png',
              'Oguri Cap': 'https://i.ibb.co/PGPLf83T/image.png',
              'Copano Rickey': 'https://i.ibb.co/FT3trBd/image.png',
              'Neo Universe': 'https://i.ibb.co/vxPCMPTf/image.png',
              'Almond Eye': 'https://i.ibb.co/TB2mD8s1/image.png',
              'Sakura Chiyono O': 'https://i.ibb.co/93hXrWBg/image.png',
              'Tamamo Cross': 'https://i.ibb.co/TM6YQbwH/image.png',
              'Aston Machan': 'https://i.ibb.co/G3FqKnzd/image.png',
              'Curren Chan': 'https://i.ibb.co/ynyz8qzm/image.png',
              'Nakayama Festa': 'https://i.ibb.co/pqLz3TJ/image.png',
              'Sunday Silence': 'https://i.ibb.co/jvNPSGGb/image.png',
              'Tsurumaru Tsuyoshi': 'https://i.ibb.co/RTwVyNsF/image.png',
            }[e] || null
          );
        }
        getSexPositionImage(positionName) {
          if (!positionName) {
            return 'https://files.catbox.moe/6386xs.gif';
          }
          const positionMap = {
            'Tr√≤ chuy·ªán': 'https://files.catbox.moe/4xl6g6.png',
            'T√°n t·ªânh': 'https://files.catbox.moe/4xl6g6.png',
            'H√¥n': 'https://files.catbox.moe/4xl6g6.png',
            'Vu·ªët ve tai': 'https://files.catbox.moe/4xl6g6.png',
            'Vu·ªët ve ƒë√πi': 'https://files.catbox.moe/4xl6g6.png',
            'Vu·ªët ve ƒëu√¥i': 'https://files.catbox.moe/4xl6g6.png',
            'Vu·ªët ve ng·ª±c': 'https://files.catbox.moe/lyrkgb.gif',
            'Vu·ªët ve √¢m v·∫≠t': 'https://files.catbox.moe/4xl6g6.png',
            'Ng√≥n tay th√¢m nh·∫≠p': 'https://files.catbox.moe/4xl6g6.png',
            'Handjob': 'https://files.catbox.moe/sttoic.gif',
            'Oral sex': 'https://files.catbox.moe/dglho3.gif',
            'Deepthroat': 'https://files.catbox.moe/bbezbz.gif',
            'Oral sex s√¢u': 'https://files.catbox.moe/bbezbz.gif',
            '·∫§n ƒë·∫ßu Oral sex': 'https://files.catbox.moe/2xu3gl.gif',
            'D√πng l∆∞·ª°i': 'https://files.catbox.moe/dglho3.gif',
            'Paizuri': 'https://files.catbox.moe/qzhy79.gif',
            'K·∫πp ng·ª±c Oral': 'https://files.catbox.moe/qzhy79.gif',
            'Footjob': 'https://files.catbox.moe/3jmnfs.gif',
            'Sumata': 'https://files.catbox.moe/7fznxn.gif',
            'Li·∫øm h·∫≠u m√¥n': 'https://files.catbox.moe/4xl6g6.png',
            'D∆∞∆°ng v·∫≠t v·ªó m·∫∑t': 'https://files.catbox.moe/k8mjcl.gif',
            'T∆∞ th·∫ø truy·ªÅn th·ªëng': 'https://files.catbox.moe/ha9710.gif',
            'Th√¢m nh·∫≠p truy·ªÅn th·ªëng': 'https://files.catbox.moe/9lyaet.png',
            'Creampie truy·ªÅn th·ªëng': 'https://files.catbox.moe/h7zf71.gif',
            '·∫§n xu·ªëng Creampie truy·ªÅn th·ªëng': 'https://files.catbox.moe/ha9710.gif',
            'Doggy style': 'https://files.catbox.moe/ync9or.gif',
            'T·ª´ ph√≠a sau': 'https://files.catbox.moe/ync9or.gif',
            'Ng·ªìi ƒë·ªëi m·∫∑t': 'https://files.catbox.moe/ue4bj4.gif',
            'Ng·ªìi quay l∆∞ng': 'https://files.catbox.moe/jpentm.gif',
            'N·ªØ tr√™n quay l∆∞ng': 'https://files.catbox.moe/jpentm.gif',
            'ƒê·ª©ng ƒë·ªëi m·∫∑t': 'https://files.catbox.moe/vdlsy0.gif',
            'ƒê·ª©ng quay l∆∞ng': 'https://files.catbox.moe/vdlsy0.gif',
            'ƒê·ª©ng m·ªôt ch√¢n': 'https://files.catbox.moe/61uy8w.gif',
            'T∆∞ th·∫ø 69': 'https://files.catbox.moe/gdc9ge.gif',
            'T∆∞ th·∫ø 69': 'https://files.catbox.moe/gdc9ge.gif',
            'Cowgirl': 'https://files.catbox.moe/6386xs.gif',
            'Cowgirl th√¢m nh·∫≠p': 'https://files.catbox.moe/6kjny0.gif',
            'Cowgirl xu·∫•t tinh': 'https://files.catbox.moe/0ess4j.gif',
            'Cowgirl l·∫∑p l·∫°i': 'https://files.catbox.moe/6386xs.gif',
            'Cowgirl sumata': 'https://files.catbox.moe/7fznxn.gif',
            'Cowgirl √°o t·∫Øm': 'https://files.catbox.moe/zi9cwm.gif',
            'Cowgirl quay l∆∞ng d·∫≠p': 'https://files.catbox.moe/nshpes.gif',
            'B·∫ø l√™n l√†m': 'https://files.catbox.moe/mygqgs.gif',
            'Anal truy·ªÅn th·ªëng': 'https://files.catbox.moe/qav7rm.gif',
            'Anal sex': 'https://files.catbox.moe/qav7rm.gif',
            'Anal Doggy': 'https://files.catbox.moe/qav7rm.gif',
            'Anal ng·ªìi ƒë·ªëi m·∫∑t': 'https://files.catbox.moe/qav7rm.gif',
            'Anal ng·ªìi quay l∆∞ng': 'https://files.catbox.moe/qav7rm.gif',
            'Anal ƒë·ª©ng ƒë·ªëi m·∫∑t': 'https://files.catbox.moe/qav7rm.gif',
            'Anal ƒë·ª©ng quay l∆∞ng': 'https://files.catbox.moe/qav7rm.gif',
            'Anal cowgirl': 'https://files.catbox.moe/qav7rm.gif',
            'Tr·∫°ng th√°i chu·∫©n': 'https://files.catbox.moe/4xl6g6.png',
            'Tr·∫°ng th√°i chu·∫©n_Th√¢m nh·∫≠p': 'https://files.catbox.moe/9lyaet.png',
            'Tinh d·ªãch √≠t': 'https://files.catbox.moe/9k7svg.png',
            'Tinh d·ªãch √≠t_Th√¢m nh·∫≠p': 'https://files.catbox.moe/kpax3j.png',
            'Tinh d·ªãch v·ª´a': 'https://files.catbox.moe/rjd0lb.png',
            'Tinh d·ªãch v·ª´a_Th√¢m nh·∫≠p': 'https://files.catbox.moe/hduhkb.png',
            'Tinh d·ªãch nhi·ªÅu': 'https://files.catbox.moe/j3jca9.png',
            'Tinh d·ªãch nhi·ªÅu_Th√¢m nh·∫≠p': 'https://files.catbox.moe/2n42h7.png',
            'Th·ªùi k·ª≥ nguy hi·ªÉm': 'https://files.catbox.moe/ceobkd.png',
            'Th·ªùi k·ª≥ nguy hi·ªÉm_Th√¢m nh·∫≠p': 'https://files.catbox.moe/svd5vs.png',
            'Th·ªùi k·ª≥ r·ª•ng tr·ª©ng': 'https://files.catbox.moe/aefbia.png',
            'Th·ªùi k·ª≥ r·ª•ng tr·ª©ng_Th√¢m nh·∫≠p': 'https://files.catbox.moe/dd7gji.png',
            'Th·ª• tinh': 'https://files.catbox.moe/4hqguy.png',
            'Th·ª• tinh_Th√¢m nh·∫≠p': 'https://files.catbox.moe/jz01gj.png',
            'Mang thai': 'https://files.catbox.moe/jnd52k.png',
            'Mang thai_Th√¢m nh·∫≠p': 'https://files.catbox.moe/arfyv1.png',
            'L√¢m b·ªìn': 'https://files.catbox.moe/5bjfv3.png',
            'L√¢m b·ªìn_Th√¢m nh·∫≠p': 'https://files.catbox.moe/c5omi0.png',
          };
          if (positionMap[positionName]) {
            return positionMap[positionName];
          }
          const priorityKeywords = [
            { keyword: 'L√¢m b·ªìn', image: 'https://files.catbox.moe/5bjfv3.png' },
            { keyword: 'Mang thai', image: 'https://files.catbox.moe/jnd52k.png' },
            { keyword: 'Th·ª• tinh', image: 'https://files.catbox.moe/4hqguy.png' },
            { keyword: 'Th·ªùi k·ª≥ r·ª•ng tr·ª©ng', image: 'https://files.catbox.moe/aefbia.png' },
            { keyword: 'Th·ªùi k·ª≥ nguy hi·ªÉm', image: 'https://files.catbox.moe/ceobkd.png' },
            { keyword: 'Tinh d·ªãch nhi·ªÅu', image: 'https://files.catbox.moe/j3jca9.png' },
            { keyword: 'Tinh d·ªãch v·ª´a', image: 'https://files.catbox.moe/rjd0lb.png' },
            { keyword: 'Tinh d·ªãch √≠t', image: 'https://files.catbox.moe/9k7svg.png' },
            { keyword: '·∫§n xu·ªëng Creampie', image: 'https://files.catbox.moe/ha9710.gif' },
            { keyword: 'Creampie truy·ªÅn th·ªëng', image: 'https://files.catbox.moe/h7zf71.gif' },
            { keyword: 'Creampie', image: 'https://files.catbox.moe/h7zf71.gif' },
            { keyword: 'Cowgirl quay l∆∞ng d·∫≠p', image: 'https://files.catbox.moe/nshpes.gif' },
            { keyword: 'Cowgirl √°o t·∫Øm', image: 'https://files.catbox.moe/zi9cwm.gif' },
            { keyword: 'ƒê·ª©ng m·ªôt ch√¢n', image: 'https://files.catbox.moe/61uy8w.gif' },
            { keyword: 'T∆∞ th·∫ø 69', image: 'https://files.catbox.moe/gdc9ge.gif' },
            { keyword: 'T∆∞ th·∫ø 69', image: 'https://files.catbox.moe/gdc9ge.gif' },
            { keyword: '·∫§n ƒë·∫ßu Oral sex', image: 'https://files.catbox.moe/2xu3gl.gif' },
            { keyword: 'Oral sex s√¢u', image: 'https://files.catbox.moe/bbezbz.gif' },
            { keyword: 'Deepthroat', image: 'https://files.catbox.moe/bbezbz.gif' },
            { keyword: 'D∆∞∆°ng v·∫≠t v·ªó m·∫∑t', image: 'https://files.catbox.moe/k8mjcl.gif' },
            { keyword: 'B·∫ø l√™n l√†m', image: 'https://files.catbox.moe/mygqgs.gif' },
            { keyword: 'N·ªØ tr√™n quay l∆∞ng', image: 'https://files.catbox.moe/jpentm.gif' },
            { keyword: 'Ng·ªìi quay l∆∞ng', image: 'https://files.catbox.moe/jpentm.gif' },
            { keyword: 'Ng·ªìi ƒë·ªëi m·∫∑t', image: 'https://files.catbox.moe/ue4bj4.gif' },
            { keyword: 'ƒê·ª©ng ƒë·ªëi m·∫∑t', image: 'https://files.catbox.moe/vdlsy0.gif' },
            { keyword: 'ƒê·ª©ng quay l∆∞ng', image: 'https://files.catbox.moe/vdlsy0.gif' },
            { keyword: 'T·ª´ ph√≠a sau', image: 'https://files.catbox.moe/ync9or.gif' },
            { keyword: 'Doggy style', image: 'https://files.catbox.moe/ync9or.gif' },
            { keyword: 'Anal sex', image: 'https://files.catbox.moe/qav7rm.gif' },
            { keyword: 'Paizuri', image: 'https://files.catbox.moe/qzhy79.gif' },
            { keyword: 'Sumata', image: 'https://files.catbox.moe/7fznxn.gif' },
            { keyword: 'Xu·∫•t tinh', image: 'https://files.catbox.moe/0ess4j.gif' },
            { keyword: 'Th√¢m nh·∫≠p', image: 'https://files.catbox.moe/9lyaet.png' },
            { keyword: 'Handjob', image: 'https://files.catbox.moe/sttoic.gif' },
            { keyword: 'Oral sex', image: 'https://files.catbox.moe/dglho3.gif' },
            { keyword: 'Footjob', image: 'https://files.catbox.moe/3jmnfs.gif' },
            { keyword: 'Vu·ªët ve ng·ª±c', image: 'https://files.catbox.moe/lyrkgb.gif' },
            { keyword: 'T∆∞ th·∫ø truy·ªÅn th·ªëng', image: 'https://files.catbox.moe/ha9710.gif' },
            { keyword: 'Cowgirl', image: 'https://files.catbox.moe/6386xs.gif' },
          ];
          for (const item of priorityKeywords) {
            if (positionName.includes(item.keyword)) {
              return item.image;
            }
          }
          return 'https://files.catbox.moe/6386xs.gif';
        }
        updateSexPositionImage() {
          const allVariables = this.getAllVariables();
          const position = this.getVariable(allVariables, 'stat_data.trainer.sexualPosition', '');
          const imageUrl = this.getSexPositionImage(position);
          const imageElement = document.getElementById('sex-position-image');
          const placeholderElement = document.getElementById('sex-position-placeholder');
          const textElement = document.getElementById('sex-position-text');
          if (textElement) {
            textElement.textContent = position || 'Cowgirl l·∫∑p l·∫°i';
          }
          if (imageElement && placeholderElement) {
            imageElement.src = imageUrl;
            imageElement.style.display = 'block';
            placeholderElement.style.display = 'none';
          }
        }
        toggleSexPosition() {
          const basic = document.getElementById('sex-position-basic');
          const detail = document.getElementById('sex-position-detail');

          if (basic && detail) {
            if ('none' === detail.style.display) {
              basic.style.display = 'none';
              detail.style.display = 'block';
            } else {
              basic.style.display = 'block';
              detail.style.display = 'none';
            }
          }
        }
        initSexPositionSection() {
          this.updateSexPositionImage();
        }
        getLocationImage(locationName) {
          if (!locationName) return 'https://i.ibb.co/HLSMJ9d6/image.png';
          const defaultLocationImage = 'https://i.ibb.co/HLSMJ9d6/image.png';
          const school_internal = {
            building_winter: 'https://i.ibb.co/G3f19P0F/image.png', 
            building_autumn: 'https://i.ibb.co/bggsc83g/image.png', 
            building_sunset: 'https://i.ibb.co/jPcCXjCQ/image.png', 
            building_cloudy: 'https://i.ibb.co/TxfgPsPK/image.png', 
            building_noon: 'https://i.ibb.co/TBxYs5mr/image.png', 
            building_christmas: 'https://i.ibb.co/YFk4j6DX/image.png', 
            corridor_sunset: 'https://i.ibb.co/SDvv6p7j/image.png', 
            corridor_activity: 'https://i.ibb.co/dwWSMTF9/image.png', 
            corridor_back_sunset: 'https://i.ibb.co/xSYJg5YR/image.png', 
            office_building_in: 'https://i.ibb.co/hRtQ0k6C/image.png', 
            office_building_front: 'https://i.ibb.co/DfQbT1TB/image.png', 
            archive_room: 'https://i.ibb.co/5xt3CYJX/image.png', 
            basement: 'https://i.ibb.co/jvszvTH1/image.png', 
          };
          const training_area = {
            track_offseason: 'https://i.ibb.co/yFvhNt7G/image.png', 
            track_side: 'https://i.ibb.co/1GxvHfB2/image.png', 
            track_gate_prep: 'https://i.ibb.co/JjD65SQd/image.jpg', 
            track_dirt_road: 'https://i.ibb.co/G3fcjDF3/image.png', 
            field_grass: 'https://i.ibb.co/5WdZDrZK/image.png', 
            field_football: 'https://i.ibb.co/5gLTMPDp/image.png', 
            arena_entrance: 'https://i.ibb.co/Zz1FK13k/image.png', 
            arena_hall: 'https://i.ibb.co/VYVYYXJR/image.png', 
            arena_stand_plaza: 'https://i.ibb.co/V0ZYM5YY/image.png', 
            arena_indoor_hall: 'https://i.ibb.co/Qvg3RfLv/image.png', 
            arena_studio: 'https://i.ibb.co/23C23c9p/image.jpg', 
          };
          const life_social = {
            dorm_laundry: 'https://i.ibb.co/NgSh35Hg/image.png', 
            dorm_kitchen: 'https://i.ibb.co/mVqRQD06/image.png', 
            dorm_afternoon_tea: 'https://i.ibb.co/VWjDsK86/image.png', 
            dorm_rest_room: 'https://i.ibb.co/39SNvPzK/image.png', 
            dorm_luxury: 'https://i.ibb.co/MTwYVb3/image.png', 
            plaza_night: 'https://i.ibb.co/nNSKqqGT/image.png', 
            plaza_mid: 'https://i.ibb.co/WWh3WgYN/image.png', 
            plaza_stairs: 'https://i.ibb.co/Wqzrx5B/image.png', 
            plaza_shrine: 'https://i.ibb.co/SXvChCgJ/image.png', 
            forest_autumn: 'https://i.ibb.co/k2WqY4mp/image.png', 
            garden: 'https://i.ibb.co/gbq2YX8L/image.png', 
            sakura_tree: 'https://i.ibb.co/TqYNzKmx/image.png', 
          };
          const town_area = {
            transport_bus_in: 'https://i.ibb.co/rRy0JJrY/image.png', 
            transport_subway_out: 'https://i.ibb.co/tw8463Wy/image.png', 
            transport_train_ext: 'https://i.ibb.co/KcFyG7bb/image.png', 
            transport_highway: 'https://i.ibb.co/d4gDDjwF/image.gif', 
            store_fashion: 'https://i.ibb.co/tM6G7df7/image.png', 
            store_snack: 'https://i.ibb.co/pr222fWK/image.png', 
            store_market: 'https://i.ibb.co/d4Vqw2S0/image.png', 
            store_flower: 'https://i.ibb.co/6Rb1Xyf0/image.png', 
            restaurant_izakaya: 'https://i.ibb.co/7J9HHMjq/image.png', 
            restaurant_bar_front: 'https://i.ibb.co/chWNyFj6/image.png', 
            fun_museum: 'https://i.ibb.co/nsx5YXHN/image.png', 
            fun_circus: 'https://i.ibb.co/CK5rjwKy/image.png', 
            fun_festival: 'https://i.ibb.co/35nxgbk7/image.png', 
            fun_park: 'https://i.ibb.co/fdQ4V1kH/image.png', 
          };
          const special_location = {
            island_camp: 'https://i.ibb.co/tpvT3qZc/image.png', 
            island_pier: 'https://i.ibb.co/3YGyJj5h/image.png', 
            island_cave: 'https://i.ibb.co/wZKpQ9x6/image.png', 
            island_shop: 'https://i.ibb.co/Z6Wq58LZ/image.png', 
            island_tent: 'https://i.ibb.co/fzztrTCV/image.png', 
            island_pool_private: 'https://i.ibb.co/bMw1H3WD/image.png', 
            event_dinner_ball: 'https://i.ibb.co/XxWHSsbw/image.png', 
            event_dinner_hall: 'https://i.ibb.co/xtz8zy9P/1.png', 
            event_speech: 'https://i.ibb.co/WWpdNkbt/image.png', 
            event_stage_concert: 'https://i.ibb.co/nsbJS6Lc/image.png', 
            world_guangzhou: 'https://i.ibb.co/yF5tsW5M/image.png', 
          };
          const allLocationImages = {
            ...school_internal,
            ...training_area,
            ...life_social,
            ...town_area,
            ...special_location,
          };
          const keywordRules = [
            { keywords: ['Qu·∫£ng tr∆∞·ªùng trung t√¢m', 'Qu·∫£ng tr∆∞·ªùng'], image: school_internal['plaza_mid'] || defaultLocationImage },
            {
              keywords: ['T√≤a nh√† gi·∫£ng ƒë∆∞·ªùng', 'Gi·∫£ng ƒë∆∞·ªùng ch√≠nh', 'T√≤a nh√† ho·∫°t ƒë·ªông'],
              image: school_internal['building_noon'] || defaultLocationImage,
            },
            {
              keywords: ['T√≤a nh√† h√†nh ch√≠nh', 'T√≤a nh√† vƒÉn ph√≤ng', 'Ph√≤ng hu·∫•n luy·ªán vi√™n', 'VƒÉn ph√≤ng hu·∫•n luy·ªán vi√™n'],
              image: school_internal['office_building_in'] || defaultLocationImage,
            },
            { keywords: ['H√†nh lang'], image: school_internal['corridor_activity'] || defaultLocationImage },
            { keywords: ['Ph√≤ng l∆∞u tr·ªØ'], image: school_internal['archive_room'] || defaultLocationImage },
            { keywords: ['T·∫ßng h·∫ßm'], image: school_internal['basement'] || defaultLocationImage },
            { keywords: ['Nh√† ƒÉn'], image: life_social['dorm_kitchen'] || defaultLocationImage },
            { keywords: ['Ph√≤ng t·∫≠p nh·∫£y'], image: school_internal['corridor_activity'] || defaultLocationImage },
            {
              keywords: ['S√¢n t·∫≠p ngo√†i tr·ªùi', 'S√¢n t·∫≠p', 'S√¢n v·∫≠n ƒë·ªông'],
              image: training_area['track_offseason'] || defaultLocationImage,
            },
            {
              keywords: ['S√¢n t·∫≠p trong nh√†', 'Nh√† thi ƒë·∫•u', 'Nh√† thi ƒë·∫•u trong nh√†'],
              image: training_area['arena_indoor_hall'] || defaultLocationImage,
            },
            { keywords: ['S√¢n tennis', 'S√¢n b√≥ng ƒë√°', 'B√£i c·ªè'], image: training_area['field_grass'] || defaultLocationImage },
            { keywords: ['Ph√≤ng thu'], image: training_area['arena_studio'] || defaultLocationImage },
            { keywords: ['Kh√°n ƒë√†i', 'Kh√°n ƒë√†i'], image: training_area['arena_stand_plaza'] || defaultLocationImage },
            { keywords: ['Nh√† h√°t ngo√†i tr·ªùi h√¨nh qu·∫°t', 'Nh√† h√°t ngo√†i tr·ªùi'], image: training_area['arena_entrance'] || defaultLocationImage },
            {
              keywords: ['K√Ω t√∫c x√° h·ªçc sinh', 'K√Ω t√∫c x√°', 'K√Ω t√∫c x√° Uma Musume', 'K√Ω t√∫c x√° hu·∫•n luy·ªán vi√™n', 'Ph√≤ng ng·ªß'],
              image: life_social['dorm_luxury'] || defaultLocationImage,
            },
            { keywords: ['Ph√≤ng ngh·ªâ'], image: life_social['dorm_rest_room'] || defaultLocationImage },
            { keywords: ['S√¢n trong'], image: life_social['plaza_mid'] || defaultLocationImage },
            { keywords: ['R·ª´ng nh·ªè', 'R·ª´ng'], image: life_social['forest_autumn'] || defaultLocationImage },
            { keywords: ['ƒê·ªÅn th·ªù'], image: life_social['plaza_shrine'] || defaultLocationImage },
            { keywords: ['V∆∞·ªùn hoa'], image: life_social['garden'] || defaultLocationImage },
            { keywords: ['Hoa anh ƒë√†o'], image: life_social['sakura_tree'] || defaultLocationImage },
            {
              keywords: ['Nh√† b∆°i', 'B·ªÉ b∆°i trong nh√†', 'B·ªÉ b∆°i'],
              image: special_location['island_pool_private'] || defaultLocationImage,
            },
            { keywords: ['Nh√† ga', 'Ga t√†u h·ªèa'], image: town_area['transport_train_ext'] || defaultLocationImage },
            { keywords: ['T√†u ƒëi·ªán ng·∫ßm'], image: town_area['transport_subway_out'] || defaultLocationImage },
            { keywords: ['Ph·ªë th∆∞∆°ng m·∫°i', 'Ph·ªë mua s·∫Øm'], image: town_area['store_fashion'] || defaultLocationImage },
            { keywords: ['ƒê∆∞·ªùng', 'Qu·ªëc l·ªô'], image: town_area['transport_highway'] || defaultLocationImage },
            { keywords: ['ƒê√™ s√¥ng', 'S√¥ng ng√≤i'], image: life_social['plaza_stairs'] || defaultLocationImage },
            { keywords: ['C√¥ng vi√™n'], image: town_area['fun_park'] || defaultLocationImage },
            { keywords: ['B·∫£o t√†ng'], image: town_area['fun_museum'] || defaultLocationImage },
            { keywords: ['B√£i bi·ªÉn', 'Nh√† b√™n bi·ªÉn'], image: special_location['island_shop'] || defaultLocationImage },
            { keywords: ['Tr·∫°i hu·∫•n luy·ªán', 'Doanh tr·∫°i'], image: special_location['island_camp'] || defaultLocationImage },
            { keywords: ['Kh√°ch s·∫°n', 'Kh√°ch s·∫°n t√¨nh y√™u'], image: special_location['event_dinner_hall'] || defaultLocationImage },
            { keywords: ['Su·ªëi n∆∞·ªõc n√≥ng'], image: special_location['island_pool_private'] || defaultLocationImage },
            { keywords: ['Qu·∫£ng Ch√¢u'], image: special_location['world_guangzhou'] || defaultLocationImage },
            { keywords: ['Dinh th·ª± Mejiro', 'Nh√† Golden'], image: special_location['event_dinner_ball'] || defaultLocationImage },
            { keywords: ['Kh·∫£i Ho√†n M√¥n', 'Paris'], image: special_location['event_speech'] || defaultLocationImage },
            { keywords: ['B·ªánh vi·ªán', 'Ph√≤ng y t·∫ø'], image: defaultLocationImage },
            { keywords: ['Ph√≤ng hi·ªáu tr∆∞·ªüng', 'H·ªôi h·ªçc sinh'], image: school_internal['office_building_front'] || defaultLocationImage },
            { keywords: ['C·ªïng tr∆∞·ªùng'], image: school_internal['corridor_back_sunset'] || defaultLocationImage },
            { keywords: ['Ph√≤ng t·∫Øm'], image: life_social['dorm_laundry'] || defaultLocationImage },
            { keywords: ['S√¢n th∆∞·ª£ng'], image: school_internal['building_sunset'] || defaultLocationImage },
          ];
          if (allLocationImages[locationName]) {
            return allLocationImages[locationName];
          }
          for (const rule of keywordRules) {
            for (const keyword of rule.keywords) {
              if (locationName.includes(keyword) || keyword.includes(locationName)) {
                return rule.image;
              }
            }
          }
          return defaultLocationImage;
        }
        updateLocationImage() {
          const allVariables = this.getAllVariables();
          const location = this.getVariable(allVariables, 'stat_data.trainer.location', '');
          const imageUrl = this.getLocationImage(location);
          const imageElement = document.getElementById('location-image');
          const placeholderElement = document.getElementById('location-image-placeholder');

          if (imageElement && placeholderElement) {
            if (imageUrl) {
              imageElement.src = imageUrl;
              imageElement.style.display = 'block';
              placeholderElement.style.display = 'none';
            } else {
              imageElement.style.display = 'none';
              placeholderElement.style.display = 'block';
              placeholderElement.textContent = location ? `T·∫°m kh√¥ng c√≥ ·∫£nh c·ªßa "${location}"` : 'T·∫°m kh√¥ng c√≥ ·∫£nh ƒë·ªãa ƒëi·ªÉm';
            }
          }
        }
        getUmaExpression(umaName, status = 'B√¨nh th∆∞·ªùng') {
          const expressions = {
            'Ines Fujin': 'https://i.ibb.co/bj3kPZyC/image.png',
            'Agnes Digital': 'https://i.ibb.co/G3FhVWyK/image.png',
            'Agnes Tachyon': 'https://i.ibb.co/wN1QN1qd/image.png',
            'Admire Vega': 'https://i.ibb.co/rKvd7MMZ/image.png',
            'Still in Love': 'https://i.ibb.co/WvNPZzCd/image.png',
            'Yaeno Muteki': 'https://i.ibb.co/spbzHH91/image.png',
            'Byerley Turk': 'https://i.ibb.co/JWZ0GvLs/image.png',
            'Kitasan Black': 'https://i.ibb.co/FLcJPdZF/image.gif',
            'Hokko Tarumae': 'https://i.ibb.co/hJrLJkG2/image.png',
            'Grass Wonder': 'https://i.ibb.co/mCLvncKr/image.png',
            'Biko Pegasus': 'https://i.ibb.co/N6chbWvy/image.png',
            'Super Creek': 'https://i.ibb.co/k6ycDZBX/image.png',
            'Narita Brian': 'https://i.ibb.co/mV2yMXrm/image.png',
            'Narita Top Road': 'https://i.ibb.co/bjF1dzKk/image.png',
            'Transcend': 'https://i.ibb.co/ns4vdDJk/image.png',
            'Chrono Genesis': 'https://i.ibb.co/hnhKR0f/image.png',
            'Haru Urara': 'https://i.ibb.co/6cKDxkhR/image.png',
            'Darley Arabian': 'https://i.ibb.co/ksFLwCP7/image.png',
            'Daiwa Scarlet': 'https://i.ibb.co/zTmwrFfq/image.png',
            'Duramente': 'https://i.ibb.co/CxvLS2k/image.png',
            'Taiki Shuttle': 'https://i.ibb.co/bVrkb4Z/image.png',
            'Daitaku Helios': 'https://i.ibb.co/cc5w7rv7/image.png',
            'Matikanefukukitaru': 'https://i.ibb.co/XxfVsRRh/image.png',
            'King Halo': 'https://i.ibb.co/pvk8VC1g/image.png',
            'Daiichi Ruby': 'https://i.ibb.co/MD8w8cBK/image.png',
            'Tokai Teio': 'https://i.ibb.co/Cpnw9vwP/image.gif',
            'Sweep Tosho': 'https://i.ibb.co/5hX5YVtX/image.png',
            'Durandal': 'https://i.ibb.co/k2LNHwYH/image.png',
            'Vodka': 'https://i.ibb.co/qMGbx3QN/image.png',
            'Fuji Kiseki': 'https://i.ibb.co/sv3kXwZj/image.png',
            'Godolphin Arabian': 'https://i.ibb.co/cKJYgBqf/image.png',
            'Cheval Grand': 'https://i.ibb.co/YTpTRtsP/image.png',
            'Katsuragi Ace': 'https://i.ibb.co/XrpbRKvG/image.png',
            'Gentildonna': 'https://i.ibb.co/H1xMMnQ/image.png',
            'T.M. Opera O': 'https://i.ibb.co/TBWzwpWf/image.png',
            'Zenno Rob Roy': 'https://i.ibb.co/Q7SG0d1S/image.png',
            'Gold City': 'https://i.ibb.co/Rk8Sz1r3/image.png',
            'Gold Ship': 'https://i.ibb.co/gM380dmj/image.gif',
            'Orfevre': 'https://i.ibb.co/DHGfWKY6/image.png',
            'Stay Gold': 'https://i.ibb.co/MkP8XkTQ/image.png',
            'Verxina': 'https://i.ibb.co/dscWLKSh/image.png',
            'Calstone Light O': 'https://i.ibb.co/KcxHWR26/image.png',
            'Tazuna Hayakawa': 'https://i.ibb.co/6cCpspgt/image.png',
            'Win Variation': 'https://i.ibb.co/99WM988q/image.png',
            'Satono Diamond': 'https://i.ibb.co/cSBMWZzP/image.png',
            'Satono Crown': 'https://i.ibb.co/XxbxGfPn/image.png',
            'Hishi Amazon': 'https://i.ibb.co/F4cbGNHc/image.png',
            'Hishi Miracle': 'https://i.ibb.co/931qjncN/image.png',
            'Symboli Rudolf': 'https://i.ibb.co/qFgkWRF2/image.gif',
            'Manhattan Cafe': 'https://i.ibb.co/F4Kcs90C/image.png',
            'Fine Motion': 'https://i.ibb.co/Sjm1JCs/image.png',
            'Mihono Bourbon': 'https://i.ibb.co/spgWT4fL/image.png',
            'Dream Journey': 'https://i.ibb.co/fYdsSzGb/image.png',
            'Buena Vista': 'https://i.ibb.co/Rp96LFCG/image.png',
            'Rice Shower': 'https://i.ibb.co/dsBhfsGy/image.png',
            'Meisho Doto': 'https://i.ibb.co/DDmMfWxN/image.png',
            'Mayano Top Gun': 'https://i.ibb.co/qYjTrJWT/image.png',
            'Daring Tact': 'https://i.ibb.co/hF7TJCnK/image.png',
            'Mejiro Ardan': 'https://i.ibb.co/JFpnBJh8/image.png',
            'Mejiro Dober': 'https://i.ibb.co/nshjLrNb/image.png',
            'Mejiro Ramonu': 'https://i.ibb.co/pB1hz7ck/image.png',
            'Mejiro Bright': 'https://i.ibb.co/k6yC6WrB/image.png',
            'Mejiro McQueen': 'https://i.ibb.co/cKMdq4ZB/image.png',
            'Mejiro Palmer': 'https://i.ibb.co/9kMcjsrL/image.png',
            'Wonder Acute': 'https://i.ibb.co/dsc6XRm6/image.png',
            'Air Groove': 'https://i.ibb.co/Q3Bk02q1/image.png',
            'Mr. C.B.': 'https://i.ibb.co/M5KWd7vS/image.png',
            'Symboli Kris S': 'https://i.ibb.co/twht0T1H/image.png',
            'Seiun Sky': 'https://i.ibb.co/rRYtjBx9/image.png',
            'Yayoi Akikawa': 'https://i.ibb.co/wN2k3b32/image.png',
            'Eishin Flash': 'https://i.ibb.co/xK8wrv4k/image.png',
            'Jungle Pocket': 'https://i.ibb.co/VW22pxsR/image.png',
            'El Condor Pasa': 'https://i.ibb.co/4nNyKZdG/image.png',
            'Winning Ticket': 'https://i.ibb.co/wNwqtFrV/image.png',
            'Twin Turbo': 'https://i.ibb.co/B5NTrmwJ/image.png',
            'Special Week': 'https://i.ibb.co/DfCGq30P/image.png',
            'Sirius Symboli': 'https://i.ibb.co/fdks4Rz3/image.png',
            'Maruzensky': 'https://i.ibb.co/23tcfxHM/image.png',
            'Silence Suzuka': 'https://i.ibb.co/S4tKhJ1T/image.png',
            'Nishino Flower': 'https://i.ibb.co/JFs5yDt4/image.png',
            'Oguri Cap': 'https://i.ibb.co/tp1kx5BC/image.png',
            'Copano Rickey': 'https://i.ibb.co/DDgC84z0/image.png',
            'Neo Universe': 'https://i.ibb.co/GQ4vxxxR/image.png',
            'Almond Eye': 'https://i.ibb.co/WpVhzyMk/image.png',
            'Sakura Chiyono O': 'https://i.ibb.co/DDPZbCKv/image.png',
            'Tamamo Cross': 'https://i.ibb.co/1tc1Wqkq/image.png',
            'Aston Machan': 'https://i.ibb.co/VYQTFJfL/image.png',
            'Curren Chan': 'https://i.ibb.co/1JBJWtJm/image.png',
            'Nakayama Festa': 'https://i.ibb.co/svRCcYP6/image.png',
            'Sunday Silence': 'https://i.ibb.co/YFMc4TQZ/image.png',
            'Tsurumaru Tsuyoshi': 'https://i.ibb.co/vCgSJXyd/image.png',
          };
          if (status === 'B√¨nh th∆∞·ªùng' || !status) {
            return expressions[umaName] || null;
          }
          return expressions[umaName] || null;
        }
        showUmaExpression(umaName) {
          const grid = document.getElementById('main-uma-expression-grid');
          if (!grid) return;
          if (!umaName) {
            grid.innerHTML =
              '<div style="text-align: center; color: #8b4513; padding: 20px; font-size: 0.9em;">Nh·∫•n v√†o avatar Uma Musume ƒë·ªÉ xem bi·ªÉu c·∫£m</div>';
            return;
          }
          const allVariables = this.getAllVariables();
          const umaData = this.getVariable(allVariables, 'stat_data.umaMusume', {});

          if (!umaData || !umaData[umaName]) {
            grid.innerHTML = '<div style="text-align: center; color: #8b4513; padding: 20px;">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu Uma Musume n√†y</div>';
            return;
          }
          grid.innerHTML = '<div style="text-align: center; color: #8b4513; padding: 20px;">ƒêang t·∫£i...</div>';
          const umaStatus = this.getVariable(allVariables, `stat_data.umaMusume.${umaName}.status`, 'B√¨nh th∆∞·ªùng');
          const expressionImage = this.getUmaExpression(umaName, umaStatus);

          if (expressionImage) {
            const img = document.createElement('img');
            img.src = expressionImage;
            img.alt = umaName;
            img.style.cssText =
              'max-width: 100%; width: auto; height: auto; min-height: 100px; border-radius: 8px; display: block; margin: 0 auto;';
            img.loading = 'eager'; 
            img.onload = () => {
              grid.innerHTML = '';
              const container = document.createElement('div');
              container.style.cssText = 'text-align: center;';
              container.appendChild(img);
              grid.appendChild(container);
            };
            img.onerror = () => {
              grid.innerHTML = '<div style="text-align: center; color: #8b4513; padding: 20px;">T·∫£i ·∫£nh th·∫•t b·∫°i</div>';
            };
          } else {
            grid.innerHTML =
              '<div style="text-align: center; color: #8b4513; padding: 20px;">T·∫°m kh√¥ng c√≥ ·∫£nh bi·ªÉu c·∫£m c·ªßa Uma Musume n√†y</div>';
          }
        }
        renderUmaExpressions(selectedUmaName = null) {
          const grid = document.getElementById('uma-expression-grid');
          if (!grid) return;
          const allVariables = this.getAllVariables();
          const umaData = this.getVariable(allVariables, 'stat_data.umaMusume', {});

          if (!umaData || Object.keys(umaData).length === 0) {
            grid.innerHTML = '<div class="empty-uma">T·∫°m kh√¥ng c√≥ d·ªØ li·ªáu Uma Musume</div>';
            return;
          }
          grid.innerHTML = '';
          const umaNamesToShow = selectedUmaName ? [selectedUmaName] : Object.keys(umaData);
          umaNamesToShow.forEach(umaName => {
            if (!umaData[umaName]) return;

            const umaStatus = this.getVariable(allVariables, `stat_data.umaMusume.${umaName}.status`, 'B√¨nh th∆∞·ªùng');
            const expressionImage = this.getUmaExpression(umaName, umaStatus);

            if (expressionImage) {
              const item = document.createElement('div');
              item.className = 'uma-expression-item';
              item.innerHTML = `
                <div class="uma-expression-card">
                  <div class="uma-expression-name">${umaName}</div>
                  <div class="uma-expression-status">Tr·∫°ng th√°i: ${umaStatus}</div>
                  <img src="${expressionImage}" alt="${umaName} - ${umaStatus}" class="uma-expression-image" loading="lazy">
                </div>
              `;
              grid.appendChild(item);
            }
          });
        }

        getAvatarStyle(e, t) {
          return `width: 58.44px; height: 64px; border-radius: 0.5rem; object-fit: cover;`;
        }

        getUmaNameColor(favorability, exclusivity) {

          if (exclusivity > 90) return '#dc2626'; 

          if (exclusivity > 80) return '#ef4444'; 

          if (exclusivity > 70) return '#f87171'; 

          if (favorability > 80) return '#ec4899'; 

          if (favorability > 60) return '#f472b6'; 

          if (favorability > 40) return '#f9a8d4'; 

          return '#8b6914'; 
        }

        getUmaStatusColor(status, exclusivity, index = 0) {
          return '#ffffff'; 
        }

        getStatusBackgroundColor(status, exclusivity, index = 0) {

          const backgrounds = [
            'rgba(239, 68, 68, 0.15)', 

            'rgba(59, 130, 246, 0.15)', 

            'rgba(34, 197, 94, 0.15)', 

            'rgba(251, 191, 36, 0.15)', 

            'rgba(139, 92, 246, 0.15)', 

            'rgba(249, 115, 22, 0.15)', 

            'rgba(6, 182, 212, 0.15)', 

            'rgba(236, 72, 153, 0.15)', 

            'rgba(132, 204, 22, 0.15)', 

            'rgba(245, 158, 11, 0.15)', 
          ];

          return backgrounds[index % backgrounds.length];
        }

        updateCurrencySystem() {
          const e = this.getAllVariables(),
            t = this.getVariable(e, 'stat_data.trainer.experimentDataPoints', 0),
            n = document.getElementById('currency-value'),
            profileCurrency = document.getElementById('profile-currency-value');

          n && (n.textContent = t.toString());

          profileCurrency && (profileCurrency.textContent = t.toString());
        }

        updateFestivalNotice() {
          const e = this.getAllVariables(),
            t = this.getVariable(e, 'stat_data.world.currentFestival', ''),
            s = document.getElementById('festival-notice'),
            o = document.getElementById('festival-text');

          s &&
            o &&
            (t && t !== '' && t !== null && t !== 'null'
              ? ((o.textContent = `${t}`), (s.style.display = 'flex'))
              : ((o.textContent = 'M·ªôt ng√†y b√¨nh th∆∞·ªùng'), (s.style.display = 'flex')));
        }

        updateRulesCountdown() {
          const e = this.getAllVariables(),
            t = this.getVariable(e, 'stat_data.world.rulesRefreshDay', 0),
            n = document.getElementById('rules-countdown'),
            s = document.getElementById('countdown-text');

          n &&
            s &&
            (t > 0
              ? ((s.textContent = `L√†m m·ªõi quy t·∫Øc: ${t} ng√†y sau`), (n.style.display = 'flex'))
              : ((s.textContent = 'Quy t·∫Øc ƒë∆∞·ª£c l√†m m·ªõi h√¥m nay'), (n.style.display = 'flex')));
        }

        updateReplyTimer() {
          try {
            const e = document.getElementById('reply-timer'),
              t = document.getElementById('reply-timer-text');

            if (!e || !t) return;

            const n = localStorage.getItem('teresen_waiting_for_reply'),
              s = localStorage.getItem('teresen_reply_start_time');

            if ('true' === n && s) {
              const n = parseInt(s),
                o = new Date().getTime() - n,
                a = Math.floor(o / 6e4),
                l = Math.floor((o % 6e4) / 1e3);

              ((t.textContent = `Eternal zz ƒëang g√µ ch·ªØ: ${a.toString().padStart(2, '0')}:${l.toString().padStart(2, '0')}`),
                (e.className = o >= 3e5 ? 'reply-timer danger' : o >= 18e4 ? 'reply-timer warning' : 'reply-timer'),
                (e.style.display = 'flex'));
            } else {
              const n = localStorage.getItem('teresen_last_reply_time');

              const evaluation = localStorage.getItem('teresen_last_reply_evaluation') || '';

              if (n) {
                const s = parseInt(n),
                  o = Math.floor(s / 6e4),
                  a = Math.floor((s % 6e4) / 1e3);

                const timeText = `${o.toString().padStart(2, '0')}:${a.toString().padStart(2, '0')}`;

                const displayText = evaluation ? `${timeText}ÔºåE m·∫Øt soi frameÔºö${evaluation}` : `${timeText}`;

                ((t.textContent = displayText), (e.className = 'reply-timer'), (e.style.display = 'flex'));
              } else this.hideReplyTimer();
            }
          } catch (e) {
            (console.error('C·∫≠p nh·∫≠t t√≠nh to√°n th·ªùi gian ph·∫£n h·ªìi th·∫•t b·∫°i:', e), this.hideReplyTimer());
          }
        }

        hideReplyTimer() {
          const e = document.getElementById('reply-timer');

          e && (e.style.display = 'none');
        }

        startReplyTimer() {
          setInterval(() => {
            this.updateReplyTimer();
          }, 1e3);
        }
        streamUpdateDebounceTimer = null;

        handleStreamUpdate(fullText) {
          try {
            if (!fullText || !fullText.trim()) return;
            if (this.streamUpdateDebounceTimer) {
              clearTimeout(this.streamUpdateDebounceTimer);
            }

            this.streamUpdateDebounceTimer = setTimeout(() => {
              this._doStreamUpdate(fullText);
            }, 200);
          } catch (e) {
            console.error('C·∫≠p nh·∫≠t lu·ªìng th·∫•t b·∫°i:', e);
          }
        }
        _doStreamUpdate(fullText) {
          try {
            const storyContent = document.getElementById('story-content');
            if (!storyContent) return;
            let contentText = '';
            let actionText = '';
            const contentMatches = [...fullText.matchAll(/<content>([\s\S]*?)(?:<\/content>|$)/g)];
            if (contentMatches.length > 0) {
              const lastMatch = contentMatches[contentMatches.length - 1];
              contentText = lastMatch[1].trim();
            }
            const actionMatches = [...fullText.matchAll(/<action>([\s\S]*?)(?:<\/action>|$)/g)];
            if (actionMatches.length > 0) {
              const lastMatch = actionMatches[actionMatches.length - 1];
              actionText = lastMatch[1].trim();
            }
            if (contentText && contentText !== this.lastContentText) {
              this.lastContentText = contentText;
              requestAnimationFrame(() => {
                storyContent.innerHTML = `<p class="story-text">${contentText}</p>`;
                const font = localStorage.getItem('teresen_font') || "'Source Han Serif', 'ÊÄùÊ∫êÂÆã‰Ωì', serif";
                const size = localStorage.getItem('teresen_font_size') || '1';
                $('.story-text').css({
                  'font-family': font,
                  'font-size': size + 'em',
                });
              });
            }
            if (actionText !== this.lastActionText) {
              this.lastActionText = actionText;
              this.updateActionOptionsFromContent(actionText);
            } else if (!actionText && this.lastActionText) {
              this.lastActionText = '';
              this.updateActionOptionsFromContent('');
            }
            let variableUpdateText = '';
            const variableMatches = [...fullText.matchAll(/<UpdateVariable>([\s\S]*?)(?:<\/UpdateVariable>|$)/g)];
            if (variableMatches.length > 0) {
              const lastMatch = variableMatches[variableMatches.length - 1];
              variableUpdateText = lastMatch[1].trim();
            }
            if (variableUpdateText) {
              this.updateVariableDecoration(variableUpdateText, true); 
            }
          } catch (e) {
            console.error('Th·ª±c thi c·∫≠p nh·∫≠t lu·ªìng th·∫•t b·∫°i:', e);
          }
        }

        startHighFrequencyStreaming() {
          if (this.highFrequencyStreamingInterval) {
            clearInterval(this.highFrequencyStreamingInterval);
          }
          this.highFrequencyStreamingInterval = setInterval(() => {
            const isGenerating = document.querySelector('.generating-indicator')?.style.display !== 'none';
            if (!isGenerating) {
              clearInterval(this.highFrequencyStreamingInterval);
              this.highFrequencyStreamingInterval = null;
              this.isStreaming = false;
              const latestMessage = document.querySelector('.message:last-child .message-content');
              if (latestMessage && latestMessage.textContent) {
                this._doStreamUpdate(latestMessage.textContent);
              }
              const decoration = document.getElementById('variable-update-decoration');
              if (decoration) {
                decoration.classList.remove('updating');
              }
              return;
            }
            const latestMessage = document.querySelector('.message:last-child .message-content');
            if (latestMessage && latestMessage.textContent) {
              this.handleStreamUpdate(latestMessage.textContent);
            }
          }, 150); 
        }

        async handleGenerationEnd(finalText) {
          try {
            console.log('üîÑ X·ª≠ l√Ω k·∫øt th√∫c t·∫°o n·ªôi dung...');
            console.log(`  - ƒê·ªô d√†i finalText: ${finalText?.length || 0}`);
            console.log(`  - ƒê·ªô d√†i chatHistoryCache hi·ªán t·∫°i: ${this.chatHistoryCache?.length || 0}`);

            const storyContent = document.getElementById('story-content');
            if (!finalText || !finalText.trim()) {
              console.warn('‚ö†Ô∏è finalText tr·ªëng ho·∫∑c kh√¥ng h·ª£p l·ªá, t·∫°o n·ªôi dung th·∫•t b·∫°i, kh√¥i ph·ª•c nguy√™n vƒÉn');
              if (storyContent && this.lastValidStoryContentBeforeGeneration) {
                storyContent.innerHTML = this.lastValidStoryContentBeforeGeneration;
                console.log('‚úÖ ƒê√£ kh√¥i ph·ª•c nguy√™n vƒÉn tr∆∞·ªõc khi t·∫°o, tr√°nh hi·ªÉn th·ªã n·ªôi dung tr·ªëng');
              }
              return; 
            }
            const hasContentTag = /<content>[\s\S]*?<\/content>/i.test(finalText);
            if (!hasContentTag) {
              console.warn('‚ö†Ô∏è finalText kh√¥ng c√≥ th·∫ª content h·ª£p l·ªá, t·∫°o n·ªôi dung th·∫•t b·∫°i, kh√¥i ph·ª•c nguy√™n vƒÉn');
              if (storyContent && this.lastValidStoryContentBeforeGeneration) {
                storyContent.innerHTML = this.lastValidStoryContentBeforeGeneration;
                console.log('‚úÖ ƒê√£ kh√¥i ph·ª•c nguy√™n vƒÉn tr∆∞·ªõc khi t·∫°o, v√¨ kh√¥ng c√≥ th·∫ª content h·ª£p l·ªá');
              }
              return; 
            }
            console.log('üîÑ C·∫≠p nh·∫≠t ph·∫ßn t·ª≠ giao di·ªán (b·ªè qua c·∫≠p nh·∫≠t n·ªôi dung ch√≠nh, gi·ªØ hi·ªÉn th·ªã truy·ªÅn lu·ªìng)');
            this.updateTrainerStatus();
            this.updateUmaStatus();
            this.updateTimeDisplay();
            this.updateReplyTimer();
            this.updateLocationImage();
            this.initSexPositionSection();
            this.updateSexPositionImage();
            this.updateTaskList();
            this.updateInventory();
            this.updateRules();
            this.updateCurrencySystem();
            this.updateFestivalNotice();
            if (finalText && finalText.trim()) {
              const variableMatch = finalText.match(/<UpdateVariable>(.*?)<\/UpdateVariable>/s);
              if (variableMatch) {
                const updateScript = variableMatch[1].trim();
                console.log('üìä Ph√°t hi·ªán c·∫≠p nh·∫≠t bi·∫øn:', updateScript);
                this.updateVariableDecoration(updateScript, false);
                if (this.currentMvuState && updateScript) {
                  const inputData = { old_variables: this.currentMvuState };
                  try {
                    const mvuPromise = eventEmit('mag_invoke_mvu', updateScript, inputData);
                    const timeoutPromise = new Promise((_, reject) =>
                      setTimeout(() => reject(new Error('MVU event timeout')), 3000),
                    );
                    await Promise.race([mvuPromise, timeoutPromise]);

                    if (inputData.new_variables) {
                      this.currentMvuState = inputData.new_variables;
                      console.log('‚úÖ C·∫≠p nh·∫≠t bi·∫øn MVU th√†nh c√¥ng');
                    }
                  } catch (eventError) {
                    console.error('‚ùå C·∫≠p nh·∫≠t bi·∫øn MVU th·∫•t b·∫°i:', eventError);
                  }
                }
              } else {
                this.updateVariableDecoration('');
              }
              console.log('üìù B·∫Øt ƒë·∫ßu tr√≠ch xu·∫•t k√Ω ·ª©c...');
              const cleanedText = finalText.replace(/<safe>[\s\S]*?<\/safe>/g, '');
              this.lastExtractedJourney = this._extractLastTagContent('Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y', cleanedText);
              this.lastExtractedCoreMemory = this._extractLastTagContent('K√Ω ·ª©c c·ªët l√µi v√≤ng l·∫∑p n√†y', cleanedText);
              if (this.isAutoWriteEnabled) {
                if (this.lastExtractedJourney) {
                  await this.writeJourneyToLorebook(true); 
                  this.lastWrittenJourney = this.lastExtractedJourney;
                  console.log('‚úÖ Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y ƒë√£ ghi v√†o S√°ch th·∫ø gi·ªõi');
                }
                if (this.lastExtractedCoreMemory) {
                  await this.writeCoreMemoryToLorebook(true);
                  this.lastWrittenCoreMemory = this.lastExtractedCoreMemory;
                  console.log('‚úÖ K√Ω ·ª©c c·ªët l√µi v√≤ng l·∫∑p n√†y ƒë√£ ghi v√†o S√°ch th·∫ø gi·ªõi');
                }
              }
              console.log(`[H·ªá th·ªëng l·ªãch s·ª≠] Chu·∫©n b·ªã l∆∞u snapshot v√≤ng ch∆°i, ƒë·ªô d√†i cleanedText: ${cleanedText?.length || 0}`);
              await this._finalizeTurn(cleanedText);
              console.log(
                `[H·ªá th·ªëng l·ªãch s·ª≠] L∆∞u snapshot v√≤ng ch∆°i ho√†n t·∫•t, ƒë·ªô d√†i chatHistoryCache hi·ªán t·∫°i: ${this.chatHistoryCache?.length || 0}`,
              );
              if (this.isAutoSaveEnabled) {
                await this.performAutoSave();
              }
            } else {
              console.warn('[H·ªá th·ªëng l·ªãch s·ª≠] ‚ö†Ô∏è finalText tr·ªëng, b·ªè qua l∆∞u snapshot v√≤ng ch∆°i');
            }

            console.log('‚úÖ X·ª≠ l√Ω k·∫øt th√∫c t·∫°o n·ªôi dung ho√†n t·∫•t');
          } catch (e) {
            console.error('‚ùå X·ª≠ l√Ω k·∫øt th√∫c t·∫°o n·ªôi dung th·∫•t b·∫°i:', e);
          }
        }
        _extractLastTagContent(tagName, text, keepTags = false) {
          if (!text || typeof text !== 'string') return '';
          const regex = new RegExp(`<${tagName}>([\\s\\S]*?)<\\/${tagName}>`, 'gi');
          const matches = [...text.matchAll(regex)];

          if (matches.length === 0) return '';
          const lastMatch = matches[matches.length - 1];
          const content = lastMatch[1].trim();

          return keepTags ? `<${tagName}>${content}</${tagName}>` : content;
        }
        _getHistoryKey() {
          const chatId = TavernHelper?.chatId;
          if (!chatId) {
            console.warn('[H·ªá th·ªëng l·ªãch s·ª≠] Kh√¥ng th·ªÉ l·∫•y chatId, s·ª≠ d·ª•ng l·ªãch s·ª≠ to√†n c·ª•c');
            return 'frontend_chat_history_fallback';
          }
          return `frontend_chat_history_${chatId}`;
        }

        
        async loadChatHistoryFromExtra() {
          try {
            if (typeof SillyTavern === 'undefined' || !SillyTavern.chat || SillyTavern.chat.length === 0) {
              console.log('üìù SillyTavern.chat tr·ªëng, tr·∫£ v·ªÅ m·∫£ng r·ªóng');
              return [];
            }

            const chat = SillyTavern.chat;
            for (let i = chat.length - 1; i >= 0; i--) {
              const msg = chat[i];
              if (msg.extra?.teresen_chat && Array.isArray(msg.extra.teresen_chat)) {
                console.log(`‚úÖ ƒê√£ t·∫£i ${msg.extra.teresen_chat.length} tin nh·∫Øn t·ª´ extra.teresen_chat c·ªßa tin nh·∫Øn th·ª© ${i}`);
                return JSON.parse(JSON.stringify(msg.extra.teresen_chat)); 
              }
            }

            console.log('üìù Kh√¥ng t√¨m th·∫•y extra.teresen_chat, tr·∫£ v·ªÅ m·∫£ng r·ªóng');
            return [];
          } catch (error) {
            console.error('‚ùå T·∫£i l·ªãch s·ª≠ tr√≤ chuy·ªán th·∫•t b·∫°i:', error);
            return [];
          }
        }

        
        async saveChatHistoryToExtra(chatHistory, updatedVariables = null) {
          try {
            if (typeof SillyTavern === 'undefined' || !SillyTavern.chat || SillyTavern.chat.length === 0) {
              console.error('‚ùå Kh√¥ng th·ªÉ l·∫•y b·∫£n ghi tr√≤ chuy·ªán, kh√¥ng th·ªÉ l∆∞u l·ªãch s·ª≠ tr√≤ chuy·ªán');
              return;
            }

            const lastMessage = SillyTavern.chat[SillyTavern.chat.length - 1];
            if (!lastMessage.extra) {
              lastMessage.extra = {};
            }
            lastMessage.extra.teresen_chat = JSON.parse(JSON.stringify(chatHistory)); 
            if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
              await SillyTavern.saveChat();
              console.log(
                `‚úÖ ƒê√£ l∆∞u ${chatHistory.length} tin nh·∫Øn v√†o extra.teresen_chat c·ªßa tin nh·∫Øn cu·ªëi c√πng th√¥ng qua SillyTavern.saveChat()`,
              );
            } else {
              await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });
              console.log(
                `‚úÖ ƒê√£ l∆∞u ${chatHistory.length} tin nh·∫Øn v√†o extra.teresen_chat c·ªßa tin nh·∫Øn cu·ªëi c√πng th√¥ng qua setChatMessages (kh√¥ng c·∫≠p nh·∫≠t tr∆∞·ªùng message)`,
              );
            }
            if (updatedVariables) {
              try {
                if (typeof updateVariablesWith === 'function' && typeof getVariables === 'function') {
                  await updateVariablesWith(() => JSON.parse(JSON.stringify(updatedVariables)), {
                    type: 'message',
                    message_id: 'latest',
                  });
                  const updated = getVariables({ type: 'message' });
                  await updateVariablesWith(() => updated, { type: 'chat' });

                  console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t bi·∫øn t·∫ßng message v√† chat th√¥ng qua updateVariablesWith');
                } else {
                  console.warn('‚ö†Ô∏è updateVariablesWith ho·∫∑c getVariables kh√¥ng kh·∫£ d·ª•ng, bi·∫øn ch·ªâ ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô');
                }
              } catch (commitError) {
                console.error('‚ùå G·ª≠i c·∫≠p nh·∫≠t bi·∫øn th·∫•t b·∫°i:', commitError);
              }
            }
          } catch (error) {
            console.error('‚ùå L∆∞u l·ªãch s·ª≠ tr√≤ chuy·ªán th·∫•t b·∫°i:', error);
          }
        }

        
        async addMessageToExtra(role, content, variableState = null) {
          try {
            let chatHistory = await this.loadChatHistoryFromExtra();
            const newMessage = {
              role: role,
              content: content,
              id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
              timestamp: Date.now(),
              variableState: variableState ? JSON.parse(JSON.stringify(variableState)) : null,
            };
            chatHistory.push(newMessage);
            const variablesToSave = variableState || null;
            await this.saveChatHistoryToExtra(chatHistory, variablesToSave);

            console.log(`‚úÖ ƒê√£ th√™m tin nh·∫Øn ${role} v√†o extra.teresen_chat`);
            return newMessage;
          } catch (error) {
            console.error('‚ùå Th√™m tin nh·∫Øn th·∫•t b·∫°i:', error);
            throw error;
          }
        }

        
        async getLatestMessageFromExtra() {
          try {
            const chatHistory = await this.loadChatHistoryFromExtra();
            if (chatHistory.length === 0) return null;
            return chatHistory[chatHistory.length - 1];
          } catch (error) {
            console.error('‚ùå L·∫•y tin nh·∫Øn m·ªõi nh·∫•t th·∫•t b·∫°i:', error);
            return null;
          }
        }

        
        async _processVariables(content, currentVariables) {
          const inputData = { old_variables: currentVariables };
          try {
            if ('function' == typeof window.eventEmit) {
              await window.eventEmit('mag_invoke_mvu', content, inputData);
              if (inputData.new_variables) {
                const updatedVariables = inputData.new_variables;
                return {
                  updatedVariables: updatedVariables,
                  snapshot: JSON.parse(JSON.stringify(updatedVariables)),
                };
              }
            }
          } catch (error) {
            console.error('‚ùå X·ª≠ l√Ω bi·∫øn th·∫•t b·∫°i:', error);
          }
          return {
            updatedVariables: currentVariables,
            snapshot: JSON.parse(JSON.stringify(currentVariables)),
          };
        }

        
        async _syncStateWithHistory(chatHistory) {
          const variables = (chatHistory.length > 0 && chatHistory[chatHistory.length - 1].variableState) || {};
          await this.saveChatHistoryToExtra(chatHistory, variables);
        }

        
        async restoreVariableStateFromLastMessage() {
          try {
            const chatHistory = await this.loadChatHistoryFromExtra();

            if (chatHistory && chatHistory.length > 0) {
              const lastMessage = chatHistory[chatHistory.length - 1];
              const variableState = lastMessage?.variableState || null;

              if (variableState) {
                console.log('üîÑ Kh√¥i ph·ª•c tr·∫°ng th√°i bi·∫øn t·ª´ tin nh·∫Øn cu·ªëi c√πng...');
                this.currentMvuState = JSON.parse(JSON.stringify(variableState));
                try {
                  if (typeof updateVariablesWith === 'function' && typeof getVariables === 'function') {
                    await updateVariablesWith(() => JSON.parse(JSON.stringify(variableState)), {
                      type: 'message',
                      message_id: 'latest',
                    });
                    const updated = getVariables({ type: 'message' });
                    await updateVariablesWith(() => updated, { type: 'chat' });

                    console.log('‚úÖ ƒê√£ kh√¥i ph·ª•c tr·∫°ng th√°i bi·∫øn t·∫ßng message v√† chat th√¥ng qua updateVariablesWith');
                  } else {
                    console.warn('‚ö†Ô∏è updateVariablesWith ho·∫∑c getVariables kh√¥ng kh·∫£ d·ª•ng, ch·ªâ c·∫≠p nh·∫≠t tr·∫°ng th√°i c·ª•c b·ªô');
                  }
                } catch (varError) {
                  console.error('‚ùå Kh√¥i ph·ª•c tr·∫°ng th√°i bi·∫øn th·∫•t b·∫°i:', varError);
                }
                if (variableState.stat_data) {
                  this.renderUI(variableState.stat_data);
                }

                console.log('‚úÖ Tr·∫°ng th√°i bi·∫øn ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c t·ª´ tin nh·∫Øn cu·ªëi c√πng');
                return variableState;
              } else {
                console.log('üìù Tin nh·∫Øn cu·ªëi c√πng kh√¥ng c√≥ variableState, b·ªè qua kh√¥i ph·ª•c bi·∫øn');
              }
            } else {
              console.log('üìù L·ªãch s·ª≠ tr√≤ chuy·ªán tr·ªëng, b·ªè qua kh√¥i ph·ª•c bi·∫øn');
            }
          } catch (error) {
            console.error('‚ùå Kh√¥i ph·ª•c tr·∫°ng th√°i bi·∫øn th·∫•t b·∫°i:', error);
          }
          return null;
        }
        _getBaseJourneyKey() {
          const index = this.unifiedIndex || 1;
          return index > 1 ? `Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y(${index})` : 'Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y';
        }

        _getBaseCoreMemoryKey() {
          const index = this.unifiedIndex || 1;
          return index > 1 ? `K√Ω ·ª©c c·ªët l√µi v√≤ng l·∫∑p n√†y(${index})` : 'K√Ω ·ª©c c·ªët l√µi v√≤ng l·∫∑p n√†y';
        }
        async _disableOtherPlaythroughEntries(bookName, baseEntryKey, currentEntryKey) {
          try {
            const allEntries = await TavernHelper.getLorebookEntries(bookName);
            const entriesToDisable = [];

            for (const entry of allEntries) {
              const isSameType = entry.comment.startsWith(baseEntryKey);
              const isNotCurrent = entry.comment !== currentEntryKey;

              if (isSameType && isNotCurrent && entry.enabled) {
                entriesToDisable.push({ uid: entry.uid, enabled: false });
              }
            }

            if (entriesToDisable.length > 0) {
              await TavernHelper.setLorebookEntries(bookName, entriesToDisable);
              console.log(`‚úÖ ƒê√£ v√¥ hi·ªáu h√≥a ${entriesToDisable.length} m·ª•c "${baseEntryKey}" c·ªßa c√°c v√≤ng l·∫∑p kh√°c`);
            }
          } catch (error) {
            console.error('V√¥ hi·ªáu h√≥a m·ª•c v√≤ng l·∫∑p kh√°c th·∫•t b·∫°i:', error);
          }
        }
        async _checkNewGameSession() {
          try {
            const sessionStart = performance.now();
            const currentChatId = TavernHelper?.chatId || 'default';
            const lastChatIdKey = 'teresen_last_chat_id';
            const lastChatId = localStorage.getItem(lastChatIdKey);
            const cacheStart = performance.now();
            await this._loadHistoryCache();
            const cacheEnd = performance.now();
            console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] _loadHistoryCache t·ªën: ${(cacheEnd - cacheStart).toFixed(2)}ms`);
            if (lastChatId && lastChatId !== currentChatId) {
              console.log(`[Ph√°t hi·ªán game m·ªõi] Ph√°t hi·ªán chatId thay ƒë·ªïi: ${lastChatId} -> ${currentChatId}`);
              if (this.chatHistoryCache.length === 0) {
                console.log('[Ph√°t hi·ªán game m·ªõi] Cache l·ªãch s·ª≠ tr·ªëng, chu·∫©n b·ªã b·∫Øt ƒë·∫ßu game m·ªõi');
                const historyKey = this._getHistoryKey();
                localStorage.removeItem(historyKey);
              } else {
                console.log(
                  `[Ph√°t hi·ªán game m·ªõi] Ph√°t hi·ªán b·∫£n ghi l·ªãch s·ª≠ c√≥ s·∫µn (${this.chatHistoryCache.length} v√≤ng), gi·ªØ l·∫°i l·ªãch s·ª≠ (c√≥ th·ªÉ l√† tr·∫°ng th√°i sau khi ƒë·ªçc file)`,
                );
              }
            }
            localStorage.setItem(lastChatIdKey, currentChatId);
            if (this.chatHistoryCache.length === 0 && this.currentMvuState) {
              console.log('[Ph√°t hi·ªán game m·ªõi] Ph√°t hi·ªán game m·ªõi, ƒëang t·∫°o snapshot tr·∫°ng th√°i ban ƒë·∫ßu...');
              try {
                let initialMessage = 'Tr√≤ ch∆°i b·∫Øt ƒë·∫ßu';
                try {
                  const initMsgStart = performance.now();
                  const messages = await getChatMessages('0');
                  const initMsgEnd = performance.now();
                  console.log(
                    `‚è±Ô∏è [Hi·ªáu nƒÉng] getChatMessages('0') trong _checkNewGameSession t·ªën: ${(initMsgEnd - initMsgStart).toFixed(2)}ms`,
                  );
                  initialMessage = messages?.[0]?.message || 'Tr√≤ ch∆°i b·∫Øt ƒë·∫ßu';
                } catch (e) {
                  console.warn('[Ph√°t hi·ªán game m·ªõi] L·∫•y tin nh·∫Øn ban ƒë·∫ßu th·∫•t b·∫°i, s·ª≠ d·ª•ng gi√° tr·ªã m·∫∑c ƒë·ªãnh');
                }

                const initialSnapshot = {
                  message_id: `frontend-hist-initial-${Date.now()}`,
                  message: initialMessage.substring(0, 100), 
                  is_user: false,
                  role: 'assistant',
                  data: {
                    ...JSON.parse(JSON.stringify(this.currentMvuState)),
                  },
                  timestamp: Date.now(),
                };

                this.chatHistoryCache.push(initialSnapshot);
                const historyKey = this._getHistoryKey();
                localStorage.setItem(historyKey, JSON.stringify(this.chatHistoryCache));
                this.historyViewIndex = 0;

                console.log('[Ph√°t hi·ªán game m·ªõi] ‚úÖ Snapshot ban ƒë·∫ßu ƒë√£ ƒë∆∞·ª£c t·∫°o v√† l∆∞u th√†nh c√¥ng!');
              } catch (e) {
                console.error('[Ph√°t hi·ªán game m·ªõi] T·∫°o snapshot ban ƒë·∫ßu th·∫•t b·∫°i:', e);
              }
            }
            const sessionEnd = performance.now();
            console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] _checkNewGameSession t·ªïng th·ªùi gian: ${(sessionEnd - sessionStart).toFixed(2)}ms`);
          } catch (error) {
            console.error('[Ph√°t hi·ªán game m·ªõi] Ki·ªÉm tra phi√™n game m·ªõi th·∫•t b·∫°i:', error);
            const sessionEnd = performance.now();
            console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] _checkNewGameSession th·∫•t b·∫°i, t·ªïng th·ªùi gian: ${(sessionEnd - sessionStart).toFixed(2)}ms`);
          }
        }
        async _finalizeTurn(textToSave) {
          try {
            if (!textToSave || !textToSave.trim()) {
              console.warn('[H·ªá th·ªëng l·ªãch s·ª≠] VƒÉn b·∫£n tr·ªëng, b·ªè qua l∆∞u snapshot');
              return;
            }

            const newSnapshot = {
              message_id: `frontend-hist-${Date.now()}`,
              message: textToSave,
              is_user: false,
              role: 'assistant',
              data: {
                ...(this.currentMvuState ? JSON.parse(JSON.stringify(this.currentMvuState)) : {}),
              },
              timestamp: Date.now(),
            };
            if (!Array.isArray(this.chatHistoryCache)) {
              console.warn('[H·ªá th·ªëng l·ªãch s·ª≠] chatHistoryCache kh√¥ng ph·∫£i l√† m·∫£ng, kh·ªüi t·∫°o l·∫°i');
              this.chatHistoryCache = [];
            }

            this.chatHistoryCache.push(newSnapshot);
            if (this.chatHistoryCache.length > 50) {
              this.chatHistoryCache.shift();
            }
            const historyKey = this._getHistoryKey();
            localStorage.setItem(historyKey, JSON.stringify(this.chatHistoryCache));
            this.historyViewIndex = this.chatHistoryCache.length - 1;

            console.log(`[H·ªá th·ªëng l·ªãch s·ª≠] ‚úÖ Snapshot v√≤ng ch∆°i m·ªõi ƒë√£ ƒë∆∞·ª£c l∆∞u!`);
            console.log(`  - T·ªïng s·ªë hi·ªán t·∫°i: ${this.chatHistoryCache.length}`);
            console.log(`  - ƒê·ªô d√†i tin nh·∫Øn: ${textToSave.length} k√Ω t·ª±`);
            console.log(`  - Kh√≥a l∆∞u tr·ªØ: ${historyKey}`);
          } catch (error) {
            console.error('[H·ªá th·ªëng l·ªãch s·ª≠] ‚ùå L∆∞u snapshot v√≤ng ch∆°i th·∫•t b·∫°i:', error);
          }
        }
        async _loadHistoryCache() {
          const loadCacheStart = performance.now();
          try {
            const storedHistory = await new Promise(resolve => {
              if ('requestIdleCallback' in window) {
                requestIdleCallback(
                  () => {
                    const getItemStart = performance.now();
                    const data = localStorage.getItem(this._getHistoryKey());
                    const getItemEnd = performance.now();
                    console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] localStorage.getItem t·ªën: ${(getItemEnd - getItemStart).toFixed(2)}ms`);
                    resolve(data);
                  },
                  { timeout: 100 },
                ); 
              } else {
                const getItemStart = performance.now();
                const data = localStorage.getItem(this._getHistoryKey());
                const getItemEnd = performance.now();
                console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] localStorage.getItem t·ªën: ${(getItemEnd - getItemStart).toFixed(2)}ms`);
                resolve(data);
              }
            });

            if (storedHistory) {
              const parsed = await new Promise((resolve, reject) => {
                setTimeout(() => {
                  try {
                    const parseStart = performance.now();
                    const result = JSON.parse(storedHistory);
                    const parseEnd = performance.now();
                    console.log(
                      `‚è±Ô∏è [Hi·ªáu nƒÉng] JSON.parse t·ªën: ${(parseEnd - parseStart).toFixed(2)}ms (K√≠ch th∆∞·ªõc d·ªØ li·ªáu: ${storedHistory.length} k√Ω t·ª±)`,
                    );
                    resolve(result);
                  } catch (e) {
                    reject(e);
                  }
                }, 0);
              });

              if (Array.isArray(parsed) && parsed.length > 0) {
                this.chatHistoryCache = parsed;
                this.historyViewIndex = this.chatHistoryCache.length - 1;
                console.log(`[H·ªá th·ªëng l·ªãch s·ª≠] ƒê√£ t·∫£i ${this.chatHistoryCache.length} b·∫£n ghi l·ªãch s·ª≠`);
              } else {
                this.chatHistoryCache = [];
                this.historyViewIndex = -1;
              }
            } else {
              this.chatHistoryCache = [];
              this.historyViewIndex = -1;
            }
          } catch (error) {
            console.error('[H·ªá th·ªëng l·ªãch s·ª≠] T·∫£i cache l·ªãch s·ª≠ th·∫•t b·∫°i:', error);
            this.chatHistoryCache = [];
            this.historyViewIndex = -1;
          }
          const loadCacheEnd = performance.now();
          console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] _loadHistoryCache t·ªën: ${(loadCacheEnd - loadCacheStart).toFixed(2)}ms`);
        }
        parseJourneyEntry(contentString) {
          if (!contentString || typeof contentString !== 'string') return [];
          try {
            const events = [];
            const eventBlocks = contentString
              .trim()
              .split(/\n*\s*STT\|/)
              .filter(s => s.trim() !== '');

            const fieldOrder = [
              'Ng√†y',
              'Ti√™u ƒë·ªÅ',
              'ƒê·ªãa ƒëi·ªÉm',
              'Nh√¢n v·∫≠t',
              'M√¥ t·∫£',
              'Quan h·ªá nh√¢n v·∫≠t',
              'Nh√£n',
              'Th√¥ng tin quan tr·ªçng',
              'Tuy·∫øn ng·∫ßm v√† ƒëi·ªÅm b√°o',
              'H·ªá th·ªëng t·ª± ƒë·ªông',
            ];

            eventBlocks.forEach(block => {
              const firstLineEnd = block.indexOf('\n');
              const seq = block.substring(0, firstLineEnd !== -1 ? firstLineEnd : undefined).trim();
              if (!/\d+/.test(seq)) return; 

              const event = { STT: seq };
              let remainingBlock = firstLineEnd !== -1 ? block.substring(firstLineEnd).trim() : '';
              const lines = remainingBlock.split('\n');
              let currentKey = null;
              for (const line of lines) {
                let matched = false;
                for (const key of fieldOrder) {
                  if (line.startsWith(key + '|')) {
                    if (currentKey && event[currentKey] === undefined) {
                      event[currentKey] = '';
                    }
                    currentKey = key;
                    event[currentKey] = line.substring(key.length + 1).trim();
                    matched = true;
                    break;
                  }
                }
                if (!matched && currentKey && event[currentKey] !== undefined) {
                  event[currentKey] += '\n' + line;
                }
              }
              events.push(event);
            });

            return events;
          } catch (e) {
            console.error('L·ªói khi ph√¢n t√≠ch "Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y":', e);
            return [];
          }
        }
        stringifyJourneyEvent(event) {
          const fieldOrder = [
            'STT',
            'Ng√†y',
            'Ti√™u ƒë·ªÅ',
            'ƒê·ªãa ƒëi·ªÉm',
            'Nh√¢n v·∫≠t',
            'M√¥ t·∫£',
            'Quan h·ªá nh√¢n v·∫≠t',
            'Nh√£n',
            'Th√¥ng tin quan tr·ªçng',
            'Tuy·∫øn ng·∫ßm v√† ƒëi·ªÅm b√°o',
            'H·ªá th·ªëng t·ª± ƒë·ªông',
          ];
          return fieldOrder
            .map(key => (event[key] ? `${key}|${event[key]}` : null))
            .filter(Boolean)
            .join('\n');
        }
        async writeToLorebook(baseEntryKey, contentToWrite, silent = false) {
          if (!contentToWrite || contentToWrite.trim() === '') {
            if (!silent) console.log('Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ ghi.');
            return;
          }

          const index = this.unifiedIndex || 1;
          const finalEntryKey = index > 1 ? `${baseEntryKey}(${index})` : baseEntryKey;
          const bookName = '- Uma Musume: Chuy·ªán l·∫° Tracen'; 
          const reformattedContent = contentToWrite.trim();

          try {
            const allEntries = await TavernHelper.getLorebookEntries(bookName);
            let targetEntry = allEntries.find(entry => entry.comment === finalEntryKey);
            if (!targetEntry) {
              if (!silent) console.log(`M·ª•c "${finalEntryKey}" kh√¥ng t·ªìn t·∫°i, ƒëang t·∫°o m·ªõi...`);
              const baseEntryTemplate = allEntries.find(entry => entry.comment === baseEntryKey);
              const newEntryData = {
                comment: finalEntryKey,
                content: reformattedContent,
                keys: baseEntryTemplate ? [...baseEntryTemplate.keys, finalEntryKey] : [finalEntryKey],
                enabled: true, 
                selective: baseEntryTemplate?.selective,
                constant: baseEntryTemplate?.constant,
                position: baseEntryTemplate?.position || 'in_chat',
                case_sensitive: baseEntryTemplate?.case_sensitive,
              };
              await TavernHelper.createLorebookEntries(bookName, [newEntryData]);
              if (!silent) console.log(`ƒê√£ t·∫°o v√† ghi v√†o "${finalEntryKey}", v√† ƒë√£ k√≠ch ho·∫°t.`);
              await this._disableOtherPlaythroughEntries(bookName, baseEntryKey, finalEntryKey);
              return;
            }
            const existingContent = targetEntry.content || '';
            let finalContent = '';

            if (baseEntryKey === 'Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y') {
              const existingEvents = this.parseJourneyEntry(existingContent);
              const newEvents = this.parseJourneyEntry(reformattedContent);
              if (newEvents.length === 0) return;

              const newEvent = newEvents[0];
              const newEventId = newEvent['STT'];
              const eventIndex = existingEvents.findIndex(event => event['STT'] === newEventId);

              if (eventIndex !== -1) {
                existingEvents[eventIndex] = newEvent;
                if (!silent) console.log(`ƒê√£ c·∫≠p nh·∫≠t s·ª± ki·ªán #${newEventId}.`);
              } else {
                existingEvents.push(newEvent);
                if (!silent) console.log(`ƒê√£ th√™m s·ª± ki·ªán m·ªõi #${newEventId}.`);
              }
              existingEvents.sort((a, b) => (parseInt(a.STT, 10) || 0) - (parseInt(b.STT, 10) || 0));
              finalContent = existingEvents.map(ev => this.stringifyJourneyEvent(ev)).join('\n\n');
            } else if (baseEntryKey === 'K√Ω ·ª©c c·ªët l√µi v√≤ng l·∫∑p n√†y') {
              finalContent = reformattedContent;
              if (!silent) console.log(`ƒê√£ c·∫≠p nh·∫≠t "${finalEntryKey}".`);
            } else {
              if (existingContent.includes(reformattedContent)) {
                if (!silent) console.log('N·ªôi dung ƒë√£ t·ªìn t·∫°i, kh√¥ng c·∫ßn ghi l·∫°i.');
                return;
              }
              finalContent = existingContent + (existingContent ? '\n\n' : '') + reformattedContent;
              if (!silent) console.log(`ƒê√£ th√™m n·ªôi dung v√†o "${finalEntryKey}".`);
            }
            await TavernHelper.setLorebookEntries(bookName, [{ uid: targetEntry.uid, content: finalContent }]);
          } catch (error) {
            console.error(`L·ªói khi ghi S√°ch th·∫ø gi·ªõi "${finalEntryKey}":`, error);
            if (!silent) console.error(`Ghi th·∫•t b·∫°i: ${error.message}`);
          }
        }
        async writeJourneyToLorebook(silent = false) {
          const content = this.lastExtractedJourney;
          await this.writeToLorebook('Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y', content, silent);
        }
        async writeCoreMemoryToLorebook(silent = false) {
          const content = this.lastExtractedCoreMemory;
          await this.writeToLorebook('K√Ω ·ª©c c·ªët l√µi v√≤ng l·∫∑p n√†y', content, silent);
        }
        async _assembleDynamicContext(userMessage) {
          let contextParts = [];
          const stat_data = this.currentMvuState?.stat_data;
          if (!stat_data) return '';
          try {
            const bookName = '- Uma Musume: Chuy·ªán l·∫° Tracen';
            const index = this.unifiedIndex || 1;
            const journeyKey = index > 1 ? `Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y(${index})` : 'Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y';
            const allEntries = await TavernHelper.getLorebookEntries(bookName);
            const journeyEntry = allEntries.find(entry => entry.comment === journeyKey);

            if (journeyEntry && journeyEntry.content) {
              const events = this.parseJourneyEntry(journeyEntry.content);
              if (events.length > 0) {
                const recentEvents = events.slice(-5); 
                const recentEventsText = recentEvents.map(ev => this.stringifyJourneyEvent(ev)).join('\n\n');
                contextParts.push(`[Nh·ªØng s·ª± ki·ªán g·∫ßn ƒë√¢y]\n${recentEventsText}`);
              }
            }
          } catch (e) {
            console.error('[H·ªá th·ªëng k√Ω ·ª©c] L·ªói khi tr√≠ch xu·∫•t k√Ω ·ª©c ng·∫Øn h·∫°n:', e);
          }
          try {
            const bookName = '- Uma Musume: Chuy·ªán l·∫° Tracen';
            const index = this.unifiedIndex || 1;
            const coreMemoryKey = index > 1 ? `K√Ω ·ª©c c·ªët l√µi v√≤ng l·∫∑p n√†y(${index})` : 'K√Ω ·ª©c c·ªët l√µi v√≤ng l·∫∑p n√†y';
            const allEntries = await TavernHelper.getLorebookEntries(bookName);
            const coreMemoryEntry = allEntries.find(entry => entry.comment === coreMemoryKey);

            if (coreMemoryEntry && coreMemoryEntry.content) {
              contextParts.push(`[T√≥m t·∫Øt c·ªët truy·ªán ch√≠nh]\n${coreMemoryEntry.content}`);
            }
          } catch (e) {
            console.error('[H·ªá th·ªëng k√Ω ·ª©c] L·ªói khi tr√≠ch xu·∫•t k√Ω ·ª©c c·ªët l√µi:', e);
          }
          return contextParts.join('\n\n');
        }

        setupStreamListeners() {
          try {
            const streamingCheckbox = document.getElementById('streaming-checkbox');
            if (streamingCheckbox) {
              streamingCheckbox.addEventListener('change', event => {
                const isEnabled = event.target.checked;
                console.log(isEnabled ? '‚úÖ Truy·ªÅn lu·ªìng ƒë√£ b·∫≠t' : '‚ùå Truy·ªÅn lu·ªìng ƒë√£ t·∫Øt');
                localStorage.setItem('teresen_streaming_enabled', isEnabled.toString());
              });
              const savedState = localStorage.getItem('teresen_streaming_enabled');
              if (savedState === 'true') {
                streamingCheckbox.checked = true;
              } else {
                streamingCheckbox.checked = true;
                localStorage.setItem('teresen_streaming_enabled', 'true');
              }
              console.log('üîÑ S·ª± ki·ªán checkbox truy·ªÅn lu·ªìng ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p');
            }
            const chatHistoryCheckbox = document.getElementById('chat-history-checkbox');
            if (chatHistoryCheckbox) {
              chatHistoryCheckbox.addEventListener('change', async event => {
                const isEnabled = event.target.checked;
                if (isEnabled) {
                  console.log('‚úÖ Hi·ªÉn th·ªã l·ªãch s·ª≠ tr√≤ chuy·ªán trong khu v·ª±c n·ªôi dung c√¢u chuy·ªán...');
                  await this.handleChatHistory();
                } else {
                  await this.restoreStoryContent();
                }
              });
              console.log('üîÑ S·ª± ki·ªán n√∫t xem tr√≤ chuy·ªán ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p');
            }

            if ('undefined' != typeof eventOn && void 0 !== window.iframe_events) {
              const e = window.iframe_events;

              (eventOn(e.GENERATION_STARTED, () => {
                (console.log('üöÄ AI b·∫Øt ƒë·∫ßu t·∫°o ph·∫£n h·ªìi'),
                  (this.isStreaming = true),
                  (() => {
                    const storyContent = document.getElementById('story-content');
                    if (storyContent) {
                      this.lastValidStoryContentBeforeGeneration = storyContent.innerHTML;
                      console.log('üíæ ƒê√£ l∆∞u n·ªôi dung ch√≠nh vƒÉn b·∫£n tr∆∞·ªõc khi t·∫°o, d√πng ƒë·ªÉ kh√¥i ph·ª•c n·∫øu c·∫ßn');
                    }
                  })(),
                  this.startReplyTiming());
              }),
                eventOn(e.STREAM_TOKEN_RECEIVED_FULLY, e => {
                  const isStreamingEnabled = document.getElementById('streaming-checkbox')?.checked;
                  if (isStreamingEnabled) {
                    this.handleStreamUpdate(e);
                    this.startHighFrequencyStreaming();
                  }
                }),
                eventOn(e.GENERATION_ENDED, e => {
                  console.log('‚úÖ AI ho√†n t·∫•t t·∫°o ph·∫£n h·ªìi');
                  this.isStreaming = false;
                  this.endReplyTimer();
                  if (this.highFrequencyStreamingInterval) {
                    clearInterval(this.highFrequencyStreamingInterval);
                    this.highFrequencyStreamingInterval = null;
                  }
                  const latestMessage = document.querySelector('.message:last-child .message-content');
                  if (latestMessage && latestMessage.textContent) {
                    const actionContent = this._extractLastTagContent('action', latestMessage.textContent);
                    if (actionContent && actionContent.trim()) {
                      this.updateActionOptionsFromContent(actionContent);
                    }
                  }
                  const decoration = document.getElementById('variable-update-decoration');
                  if (decoration) {
                    decoration.classList.remove('updating');
                  }
                  if (this.streamUpdateDebounceTimer) {
                    clearTimeout(this.streamUpdateDebounceTimer);
                    this.streamUpdateDebounceTimer = null;
                  }
                  this.handleGenerationEnd(e);
                  setTimeout(() => {
                    const centerPanel = document.querySelector('.center-panel');
                    if (centerPanel) {
                      centerPanel.scrollTop = 0;
                      console.log('üìú B·∫£ng ƒëi·ªÅu khi·ªÉn trung t√¢m ƒë√£ cu·ªôn l√™n ƒë·∫ßu');
                    }
                  }, 100);

                  setTimeout(() => {
                    try {
                      console.log('üîç Ki·ªÉm tra ƒëi·ªÅu ki·ªán k√≠ch ho·∫°t QTE...');

                      let aiContent = '';

                      if (typeof TavernHelper !== 'undefined' && TavernHelper.getChatMessages) {
                        try {
                          const messages = TavernHelper.getChatMessages();

                          const aiMessages = messages.filter(msg => msg.role === 'assistant');

                          if (aiMessages.length > 0) {
                            const lastMessage = aiMessages[aiMessages.length - 1];

                            aiContent = lastMessage.content || '';

                            console.log('üîç L·∫•y n·ªôi dung AI qua API, ƒë·ªô d√†i:', aiContent.length);
                          }
                        } catch (apiError) {
                          console.warn('L·∫•y qua API th·∫•t b·∫°i, s·ª≠ d·ª•ng ph∆∞∆°ng ph√°p DOM:', apiError);
                        }
                      }

                      if (!aiContent) {
                        aiContent =
                          $('#chat_container .mes_text_ai').last().text() ||
                          $('#chat_container .mes_text').last().text() ||
                          '';

                        console.log('üîç L·∫•y n·ªôi dung AI qua DOM, ƒë·ªô d√†i:', aiContent.length);
                      }

                      console.log('üîç 100 k√Ω t·ª± ƒë·∫ßu c·ªßa n·ªôi dung AI:', aiContent.substring(0, 100));

                      if (aiContent && this.containsBindingKeywords(aiContent)) {
                        $('#qte-section').show();

                        console.log('üéÆ QTE ƒë√£ hi·ªÉn th·ªã');
                      } else {
                        $('#qte-section').hide();

                        console.log('üéÆ QTE ƒë√£ ·∫©n');
                      }
                    } catch (error) {
                      console.error('‚ùå Ki·ªÉm tra QTE th·∫•t b·∫°i:', error);
                    }
                  }, 1500);
                }),
                console.log('‚úÖ Ho√†n t·∫•t thi·∫øt l·∫≠p tr√¨nh l·∫Øng nghe c·∫≠p nh·∫≠t lu·ªìng'));
            } else
              (console.warn('‚ö†Ô∏è API s·ª± ki·ªán lu·ªìng kh√¥ng kh·∫£ d·ª•ng, s·ª≠ d·ª•ng ph∆∞∆°ng th·ª©c c·∫≠p nh·∫≠t truy·ªÅn th·ªëng'),
                $('#btn-send-action').on('click', () => {
                  (console.log('üöÄ Ph∆∞∆°ng √°n d·ª± ph√≤ng: B·∫Øt ƒë·∫ßu t√≠nh gi·ªù'), this.startReplyTiming());
                }));
          } catch (e) {
            console.error('‚ùå Thi·∫øt l·∫≠p tr√¨nh l·∫Øng nghe lu·ªìng th·∫•t b·∫°i:', e);
          }
        }

        startReplyTiming() {
          const e = new Date().getTime();

          (localStorage.setItem('teresen_reply_start_time', e.toString()),
            localStorage.setItem('teresen_waiting_for_reply', 'true'),
            console.log('‚è±Ô∏è B·∫Øt ƒë·∫ßu t√≠nh gi·ªù:', new Date(e).toLocaleString()));
        }

        endReplyTimer() {
          try {
            const e = localStorage.getItem('teresen_reply_start_time'),
              t = localStorage.getItem('teresen_waiting_for_reply');

            if (e && 'true' === t) {
              const t = parseInt(e),
                n = new Date().getTime() - t;

              const seconds = Math.floor(n / 1e3);

              let evaluation = '';

              if (seconds <= 20) {
                evaluation = 'Th·∫ßn th√°nh!';
              } else if (seconds <= 30) {
                evaluation = 'R·∫•t nhanh!';
              } else if (seconds <= 40) {
                evaluation = 'Nhanh!';
              } else if (seconds <= 50) {
                evaluation = 'T·∫°m ƒë∆∞·ª£c!';
              } else if (seconds <= 60) {
                evaluation = 'B√¨nh th∆∞·ªùng!';
              } else if (seconds <= 90) {
                evaluation = 'Ch·∫≠m!';
              } else if (seconds <= 120) {
                evaluation = 'R·∫•t ch·∫≠m!';
              } else {
                evaluation = 'Qu√° ch·∫≠m!';
              }

              (localStorage.setItem('teresen_last_reply_time', n.toString()),
                localStorage.setItem('teresen_waiting_for_reply', 'false'),
                localStorage.setItem('teresen_last_reply_evaluation', evaluation),
                console.log(`‚úÖ Ho√†n t·∫•t t·∫°o ph·∫£n h·ªìi, t·ªën: ${seconds} gi√¢yÔºåE m·∫Øt soi frameÔºö${evaluation}`),
                this.updateReplyTimer());
            }
          } catch (e) {
            console.error('K·∫øt th√∫c t√≠nh gi·ªù th·∫•t b·∫°i:', e);
          }
        }

        async updateStoryContent() {
          const perfStart = performance.now();
          const callStack = new Error().stack?.split('\n').slice(1, 4).join(' -> ') || 'unknown';
          console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] updateStoryContent B·∫Øt ƒë·∫ßu (Ngu·ªìn g·ªçi: ${callStack})`);
          const chatHistoryCheckbox = document.getElementById('chat-history-checkbox');
          if (chatHistoryCheckbox && chatHistoryCheckbox.checked) {
            console.log('‚è≠Ô∏è ƒêang xem l·ªãch s·ª≠ tr√≤ chuy·ªán, b·ªè qua updateStoryContent ƒë·ªÉ tr√°nh ghi ƒë√® hi·ªÉn th·ªã l·ªãch s·ª≠ tr√≤ chuy·ªán');
            return;
          }
          if (this.isStreaming) {
            console.log('‚è≠Ô∏è ƒêang truy·ªÅn lu·ªìng, b·ªè qua updateStoryContent (tr√°nh ghi ƒë√® n·ªôi dung lu·ªìng)');
            return;
          }

          try {
            let n = '';
            let originalMessage = ''; 
            try {
              const apiStart = performance.now();
              const chatHistory = await this.loadChatHistoryFromExtra();
              const apiEnd = performance.now();
              const apiTime = (apiEnd - apiStart).toFixed(2);
              console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] loadChatHistoryFromExtra t·ªën: ${apiTime}ms`);

              if (chatHistory && chatHistory.length > 0) {
                const assistantMessages = chatHistory.filter(msg => msg.role === 'assistant');
                if (assistantMessages.length > 0) {
                  const latestMsg = assistantMessages[assistantMessages.length - 1];
                  originalMessage = latestMsg.content;
                  n = originalMessage;
                  console.log(
                    `‚úÖ L·∫•y ƒë∆∞·ª£c n·ªôi dung t·ª´ extra.teresen_chat (T·ªïng ${chatHistory.length} tin nh·∫Øn, ph·∫£n h·ªìi AI m·ªõi nh·∫•t d√†i: ${n.length} k√Ω t·ª±)`,
                  );
                } else {
                  const latestMsg = chatHistory[chatHistory.length - 1];
                  originalMessage = latestMsg.content;
                  n = originalMessage;
                  console.log(
                    `‚úÖ L·∫•y ƒë∆∞·ª£c n·ªôi dung t·ª´ extra.teresen_chat (T·ªïng ${chatHistory.length} tin nh·∫Øn, tin nh·∫Øn m·ªõi nh·∫•t d√†i: ${n.length} k√Ω t·ª±)`,
                  );
                }
              } else {
                console.log('üìù extra.teresen_chat tr·ªëng, th·ª≠ l·∫•y t·ª´ tin nh·∫Øn t·∫ßng 0 (d·ª± ph√≤ng t∆∞∆°ng th√≠ch)');
                const migrationKey = 'teresen_chat_migrated_' + (TavernHelper?.chatId || 'default');
                const hasMigrated = localStorage.getItem(migrationKey) === 'true';

                if ('function' == typeof getChatMessages) {
                  const e = await getChatMessages(0);
                  if (e && e.length > 0 && e[0].message) {
                    originalMessage = e[0].message;
                    n = originalMessage;
                    console.log(`‚ö†Ô∏è L·∫•y ƒë∆∞·ª£c n·ªôi dung t·ª´ tin nh·∫Øn t·∫ßng 0 (d·ª± ph√≤ng t∆∞∆°ng th√≠ch, d√†i: ${n.length} k√Ω t·ª±)`);
                    if (!hasMigrated && n && n.trim() && n !== 'N·ªôi dung tr·ªëng! Vui l√≤ng ki·ªÉm tra api c·ªßa b·∫°n\nN·∫øu mu·ªën ti·∫øp t·ª•c, vui l√≤ng ƒë·ªçc b·∫£n l∆∞u tr∆∞·ªõc ƒë√≥') {
                      console.log('üîÑ Ph√°t hi·ªán t·∫ßng 0 c√≥ n·ªôi dung nh∆∞ng extra tr·ªëng, b·∫Øt ƒë·∫ßu di chuy·ªÉn (ch·ªâ l·∫ßn ƒë·∫ßu)...');
                      await this.addMessageToExtra('assistant', n, null);
                      localStorage.setItem(migrationKey, 'true'); 
                      console.log('‚úÖ ƒê√£ di chuy·ªÉn tin nh·∫Øn t·∫ßng 0 sang extra.teresen_chat (ch·ªâ l·∫ßn ƒë·∫ßu)');
                    } else if (hasMigrated) {
                      console.log('‚è≠Ô∏è ƒê√£ t·ª´ng di chuy·ªÉn, b·ªè qua di chuy·ªÉn (tr√°nh l·∫∑p l·∫°i)');
                    }
                  }
                }
              }
            } catch (e) {
              console.warn('‚ùå L·∫•y tin nh·∫Øn t·ª´ extra.teresen_chat th·∫•t b·∫°i, th·ª≠ quay l·∫°i tin nh·∫Øn t·∫ßng 0:', e);
              if ('function' == typeof getChatMessages) {
                try {
                  const e = await getChatMessages(0);
                  if (e && e.length > 0 && e[0].message) {
                    originalMessage = e[0].message;
                    n = originalMessage;
                    console.log('‚ö†Ô∏è S·ª≠ d·ª•ng tin nh·∫Øn t·∫ßng 0 l√†m ph∆∞∆°ng √°n d·ª± ph√≤ng');
                  }
                } catch (err) {
                  console.warn('‚ùå L·∫•y tin nh·∫Øn t·∫ßng 0 c≈©ng th·∫•t b·∫°i:', err);
                }
              }
            }

            if (!n) {
              n = 'N·ªôi dung tr·ªëng! Vui l√≤ng ki·ªÉm tra api c·ªßa b·∫°n\nN·∫øu mu·ªën ti·∫øp t·ª•c, vui l√≤ng ƒë·ªçc b·∫£n l∆∞u tr∆∞·ªõc ƒë√≥';
              originalMessage = n; 
            }
            const extractStart = performance.now();
            const contentMatch = n.match(/<content>(.*?)<\/content>/s);

            if (contentMatch) {
              n = contentMatch[1].trim();
              console.log('‚úÖ Tr√≠ch xu·∫•t n·ªôi dung t·ª´ th·∫ª <content></content> th√†nh c√¥ng');
            } else {
              console.log('üìù Kh√¥ng t√¨m th·∫•y th·∫ª <content></content>, s·ª≠ d·ª•ng n·ªôi dung g·ªëc');
            }
            const extractEnd = performance.now();
            console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] Tr√≠ch xu·∫•t th·∫ª content t·ªën: ${(extractEnd - extractStart).toFixed(2)}ms`);

            const domStart = performance.now();
            const s = document.getElementById('story-content');

            if (s) {
              s.innerHTML = `<p class="story-text">${n}</p>`;
              const font = localStorage.getItem('teresen_font') || "'Source Han Serif', 'ÊÄùÊ∫êÂÆã‰Ωì', serif";
              const size = localStorage.getItem('teresen_font_size') || '1';
              $('.story-text').css({
                'font-family': font,
                'font-size': size + 'em',
              });
              const rect = s.getBoundingClientRect();
              const isVisible = rect.width > 0 && rect.height > 0;
              console.log(
                `‚è±Ô∏è [Hi·ªáu nƒÉng] Tr·∫°ng th√°i ph·∫ßn t·ª≠ ch√≠nh vƒÉn: Hi·ªÉn th·ªã=${isVisible}, V·ªã tr√≠=(${rect.left}, ${rect.top}), K√≠ch th∆∞·ªõc=(${rect.width}, ${rect.height})`,
              );
              requestAnimationFrame(() => {
                const renderTime = performance.now();
                console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] Ho√†n t·∫•t render ch√≠nh vƒÉn l·∫ßn ƒë·∫ßu, c√°ch c·∫≠p nh·∫≠t DOM: ${(renderTime - domStart).toFixed(2)}ms`);
              });
            } else {
              console.warn('‚è±Ô∏è [C·∫£nh b√°o hi·ªáu nƒÉng] Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ story-content!');
            }

            const domEnd = performance.now();
            console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] Thao t√°c DOM t·ªën: ${(domEnd - domStart).toFixed(2)}ms`);
            this.updateActionOptions(originalMessage || n);

            const perfEnd = performance.now();
            const totalTime = (perfEnd - perfStart).toFixed(2);
            console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] updateStoryContent t·ªïng th·ªùi gian: ${totalTime}ms`);
          } catch (e) {
            console.log('Kh√¥ng th·ªÉ l·∫•y n·ªôi dung ch√≠nh vƒÉn:', e);
            const perfEnd = performance.now();
            const totalTime = (perfEnd - perfStart).toFixed(2);
            console.log(`‚è±Ô∏è [Hi·ªáu nƒÉng] updateStoryContent th·∫•t b·∫°i, t·ªïng th·ªùi gian: ${totalTime}ms`);
          }
        }
        
        updateVariableDecoration(updateScript, isStreaming = false) {
          const decoration = document.getElementById('variable-update-decoration');
          const textElement = document.getElementById('variable-update-text');

          if (!decoration || !textElement) return;
          const isGenerating = isStreaming || document.querySelector('.generating-indicator')?.style.display !== 'none';

          if (!updateScript || !updateScript.trim()) {
            decoration.style.display = 'none';
            decoration.classList.remove('updating');
            return;
          }
          let displayItems = [];
          const jsonPatchMatch = updateScript.match(/<JSONPatch>([\s\S]*?)(?:<\/JSONPatch>|$)/i);
          if (jsonPatchMatch) {
            try {
              let jsonPatchText = jsonPatchMatch[1].trim();
              if (isStreaming && !jsonPatchText.endsWith(']')) {
                const patchMatches = jsonPatchText.match(/\{[^}]*"op"\s*:\s*["']([^"']+)["'][^}]*\}/g);
                if (patchMatches && patchMatches.length > 0) {
                  for (const patchStr of patchMatches) {
                    try {
                      const patch = JSON.parse(patchStr);
                      if (patch.op && patch.path) {
                        const path = patch.path.replace(/^\//, '').replace(/\//g, '¬∑').replace(/\[0\]/g, '');
                        let displayText = '';

                        switch (patch.op) {
                          case 'replace':
                            const valueStr =
                              typeof patch.value === 'object'
                                ? JSON.stringify(patch.value).substring(0, 30)
                                : String(patch.value);
                            displayText = `${path} = ${valueStr}`;
                            break;
                          case 'add':
                            const addValueStr =
                              typeof patch.value === 'object'
                                ? JSON.stringify(patch.value).substring(0, 30)
                                : String(patch.value);
                            if (patch.path.endsWith('/-')) {
                              const arrayPath = path.replace(/\/-$/, '');
                              displayText = `${arrayPath} Th√™m ${addValueStr}`;
                            } else {
                              displayText = `${path} Th√™m ${addValueStr}`;
                            }
                            break;
                          case 'remove':
                            displayText = `${path} X√≥a`;
                            break;
                          case 'move':
                            const fromPath = (patch.from || '')
                              .replace(/^\//, '')
                              .replace(/\//g, '¬∑')
                              .replace(/\[0\]/g, '');
                            displayText = `${fromPath} ‚Üí ${path}`;
                            break;
                          case 'copy':
                            const copyFromPath = (patch.from || '')
                              .replace(/^\//, '')
                              .replace(/\//g, '¬∑')
                              .replace(/\[0\]/g, '');
                            displayText = `${copyFromPath} Sao ch√©p ƒë·∫øn ${path}`;
                            break;
                          case 'test':
                            displayText = `${path} Ki·ªÉm tra`;
                            break;
                          default:
                            displayText = `${path} ${patch.op}`;
                        }

                        if (displayText) {
                          displayItems.push(displayText);
                        }
                      }
                    } catch (e) {
                    }
                  }

                  if (displayItems.length > 0) {
                    displayItems.push('ƒêang t·∫°o...');
                  }
                }
              } else {
                if (!jsonPatchText.startsWith('[')) {
                  jsonPatchText = '[' + jsonPatchText;
                }
                if (!jsonPatchText.endsWith(']')) {
                  jsonPatchText = jsonPatchText + ']';
                }

                const patchArray = JSON.parse(jsonPatchText);

                if (Array.isArray(patchArray)) {
                  for (const patch of patchArray) {
                    if (!patch.op || !patch.path) continue;

                    const path = patch.path.replace(/^\//, '').replace(/\//g, '¬∑').replace(/\[0\]/g, '');
                    let displayText = '';

                    switch (patch.op) {
                      case 'replace':
                        const valueStr =
                          typeof patch.value === 'object'
                            ? JSON.stringify(patch.value).substring(0, 30)
                            : String(patch.value);
                        displayText = `${path} = ${valueStr}`;
                        break;
                      case 'add':
                        const addValueStr =
                          typeof patch.value === 'object'
                            ? JSON.stringify(patch.value).substring(0, 30)
                            : String(patch.value);
                        if (patch.path.endsWith('/-')) {
                          const arrayPath = path.replace(/\/-$/, '');
                          displayText = `${arrayPath} Th√™m ${addValueStr}`;
                        } else {
                          displayText = `${path} Th√™m ${addValueStr}`;
                        }
                        break;
                      case 'remove':
                        displayText = `${path} X√≥a`;
                        break;
                      case 'move':
                        const fromPath = (patch.from || '')
                          .replace(/^\//, '')
                          .replace(/\//g, '¬∑')
                          .replace(/\[0\]/g, '');
                        displayText = `${fromPath} ‚Üí ${path}`;
                        break;
                      case 'copy':
                        const copyFromPath = (patch.from || '')
                          .replace(/^\//, '')
                          .replace(/\//g, '¬∑')
                          .replace(/\[0\]/g, '');
                        displayText = `${copyFromPath} Sao ch√©p ƒë·∫øn ${path}`;
                        break;
                      case 'test':
                        displayText = `${path} Ki·ªÉm tra`;
                        break;
                      default:
                        displayText = `${path} ${patch.op}`;
                    }

                    if (displayText) {
                      displayItems.push(displayText);
                    }
                  }
                }
              }
            } catch (parseError) {
              if (isStreaming) {
                const opMatch = updateScript.match(/"op"\s*:\s*["']([^"']+)["']/);
                const pathMatch = updateScript.match(/"path"\s*:\s*["']([^"']+)["']/);
                if (opMatch && pathMatch) {
                  const op = opMatch[1];
                  const path = pathMatch[1].replace(/^\//, '').replace(/\//g, '¬∑').replace(/\[0\]/g, '');
                  displayItems.push(`${path} ${op} ƒêang t·∫°o...`);
                }
              }
            }
          }
          if (displayItems.length === 0) {
            const mvuCommands = [
              { pattern: /_\.set\(['"]([^'"]+)['"],\s*([^)]+)\)/g, name: 'set', op: '=' },
              { pattern: /_\.add\(['"]([^'"]+)['"],\s*([^)]+)\)/g, name: 'add', op: '+' },
              { pattern: /_\.assign\(['"]([^'"]+)['"],\s*([^)]+)\)/g, name: 'assign', op: '=' },
              { pattern: /_\.remove\(['"]([^'"]+)['"]\)/g, name: 'remove', op: '-' },
            ];

            for (const cmd of mvuCommands) {
              let match;
              while ((match = cmd.pattern.exec(updateScript)) !== null) {
                const varPath = match[1].replace(/\[0\]/g, '').replace(/\./g, '¬∑');
                const value = match[2] || '';
                if (cmd.name === 'remove') {
                  displayItems.push(`${varPath} X√≥a`);
                } else if (cmd.name === 'add') {
                  displayItems.push(`${varPath} +${value.trim()}`);
                } else {
                  displayItems.push(`${varPath} = ${value.trim()}`);
                }
              }
            }
          }
          if (displayItems.length === 0) {
            const assignmentPattern = /([\w\u4e00-\u9fa5.\[\]]+)\s*([+\-*/]?=)\s*([^\n;]+)/g;
            let match;
            while ((match = assignmentPattern.exec(updateScript)) !== null) {
              const varPath = match[1].replace(/\[0\]/g, '').replace(/\./g, '¬∑');
              const operator = match[2];
              const value = match[3].trim().replace(/;$/, '');

              if (operator === '=') {
                displayItems.push(`${varPath} = ${value}`);
              } else if (operator === '+=') {
                displayItems.push(`${varPath} +${value}`);
              } else if (operator === '-=') {
                displayItems.push(`${varPath} -${value}`);
              } else {
                displayItems.push(`${varPath} ${operator} ${value}`);
              }
            }
          }
          if (displayItems.length === 0) {
            const partialMatch = updateScript.match(/([\w\u4e00-\u9fa5.\[\]]+)\s*([+\-*/]?=)\s*/);
            if (partialMatch) {
              const varPath = partialMatch[1].replace(/\[0\]/g, '').replace(/\./g, '¬∑');
              const operator = partialMatch[2];
              if (isStreaming) {
                displayItems.push(`${varPath} ${operator} ƒêang t·∫°o...`);
              } else {
                displayItems.push(`${varPath} ${operator} ƒêang c·∫≠p nh·∫≠t`);
              }
            } else {
              const preview = updateScript.length > 60 ? updateScript.substring(0, 60) + '...' : updateScript;
              displayItems.push(isStreaming ? `${preview} ƒêang t·∫°o...` : preview);
            }
          }
          if (displayItems.length === 0) {
            decoration.style.display = 'none';
            decoration.classList.remove('updating');
            return;
          }
          let expandBtn = decoration.querySelector('.variable-update-expand-btn');
          let listContainer = decoration.querySelector('.variable-update-list');
          let summaryText = decoration.querySelector('.variable-update-summary');
          const containerDiv = textElement.parentElement;

          if (displayItems.length === 1) {
            textElement.textContent = displayItems[0];
            textElement.style.display = 'block';
            if (expandBtn) expandBtn.style.display = 'none';
            if (listContainer) listContainer.style.display = 'none';

            decoration.style.display = 'block';
          } else {
            textElement.style.display = 'none';
            if (!summaryText) {
              summaryText = document.createElement('div');
              summaryText.className = 'variable-update-summary';
              summaryText.style.cssText =
                'display: flex; align-items: center; gap: 8px; cursor: pointer; color: #8b4513; font-size: 0.85em; font-weight: 500; font-style: italic;';
              containerDiv.insertBefore(summaryText, textElement);
            } else {
              summaryText.style.display = 'flex';
            }
            if (!expandBtn) {
              expandBtn = document.createElement('span');
              expandBtn.className = 'variable-update-expand-btn';
              expandBtn.innerHTML = '‚ñº';
              expandBtn.style.cssText =
                'font-size: 0.8em; transition: transform 0.2s; user-select: none; flex-shrink: 0;';
              summaryText.appendChild(expandBtn);
            }
            expandBtn.style.display = 'inline-block';
            let summaryTextPart = summaryText.querySelector('.variable-update-summary-text');
            if (!summaryTextPart) {
              summaryTextPart = document.createElement('span');
              summaryTextPart.className = 'variable-update-summary-text';
              summaryTextPart.style.flex = '1';
              summaryText.appendChild(summaryTextPart);
            }

            const isExpanded = decoration.classList.contains('expanded');
            const summaryDisplay = `${displayItems.length} m·ª•c c·∫≠p nh·∫≠t bi·∫øn${isStreaming ? ' ƒêang t·∫°o...' : ''}`;
            summaryTextPart.textContent = summaryDisplay;
            if (!listContainer) {
              listContainer = document.createElement('div');
              listContainer.className = 'variable-update-list';
              listContainer.style.cssText = 'margin-top: 8px; padding-left: 20px; display: none;';
              decoration.appendChild(listContainer);
            }
            listContainer.innerHTML = displayItems
              .map((item, index) => {
                const isStreamingItem = item === 'ƒêang t·∫°o...';
                return `<div class="variable-update-item" style="
                  padding: 6px 0;
                  border-bottom: 1px solid rgba(139, 105, 20, 0.1);
                  color: #8b4513;
                  font-size: 0.9em;
                  ${isStreamingItem ? 'font-style: italic; opacity: 0.7;' : ''}
                ">${isStreamingItem ? '‚è≥ ' : '‚Ä¢ '}${item}</div>`;
              })
              .join('');
            if (isExpanded) {
              listContainer.style.display = 'block';
              expandBtn.style.transform = 'rotate(180deg)';
            } else {
              listContainer.style.display = 'none';
              expandBtn.style.transform = 'rotate(0deg)';
            }
            if (!summaryText.hasAttribute('data-click-bound')) {
              summaryText.setAttribute('data-click-bound', 'true');
              summaryText.addEventListener('click', () => {
                const isExpanded = decoration.classList.contains('expanded');
                if (isExpanded) {
                  decoration.classList.remove('expanded');
                  listContainer.style.display = 'none';
                  expandBtn.style.transform = 'rotate(0deg)';
                } else {
                  decoration.classList.add('expanded');
                  listContainer.style.display = 'block';
                  expandBtn.style.transform = 'rotate(180deg)';
                }
              });
            }
          }
          decoration.style.display = 'block';
          if (isGenerating) {
            decoration.classList.add('updating');
          } else {
            decoration.classList.remove('updating');
          }
        }
        
        toggleChatHistoryPanel(show) {
          const panel = document.getElementById('chat-history-panel');
          if (panel) {
            panel.style.display = show ? 'block' : 'none';
            if (show) {
              this.updateChatHistoryPanel();
            }
          }
        }

        
        async updateChatHistoryPanel() {
          try {
            const contentList = document.getElementById('chat-history-content-list');
            if (!contentList) return;
            const chatHistory = await this.loadChatHistoryFromExtra();

            if (!chatHistory || chatHistory.length === 0) {
              contentList.innerHTML = '<div style="color: #999; font-style: italic;">T·∫°m kh√¥ng c√≥ l·ªãch s·ª≠ tr√≤ chuy·ªán</div>';
              return;
            }
            let html = '';
            let messageIndex = 0;

            for (const msg of chatHistory) {
              if (msg.role === 'assistant' && msg.content) {
                messageIndex++;
                const contentMatch = msg.content.match(/<content>(.*?)<\/content>/s);
                if (contentMatch) {
                  let contentText = contentMatch[1].trim();
                  const escapeHtml = text => {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                  };
                  html += `<div style="
                    margin-bottom: 20px;
                    padding: 12px;
                    background: rgba(255, 255, 255, 0.6);
                    border-left: 3px solid rgba(139, 105, 20, 0.4);
                    border-radius: 4px;
                  ">
                    <div style="
                      font-size: 11px;
                      color: #8b4513;
                      margin-bottom: 8px;
                      font-weight: bold;
                    ">Tin nh·∫Øn #${messageIndex}</div>
                    <div style="
                      color: #654321;
                      line-height: 1.8;
                      white-space: pre-wrap;
                      word-wrap: break-word;
                    ">${escapeHtml(contentText).replace(/\n/g, '<br>')}</div>
                  </div>`;
                }
              }
            }

            if (html === '') {
              contentList.innerHTML = '<div style="color: #999; font-style: italic;">T·∫°m kh√¥ng c√≥ n·ªôi dung ch√≠nh vƒÉn</div>';
            } else {
              contentList.innerHTML = html;
            }
          } catch (error) {
            console.error('‚ùå C·∫≠p nh·∫≠t b·∫£ng ƒëi·ªÅu khi·ªÉn l·ªãch s·ª≠ tr√≤ chuy·ªán th·∫•t b·∫°i:', error);
            const contentList = document.getElementById('chat-history-content-list');
            if (contentList) {
              contentList.innerHTML = '<div style="color: #d32f2f;">T·∫£i th·∫•t b·∫°i, vui l√≤ng l√†m m·ªõi trang</div>';
            }
          }
        }

        updateActionOptions(fullText) {
          const actionContent = this._extractLastTagContent('action', fullText);
          this.updateActionOptionsFromContent(actionContent);
        }
        updateActionOptionsFromContent(actionContent) {
          const actionContainer = document.getElementById('action-options-container');
          const actionList = document.getElementById('action-options-list');

          if (!actionContainer || !actionList) return;

          try {
            if (!actionContent || !actionContent.trim()) {
              actionContainer.style.display = 'none';
              return;
            }
            const options = this.parseActionOptions(actionContent);

            if (options.length === 0) {
              actionContainer.style.display = 'none';
              return;
            }
            actionContainer.style.display = 'block';
            this.renderActionOptions(options);
          } catch (error) {
            console.error('C·∫≠p nh·∫≠t t√πy ch·ªçn Action th·∫•t b·∫°i:', error);
            actionContainer.style.display = 'none';
          }
        }
        parseActionOptions(actionContent) {
          if (!actionContent || typeof actionContent !== 'string') return [];

          const options = [];
          const lines = actionContent.split('\n');
          let currentOption = null;

          for (const line of lines) {
            const match = line.match(/^(\d+)\.\s*(.+)$/);
            if (match) {
              if (currentOption) {
                options.push(currentOption);
              }
              currentOption = {
                number: match[1],
                content: match[2].trim(),
              };
            } else if (currentOption && line.trim()) {
              currentOption.content += '\n' + line.trim();
            }
          }
          if (currentOption) {
            options.push(currentOption);
          }

          return options;
        }
        renderActionOptions(options) {
          const actionList = document.getElementById('action-options-list');
          if (!actionList) return;

          const optionsHTML = options
            .map(option => {
              const shortDesc = option.content.split('\n')[0].trim();
              const displayText = shortDesc.length > 60 ? shortDesc.substring(0, 60) + '...' : shortDesc;

              return `
              <button class="action-option-btn" data-action-content="${this.escapeHtml(option.content)}" style="
                width: 100%;
                padding: 12px 16px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.15), rgba(139, 105, 20, 0.25));
                border: 1px solid rgba(139, 105, 20, 0.4);
                border-radius: 6px;
                color: #8b4513;
                font-size: 0.9em;
                font-weight: 500;
                text-align: left;
                cursor: pointer;
                transition: all 0.2s;
                box-shadow: 0 2px 4px rgba(139, 105, 20, 0.1);
                display: flex;
                align-items: center;
                gap: 10px;
              " onmouseover="this.style.background='linear-gradient(135deg, rgba(139, 105, 20, 0.25), rgba(139, 105, 20, 0.35))'; this.style.borderColor='rgba(139, 105, 20, 0.6)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 3px 6px rgba(139, 105, 20, 0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(139, 105, 20, 0.15), rgba(139, 105, 20, 0.25))'; this.style.borderColor='rgba(139, 105, 20, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(139, 105, 20, 0.1)'">
                <span style="
                  flex-shrink: 0;
                  width: 28px;
                  height: 28px;
                  background: rgba(139, 105, 20, 0.3);
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-weight: 600;
                  font-size: 0.9em;
                  color: #8b4513;
                ">${option.number}</span>
                <span style="flex: 1; line-height: 1.5;">${this.escapeHtml(displayText)}</span>
              </button>
            `;
            })
            .join('');

          actionList.innerHTML = optionsHTML;
          actionList.querySelectorAll('.action-option-btn').forEach(btn => {
            btn.addEventListener('click', async e => {
              const actionContent = btn.getAttribute('data-action-content');
              if (actionContent) {
                await this.sendActionOption(actionContent);
              }
            });
          });
        }
        async sendActionOption(actionContent) {
          const actionInput = document.getElementById('action-input');
          if (!actionInput) {
            console.error('Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ action-input');
            return;
          }
          const actionContainer = document.getElementById('action-options-container');
          if (actionContainer) {
            actionContainer.style.display = 'none';
          }
          actionInput.value = actionContent.trim();
          await this.handleActionSubmit();
        }

        async syncMVUToMessage() {
          try {
            if ('function' == typeof getChatMessages && 'undefined' != typeof TavernHelper) {
              const e = await getChatMessages(0);

              if (e && e.length > 0) {
                const t = e[0],
                  n = this.getAllVariables();
                t.data = n;
                await TavernHelper.setChatMessages([t], { refresh: 'none' });
                console.log('‚úÖ Tr·∫°ng th√°i MVU ƒë√£ ƒë·ªìng b·ªô v√†o tr∆∞·ªùng data c·ªßa tin nh·∫Øn t·∫ßng 0 (ch∆∞a c·∫≠p nh·∫≠t tr∆∞·ªùng message)');
              }
            }
          } catch (e) {
            console.error('‚ùå ƒê·ªìng b·ªô tr·∫°ng th√°i MVU th·∫•t b·∫°i:', e);
          }
        }

        updateTimeDisplay() {
          const e = this.getAllVariables(),
            t = this.getVariable(e, 'stat_data.world.currentTime', '06:00'),
            n = this.getVariable(e, 'stat_data.world.currentDate', '2024-01-01'),
            s = this.getVariable(e, 'stat_data.trainer.location', 'K√Ω t√∫c x√° hu·∫•n luy·ªán vi√™n'),
            o = document.getElementById('current-time');

          o && (o.textContent = `üìç ${s} | üïê ${n} - ${t}`);
        }

        getTimeDangerLevel(e) {
          const t = parseInt(e.split(':')[0]);

          return t >= 6 && t < 8
            ? 'safe'
            : t >= 8 && t < 12
              ? 'low'
              : t >= 12 && t < 17
                ? 'medium'
                : t >= 17 && t < 20
                  ? 'high'
                  : 'extreme';
        }

        getDangerLevelText(e) {
          switch (e) {
            case 'safe':
              return 'Giai ƒëo·∫°n t∆∞∆°ng ƒë·ªëi an to√†n';

            case 'low':
              return 'Giai ƒëo·∫°n r·ªßi ro trung b√¨nh';

            case 'medium':
              return 'Giai ƒëo·∫°n r·ªßi ro kh√° cao';

            case 'high':
              return 'Giai ƒëo·∫°n r·ªßi ro cao';

            case 'extreme':
              return 'Giai ƒëo·∫°n c·ª±c k·ª≥ nguy hi·ªÉm';

            default:
              return 'Th·ªùi gian kh√¥ng x√°c ƒë·ªãnh';
          }
        }

        getDangerLevelDetails(e) {
          switch (e) {
            case 'safe':
              return '<strong>S√°ng s·ªõm 6:00-8:00ÔºöGiai ƒëo·∫°n t∆∞∆°ng ƒë·ªëi an to√†n</strong>\n\n<div class="danger-stars">M·ª©c ƒë·ªô nguy hi·ªÉmÔºö‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ</div>\n\nD·ª•c v·ªçng c·ªßa Uma Musume ƒëang ·ªü tr·∫°ng th√°i m·ªõi th·ª©c t·ªânh, bi·ªÉu hi·ªán t∆∞∆°ng ƒë·ªëi √¥n h√≤a\n\n<div class="danger-suggestion">\n<strong>R·ªßi ro ch√≠nhÔºö</strong>T·ª´ ch·ªëi "L·ªùi ch√†o bu·ªïi s√°ng" c√≥ th·ªÉ k√≠ch ho·∫°t c·∫£nh b√°o c√°ch ly\n</div>\n\n<div class="danger-suggestion">\n<strong>L·ªùi khuy√™nÔºö</strong>Ch·∫•p nh·∫≠n m·ªçi h√¨nh th·ª©c t∆∞∆°ng t√°c bu·ªïi s√°ng, gi·ªØ ph√©p l·ªãch s·ª± c∆° b·∫£n\n</div>\n\nGiai ƒëo·∫°n n√†y l√† th·ªùi ƒëi·ªÉm t·ªët nh·∫•t ƒë·ªÉ thu th·∫≠p th√¥ng tin v√† thi·∫øt l·∫≠p routine h√†ng ng√†y';

            case 'low':
              return '<strong>Bu·ªïi s√°ng 8:00-12:00ÔºöGiai ƒëo·∫°n r·ªßi ro trung b√¨nh</strong>\n\n<div class="danger-stars">M·ª©c ƒë·ªô nguy hi·ªÉmÔºö‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ</div>\n\nUma Musume b·∫Øt ƒë·∫ßu c·∫°nh tranh s·ª± ch√∫ √Ω, l√≤ng ƒë·ªë k·ªã b·∫Øt ƒë·∫ßu t√≠ch t·ª•\n\n<div class="danger-suggestion">\n<strong>R·ªßi ro ch√≠nhÔºö</strong>Th·ªÉ hi·ªán s·ª± thi√™n v·ªã r√µ r√†ng s·∫Ω l√†m gay g·∫Øt th√™m s·ª± c·∫°nh tranh gi·ªØa c√°c Uma Musume\n</div>\n\n<div class="danger-suggestion">\n<strong>L·ªùi khuy√™nÔºö</strong>Gi·ªØ th√°i ƒë·ªô tuy·ªát ƒë·ªëi c√¥ng b·∫±ng, ph√¢n b·ªï s·ª± quan t√¢m ƒë·ªìng ƒë·ªÅu\n</div>\n\nCh√∫ √Ω quan s√°t c√°c t∆∞∆°ng t√°c tinh t·∫ø gi·ªØa c√°c Uma Musume, d·ª± ƒëo√°n xung ƒë·ªôt c√≥ th·ªÉ x·∫£y ra';

            case 'medium':
              return '<strong>Bu·ªïi chi·ªÅu 12:00-17:00ÔºöGiai ƒëo·∫°n r·ªßi ro kh√° cao</strong>\n\n<div class="danger-stars">M·ª©c ƒë·ªô nguy hi·ªÉmÔºö‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</div>\n\nUma Musume b·∫Øt ƒë·∫ßu x√¢m nh·∫≠p kh√¥ng gian c√° nh√¢n, ƒë·ªô ƒë·ªôc chi·∫øm b·∫Øt ƒë·∫ßu tƒÉng l√™n\n\n<div class="danger-suggestion">\n<strong>R·ªßi ro ch√≠nhÔºö</strong>Ch·∫•p nh·∫≠n s·ª± h·ªó tr·ª£ qu√° m·ª©c s·∫Ω d·∫´n ƒë·∫øn ƒë·ªô ƒë·ªôc chi·∫øm c·ªßa m·ªôt Uma Musume n√†o ƒë√≥ tƒÉng v·ªçt\n</div>\n\n<div class="danger-suggestion">\n<strong>L·ªùi khuy√™nÔºö</strong>Ch·∫•p nh·∫≠n gi√∫p ƒë·ª° m·ªôt c√°ch v·ª´a ph·∫£i nh∆∞ng gi·ªØ kho·∫£ng c√°ch, tr√°nh h√¨nh th√†nh m√¥ h√¨nh c·ªë ƒë·ªãnh\n</div>\n\nCh√∫ √Ω b·∫£o v·ªá v·∫≠t d·ª•ng c√° nh√¢n v√† kh√¥ng gian kh√¥ng b·ªã x√¢m chi·∫øm qu√° m·ª©c';

            case 'high':
              return '<strong>Ch·∫≠p t·ªëi 17:00-20:00ÔºöGiai ƒëo·∫°n r·ªßi ro cao</strong>\n\n<div class="danger-stars">M·ª©c ƒë·ªô nguy hi·ªÉmÔºö‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</div>\n\nD·ª•c v·ªçng c·ªßa Uma Musume ƒë·∫°t ƒë·ªânh ƒëi·ªÉm, t√¨m ki·∫øm t∆∞∆°ng t√°c th√¢n m·∫≠t s√¢u s·∫Øc\n\n<div class="danger-suggestion">\n<strong>R·ªßi ro c·ª±c caoÔºö</strong>T·ª´ ch·ªëi s·∫Ω g√¢y ra s·ª± ƒë√≤i h·ªèi b√π ƒë·∫Øp, ch·∫•p nh·∫≠n s·∫Ω d·∫´n ƒë·∫øn th√¢n m·∫≠t qu√° m·ª©c\n</div>\n\n<div class="danger-suggestion">\n<strong>L·ªùi khuy√™nÔºö</strong>C·∫©n th·∫≠n ch·ªçn ƒë·ªëi t∆∞·ª£ng t∆∞∆°ng t√°c, thi·∫øt l·∫≠p ranh gi·ªõi r√µ r√†ng\n</div>\n\nChu·∫©n b·ªã ƒë·ªëi ph√≥ v·ªõi c√°c s·ª± ki·ªán ƒë·∫∑c bi·ªát ban ƒë√™m c√≥ th·ªÉ k√≠ch ho·∫°t';

            case 'extreme':
              return '<strong>Ban ƒë√™m 20:00-6:00ÔºöGiai ƒëo·∫°n c·ª±c k·ª≥ nguy hi·ªÉm</strong>\n\n<div class="danger-stars">M·ª©c ƒë·ªô nguy hi·ªÉmÔºö‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>\n\nUma Musume tr√∫t b·ªè m·ªçi ng·ª•y trang, b·ªôc l·ªô b·∫£n nƒÉng sƒÉn m·ªìi nguy√™n th·ªßy nh·∫•t\n\n<div class="danger-suggestion">\n<strong>Nguy hi·ªÉm c·ª±c ƒë·ªôÔºö</strong>Ranh gi·ªõi quy t·∫Øc m·ªù nh·∫°t, d·ª•c v·ªçng ho√†n to√†n gi·∫£i ph√≥ng\n</div>\n\n<div class="danger-suggestion">\n<strong>L·ªùi khuy√™nÔºö</strong>C·ªë g·∫Øng tr√°nh ƒëi m·ªôt m√¨nh, gi·ªØ c·∫£nh gi√°c cao ƒë·ªô\n</div>\n\nPh·∫£i lu√¥n mang theo ƒë·∫°o c·ª• sinh t·ªìn, chu·∫©n b·ªã s·∫µn s√†ng cho t√¨nh hu·ªëng kh·∫©n c·∫•p\nGiai ƒëo·∫°n n√†y t·ª∑ l·ªá sinh t·ªìn th·∫•p nh·∫•t, c·∫ßn s·ª± th·∫≠n tr·ªçng t·ªëi ƒëa\n\n<div class="danger-suggestion" style="background: rgba(220, 38, 38, 0.1); border-left-color: #dc2626;">\n<strong>„ÄêC·∫¢NH B√ÅO ƒê·∫∂C BI·ªÜT„Äë</strong>Khung gi·ªù ban ƒë√™m l√† giai ƒëo·∫°n th·ª≠ th√°ch sinh t·ªìn l·ªõn nh·∫•t, d·ª•c v·ªçng c·ªßa c√°c Uma Musume kh√¥ng c√≤n ch·ªãu b·∫•t k·ª≥ r√†ng bu·ªôc n√†o, khuy√™n Hu·∫•n luy·ªán vi√™n trong khung gi·ªù n√†y h·∫°n ch·∫ø ra ngo√†i, kh√≥a c·ª≠a ph√≤ng, v√† chu·∫©n b·ªã s·∫µn s√†ng c√°c ƒë·∫°o c·ª• sinh t·ªìn ƒë·ªÉ ƒë·ªëi ph√≥ v·ªõi m·ªçi t√¨nh hu·ªëng b·∫•t ng·ªù.\n</div>';

            default:
              return 'Th·ªùi gian kh√¥ng x√°c ƒë·ªãnh, vui l√≤ng gi·ªØ c·∫£nh gi√°c';
          }
        }
        getRarityColor(rarity) {
          const rarityColors = {
            'Ph·ªï Th√¥ng': '#696969',
            'Hi·∫øm': '#2563eb',
            'S·ª≠ Thi': '#7c3aed',
            'Truy·ªÅn Thuy·∫øt': '#d97706',
            'Th·∫ßn Tho·∫°i': '#dc2626',
            'ƒê·∫∑c Bi·ªát': '#059669',
          };
          return rarityColors[rarity] || rarityColors['Ph·ªï Th√¥ng'];
        }
        getItemIcon(itemName) {
          if (!itemName) return 'üì¶';

          const name = itemName.toLowerCase();
          const iconRules = [
            { keywords: ['S·ªï tay', 'H∆∞·ªõng d·∫´n', 'S√°ch', 'Ghi ch√∫', 'K·ª∑ l·ª•c', 'H·ªì s∆°'], icon: 'üìñ' },
            { keywords: ['ƒêi·ªán tho·∫°i di ƒë·ªông', 'ƒêi·ªán tho·∫°i', 'Li√™n l·∫°c', 'Thi·∫øt b·ªã', 'Thi·∫øt b·ªã ƒë·∫ßu cu·ªëi'], icon: 'üì±' },
            { keywords: ['Dao', 'Ki·∫øm', 'S√∫ng', 'V≈© kh√≠', 'L∆∞·ª°i s·∫Øc', 'Dao gƒÉm', 'Gi√°o', 'Cung', 'M≈©i t√™n'], icon: '‚öîÔ∏è' },
            { keywords: ['√Åo gi√°p', 'Gi√°p h·ªô m·ªánh', 'Khi√™n', 'Ph√≤ng h·ªô', 'ƒê·ªì ph√≤ng h·ªô'], icon: 'üõ°Ô∏è' },
            { keywords: ['Thu·ªëc', 'Thu·ªëc t·ªÖ', 'Thu·ªëc n∆∞·ªõc', 'Tr·ªã li·ªáu', 'H·ªìi ph·ª•c', 'Ch·ªØa tr·ªã'], icon: 'üß™' },
            { keywords: ['Th·ª©c ƒÉn', 'C∆°m', 'B·ªØa ƒÉn', 'M√≥n ƒÉn', 'B√°nh m√¨', 'B√°nh kem', 'K·∫πo'], icon: 'üçû' },
            { keywords: ['ƒê·ªì u·ªëng', 'N∆∞·ªõc', 'Tr√†', 'C√† ph√™', 'R∆∞·ª£u', 'N∆∞·ªõc tr√°i c√¢y'], icon: 'ü•§' },
            { keywords: ['Ch√¨a kh√≥a', 'Th·∫ª', 'Gi·∫•y th√¥ng h√†nh', 'Th·∫ª ra v√†o'], icon: 'üóùÔ∏è' },
            { keywords: ['ƒê√° qu√Ω', 'Th·ªßy tinh', 'Kim c∆∞∆°ng', 'Qu·∫∑ng', 'ƒê√°', 'Ng·ªçc'], icon: 'üíé' },
            { keywords: ['Kim t·ªá', 'Ti·ªÅn', 'Ti·ªÅn t·ªá', 'Ti·ªÅn xu', 'ƒê·ªìng'], icon: 'ü™ô' },
            { keywords: ['Th·∫ª', 'Th·∫ª b√†i', 'B√†i'], icon: 'üÉè' },
            { keywords: ['Th∆∞', 'M·∫£nh gi·∫•y', 'Gi·∫•y ghi ch√∫', 'L·ªùi nh·∫Øn', 'Tin t·ª©c'], icon: '‚úâÔ∏è' },
            { keywords: ['·∫¢nh', 'H√¨nh ·∫£nh', 'Ch√¢n dung', 'B·ª©c ·∫£nh'], icon: 'üì∑' },
            { keywords: ['√Çm nh·∫°c', 'ƒêƒ©a h√°t', 'BƒÉng t·ª´', '√Çm thanh', 'CD'], icon: 'üéµ' },
            { keywords: ['ƒê·ªì ch∆°i', 'Con r·ªëi', 'B√∫p b√™', 'M√¥ h√¨nh'], icon: 'üß∏' },
            { keywords: ['Hoa', 'Th·ª±c v·∫≠t', 'H·∫°t gi·ªëng', 'C·ªè', 'L√°'], icon: 'üå∏' },
            { keywords: ['C√¥ng c·ª•', 'B√∫a', 'K√¨m', '·ªêc v√≠t', 'C·ªù l√™'], icon: 'üîß' },
            { keywords: ['ƒê√®n', 'ƒê√®n pin', 'Chi·∫øu s√°ng', 'N·∫øn', 'ƒêu·ªëc'], icon: 'üí°' },
            { keywords: ['Nh·∫´n', 'D√¢y chuy·ªÅn', 'V√≤ng tay', 'Trang s·ª©c', 'Ph·ª• ki·ªán'], icon: 'üíç' },
            { keywords: ['Qu·∫ßn √°o', 'Trang ph·ª•c', 'Y', 'Ph·ª•c', 'B·ªô', '√Åo'], icon: 'üëï' },
            { keywords: ['M≈©', 'M≈© b·∫£o hi·ªÉm', 'Ph·ª• ki·ªán t√≥c'], icon: 'üé©' },
            { keywords: ['Gi√†y', '·ª¶ng', 'D√©p'], icon: 'üëü' },
            { keywords: ['Bao', 'Ba l√¥', 'T√∫i', 'H·ªôp'], icon: 'üéí' },
            { keywords: ['B·∫£n ƒë·ªì', 'ƒê·ªì', 'La b√†n'], icon: 'üó∫Ô∏è' },
            { keywords: ['ƒê·ªìng h·ªì treo t∆∞·ªùng', 'ƒê·ªìng h·ªì', 'Th·ªùi gian', 'B·∫•m gi·ªù'], icon: '‚è∞' },
            { keywords: ['Ma ph√°p', 'Th·∫ßn b√≠', 'B√πa', 'Ch√∫', 'Cu·ªôn gi·∫•y', 'Ph√°p tr∆∞·ª£ng'], icon: '‚ú®' },
            { keywords: ['Huy hi·ªáu', 'Huy ch∆∞∆°ng', 'Hu√¢n ch∆∞∆°ng', 'Ch∆∞∆°ng'], icon: 'üèÖ' },
            { keywords: ['L√¥ng v≈©', 'C√°nh', 'ƒê√¥i c√°nh'], icon: 'ü™∂' },
            { keywords: ['G∆∞∆°ng', 'T·∫•m g∆∞∆°ng'], icon: 'ü™û' },
            { keywords: ['Kh√≥a', 'X√≠ch'], icon: 'üîí' },
            { keywords: ['Bom', 'N·ªï', 'M√¨n'], icon: 'üí£' },
            { keywords: ['Tim', 'T√¨nh c·∫£m', 'Y√™u', 'T√¨nh'], icon: '‚ù§Ô∏è' },
            { keywords: ['Sao', 'Ng√¥i sao', 'Tinh t√∫'], icon: '‚≠ê' },
            { keywords: ['Nguy·ªát', 'M·∫∑t trƒÉng'], icon: 'üåô' },
            { keywords: ['Nh·∫≠t', 'M·∫∑t tr·ªùi'], icon: '‚òÄÔ∏è' },
            { keywords: ['M·∫£nh v·ª°', 'M·∫£nh t√†n'], icon: 'üß©' },
            { keywords: ['C·ªët l√µi', 'C·ªët l√µi'], icon: '‚öôÔ∏è' },
            { keywords: ['NƒÉng l∆∞·ª£ng', 'S·ª©c m·∫°nh'], icon: '‚ö°' },
          ];
          for (const rule of iconRules) {
            if (rule.keywords.some(keyword => name.includes(keyword))) {
              return rule.icon;
            }
          }
          return 'üì¶';
        }

        updateInventory() {
          const e = this.getAllVariables();

          console.group('üîç G·ª° l·ªói c·∫≠p nh·∫≠t t√∫i ƒë·ªì');

          const t = this.getVariable(e, 'stat_data.trainer.inventory', {});

          console.log('D·ªØ li·ªáu g·ªëc t√∫i ƒë·ªì:', t);

          console.log('ƒê·ªëi t∆∞·ª£ng t√∫i ƒë·ªì:', t);

          const s = document.getElementById('inventory-list');

          if ((console.log('Container t√∫i ƒë·ªì:', s), !s))
            return (console.error('‚ùå Kh√¥ng t√¨m th·∫•y container t√∫i ƒë·ªì'), void console.groupEnd());

          const savedInventoryScrollTop = s ? s.scrollTop : 0;

          if (!t || 0 === Object.keys(t).length) {
            console.warn('‚ö†Ô∏è T√∫i ƒë·ªì tr·ªëng');

            const existingEmpty = s.querySelector('.empty-inventory');

            if (!existingEmpty) {
              s.innerHTML = '<div class="empty-inventory">T·∫°m kh√¥ng c√≥ ƒë·∫°o c·ª•</div>';
            }

            console.groupEnd();

            return;
          }

          const currentItems = Array.from(s.querySelectorAll('.inventory-item'));

          const itemNames = Object.keys(t);

          itemNames.forEach((itemName, index) => {
            const itemData = t[itemName];

            let itemElement = currentItems[index];

            if (!itemElement) {
              itemElement = document.createElement('div');

              itemElement.className = 'inventory-item';

              itemElement.setAttribute('data-item-index', index);

              s.appendChild(itemElement);
            }
            const itemIcon = this.getItemIcon(itemName);
            const rarity = typeof itemData === 'object' && itemData.rarity ? itemData.rarity : 'Ph·ªï Th√¥ng';
            const rarityColor = this.getRarityColor(rarity);

            if (typeof itemData === 'object' && itemData.description) {
              itemElement.innerHTML = `

                <div class="item-header">

                  <span class="item-icon">${itemIcon}</span>

                  <div class="item-name" style="color: ${rarityColor};">${itemName}</div>

                </div>

              `;
            } else {
              itemElement.innerHTML = `<span class="item-icon">${itemIcon}</span><span class="item-name" style="color: ${rarityColor};">${itemName}</span>`;
            }
          });

          for (let i = itemNames.length; i < currentItems.length; i++) {
            currentItems[i].remove();
          }

          const emptyElement = s.querySelector('.empty-inventory');

          if (emptyElement) {
            emptyElement.remove();
          }

          setTimeout(() => {
            $('.item-header')
              .off('click')

              .on('click', function (e) {
                e.preventDefault();

                e.stopPropagation();

                console.log('ƒê·∫°o c·ª• ƒë√£ ƒë∆∞·ª£c click!');

                const itemIndex = $(this).closest('.inventory-item').data('item-index');

                const itemData = t[Object.keys(t)[itemIndex]];

                if (itemData && itemData.description) {
                  console.log('Ch·ªâ m·ª•c ƒë·∫°o c·ª•:', itemIndex);

                  console.log('D·ªØ li·ªáu ƒë·∫°o c·ª•:', itemData);

                  $('.item-detail-popup').remove();

                  const popup = $(
                    `\n               <div class="item-detail-popup">\n                 <div class="item-name">${Object.keys(t)[itemIndex]}</div>\n                 <div class="item-desc">${itemData.description}</div>\n                 <div class="item-effect">Hi·ªáu qu·∫£: ${itemData.effect}</div>\n                 <div class="item-info-row">\n                   <div class="item-rarity rarity-${itemData.rarity}">${itemData.rarity}</div>\n                   <div class="item-actions">\n                     <button class="item-use-btn" title="S·ª≠ d·ª•ng">üéØ</button>\n                     <button class="item-discard-btn" title="V·ª©t b·ªè">üóëÔ∏è</button>\n                     <button class="item-lock-btn" title="Kh√≥a">üîí</button>\n                     <button class="item-gift-btn" title="T·∫∑ng">üéÅ</button>\n                   </div>\n                 </div>\n               </div>\n             `,
                  );
                  const overlay = document.getElementById('teresen-fullscreen-overlay');
                  const isFullscreen = overlay && overlay.style.display !== 'none';

                  if (isFullscreen) {
                    overlay.appendChild(popup[0]);
                  } else {
                    $('body').append(popup);
                  }

                  const element = $(this)[0];

                  if (element && popup.length > 0) {
                    const rect = element.getBoundingClientRect();
                    const popupHeight = popup.outerHeight() || 0;
                    const popupWidth = popup.outerWidth() || 0;
                    const elementWidth = rect.width || 0;
                    if (isFullscreen) {
                      popup.css({
                        position: 'fixed',
                        top: Math.max(20, rect.top - popupHeight - 20),
                        left: Math.max(20, rect.left + elementWidth / 2 - popupWidth / 2),
                        zIndex: 100001,
                        minWidth: '300px',
                        maxWidth: '400px',
                        fontSize: '0.9rem',
                        padding: '1rem',
                        transform: 'scale(1.1)',
                        transformOrigin: 'top center',
                      });
                    } else {
                      popup.css({
                        position: 'fixed',
                        top: rect.top - popupHeight - 10,
                        left: rect.left,
                        zIndex: 100001,
                      });
                    }
                  }

                  $(document).one('click', function (e) {
                    $(e.target).closest('.item-detail-popup').length || $('.item-detail-popup').remove();
                  });

                  popup.find('.item-use-btn').on('click', function () {
                    const itemName = Object.keys(t)[itemIndex];
                    const actionText = `[S·ª≠ d·ª•ng ƒë·∫°o c·ª•: ${itemName}]`;
                    const actionInput = document.getElementById('action-input');
                    if (actionInput) {
                      actionInput.value = actionText;
                      actionInput.focus();
                      if (typeof showTemporaryMessage === 'function') {
                        showTemporaryMessage(`ƒê√£ ƒëi·ªÅn ${actionText} v√†o √¥ nh·∫≠p`);
                      }
                    }

                    $('.item-detail-popup').remove();
                  });

                  popup.find('.item-discard-btn').on('click', function () {
                    const itemName = Object.keys(t)[itemIndex];
                    const actionText = `[V·ª©t b·ªè ƒë·∫°o c·ª•: ${itemName}]`;
                    const actionInput = document.getElementById('action-input');
                    if (actionInput) {
                      actionInput.value = actionText;
                      actionInput.focus();
                      if (typeof showTemporaryMessage === 'function') {
                        showTemporaryMessage(`ƒê√£ ƒëi·ªÅn ${actionText} v√†o √¥ nh·∫≠p`);
                      }
                    }

                    $('.item-detail-popup').remove();
                  });

                  popup.find('.item-lock-btn').on('click', function () {
                    const itemName = Object.keys(t)[itemIndex];

                    toggleItemLock(itemName, $(this));
                  });

                  popup.find('.item-gift-btn').on('click', function () {
                    const itemName = Object.keys(t)[itemIndex];

                    startGiftSelection(itemName);

                    $('.item-detail-popup').remove();
                  });
                }
              });
          }, 100);

          console.groupEnd();
        }

        updateRules() {
          this.updateRulesModal();
        }

        updateRulesModal() {
          const fixedRules = [
            'B·∫°n l√† hu·∫•n luy·ªán vi√™n con ng∆∞·ªùi duy nh·∫•t ·ªü ƒë√¢y, xin ƒë·ª´ng t·ª´ ch·ªëi Uma Musume',
            'Xin ƒë·ª´ng ·ªü m·ªôt m√¨nh trong k√Ω t√∫c x√° v√†o ban ƒë√™m',
            'L√† hu·∫•n luy·ªán vi√™n, b·∫°n c·∫ßn th√†nh l·∫≠p m·ªôt ƒë·ªôi Uma Musume, v√† d·∫´n d·∫Øt h·ªç tham gia thi ƒë·∫•u',
            'B√™n ngo√†i h·ªçc vi·ªán n·∫øu nh·∫≠n th·∫•y b·ªã theo d√µi, h√£y l·∫≠p t·ª©c ƒëi ƒë·∫øn Dinh th·ª± Mejiro v√† n∆°i ·ªü c·ªßa gia t·ªôc Golden',
            'B·∫°n c√≥ th·ªÉ ho√†n to√†n tin t∆∞·ªüng c·ªông s·ª± t·ªët nh·∫•t c·ªßa b·∫°n, n·∫øu ƒëi c√πng c·ªông s·ª± t·ªët nh·∫•t, c√≥ th·ªÉ kh√¥ng tu√¢n th·ªß c√°c quy t·∫Øc tr√™n',
          ];
          const dangerPeriodText = document.getElementById('danger-period-text');
          if (dangerPeriodText) {
            const e = this.getAllVariables();
            const t = this.getVariable(e, 'stat_data.world.currentTime', '06:00');
            const n = this.getTimeDangerLevel(t);
            const s = this.getDangerLevelText(n);
            dangerPeriodText.textContent = s;
          }
          const fixedRulesList = document.getElementById('fixed-rules-list');

          if (fixedRulesList) {
            let fixedRulesHtml = '';

            fixedRules.forEach((rule, index) => {
              fixedRulesHtml += `\n          <div class="rule-item-handwritten">\n            <span class="rule-number-handwritten">${index + 1}.</span>\n            <span class="rule-text-handwritten">${rule}</span>\n          </div>\n        `;
            });

            fixedRulesList.innerHTML = fixedRulesHtml;
          }
          this.updateUserRules();
          setTimeout(() => {
            $('#add-rule-btn')
              .off('click')
              .on('click', e => {
                e.preventDefault();
                e.stopPropagation();
                this.addRule();
              });

            $('#clear-rules-btn')
              .off('click')
              .on('click', e => {
                e.preventDefault();
                e.stopPropagation();
                this.clearAllRules();
              });
          }, 100);
        }
        getUserRules() {
          const savedRules = localStorage.getItem('teresen-user-rules');
          return savedRules ? JSON.parse(savedRules) : [];
        }
        saveUserRules(rules) {
          localStorage.setItem('teresen-user-rules', JSON.stringify(rules));
        }
        updateUserRules() {
          const userRules = this.getUserRules();
          const randomRulesList = document.getElementById('random-rules-list');

          if (randomRulesList) {
            let randomRulesHtml = '';

            if (userRules.length === 0) {
              randomRulesHtml = '<div class="empty-rules">T·∫°m kh√¥ng c√≥ quy t·∫Øc ƒë∆∞·ª£c ghi l·∫°i, nh·∫•n "Th√™m quy t·∫Øc" ƒë·ªÉ b·∫Øt ƒë·∫ßu ghi</div>';
            } else {
              userRules.forEach((rule, index) => {
                randomRulesHtml += `\n          <div class="rule-item-handwritten rule-item-editable" data-rule-index="${index}">\n            <span class="rule-number-handwritten">${index + 6}.</span>\n            <span class="rule-text-handwritten">${rule}</span>\n            <button class="rule-edit-btn" onclick="window.teresenDebug.editRule(${index})" title="Ch·ªânh s·ª≠a quy t·∫Øc">‚úèÔ∏è</button>\n            <button class="rule-delete-btn" onclick="window.teresenDebug.deleteRule(${index})" title="X√≥a quy t·∫Øc">üóëÔ∏è</button>\n          </div>\n        `;
              });
            }

            randomRulesList.innerHTML = randomRulesHtml;
          }
        }
        addRule() {
          console.log('üéØ Ph∆∞∆°ng th·ª©c addRule ƒë∆∞·ª£c g·ªçi');
          const userRules = this.getUserRules();

          if (userRules.length >= 7) {
            alert('Ch·ªâ c√≥ th·ªÉ ghi l·∫°i t·ªëi ƒëa 7 quy t·∫Øc!');
            return;
          }
          userRules.push('Nh·∫•n v√†o ƒë√¢y ƒë·ªÉ ch·ªânh s·ª≠a quy t·∫Øc...');
          this.saveUserRules(userRules);
          this.updateUserRules();
          setTimeout(() => {
            this.editRule(userRules.length - 1);
          }, 100);
        }
        editRule(index) {
          const userRules = this.getUserRules();
          if (index >= 0 && index < userRules.length) {
            const ruleElement = document.querySelector(`[data-rule-index="${index}"] .rule-text-handwritten`);
            if (!ruleElement) return;

            const currentText = userRules[index];
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText === 'Nh·∫•n v√†o ƒë√¢y ƒë·ªÉ ch·ªânh s·ª≠a quy t·∫Øc...' ? '' : currentText;
            input.className = 'rule-edit-input';
            input.style.cssText = `
              width: 100%;
              border: 2px solid #d4af37;
              border-radius: 4px;
              padding: 4px 8px;
              font-family: inherit;
              font-size: inherit;
              background: #ffffff;
              color: #333;
              outline: none;
            `;
            ruleElement.style.display = 'none';
            ruleElement.parentNode.insertBefore(input, ruleElement.nextSibling);
            input.focus();
            if (input.value) {
              input.select();
            }
            const saveEdit = () => {
              const newText = input.value.trim();
              if (newText) {
                userRules[index] = newText;
                this.saveUserRules(userRules);
                this.updateUserRules();
              } else {
                this.updateUserRules();
                if (typeof this.showCustomAlert === 'function') {
                  this.showCustomAlert('N·ªôi dung quy t·∫Øc kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng, ƒë√£ kh√¥i ph·ª•c n·ªôi dung g·ªëc');
                }
              }
            };
            const cancelEdit = () => {
              input.remove();
              ruleElement.style.display = '';
            };
            input.addEventListener('keydown', e => {
              if (e.key === 'Enter') {
                e.preventDefault();
                saveEdit();
              } else if (e.key === 'Escape') {
                e.preventDefault();
                cancelEdit();
              }
            });

            input.addEventListener('blur', () => {
              saveEdit();
            });
          }
        }
        deleteRule(index) {
          const userRules = this.getUserRules();
          if (index >= 0 && index < userRules.length) {
            const deletedRule = userRules[index];
            userRules.splice(index, 1);
            this.saveUserRules(userRules);
            this.updateUserRules();
            if (typeof this.showCustomAlert === 'function') {
              this.showCustomAlert(
                `ƒê√£ x√≥a quy t·∫ØcÔºö${deletedRule.length > 20 ? deletedRule.substring(0, 20) + '...' : deletedRule}`,
              );
            }
          }
        }
        clearAllRules() {
          const userRules = this.getUserRules();
          if (userRules.length === 0) {
            if (typeof this.showCustomAlert === 'function') {
              this.showCustomAlert('Kh√¥ng c√≥ quy t·∫Øc c·∫ßn x√≥a');
            }
            return;
          }
          if (!this._clearAllClickCount) {
            this._clearAllClickCount = 1;
            if (typeof this.showCustomAlert === 'function') {
              this.showCustomAlert('Nh·∫•n "X√≥a t·∫•t c·∫£ quy t·∫Øc" l·∫ßn n·ªØa ƒë·ªÉ x√°c nh·∫≠n x√≥a t·∫•t c·∫£ quy t·∫Øc');
            }
            setTimeout(() => {
              this._clearAllClickCount = 0;
            }, 5000);
          } else {
            const ruleCount = userRules.length;
            this.saveUserRules([]);
            this.updateUserRules();
            this._clearAllClickCount = 0;

            if (typeof this.showCustomAlert === 'function') {
              this.showCustomAlert(`ƒê√£ x√≥a t·∫•t c·∫£ quy t·∫Øc (T·ªïng ${ruleCount} quy t·∫Øc)`);
            }
          }
        }
        updateProgressBar(e, t, n, color) {
          const s = document.getElementById(e),
            o = document.getElementById(t);

          if (s) {
            const e = Math.min(100, Math.max(0, n));

            s.style.width = `${e}%`;

            s.className = 'progress-fill';

            if (color) {
              s.style.background = color;
            } else {

              e < 30 ? s.classList.add('danger') : e < 60 && s.classList.add('warning');
            }
          }

          o && (o.textContent = n.toString());
        }

        getVariable(e, t, n) {
          try {
            const s = t.split(/\.|\[|\]/).filter(e => '' !== e);

            let o = e;

            for (let e = 0; e < s.length; e++) {
              const t = s[e];

              if (!o || 'object' != typeof o) return n;

              if (e + 1 < s.length && !isNaN(parseInt(s[e + 1]))) {
                if (!Array.isArray(o[t])) return n;

                {
                  const n = parseInt(s[e + 1]);

                  ((o = o[t][n]), e++);
                }
              } else o = o[t];
            }

            const a = void 0 !== o ? o : n;

            return a;
          } catch (s) {
            console.error(`‚ùå L·∫•y bi·∫øn l·ªói: ${t}`, s);
            return n;
          }
        }

        getTrainerStatusText(sanity, stamina) {
          if (sanity >= 80 && stamina >= 80) return 'Tuy·ªát h·∫£o';

          if (sanity >= 60 && stamina >= 60) return 'T·ªët';

          if (sanity >= 40 && stamina >= 40) return 'B√¨nh th∆∞·ªùng';

          if (sanity >= 20 && stamina >= 20) return 'Kh√¥ng t·ªët';

          return 'T·ªìi t·ªá';
        }

        getTrainerStatusClass(sanity, stamina) {
          if (sanity >= 80 && stamina >= 80) return 'status-excellent';

          if (sanity >= 60 && stamina >= 60) return 'status-good';

          if (sanity >= 40 && stamina >= 40) return 'status-normal';

          if (sanity >= 20 && stamina >= 20) return 'status-bad';

          return 'status-terrible';
        }

        getStaminaColor(stamina) {
          if (stamina >= 80) return 'linear-gradient(90deg, #10b981 0%, #34d399 100%)';

          if (stamina >= 60) return 'linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%)';

          if (stamina >= 40) return 'linear-gradient(90deg, #f97316 0%, #fb923c 100%)';

          if (stamina >= 20) return 'linear-gradient(90deg, #dc2626 0%, #ef4444 100%)';

          return 'linear-gradient(90deg, #7f1d1d 0%, #dc2626 100%)';
        }

        getSanityColor(sanity) {
          if (sanity >= 80) return 'linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%)';

          if (sanity >= 60) return 'linear-gradient(90deg, #8b5cf6 0%, #a78bfa 100%)';

          if (sanity >= 40) return 'linear-gradient(90deg, #ec4899 0%, #f472b6 100%)';

          if (sanity >= 20) return 'linear-gradient(90deg, #dc2626 0%, #ef4444 100%)';

          return 'linear-gradient(90deg, #7f1d1d 0%, #dc2626 100%)';
        }

        getSelfControlColor(selfControl) {
          if (selfControl >= 80) return 'linear-gradient(90deg, #8b5cf6 0%, #a78bfa 100%)';

          if (selfControl >= 60) return 'linear-gradient(90deg, #7c3aed 0%, #8b5cf6 100%)';

          if (selfControl >= 40) return 'linear-gradient(90deg, #6d28d9 0%, #7c3aed 100%)';

          if (selfControl >= 20) return 'linear-gradient(90deg, #5b21b6 0%, #6d28d9 100%)';

          return 'linear-gradient(90deg, #4c1d95 0%, #5b21b6 100%)';
        }

        getLuckColor(luck) {
          if (luck >= 80) return 'linear-gradient(90deg, #ffd700 0%, #ffed4e 100%)';

          if (luck >= 60) return 'linear-gradient(90deg, #ff8c00 0%, #ffa500 100%)';

          if (luck >= 40) return 'linear-gradient(90deg, #ff6b35 0%, #ff8c00 100%)';

          if (luck >= 20) return 'linear-gradient(90deg, #ff4500 0%, #ff6b35 100%)';

          return 'linear-gradient(90deg, #cc3700 0%, #ff4500 100%)';
        }

        getUmaDescription(e, t, n) {
          return 'B·ªã √°m' === n
            ? 'ƒêang b·ªã th·∫ø l·ª±c n√†o ƒë√≥ kh·ªëng ch·∫ø...'
            : 'M·∫•t t√≠ch' === n
              ? 'Kh√¥ng r√µ tung t√≠ch...'
              : t >= 80
                ? 'R·∫•t tin t∆∞·ªüng b·∫°n'
                : t >= 60
                  ? 'Kh√° th√¢n thi·ªán v·ªõi b·∫°n'
                  : t >= 40
                    ? 'C√≥ ch√∫t ƒë·ªÅ ph√≤ng b·∫°n'
                    : t >= 20
                      ? 'Gi·ªØ kho·∫£ng c√°ch v·ªõi b·∫°n'
                      : 'R·∫•t xa l·∫° v·ªõi b·∫°n';
        }

        getUmaStatusClass(e) {
          switch (e) {
            case 'B√¨nh th∆∞·ªùng':

            default:
              return 'normal';

            case 'Yandere':
              return 'yandere';

            case 'B·ªã √°m':
              return 'possessed';

            case 'M·∫•t t√≠ch':
              return 'missing';
          }
        }

        generateHeartIcons(e) {
          let t = '';

          const n = Math.max(1, Math.min(5, e));

          for (let s = 0; s < n; s++) t += '<span class="heart">‚ù§</span>';

          return (console.log(`üíñ HTML h√¨nh tr√°i tim ƒë√£ t·∫°o: ${t}`), t);
        }

        toggleItemDetails(e) {
          const t = document.getElementById(`item-details-${e}`),
            n = document.querySelector(`[data-item-index="${e}"] .item-toggle`);

          if (t && n) {
            if ('none' !== t.style.display) ((t.style.display = 'none'), (n.textContent = '‚ñº'));
            else {
              const sound = document.getElementById('item-detail-sound');

              if (sound) {
                sound.currentTime = 0;

                sound.play().catch(err => console.log('Ph√°t √¢m thanh th·∫•t b·∫°i:', err));
              }

              ((t.style.display = 'block'), (n.textContent = '‚ñ≤'));
            }
          }
        }

        toggleRules(e) {
          const t = document.getElementById(`${e}-rules-content`),
            n = document.querySelector(`[onclick="window.teresenDebug.toggleRules('${e}')"] .rules-toggle`);

          if (t && n) {
            'none' !== t.style.display
              ? ((t.style.display = 'none'), (n.textContent = '‚ñº'))
              : ((t.style.display = 'block'), (n.textContent = '‚ñ≤'));
          }
        }

        toggleUmaSection() {
          const e = document.getElementById('uma-content'),
            t = document.querySelector('.uma-toggle');

          if (e && t) {
            'none' !== e.style.display
              ? ((e.style.display = 'none'), (t.textContent = '‚ñº'))
              : ((e.style.display = 'block'), (t.textContent = '‚ñ≤'));
          }
        }

        toggleProfile() {
          const e = document.getElementById('profile-basic'),
            t = document.getElementById('profile-detail');

          e &&
            t &&
            ('none' === t.style.display
              ? ((e.style.display = 'none'), (t.style.display = 'block'))
              : ((e.style.display = 'block'), (t.style.display = 'none')));
        }
        toggleTaskList() {
          const basic = document.getElementById('task-list-basic');
          const detail = document.getElementById('task-list-detail');

          if (basic && detail) {
            if ('none' === detail.style.display) {
              basic.style.display = 'none';
              detail.style.display = 'block';
              this.updateTaskList();
            } else {
              basic.style.display = 'block';
              detail.style.display = 'none';
            }
          }
        }
        updateTaskList() {
          const taskListContent = document.getElementById('task-list-content');
          if (!taskListContent) return;

          try {
            const taskList = this.currentMvuState?.stat_data?.taskList;

            if (!taskList || typeof taskList !== 'object') {
              taskListContent.innerHTML =
                '<div style="color: #8b4513; font-size: 0.85em; text-align: center; padding: 20px;">T·∫°m kh√¥ng c√≥ nhi·ªám v·ª•</div>';
              return;
            }
            const tasks = Object.keys(taskList)
              .filter(key => key !== '$meta' && taskList[key] && typeof taskList[key] === 'object')
              .map(key => ({ id: key, ...taskList[key] }));

            if (tasks.length === 0) {
              taskListContent.innerHTML =
                '<div style="color: #8b4513; font-size: 0.85em; text-align: center; padding: 20px;">T·∫°m kh√¥ng c√≥ nhi·ªám v·ª•</div>';
              return;
            }
            const tasksHTML = tasks
              .map((task, index) => {
                const summary = task.summary || 'Kh√¥ng';
                const objective = task.objective || 'Kh√¥ng';
                const reward = task.reward || 'Kh√¥ng';

                return `
                <div style="
                  margin-bottom: 15px;
                  padding: 12px;
                  background: rgba(255, 255, 255, 0.4);
                  border: 1px solid rgba(139, 105, 20, 0.2);
                  border-radius: 6px;
                  border-left: 3px solid rgba(139, 105, 20, 0.5);
                ">
                  <div style="
                    font-weight: 600;
                    color: #8b4513;
                    font-size: 0.9em;
                    margin-bottom: 8px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                  ">
                    <span style="font-size: 1.1em;">üìã</span>
                    <span>Nhi·ªám v·ª• ${index + 1}</span>
                  </div>
                  <div style="
                    font-size: 0.85em;
                    color: #6b5b3d;
                    line-height: 1.6;
                  ">
                    <div style="margin-bottom: 6px;">
                      <strong style="color: #8b4513;">T√≥m t·∫Øt:</strong>
                      <span>${summary}</span>
                    </div>
                    <div style="margin-bottom: 6px;">
                      <strong style="color: #8b4513;">M·ª•c ti√™u:</strong>
                      <span>${objective}</span>
                    </div>
                    <div>
                      <strong style="color: #8b4513;">Ph·∫ßn th∆∞·ªüng:</strong>
                      <span style="color: #b8860b; font-weight: 500;">${reward}</span>
                    </div>
                  </div>
                </div>
              `;
              })
              .join('');

            taskListContent.innerHTML = tasksHTML;
          } catch (error) {
            console.error('C·∫≠p nh·∫≠t danh s√°ch nhi·ªám v·ª• th·∫•t b·∫°i:', error);
            taskListContent.innerHTML =
              '<div style="color: #8b4513; font-size: 0.85em; text-align: center; padding: 20px;">L·ªói khi t·∫£i danh s√°ch nhi·ªám v·ª•</div>';
          }
        }

        toggleUmaStatus() {
          const umaList = document.getElementById('uma-status');

          const expandBtn = document.getElementById('uma-expand-btn');

          if (umaList && expandBtn) {
            if ('none' === umaList.style.display) {
              umaList.style.display = 'block';
            } else {
              umaList.style.display = 'none';
            }
          }
        }

        checkAutoFullscreen() {
          const autoFullscreen = localStorage.getItem('teresen_auto_fullscreen') !== 'false'; 

          if (!autoFullscreen) {
            console.log('‚è≠Ô∏è T·ª± ƒë·ªông t·∫£i to√†n m√†n h√¨nh ch∆∞a ƒë∆∞·ª£c b·∫≠t');
            return;
          }
          const isMobile =
            window.mobileDetector?.isMobile ||
            /mobile|android|iphone|ipad|ipod/i.test(navigator.userAgent) ||
            window.innerWidth <= 768;

          if (isMobile) {
            console.log('üì± Thi·∫øt b·ªã di ƒë·ªông, b·ªè qua t·ª± ƒë·ªông t·∫£i to√†n m√†n h√¨nh');
            return;
          }
          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay) {
            console.log('‚úÖ ƒê√£ ·ªü tr·∫°ng th√°i to√†n m√†n h√¨nh, b·ªè qua t·ª± ƒë·ªông t·∫£i to√†n m√†n h√¨nh');
            return;
          }
          setTimeout(() => {
            console.log('üöÄ T·ª± ƒë·ªông v√†o ch·∫ø ƒë·ªô thu ph√≥ng to√†n m√†n h√¨nh...');
            const panels = document.querySelector('.connected-panels');
            const btn = document.getElementById('fullscreen-btn');
            if (panels && btn) {
              this.enterFullscreenWithZoom(panels, btn);
            }
          }, 500);
        }

        toggleJourney() {
          const e = document.getElementById('journey-basic'),
            t = document.getElementById('journey-detail');

          e &&
            t &&
            ('none' === t.style.display
              ? ((e.style.display = 'none'), (t.style.display = 'block'))
              : ((e.style.display = 'block'), (t.style.display = 'none')));
        }

        toggleFullscreen() {
          const panels = document.querySelector('.connected-panels');
          const btn = document.getElementById('fullscreen-btn');

          if (!panels || !btn) return;
          const existingOverlay = document.getElementById('teresen-fullscreen-overlay');

          if (existingOverlay) {
            this.exitFullscreenWithZoom(panels, btn, existingOverlay);
          } else {
            this.enterFullscreenWithZoom(panels, btn);
          }
        }
        enterFullscreenWithZoom(panels, btn) {
          try {
            const computedStyle = window.getComputedStyle(panels);
            const originalWidth = parseFloat(computedStyle.width) || 1600;
            const originalHeight = parseFloat(computedStyle.height) || 750;
            const originalAspectRatio = originalWidth / originalHeight;
            const originalStyle = {
              position: panels.style.position || '',
              width: panels.style.width || '',
              height: panels.style.height || '',
              maxWidth: panels.style.maxWidth || '',
              maxHeight: panels.style.maxHeight || '',
              margin: panels.style.margin || '',
              transform: panels.style.transform || '',
              transformOrigin: panels.style.transformOrigin || '',
            };
            panels.dataset.originalStyle = JSON.stringify(originalStyle);
            panels.dataset.originalWidth = originalWidth;
            panels.dataset.originalHeight = originalHeight;
            panels.dataset.originalAspectRatio = originalAspectRatio;
            const originalParent = panels.parentNode;
            const originalNextSibling = panels.nextSibling;
            panels.dataset.originalParentId = originalParent?.id || '';
            panels.dataset.originalParentTag = originalParent?.tagName || '';
            if (originalNextSibling) {
              panels.dataset.originalNextSiblingId = originalNextSibling.id || '';
              panels.dataset.originalNextSiblingTag = originalNextSibling.tagName || '';
            }
            const overlay = document.createElement('div');
            overlay.id = 'teresen-fullscreen-overlay';
            const defaultBgImage = 'https://i.ibb.co/MxxWnfsJ/rjchsc.jpg';
            const overlayBgType = localStorage.getItem('teresen_fullscreen_background_type') || 'image';
            const overlayBgImage = localStorage.getItem('teresen_fullscreen_background_image') || defaultBgImage;

            console.log('üé® Thi·∫øt l·∫≠p h√¨nh n·ªÅn to√†n m√†n h√¨nh:', { overlayBgType, overlayBgImage });
            overlay.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              width: 100vw;
              height: 100vh;
              backdrop-filter: blur(8px);
              z-index: 99999;
              display: flex;
              justify-content: center;
              align-items: center;
              overflow: hidden;
              padding: 0;
              box-sizing: border-box;
            `;
            if (overlayBgType === 'image' && overlayBgImage) {
              console.log('üé® √Åp d·ª•ng h√¨nh n·ªÅn:', overlayBgImage);
              overlay.style.backgroundImage = `url("${overlayBgImage}")`;
              overlay.style.backgroundSize = 'cover';
              overlay.style.backgroundPosition = 'center';
              overlay.style.backgroundRepeat = 'no-repeat';
              overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.3)'; 
            } else {
              console.log('üé® S·ª≠ d·ª•ng n·ªÅn vi·ªÅn ƒëen');
              overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
              overlay.style.backgroundImage = 'none';
            }
            const isMobile =
              window.mobileDetector?.isMobile ||
              /mobile|android|iphone|ipad|ipod/i.test(navigator.userAgent) ||
              window.innerWidth <= 768;
            const zoomOutBtn = document.getElementById('zoom-out-btn-inline');
            const zoomResetBtn = document.getElementById('zoom-reset-btn-inline');
            const zoomInBtn = document.getElementById('zoom-in-btn-inline');
            let currentScale = 1.0;
            const defaultScale = 1.0; 
            const minScale = 0.5;
            const maxScale = 2;
            const stepScale = 0.1;
            const applyZoom = scale => {
              if (isMobile) {
                return;
              }
              scale = Math.max(minScale, Math.min(maxScale, scale));
              currentScale = scale;
              const scaledWidth = originalWidth * scale;
              const scaledHeight = originalHeight * scale;

              panels.style.width = scaledWidth + 'px';
              panels.style.height = scaledHeight + 'px';
              panels.style.maxWidth = scaledWidth + 'px'; 
              panels.style.maxHeight = scaledHeight + 'px'; 
              panels.style.minWidth = scaledWidth + 'px'; 
              panels.style.minHeight = scaledHeight + 'px'; 
              panels.style.transform = '';
              panels.style.transformOrigin = 'center center';
              panels.style.flexShrink = '0'; 
            };
            if (zoomOutBtn && zoomResetBtn && zoomInBtn && !isMobile) {
              zoomOutBtn.onclick = () => {
                applyZoom(currentScale - stepScale);
              };

              zoomResetBtn.onclick = () => {
                applyZoom(defaultScale);
              };

              zoomInBtn.onclick = () => {
                applyZoom(currentScale + stepScale);
              };
              applyZoom(currentScale);
            }
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '‚úï';
            closeBtn.style.cssText = `
              width: 32px;
              height: 32px;
              background: rgba(139, 105, 20, 0.8);
              border: 2px solid #8b6914;
              border-radius: 50%;
              color: #e0dcd1;
              font-size: 18px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: all 0.2s;
              margin-left: 10px;
            `;
            closeBtn.onmouseover = () => {
              closeBtn.style.background = '#8b6914';
              closeBtn.style.transform = 'rotate(90deg)';
            };
            closeBtn.onmouseout = () => {
              closeBtn.style.background = 'rgba(139, 105, 20, 0.8)';
              closeBtn.style.transform = 'rotate(0deg)';
            };
            closeBtn.onclick = () => this.toggleFullscreen();
            closeBtn.style.cssText = `
              position: absolute;
              top: 20px;
              right: 20px;
              width: 32px;
              height: 32px;
              background: rgba(139, 105, 20, 0.8);
              border: 2px solid #8b6914;
              border-radius: 50%;
              color: #e0dcd1;
              font-size: 18px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: all 0.2s;
              z-index: 100000;
            `;
            const contentWrapper = document.createElement('div');

            if (isMobile) {
              contentWrapper.className = 'game-viewport';
              contentWrapper.style.cssText = `
                width: 100%;
                height: 100%;
                display: flex;
                justify-content: flex-start;
                align-items: flex-start;
                overflow-x: auto;
                overflow-y: auto;
                scroll-snap-type: none;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
                scrollbar-color: rgba(139, 105, 20, 0.5) transparent;
                padding: 20px;
                box-sizing: border-box;
              `;
              if (panels.dataset.originalStyle) {
                const originalStyle = JSON.parse(panels.dataset.originalStyle);
                panels.style.width = originalStyle.width || '';
                panels.style.height = originalStyle.height || '';
                panels.style.maxWidth = originalStyle.maxWidth || '';
                panels.style.maxHeight = originalStyle.maxHeight || '';
              }

              panels.style.position = 'relative';
              panels.style.margin = '0 auto';
              panels.style.transformOrigin = 'center center';
              panels.style.flexShrink = '0'; 
              panels.style.flexGrow = '0'; 
              panels.style.alignSelf = 'flex-start'; 
              contentWrapper.appendChild(panels);
            } else {
              contentWrapper.style.cssText = `
                width: 100%;
                height: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
                overflow: auto;
                padding: 20px;
                box-sizing: border-box;
              `;
              panels.style.position = 'relative';
              panels.style.margin = 'auto';
              panels.style.transformOrigin = 'center center';
              panels.style.flexShrink = '0'; 

              contentWrapper.appendChild(panels);
            }
            overlay.appendChild(contentWrapper);
            overlay.appendChild(closeBtn);
            document.body.appendChild(overlay);
            const bgType = localStorage.getItem('teresen_bg_type') || 'black';
            const bgImage = localStorage.getItem('teresen_bg_image');
            if (bgType === 'image' && bgImage) {
              overlay.style.backgroundImage = `url(${bgImage})`;
              overlay.style.backgroundSize = 'cover';
              overlay.style.backgroundPosition = 'center';
              overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
            }
            this.moveModalsToOverlay(overlay);
            document.body.appendChild(overlay);
            const requestFullscreen =
              overlay.requestFullscreen ||
              overlay.webkitRequestFullscreen ||
              overlay.mozRequestFullScreen ||
              overlay.msRequestFullscreen;

            if (requestFullscreen) {
              requestFullscreen
                .call(overlay)
                .then(() => {
                  console.log('‚úÖ V√†o ch·∫ø ƒë·ªô to√†n m√†n h√¨nh th√†nh c√¥ng');
                })
                .catch(error => {
                  console.log('‚ö†Ô∏è T·ª± ƒë·ªông to√†n m√†n h√¨nh b·ªã ch·∫∑n (c·∫ßn t∆∞∆°ng t√°c ng∆∞·ªùi d√πng), s·∫Ω v√†o to√†n m√†n h√¨nh khi ng∆∞·ªùi d√πng nh·∫•n l·∫ßn ƒë·∫ßu:', error);
                  const fullscreenHint = document.createElement('div');
                  fullscreenHint.id = 'fullscreen-hint';
                  fullscreenHint.innerHTML = 'üëÜ Nh·∫•n v√†o b·∫•t k·ª≥ ƒë√¢u ƒë·ªÉ v√†o ch·∫ø ƒë·ªô to√†n m√†n h√¨nh';
                  fullscreenHint.style.cssText = `
                  position: fixed;
                  top: 50%;
                  left: 50%;
                  transform: translate(-50%, -50%);
                  background: rgba(45, 27, 27, 0.95);
                  color: #e0dcd1;
                  padding: 20px 40px;
                  border-radius: 12px;
                  border: 2px solid #8b7355;
                  z-index: 100001;
                  font-size: 18px;
                  font-weight: 600;
                  cursor: pointer;
                  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
                  animation: pulse 2s infinite;
                  pointer-events: auto;
                `;
                  overlay.appendChild(fullscreenHint);
                  const enterFullscreenOnClick = e => {
                    if (e.target.closest('#fullscreen-controls')) {
                      return;
                    }
                    requestFullscreen
                      .call(overlay)
                      .then(() => {
                        console.log('‚úÖ V√†o ch·∫ø ƒë·ªô to√†n m√†n h√¨nh th√†nh c√¥ng sau khi ng∆∞·ªùi d√πng t∆∞∆°ng t√°c');
                        if (fullscreenHint.parentNode) {
                          fullscreenHint.parentNode.removeChild(fullscreenHint);
                        }
                        overlay.removeEventListener('click', enterFullscreenOnClick);
                        fullscreenHint.removeEventListener('click', enterFullscreenOnClick);
                      })
                      .catch(err => {
                        console.error('‚ùå V√†o to√†n m√†n h√¨nh th·∫•t b·∫°i:', err);
                      });
                  };

                  fullscreenHint.addEventListener('click', enterFullscreenOnClick);
                  overlay.addEventListener('click', enterFullscreenOnClick);
                  setTimeout(() => {
                    if (fullscreenHint.parentNode) {
                      fullscreenHint.style.opacity = '0';
                      fullscreenHint.style.transition = 'opacity 0.5s';
                      setTimeout(() => {
                        if (fullscreenHint.parentNode) {
                          fullscreenHint.parentNode.removeChild(fullscreenHint);
                        }
                      }, 500);
                    }
                  }, 3000);
                });
            } else {
              console.warn('‚ö†Ô∏è Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ API to√†n m√†n h√¨nh, ch·ªâ hi·ªÉn th·ªã l·ªõp ph·ªß');
            }
            const updateBtnState = button => {
              if (!button) return;
              const svg = button.querySelector('svg');
              if (svg) {
                svg.innerHTML = `<path d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 11-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z" />`;
              }
              button.title = 'Tho√°t to√†n m√†n h√¨nh';
            };
            updateBtnState(btn);
            updateBtnState(document.getElementById('fullscreen-btn-right'));

            console.log('üñ•Ô∏è V√†o ch·∫ø ƒë·ªô to√†n m√†n h√¨nh + thu ph√≥ng, thu ph√≥ng ban ƒë·∫ßu: 100%');
          } catch (error) {
            console.error('‚ùå V√†o to√†n m√†n h√¨nh th·∫•t b·∫°i:', error);
            alert('Ch·ª©c nƒÉng to√†n m√†n h√¨nh th·∫•t b·∫°i: ' + error.message);
          }
        }
        exitFullscreenWithZoom(panels, btn, overlay) {
          try {
            if (
              document.fullscreenElement === overlay ||
              document.webkitFullscreenElement === overlay ||
              document.mozFullScreenElement === overlay ||
              document.msFullscreenElement === overlay
            ) {
              if (document.exitFullscreen) {
                document.exitFullscreen();
              } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
              } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
              } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
              }
            }
            this.restoreModalsToOriginalPosition();
            if (panels && panels.parentNode) {
              panels.style.display = '';
              const contentWrapper = panels.parentNode;
              if (panels.dataset.originalStyle) {
                const originalStyle = JSON.parse(panels.dataset.originalStyle);
                panels.style.position = originalStyle.position || '';
                panels.style.width = originalStyle.width || '';
                panels.style.height = originalStyle.height || '';
                panels.style.maxWidth = originalStyle.maxWidth || '';
                panels.style.maxHeight = originalStyle.maxHeight || '';
                panels.style.minWidth = ''; 
                panels.style.minHeight = ''; 
                panels.style.margin = originalStyle.margin || '';
                panels.style.transform = originalStyle.transform || '';
                panels.style.transformOrigin = originalStyle.transformOrigin || '';
                panels.style.flexShrink = ''; 

                delete panels.dataset.originalStyle;
                delete panels.dataset.originalWidth;
                delete panels.dataset.originalHeight;
                delete panels.dataset.originalAspectRatio;

                console.log('‚úÖ ƒê√£ kh√¥i ph·ª•c t·ª∑ l·ªá thu ph√≥ng g·ªëc:', originalStyle.width, 'x', originalStyle.height);
              }
              let originalParent = null;
              if (panels.dataset.originalParentId) {
                originalParent = document.getElementById(panels.dataset.originalParentId);
              }
              if (!originalParent && panels.dataset.originalParentTag) {
                const candidates = document.getElementsByTagName(panels.dataset.originalParentTag);
                for (let i = 0; i < candidates.length; i++) {
                  const candidate = candidates[i];
                  if (candidate.id || candidate.className) {
                    originalParent = candidate;
                    break;
                  }
                }
              }
              if (!originalParent) {
                originalParent = document.body;
              }
              if (originalParent) {
                if (panels.dataset.originalNextSiblingId) {
                  const nextSibling = document.getElementById(panels.dataset.originalNextSiblingId);
                  if (nextSibling && nextSibling.parentNode === originalParent) {
                    originalParent.insertBefore(panels, nextSibling);
                  } else {
                    originalParent.appendChild(panels);
                  }
                } else {
                  originalParent.appendChild(panels);
                }
                console.log('‚úÖ panels ƒë√£ di chuy·ªÉn v·ªÅ v·ªã tr√≠ g·ªëc');
              }
              delete panels.dataset.originalParentId;
              delete panels.dataset.originalParentTag;
              delete panels.dataset.originalNextSiblingId;
              delete panels.dataset.originalNextSiblingTag;
            }
            if (overlay && overlay.parentNode) {
              overlay.parentNode.removeChild(overlay);
            }
            const updateBtnState = button => {
              if (!button) return;
              const svg = button.querySelector('svg');
              if (svg) {
                svg.innerHTML = `<path d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 11-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z" />`;
              }
              button.title = 'To√†n m√†n h√¨nh';
            };
            updateBtnState(btn);
            updateBtnState(document.getElementById('fullscreen-btn-right'));

            console.log('üñ•Ô∏è Tho√°t ch·∫ø ƒë·ªô to√†n m√†n h√¨nh + thu ph√≥ng');
          } catch (error) {
            console.error('‚ùå Tho√°t to√†n m√†n h√¨nh th·∫•t b·∫°i:', error);
          }
        }

        handleFullscreenChange() {
          const e = document.querySelector('.connected-panels'),
            t = document.getElementById('fullscreen-btn'),
            tRight = document.getElementById('fullscreen-btn-right');

          if (!e || !t) return;

          const isFullscreen = !!(
            document.fullscreenElement ||
            document.webkitFullscreenElement ||
            document.mozFullScreenElement ||
            document.msFullscreenElement
          );
          const updateButton = (btn, isFullscreen) => {
            if (!btn) return;
            const svg = btn.querySelector('svg');
            if (svg) {
              svg.innerHTML = `<path d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 11-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z" />`;
            }
            btn.title = isFullscreen ? 'Tho√°t to√†n m√†n h√¨nh' : 'To√†n m√†n h√¨nh';
          };

          if (isFullscreen) {
            e.classList.add('fullscreen-active');
            updateButton(t, true);
            updateButton(tRight, true);
            console.log('üñ•Ô∏è V√†o ch·∫ø ƒë·ªô to√†n m√†n h√¨nh');
          } else {
            e.classList.remove('fullscreen-active');
            const overlay = document.getElementById('teresen-fullscreen-overlay');
            if (overlay) {
              this.exitFullscreenWithZoom(e, t, overlay);
              const modalsToRestore = [
                'quick-action-modal',
                'quick-position-modal',
                'rules-modal',
                'settings-modal',
                'talents-modal',
                'load-modal',
                'world-map-modal',
              ];

              modalsToRestore.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal && modal.parentNode === overlay) {
                  const originalParent = modal.dataset.originalParent;
                  if (originalParent === 'BODY' || !originalParent) {
                    document.body.appendChild(modal);
                    console.log(`‚úÖ ${modalId} ƒë√£ di chuy·ªÉn t·ª´ overlay v·ªÅ body`);
                  }
                }
              });
            } else {
              if (e.dataset.originalStyle) {
                const originalStyle = JSON.parse(e.dataset.originalStyle);
                e.style.width = originalStyle.width || '';
                e.style.height = originalStyle.height || '';
                e.style.maxWidth = originalStyle.maxWidth || '';
                e.style.maxHeight = originalStyle.maxHeight || '';
                e.style.minWidth = '';
                e.style.minHeight = '';
                e.style.flexShrink = '';

                delete e.dataset.originalStyle;
                delete e.dataset.originalWidth;
                delete e.dataset.originalHeight;
                delete e.dataset.originalAspectRatio;
              }
            }
            updateButton(t, false);
            updateButton(tRight, false);
            console.log('üñ•Ô∏è Tho√°t ch·∫ø ƒë·ªô to√†n m√†n h√¨nh');
          }
        }

        async handleSave(e = 'local') {
          try {
            console.log(`üíæ B·∫Øt ƒë·∫ßu l∆∞u tr·ªØ ${'local' === e ? 'c·ª•c b·ªô' : 'S√°ch th·∫ø gi·ªõi'}...`);

            const gameState = this.getAllVariables();
            let chatHistory = [];
            try {
              chatHistory = await this.loadChatHistoryFromExtra();
              console.log(`üìã ƒê·ªçc ƒë∆∞·ª£c ${chatHistory.length} tin nh·∫Øn t·ª´ extra.teresen_chat`);
            } catch (error) {
              console.error('‚ùå ƒê·ªçc extra.teresen_chat th·∫•t b·∫°i:', error);
              chatHistory = [];
            }
            const bookName = '- Uma Musume: Chuy·ªán l·∫° Tracen';
            const baseJourneyKey = this._getBaseJourneyKey();
            const baseCoreKey = this._getBaseCoreMemoryKey();
            let journeyContent = '';
            let coreMemoryContent = '';
            try {
              const allEntries = await TavernHelper.getLorebookEntries(bookName);
              const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);
              const coreEntry = allEntries.find(entry => entry.comment === baseCoreKey);
              journeyContent = journeyEntry?.content || '';
              coreMemoryContent = coreEntry?.content || '';
              console.log(
                `üìö ƒê·ªçc n·ªôi dung S√°ch th·∫ø gi·ªõi: Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y(${journeyContent.length} k√Ω t·ª±), K√Ω ·ª©c c·ªët l√µi v√≤ng l·∫∑p n√†y(${coreMemoryContent.length} k√Ω t·ª±)`,
              );
            } catch (e) {
              console.error('‚ùå ƒê·ªçc n·ªôi dung S√°ch th·∫ø gi·ªõi th·∫•t b·∫°i:', e);
            }
            let timelineHistory = [];
            if (chatHistory && chatHistory.length > 0) {
              timelineHistory = chatHistory.map(msg => ({
                message: msg.content || '',
                message_id: msg.id || `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                timestamp: msg.timestamp || Date.now(),
                data: msg.variableState || null,
              }));
            } else if (this.chatHistoryCache && this.chatHistoryCache.length > 0) {
              timelineHistory = JSON.parse(JSON.stringify(this.chatHistoryCache));
            }

            const saveData = {
              timestamp: Date.now(),

              saveName: `L∆∞u Th·ªß C√¥ng_${new Date().toLocaleString('vi-VN')}`,

              type: 'manual',

              timeline_history: timelineHistory, 

              snapshot_data: {
                mvu_data: gameState,

                lorebook_content: {
                  journey: journeyContent,

                  core_memory: coreMemoryContent,
                },
              },
            };

            if (e === 'local') {

              localStorage.setItem('teresen-save', JSON.stringify(saveData));

              console.log('‚úÖ L∆∞u tr·ªØ c·ª•c b·ªô th√†nh c√¥ng, bao g·ªìm', timelineHistory.length, 'tin nh·∫Øn');

              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage(`L∆∞u tr·ªØ c·ª•c b·ªô th√†nh c√¥ng! Bao g·ªìm ${timelineHistory.length} tin nh·∫Øn`);
              }
            } else {

              localStorage.setItem('teresen-save', JSON.stringify(saveData));

              console.log('‚úÖ L∆∞u tr·ªØ S√°ch th·∫ø gi·ªõi th√†nh c√¥ng, bao g·ªìm', timelineHistory.length, 'tin nh·∫Øn');

              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage(`L∆∞u tr·ªØ S√°ch th·∫ø gi·ªõi th√†nh c√¥ng! Bao g·ªìm ${timelineHistory.length} tin nh·∫Øn`);
              }
            }
            try {
              const saveLorebookEntry = {
                comment: `L∆∞u Tr·ªØ-${saveData.saveName}`,
                content: JSON.stringify({
                  save_name: saveData.saveName,
                  timestamp: saveData.timestamp,
                  round_count: timelineHistory.length,
                  has_journey: !!journeyContent,
                  has_core_memory: !!coreMemoryContent,
                }),
                keys: [`L∆∞u Tr·ªØ`, saveData.saveName],
                enabled: false,
                selective: false,
                constant: false,
                position: 'in_chat',
              };

              await TavernHelper.createLorebookEntries(bookName, [saveLorebookEntry]);
              console.log(`‚úÖ ƒê√£ t·∫°o m·ª•c S√°ch th·∫ø gi·ªõi: L∆∞u Tr·ªØ-${saveData.saveName}`);
            } catch (e) {
              console.warn('T·∫°o m·ª•c S√°ch th·∫ø gi·ªõi th·∫•t b·∫°i (kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn l∆∞u tr·ªØ):', e);
            }

            $('#load-modal').hide();
          } catch (error) {
            console.error('‚ùå L∆∞u tr·ªØ th·∫•t b·∫°i:', error);

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('L∆∞u tr·ªØ th·∫•t b·∫°i!');
            }
          }
        }
        showCardDisplayModal(selectedUmaName = null) {
          const modal = document.getElementById('card-display-modal');
          if (!modal) return;
          const cardImages = [
            'https://i.ibb.co/qYTp2NZ7/1.jpg',
            'https://i.ibb.co/0RYXQ6Tf/2.jpg',
            'https://i.ibb.co/jPJH7tYk/3.jpg',
            'https://i.ibb.co/ym5wY14R/4.jpg',
            'https://i.ibb.co/yB0SjDZ1/5.jpg',
            'https://i.ibb.co/39gc8R4b/6.jpg',
            'https://i.ibb.co/5g92hwY7/7.jpg',
            'https://i.ibb.co/mrSLGdyL/8.jpg',
            'https://i.ibb.co/39wDQShm/9.jpg',
            'https://i.ibb.co/sp5db3jp/10.jpg',
            'https://i.ibb.co/V0GyrGB2/11.png',
            'https://i.ibb.co/3mcDgrmZ/12.jpg',
            'https://i.ibb.co/5gzzp561/13.jpg',
            'https://i.ibb.co/SwQBJm6z/14.jpg',
            'https://i.ibb.co/0RfCRvTs/15.jpg',
            'https://i.ibb.co/JWjdNhFw/16.jpg',
            'https://i.ibb.co/xSBKRkK5/17.jpg',
            'https://i.ibb.co/7trWqhzN/18.jpg',
            'https://i.ibb.co/qYrckYPc/19.jpg',
            'https://i.ibb.co/5xGHXgs8/20.jpg',
            'https://i.ibb.co/NbBv5SG/21.jpg',
            'https://i.ibb.co/mFv1pgn7/22.jpg',
            'https://i.ibb.co/MkDZcYBJ/23.jpg',
            'https://i.ibb.co/XxjgbfDy/24.jpg',
            'https://i.ibb.co/84X0F6y0/25.jpg',
            'https://i.ibb.co/Xx97Sk5J/26.jpg',
            'https://i.ibb.co/YBWHX1n5/27.jpg',
            'https://i.ibb.co/v431tVDz/28.jpg',
            'https://i.ibb.co/s92DYt0K/29.jpg',
            'https://i.ibb.co/KckF1zsk/30.jpg',
            'https://i.ibb.co/39nmCYPv/31.jpg',
            'https://i.ibb.co/XfBLBHR9/32.jpg',
            'https://i.ibb.co/k2hCms4X/33.png',
            'https://i.ibb.co/bjKMh9PJ/34.jpg',
            'https://i.ibb.co/VWDs1hdv/35.jpg',
            'https://i.ibb.co/SD4vgTjp/36.jpg',
            'https://i.ibb.co/v4LD9G9g/37.jpg',
            'https://i.ibb.co/k2kMmqJy/38.jpg',
            'https://i.ibb.co/hJgC1VJL/39.jpg',
            'https://i.ibb.co/3yVZcPW5/40.jpg',
            'https://i.ibb.co/vR4zWzm/41.jpg',
            'https://i.ibb.co/Jwkp7PBJ/42.jpg',
            'https://i.ibb.co/rXF4HWz/43.jpg',
            'https://i.ibb.co/VYDfFybp/44.jpg',
            'https://i.ibb.co/XrxT8cN3/45.jpg',
            'https://i.ibb.co/mCm0zWGv/46.jpg',
            'https://i.ibb.co/LzgKVVyx/47.jpg',
            'https://i.ibb.co/RGgj2rKF/48.jpg',
            'https://i.ibb.co/Y4CBT78Z/49.jpg',
            'https://i.ibb.co/fdyvNgVN/50.jpg',
            'https://i.ibb.co/Fk0m72Z3/51.jpg',
          ];
          const grid = document.getElementById('card-display-grid');
          if (grid) {
            grid.innerHTML = '';
            cardImages.forEach((imageUrl, index) => {
              const item = document.createElement('div');
              item.className = 'card-display-item';
              item.innerHTML = `<img src="${imageUrl}" alt="Th·∫ª b√†i ${index + 1}" loading="lazy">`;
              item.addEventListener('click', () => this.showCardImageViewer(imageUrl));
              grid.appendChild(item);
            });
          }
          this.renderUmaExpressions(selectedUmaName);
          modal.style.display = 'flex';
          modal.style.justifyContent = 'center';
          modal.style.alignItems = 'center';
          this.ensureModalInOverlay(modal);
        }
        showCardImageViewer(imageUrl) {
          const existingViewer = document.querySelector('.card-image-viewer');
          if (existingViewer) {
            existingViewer.remove();
          }
          requestAnimationFrame(() => {
            const viewer = document.createElement('div');
            viewer.className = 'card-image-viewer';
            const img = document.createElement('img');
            img.alt = '·∫¢nh th·∫ª b√†i l·ªõn';
            img.setAttribute('data-loading', 'true');
            img.onload = () => {
              requestAnimationFrame(() => {
                img.setAttribute('data-loaded', 'true');
                img.removeAttribute('data-loading');
              });
            };
            img.onerror = () => {
              img.alt = 'T·∫£i ·∫£nh th·∫•t b·∫°i';
              img.setAttribute('data-loaded', 'true');
              img.removeAttribute('data-loading');
            };
            img.src = imageUrl;
            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-viewer';
            closeBtn.textContent = '√ó';

            viewer.appendChild(closeBtn);
            viewer.appendChild(img);
            closeBtn.addEventListener('click', e => {
              e.stopPropagation();
              requestAnimationFrame(() => {
                viewer.remove();
              });
            });
            viewer.addEventListener('click', e => {
              if (e.target === viewer) {
                requestAnimationFrame(() => {
                  viewer.remove();
                });
              }
            });
            const escHandler = e => {
              if (e.key === 'Escape') {
                requestAnimationFrame(() => {
                  viewer.remove();
                  document.removeEventListener('keydown', escHandler);
                });
              }
            };
            document.addEventListener('keydown', escHandler);
            const overlay = document.getElementById('teresen-fullscreen-overlay');
            if (overlay) {
              overlay.appendChild(viewer);
            } else {
              document.body.appendChild(viewer);
            }
            viewer.offsetHeight;
          });
        }
        async handleChatHistory() {
          try {
            console.log('üí¨ Hi·ªÉn th·ªã l·ªãch s·ª≠ tr√≤ chuy·ªán trong b·∫£ng ƒëi·ªÅu khi·ªÉn l·ªãch s·ª≠...');
            const chatHistoryPanel = document.getElementById('chat-history-panel');
            const contentList = document.getElementById('chat-history-content-list');

            if (!chatHistoryPanel || !contentList) {
              console.error('‚ùå Kh√¥ng t√¨m th·∫•y b·∫£ng ƒëi·ªÅu khi·ªÉn l·ªãch s·ª≠ tr√≤ chuy·ªán');
              return;
            }
            chatHistoryPanel.style.display = 'block';
            const chatHistory = await this.loadChatHistoryFromExtra();
            console.log('üìä ƒê√£ t·∫£i', chatHistory.length, 'tin nh·∫Øn t·ª´ extra.teresen_chat');

            if (!chatHistory || chatHistory.length === 0) {
              contentList.innerHTML =
                '<div style="text-align: center; color: #8b4513; padding: 20px;">T·∫°m kh√¥ng c√≥ l·ªãch s·ª≠ tr√≤ chuy·ªán</div>';
              return;
            }
            const formattedHistory = chatHistory.map((msg, index) => {
              let displayContent = msg.content || '';
              const contentMatch = displayContent.match(/<content>([\s\S]*?)<\/content>/s);
              if (contentMatch) {
                displayContent = contentMatch[1].trim();
              }

              return {
                id: msg.id || `msg_${index}_${Date.now()}`, 
                role: msg.role || 'assistant',
                timestamp: msg.timestamp || Date.now() - (chatHistory.length - index) * 1000,
                send_date: msg.timestamp ? new Date(msg.timestamp).toLocaleString('vi-VN') : `Tin nh·∫Øn #${index + 1}`,
                content: displayContent,
                message: msg.content || '', 
                variableState: msg.variableState || msg.data || null,
                originalIndex: index, 
              };
            });

            const html = this.formatChatHistoryForStory(formattedHistory);
            contentList.innerHTML = html;
            const font = localStorage.getItem('teresen_font') || "'Source Han Serif', 'ÊÄùÊ∫êÂÆã‰Ωì', serif";
            const size = localStorage.getItem('teresen_font_size') || '1';
            const messageContents = contentList.querySelectorAll('.message-content');
            messageContents.forEach(el => {
              el.style.fontFamily = font;
              el.style.fontSize = size + 'em';
            });
            this.currentChatHistory = formattedHistory;
            this.bindChatHistoryActions(contentList);
            setTimeout(() => {
              chatHistoryPanel.scrollTo({ top: chatHistoryPanel.scrollHeight, behavior: 'smooth' });
            }, 100);
          } catch (error) {
            console.error('Hi·ªÉn th·ªã l·ªãch s·ª≠ tr√≤ chuy·ªán th·∫•t b·∫°i:', error);
            const contentList = document.getElementById('chat-history-content-list');
            if (contentList) {
              contentList.innerHTML = `<div style="text-align: center; color: #dc3545; padding: 20px;">Hi·ªÉn th·ªã l·ªãch s·ª≠ tr√≤ chuy·ªán th·∫•t b·∫°i: ${error.message}</div>`;
            }
          }
        }

        
        async restoreStoryContent() {
          try {
            const chatHistoryPanel = document.getElementById('chat-history-panel');
            if (chatHistoryPanel) {
              chatHistoryPanel.style.display = 'none';
              console.log('‚úÖ ƒê√£ ·∫©n b·∫£ng ƒëi·ªÅu khi·ªÉn l·ªãch s·ª≠ tr√≤ chuy·ªán');
            }
            this.currentChatHistory = null;
          } catch (error) {
            console.error('‚ùå ·∫®n b·∫£ng ƒëi·ªÅu khi·ªÉn l·ªãch s·ª≠ tr√≤ chuy·ªán th·∫•t b·∫°i:', error);
          }
        }
        createChatHistoryViewer(chatHistory) {
          const existing = document.getElementById('chat-history-modal');
          if (existing) {
            existing.remove();
          }

          const modal = document.createElement('div');
          modal.id = 'chat-history-modal';
          modal.innerHTML = `
            <div class="summary-modal-overlay" style="
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.8);
              z-index: 10000;
              display: flex;
              align-items: center;
              justify-content: center;
            ">
              <div class="summary-modal-content" style="
                background: linear-gradient(135deg, #f5f0e8, #ede4d3);
                border: 2px solid #d4af37;
                border-radius: 12px;
                width: 90%;
                max-width: 800px;
                max-height: 80%;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                display: flex;
                flex-direction: column;
              ">
                <div class="summary-modal-header" style="
                  padding: 20px;
                  border-bottom: 1px solid #d4af37;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  background: linear-gradient(135deg, #f0e6d2, #e8dcc6);
                ">
                  <h3 style="
                    color: #8b4513;
                    margin: 0;
                    font-size: 18px;
                    font-weight: bold;
                  ">üí¨ Tr√¨nh xem l·ªãch s·ª≠ tr√≤ chuy·ªán</h3>
                  <button class="chat-history-close-btn" style="
                    background: none;
                    border: none;
                    color: #8b4513;
                    font-size: 24px;
                    cursor: pointer;
                    padding: 5px;
                    border-radius: 4px;
                    transition: background 0.2s;
                  ">&times;</button>
                </div>
                <div class="chat-controls" style="
                  padding: 15px 20px;
                  border-bottom: 1px solid rgba(212, 175, 55, 0.3);
                  display: flex;
                  gap: 10px;
                  align-items: center;
                  flex-wrap: wrap;
                  background: rgba(212, 175, 55, 0.1);
                ">
                  <input type="text" id="chat-search-input" placeholder="üîç T√¨m ki·∫øm n·ªôi dung tr√≤ chuy·ªán..." style="
                    flex: 1;
                    min-width: 200px;
                    padding: 8px 12px;
                    background: rgba(255,255,255,0.8);
                    border: 1px solid #d4af37;
                    color: #8b4513;
                    border-radius: 4px;
                    font-size: 0.9em;
                  ">
                  <button id="scroll-to-top-btn" style="
                    padding: 8px 15px;
                    background: linear-gradient(135deg, #d4af37, #e6c347);
                    border: 1px solid #8b4513;
                    color: #8b4513;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 0.9em;
                    transition: all 0.3s ease;
                    font-weight: bold;
                  ">‚¨ÜÔ∏è L√™n ƒë·∫ßu</button>
                  <button id="scroll-to-bottom-btn" style="
                    padding: 8px 15px;
                    background: linear-gradient(135deg, #d4af37, #e6c347);
                    border: 1px solid #8b4513;
                    color: #8b4513;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 0.9em;
                    transition: all 0.3s ease;
                    font-weight: bold;
                  ">‚¨áÔ∏è Xu·ªëng ƒë√°y</button>
                  <button id="export-chat-btn" style="
                    padding: 8px 15px;
                    background: linear-gradient(135deg, #d4af37, #e6c347);
                    border: 1px solid #8b4513;
                    color: #8b4513;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 0.9em;
                    transition: all 0.3s ease;
                    font-weight: bold;
                  ">üì• Xu·∫•t</button>
                </div>
                <div class="chat-history-body" id="chat-history-content" style="
                  padding: 20px;
                  flex-grow: 1;
                  overflow-y: auto;
                  background: rgba(255,255,255,0.3);
                  color: #8b4513;
                ">
                  ${this.formatChatHistory(chatHistory)}
                </div>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
          this.ensureModalInOverlay(modal);
          const closeBtn = modal.querySelector('.chat-history-close-btn');
          const overlay = modal.querySelector('.summary-modal-overlay');
          const searchInput = modal.querySelector('#chat-search-input');
          const scrollTopBtn = modal.querySelector('#scroll-to-top-btn');
          const scrollBottomBtn = modal.querySelector('#scroll-to-bottom-btn');
          const exportBtn = modal.querySelector('#export-chat-btn');
          const contentArea = modal.querySelector('#chat-history-content');

          const closeModal = () => modal.remove();
          closeBtn.addEventListener('click', closeModal);
          overlay.addEventListener('click', e => {
            if (e.target === overlay) closeModal();
          });
          let searchTimeout;
          searchInput.addEventListener('input', e => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
              this.searchChatHistory(e.target.value, contentArea, chatHistory);
            }, 300);
          });
          scrollTopBtn.addEventListener('click', () => {
            contentArea.scrollTo({ top: 0, behavior: 'smooth' });
          });

          scrollBottomBtn.addEventListener('click', () => {
            contentArea.scrollTo({ top: contentArea.scrollHeight, behavior: 'smooth' });
          });
          exportBtn.addEventListener('click', async () => {
            await this.exportChatHistory(chatHistory);
          });
          contentArea.addEventListener('click', async e => {
            const btn = e.target.closest('.msg-btn');
            if (!btn) return;

            const messageId = btn.getAttribute('data-message-id');
            const messageItem = contentArea.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageItem) return;

            if (btn.classList.contains('edit-btn')) {
              await this.handleEditMessage(messageId, messageItem, chatHistory);
            } else if (btn.classList.contains('delete-btn')) {
              await this.handleDeleteMessage(messageId, chatHistory, modal);
            } else if (btn.classList.contains('save-btn')) {
              const textarea = messageItem.querySelector('.edit-textarea');
              if (textarea) {
                await this.updateMessageInHistory(messageId, textarea.value, chatHistory, modal);
              }
            } else if (btn.classList.contains('cancel-btn')) {
              await this.refreshChatHistoryViewer(modal, chatHistory);
            }
          });
          [scrollTopBtn, scrollBottomBtn, exportBtn].forEach(btn => {
            btn.addEventListener('mouseenter', () => {
              btn.style.background = 'rgba(139, 69, 19, 0.4)';
              btn.style.transform = 'translateY(-1px)';
            });
            btn.addEventListener('mouseleave', () => {
              btn.style.background = 'rgba(139, 69, 19, 0.2)';
              btn.style.transform = 'translateY(0)';
            });
          });
          setTimeout(() => {
            contentArea.scrollTo({ top: contentArea.scrollHeight, behavior: 'smooth' });
          }, 100);
        }

        
        formatChatHistoryForStory(chatHistory) {
          if (!chatHistory || chatHistory.length === 0) {
            return '<p class="story-text" style="text-align: center; color: #8b4513; padding: 20px;">T·∫°m kh√¥ng c√≥ l·ªãch s·ª≠ tr√≤ chuy·ªán</p>';
          }

          console.log(`üìú ƒêang ƒë·ªãnh d·∫°ng ${chatHistory.length} tin nh·∫Øn l·ªãch s·ª≠ ƒë·ªÉ hi·ªÉn th·ªã trong khu v·ª±c n·ªôi dung c√¢u chuy·ªán`);

          let html = '';
          const sortedMessages = [...chatHistory].sort((a, b) => {
            const timeA = new Date(a.timestamp || a.send_date || Date.now()).getTime();
            const timeB = new Date(b.timestamp || b.send_date || Date.now()).getTime();
            return timeA - timeB;
          });

          let messageNumber = 0; 
          sortedMessages.forEach((msg, index) => {
            let content = msg.content || msg.message || '';
            if (!content.trim()) {
              return;
            }

            messageNumber++; 
            if (msg.role === 'assistant' || msg.role === 'ai') {
              const contentMatch = content.match(/<content>([\s\S]*?)<\/content>/s);
              if (contentMatch) {
                content = contentMatch[1].trim();
              }
            }
            const messageId = msg.id || `msg_${index}_${Date.now()}`;
            const escapedContent = this.escapeHtml(content).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            html += `
              <div class="chat-message-item" data-message-id="${messageId}" style="
                margin-bottom: 15px;
                position: relative;
                padding-bottom: 10px;
                border-bottom: 1px solid rgba(139, 105, 20, 0.1);
              ">
                <div style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  margin-bottom: 6px;
                ">
                  <div style="
                    color: rgba(139, 105, 20, 0.6);
                    font-size: 0.8em;
                    font-weight: 500;
                  ">Tin nh·∫Øn th·ª© ${messageNumber}</div>
                  <div class="message-actions" style="
                    display: flex;
                    gap: 6px;
                    opacity: 0;
                    transition: opacity 0.2s;
                  ">
                    <span class="msg-icon copy-btn" title="Sao ch√©p" data-message-id="${messageId}" data-content="${escapedContent}" style="
                      color: rgba(139, 105, 20, 0.6);
                      cursor: pointer;
                      font-size: 1em;
                      transition: color 0.2s;
                      user-select: none;
                    " onmouseover="this.style.color='rgba(139, 105, 20, 0.9)'" onmouseout="this.style.color='rgba(139, 105, 20, 0.6)'">üìã</span>
                    <span class="msg-icon edit-btn" title="Ch·ªânh s·ª≠a" data-message-id="${messageId}" style="
                      color: rgba(139, 105, 20, 0.6);
                      cursor: pointer;
                      font-size: 1em;
                      transition: color 0.2s;
                      user-select: none;
                    " onmouseover="this.style.color='rgba(139, 105, 20, 0.9)'" onmouseout="this.style.color='rgba(139, 105, 20, 0.6)'">‚úèÔ∏è</span>
                    <span class="msg-icon delete-btn" title="X√≥a" data-message-id="${messageId}" style="
                      color: rgba(139, 105, 20, 0.6);
                      cursor: pointer;
                      font-size: 1em;
                      transition: color 0.2s;
                      user-select: none;
                    " onmouseover="this.style.color='rgba(220, 53, 69, 0.8)'" onmouseout="this.style.color='rgba(139, 105, 20, 0.6)'">üóëÔ∏è</span>
                  </div>
                </div>
                <div class="message-content" style="
                  color: #2d1810;
                  line-height: 1.6;
                  white-space: pre-wrap;
                  word-wrap: break-word;
                ">${this.escapeHtml(content)}</div>
              </div>
            `;
          });
          html += `
            <style>
              .chat-message-item:hover .message-actions {
                opacity: 1 !important;
              }
            </style>
          `;

          console.log(`‚úÖ ƒê·ªãnh d·∫°ng l·ªãch s·ª≠ tr√≤ chuy·ªán th√†nh c√¥ng`);

          return html || '<div style="text-align: center; color: #8b4513; padding: 20px;">Kh√¥ng t√¨m th·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán h·ª£p l·ªá</div>';
        }
        formatChatHistory(chatHistory) {
          if (!chatHistory || chatHistory.length === 0) {
            return '<div style="color: #8b4513; text-align: center; padding: 20px; font-weight: bold;">T·∫°m kh√¥ng c√≥ l·ªãch s·ª≠ tr√≤ chuy·ªán</div>';
          }
          console.log(`üìú ƒêang ƒë·ªãnh d·∫°ng ${chatHistory.length} tin nh·∫Øn l·ªãch s·ª≠ tr√≤ chuy·ªán`);

          let html = '';
          let displayCount = 0;
          const sortedMessages = [...chatHistory].sort((a, b) => {
            const timeA = new Date(a.timestamp || a.send_date || Date.now()).getTime();
            const timeB = new Date(b.timestamp || b.send_date || Date.now()).getTime();
            return timeA - timeB;
          });

          sortedMessages.forEach((msg, index) => {
            const time =
              msg.send_date ||
              (msg.timestamp ? new Date(msg.timestamp).toLocaleString('zh-CN') : '') ||
              new Date().toLocaleString('zh-CN');
            const content = msg.content || msg.mes || msg.message || '';
            if (!content.trim()) {
              console.log(`‚è≠Ô∏è B·ªè qua tin nh·∫Øn th·ª© ${index + 1}: N·ªôi dung tr·ªëng`);
              return;
            }
            const isUser = msg.is_user || msg.type === 'user';
            const isAI = msg.type === 'ai' || msg.type === 'assistant' || (!isUser && content);

            displayCount++;
            const messageId = msg.id || `msg_${index}_${Date.now()}`;

            if (isUser) {
              html += `
                <div class="chat-message-item" data-message-id="${messageId}" style="
                  margin-bottom: 15px;
                  padding: 12px;
                  background: rgba(100, 149, 237, 0.1);
                  border-left: 4px solid #6495ED;
                  border-radius: 4px;
                  animation: fadeIn 0.3s ease-in;
                  position: relative;
                ">
                  <div style="color: #6495ED; font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                    <span>üéÆ Ng∆∞·ªùi ch∆°i</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 0.85em; opacity: 0.8;">${time}</span>
                      <div class="message-actions" style="display: flex; gap: 4px;">
                        <button class="msg-btn edit-btn" title="Ch·ªânh s·ª≠a" data-message-id="${messageId}" style="
                          background: rgba(100, 149, 237, 0.2);
                          border: none;
                          color: #6495ED;
                          padding: 4px 8px;
                          border-radius: 3px;
                          cursor: pointer;
                          font-size: 0.9em;
                          transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(100, 149, 237, 0.4)'" onmouseout="this.style.background='rgba(100, 149, 237, 0.2)'">‚úèÔ∏è</button>
                        <button class="msg-btn delete-btn" title="X√≥a" data-message-id="${messageId}" style="
                          background: rgba(220, 53, 69, 0.2);
                          border: none;
                          color: #dc3545;
                          padding: 4px 8px;
                          border-radius: 3px;
                          cursor: pointer;
                          font-size: 0.9em;
                          transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(220, 53, 69, 0.4)'" onmouseout="this.style.background='rgba(220, 53, 69, 0.2)'">üóëÔ∏è</button>
                  </div>
                    </div>
                  </div>
                  <div class="message-content" style="color: #2d1810; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; font-weight: 500;">
                    ${this.escapeHtml(content)}
                  </div>
                </div>
              `;
              displayCount++;
            } else if (isAI) {
              html += `
                <div class="chat-message-item" data-message-id="${messageId}" style="
                  margin-bottom: 15px;
                  padding: 12px;
                  background: rgba(255, 165, 0, 0.1);
                  border-left: 4px solid #FFA500;
                  border-radius: 4px;
                  animation: fadeIn 0.3s ease-in;
                  position: relative;
                ">
                  <div style="color: #FFA500; font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                    <span>ü§ñ Tr·ª£ l√Ω AI</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 0.85em; opacity: 0.8;">${time}</span>
                      <div class="message-actions" style="display: flex; gap: 4px;">
                        <button class="msg-btn edit-btn" title="Ch·ªânh s·ª≠a" data-message-id="${messageId}" style="
                          background: rgba(255, 165, 0, 0.2);
                          border: none;
                          color: #FF8C00;
                          padding: 4px 8px;
                          border-radius: 3px;
                          cursor: pointer;
                          font-size: 0.9em;
                          transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(255, 165, 0, 0.4)'" onmouseout="this.style.background='rgba(255, 165, 0, 0.2)'">‚úèÔ∏è</button>
                        <button class="msg-btn delete-btn" title="X√≥a" data-message-id="${messageId}" style="
                          background: rgba(220, 53, 69, 0.2);
                          border: none;
                          color: #dc3545;
                          padding: 4px 8px;
                          border-radius: 3px;
                          cursor: pointer;
                          font-size: 0.9em;
                          transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(220, 53, 69, 0.4)'" onmouseout="this.style.background='rgba(220, 53, 69, 0.2)'">üóëÔ∏è</button>
                  </div>
                    </div>
                  </div>
                  <div class="message-content" style="color: #2d1810; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; font-weight: 500;">
                    ${this.escapeHtml(content)}
                  </div>
                </div>
              `;
              displayCount++;
            }
          });

          console.log(`‚úÖ ƒê·ªãnh d·∫°ng th√†nh c√¥ng ${displayCount} tin nh·∫Øn l·ªãch s·ª≠ tr√≤ chuy·ªán`);

          if (html) {
            html =
              `
              <div style="
                text-align: center; 
                color: #8b4513; 
                margin-bottom: 20px; 
                padding: 10px;
                background: rgba(212, 175, 55, 0.15);
                border-radius: 4px;
                font-weight: bold;
              ">
                üìä Hi·ªÉn th·ªã t·ªïng c·ªông ${displayCount} tin nh·∫Øn l·ªãch s·ª≠ tr√≤ chuy·ªán
              </div>
            ` + html;

            return html;
          } else {
            return '<div style="color: #8b4513; text-align: center; padding: 20px; font-weight: bold;">Kh√¥ng t√¨m th·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán h·ª£p l·ªá</div>';
          }
        }
        escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }

        
        async handleEditMessage(messageId, messageItem, chatHistory) {
          try {
            const msg = chatHistory.find(m => m.id === messageId);
            if (!msg) {
              console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y tin nh·∫Øn:', messageId);
              return;
            }
            const originalContent = msg.message || msg.content || '';
            const messageContent = messageItem.querySelector('.message-content');
            const messageActions = messageItem.querySelector('.message-actions');

            if (!messageContent || !messageActions) return;
            messageContent.innerHTML = `<textarea class="edit-textarea" style="
              width: 100%;
              min-height: 100px;
              padding: 8px;
              border: 1px solid rgba(139, 105, 20, 0.3);
              border-radius: 4px;
              background: rgba(255, 255, 255, 0.9);
              color: #2d1810;
              font-size: 0.9em;
              line-height: 1.5;
              resize: vertical;
              font-family: inherit;
            ">${this.escapeHtml(originalContent)}</textarea>`;

            messageActions.innerHTML = `
              <button class="msg-btn save-btn" title="L∆∞u" data-message-id="${messageId}" style="
                background: rgba(40, 167, 69, 0.2);
                border: none;
                color: #28a745;
                padding: 4px 8px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 0.9em;
                transition: all 0.2s;
              " onmouseover="this.style.background='rgba(40, 167, 69, 0.4)'" onmouseout="this.style.background='rgba(40, 167, 69, 0.2)'">‚úîÔ∏è</button>
              <button class="msg-btn cancel-btn" title="H·ªßy" data-message-id="${messageId}" style="
                background: rgba(220, 53, 69, 0.2);
                border: none;
                color: #dc3545;
                padding: 4px 8px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 0.9em;
                transition: all 0.2s;
              " onmouseover="this.style.background='rgba(220, 53, 69, 0.4)'" onmouseout="this.style.background='rgba(220, 53, 69, 0.2)'">‚ùå</button>
            `;

            messageItem.classList.add('is-editing');
            const textarea = messageContent.querySelector('.edit-textarea');
            if (textarea) {
              this._autoResizeTextarea(textarea);
              textarea.focus();
              textarea.addEventListener('input', () => this._autoResizeTextarea(textarea));
            }
          } catch (error) {
            console.error('‚ùå Ch·ªânh s·ª≠a tin nh·∫Øn th·∫•t b·∫°i:', error);
          }
        }

        
        _autoResizeTextarea(textarea) {
          textarea.style.height = 'auto';
          textarea.style.height = `${textarea.scrollHeight}px`;
        }

        
        bindChatHistoryActions(container) {
          if (this.chatHistoryClickHandler) {
            container.removeEventListener('click', this.chatHistoryClickHandler);
          }
          this.chatHistoryClickHandler = async e => {
            const icon = e.target.closest('.msg-icon');
            const btn = e.target.closest('.msg-btn');
            const target = icon || btn;
            if (!target) return;

            const messageId = target.getAttribute('data-message-id');
            const messageItem = container.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageItem || !this.currentChatHistory) return;
            if (target.classList.contains('copy-btn')) {
              const content =
                target.getAttribute('data-content') || messageItem.querySelector('.message-content')?.textContent || '';
              try {
                await navigator.clipboard.writeText(content);
                const originalText = target.textContent;
                target.textContent = '‚úì';
                target.style.color = '#28a745';
                setTimeout(() => {
                  target.textContent = originalText;
                  target.style.color = '';
                }, 1000);
                console.log('‚úÖ ƒê√£ sao ch√©p n·ªôi dung tin nh·∫Øn v√†o clipboard');
              } catch (err) {
                console.error('‚ùå Sao ch√©p th·∫•t b·∫°i:', err);
                const textarea = document.createElement('textarea');
                textarea.value = content;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                const originalText = target.textContent;
                target.textContent = '‚úì';
                target.style.color = '#28a745';
                setTimeout(() => {
                  target.textContent = originalText;
                  target.style.color = '';
                }, 1000);
              }
              return;
            }

            if (target.classList.contains('edit-btn') || btn?.classList.contains('edit-btn')) {
              await this.handleEditMessageInStory(messageId, messageItem, this.currentChatHistory);
            } else if (target.classList.contains('delete-btn') || btn?.classList.contains('delete-btn')) {
              await this.handleDeleteMessageInStory(messageId, this.currentChatHistory);
            } else if (btn?.classList.contains('save-btn')) {
              const textarea = messageItem.querySelector('.edit-textarea');
              if (textarea) {
                await this.updateMessageInStory(messageId, textarea.value, this.currentChatHistory);
              }
            } else if (btn?.classList.contains('cancel-btn')) {
              await this.refreshChatHistoryInStory(this.currentChatHistory);
            }
          };
          container.addEventListener('click', this.chatHistoryClickHandler);
        }

        
        async handleEditMessageInStory(messageId, messageItem, chatHistory) {
          await this.handleEditMessage(messageId, messageItem, chatHistory);
        }

        
        async handleDeleteMessageInStory(messageId, chatHistory) {
          try {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a tin nh·∫Øn n√†y kh√¥ng?')) {
              return;
            }
            const fullHistory = await this.loadChatHistoryFromExtra();
            const updatedHistory = fullHistory.filter(msg => msg.id !== messageId);
            await this._syncStateWithHistory(updatedHistory);
            await this.refreshChatHistoryInStory(updatedHistory);
            const lastMessage = updatedHistory[updatedHistory.length - 1];
            if (lastMessage && lastMessage.variableState) {
              this.currentMvuState = JSON.parse(JSON.stringify(lastMessage.variableState));
              if (lastMessage.variableState.stat_data) {
                this.renderUI(lastMessage.variableState.stat_data);
              }
            }
          } catch (error) {
            console.error('‚ùå X√≥a tin nh·∫Øn th·∫•t b·∫°i:', error);
          }
        }

        
        async updateMessageInStory(messageId, newContent, chatHistory) {
          try {
            const fullHistory = await this.loadChatHistoryFromExtra();
            const msgIndex = fullHistory.findIndex(msg => msg.id === messageId);
            if (msgIndex === -1) {
              console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y tin nh·∫Øn c·∫ßn c·∫≠p nh·∫≠t:', messageId);
              return;
            }
            const msg = fullHistory[msgIndex];
            if (msg.role === 'assistant' || msg.role === 'ai') {
              msg.content = `<content>\n${newContent}\n</content>`;
            } else {
              msg.content = newContent;
            }
            await this.saveChatHistoryToExtra(fullHistory);
            if (msgIndex === fullHistory.length - 1) {
              await this._syncStateWithHistory(fullHistory);
            }
            await this.refreshChatHistoryInStory(fullHistory);
          } catch (error) {
            console.error('‚ùå C·∫≠p nh·∫≠t tin nh·∫Øn th·∫•t b·∫°i:', error);
          }
        }

        
        async refreshChatHistoryInStory(chatHistory = null) {
          try {
            const contentList = document.getElementById('chat-history-content-list');
            if (!contentList) {
              await this.handleChatHistory();
              return;
            }
            if (!chatHistory) {
              chatHistory = await this.loadChatHistoryFromExtra();
            }

            if (!chatHistory || chatHistory.length === 0) {
              contentList.innerHTML =
                '<div style="text-align: center; color: #8b4513; padding: 20px;">T·∫°m kh√¥ng c√≥ l·ªãch s·ª≠ tr√≤ chuy·ªán</div>';
              return;
            }
            const formattedHistory = chatHistory.map((msg, index) => {
              let displayContent = msg.content || '';
              const contentMatch = displayContent.match(/<content>([\s\S]*?)<\/content>/s);
              if (contentMatch) {
                displayContent = contentMatch[1].trim();
              }

              return {
                id: msg.id || `msg_${index}_${Date.now()}`,
                role: msg.role || 'assistant',
                timestamp: msg.timestamp || Date.now() - (chatHistory.length - index) * 1000,
                send_date: msg.timestamp ? new Date(msg.timestamp).toLocaleString('vi-VN') : `Tin nh·∫Øn #${index + 1}`,
                content: displayContent,
                message: msg.content || '',
                variableState: msg.variableState || msg.data || null,
                originalIndex: index,
              };
            });
            const html = this.formatChatHistoryForStory(formattedHistory);
            contentList.innerHTML = html;
            const font = localStorage.getItem('teresen_font') || "'Source Han Serif', 'ÊÄùÊ∫êÂÆã‰Ωì', serif";
            const size = localStorage.getItem('teresen_font_size') || '1';

            const messageContents = contentList.querySelectorAll('.message-content');
            messageContents.forEach(el => {
              el.style.fontFamily = font;
              el.style.fontSize = size + 'em';
            });
            this.currentChatHistory = formattedHistory;
            this.bindChatHistoryActions(contentList);
          } catch (error) {
            console.error('‚ùå L√†m m·ªõi hi·ªÉn th·ªã l·ªãch s·ª≠ tr√≤ chuy·ªán th·∫•t b·∫°i:', error);
          }
        }

        
        async handleDeleteMessage(messageId, chatHistory, modal) {
          try {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a tin nh·∫Øn n√†y kh√¥ng?')) {
              return;
            }
            const fullHistory = await this.loadChatHistoryFromExtra();
            const updatedHistory = fullHistory.filter(msg => msg.id !== messageId);
            await this._syncStateWithHistory(updatedHistory);
            const newHistory = await this.loadChatHistoryFromExtra();
            if (newHistory && newHistory.length > 0) {
              const formattedHistory = newHistory.map((msg, index) => {
                let displayContent = msg.content || '';
                const contentMatch = displayContent.match(/<content>(.*?)<\/content>/s);
                if (contentMatch) {
                  displayContent = contentMatch[1].trim();
                }

                return {
                  id: msg.id || `msg_${index}_${Date.now()}`,
                  type: msg.role === 'user' ? 'user' : 'ai',
                  timestamp: msg.timestamp || Date.now() - (newHistory.length - index) * 1000,
                  send_date: msg.timestamp ? new Date(msg.timestamp).toLocaleString('vi-VN') : `Tin nh·∫Øn #${index + 1}`,
                  content: displayContent,
                  message: msg.content || '',
                  data: msg.variableState || msg.data || null,
                  originalIndex: index,
                };
              });
              const contentArea = modal.querySelector('#chat-history-content');
              if (contentArea) {
                contentArea.innerHTML = this.formatChatHistory(formattedHistory);
                setTimeout(() => {
                  contentArea.scrollTo({ top: contentArea.scrollHeight, behavior: 'smooth' });
                }, 100);
              }
              const lastMessage = newHistory[newHistory.length - 1];
              if (lastMessage && lastMessage.variableState) {
                this.currentMvuState = JSON.parse(JSON.stringify(lastMessage.variableState));
                if (lastMessage.variableState.stat_data) {
                  this.renderUI(lastMessage.variableState.stat_data);
                }
              }
            } else {
              modal.remove();
              await this.showCustomAlert('ƒê√£ x√≥a t·∫•t c·∫£ tin nh·∫Øn');
            }

            console.log('‚úÖ Tin nh·∫Øn ƒë√£ b·ªã x√≥a, tr·∫°ng th√°i bi·∫øn ƒë√£ ƒë∆∞·ª£c ƒë·ªìng b·ªô');
          } catch (error) {
            console.error('‚ùå X√≥a tin nh·∫Øn th·∫•t b·∫°i:', error);
            await this.showCustomAlert('X√≥a tin nh·∫Øn th·∫•t b·∫°i: ' + error.message);
          }
        }

        
        async updateMessageInHistory(messageId, newContent, chatHistory, modal) {
          try {
            const fullHistory = await this.loadChatHistoryFromExtra();
            const messageIndex = fullHistory.findIndex(msg => msg.id === messageId);
            if (messageIndex === -1) {
              console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y tin nh·∫Øn c·∫ßn c·∫≠p nh·∫≠t:', messageId);
              return;
            }
            fullHistory[messageIndex].content = newContent.trim();
            if (messageIndex === fullHistory.length - 1) {
              await this._syncStateWithHistory(fullHistory);
            } else {
              await this.saveChatHistoryToExtra(fullHistory, null);
            }
            await this.refreshChatHistoryViewer(modal, chatHistory);
            if (messageIndex === fullHistory.length - 1) {
              const lastMessage = fullHistory[fullHistory.length - 1];
              if (lastMessage && lastMessage.variableState) {
                this.currentMvuState = JSON.parse(JSON.stringify(lastMessage.variableState));
                if (lastMessage.variableState.stat_data) {
                  this.renderUI(lastMessage.variableState.stat_data);
                }
              }
            }

            console.log('‚úÖ Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t');
          } catch (error) {
            console.error('‚ùå C·∫≠p nh·∫≠t tin nh·∫Øn th·∫•t b·∫°i:', error);
            await this.showCustomAlert('C·∫≠p nh·∫≠t tin nh·∫Øn th·∫•t b·∫°i: ' + error.message);
          }
        }

        
        async refreshChatHistoryViewer(modal, originalChatHistory) {
          try {
            const newHistory = await this.loadChatHistoryFromExtra();
            if (!newHistory || newHistory.length === 0) {
              modal.remove();
              await this.showCustomAlert('Kh√¥ng c√≥ l·ªãch s·ª≠ tr√≤ chuy·ªán');
              return;
            }
            const formattedHistory = newHistory.map((msg, index) => {
              let displayContent = msg.content || '';
              const contentMatch = displayContent.match(/<content>(.*?)<\/content>/s);
              if (contentMatch) {
                displayContent = contentMatch[1].trim();
              }

              return {
                id: msg.id || `msg_${index}_${Date.now()}`,
                type: msg.role === 'user' ? 'user' : 'ai',
                timestamp: msg.timestamp || Date.now() - (newHistory.length - index) * 1000,
                send_date: msg.timestamp ? new Date(msg.timestamp).toLocaleString('vi-VN') : `Tin nh·∫Øn #${index + 1}`,
                content: displayContent,
                message: msg.content || '',
                data: msg.variableState || msg.data || null,
                originalIndex: index,
              };
            });
            const contentArea = modal.querySelector('#chat-history-content');
            if (contentArea) {
              contentArea.innerHTML = this.formatChatHistory(formattedHistory);
              setTimeout(() => {
                contentArea.scrollTo({ top: contentArea.scrollHeight, behavior: 'smooth' });
              }, 100);
            }
          } catch (error) {
            console.error('‚ùå L√†m m·ªõi tr√¨nh xem th·∫•t b·∫°i:', error);
          }
        }
        searchChatHistory(searchTerm, contentArea, chatHistory) {
          if (!searchTerm.trim()) {
            contentArea.innerHTML = this.formatChatHistory(chatHistory);
            return;
          }
          const filteredHistory = chatHistory.filter(msg => {
            const content = (msg.content || msg.mes || msg.message || '').toLowerCase();
            return content.includes(searchTerm.toLowerCase());
          });

          if (filteredHistory.length === 0) {
            contentArea.innerHTML = `
              <div style="color: #b0b0b0; text-align: center; padding: 20px;">
                <p>üîç Kh√¥ng t√¨m th·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán ch·ª©a "${searchTerm}"</p>
                <p style="font-size: 0.9em; opacity: 0.7;">Th·ª≠ s·ª≠ d·ª•ng t·ª´ kh√≥a kh√°c ƒë·ªÉ t√¨m ki·∫øm</p>
              </div>
            `;
          } else {
            contentArea.innerHTML =
              `
              <div style="
                text-align: center; 
                color: #a0a0a0; 
                margin-bottom: 20px; 
                padding: 10px;
                background: rgba(255,255,255,0.05);
                border-radius: 4px;
              ">
                üîç T√¨m ki·∫øm "${searchTerm}" t√¨m th·∫•y ${filteredHistory.length} b·∫£n ghi
              </div>
            ` +
              this.formatChatHistory(filteredHistory).replace(
                /üìä Hi·ªÉn th·ªã t·ªïng c·ªông \d+ tin nh·∫Øn l·ªãch s·ª≠ tr√≤ chuy·ªán/,
                `üîç K·∫øt qu·∫£ t√¨m ki·∫øm: ${filteredHistory.length} b·∫£n ghi kh·ªõp`,
              );
          }
        }
        async exportChatHistory(chatHistory) {
          try {
            const gameState = this.getAllVariables();
            const bookName = '- Uma Musume: Chuy·ªán l·∫° Tracen';
            const baseJourneyKey = this._getBaseJourneyKey();
            const baseCoreKey = this._getBaseCoreMemoryKey();
            let journeyContent = '';
            let coreMemoryContent = '';
            try {
              const allEntries = await TavernHelper.getLorebookEntries(bookName);
              const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);
              const coreEntry = allEntries.find(entry => entry.comment === baseCoreKey);
              journeyContent = journeyEntry?.content || '';
              coreMemoryContent = coreEntry?.content || '';
            } catch (e) {
              console.warn('ƒê·ªçc n·ªôi dung S√°ch th·∫ø gi·ªõi th·∫•t b·∫°i:', e);
            }

            const exportData = {
              exportTime: new Date().toLocaleString('zh-CN'),
              gameTitle: 'H·ªçc vi·ªán Tracen: Chuy·ªán l·∫°',
              version: '2.0',
              totalMessages: chatHistory.length,
              gameState: gameState,
              chatHistory: chatHistory.map(msg => ({
                type: msg.is_user || msg.type === 'user' ? 'user' : 'ai',
                time: msg.send_date || (msg.timestamp ? new Date(msg.timestamp).toLocaleString('zh-CN') : ''),
                content: msg.content || msg.mes || msg.message || '',
              })),
              lorebook_content: {
                journey: journeyContent,
                core_memory: coreMemoryContent,
              },
            };

            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `L·ªãch s·ª≠ tr√≤ chuy·ªán_${new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            this.showCustomAlert('‚úÖ Xu·∫•t l·ªãch s·ª≠ tr√≤ chuy·ªán th√†nh c√¥ngÔºÅ');
          } catch (error) {
            console.error('Xu·∫•t l·ªãch s·ª≠ tr√≤ chuy·ªán th·∫•t b·∫°i:', error);
            this.showCustomAlert('‚ùå Xu·∫•t th·∫•t b·∫°i: ' + error.message);
          }
        }
        async showCustomAlert(message) {
          return new Promise(resolve => {
            const alert = document.createElement('div');
            alert.innerHTML = `
              <div style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 15000;
                display: flex;
                align-items: center;
                justify-content: center;
              ">
                <div style="
                  background: linear-gradient(135deg, #2c1810, #3d2817);
                  border: 2px solid #8b4513;
                  border-radius: 12px;
                  padding: 30px;
                  max-width: 400px;
                  text-align: center;
                  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
                ">
                  <p style="
                    color: #e0e0e0;
                    margin: 0 0 20px 0;
                    line-height: 1.6;
                    font-size: 16px;
                  ">${message}</p>
                  <button style="
                    background: linear-gradient(135deg, #8b4513, #a0522d);
                    color: #fff;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    transition: all 0.2s;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
                  ">X√°c nh·∫≠n</button>
                </div>
              </div>
            `;

            document.body.appendChild(alert);

            const btn = alert.querySelector('button');
            btn.addEventListener('click', () => {
              alert.remove();
              resolve();
            });
          });
        }

        handleDangerPeriod() {
          console.log('N√∫t giai ƒëo·∫°n nguy hi·ªÉm ƒë√£ ƒë∆∞·ª£c nh·∫•n');
          const sound = document.getElementById('danger-rules-sound');
          if (sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log('Ph√°t √¢m thanh th·∫•t b·∫°i:', e));
          }

          const e = this.getAllVariables(),
            t = this.getVariable(e, 'stat_data.world.currentTime', '06:00'),
            n = this.getTimeDangerLevel(t),
            s = this.getDangerLevelText(n),
            o = this.getDangerLevelDetails(n),
            a = document.createElement('div');

          ((a.className = 'danger-modal'),
            (a.innerHTML = `\n      <div class="danger-modal-content">\n        <div class="danger-modal-header">\n          <h3>„ÄêH∆∞·ªõng D·∫´n Sinh T·ªìn Theo Khung Gi·ªù C·ªßa Hu·∫•n Luy·ªán Vi√™n„Äë</h3>\n          <span class="danger-modal-close">&times;</span>\n        </div>\n        <div class="danger-modal-body">\n          <div class="danger-current-period">\n            <strong>Khung gi·ªù hi·ªán t·∫°iÔºö${s}</strong>\n          </div>\n          <div class="danger-details-content">\n            ${o}\n          </div>\n        </div>\n      </div>\n    `),
            (() => {
              const overlay = document.getElementById('teresen-fullscreen-overlay');
              if (overlay) {
                overlay.appendChild(a);
              } else {
                document.body.appendChild(a);
              }
            })());

          const l = a.querySelector('.danger-modal-close');

          (l &&
            l.addEventListener('click', () => {
              a.remove();
            }),
            a.addEventListener('click', e => {
              e.target === a && a.remove();
            }));
        }

        debugVariables() {
          console.log('üîç N√∫t g·ª° l·ªói bi·∫øn ƒë√£ ƒë∆∞·ª£c nh·∫•n');

          const e = this.getAllVariables();

          (console.log('üìä T·∫•t c·∫£ d·ªØ li·ªáu bi·∫øn:', e),
            e && e.stat_data
              ? (console.log('‚úÖ T√¨m th·∫•y c·∫•u tr√∫c stat_data'),
                console.log('üèÉ D·ªØ li·ªáu Hu·∫•n luy·ªán vi√™n:', e.stat_data.trainer),
                console.log('üåç D·ªØ li·ªáu Th·∫ø gi·ªõi:', e.stat_data.world),
                console.log('üêé D·ªØ li·ªáu Uma Musume:', e.stat_data.umaMusume),
                e.stat_data.umaMusume &&
                  (console.log('üîç Chi ti·∫øt d·ªØ li·ªáu Uma Musume:'),
                  Object.keys(e.stat_data.umaMusume).forEach(t => {
                    const n = e.stat_data.umaMusume[t];

                    (console.log(`üêé ${t}:`, n),
                      n.affection && console.log(`  üíñ ${t} ƒê·ªô thi·ªán c·∫£m:`, n.affection),
                      n.possessiveness && console.log(`  üî• ${t} ƒê·ªô chi·∫øm h·ªØu:`, n.possessiveness),
                      n.status && console.log(`  üìä ${t} Tr·∫°ng th√°i:`, n.status));
                  })),
                e.stat_data.rules && console.log('üìú D·ªØ li·ªáu Quy t·∫Øc:', e.stat_data.rules))
              : (console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y c·∫•u tr√∫c stat_data'), console.log('üîç K·∫øt qu·∫£ tr·∫£ v·ªÅ ƒë·∫ßy ƒë·ªß:', e)),
            console.log('üéÆ Tr·∫°ng th√°i giao di·ªán hi·ªán t·∫°i:'),
            console.log('  - Container Uma Musume:', document.getElementById('uma-status')),
            console.log('  - Hi·ªÉn th·ªã th·ªùi gian:', document.getElementById('current-time')),
            console.log('  - Tr·∫°ng th√°i Hu·∫•n luy·ªán vi√™n:', document.getElementById('trainer-status')));
        }

        async handleActionSubmit() {
          const e = document.getElementById('action-input');

          if (!e || !e.value.trim()) return;

          const userMessage = e.value.trim();

          console.log('üéØ G·ª≠i h√†nh ƒë·ªông:', userMessage);
          try {
            const clearAllBtn = document.querySelector('.clear-all-btn');
            if (clearAllBtn) {
              clearAllBtn.click();
            } else {
              if (typeof clearAllActions === 'function' && typeof updateCommandList === 'function') {
                clearAllActions();
                updateCommandList();
              }
            }
          } catch (err) {
            console.warn('X√≥a ch·ªâ th·ªã th·∫•t b·∫°i:', err);
          }
          const actionContainer = document.getElementById('action-options-container');
          if (actionContainer) {
            actionContainer.style.display = 'none';
          }
          const sendBtn = document.getElementById('btn-send-action');
          const originalText = sendBtn ? sendBtn.textContent : 'G·ª≠i';
          if (sendBtn) {
            sendBtn.textContent = 'ƒêang t·∫°o';
            sendBtn.disabled = true;
          }
          if (this.isAutoSaveEnabled) {
            await this.createPendingAutoSave();
          }

          try {

            let commandText = '';

            if (window.pendingActions && window.pendingActions.length > 0) {
              commandText += '[Ch·ªâ th·ªã h√†nh ƒë·ªông c·ªßa Hu·∫•n luy·ªán vi√™n]\n';
              commandText += 'Hu·∫•n luy·ªán vi√™n trong l∆∞·ª£t n√†y x√°c nh·∫≠n mu·ªën th·ª±c hi·ªán c√°c h√†nh ƒë·ªông sau, vui l√≤ng m√¥ t·∫£ chi ti·∫øt qu√° tr√¨nh v√† k·∫øt qu·∫£ c·ªßa c√°c h√†nh ƒë·ªông n√†y trong ph·∫£n h·ªìi:\n\n';

              window.pendingActions.forEach((cmd, index) => {
                let requestText = '';
                switch (cmd.action) {
                  case 'use':
                    const useDesc = cmd.itemData?.description || 'Kh√¥ng m√¥ t·∫£';
                    const useEffect = cmd.itemData?.effect || 'Kh√¥ng c√≥ m√¥ t·∫£ hi·ªáu qu·∫£';
                    requestText = `<Request: S·ª≠ d·ª•ng ƒë·∫°o c·ª•${cmd.itemName}ÔºåM√¥ t·∫£:${useDesc}ÔºåHi·ªáu qu·∫£:${useEffect}>`;
                    break;
                  case 'discard':
                    const discardDesc = cmd.itemData?.description || 'Kh√¥ng m√¥ t·∫£';
                    requestText = `<Request: V·ª©t b·ªè ƒë·∫°o c·ª•${cmd.itemName}ÔºåM√¥ t·∫£:${discardDesc}>`;
                    break;
                  case 'gift':
                    const giftDesc = cmd.itemData?.description || 'Kh√¥ng m√¥ t·∫£';
                    const giftEffect = cmd.itemData?.effect || 'Kh√¥ng c√≥ m√¥ t·∫£ hi·ªáu qu·∫£';
                    requestText = `<Request: T·∫∑ng ƒë·∫°o c·ª•${cmd.itemName} cho${cmd.characterName || cmd.target}ÔºåM√¥ t·∫£:${giftDesc}ÔºåHi·ªáu qu·∫£:${giftEffect}>`;
                    break;
                  case 'move':
                    const moveDesc = cmd.description || 'Kh√¥ng c√≥ m√¥ t·∫£ chi ti·∫øt';
                    requestText = `<Request: ƒêi ƒë·∫øn${cmd.itemName}ÔºåM√¥ t·∫£:${moveDesc}>`;
                    break;
                  case 'lock':
                    requestText = `<Request: Kh√≥a ƒë·∫°o c·ª•${cmd.itemName}>`;
                    break;
                  case 'skill':
                    const skillInfo = cmd.skillType || 'K·ªπ nƒÉng kh√¥ng x√°c ƒë·ªãnh';
                    const targetInfo = cmd.target === 'self' ? 'l√™n b·∫£n th√¢n' : cmd.characterName || 'l√™n m·ª•c ti√™u';
                    requestText = `<Request: S·ª≠ d·ª•ng k·ªπ nƒÉng${skillInfo}${targetInfo}>`;
                    break;
                  case 'meal':
                    requestText = `<Request: ƒÇn th√™m${cmd.characterName ? ` c√πng ${cmd.characterName}` : ''}>`;
                    break;
                  case 'borrow':
                    requestText = `<Request: M∆∞·ª£n ti·ªÅn${cmd.characterName ? ` t·ª´ ${cmd.characterName}` : ''}>`;
                    break;
                  case 'game':
                    requestText = `<Request: Ch∆°i game${cmd.characterName ? ` c√πng ${cmd.characterName}` : ''}>`;
                    break;
                  case 'chat':
                    requestText = `<Request: Tr√≤ chuy·ªán${cmd.characterName ? ` v·ªõi ${cmd.characterName}` : ''}>`;
                    break;
                  case 'rest':
                    requestText = `<Request: Ngh·ªâ ng∆°i ƒë·∫øn tu·∫ßn sau>`;
                    break;
                  default:
                    requestText = `<Request: Th·ª±c hi·ªán thao t√°c${cmd.action}${cmd.itemName ? `Ôºåƒê·∫°o c·ª•:${cmd.itemName}` : ''}>`;
                }

                commandText += `- ${requestText}\n`;
              });

              commandText += '\n';

              console.log('üìã VƒÉn b·∫£n ch·ªâ th·ªã ƒë√£ ƒë∆∞·ª£c t·∫°o, t·ªïng', window.pendingActions.length, 'ch·ªâ th·ªã:');
              console.log(commandText);
            } else {
              console.log('üìã Kh√¥ng c√≥ ch·ªâ th·ªã ch·ªù th·ª±c hi·ªán');
            }
            let dynamicContext = '';
            try {
              dynamicContext = await this._assembleDynamicContext(userMessage);
              if (dynamicContext) {
                console.log('üìñ ƒê√£ ƒë·ªçc k√Ω ·ª©c t·ª´ S√°ch th·∫ø gi·ªõi');
              }
            } catch (e) {
              console.error('‚ùå ƒê·ªçc k√Ω ·ª©c th·∫•t b·∫°i:', e);
            }

            let combinedContent = '';
            if (dynamicContext) {
              combinedContent += `[Ghi nh·ªõ k√Ω ·ª©c]\n${dynamicContext}\n\n`;
            }

            if (commandText) {
              combinedContent += commandText;
              console.log('‚úÖ Ch·ªâ th·ªã ƒë√£ th√™m v√†o combinedContent, ƒë·ªô d√†i:', commandText.length);
            } else {
              console.log('‚ö†Ô∏è Kh√¥ng c√≥ vƒÉn b·∫£n ch·ªâ th·ªã');
            }

            if (userMessage) {
              combinedContent += `<userinput>\n${userMessage}\n</userinput>`;
            }

            if (!combinedContent) {
              console.warn('‚ö†Ô∏è Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ g·ª≠i');

              return;
            }

            console.log('üì§ N·ªôi dung ƒë·∫ßy ƒë·ªß chu·∫©n b·ªã g·ª≠i:', combinedContent);
            this.lastUserInput = combinedContent;
            this.lastSentPrompt = combinedContent; 
            let chatHistory = await this.loadChatHistoryFromExtra();
            console.log(`üìã [handleActionSubmit] T·∫£i tin nh·∫Øn l·ªãch s·ª≠: ${chatHistory.length} tin nh·∫Øn`);
            const totalMessages = chatHistory.length + 1; 
            const injects = [];
            chatHistory.forEach((msg, index) => {
              const depth = totalMessages - index;
              let content = msg.content || '';
              if (typeof formatAsTavernRegexedString === 'function') {
                try {
                  const msgType = msg.role === 'user' ? 'user_input' : 'ai_output';
                  content = formatAsTavernRegexedString(content, msgType, 'prompt', { depth: depth });
                } catch (e) {
                  console.warn('‚ö†Ô∏è formatAsTavernRegexedString th·∫•t b·∫°i, s·ª≠ d·ª•ng n·ªôi dung g·ªëc:', e);
                }
              }

              injects.push({
                role: msg.role,
                content: content,
                position: 'in_chat',
                depth: depth,
                should_scan: true,
              });
            });
            let currentUserContent = combinedContent;
            if (typeof formatAsTavernRegexedString === 'function') {
              try {
                currentUserContent = formatAsTavernRegexedString(combinedContent, 'user_input', 'prompt', { depth: 1 });
              } catch (e) {
                console.warn('‚ö†Ô∏è formatAsTavernRegexedString th·∫•t b·∫°i, s·ª≠ d·ª•ng n·ªôi dung g·ªëc:', e);
              }
            }

            injects.push({
              role: 'user',
              content: currentUserContent,
              position: 'in_chat',
              depth: 1, 
              should_scan: true,
            });

            console.log(`üì§ Chu·∫©n b·ªã g·ª≠i ${injects.length} tin nh·∫Øn cho AI (L·ªãch s·ª≠: ${chatHistory.length}, Hi·ªán t·∫°i: 1)`);
            if ('undefined' != typeof TavernHelper && TavernHelper.generate) {
              const generateConfig = {
                injects: injects, 
                max_chat_history: 0, 
                should_stream: true,
              };

              try {
                console.log('üöÄ B·∫Øt ƒë·∫ßu t·∫°o lu·ªìng...');

                const aiResponse = await TavernHelper.generate(generateConfig);

                console.log('‚úÖ AI ho√†n t·∫•t t·∫°o:', aiResponse);
                try {
                  console.log(`üìã [handleActionSubmit] S·ª≠ d·ª•ng l·ªãch s·ª≠ ƒë√£ t·∫£i: ${chatHistory.length} tin nh·∫Øn`);
                  let currentVariables = {};
                  try {
                    if (typeof getVariables === 'function') {
                      currentVariables = JSON.parse(JSON.stringify(getVariables({ type: 'message' }) || {}));
                    } else {
                      const lastMsg = chatHistory.length > 0 ? chatHistory[chatHistory.length - 1] : null;
                      currentVariables = lastMsg?.variableState || this.currentMvuState || this.getAllVariables() || {};
                    }
                  } catch (error) {
                    console.warn('‚ö†Ô∏è L·∫•y tr·∫°ng th√°i bi·∫øn th·∫•t b·∫°i, s·ª≠ d·ª•ng ph∆∞∆°ng √°n d·ª± ph√≤ng:', error);
                    currentVariables = this.currentMvuState || this.getAllVariables() || {};
                  }
                  const variableResult = await this._processVariables(aiResponse, currentVariables);
                  const updatedVariables = variableResult.updatedVariables;
                  const variableSnapshot = variableResult.snapshot;
                  const userMessageObj = {
                    role: 'user',
                    content: userMessage,
                    id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    timestamp: Date.now(),
                    variableState: JSON.parse(JSON.stringify(currentVariables)), 
                  };
                  chatHistory.push(userMessageObj);
                  console.log(`üìã [handleActionSubmit] Sau khi th√™m tin nh·∫Øn ng∆∞·ªùi d√πng, ƒë·ªô d√†i l·ªãch s·ª≠: ${chatHistory.length}`);
                  const assistantMessageObj = {
                    role: 'assistant',
                    content: aiResponse,
                    id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    timestamp: Date.now(),
                    variableState: variableSnapshot, 
                  };
                  chatHistory.push(assistantMessageObj);
                  console.log(`üìã [handleActionSubmit] Sau khi th√™m tin nh·∫Øn AI, ƒë·ªô d√†i l·ªãch s·ª≠: ${chatHistory.length}`);
                  await this.saveChatHistoryToExtra(chatHistory, updatedVariables);
                  const verifyHistory = await this.loadChatHistoryFromExtra();
                  console.log(`üìã [handleActionSubmit] X√°c minh sau khi l∆∞u, ƒë·ªô d√†i l·ªãch s·ª≠: ${verifyHistory.length} tin nh·∫Øn`);
                  if (verifyHistory.length !== chatHistory.length) {
                    console.error(
                      `‚ùå [handleActionSubmit] X√°c minh l∆∞u th·∫•t b·∫°i! Mong ƒë·ª£i ${chatHistory.length} tin nh·∫Øn, th·ª±c t·∫ø ${verifyHistory.length} tin nh·∫Øn`,
                    );
                  } else {
                    console.log('‚úÖ ƒê·∫ßu v√†o ng∆∞·ªùi d√πng v√† ph·∫£n h·ªìi AI ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o extra.teresen_chat');
                  }
                  console.log('üìù Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o extra.teresen_chat, kh√¥ng c·∫≠p nh·∫≠t tin nh·∫Øn t·∫ßng 0 (ph∆∞∆°ng √°n t√°ch bi·ªát ho√†n to√†n kh·ªèi t·∫ßng 0)');
                  if (updatedVariables) {
                    this.currentMvuState = updatedVariables;
                    if (updatedVariables.stat_data) {
                      this.renderUI(updatedVariables.stat_data);
                    }
                    console.log('‚úÖ Tr·∫°ng th√°i bi·∫øn ƒë√£ c·∫≠p nh·∫≠t v√† l∆∞u v√†o extra.teresen_chat');
                  }
                } catch (saveError) {
                  console.error('‚ùå L∆∞u v√†o extra.teresen_chat th·∫•t b·∫°i:', saveError);
                  console.error('‚ùå L∆∞u th·∫•t b·∫°i, nh∆∞ng s·∫Ω kh√¥ng quay l·∫°i tin nh·∫Øn t·∫ßng 0 (ph∆∞∆°ng √°n t√°ch bi·ªát ho√†n to√†n kh·ªèi t·∫ßng 0)');
                  throw saveError; 
                }
                console.log('üìù D·ªØ li·ªáu ƒë√£ l∆∞u v√†o extra.teresen_chat, kh√¥ng c·∫≠p nh·∫≠t tin nh·∫Øn t·∫ßng 0 (ph∆∞∆°ng √°n t√°ch bi·ªát ho√†n to√†n kh·ªèi t·∫ßng 0)');

                this.endReplyTimer();
              } catch (error) {
                console.error('‚ùå AI t·∫°o th·∫•t b·∫°i:', error);

                this.endReplyTimer();
              } finally {
                try {
                  await this.updateDynamicData();
                  console.log('‚úÖ L√†m m·ªõi UI cu·ªëi c√πng ho√†n t·∫•t');
                } catch (finalError) {
                  console.warn('‚ö†Ô∏è L√†m m·ªõi UI cu·ªëi c√πng th·∫•t b·∫°i:', finalError);
                }
                const sendBtn = document.getElementById('btn-send-action');
                if (sendBtn) {
                  sendBtn.textContent = 'G·ª≠i';
                  sendBtn.disabled = false;
                }
              }
            }
          } catch (error) {
            console.error('‚ùå T∆∞∆°ng t√°c th·∫•t b·∫°i:', error);
          } finally {

            await this.updateDynamicData();

            console.log('‚úÖ C·∫≠p nh·∫≠t giao di·ªán cu·ªëi c√πng ho√†n t·∫•t (tham kh·∫£o ch·∫ø ƒë·ªô d·ª± √°n)');
            const sendBtn = document.getElementById('btn-send-action');
            if (sendBtn) {
              sendBtn.textContent = 'G·ª≠i';
              sendBtn.disabled = false;
            }
          }

          e.value = '';
        }

        setupRulesModal() {
          ($('#view-rules-btn').on('click', () => {
            console.log('üéØ N√∫t xem quy t·∫Øc ƒë√£ ƒë∆∞·ª£c nh·∫•n!');

            const e = document.getElementById('rules-modal'),
              t = document.getElementById('danger-rules-sound');
            e && t
              ? (console.log('‚úÖ Hi·ªÉn th·ªã modal quy t·∫Øc'),
                t.play().catch(e => console.log('Ph√°t √¢m thanh th·∫•t b·∫°i:', e)),
                (() => {
                  const overlay = document.getElementById('teresen-fullscreen-overlay');
                  if (overlay && e.parentNode !== overlay) {
                    e.dataset.originalParent = e.parentNode?.tagName || 'BODY';
                    overlay.appendChild(e);
                    console.log('‚úÖ rules-modal ƒë√£ di chuy·ªÉn v√†o b√™n trong l·ªõp ph·ªß');
                  }
                })(),
                (e.style.display = 'flex'),
                this.updateRulesModal())
              : console.error('‚ùå Kh√¥ng t√¨m th·∫•y modal ho·∫∑c ph·∫ßn t·ª≠ √¢m thanh');
          }),
            $('#close-rules-btn').on('click', () => {
              $('#rules-modal').hide();
            }),
            $('#rules-modal').on('click', e => {
              e.target === e.currentTarget && $('#rules-modal').hide();
            }),
            this.setupMusicControls(),
            $('#add-rule-btn')
              .off('click')
              .on('click', () => {
                this.addRule();
              }),
            $('#clear-rules-btn')
              .off('click')
              .on('click', () => {
                this.clearAllRules();
              }));
        }

        setupSettingsModal() {
        }
        loadProfileAvatar() {
          const savedAvatar = localStorage.getItem('teresen_profile_avatar');
          const avatarImg = document.getElementById('profile-avatar');
          if (avatarImg) {
            if (savedAvatar) {
              avatarImg.src = savedAvatar;
            } else {
              avatarImg.src = 'https://i.ibb.co/0VzNGcfs/116.gif';
              localStorage.setItem('teresen_profile_avatar', 'https://i.ibb.co/0VzNGcfs/116.gif');
            }
          }
        }
        showAvatarSelector() {
          const existing = document.getElementById('avatar-selector-modal');
          if (existing) {
            existing.remove();
          }

          const modal = document.createElement('div');
          modal.id = 'avatar-selector-modal';
          modal.className = 'rules-modal';
          modal.style.display = 'flex';

          const avatarIcons = [
            'https://i.ibb.co/MyDhdy9p/117.gif',
            'https://i.ibb.co/0VzNGcfs/116.gif',
            'https://i.ibb.co/4Zc012Ky/115.gif',
            'https://i.ibb.co/6JgDbTFf/114.gif',
            'https://i.ibb.co/M3H5Qkv/112.gif',
            'https://i.ibb.co/GQpSM0V2/111.gif',
            'https://i.ibb.co/qLnLxgtd/110.gif',
            'https://i.ibb.co/Ndxt9GLW/109.gif',
            'https://i.ibb.co/zTnj7rc5/108.gif',
            'https://i.ibb.co/gbbSkX6r/107.gif',
            'https://i.ibb.co/S7McVksQ/105.gif',
            'https://i.ibb.co/spqVTM4p/104.gif',
            'https://i.ibb.co/xq6SYWR3/103.gif',
            'https://i.ibb.co/216dQLz1/102.gif',
            'https://i.ibb.co/MkRMKY1L/101.png',
            'https://i.ibb.co/CpdK60fz/100.png',
            'https://i.ibb.co/Y4NqXtkb/99.gif',
            'https://i.ibb.co/qMLCbGLH/98.gif',
            'https://i.ibb.co/sJ3Z0HMS/97.gif',
            'https://i.ibb.co/DDg778RC/96.gif',
            'https://i.ibb.co/8Drbgt9G/95.gif',
            'https://i.ibb.co/tM3kwyFy/94.gif',
            'https://i.ibb.co/XxywhDwC/93.gif',
            'https://i.ibb.co/fdrXcQSy/92.gif',
            'https://i.ibb.co/d44fqZKp/91.gif',
            'https://i.ibb.co/whVJD4YX/90.gif',
            'https://i.ibb.co/qbFsGr1/89.gif',
            'https://i.ibb.co/7tmgJfG6/88.gif',
            'https://i.ibb.co/ZzcDgPPb/87.gif',
            'https://i.ibb.co/8L3GVTV9/86.gif',
            'https://i.ibb.co/1JvsPL1R/85.gif',
            'https://i.ibb.co/HTWTRKpF/84.gif',
            'https://i.ibb.co/9HtCCTY2/83.gif',
            'https://i.ibb.co/tMdg1T6w/82.gif',
            'https://i.ibb.co/5hN95Bqv/81.gif',
            'https://i.ibb.co/Qjb64H64/80.gif',
            'https://i.ibb.co/Nh2GRds/79.gif',
            'https://i.ibb.co/bjspDw6m/78.gif',
            'https://i.ibb.co/9HfLCRSC/77.gif',
            'https://i.ibb.co/gphxHCg/76.gif',
            'https://i.ibb.co/qY2xnKr8/75.png',
            'https://i.ibb.co/gMbfw31M/74.png',
            'https://i.ibb.co/fV6KZzW1/73.png',
            'https://i.ibb.co/hx6ybYb1/72.png',
            'https://i.ibb.co/0ySpFbqk/71.png',
            'https://i.ibb.co/7x8Z012R/70.png',
            'https://i.ibb.co/4Zrc3wYd/69.png',
            'https://i.ibb.co/d0cCP8hm/68.png',
            'https://i.ibb.co/vg2GWNF/67.png',
            'https://i.ibb.co/D0kRstQ/66.png',
            'https://i.ibb.co/bMQSpQ8J/65.png',
            'https://i.ibb.co/C38QsTSd/64.jpg',
            'https://i.ibb.co/V0Rwg8SZ/63.png',
            'https://i.ibb.co/S4SLdwPn/62.png',
            'https://i.ibb.co/SDx7NRwm/61.png',
            'https://i.ibb.co/S4KhX8CJ/60.png',
            'https://i.ibb.co/prnzCdHz/59.png',
            'https://i.ibb.co/7JZQ5prg/58.png',
            'https://i.ibb.co/TDkKhmzQ/57.png',
            'https://i.ibb.co/fYk5MZFh/56.png',
            'https://i.ibb.co/ksvdqCkF/55.png',
            'https://i.ibb.co/n84b3ffK/54.png',
            'https://i.ibb.co/C4kbzPZ/53.png',
            'https://i.ibb.co/39XsKJj9/52.png',
            'https://i.ibb.co/d45P2KV1/51.png',
            'https://i.ibb.co/chYdSpCJ/50.png',
            'https://i.ibb.co/FbZNZwFT/49.png',
            'https://i.ibb.co/SwDBmhZ4/48.png',
            'https://i.ibb.co/v4mQyNwh/47.png',
            'https://i.ibb.co/3mZJLMCm/46.png',
            'https://i.ibb.co/cS0j0H80/45.png',
            'https://i.ibb.co/pv7Xt59p/44.png',
            'https://i.ibb.co/938Nhjsb/43.png',
            'https://i.ibb.co/Qv2NgmQB/42.png',
            'https://i.ibb.co/k2Ym0b0J/41.png',
            'https://i.ibb.co/9HP1wRSY/40.png',
            'https://i.ibb.co/VYtKbgMm/39.png',
            'https://i.ibb.co/0pzfJNGC/38.png',
            'https://i.ibb.co/9H9Z6pLP/37.png',
            'https://i.ibb.co/pjSF1YXp/36.png',
            'https://i.ibb.co/s9v22tXb/35.png',
            'https://i.ibb.co/rKPszvrq/34.png',
            'https://i.ibb.co/qGGR8Hf/33.png',
            'https://i.ibb.co/M08FLv3/32.png',
            'https://i.ibb.co/rfdJN1XH/31.png',
            'https://i.ibb.co/fYt6gcbN/30.png',
            'https://i.ibb.co/JRvsWH6k/29.png',
            'https://i.ibb.co/XrXZgQhz/28.png',
            'https://i.ibb.co/RTkhvgM1/27.png',
            'https://i.ibb.co/8LjV2b2S/26.png',
            'https://i.ibb.co/Fk238vRf/25.png',
            'https://i.ibb.co/rKKR5hsF/24.png',
            'https://i.ibb.co/9kgxsKQm/23.png',
            'https://i.ibb.co/MkxLXxnV/22.png',
            'https://i.ibb.co/5g04Jz2R/21.png',
            'https://i.ibb.co/MyctrsYt/20.png',
            'https://i.ibb.co/svw4FzXt/19.png',
            'https://i.ibb.co/HD9V68R6/18.png',
            'https://i.ibb.co/Q3mknYLx/17.png',
            'https://i.ibb.co/0RRBCmVM/16.png',
            'https://i.ibb.co/gFmszgrf/15.png',
            'https://i.ibb.co/WW9Dyk6S/14.png',
            'https://i.ibb.co/svXZ2rHd/13.png',
            'https://i.ibb.co/21GdZ3wz/12.png',
            'https://i.ibb.co/WNpm09fR/11.png',
            'https://i.ibb.co/zTjtw2nf/10.png',
            'https://i.ibb.co/5gKVSwHV/9.png',
            'https://i.ibb.co/whqMPcc8/8.png',
            'https://i.ibb.co/RpRpbjQp/7.png',
            'https://i.ibb.co/HTj9n8S6/6.png',
            'https://i.ibb.co/Sjvb0wx/5.png',
            'https://i.ibb.co/Kz3KSfz8/4.png',
            'https://i.ibb.co/S4qfvH4C/3.png',
            'https://i.ibb.co/HDHYW6Pr/2.png',
            'https://i.ibb.co/HLJGzVQt/1.jpg',
          ];

          const avatarImg = document.getElementById('profile-avatar');
          const currentAvatar = avatarImg
            ? localStorage.getItem('teresen_profile_avatar') || avatarImg.src || 'https://i.ibb.co/0VzNGcfs/116.gif'
            : 'https://i.ibb.co/0VzNGcfs/116.gif';

          modal.innerHTML = `
            <div class="rules-modal-content" style="
              background: linear-gradient(135deg, #f5f0e8, #ede4d3);
              border: 2px solid #d4af37;
              border-radius: 12px;
              width: 90%;
              max-width: 800px;
              max-height: 85vh;
              box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
              display: flex;
              flex-direction: column;
            ">
              <div class="rules-modal-header" style="
                padding: 20px;
                border-bottom: 1px solid #d4af37;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: linear-gradient(135deg, #f0e6d2, #e8dcc6);
              ">
                <h3 style="
                  color: #8b4513;
                  margin: 0;
                  font-size: 18px;
                  font-weight: bold;
                ">Ch·ªçn Avatar</h3>
                <button id="avatar-selector-close-btn" style="
                  background: none;
                  border: none;
                  color: #8b4513;
                  font-size: 24px;
                  cursor: pointer;
                  padding: 5px;
                  border-radius: 4px;
                  transition: background 0.2s;
                ">&times;</button>
              </div>
              <div class="rules-modal-body" style="
                padding: 20px;
                flex: 1;
                overflow-y: auto;
              ">
                <div id="avatar-grid" style="
                  display: grid;
                  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                  gap: 15px;
                "></div>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
          this.ensureModalInOverlay(modal);
          const grid = modal.querySelector('#avatar-grid');
          avatarIcons.forEach(url => {
            const avatarItem = document.createElement('div');
            const currentAvatarUrl = currentAvatar.replace(/^https?:\/\/[^\/]+/, '').replace(/^\/+/, '');
            const compareUrl = url.replace(/^https?:\/\/[^\/]+/, '').replace(/^\/+/, '');
            const isSelected =
              url === currentAvatar || currentAvatarUrl === compareUrl || currentAvatar.includes(url.split('/').pop());

            avatarItem.style.cssText = `
              position: relative;
              aspect-ratio: 1;
              border: 3px solid ${isSelected ? 'rgba(139, 105, 20, 0.8)' : 'rgba(139, 105, 20, 0.3)'};
              border-radius: 8px;
              overflow: hidden;
              cursor: pointer;
              transition: all 0.2s;
              background: rgba(139, 105, 20, 0.05);
              ${isSelected ? 'transform: scale(1.05); box-shadow: 0 4px 8px rgba(139, 105, 20, 0.4);' : ''}
            `;

            const img = document.createElement('img');
            img.src = url;
            img.style.cssText = `
              width: 100%;
              height: 100%;
              object-fit: cover;
              display: block;
            `;
            img.onerror = () => {
              avatarItem.style.display = 'none';
            };

            avatarItem.appendChild(img);

            let itemIsSelected = isSelected;

            avatarItem.addEventListener('click', () => {
              const profileAvatarImg = document.getElementById('profile-avatar');
              if (profileAvatarImg) {
                profileAvatarImg.src = url;
              }
              localStorage.setItem('teresen_profile_avatar', url);
              modal.remove();
            });

            avatarItem.addEventListener('mouseenter', () => {
              if (!itemIsSelected) {
                avatarItem.style.borderColor = 'rgba(139, 105, 20, 0.5)';
              }
            });

            avatarItem.addEventListener('mouseleave', () => {
              if (!itemIsSelected) {
                avatarItem.style.borderColor = 'rgba(139, 105, 20, 0.3)';
              }
            });

            grid.appendChild(avatarItem);
          });
          const closeBtn = modal.querySelector('#avatar-selector-close-btn');
          closeBtn.addEventListener('click', () => {
            modal.remove();
          });
          modal.addEventListener('click', e => {
            if (e.target === modal) {
              modal.remove();
            }
          });
        }

        async applySettings() {
          const selectedFont =
            $('.font-option-btn.selected').data('font') ||
            $('.font-option-btn').first().data('font') ||
            "'Source Han Serif', 'ÊÄùÊ∫êÂÆã‰Ωì', serif";
          const selectedSize =
            $('.font-size-btn.selected').data('size') || $('.font-size-btn[data-size="1"]').data('size') || '1';
          const selectedBgType =
            $('.bg-option-btn.selected').data('bg-type') ||
            $('.bg-option-btn[data-bg-type="black"]').data('bg-type') ||
            'black';
          let bgImage = '';
          if (selectedBgType === 'image') {
            bgImage = $('#bg-preview-img').attr('src') || $('#bg-image-url').val() || '';
          }
          localStorage.setItem('teresen_font_family', selectedFont);
          localStorage.setItem('teresen_font_size', selectedSize);
          localStorage.setItem('teresen_fullscreen_background_type', selectedBgType);
          if (bgImage) {
            if (bgImage.startsWith('data:')) {
              console.warn('‚ö†Ô∏è Ph√°t hi·ªán d·ªØ li·ªáu ·∫£nh base64, khuy√™n d√πng URL ·∫£nh');
              const base64Data = bgImage.split(',')[1] || '';
              if (base64Data.length > 100000) {
                alert(
                  'D·ªØ li·ªáu ·∫£nh qu√° l·ªõn! Vui l√≤ng d√πng URL ·∫£nh thay v√¨ t·∫£i l√™n t·ªáp.\n\nG·ª£i √Ω: C√≥ th·ªÉ t·∫£i ·∫£nh l√™n host ·∫£nh (nh∆∞ imgur, sm.ms, v.v.), sau ƒë√≥ d√πng URL ·∫£nh.',
                );
                localStorage.removeItem('teresen_fullscreen_background_image');
              } else {
                try {
                  localStorage.setItem('teresen_fullscreen_background_image', bgImage);
                } catch (error) {
                  console.error('‚ùå L∆∞u tr·ªØ ·∫£nh n·ªÅn th·∫•t b·∫°i:', error);
                  alert('D·ªØ li·ªáu ·∫£nh qu√° l·ªõn, kh√¥ng th·ªÉ l∆∞u tr·ªØ! Vui l√≤ng d√πng URL ·∫£nh.');
                  localStorage.removeItem('teresen_fullscreen_background_image');
                }
              }
            } else {
              localStorage.setItem('teresen_fullscreen_background_image', bgImage);
            }
          } else {
            localStorage.removeItem('teresen_fullscreen_background_image');
          }
          const autoFullscreenCheckbox = document.getElementById('auto-fullscreen-checkbox');
          if (autoFullscreenCheckbox) {
            localStorage.setItem('teresen_auto_fullscreen', autoFullscreenCheckbox.checked ? 'true' : 'false');
          }
          const enterToSendCheckbox = document.getElementById('enter-to-send-checkbox');
          if (enterToSendCheckbox) {
            if (enterToSendCheckbox.checked) {
              localStorage.setItem('teresen_enter_to_send', 'true');
            } else {
              localStorage.removeItem('teresen_enter_to_send'); 
            }
            this.setupEnterToSend(); 
          }
          $('.story-text').css({
            'font-family': selectedFont,
            'font-size': selectedSize + 'em',
          });

          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay) {
            if (selectedBgType === 'black') {
              overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
              overlay.style.backgroundImage = 'none';
            } else if (selectedBgType === 'image' && bgImage) {
              overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
              overlay.style.backgroundImage = `url("${bgImage}")`;
              overlay.style.backgroundSize = 'cover';
              overlay.style.backgroundPosition = 'center';
              overlay.style.backgroundRepeat = 'no-repeat';
            }
          }

          console.log('‚úÖ ƒê√£ √°p d·ª•ng c√†i ƒë·∫∑t');
        }

        restoreSettingsToUI() {
          const fontFamily = localStorage.getItem('teresen_font_family') || "'Source Han Serif', 'ÊÄùÊ∫êÂÆã‰Ωì', serif";
          const fontSize = localStorage.getItem('teresen_font_size') || '1';
          const bgType = localStorage.getItem('teresen_fullscreen_background_type') || 'black';
          const bgImage = localStorage.getItem('teresen_fullscreen_background_image') || '';
          const autoFullscreen = localStorage.getItem('teresen_auto_fullscreen') !== 'false'; 
          const autoFullscreenCheckbox = document.getElementById('auto-fullscreen-checkbox');
          if (autoFullscreenCheckbox) {
            autoFullscreenCheckbox.checked = autoFullscreen;
          }
          const enterToSend = localStorage.getItem('teresen_enter_to_send') === 'true'; 
          const enterToSendCheckbox = document.getElementById('enter-to-send-checkbox');
          if (enterToSendCheckbox) {
            enterToSendCheckbox.checked = enterToSend;
          }
          $('.font-option-btn').removeClass('selected').css({
            background: 'rgba(139, 105, 20, 0.05)',
            'border-color': 'rgba(139, 105, 20, 0.3)',
          });
          const fontBtn = $(`.font-option-btn[data-font="${fontFamily}"]`).first();
          if (fontBtn.length) {
            fontBtn.addClass('selected').css({
              background: 'rgba(139, 105, 20, 0.2)',
              'border-color': 'rgba(139, 105, 20, 0.6)',
            });
            $('#font-preview').css('font-family', fontFamily);
          }
          $('.font-size-btn').removeClass('selected').css({
            background: 'rgba(139, 105, 20, 0.05)',
            'border-color': 'rgba(139, 105, 20, 0.3)',
          });
          const sizeBtn = $(`.font-size-btn[data-size="${fontSize}"]`).first();
          if (sizeBtn.length) {
            sizeBtn.addClass('selected').css({
              background: 'rgba(139, 105, 20, 0.2)',
              'border-color': 'rgba(139, 105, 20, 0.6)',
            });
            $('#font-preview').css('font-size', fontSize + 'em');
          }
          $('.bg-option-btn').removeClass('selected').css({
            background: 'rgba(139, 105, 20, 0.05)',
            'border-color': 'rgba(139, 105, 20, 0.3)',
            color: '#2d2d2d',
          });
          const bgBtn = $(`.bg-option-btn[data-bg-type="${bgType}"]`).first();
          if (bgBtn.length) {
            bgBtn.addClass('selected');
            if (bgType === 'black') {
              bgBtn.css({
                background: 'rgba(0, 0, 0, 0.85)',
                color: '#fff',
              });
            } else {
              bgBtn.css({
                background: 'rgba(139, 105, 20, 0.2)',
                'border-color': 'rgba(139, 105, 20, 0.6)',
              });
            }
            if (bgType === 'image') {
              $('#bg-image-upload').show();
              if (bgImage) {
                $('#bg-preview-img').attr('src', bgImage);
                $('#bg-image-preview').show();
                $('#bg-image-url').val(bgImage);
                $('.preset-image-item').each(function () {
                  if ($(this).data('url') === bgImage) {
                    $(this).css({
                      'border-color': 'rgba(139, 105, 20, 0.8)',
                      transform: 'scale(1.05)',
                      'box-shadow': '0 4px 8px rgba(139, 105, 20, 0.4)',
                    });
                  } else {
                    $(this).css({
                      'border-color': 'rgba(139, 105, 20, 0.3)',
                      transform: 'scale(1)',
                      'box-shadow': 'none',
                    });
                  }
                });
              }
            } else {
              $('#bg-image-upload').hide();
            }
          }
        }

        loadSettings() {
          const defaultBgImage = 'https://files.catbox.moe/rjchsc.jpg';
          const fontFamily = localStorage.getItem('teresen_font_family') || "'Source Han Serif', 'ÊÄùÊ∫êÂÆã‰Ωì', serif";
          const fontSize = localStorage.getItem('teresen_font_size') || '1';
          const bgType = localStorage.getItem('teresen_fullscreen_background_type') || 'image';
          const bgImage = localStorage.getItem('teresen_fullscreen_background_image') || defaultBgImage;
          $('.story-text').css({
            'font-family': fontFamily,
            'font-size': fontSize + 'em',
          });
          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay) {
            if (bgType === 'black') {
              overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
              overlay.style.backgroundImage = 'none';
            } else if (bgType === 'image' && bgImage) {
              overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
              overlay.style.backgroundImage = `url("${bgImage}")`;
              overlay.style.backgroundSize = 'cover';
              overlay.style.backgroundPosition = 'center';
              overlay.style.backgroundRepeat = 'no-repeat';
            }
          }
        }

        resetSettings() {
          const defaultBgImage = 'https://files.catbox.moe/rjchsc.jpg';
          localStorage.removeItem('teresen_font_family');
          localStorage.removeItem('teresen_font_size');
          localStorage.setItem('teresen_fullscreen_background_type', 'image');
          localStorage.setItem('teresen_fullscreen_background_image', defaultBgImage);
          localStorage.setItem('teresen_auto_fullscreen', 'true'); 
          localStorage.removeItem('teresen_enter_to_send'); 
          this.restoreSettingsToUI();
          const defaultFont = "'Source Han Serif', 'ÊÄùÊ∫êÂÆã‰Ωì', serif";
          const defaultSize = '1';

          $('.story-text').css({
            'font-family': defaultFont,
            'font-size': defaultSize + 'em',
          });

          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay) {
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
            overlay.style.backgroundImage = `url("${defaultBgImage}")`;
            overlay.style.backgroundSize = 'cover';
            overlay.style.backgroundPosition = 'center';
            overlay.style.backgroundRepeat = 'no-repeat';
          }

          console.log('‚úÖ C√†i ƒë·∫∑t ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t l·∫°i v·ªÅ m·∫∑c ƒë·ªãnh');
        }

        clearCache() {
          if (
            !confirm(
              'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ b·ªô nh·ªõ ƒë·ªám kh√¥ng?\n\nƒêi·ªÅu n√†y s·∫Ω x√≥a c√°c n·ªôi dung sau:\n- T·∫•t c·∫£ c√†i ƒë·∫∑t\n- L·ªãch s·ª≠ tr√≤ chuy·ªán\n- D·ªØ li·ªáu tr·∫°ng th√°i tr√≤ ch∆°i\n- D·ªØ li·ªáu l∆∞u tr·ªØ c·ª•c b·ªô kh√°c\n\nThao t√°c n√†y kh√¥ng th·ªÉ kh√¥i ph·ª•c!',
            )
          ) {
            return;
          }

          const resultDiv = $('#clear-cache-result');
          resultDiv.hide();

          try {
            let clearedCount = 0;
            const keysToKeep = []; 
            for (let i = localStorage.length - 1; i >= 0; i--) {
              const key = localStorage.key(i);
              if (key && key.startsWith('teresen_') && !keysToKeep.includes(key)) {
                localStorage.removeItem(key);
                clearedCount++;
              }
            }
            const otherCacheKeys = [
              'treisenAchievements', 
              'item_pending_actions', 
              'game_current_day', 
              'frontend_chat_history_fallback', 
            ];

            otherCacheKeys.forEach(key => {
              if (localStorage.getItem(key)) {
                localStorage.removeItem(key);
                clearedCount++;
              }
            });
            const prefixPatterns = [
              'frontend_chat_history_', 
              'tarot_', 
            ];

            prefixPatterns.forEach(prefix => {
              for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key && key.startsWith(prefix)) {
                  localStorage.removeItem(key);
                  clearedCount++;
                }
              }
            });
            try {
              const sessionCount = sessionStorage.length;
              sessionStorage.clear();
              clearedCount += sessionCount;
            } catch (e) {
              console.warn('X√≥a sessionStorage th·∫•t b·∫°i:', e);
            }
            resultDiv
              .css({
                background: 'rgba(16, 185, 129, 0.1)',
                border: '1px solid rgba(16, 185, 129, 0.3)',
                color: '#059669',
              })
              .html(`‚úÖ ƒê√£ x√≥a th√†nh c√¥ng ${clearedCount} m·ª•c d·ªØ li·ªáu ƒë·ªám! Trang s·∫Ω t·ª± ƒë·ªông l√†m m·ªõi...`)
              .fadeIn(200);

            console.log(`‚úÖ ƒê√£ x√≥a ${clearedCount} m·ª•c b·ªô nh·ªõ ƒë·ªám`);
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          } catch (error) {
            console.error('X√≥a b·ªô nh·ªõ ƒë·ªám th·∫•t b·∫°i:', error);
            resultDiv
              .css({
                background: 'rgba(220, 38, 38, 0.1)',
                border: '1px solid rgba(220, 38, 38, 0.3)',
                color: '#dc2626',
              })
              .html(`‚ùå X·∫£y ra l·ªói khi x√≥a b·ªô nh·ªõ ƒë·ªám: ${error.message}`)
              .fadeIn(200);
          }
        }

        setupConsoleCommands() {
          try {
            ((window.teresenDebug = {
              showAllVariables: () => this.showAllVariables(),

              showTrainerStatus: () => this.showTrainerStatus(),

              showUmaStatus: () => this.showUmaStatus(),

              showWorldInfo: () => this.showWorldInfo(),

              showRules: () => this.showRules(),

              help: () => this.showConsoleHelp(),

              toggleItemDetails: e => this.toggleItemDetails(e),

              toggleRules: e => this.toggleRules(e),

              toggleUmaSection: () => this.toggleUmaSection(),

              checkCrystals: () => this.checkCrystals(),

              showTalentsModal: () => this.showTalentsModal(),

              switchTalentPage: page => this.switchTalentPage(page),

              prevTalentPage: () => this.prevTalentPage(),

              nextTalentPage: () => this.nextTalentPage(),

              selectTalentOption: (level, optionIndex) => this.selectTalentOption(level, optionIndex),

              testMvuInjection: () => this.testMvuInjection(),

              checkMvuStatus: () => this.checkMvuStatus(),

              showItemPopup: (e, t) => this.showItemPopup(e, t),

              loadLocalSave: () => this.loadLocalSave(),

              loadWorldbookSave: e => this.loadWorldbookSave(e),

              loadAutoSave: e => this.loadAutoSave(e),

              triggerQTE: e => this.triggerQTE(e),

              updateQTESection: () => this.updateQTESection(),

              manualCheckQTE: () => this.manualCheckQTE(),

              startReplyTiming: () => this.startReplyTiming(),

              endReplyTimer: () => this.endReplyTimer(),

              debugSaves: () => this.debugSaves(),

              debugCommands: () => this.debugCommands(),

              debugAutoSaves: () => this.debugAutoSaves(),
              addRule: index => this.addRule(),
              editRule: index => this.editRule(index),
              deleteRule: index => this.deleteRule(index),
              clearAllRules: () => this.clearAllRules(),
              getUserRules: () => this.getUserRules(),
              checkStatusTriggers: () => this.checkStatusTriggers(),
              triggerStatusAnimation: (stamina, sanity) => this.triggerStatusAnimation(stamina, sanity),
              testTarotDivination: () => this.testTarotDivination(),
              showFullscreenAlert: (message, options) => this.showFullscreenAlert(message, options),
              showFullscreenConfirm: (message, options) => this.showFullscreenConfirm(message, options),
              executeQuickAction: (actionType, characterName, characterId) =>
                this.executeQuickAction(actionType, characterName, characterId),
              cancelQuickActionSelection: () => this.cancelQuickActionSelection(),
            }),
              console.log('üéÆ L·ªánh g·ª° l·ªói H·ªçc vi·ªán Tracen: Chuy·ªán l·∫° ƒë√£ ƒë∆∞·ª£c t·∫£i!'),
              console.log('üí° Nh·∫≠p teresenDebug.help() ƒë·ªÉ xem t·∫•t c·∫£ c√°c l·ªánh kh·∫£ d·ª•ng'),
              console.log('üîç ƒê·ªëi t∆∞·ª£ng g·ª° l·ªói:', window.teresenDebug));
          } catch (e) {
            console.error('‚ùå L·ªói khi thi·∫øt l·∫≠p l·ªánh console:', e);
          }
        }

        showAllVariables() {
          const e = this.getAllVariables();

          (console.group('üìä T·∫•t c·∫£ th√¥ng tin bi·∫øn'),
            console.log('ƒê·ªëi t∆∞·ª£ng bi·∫øn ƒë·∫ßy ƒë·ªß:', e),
            e.stat_data
              ? (console.group('üèÉ Th√¥ng tin Hu·∫•n luy·ªán vi√™n'),
                console.table(e.stat_data.trainer),
                console.groupEnd(),
                console.group('üåç Th√¥ng tin Th·∫ø gi·ªõi'),
                console.table(e.stat_data.world),
                console.groupEnd(),
                console.group('üêé Th√¥ng tin Uma Musume'),
                console.table(e.stat_data.umaMusume),
                console.groupEnd(),
                e.stat_data.rules && (console.group('üìú Th√¥ng tin Quy t·∫Øc'), console.table(e.stat_data.rules), console.groupEnd()),
                e.stat_data.outerGods && (console.group('üëπ Th√¥ng tin Ngo·∫°i th·∫ßn'), console.table(e.stat_data.outerGods), console.groupEnd()))
              : console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y c·∫•u tr√∫c stat_data'),
            console.groupEnd());
        }

        showTrainerStatus() {
          var e;

          const t = this.getAllVariables();

          (console.group('üèÉ Chi ti·∫øt tr·∫°ng th√°i Hu·∫•n luy·ªán vi√™n'),
            (null == (e = t.stat_data) ? void 0 : e.trainer)
              ? (t.stat_data.trainer,
                console.log('Th·ªÉ l·ª±c:', this.getVariable(t, 'stat_data.trainer.stamina', 'N/A')),
                console.log('L√Ω tr√≠:', this.getVariable(t, 'stat_data.trainer.sanity', 'N/A')),
                console.log('May m·∫Øn:', this.getVariable(t, 'stat_data.trainer.luck', 'N/A')),
                console.log('V·ªã tr√≠:', this.getVariable(t, 'stat_data.trainer.location', 'N/A')),
                console.log('S·ªë ng√†y ·ªü tr∆∞·ªùng:', this.getVariable(t, 'stat_data.trainer.daysInSchool', 'N/A')),
                console.log('T√∫i ƒë·ªì:', this.getVariable(t, 'stat_data.trainer.inventory', 'N/A')))
              : console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu Hu·∫•n luy·ªán vi√™n'),
            console.groupEnd());
        }

        showUmaStatus() {
          const e = this.getAllVariables();

          console.group('üêé Chi ti·∫øt tr·∫°ng th√°i Uma Musume');

          (['Tokai Teio', 'Still in Love', 'Special Week', 'Silence Suzuka', 'Matikanefukukitaru', 'Agnes Tachyon'].forEach(t => {
            console.group(`${t} Tr·∫°ng th√°i`);

            const n = this.getVariable(e, `stat_data.umaMusume.${t}.affection`, 'N/A'),
              s = this.getVariable(e, `stat_data.umaMusume.${t}.status`, 'N/A');

            (console.log('H·∫£o c·∫£m ƒë·ªô:', n),
              console.log('Tr·∫°ng th√°i:', s),
              console.log('M√¥ t·∫£:', this.getUmaDescription(t, Number(n) || 0, s)),
              console.groupEnd());
          }),
            console.groupEnd());
        }

        showWorldInfo() {
          var e;

          const t = this.getAllVariables();

          (console.group('üåç Chi ti·∫øt th√¥ng tin Th·∫ø gi·ªõi'),
            (null == (e = t.stat_data) ? void 0 : e.world)
              ? (console.log('Th·ªùi gian hi·ªán t·∫°i:', this.getVariable(t, 'stat_data.world.currentTime', 'N/A')),
                console.log('Ng√†y hi·ªán t·∫°i:', this.getVariable(t, 'stat_data.world.currentDate', 'N/A')),
                console.log('Ch√≠nh vƒÉn hi·ªán t·∫°i:', this.getVariable(t, 'stat_data.world.currentText', 'N/A')),
                console.log('Quy t·∫Øc c·∫•m k·ªµ:', this.getVariable(t, 'stat_data.world.tabooRules', 'N/A')))
              : console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu Th·∫ø gi·ªõi'),
            console.groupEnd());
        }

        showRules() {
          var e;

          const t = this.getAllVariables();

          if ((console.group('üìú Chi ti·∫øt th√¥ng tin Quy t·∫Øc'), null == (e = t.stat_data) ? void 0 : e.rules)) {
            console.group('Quy t·∫Øc c·ªë ƒë·ªãnh');

            const e = this.getVariable(t, 'stat_data.rules.fixedRules', []);

            (Array.isArray(e) &&
              e.forEach((e, t) => {
                console.log(`${t + 1}. ${e}`);
              }),
              console.groupEnd(),
              console.group('Quy t·∫Øc ng·∫´u nhi√™n'));

            const n = this.getVariable(t, 'stat_data.rules.randomRules', []);

            (Array.isArray(n) &&
              n.forEach((e, t) => {
                console.log(`${t + 1}. ${e}`);
              }),
              console.groupEnd(),
              console.log('S·ªë l·∫ßn vi ph·∫°m:', this.getVariable(t, 'stat_data.rules.violationCount', 'N/A')));
          } else console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu Quy t·∫Øc');

          console.groupEnd();
        }

        updateLocation() {}

        updateGachaCoin() {
          const e = this.getAllVariables(),
            t = this.getVariable(e, 'stat_data.trainer.gachaCoin', 0),
            n = document.getElementById('gacha-coin-text'),
            profileGacha = document.getElementById('profile-gacha-coin');

          n && (n.textContent = `Xu Gacha: ${t}`);

          profileGacha && (profileGacha.textContent = t.toString());
        }

        updateJourneyModal() {
          const e = this.getAllVariables(),
            t = this.getVariable(e, 'stat_data.trainer.journey', []),
            n = document.getElementById('journey-list-modal');

          if (n)
            if (Array.isArray(t) && t.length > 0) {
              let e = '';

              (t.forEach((t, n) => {
                e += `\n            <div class="journey-entry">\n              <div class="journey-header">\n                <span class="journey-day">Ng√†y th·ª© ${t.day || n + 1}</span>\n                <span class="journey-status ${t.status || 'normal'}">${t.status || 'B√¨nh th∆∞·ªùng'}</span>\n              </div>\n              <div class="journey-event">${t.event || 'S·ª± ki·ªán kh√¥ng x√°c ƒë·ªãnh'}</div>\n              <div class="journey-desc">${t.description || 'T·∫°m kh√¥ng c√≥ m√¥ t·∫£'}</div>\n            </div>\n          `;
              }),
                (n.innerHTML = e));
            } else n.innerHTML = '<div class="empty-inventory">T·∫°m kh√¥ng c√≥ ghi ch√©p h√†nh tr√¨nh</div>';
        }

        setupLoadModal() {
          ($('#close-load-btn').on('click', () => {
            $('#load-modal').hide();
          }),
            $('#load-modal').on('click', e => {
              e.target === e.currentTarget && $('#load-modal').hide();
            }));
          const self = this;
          const originalShow = $.fn.show;
          $.fn.show = function (...args) {
            const result = originalShow.apply(this, args);
            if (this.is('#load-modal')) {
              const modal = document.getElementById('load-modal');
              self.ensureModalInOverlay(modal);
            }
            return result;
          };
        }

        setupHistoryModal() {
          ($('#close-history-btn').on('click', () => {
            $('#history-modal').hide();
          }),
            $('#history-modal').on('click', e => {
              e.target === e.currentTarget && $('#history-modal').hide();
            }));
        }

        async updateLoadModal() {
          try {
            console.log('üíæ C·∫≠p nh·∫≠t giao di·ªán l∆∞u tr·ªØ...');

            const localSavesList = document.getElementById('local-saves-list');

            const worldbookSavesList = document.getElementById('worldbook-saves-list');

            if (localSavesList) {
              let localSaveHtml = '';

              const localSave = localStorage.getItem('teresen-save');

              if (localSave) {
                try {
                  const saveData = JSON.parse(localSave);

                  localSaveHtml += `

                    <div class="save-item manual-save-item" onclick="window.teresenDebug.loadLocalSave()">

                      <div class="save-name">${saveData.saveName || 'L∆∞u tr·ªØ c·ª•c b·ªô'}</div>

                      <div class="save-time">${new Date(saveData.timestamp).toLocaleString('zh-CN')}</div>

                      <div class="save-type">L∆∞u th·ªß c√¥ng</div>

                    </div>

                  `;
                } catch (error) {
                  console.warn('Ph√¢n t√≠ch l∆∞u tr·ªØ c·ª•c b·ªô th·∫•t b·∫°i:', error);
                }
              }

              const autoSaves = this.getAutoSaves();

              console.log('T√¨m th·∫•y l∆∞u t·ª± ƒë·ªông:', autoSaves.length, 'c√°i');

              if (autoSaves.length > 0) {
                autoSaves.forEach(save => {

                  let displayContent = 'L∆∞u T·ª± ƒê·ªông';

                  if (save.data.message_content) {
                    const contentMatch = save.data.message_content.match(/<content>(.*?)<\/content>/s);

                    if (contentMatch) {
                      displayContent =
                        contentMatch[1].trim().substring(0, 50) + (contentMatch[1].length > 50 ? '...' : '');
                    } else {
                      displayContent =
                        save.data.message_content.substring(0, 50) +
                        (save.data.message_content.length > 50 ? '...' : '');
                    }
                  }

                  localSaveHtml += `

                    <div class="save-item auto-save-item" onclick="window.teresenDebug.loadAutoSave('${save.key}')">

                      <div class="save-name">${save.data.save_name || 'L∆∞u T·ª± ƒê·ªông'}</div>

                      <div class="save-content">${displayContent}</div>

                      <div class="save-time">${new Date(save.data.timestamp).toLocaleString('zh-CN')}</div>

                      <div class="save-type">L∆∞u T·ª± ƒê·ªông</div>

                    </div>

                  `;
                });
              }

              localSavesList.innerHTML = localSaveHtml || '<div class="empty-save">T·∫°m kh√¥ng c√≥ l∆∞u tr·ªØ c·ª•c b·ªô</div>';

              console.log('Danh s√°ch l∆∞u tr·ªØ c·ª•c b·ªô ƒë√£ c·∫≠p nh·∫≠t');
            }

            if (worldbookSavesList) {
              const worldbookEntries = await this.getWorldbookEntries();

              let worldbookHtml = '';

              if (worldbookEntries && worldbookEntries.length > 0) {
                worldbookEntries.forEach(entry => {
                  if (entry.title && entry.title.includes('L∆∞u Tr·ªØ')) {
                    worldbookHtml += `

                      <div class="save-item worldbook-save-item" onclick="window.teresenDebug.loadWorldbookSave('${entry.title}')">

                        <div class="save-name">${entry.title}</div>

                        <div class="save-time">${entry.content ? new Date(entry.content).toLocaleString('vi-VN') : 'Th·ªùi gian kh√¥ng x√°c ƒë·ªãnh'}</div>

                        <div class="save-type">L∆∞u tr·ªØ S√°ch th·∫ø gi·ªõi</div>

                      </div>

                    `;
                  }
                });
              }

              worldbookSavesList.innerHTML = worldbookHtml || '<div class="empty-save">T·∫°m kh√¥ng c√≥ l∆∞u tr·ªØ S√°ch th·∫ø gi·ªõi</div>';

              console.log('Danh s√°ch l∆∞u tr·ªØ S√°ch th·∫ø gi·ªõi ƒë√£ c·∫≠p nh·∫≠t');
            }

            this.setupSaveButtons();
          } catch (error) {
            console.error('‚ùå C·∫≠p nh·∫≠t giao di·ªán l∆∞u tr·ªØ th·∫•t b·∫°i:', error);
          }
        }

        setupSaveButtons() {
          try {

            const existingButtons = document.querySelectorAll('.save-button');

            if (existingButtons.length > 0) {
              console.log('N√∫t l∆∞u tr·ªØ ƒë√£ t·ªìn t·∫°i, b·ªè qua t·∫°o');

              return;
            }

            const loadSection = document.querySelector('.load-section');

            if (!loadSection) {
              console.warn('Kh√¥ng t√¨m th·∫•y khu v·ª±c l∆∞u tr·ªØ');

              return;
            }

            const localSaveBtn = document.createElement('button');

            localSaveBtn.className = 'save-button subtle-hover';

            localSaveBtn.innerHTML = `

              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h-1v5.586l-2.293-2.293z" />

              </svg>

              <span>L∆∞u v√†o c·ª•c b·ªô</span>

            `;

            localSaveBtn.onclick = () => this.handleSave('local');

            const worldbookSaveBtn = document.createElement('button');

            worldbookSaveBtn.className = 'save-button subtle-hover';

            worldbookSaveBtn.innerHTML = `

              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h-1v5.586l-2.293-2.293z" />

              </svg>

              <span>L∆∞u v√†o S√°ch th·∫ø gi·ªõi</span>

            `;

            worldbookSaveBtn.onclick = () => this.handleSave('worldbook');

            const buttonContainer = document.createElement('div');

            buttonContainer.style.cssText = 'margin-top: 1rem; display: flex; gap: 0.5rem;';

            buttonContainer.appendChild(localSaveBtn);

            buttonContainer.appendChild(worldbookSaveBtn);

            loadSection.appendChild(buttonContainer);

            console.log('N√∫t l∆∞u tr·ªØ ƒë√£ ƒë∆∞·ª£c t·∫°o');
          } catch (error) {
            console.error('Thi·∫øt l·∫≠p n√∫t l∆∞u tr·ªØ th·∫•t b·∫°i:', error);
          }
        }

        async updateHistoryModal() {
          try {
            const e = document.getElementById('current-journey-list');

            if (e) {
              const t = await this.getWorldbookEntries();

              let n = '';

              (t &&
                t.length > 0 &&
                t.forEach(e => {
                  if (e.title && e.title.includes('H√†nh tr√¨nh c√° nh√¢n'))
                    try {
                      const t = JSON.parse(e.content || '[]');

                      Array.isArray(t) &&
                        t.forEach((e, t) => {
                          n += `\n                      <div class="journey-entry">\n                        <div class="journey-header">\n                          <span class="journey-day">Ng√†y th·ª© ${e.day || t + 1}</span>\n                          <span class="journey-status ${e.status || 'normal'}">${e.status || 'B√¨nh th∆∞·ªùng'}</span>\n                        </div>\n                        <div class="journey-event">${e.event || 'S·ª± ki·ªán kh√¥ng x√°c ƒë·ªãnh'}</div>\n                        <div class="journey-desc">${e.description || 'T·∫°m kh√¥ng c√≥ m√¥ t·∫£'}</div>\n                      </div>\n                    `;
                        });
                    } catch (t) {
                      console.warn('Ph√¢n t√≠ch d·ªØ li·ªáu h√†nh tr√¨nh c√° nh√¢n th·∫•t b·∫°i:', t);
                    }
                }),
                (e.innerHTML = n || '<div class="empty-journey">T·∫°m kh√¥ng c√≥ h√†nh tr√¨nh nh√¢n v·∫≠t</div>'));
            }
          } catch (e) {
            console.error('‚ùå C·∫≠p nh·∫≠t giao di·ªán l·ªãch s·ª≠ th·∫•t b·∫°i:', e);
          }
        }

        async saveToWorldbook(e) {
          try {
            if ('undefined' != typeof TavernHelper && TavernHelper.createLorebookEntries) {
              const t = {
                title: e.saveName,

                content: e.timestamp,

                category: 'L∆∞u Tr·ªØ',

                keywords: ['L∆∞u Tr·ªØ', 'Tracen', 'Hu·∫•n luy·ªán vi√™n'],

                force_activation: !1,

                selective: !1,

                display_index: 0,

                probability: 100,

                exclude_recursion: !1,

                use_extra: !1,

                extra: JSON.stringify(e),
              };

              (await TavernHelper.createLorebookEntries([t]), console.log('‚úÖ L∆∞u tr·ªØ ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o S√°ch th·∫ø gi·ªõi'));
            }
          } catch (t) {
            console.error('‚ùå L∆∞u v√†o S√°ch th·∫ø gi·ªõi th·∫•t b·∫°i:', t);
          }
        }

        async saveJourneyToWorldbook() {
          try {
            const e = this.getAllVariables(),
              t = this.getVariable(e, 'stat_data.trainer.journey', []);

            if (
              Array.isArray(t) &&
              t.length > 0 &&
              'undefined' != typeof TavernHelper &&
              TavernHelper.createLorebookEntries
            ) {
              const e = {
                title: 'H√†nh tr√¨nh c√° nh√¢n',

                content: JSON.stringify(t),

                category: 'H√†nh tr√¨nh',

                keywords: ['H√†nh tr√¨nh', 'Tracen', 'Hu·∫•n luy·ªán vi√™n', 'H√†nh tr√¨nh c√° nh√¢n'],

                force_activation: !1,

                selective: !1,

                display_index: 0,

                probability: 100,

                exclude_recursion: !1,

                use_extra: !1,

                extra: '',
              };

              (await TavernHelper.createLorebookEntries([e]), console.log('‚úÖ H√†nh tr√¨nh nh√¢n v·∫≠t ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o S√°ch th·∫ø gi·ªõi'));
            }
          } catch (e) {
            console.error('‚ùå L∆∞u h√†nh tr√¨nh nh√¢n v·∫≠t v√†o S√°ch th·∫ø gi·ªõi th·∫•t b·∫°i:', e);
          }
        }

        async getWorldbookEntries() {
          try {
            return 'undefined' != typeof TavernHelper && TavernHelper.getLorebookEntries
              ? await TavernHelper.getLorebookEntries()
              : [];
          } catch (e) {
            return (console.error('‚ùå L·∫•y m·ª•c S√°ch th·∫ø gi·ªõi th·∫•t b·∫°i:', e), []);
          }
        }
        async loadLocalSave_DELETED() {
          try {
            console.log('üìÇ T·∫£i l∆∞u tr·ªØ c·ª•c b·ªô...');

            const saveData = localStorage.getItem('teresen-save');

            if (!saveData) {
              throw new Error('L∆∞u tr·ªØ c·ª•c b·ªô kh√¥ng t·ªìn t·∫°i');
            }

            const save = JSON.parse(saveData);

            console.log('D·ªØ li·ªáu l∆∞u tr·ªØ c·ª•c b·ªô:', save);

            if (save.data && save.data.variables && 'function' == typeof eventEmit) {
              this.currentMvuState = save.data.variables;
              this.renderUI(this.currentMvuState.stat_data);

              console.log('‚úÖ Tr·∫°ng th√°i tr√≤ ch∆°i ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c');
            }
            if (
              save.data &&
              save.data.message &&
              typeof SillyTavern !== 'undefined' &&
              SillyTavern.chat &&
              SillyTavern.chat.length > 0
            ) {
              const lastMessage = SillyTavern.chat[SillyTavern.chat.length - 1];
              if (!lastMessage.extra) {
                lastMessage.extra = {};
              }
              if (save.data.chat_history && Array.isArray(save.data.chat_history)) {
                lastMessage.extra.teresen_chat = JSON.parse(JSON.stringify(save.data.chat_history));

                if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
                  await SillyTavern.saveChat();
                  console.log('‚úÖ L·ªãch s·ª≠ tr√≤ chuy·ªán ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c v√†o extra.teresen_chat c·ªßa tin nh·∫Øn cu·ªëi c√πng');
                } else {
                  await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });
                  console.log('‚úÖ L·ªãch s·ª≠ tr√≤ chuy·ªán ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c v√†o extra.teresen_chat c·ªßa tin nh·∫Øn cu·ªëi c√πng (ch∆∞a c·∫≠p nh·∫≠t tr∆∞·ªùng message)');
                }
              } else if (save.data.message) {
                lastMessage.extra.teresen_chat = [
                  {
                    role: 'assistant',
                    content: save.data.message,
                    id: 'load_' + Date.now(),
                    timestamp: Date.now(),
                    variableState: save.data.variables || null,
                  },
                ];

                if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
                  await SillyTavern.saveChat();
                  console.log('‚úÖ Tin nh·∫Øn ƒë∆°n l·∫ª ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c v√†o extra.teresen_chat c·ªßa tin nh·∫Øn cu·ªëi c√πng');
                } else {
                  await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });
                  console.log('‚úÖ Tin nh·∫Øn ƒë∆°n l·∫ª ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c v√†o extra.teresen_chat c·ªßa tin nh·∫Øn cu·ªëi c√πng (ch∆∞a c·∫≠p nh·∫≠t tr∆∞·ªùng message)');
                }
              }
            }

            await this.updateInterface();

            $('#load-modal').hide();

            console.log('‚úÖ T·∫£i l∆∞u tr·ªØ c·ª•c b·ªô th√†nh c√¥ng');

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('T·∫£i l∆∞u tr·ªØ c·ª•c b·ªô th√†nh c√¥ng!');
            }
          } catch (error) {
            console.error('‚ùå ƒê·ªçc l∆∞u tr·ªØ c·ª•c b·ªô th·∫•t b·∫°i:', error);

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('ƒê·ªçc l∆∞u tr·ªØ th·∫•t b·∫°i!');
            }
          }
        }

        async loadWorldbookSave(e) {
          try {
            const t = (await this.getWorldbookEntries()).find(t => t.title === e);

            if (t && t.extra) {
              const e = JSON.parse(t.extra);

              (await this.loadSaveData(e), $('#load-modal').hide());
            }
          } catch (t) {
            (console.error('‚ùå ƒê·ªçc l∆∞u tr·ªØ S√°ch th·∫ø gi·ªõi th·∫•t b·∫°i:', t),
              typeof showTemporaryMessage === 'function' && showTemporaryMessage('ƒê·ªçc l∆∞u tr·ªØ th·∫•t b·∫°i!'));
          }
        }
        async loadSaveData_DELETED(e) {
          try {
            if (e.variables && 'function' == typeof eventEmit) {
              eventEmit('mag_invoke_mvu');
              console.log('‚úÖ Bi·∫øn MVU ƒë√£ c·∫≠p nh·∫≠t');
            }
            if (e.message || (e.timeline_history && Array.isArray(e.timeline_history))) {
              if (typeof SillyTavern === 'undefined' || !SillyTavern.chat || SillyTavern.chat.length === 0) {
                console.warn('‚ö†Ô∏è SillyTavern.chat tr·ªëng, kh√¥ng th·ªÉ kh√¥i ph·ª•c l·ªãch s·ª≠ tr√≤ chuy·ªán');
              } else {
                const lastMessage = SillyTavern.chat[SillyTavern.chat.length - 1];
                if (!lastMessage.extra) {
                  lastMessage.extra = {};
                }
                if (e.timeline_history && Array.isArray(e.timeline_history) && e.timeline_history.length > 0) {
                  lastMessage.extra.teresen_chat = e.timeline_history.map(snapshot => ({
                    role: 'assistant',
                    content: snapshot.message || '',
                    id: snapshot.message_id || `snapshot_${Date.now()}`,
                    timestamp: snapshot.timestamp || Date.now(),
                    variableState: snapshot.data || null,
                  }));
                } else if (e.message) {
                  lastMessage.extra.teresen_chat = [
                    {
                      role: 'assistant',
                      content: e.message,
                      id: 'load_' + Date.now(),
                      timestamp: Date.now(),
                      variableState: e.variables || null,
                    },
                  ];
                }
                if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
                  await SillyTavern.saveChat();
                  console.log('‚úÖ L·ªãch s·ª≠ tr√≤ chuy·ªán ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c v√†o extra.teresen_chat c·ªßa tin nh·∫Øn cu·ªëi c√πng');
                } else if (typeof TavernHelper !== 'undefined' && TavernHelper.setChatMessages) {
                  await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });
                  console.log('‚úÖ L·ªãch s·ª≠ tr√≤ chuy·ªán ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c v√†o extra.teresen_chat c·ªßa tin nh·∫Øn cu·ªëi c√πng (ch∆∞a c·∫≠p nh·∫≠t tr∆∞·ªùng message)');
                }
              }
            }

            await this.updateInterface();
            console.log('‚úÖ T·∫£i l∆∞u tr·ªØ th√†nh c√¥ng');
            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('T·∫£i l∆∞u tr·ªØ th√†nh c√¥ng!');
            }
          } catch (t) {
            console.error('‚ùå T·∫£i d·ªØ li·ªáu l∆∞u tr·ªØ th·∫•t b·∫°i:', t);
            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('T·∫£i l∆∞u tr·ªØ th·∫•t b·∫°i!');
            }
          }
        }

        async autoSaveAfterAIResponse(aiResponse, userInput) {
          try {
            console.log('üíæ B·∫Øt ƒë·∫ßu l∆∞u t·ª± ƒë·ªông ph·∫£n h·ªìi AI...');

            const currentVariables = this.getAllVariables();

            let fullChatHistory = [];

            if (typeof getChatMessages === 'function') {
              try {

                let allChatMessages = null;

                if (typeof getCurrentMessageId === 'function') {
                  try {
                    const currentId = getCurrentMessageId();

                    allChatMessages = await getChatMessages(currentId);

                    console.log('üìö L·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán th√¥ng qua getCurrentMessageId:', allChatMessages?.length || 0, 'tin nh·∫Øn');
                  } catch (e) {
                    console.warn('‚ö†Ô∏è Ph∆∞∆°ng th·ª©c getCurrentMessageId th·∫•t b·∫°i:', e);
                  }
                }

                if (!allChatMessages || !Array.isArray(allChatMessages) || allChatMessages.length === 0) {
                  allChatMessages = await getChatMessages();

                  console.log('üìö L·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán th√¥ng qua g·ªçi tr·ª±c ti·∫øp:', allChatMessages?.length || 0, 'tin nh·∫Øn');
                }

                if (allChatMessages && Array.isArray(allChatMessages) && allChatMessages.length > 0) {
                  fullChatHistory = allChatMessages.map(msg => ({
                    message: msg.message || '',

                    role: msg.role || 'unknown',

                    data: msg.data || null,

                    timestamp: msg.timestamp || Date.now(),
                  }));

                  console.log('‚úÖ L·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán ƒë·∫ßy ƒë·ªß th√†nh c√¥ng:', fullChatHistory.length, 'tin nh·∫Øn');
                } else {
                  console.warn('‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c tin nh·∫Øn tr√≤ chuy·ªán h·ª£p l·ªá, s·ª≠ d·ª•ng m·∫£ng r·ªóng');

                  fullChatHistory = [];
                }
              } catch (chatError) {
                console.error('‚ùå L·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán th·∫•t b·∫°i:', chatError);

                fullChatHistory = [];
              }
            } else {
              console.warn('‚ö†Ô∏è H√†m getChatMessages kh√¥ng kh·∫£ d·ª•ng');

              fullChatHistory = [];
            }

            let currentMessage = '';

            if (fullChatHistory && fullChatHistory.length > 0) {

              const lastAiMessage = [...fullChatHistory].reverse().find(msg => msg.role === 'assistant');

              currentMessage = lastAiMessage
                ? lastAiMessage.message
                : fullChatHistory[fullChatHistory.length - 1].message;
            }
            const bookName = '- Uma Musume: Chuy·ªán l·∫° Tracen';
            const baseJourneyKey = this._getBaseJourneyKey();
            const baseCoreKey = this._getBaseCoreMemoryKey();
            let journeyContent = '';
            let coreMemoryContent = '';
            try {
              const allEntries = await TavernHelper.getLorebookEntries(bookName);
              const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);
              const coreEntry = allEntries.find(entry => entry.comment === baseCoreKey);
              journeyContent = journeyEntry?.content || '';
              coreMemoryContent = coreEntry?.content || '';
            } catch (e) {
              console.warn('ƒê·ªçc n·ªôi dung S√°ch th·∫ø gi·ªõi th·∫•t b·∫°i:', e);
            }

            const timestamp = Date.now();

            const saveData = {
              timestamp: timestamp,

              save_name: `L∆∞u T·ª± ƒê·ªông_${new Date().toLocaleString('vi-VN')}`,

              timeline_history: JSON.parse(JSON.stringify(this.chatHistoryCache)), 

              snapshot_data: {
                mvu_data: currentVariables,

                lorebook_content: {
                  journey: journeyContent,

                  core_memory: coreMemoryContent,
                },
              },

              type: 'auto',

              version: '2.0', 
            };

            const saveKey = `teresen-auto-save-${timestamp}`;

            localStorage.setItem(saveKey, JSON.stringify(saveData));

            localStorage.setItem('teresen_auto_save', JSON.stringify(saveData));

            console.log('‚úÖ L∆∞u t·ª± ƒë·ªông th√†nh c√¥ng (bao g·ªìm', fullChatHistory ? fullChatHistory.length : 0, 'tin nh·∫Øn l·ªãch s·ª≠)');

            this.showAutoSaveNotification();

            this.cleanupOldAutoSaves();

            this.lastSentPrompt = userInput;
          } catch (error) {
            console.error('‚ùå L∆∞u t·ª± ƒë·ªông th·∫•t b·∫°i:', error);

            throw error;
          }
        }

        cleanupOldAutoSaves() {
          try {
            console.log('üßπ B·∫Øt ƒë·∫ßu d·ªçn d·∫πp l∆∞u t·ª± ƒë·ªông c≈©...');

            const autoSaveKeys = [];

            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);

              if (key && key.startsWith('teresen-auto-save-')) {
                autoSaveKeys.push(key);
              }
            }

            console.log(`üìä T√¨m th·∫•y ${autoSaveKeys.length} b·∫£n l∆∞u t·ª± ƒë·ªông`);

            if (autoSaveKeys.length > 15) {

              autoSaveKeys.sort().reverse();

              const keysToRemove = autoSaveKeys.slice(10);

              console.log(`üóëÔ∏è C·∫ßn d·ªçn d·∫πp ${keysToRemove.length} b·∫£n l∆∞u c≈©`);

              keysToRemove.forEach(key => {
                localStorage.removeItem(key);

                console.log('üóëÔ∏è D·ªçn d·∫πp l∆∞u t·ª± ƒë·ªông c≈©:', key);
              });
            } else {
              console.log('‚úÖ S·ªë l∆∞·ª£ng l∆∞u t·ª± ƒë·ªông b√¨nh th∆∞·ªùng, kh√¥ng c·∫ßn d·ªçn d·∫πp');
            }
          } catch (error) {
            console.warn('D·ªçn d·∫πp l∆∞u t·ª± ƒë·ªông c≈© th·∫•t b·∫°i:', error);
          }
        }

        showAutoSaveNotification() {
          try {

            const notification = document.createElement('div');

            notification.id = 'auto-save-notification';

            notification.innerHTML = 'üíæ B√© E ƒë√£ t·ª± ƒë·ªông l∆∞u gi√∫p b·∫°n';

            notification.style.cssText = `

              position: fixed;

              top: 20px;

              right: 20px;

              background: rgba(34, 197, 94, 0.9);

              color: white;

              padding: 8px 16px;

              border-radius: 6px;

              font-size: 12px;

              font-weight: bold;

              z-index: 10000;

              opacity: 0;

              transform: translateX(100%);

              transition: all 0.3s ease;

              pointer-events: none;

            `;

            document.body.appendChild(notification);

            setTimeout(() => {
              notification.style.opacity = '1';

              notification.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
              notification.style.opacity = '0';

              notification.style.transform = 'translateX(100%)';

              setTimeout(() => {
                if (notification.parentNode) {
                  notification.parentNode.removeChild(notification);
                }
              }, 300);
            }, 3000);
          } catch (error) {
            console.warn('Hi·ªÉn th·ªã th√¥ng b√°o l∆∞u t·ª± ƒë·ªông th·∫•t b·∫°i:', error);
          }
        }
        detectUmaInAIResponse(aiResponse) {
          try {
            console.log('üîç B·∫Øt ƒë·∫ßu ph√°t hi·ªán t√™n Uma Musume trong ph·∫£n h·ªìi AI...');
            const umaNames = [
              'Tokai Teio',
              'Still in Love',
              'Special Week',
              'Silence Suzuka',
              'Matikanefukukitaru',
              'Agnes Tachyon',
              'Mejiro Bright',
              'Mejiro McQueen',
              'Mejiro Palmer',
              'Mejiro Dober',
              'Mejiro Ryan',
              'Oguri Cap',
              'Tamamo Cross',
              'Super Creek',
              'Sakura Bakushin O',
              'Winning Ticket',
              'Narita Brian',
              'Biwa Hayahide',
              'Mayano Top Gun',
              'Manhattan Cafe',
              'T.M. Opera O',
              'Agnes Digital',
              'Air Shakur',
              'Seiun Sky',
              'Grass Wonder',
              'El Condor Pasa',
              'Meisho Doto',
              'Mejiro Ryan',
              'Mejiro Ardan',
              'Mejiro Ramonu',
              'Daiwa Scarlet',
              'Vodka',
              'Daitaku Helios',
              'Gold Ship',
              'Gold City',
              'Nakayama Festa',
              'Nakayama Bright',
              'Nakayama Knight',
              'Nakayama Hero',
              'Mihono Bourbon',
              'Rice Shower',
              'Chun-Li',
              'Urara',
              'Matikanefukukitaru',
              'Matikanetannhauser',
              'Biko Pegasus',
            ];
            const detectedUmas = [];
            umaNames.forEach(umaName => {
              if (aiResponse.includes(umaName)) {
                detectedUmas.push(umaName);
                console.log(`üêé Ph√°t hi·ªán Uma Musume: ${umaName}`);
              }
            });
            if (detectedUmas.length > 0) {
              detectedUmas.forEach(umaName => {
                if (window.teresenDebug && window.teresenDebug.addUmaToRoster) {
                  window.teresenDebug.addUmaToRoster(umaName, {
                    notes: `Ph√°t hi·ªán trong ph·∫£n h·ªìi AI l√∫c: ${new Date().toLocaleString('vi-VN')}`,
                  });
                }
              });
              console.log(`üìñ ƒê√£ th√™m ${detectedUmas.length} Uma Musume v√†o danh s√°ch ghi danh`);
            } else {
              console.log('üîç Kh√¥ng ph√°t hi·ªán t√™n Uma Musume');
            }
          } catch (error) {
            console.error('Ph√°t hi·ªán t√™n Uma Musume th·∫•t b·∫°i:', error);
          }
        }

        async getChatHistory() {
          try {
            let allChatHistory = [];
            console.log('üîç B·∫Øt ƒë·∫ßu l·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán phi√™n hi·ªán t·∫°i...');
            if (this.currentArchiveName && this.db) {
              try {
                const archive = await this.db.archives.get(this.currentArchiveName);
                if (archive && archive.data && archive.data.logs) {
                  const chatLogs = archive.data.logs.filter(
                    log => log.type === 'user' || log.type === 'ai' || log.type === 'assistant',
                  );
                  if (chatLogs.length > 0) {
                    console.log('üìö L·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán t·ª´ c∆° s·ªü d·ªØ li·ªáu l∆∞u tr·ªØ:', chatLogs.length, 'b·∫£n ghi');
                    allChatHistory.push(...chatLogs);
                  }
                }
              } catch (e) {
                console.warn('‚ö†Ô∏è L·∫•y t·ª´ c∆° s·ªü d·ªØ li·ªáu l∆∞u tr·ªØ th·∫•t b·∫°i:', e);
              }
            }
            if ('function' == typeof getChatMessages) {
              let allChatMessages = null;
              if (typeof getCurrentMessageId === 'function') {
                try {
                  const currentId = getCurrentMessageId();
                  allChatMessages = await getChatMessages(currentId);
                  console.log('üìö L·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán th√¥ng qua getCurrentMessageId:', allChatMessages?.length || 0, 'tin nh·∫Øn');
                } catch (e) {
                  console.warn('‚ö†Ô∏è Ph∆∞∆°ng th·ª©c getCurrentMessageId th·∫•t b·∫°i:', e);
                }
              }
              if (!allChatMessages || !Array.isArray(allChatMessages) || allChatMessages.length === 0) {
                allChatMessages = await getChatMessages();
                console.log('üìö L·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán th√¥ng qua g·ªçi tr·ª±c ti·∫øp:', allChatMessages?.length || 0, 'tin nh·∫Øn');
              }

              if (allChatMessages && Array.isArray(allChatMessages) && allChatMessages.length > 0) {
                allChatHistory.push(...allChatMessages);
                console.log('üìö L·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán t·ª´ API SillyTavern:', allChatMessages.length, 'tin nh·∫Øn');
              }
            }
            if (window.SillyTavern && window.SillyTavern.getContext) {
              try {
                const context = window.SillyTavern.getContext();
                if (context && context.chat && context.chat.length > 0) {
                  console.log('üìö L·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán t·ª´ b·ªëi c·∫£nh SillyTavern:', context.chat.length, 'tin nh·∫Øn');
                  allChatHistory.push(...context.chat);
                }
              } catch (e) {
                console.warn('‚ö†Ô∏è L·∫•y b·ªëi c·∫£nh SillyTavern th·∫•t b·∫°i:', e);
              }
            }
            if (window.chat && Array.isArray(window.chat) && window.chat.length > 0) {
              console.log('üìö L·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán t·ª´ bi·∫øn to√†n c·ª•c:', window.chat.length, 'tin nh·∫Øn');
              allChatHistory.push(...window.chat);
            }
            if (allChatHistory.length > 0) {
              const uniqueHistory = [];
              const seenMessages = new Set();

              for (const msg of allChatHistory) {
                const content = msg.content || msg.mes || msg.message || '';
                const timestamp = msg.timestamp || msg.send_date || Date.now();
                const key = `${content.slice(0, 100)}_${timestamp}`;

                if (!seenMessages.has(key) && content.trim()) {
                  seenMessages.add(key);
                  uniqueHistory.push(msg);
                }
              }
              uniqueHistory.sort((a, b) => {
                const timeA = new Date(a.timestamp || a.send_date || 0).getTime();
                const timeB = new Date(b.timestamp || b.send_date || 0).getTime();
                return timeA - timeB;
              });

              console.log('‚úÖ L·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán ƒë·∫ßy ƒë·ªß th√†nh c√¥ng:', uniqueHistory.length, 'b·∫£n ghi (sau khi l·ªçc tr√πng)');
              return uniqueHistory;
            }

            console.warn('‚ö†Ô∏è T·∫•t c·∫£ c√°c chi·∫øn l∆∞·ª£c l·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán ƒë·ªÅu th·∫•t b·∫°i');
            return [];
          } catch (error) {
            console.warn('L·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán th·∫•t b·∫°i:', error);

            return [];
          }
        }

        updateQTESection() {
          try {

            const shouldShowQTE = this.detectQTECondition();

            const qteSection = document.getElementById('qte-section');

            if (!qteSection) {
              console.warn('‚ùå Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ khu v·ª±c QTE');

              return;
            }

            if (shouldShowQTE) {

              qteSection.style.display = 'block';

              const description = qteSection.querySelector('.qte-description');

              if (description) {
                description.textContent = 'B·∫°n b·ªã Uma Musume tr√≥i bu·ªôc! Ch·ªçn h√†nh ƒë·ªông c·ªßa b·∫°n...';
              }

              console.log('üéÆ Khu v·ª±c QTE ƒë√£ hi·ªÉn th·ªã (ph√°t hi·ªán frontend)');
            } else {

              qteSection.style.display = 'none';

              console.log('üéÆ Khu v·ª±c QTE ƒë√£ ·∫©n');
            }
          } catch (error) {
            console.error('‚ùå C·∫≠p nh·∫≠t khu v·ª±c QTE th·∫•t b·∫°i:', error);
          }
        }

        detectQTECondition() {
          try {

            const aiText = this.getLastAIText();

            console.log('üîç VƒÉn b·∫£n AI nh·∫≠n ƒë∆∞·ª£c:', aiText ? aiText.substring(0, 100) + '...' : 'VƒÉn b·∫£n tr·ªëng');

            if (aiText && this.containsBindingKeywords(aiText)) {
              console.log('üîç Ph√°t hi·ªán t·ª´ kh√≥a tr√≥i bu·ªôc, k√≠ch ho·∫°t QTE');

              return true;
            } else {
              console.log('üîç Kh√¥ng ph√°t hi·ªán t·ª´ kh√≥a tr√≥i bu·ªôc, kh√¥ng k√≠ch ho·∫°t QTE');
            }

            return false;
          } catch (error) {
            console.error('‚ùå Ph√°t hi·ªán ƒëi·ªÅu ki·ªán QTE th·∫•t b·∫°i:', error);

            return false;
          }
        }

        getLastAIText() {
          try {

            if (typeof TavernHelper !== 'undefined' && TavernHelper.getChatMessages) {
              const messages = TavernHelper.getChatMessages();

              const aiMessages = messages.filter(msg => msg.role === 'assistant');

              const lastMessage = aiMessages[aiMessages.length - 1];

              if (lastMessage && lastMessage.content) {
                console.log('üîç L·∫•y vƒÉn b·∫£n AI th√†nh c√¥ng, ƒë·ªô d√†i:', lastMessage.content.length);

                return lastMessage.content;
              }
            }

            const aiResponseElements = document.querySelectorAll('.mes_text, .mes_text_ai, .ai-response');

            if (aiResponseElements.length > 0) {
              const lastElement = aiResponseElements[aiResponseElements.length - 1];

              const text = lastElement.textContent || lastElement.innerText || '';

              console.log('üîç L·∫•y vƒÉn b·∫£n AI th√†nh c√¥ng, ƒë·ªô d√†i:', text.length);

              return text;
            }

            const chatContainer = document.querySelector('#chat_container, .chat-container');

            if (chatContainer) {
              const aiMessages = chatContainer.querySelectorAll('.mes_text, .mes_text_ai');

              if (aiMessages.length > 0) {
                const lastMessage = aiMessages[aiMessages.length - 1];

                const text = lastMessage.textContent || lastMessage.innerText || '';

                console.log('üîç L·∫•y vƒÉn b·∫£n AI th√†nh c√¥ng, ƒë·ªô d√†i:', text.length);

                return text;
              }
            }

            console.log('üîç L·∫•y vƒÉn b·∫£n AI th·∫•t b·∫°i');

            return '';
          } catch (error) {
            console.warn('L·∫•y vƒÉn b·∫£n AI th·∫•t b·∫°i:', error);

            return '';
          }
        }

        manualCheckQTE() {
          console.log('üîç Ph√°t hi·ªán QTE th·ªß c√¥ng...');

          this.checkQTEFromCurrentContent();
        }

        checkQTEFromCurrentContent() {
          try {

            const aiContent =
              $('#chat_container .mes_text_ai').last().text() ||
              $('#chat_container .mes_text').last().text() ||
              $('.ai-response').last().text() ||
              '';

            console.log('üîç ƒê·ªô d√†i n·ªôi dung AI hi·ªán t·∫°i:', aiContent.length);

            if (aiContent && this.containsBindingKeywords(aiContent)) {
              console.log('üîç Ph√°t hi·ªán t·ª´ kh√≥a tr√≥i bu·ªôc, hi·ªÉn th·ªã QTE');

              $('#qte-section').show();

              $('#qte-section .qte-description').text('B·∫°n b·ªã Uma Musume tr√≥i bu·ªôc! Ch·ªçn h√†nh ƒë·ªông c·ªßa b·∫°n...');
            } else {
              console.log('üîç Kh√¥ng ph√°t hi·ªán t·ª´ kh√≥a tr√≥i bu·ªôc, ·∫©n QTE');

              $('#qte-section').hide();
            }
          } catch (error) {
            console.error('‚ùå Ph√°t hi·ªán QTE th·∫•t b·∫°i:', error);
          }
        }

        containsBindingKeywords(text) {
          const keywords = [

          'Tr√≥i bu·ªôc',

          '√îm ch·∫∑t',

          'N·∫Øm l·∫•y',

          '√îm',

          '√îm ch·∫∑t',

          'Giam c·∫ßm',

          '√Åp ch·∫ø',

          'Bao tr√πm',

          'Giam c·∫ßm',

          'Kh√≥a l·∫°i',

          'Chi·∫øm ƒëo·∫°t',

          'C·ª©ng r·∫Øn',

          'Ch·∫∑n l·∫°i',

          'V√¢y quanh',

          'Khoanh v√πng',

          'Qu·∫•n l·∫•y',

          'Tr√≥i l·∫°i',

          '·∫§n xu·ªëng',

          'ƒê√® xu·ªëng',

          'Gi·ªØ ch·∫∑t',

          'K·∫πp ch·∫∑t',

          'K·∫πt l·∫°i',

          'K·∫πt',

          'M·∫Øc k·∫πt',

          'B·ªã nh·ªët',

          'ƒê√® b·∫°n xu·ªëng',

          'Kh√¥ng cho ph·∫£n kh√°ng',

          'Kh√¥ng th·ªÉ tho√°t ra',

          'Nh·ªët b·∫°n l·∫°i',

          '√Åp ch·∫ø b·∫°n',

          '√îm ch·∫∑t l·∫•y',

          '√îm l·∫•y b·∫°n',

          '√îm b·∫°n',

          'N·∫Øm l·∫•y b·∫°n',

          'Nh·ªët b·∫°n l·∫°i',

          '√Åp ch·∫ø b·∫°n',

          'Kh√≥a b·∫°n l·∫°i',

          'Chi·∫øm ƒëo·∫°t b·∫°n',

          'V√¢y quanh b·∫°n',

          'Khoanh v√πng b·∫°n',

          'Qu·∫•n l·∫•y b·∫°n',

          'Tr√≥i b·∫°n l·∫°i',

          '·∫§n b·∫°n xu·ªëng',

          'ƒê√® b·∫°n xu·ªëng',

          'Gi·ªØ ch·∫∑t b·∫°n',

          'K·∫πp ch·∫∑t b·∫°n',

          'Nh√†o v·ªÅ ph√≠a b·∫°n',

          'B·ªï nh√†o v√†o b·∫°n',

          'Nh√†o l√™n ng∆∞·ªùi b·∫°n',

          'ƒê√® l√™n ng∆∞·ªùi b·∫°n',

          'ƒê√® v·ªÅ ph√≠a b·∫°n',

          'ƒê√® ch·∫∑t b·∫°n',

          '√îm l·∫•y b·∫°n',

          '√îm b·∫°n',

          'N·∫Øm l·∫•y b·∫°n',

          'Nh·ªët b·∫°n l·∫°i',

          '√Åp ch·∫ø b·∫°n',

          'Kh√≥a b·∫°n l·∫°i',

          'Chi·∫øm ƒëo·∫°t b·∫°n',

          'V√¢y quanh b·∫°n',

          'Khoanh v√πng b·∫°n',

          'Qu·∫•n l·∫•y b·∫°n',

          'Tr√≥i b·∫°n l·∫°i',

          '·∫§n b·∫°n xu·ªëng',

          'Gi·ªØ ch·∫∑t b·∫°n',

          'K·∫πp ch·∫∑t b·∫°n',

          'K·∫πt b·∫°n l·∫°i',

          'H√£m b·∫°n l·∫°i',

          'Nh·ªët b·∫°n l·∫°i',

          'ƒê√® b·∫°n xu·ªëng',

          'Kh√¥ng th·ªÉ c·ª≠ ƒë·ªông',

          'Kh√¥ng th·ªÉ di chuy·ªÉn',

          'Kh√¥ng th·ªÉ tho√°t ra',

          'Kh√¥ng th·ªÉ ph·∫£n kh√°ng',

          'Kh√¥ng th·ªÉ tr·ªën tho√°t',

          'Kh√¥ng th·ªÉ tho√°t kh·ªèi',

          'Kh√¥ng th·ªÉ r·ªùi ƒëi',

          'Kh√¥ng th·ªÉ tho√°t th√¢n',

          'Kh√¥ng th·ªÉ tr·ªën tho√°t',

          'Kh√¥ng th·ªÉ tho√°t kh·ªën',

          'Kh√¥ng th·ªÉ tho√°t ra',

          'Kh√¥ng th·ªÉ t√°ch ra',

          'Kh√¥ng th·ªÉ c·ªüi b·ªè',

          'Kh√¥ng th·ªÉ c·ªüi ra',

          'Kh√¥ng th·ªÉ c·ªüi ra',

          'Ch·∫øt c·ª©ng',

          'Ch·∫∑t ch·∫Ω',

          'Ch·∫Øc ch·∫Øn',

          'Ch·∫Øc ch·∫Øn',

          'Ch·∫øt c·ª©ng',

          'Ch·∫∑t ch·∫Ω',

          'Ch·∫øt c·ª©ng √¥m l·∫•y',

          '√îm ch·∫∑t l·∫•y',

          '√îm ch·∫Øc l·∫•y',

          'N·∫Øm ch·∫øt c·ª©ng',

          'N·∫Øm ch·∫∑t l·∫•y',

          'N·∫Øm ch·∫Øc l·∫•y',

          'Nh·ªët ch·∫øt c·ª©ng',

          'Nh·ªët ch·∫∑t l·∫°i',

          'Nh·ªët ch·∫Øc l·∫°i',

          '√Åp ch·∫ø ch·∫øt c·ª©ng',

          '√Åp ch·∫ø ch·∫∑t ch·∫Ω',

          '√Åp ch·∫ø ch·∫Øc ch·∫Øn',

          'Kh√≥a ch·∫øt c·ª©ng',

          'Kh√≥a ch·∫∑t l·∫°i',

          'Kh√≥a ch·∫Øc l·∫°i',

          'Kh√¥ng cho ph·∫£n kh√°ng',

          'Kh√¥ng cho t·ª´ ch·ªëi',

          'Kh√¥ng cho tr·ªën tho√°t',

          'Kh√¥ng cho r·ªùi ƒëi',

          'Kh√¥ng cho tho√°t th√¢n',

          'C∆∞·ª°ng √©p',

          'C∆∞·ª°ng ch·∫ø',

          'C∆∞·ª°ng √©p b·∫°n',

          'C∆∞·ª°ng ch·∫ø b·∫°n',

          'B·ª©c √©p',

          'B·ª©c √©p b·∫°n',

          'ƒêe d·ªça',

          'ƒêe d·ªça b·∫°n',

          'Kh·ªßng b·ªë',

          'Kh·ªßng b·ªë b·∫°n',

          'Uy hi·∫øp',

          'Uy hi·∫øp b·∫°n',

          '√âp v√†o t∆∞·ªùng',

          '√âp b·∫°n v√†o t∆∞·ªùng',

          '√âp ch·∫∑t b·∫°n v√†o t∆∞·ªùng',

          '√âp ch·∫∑t v√†o t∆∞·ªùng',

          'D·ªìn √©p b·∫°n v√†o t∆∞·ªùng',

          'ƒê·∫©y ng√£',

          'ƒê·∫©y ng√£ b·∫°n',

          'ƒê·∫©y ng√£ b·∫°n',

          'ƒê·∫©y ng√£ xu·ªëng',

          'ƒê·∫©y ng√£ b·∫°n xu·ªëng',

          'ƒê√® xu·ªëng',

          'ƒê√® b·∫°n xu·ªëng',

          'ƒê√® b·∫°n xu·ªëng',

          'ƒê√® xu·ªëng ƒë·∫•t',

          'ƒê√® b·∫°n xu·ªëng ƒë·∫•t',

          'S·ª©c m·∫°nh c·ªßa Uma Musume',

          'S·ª©c m·∫°nh c·ªßa Super Uma Musume',

          'S·ª©c l·ª±c c·ªßa Uma Musume',

          'S·ª©c l·ª±c c·ªßa Super Uma Musume',

          'C√°i √¥m c·ªßa Uma Musume',

          'C√°i √¥m c·ªßa Super Uma Musume',

          'V√≤ng tay c·ªßa Uma Musume',

          'V√≤ng tay c·ªßa Super Uma Musume',

          'S·ª± tr√≥i bu·ªôc c·ªßa Uma Musume',

          'S·ª± tr√≥i bu·ªôc c·ªßa Super Uma Musume',

          'S·ª± √°p ch·∫ø c·ªßa Uma Musume',

          'S·ª± √°p ch·∫ø c·ªßa Super Uma Musume',

          'ƒê√® b·∫°n d∆∞·ªõi th√¢n',

          'ƒê√® b·∫°n b√™n d∆∞·ªõi',

          'ƒê√® b·∫°n d∆∞·ªõi th√¢n',

          'ƒê√® b·∫°n d∆∞·ªõi th√¢n',

          '√îm b·∫°n v√†o l√≤ng',

          '√îm b·∫°n trong l√≤ng',

          'Nh·ªët b·∫°n trong l√≤ng',

          'Kh√≥a b·∫°n trong l√≤ng',

          'ƒê√® b·∫°n l√™n t∆∞·ªùng',

          'Nh·ªët b·∫°n v√†o t∆∞·ªùng',

          'Kh√≥a b·∫°n v√†o t∆∞·ªùng',

          'ƒê√® b·∫°n l√™n c·ª≠a',

          'Nh·ªët b·∫°n v√†o c·ª≠a',

          'Kh√≥a b·∫°n v√†o c·ª≠a',

          'ƒê√® b·∫°n l√™n gi∆∞·ªùng',

          'Nh·ªët b·∫°n tr√™n gi∆∞·ªùng',

          'Kh√≥a b·∫°n tr√™n gi∆∞·ªùng',

          'ƒê√® b·∫°n l√™n sofa',

          'Nh·ªët b·∫°n tr√™n sofa',

          'Kh√≥a b·∫°n tr√™n sofa',

          'Lu√¥n',

          'Lu√¥n √¥m',

          'Lu√¥n √¥m',

          'Lu√¥n n·∫Øm',

          'Lu√¥n nh·ªët',

          'Lu√¥n ƒë√®',

          'Lu√¥n kh√≥a',

          'Lu√¥n ·∫•n',

          'Lu√¥n gi·ªØ',

          'Lu√¥n k·∫πp',

          'Ti·∫øp t·ª•c',

          'Ti·∫øp t·ª•c √¥m',

          'Ti·∫øp t·ª•c √¥m',

          'Ti·∫øp t·ª•c n·∫Øm',

          'Ti·∫øp t·ª•c nh·ªët',

          'Ti·∫øp t·ª•c ƒë√®',

          'Ti·∫øp t·ª•c kh√≥a',

          'Ti·∫øp t·ª•c ·∫•n',

          'Ti·∫øp t·ª•c gi·ªØ',

          'Ti·∫øp t·ª•c k·∫πp',

          'Ho√†n to√†n',

          'Ho√†n to√†n tr√≥i bu·ªôc',

          'Ho√†n to√†n √¥m l·∫•y',

          'Ho√†n to√†n n·∫Øm l·∫•y',

          'Ho√†n to√†n nh·ªët l·∫°i',

          'Ho√†n to√†n √°p ch·∫ø',

          'Ho√†n to√†n kh√≥a l·∫°i',

          'Ho√†n to√†n chi·∫øm ƒëo·∫°t',

          'Ho√†n to√†n v√¢y quanh',

          'Ho√†n to√†n khoanh v√πng',

          'Tri·ªát ƒë·ªÉ',

          'Tri·ªát ƒë·ªÉ tr√≥i bu·ªôc',

          'Tri·ªát ƒë·ªÉ √¥m l·∫•y',

          'Tri·ªát ƒë·ªÉ n·∫Øm l·∫•y',

          'Tri·ªát ƒë·ªÉ nh·ªët l·∫°i',

          'Tri·ªát ƒë·ªÉ √°p ch·∫ø',

          'Tri·ªát ƒë·ªÉ kh√≥a l·∫°i',

          'Tri·ªát ƒë·ªÉ chi·∫øm ƒëo·∫°t',

          'Tri·ªát ƒë·ªÉ v√¢y quanh',

          'Tri·ªát ƒë·ªÉ khoanh v√πng',

          'Kh√¥ng ƒë·ªÉ b·∫°n',

          'Kh√¥ng ƒë·ªÉ b·∫°n ƒë·ªông ƒë·∫≠y',

          'Kh√¥ng ƒë·ªÉ b·∫°n ƒëi',

          'Kh√¥ng ƒë·ªÉ b·∫°n r·ªùi ƒëi',

          'Kh√¥ng ƒë·ªÉ b·∫°n tr·ªën tho√°t',

          'Kh√¥ng ƒë·ªÉ b·∫°n tho√°t ra',

          'Kh√¥ng ƒë·ªÉ b·∫°n ph·∫£n kh√°ng',

          'Kh√¥ng ƒë·ªÉ b·∫°n t·ª´ ch·ªëi',

          'Kh√¥ng ƒë·ªÉ b·∫°n tho√°t th√¢n',

          'NgƒÉn c·∫£n b·∫°n',

          'NgƒÉn c·∫£n b·∫°n ƒë·ªông ƒë·∫≠y',

          'NgƒÉn c·∫£n b·∫°n ƒëi',

          'NgƒÉn c·∫£n b·∫°n r·ªùi ƒëi',

          'NgƒÉn c·∫£n b·∫°n tr·ªën tho√°t',

          'NgƒÉn c·∫£n b·∫°n tho√°t ra',

          'NgƒÉn c·∫£n b·∫°n ph·∫£n kh√°ng',

          'NgƒÉn c·∫£n b·∫°n t·ª´ ch·ªëi',

          'NgƒÉn c·∫£n b·∫°n tho√°t th√¢n',

          'Kh√¥ng ƒë∆∞·ª£c c·ª≠ ƒë·ªông',

          'Kh√¥ng ƒë∆∞·ª£c ƒëi',

          'Kh√¥ng ƒë∆∞·ª£c r·ªùi ƒëi',

          'Kh√¥ng ƒë∆∞·ª£c tr·ªën tho√°t',

          'Kh√¥ng ƒë∆∞·ª£c tho√°t ra',

          'Kh√¥ng ƒë∆∞·ª£c ph·∫£n kh√°ng',

          'Kh√¥ng ƒë∆∞·ª£c t·ª´ ch·ªëi',

          'Kh√¥ng ƒë∆∞·ª£c tho√°t th√¢n',

          'C·∫•m c·ª≠ ƒë·ªông',

          'C·∫•m ƒëi',

          'C·∫•m r·ªùi ƒëi',

          'C·∫•m tr·ªën tho√°t',

          'C·∫•m tho√°t ra',

          'C·∫•m ph·∫£n kh√°ng',

          'C·∫•m t·ª´ ch·ªëi',

          'C·∫•m tho√°t th√¢n',

          'Kh√¥ng th·ªÉ c·ª≠ ƒë·ªông',

          'Kh√¥ng th·ªÉ ƒëi',

          'Kh√¥ng th·ªÉ r·ªùi ƒëi',

          'Kh√¥ng th·ªÉ tr·ªën tho√°t',

          'Kh√¥ng th·ªÉ tho√°t ra',

          'Kh√¥ng th·ªÉ ph·∫£n kh√°ng',

          'Kh√¥ng th·ªÉ t·ª´ ch·ªëi',

          'Kh√¥ng th·ªÉ tho√°t th√¢n',
          ];

          const matchedKeywords = keywords.filter(keyword => text.includes(keyword));

          if (matchedKeywords.length > 0) {
            console.log('üîç T·ª´ kh√≥a kh·ªõp:', matchedKeywords);

            return true;
          } else {
            console.log('üîç Kh√¥ng kh·ªõp b·∫•t k·ª≥ t·ª´ kh√≥a n√†o');

            return false;
          }
        }

        async triggerQTE(action) {
          try {
            console.log(`üéÆ K√≠ch ho·∫°t QTE th√∫ v·ªã: ${action}`);

            let qteCommand = '';

            if (action === 'struggle') {

              qteCommand = `C·ªë g·∫Øng v√πng v·∫´y, th·ª≠ tho√°t kh·ªèi tr√≥i bu·ªôc`;
            } else if (action === 'submit') {

              qteCommand = `Ch·ªçn kh√¥ng ph·∫£n kh√°ng, ch·∫•p nh·∫≠n hi·ªán tr·∫°ng`;
            }

            if (qteCommand) {

              $('#action-input').val(qteCommand);

              console.log('‚úÖ L·ªánh QTE th√∫ v·ªã ƒë√£ ƒëi·ªÅn v√†o √¥ nh·∫≠p:', qteCommand);
            }

            this.checkQTEFromCurrentContent();
          } catch (error) {
            console.error('‚ùå K√≠ch ho·∫°t QTE th√∫ v·ªã th·∫•t b·∫°i:', error);
          }
        }

        getAutoSaves() {
          const autoSaves = [];

          try {
            console.log('üîç B·∫Øt ƒë·∫ßu l·∫•y danh s√°ch l∆∞u t·ª± ƒë·ªông...');

            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);

              if (key && key.startsWith('teresen-auto-save-')) {
                const data = localStorage.getItem(key);

                if (data) {
                  try {
                    const saveData = JSON.parse(data);

                    autoSaves.push({
                      key: key,

                      data: saveData,
                    });

                    console.log(
                      `üìÅ T√¨m th·∫•y l∆∞u t·ª± ƒë·ªông: ${key}, Th·ªùi gian: ${new Date(saveData.timestamp).toLocaleString('vi-VN')}`,
                    );
                  } catch (parseError) {
                    console.warn(`‚ùå Ph√¢n t√≠ch l∆∞u t·ª± ƒë·ªông th·∫•t b·∫°i: ${key}`, parseError);
                  }
                }
              }
            }

            autoSaves.sort((a, b) => b.data.timestamp - a.data.timestamp);

            console.log(`üìä T·ªïng c·ªông t√¨m th·∫•y ${autoSaves.length} b·∫£n l∆∞u t·ª± ƒë·ªông`);

            const result = autoSaves.slice(0, 10);

            console.log(`üìã Tr·∫£ v·ªÅ ${result.length} b·∫£n l∆∞u t·ª± ƒë·ªông g·∫ßn nh·∫•t`);

            return result;
          } catch (error) {
            console.warn('L·∫•y danh s√°ch l∆∞u t·ª± ƒë·ªông th·∫•t b·∫°i:', error);

            return [];
          }
        }

        async loadAutoSave(saveKey) {
          try {
            console.log('üìÇ T·∫£i l∆∞u t·ª± ƒë·ªông:', saveKey);

            const saveData = localStorage.getItem(saveKey);

            if (!saveData) {
              throw new Error('L∆∞u t·ª± ƒë·ªông kh√¥ng t·ªìn t·∫°i');
            }

            const save = JSON.parse(saveData);

            console.log('üìÑ C·∫•u tr√∫c d·ªØ li·ªáu l∆∞u tr·ªØ:', save);
            if (save.timeline_history && Array.isArray(save.timeline_history) && save.timeline_history.length > 0) {
              console.log('üîÑ Kh√¥i ph·ª•c l·ªãch s·ª≠ snapshot v√≤ng ch∆°i (' + save.timeline_history.length + ' v√≤ng)...');
              this.chatHistoryCache = JSON.parse(JSON.stringify(save.timeline_history));
              localStorage.setItem(this._getHistoryKey(), JSON.stringify(this.chatHistoryCache));
              this.historyViewIndex = this.chatHistoryCache.length - 1;
              const lastSnapshot = this.chatHistoryCache[this.chatHistoryCache.length - 1];
              if (
                lastSnapshot &&
                lastSnapshot.message &&
                typeof SillyTavern !== 'undefined' &&
                SillyTavern.chat &&
                SillyTavern.chat.length > 0
              ) {
                try {
                  const lastMessage = SillyTavern.chat[SillyTavern.chat.length - 1];
                  if (!lastMessage.extra) {
                    lastMessage.extra = {};
                  }
                  if (save.timeline_history && save.timeline_history.length > 0) {
                    lastMessage.extra.teresen_chat = save.timeline_history.map(snapshot => ({
                      role: 'assistant',
                      content: snapshot.message || '',
                      id: snapshot.message_id || `snapshot_${Date.now()}`,
                      timestamp: snapshot.timestamp || Date.now(),
                      variableState: snapshot.data || null,
                    }));
                  } else if (lastSnapshot) {
                    lastMessage.extra.teresen_chat = [
                      {
                        role: 'assistant',
                        content: lastSnapshot.message || '',
                        id: 'load_' + Date.now(),
                        timestamp: Date.now(),
                        variableState: lastSnapshot.data || null,
                      },
                    ];
                  }
                  if (lastSnapshot && lastSnapshot.data) {
                    lastMessage.data = lastSnapshot.data;
                  }

                  if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
                    await SillyTavern.saveChat();
                  } else {
                    await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });
                  }
                  if (typeof this.updateInterface === 'function') {
                    await this.updateInterface();
                  }
                } catch (e) {
                  console.warn('Kh√¥i ph·ª•c tin nh·∫Øn tr√≤ chuy·ªán th·∫•t b·∫°i:', e);
                }
              }

              console.log('‚úÖ L·ªãch s·ª≠ snapshot v√≤ng ch∆°i ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c (' + save.timeline_history.length + ' v√≤ng)');
            }
            else if (save.chat_history && Array.isArray(save.chat_history) && save.chat_history.length > 0) {
              console.log('üîÑ Kh√¥i ph·ª•c l·ªãch s·ª≠ tr√≤ chuy·ªán ƒë·∫ßy ƒë·ªß (ƒë·ªãnh d·∫°ng c≈©) (' + save.chat_history.length + ' tin nh·∫Øn)...');

              if (
                'function' == typeof getChatMessages &&
                'undefined' != typeof TavernHelper &&
                TavernHelper.setChatMessages
              ) {
                await TavernHelper.setChatMessages(save.chat_history, { refresh: 'full' });
                if (typeof this.updateInterface === 'function') {
                  await this.updateInterface();
                }
                console.log('‚úÖ L·ªãch s·ª≠ tr√≤ chuy·ªán ƒë·∫ßy ƒë·ªß ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c (' + save.chat_history.length + ' tin nh·∫Øn)');
              }
            }
            else if (save.message_content) {
              console.log('‚ö†Ô∏è S·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng l∆∞u tr·ªØ phi√™n b·∫£n c≈©, ch·ªâ kh√¥i ph·ª•c tin nh·∫Øn ƒë∆°n l·∫ª');
              if (typeof SillyTavern !== 'undefined' && SillyTavern.chat && SillyTavern.chat.length > 0) {
                const lastMessage = SillyTavern.chat[SillyTavern.chat.length - 1];
                if (!lastMessage.extra) {
                  lastMessage.extra = {};
                }

                lastMessage.extra.teresen_chat = [
                  {
                    role: 'assistant',
                    content: save.message_content || '',
                    id: 'load_' + Date.now(),
                    timestamp: Date.now(),
                    variableState: null,
                  },
                ];

                if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
                  await SillyTavern.saveChat();
                  console.log('‚úÖ Tin nh·∫Øn ƒë∆°n l·∫ª ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c v√†o extra.teresen_chat (ƒë·ªãnh d·∫°ng phi√™n b·∫£n c≈©)');
                } else if (typeof TavernHelper !== 'undefined' && TavernHelper.setChatMessages) {
                  await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });
                  console.log('‚úÖ Tin nh·∫Øn ƒë∆°n l·∫ª ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c v√†o extra.teresen_chat (ch∆∞a c·∫≠p nh·∫≠t tr∆∞·ªùng message)');
                }
                if (typeof this.updateInterface === 'function') {
                  await this.updateInterface();
                }
              }
            }
            if (save.snapshot_data && save.snapshot_data.mvu_data) {
              this.currentMvuState = save.snapshot_data.mvu_data;
              this.renderUI(this.currentMvuState.stat_data);
              console.log('‚úÖ Tr·∫°ng th√°i tr√≤ ch∆°i ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c');
            } else if (save.mvu_data && 'function' == typeof eventEmit) {
              this.currentMvuState = save.mvu_data;
              this.renderUI(this.currentMvuState.stat_data);
              console.log('‚úÖ Tr·∫°ng th√°i tr√≤ ch∆°i ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c (ƒë·ªãnh d·∫°ng c≈©)');
            }
            if (save.snapshot_data && save.snapshot_data.lorebook_content) {
              const bookName = '- Uma Musume: Chuy·ªán l·∫° Tracen';
              const baseJourneyKey = this._getBaseJourneyKey();
              const baseCoreKey = this._getBaseCoreMemoryKey();

              try {
                const allEntries = await TavernHelper.getLorebookEntries(bookName);
                const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);
                const coreEntry = allEntries.find(entry => entry.comment === baseCoreKey);
                const entriesToDisable = [];
                for (const entry of allEntries) {
                  const isJourneyEntry = entry.comment.startsWith('Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y');
                  const isCoreEntry = entry.comment.startsWith('K√Ω ·ª©c c·ªët l√µi v√≤ng l·∫∑p n√†y');
                  if (!isJourneyEntry && !isCoreEntry) continue;

                  const isCurrentJourney = entry.comment === baseJourneyKey;
                  const isCurrentCore = entry.comment === baseCoreKey;
                  if (!isCurrentJourney && !isCurrentCore && entry.enabled) {
                    entriesToDisable.push({ uid: entry.uid, enabled: false });
                  }
                }

                if (entriesToDisable.length > 0) {
                  await TavernHelper.setLorebookEntries(bookName, entriesToDisable);
                  console.log(`‚úÖ ƒê√£ v√¥ hi·ªáu h√≥a ${entriesToDisable.length} m·ª•c S√°ch th·∫ø gi·ªõi c·ªßa c√°c v√≤ng l·∫∑p kh√°c`);
                }
                if (journeyEntry) {
                  await TavernHelper.setLorebookEntries(bookName, [
                    {
                      uid: journeyEntry.uid,
                      content: save.snapshot_data.lorebook_content.journey || '',
                      enabled: true, 
                    },
                  ]);
                  console.log(`‚úÖ "${baseJourneyKey}" ƒë√£ kh√¥i ph·ª•c v√† k√≠ch ho·∫°t, AI b√¢y gi·ªù c√≥ th·ªÉ nh·ªõ nh·ªØng s·ª± vi·ªác tr∆∞·ªõc ƒë√≥`);
                } else {
                  console.warn(`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y m·ª•c "${baseJourneyKey}", kh√¥ng th·ªÉ kh√¥i ph·ª•c`);
                }
                if (coreEntry && save.snapshot_data.lorebook_content.core_memory) {
                  await TavernHelper.setLorebookEntries(bookName, [
                    {
                      uid: coreEntry.uid,
                      content: save.snapshot_data.lorebook_content.core_memory,
                      enabled: true, 
                    },
                  ]);
                  console.log(`‚úÖ "${baseCoreKey}" ƒë√£ kh√¥i ph·ª•c v√† k√≠ch ho·∫°t, AI b√¢y gi·ªù c√≥ th·ªÉ nh·ªõ c·ªët truy·ªán ch√≠nh`);
                } else {
                  console.warn(`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y m·ª•c "${baseCoreKey}" ho·∫∑c n·ªôi dung tr·ªëng`);
                }

                console.log('‚úÖ Ch·ª©c nƒÉng k√Ω ·ª©c S√°ch th·∫ø gi·ªõi ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c! AI b√¢y gi·ªù c√≥ th·ªÉ nh·ªõ t·∫•t c·∫£ k√Ω ·ª©c khi l∆∞u tr·ªØ');
              } catch (e) {
                console.error('‚ùå Kh√¥i ph·ª•c n·ªôi dung S√°ch th·∫ø gi·ªõi th·∫•t b·∫°i:', e);
              }
            } else if (save.lorebook_content) {
              const bookName = '- Uma Musume: Chuy·ªán l·∫° Tracen';
              const baseJourneyKey = this._getBaseJourneyKey();
              const baseCoreKey = this._getBaseCoreMemoryKey();

              try {
                const allEntries = await TavernHelper.getLorebookEntries(bookName);
                const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);
                const coreEntry = allEntries.find(entry => entry.comment === baseCoreKey);

                if (journeyEntry && save.lorebook_content.journey) {
                  await TavernHelper.setLorebookEntries(bookName, [
                    {
                      uid: journeyEntry.uid,
                      content: save.lorebook_content.journey,
                      enabled: true,
                    },
                  ]);
                }

                if (coreEntry && save.lorebook_content.core_memory) {
                  await TavernHelper.setLorebookEntries(bookName, [
                    {
                      uid: coreEntry.uid,
                      content: save.lorebook_content.core_memory,
                      enabled: true,
                    },
                  ]);
                }

                console.log('‚úÖ Ch·ª©c nƒÉng k√Ω ·ª©c S√°ch th·∫ø gi·ªõi ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c (ƒë·ªãnh d·∫°ng c≈©)!');
              } catch (e) {
                console.error('‚ùå Kh√¥i ph·ª•c n·ªôi dung S√°ch th·∫ø gi·ªõi th·∫•t b·∫°i (ƒë·ªãnh d·∫°ng c≈©):', e);
              }
            }

            await this.updateInterface();

            $('#saveManagerModal').hide();

            console.log('‚úÖ T·∫£i l∆∞u t·ª± ƒë·ªông th√†nh c√¥ng');

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('T·∫£i l∆∞u t·ª± ƒë·ªông th√†nh c√¥ng! AI b√¢y gi·ªù c√≥ th·ªÉ nh·ªõ c√°c cu·ªôc tr√≤ chuy·ªán tr∆∞·ªõc ƒë√≥.');
            }
          } catch (error) {
            console.error('‚ùå T·∫£i l∆∞u t·ª± ƒë·ªông th·∫•t b·∫°i:', error);

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('T·∫£i l∆∞u t·ª± ƒë·ªông th·∫•t b·∫°i!');
            }
          }
        }

        debugSaves() {
          console.log('üîç G·ª° l·ªói ch·ª©c nƒÉng l∆∞u tr·ªØ...');

          const allSaves = [];

          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);

            if (key && (key === 'teresen-save' || key.startsWith('teresen-auto-save-'))) {
              try {
                const data = localStorage.getItem(key);

                const save = JSON.parse(data);

                allSaves.push({
                  key: key,

                  save: save,
                });
              } catch (error) {
                console.warn('Ph√¢n t√≠ch l∆∞u tr·ªØ th·∫•t b·∫°i:', key, error);
              }
            }
          }

          console.log('üìä T·∫•t c·∫£ l∆∞u tr·ªØ:', allSaves);

          const manualSaves = allSaves.filter(s => s.key === 'teresen-save');

          const autoSaves = allSaves.filter(s => s.key.startsWith('teresen-auto-save-'));

          console.log('üìã Th·ªëng k√™ l∆∞u tr·ªØ:');

          console.log('  L∆∞u th·ªß c√¥ng:', manualSaves.length, 'c√°i');

          console.log('  L∆∞u t·ª± ƒë·ªông:', autoSaves.length, 'c√°i');

          allSaves.forEach((saveInfo, index) => {
            console.group(`L∆∞u Tr·ªØ ${index + 1}: ${saveInfo.key}`);

            console.log('D·ªØ li·ªáu l∆∞u tr·ªØ:', saveInfo.save);

            if (saveInfo.save.data) {
              console.log('Th·ªùi gian l∆∞u:', new Date(saveInfo.save.timestamp).toLocaleString('vi-VN'));

              console.log('T√™n l∆∞u tr·ªØ:', saveInfo.save.saveName);

              console.log('Lo·∫°i l∆∞u tr·ªØ:', saveInfo.save.type);
            }

            console.groupEnd();
          });

          const autoSavesList = this.getAutoSaves();

          console.log('üîß Ki·ªÉm tra ch·ª©c nƒÉng danh s√°ch l∆∞u t·ª± ƒë·ªông:', autoSavesList);
        }

        debugCommands() {
          console.log('‚ö° G·ª° l·ªói h·ªá th·ªëng t∆∞∆°ng t√°c ch·ªâ th·ªã...');

          const actionInput = document.getElementById('action-input');

          console.log('√î nh·∫≠p ch·ªâ th·ªã:', actionInput);

          const sendBtn = document.querySelector('.send-button, #send-btn, button[onclick*="handleActionSubmit"]');

          console.log('N√∫t g·ª≠i:', sendBtn);

          console.log('Ch·ªâ th·ªã g·ª≠i cu·ªëi c√πng:', this.lastSentPrompt);

          const chatContainer = document.getElementById('chat_container');

          console.log('Container tr√≤ chuy·ªán:', chatContainer);
        }

        debugAutoSaves() {
          console.log('üíæ G·ª° l·ªói h·ªá th·ªëng l∆∞u t·ª± ƒë·ªông...');

          const allAutoSaves = [];

          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);

            if (key && key.startsWith('teresen-auto-save-')) {
              try {
                const data = localStorage.getItem(key);

                const saveData = JSON.parse(data);

                allAutoSaves.push({
                  key: key,

                  timestamp: saveData.timestamp,

                  time: new Date(saveData.timestamp).toLocaleString('zh-CN'),

                  saveName: saveData.saveName,
                });
              } catch (error) {
                console.warn(`Ph√¢n t√≠ch l∆∞u tr·ªØ th·∫•t b·∫°i: ${key}`, error);
              }
            }
          }

          allAutoSaves.sort((a, b) => b.timestamp - a.timestamp);

          console.log('üìä T·∫•t c·∫£ l∆∞u t·ª± ƒë·ªông:');

          allAutoSaves.forEach((save, index) => {
            console.log(`${index + 1}. ${save.key} - ${save.time} - ${save.saveName}`);
          });

          console.log(`üìà T·ªïng c·ªông: ${allAutoSaves.length} b·∫£n l∆∞u t·ª± ƒë·ªông`);

          const recentSaves = this.getAutoSaves();

          console.log('üìã getAutoSaves tr·∫£ v·ªÅ:', recentSaves.length, 'c√°i');
        }
        getSavesFromStorage() {
          try {
            const chatId = TavernHelper?.chatId || 'default';
            const autoSaveKey = `teresen_auto_save_${chatId}`;
            const manualSaveKey = 'teresen_multi_save_data';

            let allSaves = {};
            try {
              const manualSaves = localStorage.getItem(manualSaveKey);
              if (manualSaves) {
                allSaves = JSON.parse(manualSaves);
              }
            } catch (e) {
              console.warn('[H·ªá th·ªëng l∆∞u tr·ªØ] ƒê·ªçc l∆∞u th·ªß c√¥ng th·∫•t b·∫°i:', e);
            }
            try {
              const autoSaves = localStorage.getItem(autoSaveKey);
              if (autoSaves) {
                const parsedAutoSaves = JSON.parse(autoSaves);
                Object.assign(allSaves, parsedAutoSaves);
              }
            } catch (e) {
              console.warn('[H·ªá th·ªëng l∆∞u tr·ªØ] ƒê·ªçc l∆∞u t·ª± ƒë·ªông th·∫•t b·∫°i:', e);
            }

            return allSaves;
          } catch (e) {
            console.error('L·∫•y l∆∞u tr·ªØ th·∫•t b·∫°i:', e);
            return {};
          }
        }
        async promptForSaveName(defaultName) {
          return new Promise(resolve => {
            try {
              const overlay = document.createElement('div');
              overlay.style.cssText =
                'position: fixed; inset: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100005; display: flex; align-items: center; justify-content: center;';
              overlay.id = 'save-name-overlay';
              const modal = document.createElement('div');
              modal.style.cssText =
                'background: linear-gradient(135deg, #2d1b1b, #3d2b2b); border: 2px solid #8b7355; border-radius: 8px; padding: 0; width: 450px; max-width: 90vw; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';

              modal.innerHTML = `
                <div style="padding: 20px; border-bottom: 1px solid #8b7355;">
                  <h2 style="margin: 0; color: #e0dcd1; font-size: 18px; font-weight: bold;">ƒê·∫∑t t√™n l∆∞u tr·ªØ</h2>
                </div>
                <div style="padding: 20px;">
                  <p style="margin: 0 0 15px 0; color: #c9aa71; font-size: 14px;">Vui l√≤ng nh·∫≠p t√™n l∆∞u tr·ªØÔºö</p>
                  <input type="text" id="save-name-input" placeholder="${defaultName}"
                         value="${defaultName}"
                         style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid #8b7355;
                                color: #e0dcd1; border-radius: 4px; font-size: 14px; margin-bottom: 15px; box-sizing: border-box;">
                  <p style="font-size: 12px; color: #8b7355; margin: 0 0 20px 0; line-height: 1.5;">
                    S·∫Ω t·∫°o m·ª•c S√°ch th·∫ø gi·ªõi ƒë·ªôc l·∫≠pÔºö<br>
                    ‚Ä¢ <span id="preview-journey" style="color: #c9aa71;">${defaultName}-Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y</span>
                  </p>
                  <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="save-name-cancel" class="interaction-btn" style="padding: 8px 16px; min-width: 80px; background: linear-gradient(135deg, #3d2b2b, #4d3b3b); border: 1px solid #8b7355; color: #e0dcd1; cursor: pointer;">H·ªßy</button>
                    <button id="save-name-confirm" class="interaction-btn primary-btn" style="padding: 8px 16px; min-width: 80px; background: linear-gradient(135deg, #8b4513, #a0522d); border: 1px solid #8b7355; color: #f0e6d2; cursor: pointer; font-weight: bold;">X√°c nh·∫≠n</button>
                  </div>
                </div>
              `;

              overlay.appendChild(modal);
              const parent = document.getElementById('teresen-fullscreen-overlay') || document.body;
              parent.appendChild(overlay);

              const input = modal.querySelector('#save-name-input');
              const previewJourney = modal.querySelector('#preview-journey');
              const confirmBtn = modal.querySelector('#save-name-confirm');
              const cancelBtn = modal.querySelector('#save-name-cancel');
              overlay.addEventListener('click', e => {
                if (e.target === overlay) {
                  if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                  resolve(null);
                }
              });
              if (input && previewJourney) {
                input.addEventListener('input', e => {
                  const name = e.target.value.trim() || defaultName;
                  previewJourney.textContent = `${name}-Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y`;
                });
              }
              if (confirmBtn) {
                confirmBtn.addEventListener('click', () => {
                  const name = input?.value?.trim() || defaultName;
                  if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                  resolve(name);
                });
              }
              if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                  if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                  resolve(null);
                });
              }
              if (input) {
                input.addEventListener('keydown', e => {
                  if (e.key === 'Enter') {
                    e.preventDefault();
                    const name = input.value.trim() || defaultName;
                    if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                    resolve(name);
                  } else if (e.key === 'Escape') {
                    e.preventDefault();
                    if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                    resolve(null);
                  }
                });
                setTimeout(() => {
                  input.focus();
                  input.select();
                }, 50);
              }
            } catch (error) {
              console.error('T·∫°o h·ªôp tho·∫°i ƒë·∫∑t t√™n l∆∞u tr·ªØ th·∫•t b·∫°i:', error);
              resolve(defaultName);
            }
          });
        }
        async showFullscreenAlert(message, options = {}) {
          return new Promise(resolve => {
            try {
              const { title = 'G·ª£i √Ω', icon = '‚ÑπÔ∏è', okText = 'X√°c nh·∫≠n' } = options || {};
              const parent = document.getElementById('teresen-fullscreen-overlay') || document.body;

              const overlay = document.createElement('div');
              overlay.id = `teresen-alert-overlay-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
              overlay.style.cssText = `
                position: fixed;
                inset: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.7);
                z-index: 100005;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 16px;
                box-sizing: border-box;
              `;

              const modal = document.createElement('div');
              modal.style.cssText = `
                background: linear-gradient(135deg, #2d1b1b, #3d2b2b);
                border: 2px solid #8b7355;
                border-radius: 10px;
                width: 520px;
                max-width: 95vw;
                box-shadow: 0 12px 40px rgba(0,0,0,0.6);
                overflow: hidden;
              `;

              const header = document.createElement('div');
              header.style.cssText = `
                padding: 16px 18px;
                border-bottom: 1px solid rgba(139, 115, 85, 0.7);
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
              `;

              const h = document.createElement('div');
              h.style.cssText =
                'color: #e0dcd1; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px;';
              const iconSpan = document.createElement('span');
              iconSpan.textContent = icon;
              const titleSpan = document.createElement('span');
              titleSpan.textContent = title;
              h.appendChild(iconSpan);
              h.appendChild(titleSpan);

              const closeBtn = document.createElement('button');
              closeBtn.type = 'button';
              closeBtn.textContent = '√ó';
              closeBtn.className = 'interaction-btn';
              closeBtn.style.cssText =
                'width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.18); color: #ffffff; font-size: 18px; cursor: pointer; line-height: 1;';

              header.appendChild(h);
              header.appendChild(closeBtn);

              const body = document.createElement('div');
              body.style.cssText = 'padding: 18px; color: #f0e6d2;';
              const msg = document.createElement('div');
              msg.style.cssText =
                'white-space: pre-wrap; line-height: 1.6; font-size: 14px; color: #f0e6d2; background: rgba(0,0,0,0.25); border: 1px solid rgba(139,115,85,0.35); border-radius: 8px; padding: 12px 14px;';
              msg.textContent = String(message ?? '');
              body.appendChild(msg);

              const footer = document.createElement('div');
              footer.style.cssText =
                'padding: 16px 18px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid rgba(139, 115, 85, 0.35);';
              const okBtn = document.createElement('button');
              okBtn.type = 'button';
              okBtn.className = 'interaction-btn primary-btn';
              okBtn.textContent = okText;
              okBtn.style.cssText =
                'padding: 10px 16px; min-width: 96px; background: linear-gradient(135deg, #8b4513, #a0522d); border: 1px solid #8b7355; color: #f0e6d2; cursor: pointer; font-weight: 700; border-radius: 8px;';
              footer.appendChild(okBtn);

              modal.appendChild(header);
              modal.appendChild(body);
              modal.appendChild(footer);
              overlay.appendChild(modal);
              parent.appendChild(overlay);

              const onKeyDown = e => {
                if (e.key === 'Escape' || e.key === 'Enter') {
                  e.preventDefault();
                  finish();
                }
              };

              const cleanup = () => {
                document.removeEventListener('keydown', onKeyDown, true);
                if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
              };

              const finish = () => {
                cleanup();
                resolve();
              };

              overlay.addEventListener('click', e => {
                if (e.target === overlay) finish();
              });
              closeBtn.addEventListener('click', finish);
              okBtn.addEventListener('click', finish);
              document.addEventListener('keydown', onKeyDown, true);
              setTimeout(() => okBtn.focus(), 0);
            } catch (e) {
              console.warn('showFullscreenAlert failed, fallback to alert:', e);
              alert(String(message ?? ''));
              resolve();
            }
          });
        }
        async showFullscreenConfirm(message, options = {}) {
          return new Promise(resolve => {
            try {
              const {
                title = 'X√°c nh·∫≠n',
                icon = '‚ö†Ô∏è',
                confirmText = 'X√°c nh·∫≠n',
                cancelText = 'H·ªßy',
                danger = false,
              } = options || {};

              const parent = document.getElementById('teresen-fullscreen-overlay') || document.body;
              const overlay = document.createElement('div');
              overlay.id = `teresen-confirm-overlay-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
              overlay.style.cssText = `
                position: fixed;
                inset: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.75);
                z-index: 100005;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 16px;
                box-sizing: border-box;
              `;

              const modal = document.createElement('div');
              modal.style.cssText = `
                background: linear-gradient(135deg, #2d1b1b, #3d2b2b);
                border: 2px solid #8b7355;
                border-radius: 10px;
                width: 560px;
                max-width: 95vw;
                box-shadow: 0 12px 40px rgba(0,0,0,0.65);
                overflow: hidden;
              `;

              const header = document.createElement('div');
              header.style.cssText = `
                padding: 16px 18px;
                border-bottom: 1px solid rgba(139, 115, 85, 0.7);
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
              `;

              const h = document.createElement('div');
              h.style.cssText =
                'color: #e0dcd1; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px;';
              const iconSpan = document.createElement('span');
              iconSpan.textContent = icon;
              const titleSpan = document.createElement('span');
              titleSpan.textContent = title;
              h.appendChild(iconSpan);
              h.appendChild(titleSpan);

              const closeBtn = document.createElement('button');
              closeBtn.type = 'button';
              closeBtn.textContent = '√ó';
              closeBtn.className = 'interaction-btn';
              closeBtn.style.cssText =
                'width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.18); color: #ffffff; font-size: 18px; cursor: pointer; line-height: 1;';

              header.appendChild(h);
              header.appendChild(closeBtn);

              const body = document.createElement('div');
              body.style.cssText = 'padding: 18px; color: #f0e6d2;';
              const msg = document.createElement('div');
              msg.style.cssText =
                'white-space: pre-wrap; line-height: 1.6; font-size: 14px; color: #f0e6d2; background: rgba(0,0,0,0.25); border: 1px solid rgba(139,115,85,0.35); border-radius: 8px; padding: 12px 14px;';
              msg.textContent = String(message ?? '');
              body.appendChild(msg);

              const footer = document.createElement('div');
              footer.style.cssText =
                'padding: 16px 18px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid rgba(139, 115, 85, 0.35);';

              const cancelBtn = document.createElement('button');
              cancelBtn.type = 'button';
              cancelBtn.className = 'interaction-btn';
              cancelBtn.textContent = cancelText;
              cancelBtn.style.cssText =
                'padding: 10px 16px; min-width: 96px; background: linear-gradient(135deg, #3d2b2b, #4d3b3b); border: 1px solid #8b7355; color: #e0dcd1; cursor: pointer; border-radius: 8px;';

              const confirmBtn = document.createElement('button');
              confirmBtn.type = 'button';
              confirmBtn.className = 'interaction-btn primary-btn';
              confirmBtn.textContent = confirmText;
              confirmBtn.style.cssText = `
                padding: 10px 16px;
                min-width: 96px;
                background: ${danger ? 'linear-gradient(135deg, #b91c1c, #dc2626)' : 'linear-gradient(135deg, #8b4513, #a0522d)'};
                border: 1px solid #8b7355;
                color: #f0e6d2;
                cursor: pointer;
                font-weight: 700;
                border-radius: 8px;
              `;

              footer.appendChild(cancelBtn);
              footer.appendChild(confirmBtn);

              modal.appendChild(header);
              modal.appendChild(body);
              modal.appendChild(footer);
              overlay.appendChild(modal);
              parent.appendChild(overlay);

              const onKeyDown = e => {
                if (e.key === 'Escape') {
                  e.preventDefault();
                  finish(false);
                } else if (e.key === 'Enter') {
                  e.preventDefault();
                  finish(true);
                }
              };

              const cleanup = () => {
                document.removeEventListener('keydown', onKeyDown, true);
                if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
              };

              const finish = result => {
                cleanup();
                resolve(!!result);
              };

              overlay.addEventListener('click', e => {
                if (e.target === overlay) finish(false);
              });
              closeBtn.addEventListener('click', () => finish(false));
              cancelBtn.addEventListener('click', () => finish(false));
              confirmBtn.addEventListener('click', () => finish(true));
              document.addEventListener('keydown', onKeyDown, true);
              setTimeout(() => confirmBtn.focus(), 0);
            } catch (e) {
              console.warn('showFullscreenConfirm failed, fallback to confirm:', e);
              resolve(confirm(String(message ?? '')));
            }
          });
        }

        async saveGame(slotId = 'slot_1') {
          try {
            const saveName = await this.promptForSaveName(`L∆∞u Th·ªß C√¥ng_${new Date().toLocaleString('vi-VN')}`);
            if (!saveName) {
              console.log('ƒê√£ h·ªßy l∆∞u tr·ªØ');
              return;
            }

            const allSaves = this.getSavesFromStorage();
            const slotExists = allSaves[slotId];

            const performSave = async () => {
              try {
                const gameState = this.getAllVariables();
                const chatMessages = await getChatMessages(0);
                const currentMessage = chatMessages && chatMessages.length > 0 ? chatMessages[0].message : '';
                const bookName = '- Uma Musume: Chuy·ªán l·∫° Tracen';
                const baseJourneyKey = this._getBaseJourneyKey();
                let journeyContent = '';
                try {
                  const allEntries = await TavernHelper.getLorebookEntries(bookName);
                  const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);
                  journeyContent = journeyEntry?.content || '';
                  console.log(`üìö ƒê·ªçc n·ªôi dung S√°ch th·∫ø gi·ªõi: Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y(${journeyContent.length} k√Ω t·ª±)`);
                } catch (e) {
                  console.error('‚ùå ƒê·ªçc n·ªôi dung S√°ch th·∫ø gi·ªõi th·∫•t b·∫°i:', e);
                }
                const saveJourneyEntryName = `${saveName}-Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y`;

                let lorebookEntries = {
                  journey_entry_name: saveJourneyEntryName,
                };

                try {
                  const allEntries = await TavernHelper.getLorebookEntries(bookName);
                  const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);
                  const entriesToCreate = [];
                  if (journeyEntry) {
                    entriesToCreate.push({
                      comment: saveJourneyEntryName,
                      content: journeyEntry.content || '',
                      keys: [saveJourneyEntryName],
                      enabled: false, 
                      position: 'before_character_definition',
                      order: 20,
                    });
                    console.log(
                      `[L∆∞u tr·ªØ] Chu·∫©n b·ªã t·∫°o m·ª•c "${saveJourneyEntryName}", ƒë·ªô d√†i n·ªôi dung: ${(journeyEntry.content || '').length}`,
                    );
                  } else {
                    entriesToCreate.push({
                      comment: saveJourneyEntryName,
                      content: '# Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y\nT·∫°m kh√¥ng c√≥ ghi ch√©p',
                      keys: [saveJourneyEntryName],
                      enabled: false,
                      position: 'before_character_definition',
                      order: 20,
                    });
                    console.log(`[L∆∞u tr·ªØ] M·ª•c "Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y" g·ªëc kh√¥ng t·ªìn t·∫°i, t·∫°o m·ª•c r·ªóng`);
                  }

                  if (entriesToCreate.length > 0) {
                    await TavernHelper.createLorebookEntries(bookName, entriesToCreate);
                    console.log(`‚úÖ [L∆∞u tr·ªØ] ƒê√£ t·∫°o ${entriesToCreate.length} m·ª•c S√°ch th·∫ø gi·ªõi ƒë·ªôc l·∫≠p`);
                    const updatedEntries = await TavernHelper.getLorebookEntries(bookName);
                    const currentJourneyEntry = updatedEntries.find(entry => entry.comment === baseJourneyKey);
                    if (currentJourneyEntry && !currentJourneyEntry.enabled) {
                      await TavernHelper.setLorebookEntries(bookName, [
                        {
                          uid: currentJourneyEntry.uid,
                          enabled: true,
                        },
                      ]);
                      console.log(`‚úÖ [L∆∞u tr·ªØ] ƒê√£ ƒë·∫£m b·∫£o m·ª•c S√°ch th·∫ø gi·ªõi c·ªßa v√≤ng l·∫∑p hi·ªán t·∫°i "${baseJourneyKey}" gi·ªØ tr·∫°ng th√°i k√≠ch ho·∫°t`);
                    }
                  }
                } catch (error) {
                  console.error('‚ùå L·ªói khi t·∫°o m·ª•c S√°ch th·∫ø gi·ªõi ƒë·ªôc l·∫≠p:', error);
                  console.warn('‚ö†Ô∏è C·∫£nh b√°o: T·∫°o m·ª•c S√°ch th·∫ø gi·ªõi th·∫•t b·∫°i, nh∆∞ng d·ªØ li·ªáu ch√≠nh v·∫´n s·∫Ω ƒë∆∞·ª£c l∆∞u.');
                }
                const saveData = {
                  timestamp: Date.now(),
                  save_name: saveName,
                  type: 'manual',
                  timeline_history: JSON.parse(JSON.stringify(this.chatHistoryCache)), 
                  lorebook_entries: lorebookEntries, 
                  snapshot_data: {
                    mvu_data: gameState,
                    lorebook_content: {
                      journey: journeyContent,
                    },
                  },
                  message_content: currentMessage,
                };

                allSaves[slotId] = saveData;
                localStorage.setItem('teresen_multi_save_data', JSON.stringify(allSaves));

                console.log(`‚úÖ L∆∞u tr·ªØ "${saveName}" ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o v·ªã tr√≠ l∆∞u ${slotId.split('_')[1]}`);
                if (typeof showTemporaryMessage === 'function') {
                  showTemporaryMessage(`L∆∞u tr·ªØ "${saveName}" ƒë√£ ƒë∆∞·ª£c l∆∞u!`);
                }
              } catch (error) {
                console.error('L∆∞u tr·ªØ th·∫•t b·∫°i:', error);
                if (typeof showTemporaryMessage === 'function') {
                  showTemporaryMessage(`L∆∞u tr·ªØ th·∫•t b·∫°i: ${error.message}`);
                }
              }
            };

            if (slotExists) {
              const confirmMsg = `V·ªã tr√≠ l∆∞u ${slotId.split('_')[1]} ƒë√£ c√≥ d·ªØ li·ªáu, x√°c nh·∫≠n ghi ƒë√® kh√¥ng?`;
              const ok = await this.showFullscreenConfirm(confirmMsg, {
                title: 'Ghi ƒë√® l∆∞u tr·ªØ',
                icon: '‚ö†Ô∏è',
                confirmText: 'Ghi ƒë√®',
                cancelText: 'H·ªßy',
                danger: true,
              });
              if (ok) await performSave();
            } else {
              await performSave();
            }
          } catch (error) {
            console.error('X·∫£y ra l·ªói trong qu√° tr√¨nh l∆∞u tr·ªØ:', error);
            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage(`L∆∞u tr·ªØ th·∫•t b·∫°i: ${error.message}`);
            }
          }
        }
        async loadGame_DELETED(slotId = 'slot_1') {
          try {
            const allSaves = this.getSavesFromStorage();
            const saveData = allSaves[slotId];

            if (!saveData) {
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage('L∆∞u tr·ªØ kh√¥ng t·ªìn t·∫°i!');
              }
              return;
            }

            const saveName = saveData.save_name || `L∆∞u tr·ªØ ${slotId.split('_')[1]}`;
            const ok = await this.showFullscreenConfirm(
              `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë·ªçc l∆∞u tr·ªØ "${saveName}" kh√¥ng? Ti·∫øn ƒë·ªô ch∆∞a l∆∞u hi·ªán t·∫°i s·∫Ω b·ªã ghi ƒë√®.`,
              { title: 'ƒê·ªçc l∆∞u tr·ªØ', icon: 'üìñ', confirmText: 'ƒê·ªçc', cancelText: 'H·ªßy' },
            );
            if (!ok) return;
            if (
              saveData.timeline_history &&
              Array.isArray(saveData.timeline_history) &&
              saveData.timeline_history.length > 0
            ) {
              console.log('üîÑ Kh√¥i ph·ª•c l·ªãch s·ª≠ snapshot v√≤ng ch∆°i (' + saveData.timeline_history.length + ' v√≤ng)...');
              this.chatHistoryCache = JSON.parse(JSON.stringify(saveData.timeline_history));
              const historyKey = this._getHistoryKey();
              localStorage.setItem(historyKey, JSON.stringify(this.chatHistoryCache));
              this.historyViewIndex = this.chatHistoryCache.length - 1;

              console.log(`‚úÖ L·ªãch s·ª≠ snapshot v√≤ng ch∆°i ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c (${saveData.timeline_history.length} v√≤ng), ƒë√£ l∆∞u v√†o phi√™n hi·ªán t·∫°i`);
              const lastSnapshot = this.chatHistoryCache[this.chatHistoryCache.length - 1];
              if (lastSnapshot && lastSnapshot.message) {
                try {
                  if (typeof SillyTavern !== 'undefined' && SillyTavern.chat && SillyTavern.chat.length > 0) {
                    const lastMessage = SillyTavern.chat[SillyTavern.chat.length - 1];
                    if (!lastMessage.extra) {
                      lastMessage.extra = {};
                    }
                    if (saveData.timeline_history && Array.isArray(saveData.timeline_history)) {
                      lastMessage.extra.teresen_chat = saveData.timeline_history.map(snapshot => ({
                        role: 'assistant',
                        content: snapshot.message || '',
                        id: snapshot.message_id || `snapshot_${Date.now()}`,
                        timestamp: snapshot.timestamp || Date.now(),
                        variableState: snapshot.data || null,
                      }));
                    } else if (lastSnapshot && lastSnapshot.message) {
                      lastMessage.extra.teresen_chat = [
                        {
                          role: 'assistant',
                          content: lastSnapshot.message,
                          id: 'load_' + Date.now(),
                          timestamp: Date.now(),
                          variableState: lastSnapshot.data || null,
                        },
                      ];
                    }
                    if (saveData.mvu_data) {
                      lastMessage.data = saveData.mvu_data;
                    } else if (lastSnapshot && lastSnapshot.data) {
                      lastMessage.data = lastSnapshot.data;
                    }
                    if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
                      await SillyTavern.saveChat();
                      console.log('‚úÖ Tin nh·∫Øn tr√≤ chuy·ªán ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c v√†o extra.teresen_chat (ƒë·ªçc l∆∞u tr·ªØ)');
                    } else if (typeof TavernHelper !== 'undefined' && TavernHelper.setChatMessages) {
                      await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });
                      console.log('‚úÖ Tin nh·∫Øn tr√≤ chuy·ªán ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c v√†o extra.teresen_chat (ch∆∞a c·∫≠p nh·∫≠t tr∆∞·ªùng message)');
                    }
                  }
                } catch (e) {
                  console.warn('Kh√¥i ph·ª•c tin nh·∫Øn tr√≤ chuy·ªán th·∫•t b·∫°i:', e);
                }
              }
            }
            else if (saveData.message_content) {
              console.log('‚ö†Ô∏è S·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng l∆∞u tr·ªØ phi√™n b·∫£n c≈©, ch·ªâ kh√¥i ph·ª•c tin nh·∫Øn ƒë∆°n l·∫ª');
              if (typeof SillyTavern !== 'undefined' && SillyTavern.chat && SillyTavern.chat.length > 0) {
                const lastMessage = SillyTavern.chat[SillyTavern.chat.length - 1];
                if (!lastMessage.extra) {
                  lastMessage.extra = {};
                }

                lastMessage.extra.teresen_chat = [
                  {
                    role: 'assistant',
                    content: saveData.message_content || '',
                    id: 'load_' + Date.now(),
                    timestamp: Date.now(),
                    variableState: saveData.mvu_data || null,
                  },
                ];
                if (saveData.mvu_data) {
                  lastMessage.data = saveData.mvu_data;
                }

                if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
                  await SillyTavern.saveChat();
                  console.log('‚úÖ Tin nh·∫Øn ƒë∆°n l·∫ª ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c v√†o extra.teresen_chat (ƒë·ªãnh d·∫°ng phi√™n b·∫£n c≈©)');
                } else if (typeof TavernHelper !== 'undefined' && TavernHelper.setChatMessages) {
                  await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });
                  console.log('‚úÖ Tin nh·∫Øn ƒë∆°n l·∫ª ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c v√†o extra.teresen_chat (ch∆∞a c·∫≠p nh·∫≠t tr∆∞·ªùng message)');
                }
                if (typeof this.updateInterface === 'function') {
                  await this.updateInterface();
                }
              }
            }
            if (saveData.snapshot_data && saveData.snapshot_data.mvu_data) {
              this.currentMvuState = saveData.snapshot_data.mvu_data;
              this.renderUI(this.currentMvuState.stat_data);
              console.log('‚úÖ Tr·∫°ng th√°i tr√≤ ch∆°i ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c');
            } else if (saveData.mvu_data) {
              this.currentMvuState = saveData.mvu_data;
              this.renderUI(this.currentMvuState.stat_data);
              console.log('‚úÖ Tr·∫°ng th√°i tr√≤ ch∆°i ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c (ƒë·ªãnh d·∫°ng c≈©)');
            }
            const bookName = '- Uma Musume: Chuy·ªán l·∫° Tracen';
            const baseJourneyKey = this._getBaseJourneyKey();

            try {
              const allEntries = await TavernHelper.getLorebookEntries(bookName);
              if (saveData.lorebook_entries) {
                const entries = saveData.lorebook_entries;
                const saveJourneyEntry = allEntries.find(entry => entry.comment === entries.journey_entry_name);
                const currentJourneyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);
                if (saveJourneyEntry) {
                  const contentToRestore = saveJourneyEntry.content || '';
                  console.log(
                    `[ƒê·ªçc l∆∞u tr·ªØ] T√¨m th·∫•y m·ª•c S√°ch th·∫ø gi·ªõi c·ªßa l∆∞u tr·ªØ "${entries.journey_entry_name}", ƒë·ªô d√†i n·ªôi dung: ${contentToRestore.length}`,
                  );

                  if (currentJourneyEntry) {
                    await TavernHelper.setLorebookEntries(bookName, [
                      {
                        uid: currentJourneyEntry.uid,
                        content: contentToRestore,
                        enabled: true, 
                      },
                    ]);
                    console.log(
                      `‚úÖ [ƒê·ªçc l∆∞u tr·ªØ] ƒê√£ c·∫≠p nh·∫≠t v√† k√≠ch ho·∫°t m·ª•c "${baseJourneyKey}" (UID: ${currentJourneyEntry.uid}), ƒë·ªô d√†i n·ªôi dung: ${contentToRestore.length}`,
                    );
                  } else {
                    await TavernHelper.createLorebookEntries(bookName, [
                      {
                        comment: baseJourneyKey,
                        content: contentToRestore,
                        keys: [baseJourneyKey],
                        enabled: true, 
                        position: 'before_character_definition',
                        order: 20,
                      },
                    ]);
                    console.log(`‚úÖ [ƒê·ªçc l∆∞u tr·ªØ] T·∫°o m·ª•c "${baseJourneyKey}", ƒë·ªô d√†i n·ªôi dung: ${contentToRestore.length}`);
                  }
                } else {
                  console.warn(
                    `‚ö†Ô∏è [ƒê·ªçc l∆∞u tr·ªØ] Kh√¥ng t√¨m th·∫•y m·ª•c S√°ch th·∫ø gi·ªõi c·ªßa l∆∞u tr·ªØ "${entries.journey_entry_name}", th·ª≠ s·ª≠ d·ª•ng n·ªôi dung trong snapshot_data`,
                  );
                  if (saveData.snapshot_data && saveData.snapshot_data.lorebook_content) {
                    const journeyContent = saveData.snapshot_data.lorebook_content.journey || '';
                    if (currentJourneyEntry && journeyContent) {
                      await TavernHelper.setLorebookEntries(bookName, [
                        {
                          uid: currentJourneyEntry.uid,
                          content: journeyContent,
                          enabled: true,
                        },
                      ]);
                      console.log(`‚úÖ [ƒê·ªçc l∆∞u tr·ªØ] S·ª≠ d·ª•ng snapshot_data kh√¥i ph·ª•c m·ª•c "${baseJourneyKey}"`);
                    }
                  }
                }
                const entriesToDisable = [];
                const entriesToEnable = [];
                const updatedEntries = await TavernHelper.getLorebookEntries(bookName);

                for (const entry of updatedEntries) {
                  const isJourneyEntry = entry.comment.startsWith('Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y');
                  if (!isJourneyEntry) continue;

                  const isCurrentJourney = entry.comment === baseJourneyKey;

                  if (isCurrentJourney) {
                    if (!entry.enabled) {
                      entriesToEnable.push({ uid: entry.uid, enabled: true });
                      console.log(`[ƒê·ªçc l∆∞u tr·ªØ] C·∫ßn k√≠ch ho·∫°t m·ª•c c·ªßa v√≤ng l·∫∑p hi·ªán t·∫°i "${baseJourneyKey}" (UID: ${entry.uid})`);
                    }
                  } else {
                    if (entry.enabled) {
                      entriesToDisable.push({ uid: entry.uid, enabled: false });
                    }
                  }
                }
                const allUpdates = [...entriesToEnable, ...entriesToDisable];
                if (allUpdates.length > 0) {
                  await TavernHelper.setLorebookEntries(bookName, allUpdates);
                  if (entriesToEnable.length > 0) {
                    console.log(`‚úÖ [ƒê·ªçc l∆∞u tr·ªØ] ƒê√£ k√≠ch ho·∫°t m·ª•c S√°ch th·∫ø gi·ªõi c·ªßa v√≤ng l·∫∑p hi·ªán t·∫°i "${baseJourneyKey}"`);
                  }
                  if (entriesToDisable.length > 0) {
                    console.log(`‚úÖ [ƒê·ªçc l∆∞u tr·ªØ] ƒê√£ v√¥ hi·ªáu h√≥a ${entriesToDisable.length} m·ª•c S√°ch th·∫ø gi·ªõi c·ªßa c√°c v√≤ng l·∫∑p kh√°c`);
                  }
                }

                console.log('‚úÖ [ƒê·ªçc l∆∞u tr·ªØ] Ch·ª©c nƒÉng k√Ω ·ª©c S√°ch th·∫ø gi·ªõi ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c (t·ª´ m·ª•c ƒë·ªôc l·∫≠p)! AI b√¢y gi·ªù c√≥ th·ªÉ nh·ªõ t·∫•t c·∫£ k√Ω ·ª©c khi l∆∞u tr·ªØ');
              }
              else if (saveData.snapshot_data && saveData.snapshot_data.lorebook_content) {
                const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);
                if (journeyEntry) {
                  await TavernHelper.setLorebookEntries(bookName, [
                    {
                      uid: journeyEntry.uid,
                      content: saveData.snapshot_data.lorebook_content.journey || '',
                      enabled: true, 
                    },
                  ]);
                  console.log(
                    `‚úÖ [ƒê·ªçc l∆∞u tr·ªØ] "${baseJourneyKey}" ƒë√£ kh√¥i ph·ª•c v√† k√≠ch ho·∫°t (UID: ${journeyEntry.uid}), AI b√¢y gi·ªù c√≥ th·ªÉ nh·ªõ nh·ªØng s·ª± vi·ªác tr∆∞·ªõc ƒë√≥`,
                  );
                } else {
                  console.warn(`‚ö†Ô∏è [ƒê·ªçc l∆∞u tr·ªØ] Kh√¥ng t√¨m th·∫•y m·ª•c "${baseJourneyKey}", kh√¥ng th·ªÉ kh√¥i ph·ª•c`);
                }
                const entriesToDisable = [];
                const entriesToEnable = [];
                const updatedEntries = await TavernHelper.getLorebookEntries(bookName);

                for (const entry of updatedEntries) {
                  const isJourneyEntry = entry.comment.startsWith('Tr·∫£i nghi·ªám v√≤ng l·∫∑p n√†y');
                  if (!isJourneyEntry) continue;

                  const isCurrentJourney = entry.comment === baseJourneyKey;

                  if (isCurrentJourney) {
                    if (!entry.enabled) {
                      entriesToEnable.push({ uid: entry.uid, enabled: true });
                    }
                  } else {
                    if (entry.enabled) {
                      entriesToDisable.push({ uid: entry.uid, enabled: false });
                    }
                  }
                }
                const allUpdates = [...entriesToEnable, ...entriesToDisable];
                if (allUpdates.length > 0) {
                  await TavernHelper.setLorebookEntries(bookName, allUpdates);
                  if (entriesToEnable.length > 0) {
                    console.log(`‚úÖ [ƒê·ªçc l∆∞u tr·ªØ] ƒê√£ k√≠ch ho·∫°t m·ª•c S√°ch th·∫ø gi·ªõi c·ªßa v√≤ng l·∫∑p hi·ªán t·∫°i "${baseJourneyKey}"`);
                  }
                  if (entriesToDisable.length > 0) {
                    console.log(`‚úÖ [ƒê·ªçc l∆∞u tr·ªØ] ƒê√£ v√¥ hi·ªáu h√≥a ${entriesToDisable.length} m·ª•c S√°ch th·∫ø gi·ªõi c·ªßa c√°c v√≤ng l·∫∑p kh√°c`);
                  }
                }

                console.log('‚úÖ [ƒê·ªçc l∆∞u tr·ªØ] Ch·ª©c nƒÉng k√Ω ·ª©c S√°ch th·∫ø gi·ªõi ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c (ƒë·ªãnh d·∫°ng c≈©)! AI b√¢y gi·ªù c√≥ th·ªÉ nh·ªõ t·∫•t c·∫£ k√Ω ·ª©c khi l∆∞u tr·ªØ');
              }
            } catch (e) {
              console.error('‚ùå Kh√¥i ph·ª•c n·ªôi dung S√°ch th·∫ø gi·ªõi th·∫•t b·∫°i:', e);
            }

            await this.updateInterface();
            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage(`L∆∞u tr·ªØ "${saveName}" t·∫£i th√†nh c√¥ng! AI b√¢y gi·ªù c√≥ th·ªÉ nh·ªõ c√°c cu·ªôc tr√≤ chuy·ªán tr∆∞·ªõc ƒë√≥.`);
            }
            if (document.getElementById('saveManagerModal')) {
              this.showSaveLoadManager();
              setTimeout(() => {
                this.bindSaveSlotListeners();
              }, 100);
            }
          } catch (error) {
            console.error('‚ùå T·∫£i l∆∞u tr·ªØ th·∫•t b·∫°i:', error);
            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('T·∫£i l∆∞u tr·ªØ th·∫•t b·∫°i!');
            }
          }
        }
        async createPendingAutoSave() {
          if (!this.isAutoSaveEnabled) {
            this.pendingAutoSave = null;
            return;
          }

          try {
            let mvuState = this.currentMvuState;
            if (!mvuState || !mvuState.stat_data) {
              console.log('[AutoSave] currentMvuState ch∆∞a ƒë∆∞·ª£c thi·∫øt l·∫≠p, l·∫•y t·ª´ getAllVariables...');
              mvuState = this.getAllVariables();
              if (mvuState && mvuState.stat_data) {
                this.currentMvuState = mvuState;
              }
            }

            if (!mvuState || !mvuState.stat_data) {
              console.warn('[AutoSave] Kh√¥ng th·ªÉ l·∫•y tr·∫°ng th√°i MVU, b·ªè qua l∆∞u t·ª± ƒë·ªông');
              this.pendingAutoSave = null;
              return;
            }

            let currentMessageContent = '';
            try {
              const messages = await getChatMessages('0');
              currentMessageContent = messages?.[0]?.message || '';
            } catch (e) {
              console.warn('[AutoSave] L·∫•y n·ªôi dung tin nh·∫Øn th·∫•t b·∫°i khi t·∫°o snapshot.');
            }
            const bookName = '- Uma Musume: Chuy·ªán l·∫° Tracen';
            const baseJourneyKey = this._getBaseJourneyKey();
            let journeyContent = '';
            try {
              const allEntries = await TavernHelper.getLorebookEntries(bookName);
              const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);
              journeyContent = journeyEntry?.content || '';
            } catch (e) {
              console.warn('[AutoSave] ƒê·ªçc n·ªôi dung S√°ch th·∫ø gi·ªõi th·∫•t b·∫°i.');
            }

            this.pendingAutoSave = {
              timestamp: Date.now(),
              save_name: 'L∆∞u T·ª± ƒê·ªông - V√≤ng Tr∆∞·ªõc',
              message_content: currentMessageContent,
              timeline_history: JSON.parse(JSON.stringify(this.chatHistoryCache)), 
              snapshot_data: {
                mvu_data: JSON.parse(JSON.stringify(mvuState)),
                lorebook_content: {
                  journey: journeyContent,
                },
              },
            };

            console.log('[AutoSave] ƒê√£ t·∫°o snapshot l∆∞u t·ª± ƒë·ªông ch·ªù x·ª≠ l√Ω');
          } catch (error) {
            console.error('[AutoSave] L·ªói khi t·∫°o snapshot l∆∞u tr·ªØ ch·ªù x·ª≠ l√Ω:', error);
            this.pendingAutoSave = null;
          }
        }
        async performAutoSave() {
          if (!this.isAutoSaveEnabled || !this.pendingAutoSave) {
            return;
          }

          try {
            const chatId = TavernHelper?.chatId || 'default';
            const autoSaveKey = `teresen_auto_save_${chatId}`;
            let currentAutoSaves = {};
            try {
              const saved = localStorage.getItem(autoSaveKey);
              if (saved) {
                currentAutoSaves = JSON.parse(saved);
              }
            } catch (e) {
              console.warn('[AutoSave] ƒê·ªçc l∆∞u t·ª± ƒë·ªông phi√™n hi·ªán t·∫°i th·∫•t b·∫°i, s·∫Ω t·∫°o m·ªõi:', e);
            }
            if (currentAutoSaves['auto_save_slot_0']) {
              currentAutoSaves['auto_save_slot_1'] = JSON.parse(JSON.stringify(currentAutoSaves['auto_save_slot_0']));
              currentAutoSaves['auto_save_slot_1'].save_name = 'L∆∞u T·ª± ƒê·ªông - L·∫ßn Tr∆∞·ªõc';
            }
            currentAutoSaves['auto_save_slot_0'] = this.pendingAutoSave;
            currentAutoSaves['auto_save_slot_0'].save_name = 'L∆∞u T·ª± ƒê·ªông - M·ªõi Nh·∫•t';

            localStorage.setItem(autoSaveKey, JSON.stringify(currentAutoSaves));
            console.log(`[AutoSave] ‚úÖ ƒê√£ g·ª≠i l∆∞u t·ª± ƒë·ªông (chatId: ${chatId})`);
          } catch (error) {
            console.error('[AutoSave] X·∫£y ra l·ªói khi g·ª≠i l∆∞u t·ª± ƒë·ªông:', error);
          } finally {
            this.pendingAutoSave = null;
          }
        }
        showSaveLoadManager() {
          const autoContainer = document.getElementById('auto-save-slot-container');
          const manualContainer = document.getElementById('save-slots-container');
          if (!autoContainer || !manualContainer) return;

          let saves;
          try {
            saves = this.getSavesFromStorage();
          } catch (e) {
            console.error('Ph√¢n t√≠ch t·ªáp l∆∞u tr·ªØ th·∫•t b·∫°i:', e);
            manualContainer.innerHTML = `<div style="color: #ff6b6b; padding: 20px; text-align: center;"><p>L·ªói: T·ªáp l∆∞u tr·ªØ ƒë√£ b·ªã h·ªèng.</p></div>`;
            autoContainer.innerHTML = '';
            return;
          }
          let autoSaveHtml = '';
          const autoSaveSlots = [
            { id: 'auto_save_slot_0', name: 'L∆∞u T·ª± ƒê·ªông M·ªõi Nh·∫•t', color: '#66CDAA' },
            { id: 'auto_save_slot_1', name: 'L∆∞u T·ª± ƒê·ªông L·∫ßn Tr∆∞·ªõc', color: '#FFD700' },
          ];

          autoSaveSlots.forEach(slotInfo => {
            const autoSaveData = saves[slotInfo.id];
            autoSaveHtml += `<div class="save-slot" data-slot-id="${slotInfo.id}" style="margin-bottom: 10px; padding: 10px; background: rgba(45, 27, 27, 0.6); border: 1px solid rgba(139, 105, 20, 0.5); border-radius: 6px; backdrop-filter: blur(2px);">`;
            if (autoSaveData && autoSaveData.snapshot_data && autoSaveData.snapshot_data.mvu_data) {
              const date = new Date(autoSaveData.timestamp).toLocaleString('zh-CN');
              const statData = autoSaveData.snapshot_data.mvu_data.stat_data || {};
              const summary = this._getDisplayText(autoSaveData.message_content || '');

              autoSaveHtml += `
                <div class="save-slot-info" style="margin-bottom: 10px;">
                  <div class="slot-name" style="color: ${slotInfo.color}; font-weight: bold; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${slotInfo.name}</div>
                  <div class="slot-time" style="color: #d4c4a8; font-size: 12px; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">${date}</div>
                  <div class="slot-summary" style="color: #c9b99b; font-size: 11px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">${summary ? summary.substring(0, 40) + '...' : 'Kh√¥ng c√≥ ghi ch√©p ch√≠nh vƒÉn'}</div>
                </div>
                <div class="save-slot-actions" style="display: flex; gap: 5px;">
                  <button class="interaction-btn btn-load-slot" data-slot-id="${slotInfo.id}" style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #4a6741, #5a7a51); border: 1px solid #6b8e5a; color: #f0e6d2; cursor: pointer; font-weight: 500;">ƒê·ªçc</button>
                  <button class="interaction-btn btn-export-slot" data-slot-id="${slotInfo.id}" style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #5a4a3a, #6a5a4a); border: 1px solid #7a6a5a; color: #f0e6d2; cursor: pointer; font-weight: 500;">Xu·∫•t</button>
                  <button class="interaction-btn btn-delete-slot" data-slot-id="${slotInfo.id}" style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #8b0000, #a00000); border: 1px solid #b00000; color: #ffffff; cursor: pointer; font-weight: 500;">X√≥a</button>
                </div>
              `;
            } else {
              autoSaveHtml += `
                <div class="save-slot-info" style="margin-bottom: 10px;">
                  <div class="slot-name" style="color: ${slotInfo.color}; font-weight: bold; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${slotInfo.name}</div>
                  <div class="slot-time" style="font-style: italic; color: #d4c4a8; font-size: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">Kh√¥ng c√≥ ghi ch√©p l∆∞u t·ª± ƒë·ªông</div>
                </div>
                <div class="save-slot-actions" style="display: flex; gap: 5px;">
                  <button class="interaction-btn btn-load-slot" disabled style="padding: 6px 12px; font-size: 12px; background: rgba(74, 103, 65, 0.3); border: 1px solid rgba(107, 142, 90, 0.3); color: rgba(240, 230, 210, 0.5); cursor: not-allowed;">ƒê·ªçc</button>
                  <button class="interaction-btn btn-export-slot" disabled style="padding: 6px 12px; font-size: 12px; background: rgba(90, 74, 58, 0.3); border: 1px solid rgba(122, 106, 90, 0.3); color: rgba(240, 230, 210, 0.5); cursor: not-allowed;">Xu·∫•t</button>
                  <button class="interaction-btn btn-delete-slot" disabled style="padding: 6px 12px; font-size: 12px; background: rgba(139, 0, 0, 0.3); border: 1px solid rgba(176, 0, 0, 0.3); color: rgba(255, 255, 255, 0.5); cursor: not-allowed;">X√≥a</button>
                </div>
              `;
            }
            autoSaveHtml += `</div>`;
          });
          autoContainer.innerHTML = autoSaveHtml;
          let manualHtml = '';
          const totalSlots = 5;
          for (let i = 1; i <= totalSlots; i++) {
            const slotId = `slot_${i}`;
            const saveData = saves[slotId];

            manualHtml += `<div class="save-slot" data-slot-id="${slotId}" style="margin-bottom: 10px; padding: 10px; background: rgba(45, 27, 27, 0.6); border: 1px solid rgba(139, 105, 20, 0.5); border-radius: 6px; backdrop-filter: blur(2px);">`;
            manualHtml += `<div class="save-slot-info" style="margin-bottom: 10px;">`;

            if (saveData && saveData.snapshot_data && saveData.snapshot_data.mvu_data) {
              const date = new Date(saveData.timestamp).toLocaleString('zh-CN');
              const statData = saveData.snapshot_data.mvu_data.stat_data || {};
              const summary = this._getDisplayText(saveData.message_content || '');
              const saveName = saveData.save_name || saveData.saveName || `L∆∞u Tr·ªØ ${i}`;

              manualHtml += `
                <div class="slot-name" style="font-weight: bold; margin-bottom: 5px; color: #f0e6d2; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${saveName}</div>
                <div class="slot-time" style="color: #d4c4a8; font-size: 12px; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">${date}</div>
                <div class="slot-summary" style="color: #c9b99b; font-size: 11px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">${summary ? summary.substring(0, 40) + '...' : 'Kh√¥ng c√≥ ghi ch√©p ch√≠nh vƒÉn'}</div>
              `;
            } else {
              manualHtml += `
                <div class="slot-name" style="font-weight: bold; margin-bottom: 5px; color: #f0e6d2; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">L∆∞u Tr·ªØ ${i}</div>
                <div class="slot-time" style="font-style: italic; color: #d4c4a8; font-size: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">V·ªã tr√≠ l∆∞u tr·ªëng</div>
              `;
            }

            manualHtml += `</div>`;
            manualHtml += `<div class="save-slot-actions" style="display: flex; gap: 5px;">`;
            const saveBtnStyle = saveData
              ? 'padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #6a5a4a, #7a6a5a); border: 1px solid #8a7a6a; color: #f0e6d2; cursor: pointer; font-weight: 500;'
              : 'padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #6a5a4a, #7a6a5a); border: 1px solid #8a7a6a; color: #f0e6d2; cursor: pointer; font-weight: 500;';
            manualHtml += `<button class="interaction-btn btn-save-slot" data-slot-id="${slotId}" style="${saveBtnStyle}">L∆∞u</button>`;
            const loadBtnStyle = saveData
              ? 'padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #4a6741, #5a7a51); border: 1px solid #6b8e5a; color: #f0e6d2; cursor: pointer; font-weight: 500;'
              : 'padding: 6px 12px; font-size: 12px; background: rgba(74, 103, 65, 0.3); border: 1px solid rgba(107, 142, 90, 0.3); color: rgba(240, 230, 210, 0.5); cursor: not-allowed;';
            manualHtml += `<button class="interaction-btn btn-load-slot" data-slot-id="${slotId}" style="${loadBtnStyle}" ${!saveData ? 'disabled' : ''}>ƒê·ªçc</button>`;
            const exportBtnStyle = saveData
              ? 'padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #5a4a3a, #6a5a4a); border: 1px solid #7a6a5a; color: #f0e6d2; cursor: pointer; font-weight: 500;'
              : 'padding: 6px 12px; font-size: 12px; background: rgba(90, 74, 58, 0.3); border: 1px solid rgba(122, 106, 90, 0.3); color: rgba(240, 230, 210, 0.5); cursor: not-allowed;';
            manualHtml += `<button class="interaction-btn btn-export-slot" data-slot-id="${slotId}" style="${exportBtnStyle}" ${!saveData ? 'disabled' : ''}>Xu·∫•t</button>`;
            const deleteBtnStyle = saveData
              ? 'padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #8b0000, #a00000); border: 1px solid #b00000; color: #ffffff; cursor: pointer; font-weight: 500;'
              : 'padding: 6px 12px; font-size: 12px; background: rgba(139, 0, 0, 0.3); border: 1px solid rgba(176, 0, 0, 0.3); color: rgba(255, 255, 255, 0.5); cursor: not-allowed;';
            manualHtml += `<button class="interaction-btn btn-delete-slot" data-slot-id="${slotId}" style="${deleteBtnStyle}" ${!saveData ? 'disabled' : ''}>X√≥a</button>`;

            manualHtml += `</div></div>`;
          }
          manualContainer.innerHTML = manualHtml;
        }
        bindSaveSlotListeners() {
          document.querySelectorAll('.btn-save-slot').forEach(btn => {
            btn.addEventListener('click', async e => {
              const slotId = e.target.dataset.slotId;
              if (slotId) {
                await this.saveGame(slotId);
                this.showSaveLoadManager();
                setTimeout(() => {
                  this.bindSaveSlotListeners();
                }, 100);
              }
            });
          });
          document.querySelectorAll('.btn-load-slot').forEach(btn => {
            btn.addEventListener('click', async e => {
              const slotId = e.target.dataset.slotId;
              if (slotId && !e.target.disabled) {
                await this.loadGame(slotId);
              }
            });
          });
          document.querySelectorAll('.btn-delete-slot').forEach(btn => {
            btn.addEventListener('click', async e => {
              const slotId = e.target.dataset.slotId;
              if (slotId && !e.target.disabled) {
                const ok = await this.showFullscreenConfirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a l∆∞u tr·ªØ n√†y kh√¥ngÔºü', {
                  title: 'X√≥a l∆∞u tr·ªØ',
                  icon: 'üóëÔ∏è',
                  confirmText: 'X√≥a',
                  cancelText: 'H·ªßy',
                  danger: true,
                });
                if (ok) {
                  const allSaves = this.getSavesFromStorage();
                  delete allSaves[slotId];
                  localStorage.setItem('teresen_multi_save_data', JSON.stringify(allSaves));
                  this.showSaveLoadManager();
                  setTimeout(() => {
                    this.bindSaveSlotListeners();
                  }, 100);
                }
              }
            });
          });
          document.querySelectorAll('.btn-export-slot').forEach(btn => {
            btn.addEventListener('click', async e => {
              const slotId = e.target.dataset.slotId;
              if (slotId && !e.target.disabled) {
                const allSaves = this.getSavesFromStorage();
                const saveData = allSaves[slotId];
                if (saveData) {
                  const jsonString = JSON.stringify(saveData, null, 2);
                  const blob = new Blob([jsonString], { type: 'application/json' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = `L∆∞u Tr·ªØ_${saveData.save_name || slotId}_${new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')}.json`;
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                  URL.revokeObjectURL(url);
                }
              }
            });
          });
        }
        _getDisplayText(messageContent) {
          if (!messageContent) return '';
          const contentMatch = messageContent.match(/<content>(.*?)<\/content>/s);
          if (contentMatch) {
            return contentMatch[1].trim();
          }
          return messageContent.substring(0, 100);
        }

        showTalentsModal() {
          const sound = document.getElementById('talent-sound');
          if (sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log('Ph√°t √¢m thanh th·∫•t b·∫°i:', e));
          }

          const modal = document.getElementById('talents-modal');

          if (modal) {
            modal.style.display = 'flex';

            modal.style.justifyContent = 'center';

            modal.style.alignItems = 'center';

            this.currentTalentPage = 0;

            this.updatePageIndicator();

            this.updatePageButtons();

            this.updateTalentsModal();

            this.addKeyboardListeners();

            this.addResizeListener();
          }
        }

        updateTalentsModal() {
          this.updateCurrentTalents();

          this.updateTalentOptions();

          this.updateUpgradeHistory();

          this.updateCurrentPageOptions();
        }

        updateCurrentTalents() {
          const container = document.getElementById('current-talents-list');

          if (!container) return;

          try {
            let majorTalent = 'Kh√¥ng';

            let crystals = 0;

            let acquiredTalents = [];
            const variables = this.getAllVariables();
            majorTalent = this.getVariable(variables, 'stat_data.trainer.talent.majorTalent.name', 'Kh√¥ng');
            const crystalsValue = this.getVariable(variables, 'stat_data.trainer.twistedAffectionCrystals', 0);
            crystals = parseInt(crystalsValue) || 0;
            console.log('üíé updateCurrentTalents - ƒê·ªçc s·ªë l∆∞·ª£ng k·∫øt tinh:', { raw: crystalsValue, parsed: crystals });
            const levels = ['sprout', 'growth', 'mutation', 'authority', 'abyss'];
            levels.forEach(level => {
              const talent = this.getVariable(variables, `stat_data.trainer.talent.minorTalent.${level}`, null);
              if (talent) {
                acquiredTalents.push({
                  level: level,
                  title: talent,
                });
              }
            });

            const talentInfo = this.getMajorTalentDescription(majorTalent);

            let html = `

              <div style="max-width: 800px; margin: 0 auto;">

                <div style="background: linear-gradient(135deg, rgba(139, 69, 19, 0.1), rgba(139, 69, 19, 0.05)); border: 2px solid rgba(139, 69, 19, 0.3); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">

                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    
                    <h4 style="color: #8b4513; font-size: 18px; font-weight: bold; display: flex; align-items: center; gap: 8px;">

                      <span style="font-size: 20px;">üé≠</span>

                      ${talentInfo.name}

                    </h4>

                    <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.12), rgba(168, 85, 247, 0.06)); border: 1px solid rgba(168, 85, 247, 0.4); border-radius: 8px; padding: 8px 12px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                      <div style="display: flex; align-items: center; gap: 4px;">
                        <span style="font-size: 12px;">üíé</span>
                        <span style="color: #a855f7; font-size: 12px; font-weight: 600;">K·∫øt tinh</span>
                        <span style="color: #a855f7; font-size: 14px; font-weight: bold;">${crystals}</span>
                      </div>
                    </div>

                  </div>

                  <div style="color: #8b4513; font-size: 14px; line-height: 1.6; margin-bottom: 16px; text-align: center; font-style: italic;">

                    ${talentInfo.description}

                  </div>

                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">

                    <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(34, 197, 94, 0.03)); border: 2px solid rgba(34, 197, 94, 0.4); border-radius: 12px; padding: 16px; position: relative; overflow: hidden;">

                      <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.6), transparent);"></div>

                      <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.6), transparent);"></div>

                      

                      <div style="color: #15803d; font-size: 14px; font-weight: 700; margin-bottom: 8px; text-shadow: 0 1px 2px rgba(34, 197, 94, 0.3); letter-spacing: 0.5px;">Ngu·ªìn s·ª©c m·∫°nh</div>

                      <div style="color: #1a1a1a; font-size: 13px; line-height: 1.6; font-weight: 500; text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);">${talentInfo.positive}</div>

                    </div>

                    <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(239, 68, 68, 0.03)); border: 2px solid rgba(239, 68, 68, 0.4); border-radius: 12px; padding: 16px; position: relative; overflow: hidden;">

                      <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.6), transparent);"></div>

                      <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.6), transparent);"></div>

                      

                      <div style="color: #dc2626; font-size: 14px; font-weight: 700; margin-bottom: 8px; text-shadow: 0 1px 2px rgba(239, 68, 68, 0.3); letter-spacing: 0.5px;">D·∫•u v·∫øt c√°i gi√°</div>

                      <div style="color: #1a1a1a; font-size: 13px; line-height: 1.6; font-weight: 500; text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);">${talentInfo.negative}</div>

                    </div>

                  </div>

                </div>

              </div>

            `;

            if (acquiredTalents.length > 0) {
              html += `

                <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05)); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">

                  <h4 style="color: #22c55e; font-size: 18px; font-weight: bold; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; text-align: center; justify-content: center;">

                    <span style="font-size: 20px;">üåü</span>

                    Thi√™n ph√∫ ƒë√£ nh·∫≠n

                  </h4>

                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">

              `;

              acquiredTalents.forEach(talent => {
                html += `

                  <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.08)); border: 2px solid rgba(34, 197, 94, 0.4); border-radius: 12px; padding: 16px; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 8px rgba(0,0,0,0.1)'">

                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">

                      <span style="color: #22c55e; font-size: 14px; font-weight: bold; background: rgba(34, 197, 94, 0.25); padding: 6px 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${talent.level}</span>

                      <span style="color: #22c55e; font-size: 12px; opacity: 0.9; font-weight: 500;">‚ú® ƒê√£ k√≠ch ho·∫°t</span>

                    </div>

                    <div style="color: #2d1b1b; font-size: 14px; line-height: 1.5; font-weight: 500;">${talent.title}</div>

                  </div>

                `;
              });

              html += `

                  </div>

                </div>

              `;
            } else {
              html += `

                <div style="background: linear-gradient(135deg, rgba(139, 69, 19, 0.08), rgba(139, 69, 19, 0.04)); border: 2px solid rgba(139, 69, 19, 0.25); border-radius: 16px; padding: 40px; text-align: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden;">

                  

                  <div style="font-size: 36px; margin-bottom: 16px; opacity: 0.8; filter: drop-shadow(0 2px 4px rgba(139, 69, 19, 0.3));">üìñ</div>

                  <div style="color: #8b4513; font-size: 16px; font-weight: 600; margin-bottom: 8px; text-shadow: 0 1px 2px rgba(139, 69, 19, 0.2);">S√°ch Thi√™n ph√∫</div>

                  <div style="color: #666666; font-size: 14px; font-style: italic; margin-bottom: 8px; opacity: 0.8;">T·∫°m ch∆∞a nh·∫≠n ƒë∆∞·ª£c Thi√™n ph√∫</div>

                  <div style="color: #8b4513; font-size: 13px; opacity: 0.7;">Vui l√≤ng l·∫≠t trang ƒë·ªÉ xem c√°c t√πy ch·ªçn Thi√™n ph√∫ c√≥ th·ªÉ n√¢ng c·∫•p</div>

                </div>

              `;
            }

            container.innerHTML = html;
          } catch (error) {
            console.error('C·∫≠p nh·∫≠t hi·ªÉn th·ªã Thi√™n ph√∫ hi·ªán t·∫°i th·∫•t b·∫°i:', error);

            container.innerHTML =
              '<div style="text-align: center; color: #666666; font-style: italic; padding: 50px;">T·∫£i th·∫•t b·∫°i</div>';
          }
        }

        updateTalentOptions() {
          const levels = ['seed', 'growth', 'mutation', 'authority', 'abyss'];

          levels.forEach(level => {
            this.updateTalentLevelOptions(level);
          });
        }

        updateTalentLevelOptions(level) {
          const container = document.getElementById(`${level}-options`);

          if (!container) return;

          const levelData = this.getTalentData(level);

          if (!levelData) return;

          const isLevelUnlocked = this.isLevelUnlocked(level);

          if (!isLevelUnlocked) {

            const previousLevel = this.getPreviousLevel(level);

            const previousLevelChinese = this.getLevelChineseName(previousLevel);

            container.innerHTML = `

              <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; background: linear-gradient(135deg, rgba(107, 114, 128, 0.1), rgba(107, 114, 128, 0.05)); border: 2px dashed rgba(107, 114, 128, 0.3); border-radius: 12px;">

                <div style="font-size: 48px; margin-bottom: 16px;">üîí</div>

                <h4 style="color: #6b7280; font-size: 16px; font-weight: bold; margin-bottom: 8px;">C·∫•p b·∫≠c ch∆∞a m·ªü kh√≥a</h4>

                <p style="color: #9ca3af; font-size: 14px; line-height: 1.5; margin: 0;">C·∫ßn ho√†n th√†nh l·ª±a ch·ªçn Thi√™n ph√∫ c·∫•p b·∫≠c <span style="color: #8b4513; font-weight: bold;">${previousLevelChinese}</span> tr∆∞·ªõc</p>

                <p style="color: #9ca3af; font-size: 12px; margin-top: 8px; font-style: italic;">Vui l√≤ng quay l·∫°i trang tr∆∞·ªõc ƒë·ªÉ ch·ªçn Thi√™n ph√∫</p>

              </div>

            `;

            return;
          }

          let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
          const levelChineseName = this.getLevelChineseName(level);
          const variables = this.getAllVariables();
          const currentTalent = this.getVariable(variables, `stat_data.trainer.talent.minorTalent.${levelChineseName}`, null);
          const hasTalent = currentTalent && currentTalent !== null && currentTalent !== '';

          levelData.options.forEach((option, index) => {
            const isAcquired = this.isTalentAcquired(level, index);

            const cost = this.getTalentCost(level);
            const isDisabled = hasTalent && !isAcquired;
            const cursorStyle = isDisabled ? 'not-allowed' : 'pointer';
            const opacityStyle = isDisabled ? '0.5' : '1';
            const onclickHandler = isDisabled
              ? ''
              : `onclick="window.teresenDebug.selectTalentOption('${level}', ${index})"`;

            html += `

              <div style="background: ${isAcquired ? 'linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.08))' : 'linear-gradient(135deg, rgba(139, 69, 19, 0.12), rgba(139, 69, 19, 0.06))'}; border: 2px solid ${isAcquired ? 'rgba(34, 197, 94, 0.4)' : 'rgba(139, 69, 19, 0.3)'}; border-radius: 10px; padding: 14px; cursor: ${cursorStyle}; transition: all 0.3s; box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15); opacity: ${opacityStyle};" onmouseover="${isDisabled ? '' : "this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 20px rgba(0,0,0,0.2)'"}" onmouseout="${isDisabled ? '' : "this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 12px rgba(0,0,0,0.15)'"}" ${onclickHandler}>

                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">

                  <h4 style="color: ${isAcquired ? '#22c55e' : '#8b4513'}; font-size: 15px; font-weight: bold; margin: 0; flex: 1; text-shadow: 0 1px 2px rgba(255,255,255,0.8);">${option.title}</h4>

                  <span style="color: ${isAcquired ? '#22c55e' : '#8b4513'}; font-size: 11px; font-weight: bold; background: ${isAcquired ? 'rgba(34, 197, 94, 0.25)' : 'rgba(139, 69, 19, 0.2)'}; padding: 5px 10px; border-radius: 8px; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${isAcquired ? '‚úÖ ƒê√£ nh·∫≠n' : 'üíé ' + cost}</span>

                </div>

                <p style="color: #2d1b1b; font-size: 13px; line-height: 1.5; margin: 0 0 10px 0; font-weight: 500;">${option.description}</p>

                <div style="background: ${isAcquired ? 'rgba(34, 197, 94, 0.1)' : 'rgba(139, 69, 19, 0.08)'}; border: 1px solid ${isAcquired ? 'rgba(34, 197, 94, 0.3)' : 'rgba(139, 69, 19, 0.2)'}; border-radius: 8px; padding: 8px 10px; text-align: center;">

                  <span style="color: ${isAcquired ? '#22c55e' : '#8b4513'}; font-size: 12px; font-weight: bold; text-shadow: 0 1px 1px rgba(255,255,255,0.5);">${option.effects}</span>

                </div>

              </div>

            `;
          });

          html += '</div>';

          container.innerHTML = html;
        }

        getLevelByPageIndex(pageIndex) {
          const levelMap = {
            0: null, 

            1: 'seed',

            2: 'growth',

            3: 'mutation',

            4: 'authority',

            5: 'abyss',

            6: null, 
          };

          return levelMap[pageIndex];
        }

        getTalentCost(level) {
          const costMap = {
            seed: 3,

            growth: 12,

            mutation: 25,

            authority: 40,

            abyss: 70,
          };

          return costMap[level] || 0;
        }

        updateCurrentPageOptions() {
          const level = this.getLevelByPageIndex(this.currentTalentPage);

          if (level) {
            this.updateTalentLevelOptions(level);
          }
        }

        getTalentData(level) {

          let majorTalent = 'H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)';

          try {
            const variables = this.getAllVariables();
            majorTalent = this.getVariable(variables, 'stat_data.trainer.talent.majorTalent.name', 'H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)');
            if (!majorTalent || majorTalent === '' || majorTalent === 'Kh√¥ng') {
              majorTalent = 'H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)';
            }
          } catch (error) {
            console.warn('L·∫•y ƒê·∫°i Thi√™n Ph√∫ th·∫•t b·∫°i, s·ª≠ d·ª•ng gi√° tr·ªã m·∫∑c ƒë·ªãnh:', error);
            majorTalent = 'H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)';
          }

          const talentData = {
            seed: {
              prompt:
                'B·∫°n ch·ªâ ƒëang trong tuy·ªát c·∫£nh, v√¥ th·ª©c n·∫Øm l·∫•y c·ªçng r∆°m c·ª©u m·∫°ng. S·ª©c m·∫°nh n√†y y·∫øu ·ªõt, kh√¥ng th·ªÉ ki·ªÉm so√°t, l√† ti·∫øng kh√≥c y·∫øu ·ªõt ƒë·∫ßu ti√™n c·ªßa b·∫°n trong th·∫ø gi·ªõi kh√°c bi·ªát n√†y.',

              options: this.getTalentOptionsByMajor(majorTalent, 'seed'),
            },

            growth: {
              prompt:
                'B·∫°n b·∫Øt ƒë·∫ßu hi·ªÉu v√† s·ª≠ d·ª•ng s·ª©c m·∫°nh n√†y m·ªôt c√°ch c√≥ √Ω th·ª©c, coi n√≥ nh∆∞ m·ªôt c√¥ng c·ª• gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ. B·∫°n t·ª´ m·ªôt n·∫°n nh√¢n th·ª• ƒë·ªông, chuy·ªÉn th√†nh m·ªôt ng∆∞·ªùi tham gia c√≥ th·ªÉ ƒë·∫∑t c·ªù th·∫≠n tr·ªçng tr√™n b√†n c·ªù.',

              options: this.getTalentOptionsByMajor(majorTalent, 'growth'),
            },

            mutation: {
              prompt:
                'S·ª©c m·∫°nh b·∫Øt ƒë·∫ßu t√°c ƒë·ªông ng∆∞·ª£c l·∫°i t√¢m tr√≠ v√† h√†nh vi c·ªßa b·∫°n. B·∫°n c√≥ ƒë∆∞·ª£c nƒÉng l·ª±c m·∫°nh m·∫Ω h∆°n, nh∆∞ng c≈©ng c·∫£m nh·∫≠n ƒë∆∞·ª£c s·ª± ng·ªçt ng√†o v√† ƒëi√™n cu·ªìng ƒë√°ng s·ª£ ƒë·∫±ng sau n√≥.',

              options: this.getTalentOptionsByMajor(majorTalent, 'mutation'),
            },

            authority: {
              prompt:
                "Sau khi tr·∫£i qua ƒë·∫•u tranh n·ªôi t√¢m, b·∫°n ƒë√£ ƒë∆∞a ra l·ª±a ch·ªçn. B·∫°n kh√¥ng c√≤n coi n√≥ l√† l·ªùi nguy·ªÅn, m√† b·∫Øt ƒë·∫ßu t·∫≠n h∆∞·ªüng s·ª©c m·∫°nh n√†y, v√† ch·ªß ƒë·ªông r√®n gi≈©a n√≥ th√†nh 'Quy·ªÅn nƒÉng' thu·ªôc v·ªÅ m√¨nh.",

              options: this.getTalentOptionsByMajor(majorTalent, 'authority'),
            },

            abyss: {
              prompt:
                "B·∫°n ƒë√£ ƒëi ƒë·∫øn cu·ªëi con ƒë∆∞·ªùng n√†y. B·∫°n ho√†n to√†n h√≤a l√†m m·ªôt v·ªõi 'T√¨nh y√™u phi ph√†m' ƒë√£ ch·ªçn, tr·ªü th√†nh m·ªôt 'kh√°i ni·ªám' m·ªõi, m·ªôt 'Quy T·∫Øc Qu√°i ƒê√†m' m·ªõi.",

              options: this.getTalentOptionsByMajor(majorTalent, 'abyss'),
            },
          };

          return talentData[level];
        }

        isTalentAcquired(level, optionIndex) {
          try {
            const variables = this.getAllVariables();
            const levelChineseName = this.getLevelChineseName(level);
            const currentTalent = this.getVariable(variables, `stat_data.trainer.talent.minorTalent.${levelChineseName}`, null);

            if (currentTalent && currentTalent !== null && currentTalent !== '') {
              const levelData = this.getTalentData(level);
              if (levelData && levelData.options[optionIndex]) {
                return (
                  currentTalent === levelData.options[optionIndex].description ||
                  currentTalent === levelData.options[optionIndex].title
                );
              }
            }

            return false;
          } catch (error) {
            console.error('Ki·ªÉm tra tr·∫°ng th√°i Thi√™n ph√∫ th·∫•t b·∫°i:', error);
            return false;
          }
        }

        async selectTalentOption(level, optionIndex) {
          try {
            console.log('üîç B·∫Øt ƒë·∫ßu quy tr√¨nh ch·ªçn Thi√™n ph√∫...');

            const levelData = this.getTalentData(level);

            if (!levelData || !levelData.options[optionIndex]) {
              console.error('‚ùå D·ªØ li·ªáu Thi√™n ph√∫ kh√¥ng t·ªìn t·∫°i:', { level, optionIndex });
              return;
            }

            const option = levelData.options[optionIndex];
            console.log('üìã Thi√™n ph√∫ ƒë√£ ch·ªçn:', option);
            const variables = this.getAllVariables();
            const levelChineseName = this.getLevelChineseName(level);
            const currentTalent = this.getVariable(variables, `stat_data.trainer.talent.minorTalent.${levelChineseName}`, null);
            console.log('üîç Thi√™n ph√∫ c·∫•p b·∫≠c hi·ªán t·∫°i:', { levelChineseName, currentTalent });

            if (currentTalent && currentTalent !== null && currentTalent !== '') {
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage(`C·∫•p b·∫≠c n√†y ƒë√£ c√≥ l·ª±a ch·ªçn: ${currentTalent}, m·ªói c·∫•p b·∫≠c ch·ªâ c√≥ th·ªÉ ch·ªçn m·ªôt Thi√™n ph√∫!`);
              }
              return;
            }
            const cost = this.getTalentCost(level);
            const crystalsValue = this.getVariable(variables, 'stat_data.trainer.twistedAffectionCrystals', 0);
            const currentCrystals = parseInt(crystalsValue) || 0;

            console.log('üíé Ki·ªÉm tra k·∫øt tinh:', { cost, currentCrystals, raw: crystalsValue });

            if (currentCrystals < cost) {
              await this.showFullscreenAlert(`K·∫øt tinh kh√¥ng ƒë·ªß! C·∫ßn ${cost} k·∫øt tinh, hi·ªán t·∫°i ch·ªâ c√≥ ${currentCrystals} c√°i`, {
                title: 'K·∫øt tinh kh√¥ng ƒë·ªß',
                icon: 'üíé',
              });
              return;
            }
            const confirmed = await this.showFullscreenConfirm(
              `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën m·ªü kh√≥a Thi√™n ph√∫ "${option.title}" kh√¥ng?\n\nM√¥ t·∫£: ${option.description}\n\nHi·ªáu qu·∫£: ${option.effects}\n\nTi√™u hao: ${cost} k·∫øt tinh`,
              { title: 'M·ªü kh√≥a Thi√™n ph√∫', icon: '‚ú®', confirmText: 'M·ªü kh√≥a', cancelText: 'H·ªßy' },
            );

            if (!confirmed) return;

            console.log('‚úÖ Ng∆∞·ªùi d√πng x√°c nh·∫≠n l·ª±a ch·ªçn, chu·∫©n b·ªã g·ª≠i v√†o khung tr√≤ chuy·ªán...');
            const newCrystals = currentCrystals - cost;
            const levelNameMap = {
              seed: 'M·∫ßm m·ªëng',
              growth: 'Sinh tr∆∞·ªüng',
              mutation: 'Bi·∫øn d·ªã',
              authority: 'Quy·ªÅn nƒÉng',
              abyss: 'V·ª±c th·∫≥m',
            };
            const levelDisplayName = levelNameMap[level] || level;

            const skillUnlockMessage = `Ti√™u hao ${cost} Tinh th·ªÉ T√¨nh c·∫£m Bi·∫øn d·ªã, m·ªü kh√≥a Thi√™n ph√∫ t·∫ßng ${levelDisplayName}„Äê${option.title}„Äë, Hi·ªáu qu·∫£ Thi√™n ph√∫: ${option.effects}. M√¥ t·∫£ Thi√™n ph√∫: ${option.description}. K·∫øt tinh c√≤n l·∫°i: ${newCrystals} c√°i.`;
            try {
              const actionInput = document.getElementById('action-input');
              if (actionInput) {
                actionInput.value = skillUnlockMessage;
                if (this.handleActionSubmit && typeof this.handleActionSubmit === 'function') {
                  console.log('üì§ G·ª≠i tin nh·∫Øn m·ªü kh√≥a Thi√™n ph√∫ v√†o khung tr√≤ chuy·ªán th√¥ng qua handleActionSubmit...');
                  await this.handleActionSubmit();
                  console.log('‚úÖ Tin nh·∫Øn m·ªü kh√≥a Thi√™n ph√∫ ƒë√£ g·ª≠i v√†o khung tr√≤ chuy·ªán');
                } else {
                  console.error('‚ùå Ph∆∞∆°ng th·ª©c handleActionSubmit kh√¥ng kh·∫£ d·ª•ng');
                  if (typeof showTemporaryMessage === 'function') {
                    showTemporaryMessage('G·ª≠i th·∫•t b·∫°i: Ph∆∞∆°ng th·ª©c handleActionSubmit kh√¥ng kh·∫£ d·ª•ng');
                  }
                }
              } else {
                console.error('‚ùå Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ action-input');
              }
            } catch (error) {
              console.error('‚ùå G·ª≠i tin nh·∫Øn m·ªü kh√≥a Thi√™n ph√∫ th·∫•t b·∫°i:', error);
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage(`G·ª≠i tin nh·∫Øn m·ªü kh√≥a Thi√™n ph√∫ th·∫•t b·∫°i: ${error.message}`);
              }
            }

            console.log(`üéâ M·ªü kh√≥a k·ªπ nƒÉng ho√†n t·∫•t: ${option.title}, ti√™u hao ${cost} k·∫øt tinh`);

            this.updateTalentsModal();
            if (window.skillSystem && level === 'seed') {
              console.log('üéØ M·ªü kh√≥a Thi√™n ph√∫ M·∫ßm m·ªëng, c·∫≠p nh·∫≠t h·ªá th·ªëng k·ªπ nƒÉng...');
              window.skillSystem.checkSkillUnlock();
            }

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage(`Ch√∫c m·ª´ng nh·∫≠n ƒë∆∞·ª£c Thi√™n ph√∫: ${option.title}! Ti√™u hao ${cost} k·∫øt tinh, c√≤n l·∫°i ${newCrystals} c√°i`);
            }
          } catch (error) {
            console.error('‚ùå Ti√™m Thi√™n ph√∫ th·∫•t b·∫°i:', error);

            console.error('Chi ti·∫øt l·ªói:', {
              message: error.message,

              stack: error.stack,

              level,

              optionIndex,
            });

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage(`Ti√™m Thi√™n ph√∫ th·∫•t b·∫°i: ${error.message}, vui l√≤ng ki·ªÉm tra console ƒë·ªÉ bi·∫øt chi ti·∫øt`);
            }
          }
        }

        getLevelChineseName(level) {
          const levelMap = {
            seed: 'M·∫ßm m·ªëng',

            growth: 'Sinh tr∆∞·ªüng',

            mutation: 'Bi·∫øn d·ªã',

            authority: 'Quy·ªÅn nƒÉng',

            abyss: 'V·ª±c th·∫≥m',
          };

          return levelMap[level] || level;
        }

        getPreviousLevel(level) {
          const levelOrder = ['seed', 'growth', 'mutation', 'authority', 'abyss'];

          const currentIndex = levelOrder.indexOf(level);

          if (currentIndex <= 0) return null; 

          return levelOrder[currentIndex - 1];
        }
        isLevelUnlocked(level) {
          if (level === 'seed') return true;
          const previousLevel = this.getPreviousLevel(level);
          if (!previousLevel) return true;

          try {
            const variables = this.getAllVariables();
            const previousLevelChinese = this.getLevelChineseName(previousLevel);
            const previousTalent = this.getVariable(
              variables,
              `stat_data.trainer.talent.minorTalent.${previousLevelChinese}`,
              null,
            );
            return previousTalent && previousTalent !== null && previousTalent !== '';
          } catch (error) {
            console.error('Ki·ªÉm tra tr·∫°ng th√°i m·ªü kh√≥a c·∫•p b·∫≠c th·∫•t b·∫°i:', error);
            return false;
          }
        }

        getTalentOptionsByMajor(majorTalent, level) {
          const talentOptions = {
            'H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)': {
              seed: [
                {
                  title: 'Ph√≤ng Th·ªß M·ªü R·ªông',
                  description: "S·ª± chi·∫øm h·ªØu c·ªßa b·∫°n ƒë·ªëi v·ªõi 'ng∆∞·ªùi y√™u', khi·∫øn c√¥ ·∫•y khi ·ªü b√™n c·∫°nh b·∫°n c≈©ng nh·∫≠n ƒë∆∞·ª£c 25% hi·ªáu qu·∫£ tƒÉng ph√≤ng th·ªß c·ªßa b·∫°n.",
                  effects: 'Ph√≤ng th·ªß +25%',
                },

                {
                  title: 'Quy T·∫Øc M·ªü R·ªông',
                  description: "Khi b·∫°n c√πng 'ng∆∞·ªùi y√™u' gi·∫£i m√£ quy t·∫Øc, t·ª∑ l·ªá nh√¨n th·∫•u l·ªó h·ªïng tƒÉng nh·∫π.",
                  effects: 'Quy t·∫Øc th·∫•u th·ªã +15%',
                },

                {
                  title: 'Xi·ªÅng X√≠ch M·ªü R·ªông',
                  description: "Ph·∫°m vi c·∫£m nh·∫≠n c·ªßa xi·ªÅng x√≠ch v√¥ h√¨nh m·ªü r·ªông, cho ph√©p b·∫°n c·∫£m nh·∫≠n m∆° h·ªì v·ªã tr√≠ ƒë·∫°i kh√°i c·ªßa 'ng∆∞·ªùi y√™u'.",
                  effects: 'Ph·∫°m vi c·∫£m nh·∫≠n +20%',
                },
              ],

              growth: [
                {
                  title: 'Ph√≤ng Th·ªß C∆∞·ªùng H√≥a',
                  description: "Th·ªùi gian duy tr√¨ tƒÉng ph√≤ng th·ªß tƒÉng th√™m 50%, nh∆∞ng sau khi k·∫øt th√∫c, n·ªói ƒëau t·ª´ 'v·∫øt th∆∞∆°ng' s·∫Ω tƒÉng g·∫•p ƒë√¥i.",
                  effects: 'Th·ªùi gian duy tr√¨ +50%',
                },

                {
                  title: 'Quy T·∫Øc C∆∞·ªùng H√≥a',
                  description: 'B·∫°n c√≥ th·ªÉ ch·ªß ƒë·ªông ti√™u hao tinh th·∫ßn, c∆∞·ª°ng ch·∫ø nh√¨n th·∫•u l·ªó h·ªïng c·ªßa m·ªôt quy t·∫Øc ƒë∆°n gi·∫£n, nh∆∞ng t·∫ßm nh√¨n s·∫Ω t·∫°m th·ªùi b·ªã thu h·∫πp.',
                  effects: 'Quy t·∫Øc th·∫•u th·ªã +30%',
                },

                {
                  title: 'Xi·ªÅng X√≠ch C∆∞·ªùng H√≥a',
                  description: 'B·∫°n c√≥ th·ªÉ ti√™u hao th·ªÉ l·ª±c, c·ª• th·ªÉ h√≥a m·ªôt xi·ªÅng x√≠ch th·ª±c th·ªÉ ng·∫Øn h·∫°n, d√πng ƒë·ªÉ ng√°ng ch√¢n m·ª•c ti√™u ho·∫∑c k√©o v·∫≠t nh·∫π.',
                  effects: 'C·ª• th·ªÉ h√≥a xi·ªÅng x√≠ch',
                },
              ],

              mutation: [
                {
                  title: 'Ph√≤ng Th·ªß Bi·∫øn D·ªã',
                  description: "TƒÉng ph√≤ng th·ªß chuy·ªÉn th√†nh k√≠ch ho·∫°t b·ªã ƒë·ªông, nh∆∞ng ch·ªâ khi b·∫°n ho·∫∑c 'ng∆∞·ªùi y√™u' ch·ªãu s√°t th∆∞∆°ng m·ªõi c√≥ hi·ªáu l·ª±c, v√† b·∫°n s·∫Ω khao kh√°t s·ª± k√≠ch ho·∫°t n√†y.",
                  effects: 'Ph√≤ng th·ªß b·ªã ƒë·ªông',
                },

                {
                  title: 'Quy T·∫Øc Bi·∫øn D·ªã',
                  description: "B·∫°n b·∫Øt ƒë·∫ßu nh√¨n th·∫•y 'l·ªó h·ªïng quy t·∫Øc' trong c√°c m·ªëi quan h·ªá, gi√∫p b·∫°n d·ªÖ d√†ng thao t√∫ng ng∆∞·ªùi kh√°c, nh∆∞ng l√≤ng tin c·ªßa b·∫°n ƒë·ªëi v·ªõi ng∆∞·ªùi kh√°c gi·∫£m vƒ©nh vi·ªÖn.",
                  effects: 'Th·∫•u th·ªã x√£ h·ªôi',
                },

                {
                  title: 'Xi·ªÅng X√≠ch Bi·∫øn D·ªã',
                  description: "Xi·ªÅng x√≠ch s·∫Ω v√¥ th·ª©c qu·∫•n quanh b·∫°n v√† 'ng∆∞·ªùi y√™u', n·∫øu kho·∫£ng c√°ch qu√° xa, c·∫£ hai ƒë·ªÅu c·∫£m th·∫•y n·ªói ƒëau b·ªã tr√≥i bu·ªôc (ph·∫£n ph·ªá b·∫£n th√¢n).",
                  effects: 'Xi·ªÅng x√≠ch tr√≥i bu·ªôc',
                },
              ],

              authority: [
                {
                  title: 'Quy·ªÅN NƒÉng Ph√≤ng Th·ªß',
                  description: "B·∫°n c√≥ th·ªÉ tuy√™n b·ªë m·ªôt 'lƒ©nh v·ª±c ƒë·ªôc chi·∫øm' b√°n k√≠nh 5 m√©t, trong lƒ©nh v·ª±c n√†y hi·ªáu qu·∫£ tƒÉng ph√≤ng th·ªß c·ªßa b·∫°n t·∫°o ra l·ª±c ƒë·∫©y l√πi m·ªçi k·∫ª th√π.",
                  effects: 'Lƒ©nh v·ª±c ƒë·ªôc chi·∫øm',
                },

                {
                  title: 'Quy·ªÅn NƒÉng Quy T·∫Øc',
                  description: "B·∫°n c√≥ th·ªÉ ch·ªâ ƒë·ªãnh m·ªôt l·ªó h·ªïng quy t·∫Øc ƒë√£ nh√¨n th·∫•u, v√† t·∫°m th·ªùi 'ƒë√≥ng' n√≥ l·∫°i, ngƒÉn c·∫£n ng∆∞·ªùi kh√°c l·ª£i d·ª•ng.",
                  effects: 'Phong t·ªèa quy t·∫Øc',
                },

                {
                  title: 'Quy·ªÅn NƒÉng Xi·ªÅng X√≠ch',
                  description:
                    "B·∫°n c√≥ th·ªÉ 'neo' xi·ªÅng x√≠ch v√¥ h√¨nh l√™n m·ªôt m·ª•c ti√™u, khi·∫øn m·ªçi ki·ªÉm ƒë·ªãnh h√†nh ƒë·ªông c·ªßa h·ªç ch·ªãu ·∫£nh h∆∞·ªüng ti√™u c·ª±c cho ƒë·∫øn khi tho√°t kh·ªèi ph·∫°m vi c·∫£m nh·∫≠n c·ªßa b·∫°n.",
                  effects: 'Neo gi·ªØ xi·ªÅng x√≠ch',
                },
              ],

              abyss: [
                {
                  title: 'V·ª±c Th·∫≥m Ph√≤ng Th·ªß',
                  description:
                    "C∆° th·ªÉ b·∫°n r√†ng bu·ªôc v·ªõi v·∫≠n m·ªánh c·ªßa 'ng∆∞·ªùi y√™u', ch·ªâ c·∫ßn c√¥ ·∫•y c√≤n s·ªëng, ph√≤ng th·ªß v·∫≠t l√Ω c·ªßa b·∫°n s·∫Ω kh√¥ng bao gi·ªù b·ªã ph√° h·ªßy ho√†n to√†n, c√°i gi√° l√† b·∫°n s·∫Ω m·∫•t ƒëi √Ω th·ª©c 'c√°i t√¥i' ƒë·ªôc l·∫≠p.",
                  effects: 'R√†ng bu·ªôc v·∫≠n m·ªánh',
                },

                {
                  title: 'V·ª±c Th·∫≥m Quy T·∫Øc',
                  description:
                    'B·∫°n tr·ªü th√†nh m·ªôt ph·∫ßn c·ªßa quy t·∫Øc, c√≥ th·ªÉ vi·∫øt l·∫°i m·ªôt quy t·∫Øc ƒë∆°n gi·∫£n m√† b·∫°n ƒë√£ ho√†n to√†n nh√¨n th·∫•u, c√°i gi√° l√† s·ª± t·ªìn t·∫°i c·ªßa b·∫°n c≈©ng b·ªã quy t·∫Øc m·ªõi n√†y tr√≥i bu·ªôc vƒ©nh vi·ªÖn.',
                  effects: 'Vi·∫øt l·∫°i quy t·∫Øc',
                },

                {
                  title: 'V·ª±c Th·∫≥m Xi·ªÅng X√≠ch',
                  description: "B·∫°n v√† 'ng∆∞·ªùi y√™u' ƒë∆∞·ª£c k·∫øt n·ªëi b·ªüi xi·ªÅng x√≠ch vƒ©nh c·ª≠u, chia s·∫ª sinh m·ªánh v√† s·ª©c m·∫°nh, nh∆∞ng c≈©ng kh√¥ng bao gi·ªù c√≥ th·ªÉ t√°ch r·ªùi, tr·ªü th√†nh m·ªôt th·ªÉ c·ªông sinh.",
                  effects: 'Xi·ªÅng X√≠ch Vƒ©nh C·ª≠u',
                },
              ],
            },

            'H·ªá Bi·∫øn H√≥a (T√¨nh Y√™u D·ªëi Tr√°)': {
              seed: [
                {
                  title: 'Quy T·∫Øc M·ªü R·ªông',
                  description: "Khi b·∫°n ƒë·ªçc quy t·∫Øc, c√≥ t·ª∑ l·ªá nh√¨n th·∫•y m·ªôt c√¢u t·ª´ d·ªÖ b·ªã s·ª≠a ƒë·ªïi nh·∫•t ƒë∆∞·ª£c ƒë√°nh d·∫•u th√™m b·ªüi 'l·ªùi n√≥i d·ªëi'.",
                  effects: 'ƒê√°nh d·∫•u quy t·∫Øc',
                },

                {
                  title: 'T√¨nh C·∫£m M·ªü R·ªông',
                  description: 'L·ªùi n√≥i d·ªëi v√¥ h·∫°i ƒë·∫ßu ti√™n b·∫°n n√≥i ra s·∫Ω khi·∫øn b·∫°n t·ªèa ra h∆°i th·ªü y·∫øu ·ªõt, mang l·∫°i c·∫£m gi√°c an t√¢m.',
                  effects: 'H∆°i th·ªü an t√¢m',
                },

                {
                  title: 'C√°i B√≥ng M·ªü R·ªông',
                  description: 'B√≥ng c·ªßa b·∫°n s·∫Ω l·∫Øc l∆∞ nh·∫π khi √°nh s√°ng t·ªëi nh·∫•t, nh∆∞ ƒëang m√¥ ph·ªèng m·ªôt h√†nh ƒë·ªông kh√¥ng t·ªìn t·∫°i.',
                  effects: 'B√≥ng l·∫Øc l∆∞',
                },
              ],

              growth: [
                {
                  title: 'Quy T·∫Øc C∆∞·ªùng H√≥a',
                  description: 'B·∫°n c√≥ th·ªÉ ch·ªâ ƒë·ªãnh m·ªôt t·ª´ trong m√¥ t·∫£ quy t·∫Øc, d√πng m·ªôt t·ª´ ƒë·ªìng nghƒ©a ƒë·ªÉ thay th·∫ø t·∫°m th·ªùi, k√©o d√†i 1 ph√∫t.',
                  effects: 'Thay th·∫ø quy t·∫Øc',
                },

                {
                  title: 'T√¨nh C·∫£m C∆∞·ªùng H√≥a',
                  description: "B·∫°n c√≥ th·ªÉ c·ª• th·ªÉ h√≥a m·ªôt l·ªùi n√≥i d·ªëi ƒë∆°n gi·∫£n (nh∆∞ 't√¥i ·ªïn'), ti√™m v√†o c∆° th·ªÉ m·ª•c ti√™u, khi·∫øn h·ªç t·∫°m th·ªùi b·ªè qua tr·∫°ng th√°i ti√™u c·ª±c c·ªßa b·∫°n.",
                  effects: 'C·ª• th·ªÉ h√≥a l·ªùi n√≥i d·ªëi',
                },

                {
                  title: 'C√°i B√≥ng C∆∞·ªùng H√≥a',
                  description: 'B·∫°n c√≥ th·ªÉ ra l·ªánh cho b√≥ng c·ªßa m√¨nh th·ª±c hi·ªán m·ªôt h√†nh ƒë·ªông ƒë∆°n gi·∫£n, phi th·ª±c th·ªÉ (nh∆∞ v·∫´y tay) ƒë·ªÉ thu h√∫t s·ª± ch√∫ √Ω.',
                  effects: 'Ki·ªÉm so√°t b√≥ng',
                },
              ],

              mutation: [
                {
                  title: 'Quy T·∫Øc Bi·∫øn D·ªã',
                  description: 'Khi b·∫°n s·ª≠a ƒë·ªïi quy t·∫Øc, c√≥ t·ª∑ l·ªá khi·∫øn m·ªôt ph·∫ßn kh√°c c·ªßa quy t·∫Øc ƒë√≥ tr·ªü n√™n nghi√™m kh·∫Øc h∆°n (quy t·∫Øc kh√¥ng ·ªïn ƒë·ªãnh ph·∫£n ph·ªá).',
                  effects: 'Ph·∫£n ph·ªá quy t·∫Øc',
                },

                {
                  title: 'T√¨nh C·∫£m Bi·∫øn D·ªã',
                  description: 'N·∫øu l·ªùi n√≥i d·ªëi t√¨nh c·∫£m b·∫°n c·ª• th·ªÉ h√≥a b·ªã v·∫°ch tr·∫ßn, hi·ªáu qu·∫£ t√™ li·ªát s·∫Ω l·∫≠p t·ª©c chuy·ªÉn th√†nh thu·ªëc ƒë·ªôc tinh th·∫ßn g√¢y ƒëau ƒë·ªõn cho m·ª•c ti√™u.',
                  effects: 'Thu·ªëc ƒë·ªôc l·ªùi n√≥i d·ªëi',
                },

                {
                  title: 'C√°i B√≥ng Bi·∫øn D·ªã',
                  description:
                    'Sau khi b√≥ng ch·ªãu s√°t th∆∞∆°ng, b·∫£n th√¢n b·∫°n s·∫Ω xu·∫•t hi·ªán ng·∫´u nhi√™n m·ªôt v·∫øt b·∫ßm t√≠m t∆∞∆°ng ·ª©ng v·ªõi v·ªã tr√≠ b√≥ng b·ªã th∆∞∆°ng trong v√≤ng 24 gi·ªù (ƒëi·ªÅm b√°o s√°t th∆∞∆°ng c·ªông d·ªìn).',
                  effects: 'Ph·∫£n h·ªìi s√°t th∆∞∆°ng',
                },
              ],

              authority: [
                {
                  title: 'Quy·ªÅn NƒÉng Quy T·∫Øc',
                  description: 'B·∫°n c√≥ th·ªÉ b·ªãa ƒë·∫∑t m·ªôt quy t·∫Øc ho√†n to√†n m·ªõi, c√≥ v·∫ª h·ª£p l√Ω, v√† t·∫°m th·ªùi th√™m n√≥ v√†o vƒÉn b·∫£n quy t·∫Øc hi·ªán c√≥.',
                  effects: 'B·ªãa ƒë·∫∑t quy t·∫Øc',
                },

                {
                  title: 'Quy·ªÅn NƒÉng T√¨nh C·∫£m',
                  description: "B·∫°n c√≥ th·ªÉ b·ªãa ƒë·∫∑t m·ªôt lo·∫°i 't√¨nh c·∫£m ph·ª©c h·ª£p' ph·ª©c t·∫°p (nh∆∞ 'n·ªói bu·ªìn vui v·∫ª'), l√†m t√™ li·ªát ph√°n ƒëo√°n logic c·∫•p cao c·ªßa ƒë·ªëi th·ªß.",
                  effects: 'T√¨nh c·∫£m ph·ª©c h·ª£p',
                },

                {
                  title: 'Quy·ªÅn NƒÉng B√≥ng T·ªëi',
                  description: 'B·∫°n c√≥ th·ªÉ t·∫°o ra m·ªôt c√°i b√≥ng gi·∫£ c√≥ th·ªÉ r·ªùi kh·ªèi c∆° th·ªÉ b·∫°n, t·ªìn t·∫°i trong 10 gi√¢y, d√πng ƒë·ªÉ ch·ªãu m·ªôt ƒë√≤n t·∫•n c√¥ng ch·ªâ ƒë·ªãnh.',
                  effects: 'B√≥ng gi·∫£',
                },
              ],

              abyss: [
                {
                  title: 'V·ª±c Th·∫≥m Quy T·∫Øc',
                  description:
                    "B·∫°n tr·ªü th√†nh 'l·ªùi n√≥i d·ªëi di ƒë·ªông', l·ªùi b·∫°n n√≥i ra trong th·ªùi gian ng·∫Øn s·∫Ω ƒë∆∞·ª£c ng∆∞·ªùi kh√°c v√¥ th·ª©c coi l√† 'quy t·∫Øc' ƒë·ªÉ tu√¢n th·ªß, c√°i gi√° l√† ch√≠nh b·∫°n c≈©ng kh√¥ng th·ªÉ ph√¢n bi·ªát th·∫≠t gi·∫£.",
                  effects: 'L·ªùi n√≥i d·ªëi di ƒë·ªông',
                },

                {
                  title: 'V·ª±c Th·∫≥m T√¨nh C·∫£m',
                  description:
                    'T√¨nh c·∫£m b·∫°n b·ªãa ƒë·∫∑t c√≥ th·ªÉ thay ƒë·ªïi vƒ©nh vi·ªÖn n·ªÅn t·∫£ng t√≠nh c√°ch c·ªßa m·ªôt ng∆∞·ªùi, c√°i gi√° l√† m·ªçi l·ªùi n√≥i d·ªëi b·∫°n n√≥i ra cu·ªëi c√πng s·∫Ω c·ª• th·ªÉ h√≥a ƒë·∫∑c bi·ªát tr√™n ng∆∞·ªùi b·∫°n th√†nh m·ªëi nguy hi·ªÉm m·ªõi.',
                  effects: 'T√°i t·∫°o t√≠nh c√°ch',
                },

                {
                  title: 'V·ª±c Th·∫≥m C√°i B√≥ng',
                  description:
                    'B·∫°n c√≥ th·ªÉ ƒë·ªïi ch·ªó v·ªõi b√≥ng c·ªßa m√¨nh, ƒë·ªÉ n√≥ ch·ªãu m·ªçi s√°t th∆∞∆°ng, nh∆∞ng khi b√≥ng b√πng n·ªï, m·ªçi s√°t th∆∞∆°ng t√≠ch l≈©y s·∫Ω tr·∫£ l·∫°i cho b·∫°n m·ªôt l·∫ßn.',
                  effects: 'Ho√°n ƒë·ªïi b√≥ng',
                },
              ],
            },

            'H·ªá Ph√≥ng X·∫° (T√¨nh Y√™u Hy Sinh)': {
              seed: [
                {
                  title: 'C·∫£m X√∫c M·ªü R·ªông',
                  description: 'Khi b·∫°n c·∫£m th·∫•y ƒëau bu·ªìn m√£nh li·ªát, c√°c m·ª•c ti√™u th√π ƒë·ªãch xung quanh s·∫Ω c·∫£m th·∫•y b·ªëi r·ªëi nh·∫π, ƒë·ªô ch√≠nh x√°c t·∫•n c√¥ng gi·∫£m nh·∫π.',
                  effects: 'N·ªói bu·ªìn m√™ ho·∫∑c',
                },

                {
                  title: 'Hi·∫øn T·∫ø M·ªü R·ªông',
                  description: 'ƒê∆∞·ªùng n√©t c·ªßa m·ªôt k√Ω ·ª©c b·∫°n tr√¢n tr·ªçng nh·∫•t s·∫Ω tr·ªü n√™n m∆° h·ªì, ƒë·ªïi l·∫°i, kh√°ng t√≠nh s·ª≠a ƒë·ªïi quy t·∫Øc c·ªßa b·∫°n tƒÉng nh·∫π.',
                  effects: 'K√Ω ·ª©c m∆° h·ªì',
                },

                {
                  title: 'Ph√¢n Th√¢n M·ªü R·ªông',
                  description: "B·∫°n c√≥ th·ªÉ c·∫£m nh·∫≠n ƒë∆∞·ª£c m·ªôt '·∫£o ·∫£nh' c√≥ ngo·∫°i h√¨nh gi·ªëng b·∫°n t·ªìn t·∫°i ·ªü ƒë√¢u ƒë√≥, nh∆∞ng kh√¥ng th·ªÉ giao ti·∫øp ho·∫∑c ki·ªÉm so√°t.",
                  effects: 'C·∫£m nh·∫≠n ·∫£o ·∫£nh',
                },
              ],

              growth: [
                {
                  title: 'Gi·∫£i Ph√≥ng C·∫£m X√∫c',
                  description:
                    'B·∫°n c√≥ th·ªÉ ch·ªß ƒë·ªông gi·∫£i ph√≥ng m·ªôt ƒëo·∫°n c·∫£m x√∫c ƒëau kh·ªï, khi·∫øn m·ªôt m·ª•c ti√™u ch·ªâ ƒë·ªãnh t·∫°m th·ªùi (kho·∫£ng 5 gi√¢y) m·∫•t ƒëi t√≠nh t·∫•n c√¥ng, c√°i gi√° l√† k√Ω ·ª©c t∆∞∆°ng ·ª©ng v·ªõi ƒëo·∫°n c·∫£m x√∫c ƒë√≥ s·∫Ω xu·∫•t hi·ªán v·∫øt n·ª©t.',
                  effects: 'Gi·∫£i ph√≥ng c·∫£m x√∫c',
                },

                {
                  title: 'Hi·∫øn T·∫ø Sinh M·ªánh',
                  description: "B·∫°n c√≥ th·ªÉ ti√™u hao m·ªôt l∆∞·ª£ng nh·ªè sinh m·ªánh (bi·ªÉu hi·ªán l√† m·ªôt v·∫øt th∆∞∆°ng nh·ªè kh√¥ng th·ªÉ l√†nh), ƒë·ªÉ 'x√≥a' m·ªôt t·ª´ kh√¥ng ph·∫£i t·ª´ kh√≥a trong vƒÉn b·∫£n quy t·∫Øc.",
                  effects: 'Hi·∫øn t·∫ø sinh m·ªánh',
                },

                {
                  title: 'C·ª• Th·ªÉ H√≥a Ph√¢n Th√¢n',
                  description: "B·∫°n c√≥ th·ªÉ ti√™u hao l∆∞·ª£ng l·ªõn th·ªÉ l·ª±c, c·ª• th·ªÉ h√≥a '·∫£o ·∫£nh' ng·∫Øn h·∫°n t·∫°i v·ªã tr√≠ ch·ªâ ƒë·ªãnh trong 1 gi√¢y, d√πng ƒë·ªÉ ƒë·ª° ƒë√≤n ho·∫∑c g√¢y r·ªëi.",
                  effects: 'C·ª• th·ªÉ h√≥a ph√¢n th√¢n',
                },
              ],

              mutation: [
                {
                  title: 'C·∫£m X√∫c Bi·∫øn D·ªã',
                  description:
                    'C·∫£m x√∫c b·∫°n gi·∫£i ph√≥ng b·∫Øt ƒë·∫ßu mang t√≠nh ƒÉn m√≤n, k·∫ª th√π m·∫•t ƒëi t√≠nh t·∫•n c√¥ng ƒë·ªìng th·ªùi l√Ω tr√≠ c≈©ng b·ªã ƒÉn m√≤n nh·∫π, nh∆∞ng gi·ªõi h·∫°n tinh th·∫ßn l·ª±c c·ªßa b·∫°n s·∫Ω gi·∫£m vƒ©nh vi·ªÖn v√¨ ƒëi·ªÅu n√†y.',
                  effects: 'C·∫£m x√∫c ƒÉn m√≤n',
                },

                {
                  title: 'Quy T·∫Øc Bi·∫øn D·ªã',
                  description: 'Quy t·∫Øc b·∫°n ti√™u hao k√Ω ·ª©c ƒë·ªÉ s·ª≠a ƒë·ªïi, sau khi m·∫•t hi·ªáu l·ª±c s·∫Ω quay l·∫°i d∆∞·ªõi h√¨nh th·ª©c kh√≥ hi·ªÉu h∆°n, tƒÉng ƒë·ªô kh√≥ gi·∫£i m√£.',
                  effects: 'Quy t·∫Øc quay l·∫°i',
                },

                {
                  title: 'Ph√¢n Th√¢n Bi·∫øn D·ªã',
                  description:
                    'Ph√¢n th√¢n c·ªßa b·∫°n b·∫Øt ƒë·∫ßu c√≥ √Ω th·ª©c t·ª± ch·ªß y·∫øu ·ªõt, ƒë√¥i khi s·∫Ω th·ª±c hi·ªán nh·ªØng ƒë·ªông t√°c nh·ªè tr√°i l·ªánh c·ªßa b·∫°n, n·ªói ƒëau n√≥ ch·ªãu ƒë·ª±ng s·∫Ω ph·∫£n h·ªìi nh·∫π l√™n b·∫°n.',
                  effects: '√ù th·ª©c ph√¢n th√¢n',
                },
              ],

              authority: [
                {
                  title: 'Quy·ªÅn NƒÉng C·∫£m X√∫c',
                  description: "B·∫°n c√≥ th·ªÉ g√°n c·∫£m x√∫c 'tuy·ªát v·ªçng' cho m·ªôt khu v·ª±c, t·∫•t c·∫£ k·∫ª th√π ƒëi v√†o khu v·ª±c ƒë√≥ s·∫Ω ch·ªãu s·ª± suy y·∫øu √Ω ch√≠ li√™n t·ª•c.",
                  effects: 'Lƒ©nh v·ª±c tuy·ªát v·ªçng',
                },

                {
                  title: 'Quy·ªÅn NƒÉng K√Ω ·ª®c',
                  description: 'B·∫°n c√≥ th·ªÉ hi·∫øn t·∫ø ho√†n to√†n m·ªôt ƒëo·∫°n k√Ω ·ª©c tr·ªçn v·∫πn, d√πng l√†m c√°i gi√° ƒë·ªÉ c∆∞·ª°ng ch·∫ø s·ª≠a ƒë·ªïi logic c·ªët l√µi c·ªßa m·ªôt quy t·∫Øc ƒë∆°n gi·∫£n.',
                  effects: 'Hi·∫øn t·∫ø k√Ω ·ª©c',
                },

                {
                  title: 'Quy·ªÅn NƒÉng Ph√¢n Th√¢n',
                  description:
                    'B·∫°n c√≥ th·ªÉ c·ª• th·ªÉ h√≥a m·ªôt ph√¢n th√¢n t·ªìn t·∫°i trong 1 ph√∫t, v√† giao cho n√≥ m·ªôt m·ªánh l·ªánh r√µ r√†ng, nh∆∞ng khi ph√¢n th√¢n b·ªã ph√° h·ªßy, b·∫°n s·∫Ω ch·ªãu 50% s√°t th∆∞∆°ng n√≥ ƒë√£ nh·∫≠n.',
                  effects: 'Ph√¢n th√¢n b·ªÅn v·ªØng',
                },
              ],

              abyss: [
                {
                  title: 'V·ª±c Th·∫≥m C·∫£m X√∫c',
                  description:
                    "B·∫°n tr·ªü th√†nh h√≥a th√¢n c·ªßa 'hy sinh', s·ª± t·ªìn t·∫°i c·ªßa b·∫°n s·∫Ω khi·∫øn c√°c sinh v·∫≠t xung quanh m·∫•t ƒëi √Ω mu·ªën ƒë·∫•u tranh, c√°i gi√° l√† c·∫£m x√∫c c·ªßa ch√≠nh b·∫°n c≈©ng theo ƒë√≥ m√† ti√™u bi·∫øn ho√†n to√†n.",
                  effects: 'H√≥a th√¢n hy sinh',
                },

                {
                  title: 'V·ª±c Th·∫≥m Quy T·∫Øc',
                  description:
                    'B·∫°n c√≥ th·ªÉ ti√™m vƒ©nh vi·ªÖn m·ªôt ph·∫ßn sinh m·ªánh c·ªßa m√¨nh v√†o m·ªôt quy t·∫Øc, khi·∫øn n√≥ ph·ª•c v·ª• b·∫°n, nh∆∞ng s·ª± t·ªìn t·∫°i c·ªßa b·∫°n c≈©ng b·ªã r√†ng bu·ªôc v·ªõi quy t·∫Øc ƒë√≥, khi quy t·∫Øc b·ªã ph√° gi·∫£i b·∫°n s·∫Ω ch·ªãu tr·ªçng th∆∞∆°ng.',
                  effects: 'R√†ng bu·ªôc quy t·∫Øc',
                },

                {
                  title: 'V·ª±c Th·∫≥m Ph√¢n Th√¢n',
                  description: 'B·∫°n c√≥ th·ªÉ t·∫°o ra m·ªôt ph√¢n th√¢n ho√†n to√†n gi·ªëng b·∫°n, chia s·∫ª gi√°c quan v√† sinh m·ªánh, nh∆∞ng khi ph√¢n th√¢n ch·∫øt, b·∫°n c≈©ng s·∫Ω ch·∫øt theo.',
                  effects: 'Chia s·∫ª sinh m·ªánh',
                },
              ],
            },

            'H·ªá Thao T√°c (T√¨nh Y√™u Ki·ªÉm So√°t)': {
              seed: [
                {
                  title: '√Åm Th·ªã M·ªü R·ªông',
                  description: 'B·∫°n c√≥ th·ªÉ b·ªã ƒë·ªông c·∫£m nh·∫≠n trong ƒë√°m ƒë√¥ng xung quanh, ai c√≥ √Ω ch√≠ y·∫øu nh·∫•t, d·ªÖ ch·∫•p nh·∫≠n √°m th·ªã t√¢m l√Ω h∆°n.',
                  effects: 'C·∫£m nh·∫≠n √Ω ch√≠',
                },

                {
                  title: 'Thao T√∫ng M·ªü R·ªông',
                  description: 'B·∫°n c√≥ th·ªÉ c·∫£m ·ª©ng m∆° h·ªì xem g·∫ßn ƒë√≥ c√≥ t√†n qu√¢n v·ª´a m·∫•t √Ω ch√≠ chi·∫øn ƒë·∫•u, th√≠ch h·ª£p ƒë·ªÉ b·ªã thao t√∫ng hay kh√¥ng.',
                  effects: 'C·∫£m nh·∫≠n t√†n qu√¢n',
                },

                {
                  title: 'H·∫•p Th·ª• M·ªü R·ªông',
                  description: "B·∫°n c√≥ th·ªÉ ph√¢n bi·ªát c∆∞·ªùng ƒë·ªô 't√¨nh y√™u' m√† NPC t·ªèa ra ƒë·ªëi v·ªõi b·∫°n, nh∆∞ng c·∫£m nh·∫≠n n√†y khi·∫øn b·∫°n th·∫•y l·∫°nh l·∫Ωo.",
                  effects: 'C·∫£m nh·∫≠n t√¨nh y√™u',
                },
              ],

              growth: [
                {
                  title: '√Åm Th·ªã C∆∞·ªùng H√≥a',
                  description: "B·∫°n c√≥ th·ªÉ c·∫•y m·ªôt √°m th·ªã t·ª´ ng·ªØ ƒë∆°n gi·∫£n v√†o m·ªôt NPC, v√≠ d·ª• 'qu√™n l√£ng' ho·∫∑c 'tin t∆∞·ªüng'.",
                  effects: '√Åm th·ªã t·ª´ ng·ªØ',
                },

                {
                  title: 'Thao T√∫ng C∆∞·ªùng H√≥a',
                  description: 'B·∫°n c√≥ th·ªÉ thao t√∫ng m·ªôt k·∫ª th√π nh·ªè v·ª´a b·ªã b·∫°n ƒë√°nh b·∫°i ƒë·ªÉ chi·∫øn ƒë·∫•u cho b·∫°n, th·ªùi gian duy tr√¨ m·ªôt ph√∫t.',
                  effects: 'Thao t√∫ng k·∫ª th√π',
                },

                {
                  title: 'H·∫•p Th·ª• C∆∞·ªùng H√≥a',
                  description: "B·∫°n c√≥ th·ªÉ h·∫•p th·ª• 't√¨nh y√™u' m√† m·ªôt NPC t·ª± nguy·ªán trao t·∫∑ng, c∆∞·ªùng h√≥a nh·∫π m·ªôt nƒÉng l·ª±c c∆° th·ªÉ c·ªßa b·∫°n.",
                  effects: 'H·∫•p th·ª• t√¨nh y√™u',
                },
              ],

              mutation: [
                {
                  title: '√Åm Th·ªã Bi·∫øn D·ªã',
                  description: 'Hi·ªáu qu·∫£ √°m th·ªã b·∫°n c·∫•y v√†o tƒÉng l√™n, nh∆∞ng c√°i gi√° l√† c·∫£m x√∫c c·ªßa ch√≠nh b·∫°n s·∫Ω tr·ªü n√™n t√™ li·ªát.',
                  effects: 'TƒÉng c∆∞·ªùng √°m th·ªã',
                },

                {
                  title: 'Thao T√∫ng Bi·∫øn D·ªã',
                  description: 'K·∫ª th√π b·ªã thao t√∫ng n·∫øu nh·∫≠n ra m√¨nh b·ªã ƒëi·ªÅu khi·ªÉn, s·∫Ω l·∫≠p t·ª©c tho√°t kh·ªèi ki·ªÉm so√°t v√† th·ª±c hi·ªán m·ªôt ƒë√≤n ph·∫£n c√¥ng m√£nh li·ªát m·ªôt l·∫ßn v√†o b·∫°n.',
                  effects: 'Thao t√∫ng ph·∫£n ph·ªá',
                },

                {
                  title: 'H·∫•p Th·ª• Bi·∫øn D·ªã',
                  description: "'T√¨nh y√™u' ƒë∆∞·ª£c h·∫•p th·ª• s·∫Ω ƒë·ªÉ l·∫°i tr√™n ng∆∞·ªùi b·∫°n m·ªôt d·∫•u ·∫•n ƒë·∫∑c bi·ªát kh√¥ng th·ªÉ x√≥a b·ªè, tr·ªü th√†nh m·ªôt ƒëi·ªÉm y·∫øu c·ªßa b·∫°n.",
                  effects: 'D·∫•u ·∫•n t√¨nh y√™u',
                },
              ],

              authority: [
                {
                  title: 'Quy·ªÅn NƒÉng √Åm Th·ªã',
                  description: 'B·∫°n c√≥ th·ªÉ ra m·ªôt m·ªánh l·ªánh tr·ªçn v·∫πn, kh√¥ng t·ª± s√°t cho NPC, mi·ªÖn l√† √Ω ch√≠ c·ªßa h·ªç th·∫•p h∆°n b·∫°n.',
                  effects: 'M·ªánh l·ªánh tr·ªçn v·∫πn',
                },

                {
                  title: 'Quy·ªÅn NƒÉng Thao T√∫ng',
                  description: 'B·∫°n c√≥ th·ªÉ ƒë·ªìng th·ªùi thao t√∫ng hai k·∫ª th√π b·ªã ƒë√°nh b·∫°i, nh∆∞ng trong th·ªùi gian ƒë√≥ b·∫°n ph·∫£i gi·ªØ s·ª± t·∫≠p trung, kh√¥ng th·ªÉ di chuy·ªÉn ho·∫∑c t·∫•n c√¥ng.',
                  effects: 'Thao t√∫ng k√©p',
                },

                {
                  title: 'Quy·ªÅn NƒÉng H·∫•p Th·ª•',
                  description: "B·∫°n c√≥ th·ªÉ c∆∞·ª°ng ch·∫ø h·∫•p th·ª• 't√¨nh y√™u' c·ªßa NPC, v√† d·ª±a v√†o ƒë·∫∑c ch·∫•t c·ªßa h·ªç ƒë·ªÉ nh·∫≠n ƒë∆∞·ª£c m·ªôt nƒÉng l·ª±c ƒë·∫∑c bi·ªát t·∫°m th·ªùi.",
                  effects: 'C∆∞·ª°ng ch·∫ø h·∫•p th·ª•',
                },
              ],

              abyss: [
                {
                  title: 'V·ª±c Th·∫≥m √Åm Th·ªã',
                  description: 'S·ª± t·ªìn t·∫°i c·ªßa b·∫°n tr·ªü th√†nh m·ªôt lo·∫°i √°m th·ªã t√¢m l√Ω, k·∫ª y·∫øu s·∫Ω v√¥ th·ª©c ph·ª•c t√πng b·∫°n, nh∆∞ng b·∫°n c≈©ng s·∫Ω m·∫•t ƒëi ho√†n to√†n m·ªçi c·∫£m x√∫c c√° nh√¢n.',
                  effects: '√Åm th·ªã hi·ªán h·ªØu',
                },

                {
                  title: 'V·ª±c Th·∫≥m Thao T√∫ng',
                  description: 'B·∫°n c√≥ th·ªÉ ti√™m √Ω th·ª©c ho√†n to√†n v√†o c∆° th·ªÉ m·ªôt k·∫ª th√π m·∫°nh ƒë·ªÉ thao t√∫ng, nh∆∞ng n·∫øu n√≥ b·ªã ph√° h·ªßy, tinh th·∫ßn c·ªßa b·∫°n c≈©ng s·∫Ω ch·ªãu tr·ªçng th∆∞∆°ng.',
                  effects: 'Ti√™m √Ω th·ª©c',
                },

                {
                  title: 'V·ª±c Th·∫≥m H·∫•p Th·ª•',
                  description: "B·∫°n h·∫•p th·ª• m·ªôt l∆∞·ª£ng l·ªõn 't√¨nh y√™u' m·ªôt l·∫ßn ƒë·ªÉ c√≥ s·ª©c m·∫°nh to l·ªõn, nh∆∞ng t√¨nh y√™u n√†y s·∫Ω l·∫≠p t·ª©c chuy·ªÉn h√≥a th√†nh h·∫≠n th√π ch√≠ m·∫°ng, tr·ªü th√†nh l·ªùi nguy·ªÅn kh√≥a ch·∫∑t b·∫°n.",
                  effects: 'L·ªùi nguy·ªÅn t√¨nh y√™u',
                },
              ],
            },

            'H·ªá C·ª• Th·ªÉ H√≥a (T√¨nh Y√™u L√Ω T∆∞·ªüng)': {
              seed: [
                {
                  title: '√Åo Gi√°p M·ªü R·ªông',
                  description: "Khi b·∫°n t∆∞·ªüng t∆∞·ª£ng 'ƒë∆∞·ª£c b·∫£o v·ªá', da b·∫°n s·∫Ω tho√°ng hi·ªán l√™n m·ªôt l·ªõp √°nh kim c∆∞∆°ng kh√≥ th·∫•y.",
                  effects: '√Ånh kim c∆∞∆°ng',
                },

                {
                  title: 'Nh·∫´n M·ªü R·ªông',
                  description: "Khi b·∫°n n·∫£y sinh ·∫£o t∆∞·ªüng 'l·ªùi h·ª©a' m√£nh li·ªát v·ªõi ai ƒë√≥, ƒë·∫ßu ng√≥n tay b·∫°n s·∫Ω c·∫£m th·∫•y ch√∫t c·∫£m gi√°c tr√≥i bu·ªôc l·∫°nh l·∫Ωo.",
                  effects: 'Tr√≥i bu·ªôc l·ªùi h·ª©a',
                },

                {
                  title: 'NPC M·ªü R·ªông',
                  description: 'Khi b·∫°n c·ª±c k·ª≥ c√¥ ƒë∆°n, b·∫°n s·∫Ω nghe th·∫•y m·ªôt gi·ªçng n√≥i m∆° h·ªì m√† ho√†n h·∫£o, ch·ªâ t·ªìn t·∫°i trong ƒë·∫ßu b·∫°n ƒëang an ·ªßi b·∫°n.',
                  effects: 'Gi·ªçng n√≥i ho√†n h·∫£o',
                },
              ],

              growth: [
                {
                  title: 'C·ª• Th·ªÉ H√≥a √Åo Gi√°p',
                  description: 'B·∫°n c√≥ th·ªÉ ti√™u hao tinh th·∫ßn l·ª±c, c·ª• th·ªÉ h√≥a m·ªôt m·∫£nh √°o gi√°p nh·∫π ·ªü m·ªôt b·ªô ph·∫≠n c∆° th·ªÉ, d√πng ƒë·ªÉ ƒë·ª° m·ªôt ƒë√≤n t·∫•n c√¥ng.',
                  effects: '√Åo gi√°p nh·∫π',
                },

                {
                  title: 'C·ª• Th·ªÉ H√≥a Nh·∫´n',
                  description: 'B·∫°n c√≥ th·ªÉ c·ª• th·ªÉ h√≥a m·ªôt chi·∫øc nh·∫´n h∆∞ ·∫£o ƒëeo l√™n tay, n√≥ gi√∫p l·ªùi n√≥i c·ªßa b·∫°n c√≥ tr·ªçng l∆∞·ª£ng h∆°n khi thuy·∫øt ph·ª•c ho·∫∑c ƒë√†m ph√°n.',
                  effects: 'Nh·∫´n h∆∞ ·∫£o',
                },

                {
                  title: 'C·ª• Th·ªÉ H√≥a Npc',
                  description: 'B·∫°n c√≥ th·ªÉ c·ª• th·ªÉ h√≥a ng·∫Øn h·∫°n m·ªôt ·∫£o ·∫£nh NPC ho√†n h·∫£o, b√°n trong su·ªët, d√πng ƒë·ªÉ thu h√∫t s·ª± ch√∫ √Ω c·ªßa k·∫ª th√π.',
                  effects: '·∫¢o ·∫£nh ho√†n h·∫£o',
                },
              ],

              mutation: [
                {
                  title: '√Åo Gi√°p Bi·∫øn D·ªã',
                  description: "√Åo gi√°p ƒë∆∞·ª£c c·ª• th·ªÉ h√≥a b·∫Øt ƒë·∫ßu n·∫£y sinh 't√¨nh y√™u' v·ªõi b·∫°n, ch·ªâ khi b·∫°n c≈©ng ƒë√°p l·∫°i b·∫±ng 't√¨nh y√™u', n√≥ m·ªõi h·∫•p th·ª• s√°t th∆∞∆°ng cho b·∫°n.",
                  effects: 'T√¨nh y√™u √°o gi√°p',
                },

                {
                  title: 'Nh·∫´n Bi·∫øn D·ªã',
                  description: 'N·∫øu b·∫°n vi ph·∫°m l·ªùi h·ª©a ƒë√£ th·ªÅ khi ƒëeo nh·∫´n, chi·∫øc nh·∫´n s·∫Ω h√≥a th√†nh m·ªôt xi·ªÅng x√≠ch th·ª±c s·ª±, tr√≥i bu·ªôc c·ªï tay b·∫°n.',
                  effects: 'Xi·ªÅng x√≠ch l·ªùi h·ª©a',
                },

                {
                  title: 'NPC Bi·∫øn D·ªã',
                  description: "NPC ho√†n h·∫£o ƒë∆∞·ª£c c·ª• th·ªÉ h√≥a b·∫Øt ƒë·∫ßu ti√™u hao 't√¨nh y√™u' ch√¢n th·ª±c c·ªßa b·∫°n ƒë·ªÉ duy tr√¨ h√¨nh th√°i, v√† s·∫Ω ghen t·ªã khi b·∫°n giao ti·∫øp v·ªõi ng∆∞·ªùi th·∫≠t kh√°c.",
                  effects: 'NPC ghen t·ªã',
                },
              ],

              authority: [
                {
                  title: 'Quy·ªÅn NƒÉng √Åo Gi√°p',
                  description: 'B·∫°n c√≥ th·ªÉ c·ª• th·ªÉ h√≥a m·ªôt b·ªô √°o gi√°p bao ph·ªß to√†n th√¢n, nh∆∞ng √°o gi√°p s·∫Ω li√™n t·ª•c n·∫∑ng th√™m theo th·ªùi gian, cu·ªëi c√πng h·∫°n ch·∫ø h√†nh ƒë·ªông c·ªßa b·∫°n.',
                  effects: '√Åo gi√°p to√†n th√¢n',
                },

                {
                  title: 'Quy·ªÅn NƒÉng Nh·∫´n',
                  description: "B·∫°n c√≥ th·ªÉ c·ª• th·ªÉ h√≥a m·ªôt chi·∫øc nh·∫´n s·ªü h·ªØu s·ª©c m·∫°nh to l·ªõn, nh∆∞ng s·ª©c m·∫°nh c·ªßa n√≥ ho√†n to√†n ph·ª• thu·ªôc v√†o c∆∞·ªùng ƒë·ªô ni·ªÅm tin c·ªßa b·∫°n v√†o 't√¨nh y√™u l√Ω t∆∞·ªüng'.",
                  effects: 'Nh·∫´n s·ª©c m·∫°nh',
                },

                {
                  title: 'Quy·ªÅn NƒÉng Npc',
                  description:
                    'B·∫°n c√≥ th·ªÉ c·ª• th·ªÉ h√≥a m·ªôt NPC ho√†n h·∫£o c√≥ th·ª±c th·ªÉ v√† kh·∫£ nƒÉng t·ª± ch·ªß ƒë∆°n gi·∫£n, ng∆∞·ªùi ƒë√≥ s·∫Ω v√¥ gi√∫p b·∫°n v√¥ ƒëi·ªÅu ki·ªán, nh∆∞ng kh√¥ng th·ªÉ hi·ªÉu b·∫•t k·ª≥ t√¨nh c·∫£m ch√¢n th·ª±c n√†o.',
                  effects: 'NPC th·ª±c th·ªÉ',
                },
              ],

              abyss: [
                {
                  title: 'V·ª±c Th·∫≥m √Åo Gi√°p',
                  description:
                    '√Åo gi√°p ƒë∆∞·ª£c c·ª• th·ªÉ h√≥a h√≤a l√†m m·ªôt v·ªõi m√°u th·ªãt c·ªßa b·∫°n, cung c·∫•p s·ª± b·∫£o v·ªá vƒ©nh c·ª≠u, c√°i gi√° l√† b·∫°n c≈©ng tr·ªü th√†nh t√π nh√¢n c·ªßa b·ªô √°o gi√°p n√†y, kh√¥ng bao gi·ªù c√≥ th·ªÉ c·ªüi ra.',
                  effects: 'H√≤a tan m√°u th·ªãt',
                },

                {
                  title: 'V·ª±c Th·∫≥m Nh·∫´n',
                  description:
                    'B·∫°n r√†ng bu·ªôc linh h·ªìn m√¨nh v·ªõi chi·∫øc nh·∫´n, ƒë·∫°t ƒë∆∞·ª£c s·ª©c m·∫°nh s·ª≠a ƒë·ªïi hi·ªán th·ª±c, nh∆∞ng s·ª± t·ªìn t·∫°i c·ªßa ch√≠nh b·∫°n c≈©ng tr·ªü n√™n h∆∞ v√¥ nh∆∞ ·∫£o ·∫£nh, d·∫ßn b·ªã th·∫ø gi·ªõi l√£ng qu√™n.',
                  effects: 'R√†ng bu·ªôc linh h·ªìn',
                },

                {
                  title: 'V·ª±c Th·∫≥m Npc',
                  description:
                    'NPC ho√†n h·∫£o b·∫°n c·ª• th·ªÉ h√≥a thay th·∫ø v·ªã tr√≠ c·ªßa b·∫°n trong th·ª±c t·∫°i, c√≤n b·∫°n tr·ªü th√†nh m·ªôt ph·∫ßn trong ·∫£o t∆∞·ªüng c·ªßa ng∆∞·ªùi ƒë√≥, s·ªëng trong th·∫ø gi·ªõi l√Ω t∆∞·ªüng ng∆∞·ªùi ƒë√≥ x√¢y d·ª±ng cho b·∫°n.',
                  effects: 'Ho√°n ƒë·ªïi v·ªã tr√≠',
                },
              ],
            },

            'H·ªá ƒê·∫∑c Ch·∫•t (T√¨nh Y√™u V·∫∑n V·∫πo)': {
              seed: [
                {
                  title: 'M·∫ßm M·ªëng Kh·∫ø ∆Ø·ªõc',
                  description: "B·∫°n c√≥ th·ªÉ nghe th·∫•y ti·∫øng n√≥i m·ªõ c·ªßa 'Quy T·∫Øc Qu√°i ƒê√†m' tr·∫ßm th·∫•p truy·ªÅn ƒë·∫øn t·ª´ khe n·ª©t kh√¥ng gian, ch√∫ng ƒëang d·ª• d·ªó b·∫°n k√Ω k·∫øt kh·∫ø ∆∞·ªõc.",
                  effects: 'Ti·∫øng n√≥i m·ªõ qu√°i ƒë√†m',
                },

                {
                  title: 'M·∫ßm M·ªëng C·ªông H∆∞·ªüng',
                  description: 'Khi b·∫°n n·∫£y sinh giao thoa c·∫£m x√∫c m√£nh li·ªát v·ªõi m·ªôt NPC, b·∫°n c√≥ th·ªÉ c·∫£m nh·∫≠n ng·∫Øn h·∫°n (kho·∫£ng 1 gi√¢y) c·∫£m x√∫c c·ªët l√µi nh·∫•t c·ªßa ƒë·ªëi ph∆∞∆°ng l√∫c ƒë√≥.',
                  effects: 'C·ªông h∆∞·ªüng c·∫£m x√∫c',
                },

                {
                  title: 'M·∫ßm M·ªëng H·ªón H·ª£p',
                  description: "C·∫£m nh·∫≠n c·ªßa b·∫°n v·ªÅ m·ªçi 't√¨nh y√™u' ƒë·ªÅu mang m·ªôt c·∫£m gi√°c ƒë·ªôc ƒë√°o kh√¥ng h√†i h√≤a, d∆∞·ªùng nh∆∞ ch√∫ng l√† s·ª± ng·ª•y trang c·ªßa m·ªôt th·ª© g√¨ ƒë√≥ nguy hi·ªÉm h∆°n.",
                  effects: 'C·∫£m nh·∫≠n ƒë·ªôc ƒë√°o',
                },
              ],

              growth: [
                {
                  title: 'K√Ω K·∫øt Kh·∫ø ∆Ø·ªõc',
                  description:
                    'B·∫°n c√≥ th·ªÉ hi·∫øn t·∫ø m·ªôt gi√°c quan c·ªßa m√¨nh (nh∆∞ kh·ª©u gi√°c, th·ªã gi√°c m√†u s·∫Øc) l√†m c√°i gi√°, k√Ω k·∫øt kh·∫ø ∆∞·ªõc t·∫°m th·ªùi v·ªõi m·ªôt Quy T·∫Øc Qu√°i ƒê√†m c·∫•p th·∫•p, nh·∫≠n ƒë∆∞·ª£c nƒÉng l·ª±c d·ªã bi·ªát hi·ªán th·ª±c nh·ªè b√© d√πng m·ªôt l·∫ßn.',
                  effects: 'Hi·∫øn t·∫ø gi√°c quan',
                },

                {
                  title: 'Sao Ch√©p C·ªông H∆∞·ªüng',
                  description: 'B·∫°n c√≥ th·ªÉ ch·ªß ƒë·ªông ti·∫øn h√†nh c·ªông h∆∞·ªüng c·∫£m x√∫c v·ªõi m·ªôt NPC, sao ch√©p ng·∫´u nhi√™n m·ªôt nƒÉng l·ª±c phi chi·∫øn ƒë·∫•u c∆° b·∫£n nh·∫•t c·ªßa h·ªç, k√©o d√†i 5 ph√∫t.',
                  effects: 'Sao ch√©p nƒÉng l·ª±c',
                },

                {
                  title: 'Giao D·ªãch T√¨nh C·∫£m',
                  description:
                    "B·∫°n c√≥ th·ªÉ d√πng m·ªôt ph·∫ßn 't√¨nh y√™u' ch√¢n th·ª±c l√†m h√†ng h√≥a, giao d·ªãch v·ªõi c√°c t·ªìn t·∫°i kh√°c, ƒë·ªïi l·∫•y m·ªôt 'l·ªùi ch√∫c ph√∫c' ho·∫∑c 'l·ªùi nguy·ªÅn' kh√¥ng th·ªÉ d·ª± ƒëo√°n hi·ªáu qu·∫£.",
                  effects: 'Giao d·ªãch t√¨nh y√™u',
                },
              ],

              mutation: [
                {
                  title: 'Kh·∫ø ∆Ø·ªõc Bi·∫øn D·ªã',
                  description: 'S·ª©c m·∫°nh c·ªßa kh·∫ø ∆∞·ªõc b·∫Øt ƒë·∫ßu x√¢m th·ª±c nh·∫≠n th·ª©c c·ªßa b·∫°n, th·∫ø gi·ªõi hi·ªán th·ª±c b·∫°n nh√¨n th·∫•y s·∫Ω ng·∫´u nhi√™n xu·∫•t hi·ªán ·∫£o gi√°c v√¥ h·∫°i ph√π h·ª£p v·ªõi logic qu√°i ƒë√†m.',
                  effects: 'X√¢m th·ª±c nh·∫≠n th·ª©c',
                },

                {
                  title: 'C·ªông H∆∞·ªüng Bi·∫øn D·ªã',
                  description: 'Khi k·∫øt th√∫c c·ªông h∆∞·ªüng, b·∫°n kh√¥ng ch·ªâ ph·∫£i ch·ªãu ƒë·ª±ng m·ªçi n·ªói ƒëau c·ªßa ƒë·ªëi ph∆∞∆°ng, m√† m·ªôt lo·∫°i c·∫£m x√∫c ti√™u c·ª±c m√£nh li·ªát nh·∫•t c·ªßa h·ªç c√≤n s·∫Ω l∆∞u l·∫°i trong tim b·∫°n m·ªôt gi·ªù.',
                  effects: 'N·ªói ƒëau t√†n d∆∞',
                },

                {
                  title: 'C√°i Gi√° D·ªã H√≥a',
                  description:
                    "'C√°i gi√°' b·∫°n tr·∫£ ƒë·ªÉ c√≥ ƒë∆∞·ª£c s·ª©c m·∫°nh (nh∆∞ gi√°c quan ƒë√£ m·∫•t), s·∫Ω t√°i hi·ªán d∆∞·ªõi m·ªôt h√¨nh th·ª©c ƒë·ªôc ƒë√°o xung quanh c∆° th·ªÉ b·∫°n, t·∫°o th√†nh m·ªôt v√≤ng h√†o quang h·ªØu h√¨nh, g√¢y b·∫•t an.",
                  effects: 'H√†o quang c√°i gi√°',
                },
              ],

              authority: [
                {
                  title: 'Quy·ªÅn NƒÉng Kh·∫ø ∆Ø·ªõc',
                  description:
                    'B·∫°n c√≥ th·ªÉ ch·ªâ ƒë·ªãnh m·ªôt Quy T·∫Øc Qu√°i ƒê√†m m·∫°nh m·∫Ω, th√¥ng qua vi·ªác hi·∫øn t·∫ø m·ªôt nƒÉng l·ª±c c∆° th·ªÉ vƒ©nh vi·ªÖn (nh∆∞ kh·∫£ nƒÉng ch·∫°y), ƒë·ªïi l·∫•y s·ª©c m·∫°nh to l·ªõn ƒë·∫£o ng∆∞·ª£c t√¨nh th·∫ø trong nh√°y m·∫Øt.',
                  effects: 'Hi·∫øn t·∫ø nƒÉng l·ª±c',
                },

                {
                  title: 'Quy·ªÅn NƒÉng C·ªông H∆∞·ªüng',
                  description: 'B·∫°n c√≥ th·ªÉ ch·ªâ ƒë·ªãnh sao ch√©p m·ªôt nƒÉng l·ª±c m·∫°nh m·∫Ω c·ªßa NPC, nh∆∞ng c√°i gi√° l√† nh√¢n c√°ch c·ªßa b·∫°n s·∫Ω t·∫°m th·ªùi b·ªã ƒë·∫∑c ƒëi·ªÉm t√≠nh c√°ch c·ªßa ƒë·ªëi ph∆∞∆°ng che ph·ªß.',
                  effects: 'Che ph·ªß nh√¢n c√°ch',
                },

                {
                  title: 'Quy T·∫Øc Phi Ph√†m',
                  description:
                    "B·∫°n c√≥ th·ªÉ tr·ªôn l·∫´n hai nƒÉng l·ª±c 't√¨nh y√™u' kh√¥ng li√™n quan, t·∫°o ra m·ªôt k·ªπ nƒÉng d√πng 1 l·∫ßn ho√†n to√†n m·ªõi, hi·ªáu qu·∫£ m·∫°nh m·∫Ω nh∆∞ng ho√†n to√†n kh√¥ng th·ªÉ ki·ªÉm so√°t.",
                  effects: 'H·ªón h·ª£p nƒÉng l·ª±c',
                },
              ],

              abyss: [
                {
                  title: 'V·ª±c Th·∫≥m Kh·∫ø ∆Ø·ªõc',
                  description:
                    'B·∫°n d√πng ch√≠nh m√¨nh l√†m v·∫≠t t·∫ø cu·ªëi c√πng, h√≤a l√†m m·ªôt v·ªõi b·∫£n th√¢n m·ªôt Quy T·∫Øc Qu√°i ƒê√†m, tr·ªü th√†nh qu√°i ƒë√†m m·ªõi, s·ªü h·ªØu s·ª©c m·∫°nh thi·∫øt l·∫≠p quy t·∫Øc, nh∆∞ng ho√†n to√†n m·∫•t ƒëi nh√¢n t√≠nh.',
                  effects: 'Dung h·ª£p qu√°i ƒë√†m',
                },

                {
                  title: 'V·ª±c Th·∫≥m C·ªông H∆∞·ªüng',
                  description:
                    "B·∫°n c√≥ th·ªÉ ti·∫øn h√†nh c·ªông h∆∞·ªüng c·∫£m x√∫c vƒ©nh vi·ªÖn v·ªõi m·ªôt m·ª•c ti√™u, sao ch√©p ho√†n to√†n m·ªçi nƒÉng l·ª±c v√† k√Ω ·ª©c c·ªßa h·ªç, nh∆∞ng 'c√°i t√¥i' c·ªßa b·∫°n c≈©ng s·∫Ω b·ªã ƒë·ªëi ph∆∞∆°ng ƒë·ªìng h√≥a ho√†n to√†n, tr·ªü th√†nh c√°i b√≥ng c·ªßa h·ªç.",
                  effects: 'ƒê·ªìng h√≥a ho√†n to√†n',
                },

                {
                  title: 'H√≥a Th√¢n H·ªón Mang',
                  description:
                    "B·∫°n tr·ªü th√†nh h√≥a th√¢n c·ªßa 't√¨nh y√™u ƒë·ªôc ƒë√°o', c√≥ th·ªÉ t√πy √Ω k·∫øt h·ª£p m·ªçi nƒÉng l·ª±c t√¨nh y√™u, nh∆∞ng m·ªói l·∫ßn s·ª≠ d·ª•ng ƒë·ªÅu khi·∫øn s·ª± t·ªìn t·∫°i c·ªßa b·∫°n tr·ªü n√™n h·ªón lo·∫°n v√† kh√¥ng th·ªÉ di·ªÖn t·∫£ h∆°n, cu·ªëi c√πng ƒëi ƒë·∫øn s·ª± tƒÉng entropy v√† ti√™u tan tri·ªát ƒë·ªÉ.",
                  effects: 'H√≥a th√¢n h·ªón mang',
                },
              ],
            },
          };

          return talentOptions[majorTalent]?.[level] || talentOptions['H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)'][level];
        }

        getMajorTalentDescription(majorTalent) {
          const descriptions = {
            'H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)': {
              name: 'H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)',

              description: 'C∆∞·ªùng h√≥a b·∫£n th√¢n th√¥ng qua ƒë·ªôc chi·∫øm v√† ki·ªÉm so√°t. S·ª©c m·∫°nh b·∫Øt ngu·ªìn t·ª´ ham mu·ªën chi·∫øm h·ªØu m√£nh li·ªát ƒë·ªëi v·ªõi v·∫≠t n√†o ƒë√≥.',

              positive: 'C√≥ th·ªÉ nh√¨n th·∫•u l·ªó h·ªïng quy t·∫Øc, t√¨m ra ƒëi·ªÉm y·∫øu ·∫©n gi·∫•u; tƒÉng m·∫°nh ph√≤ng th·ªß trong th·ªùi gian ng·∫Øn; c·ª• th·ªÉ h√≥a xi·ªÅng x√≠ch v√¥ h√¨nh kh√≥a ch·∫∑t m·ª•c ti√™u.',

              negative:
                'NƒÉng l·ª±c c√†ng m·∫°nh, c√†ng ph·ª• thu·ªôc v√† tr√≥i bu·ªôc v√†o "ng∆∞·ªùi y√™u", cu·ªëi c√πng m·∫•t ƒëi c√°i t√¥i; t·∫ßm nh√¨n tr·ªü n√™n h·∫πp h√≤i; m·ªói l·∫ßn s·ª≠ d·ª•ng ƒë·ªÉ l·∫°i "v·∫øt th∆∞∆°ng"; xi·ªÅng x√≠ch s·∫Ω ph·∫£n ph·ªá b·∫£n th√¢n.',
            },

            'H·ªá Bi·∫øn H√≥a (T√¨nh Y√™u D·ªëi Tr√°)': {
              name: 'H·ªá Bi·∫øn H√≥a (T√¨nh Y√™u D·ªëi Tr√°)',

              description: 'Chuy·ªÉn h√≥a l·ªùi n√≥i d·ªëi v√† s·ª± l·ª´a d·ªëi th√†nh hi·ªán th·ª±c. S·ª©c m·∫°nh kh√¥ng ·ªïn ƒë·ªãnh, thay ƒë·ªïi theo s·ª± l·ª´a d·ªëi.',

              positive: 'T·∫°m th·ªùi s·ª≠a ƒë·ªïi m√¥ t·∫£ quy t·∫Øc c√≥ l·ª£i cho m√¨nh; c·ª• th·ªÉ h√≥a l·ªùi n√≥i d·ªëi th√†nh c·∫£m x√∫c l√†m t√™ li·ªát k·∫ª th√π; t·∫°o ra "b√≥ng" gi·∫£ ch·ªãu s√°t th∆∞∆°ng.',

              negative:
                'M·ªçi l·ªùi n√≥i d·ªëi n√≥i ra ƒë·ªÅu s·∫Ω c·ª• th·ªÉ h√≥a v·∫∑n v·∫πo th√†nh nguy hi·ªÉm m·ªõi; quy t·∫Øc tr·ªü n√™n kh√¥ng ·ªïn ƒë·ªãnh c√≥ th·ªÉ ph·∫£n ph·ªá; khi l·ªùi n√≥i d·ªëi b·ªã v·∫°ch tr·∫ßn c·∫£m x√∫c bi·∫øn th√†nh thu·ªëc ƒë·ªôc ch√≠ m·∫°ng; s√°t th∆∞∆°ng b√≥ng ch·ªãu ƒë·ª±ng s·∫Ω c·ªông d·ªìn b√πng n·ªï.',
            },

            'H·ªá Ph√≥ng X·∫° (T√¨nh Y√™u Hy Sinh)': {
              name: 'H·ªá Ph√≥ng X·∫° (T√¨nh Y√™u Hy Sinh)',

              description: '·∫¢nh h∆∞·ªüng ƒë·∫øn ng∆∞·ªùi kh√°c ho·∫∑c m√¥i tr∆∞·ªùng th√¥ng qua s·ª± t·ª± hy sinh. S·ª©c m·∫°nh l√† v√¥ t∆∞, nh∆∞ng ph·∫£i tr·∫£ gi√° b·∫±ng s·ª± "m·∫•t m√°t" c·ªßa ch√≠nh m√¨nh.',

              positive: 'Gi·∫£i ph√≥ng c·∫£m x√∫c khi·∫øn k·∫ª th√π m·∫•t t√≠nh t·∫•n c√¥ng; ti√™u hao sinh m·ªánh ho·∫∑c k√Ω ·ª©c ƒë·ªÉ s·ª≠a ƒë·ªïi quy t·∫Øc; c·ª• th·ªÉ h√≥a ph√¢n th√¢n th·ª±c hi·ªán nhi·ªám v·ª•.',

              negative:
                'M·ªói l·∫ßn hy sinh ƒë·ªÅu l√†m suy y·∫øu b·∫£n th√¢n vƒ©nh vi·ªÖn; gi·ªõi h·∫°n tinh th·∫ßn l·ª±c gi·∫£m vƒ©nh vi·ªÖn; quy t·∫Øc b·ªã s·ª≠a ƒë·ªïi s·∫Ω quay l·∫°i v·ªõi h√¨nh th√°i m·∫°nh h∆°n; ch·∫øt c√πng khi ph√¢n th√¢n b·ªã ph√° h·ªßy.',
            },

            'H·ªá Thao T√°c (T√¨nh Y√™u Ki·ªÉm So√°t)': {
              name: 'H·ªá Thao T√°c (T√¨nh Y√™u Ki·ªÉm So√°t)',

              description: 'N√¥ d·ªãch ng∆∞·ªùi kh√°c th√¥ng qua ki·ªÉm so√°t tinh th·∫ßn v√† thao t√∫ng t√¨nh c·∫£m. S·ª©c m·∫°nh b·∫Øt ngu·ªìn t·ª´ s·ª± ki·ªÉm so√°t tuy·ªát ƒë·ªëi v·ªõi ng∆∞·ªùi kh√°c.',

              positive: 'G√¢y √°m th·ªã t√¢m l√Ω cho NPC khi·∫øn h·ªç ph·ª•c t√πng; thao t√∫ng k·∫ª th√π b·ªã ƒë√°nh b·∫°i chi·∫øn ƒë·∫•u cho b·∫°n; h·∫•p th·ª• "t√¨nh y√™u" c·ªßa NPC ƒë·ªÉ nh·∫≠n nƒÉng l·ª±c ƒë·∫∑c bi·ªát.',

              negative:
                'C√†ng ki·ªÉm so√°t nhi·ªÅu c·∫£m x√∫c b·∫£n th√¢n c√†ng t√™ li·ªát; NPC nh·∫≠n ra b·ªã thao t√∫ng s·∫Ω g√¢y ph·∫£n ph·ªá m√£nh li·ªát; ph·∫£i t·∫≠p trung thao t√∫ng kh√¥ng th·ªÉ d√πng nƒÉng l·ª±c kh√°c; "t√¨nh y√™u" h·∫•p th·ª• ƒë·ªÉ l·∫°i d·∫•u ·∫•n v·∫∑n v·∫πo tr·ªü th√†nh ƒëi·ªÉm y·∫øu.',
            },

            'H·ªá C·ª• Th·ªÉ H√≥a (T√¨nh Y√™u L√Ω T∆∞·ªüng)': {
              name: 'H·ªá C·ª• Th·ªÉ H√≥a (T√¨nh Y√™u L√Ω T∆∞·ªüng)',

              description: 'C·ª• th·ªÉ h√≥a t√¨nh y√™u ho√†n h·∫£o trong t∆∞·ªüng t∆∞·ª£ng th√†nh hi·ªán th·ª±c. S·ª©c m·∫°nh b·∫Øt ngu·ªìn t·ª´ ·∫£o t∆∞·ªüng v·ªÅ s·ª± ho√†n h·∫£o.',

              positive: 'C·ª• th·ªÉ h√≥a √°o gi√°p nh·∫π h·∫•p th·ª• s√°t th∆∞∆°ng; c·ª• th·ªÉ h√≥a nh·∫´n nh·∫≠n s·ª©c m·∫°nh to l·ªõn; c·ª• th·ªÉ h√≥a NPC ho√†n h·∫£o gi√∫p ƒë·ª° v√¥ ƒëi·ªÅu ki·ªán.',

              negative:
                'V·∫≠t ph·∫©m c·ª• th·ªÉ h√≥a ch·ªâ ph·∫£n ·ª©ng v·ªõi "t√¨nh y√™u" v√† d·∫ßn thay th·∫ø hi·ªán th·ª±c; √°o gi√°p d·∫ßn n·∫∑ng th√™m h·∫°n ch·∫ø h√†nh ƒë·ªông; vi ph·∫°m l·ªùi h·ª©a nh·∫´n h√≥a th√†nh xi·ªÅng x√≠ch; NPC ho√†n h·∫£o ti√™u hao l∆∞·ª£ng l·ªõn "t√¨nh y√™u" v√† kh√¥ng th·ªÉ hi·ªÉu t√¨nh c·∫£m ch√¢n th·ª±c.',
            },

            'H·ªá ƒê·∫∑c Ch·∫•t (T√¨nh Y√™u V·∫∑n V·∫πo)': {
              name: 'H·ªá ƒê·∫∑c Ch·∫•t (T√¨nh Y√™u V·∫∑n V·∫πo)',

              description: 'S·ªü h·ªØu nƒÉng l·ª±c v·∫∑n v·∫πo ƒë·ªôc nh·∫•t v√¥ nh·ªã, v∆∞·ª£t qua l·∫Ω th∆∞·ªùng. S·ª©c m·∫°nh kh√¥ng th·ªÉ d·ª± ƒëo√°n, th∆∞·ªùng l√† s·ª± h·ªón h·ª£p ho·∫∑c bi·∫øn d·ªã c·ªßa nƒÉm lo·∫°i t√¨nh y√™u tr√™n.',

              positive: 'K√Ω k·∫øt kh·∫ø ∆∞·ªõc v·ªõi Quy T·∫Øc Qu√°i ƒê√†m m·∫°nh m·∫Ω nh·∫≠n s·ª©c m·∫°nh kh·ªïng l·ªì t·ª©c th√¨; c·ªông h∆∞·ªüng c·∫£m x√∫c v·ªõi NPC sao ch√©p nƒÉng l·ª±c c·ªßa h·ªç.',

              negative: 'NƒÉng l·ª±c ƒëi k√®m r·ªßi ro kh√¥ng th·ªÉ ki·ªÉm so√°t nh·∫•t v√† s·ª± d·ªã h√≥a s√¢u s·∫Øc nh·∫•t; ph·∫£i tr·∫£ gi√° b·∫±ng m·ªôt ph·∫ßn n√†o ƒë√≥; ch·ªãu ƒë·ª±ng t·∫•t c·∫£ n·ªói ƒëau khi k·∫øt th√∫c c·ªông h∆∞·ªüng.',
            },
          };

          return descriptions[majorTalent] || descriptions['H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)'];
        }

        getCurrentMajorTalent() {
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              let majorTalent = Mvu.getMvuVariable(mvuData, 'trainer.talent.majorTalent.name', { default_value: null });
              if (!majorTalent || majorTalent === '' || majorTalent === 'Kh√¥ng') {
                if (window.teresenDebug && typeof window.teresenDebug.getAllVariables === 'function') {
                  const allVars = window.teresenDebug.getAllVariables();
                  majorTalent = window.teresenDebug.getVariable(allVars, 'stat_data.trainer.talent.majorTalent.name', null);
                }
              }
              if (!majorTalent || majorTalent === '' || majorTalent === 'Kh√¥ng') {
                majorTalent = 'H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)';
              }

              return majorTalent;
            }
          } catch (error) {
            console.warn('L·∫•y ƒê·∫°i Thi√™n Ph√∫ th·∫•t b·∫°i, s·ª≠ d·ª•ng gi√° tr·ªã m·∫∑c ƒë·ªãnh:', error);
          }

          return 'H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)';
        }

        updateUpgradeHistory() {
          const container = document.getElementById('upgrade-history');

          if (!container) return;

          try {
            let acquiredTalents = [];

            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });

              const levels = ['sprout', 'growth', 'mutation', 'authority', 'abyss'];

              levels.forEach(level => {
                const talent = Mvu.getMvuVariable(mvuData, `trainer.talent.minorTalent.${level}`, { default_value: null });

                if (talent) {
                  acquiredTalents.push({
                    level: level,

                    title: talent,
                  });
                }
              });
            }

            if (acquiredTalents.length === 0) {
              container.innerHTML =
                '<div style="text-align: center; color: #666666; font-style: italic; padding: 50px;">T·∫°m kh√¥ng c√≥ ghi ch√©p n√¢ng c·∫•p</div>';

              return;
            }

            let html = '';

            acquiredTalents.forEach((talent, index) => {
              html += `

                <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05)); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 10px;">

                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">

                    <span style="color: #22c55e; font-size: 16px; font-weight: bold;">${talent.level} - ${talent.title}</span>

                  </div>

                </div>

              `;
            });

            container.innerHTML = html;
          } catch (error) {
            console.error('C·∫≠p nh·∫≠t ghi ch√©p n√¢ng c·∫•p th·∫•t b·∫°i:', error);

            container.innerHTML =
              '<div style="text-align: center; color: #666666; font-style: italic; padding: 50px;">T·∫£i th·∫•t b·∫°i</div>';
          }
        }

        currentTalentPage = 0;

        talentPageTitles = ['üìñ Thi√™n Ph√∫ Hi·ªán T·∫°i', 'üå± M·∫ßm M·ªëng', 'üåø Sinh Tr∆∞·ªüng', 'üåÄ Bi·∫øn D·ªã', 'üëë Quy·ªÅn NƒÉng', 'üåå V·ª±c Th·∫≥m', 'üìö Ghi Ch√©p N√¢ng C·∫•p'];

        switchTalentPage(page) {
          const sound = document.getElementById('page-flip-sound');
          if (sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log('Ph√°t √¢m thanh l·∫≠t trang th·∫•t b·∫°i:', e));
          }

          const pages = document.querySelectorAll('.book-page');

          pages.forEach(p => (p.style.display = 'none'));

          const buttons = document.querySelectorAll('.page-btn');

          buttons.forEach(btn => {
            btn.classList.remove('active');

            btn.style.background = 'rgba(139, 69, 19, 0.3)';

            btn.style.border = '2px solid rgba(139, 69, 19, 0.5)';

            btn.style.color = '#8b4513';
          });

          const targetPage = document.getElementById(`page-${page}-content`);

          if (targetPage) {
            targetPage.style.display = 'block';
          }

          const targetBtn = document.getElementById(`page-${page}`);

          if (targetBtn) {
            targetBtn.classList.add('active');

            targetBtn.style.background = 'linear-gradient(135deg, #8b4513, #a0522d)';

            targetBtn.style.border = '2px solid #8b4513';

            targetBtn.style.color = '#ffffff';
          }
        }

        goToTalentPage(pageIndex) {
          if (pageIndex < 0 || pageIndex >= this.talentPageTitles.length) return;
          const sound = document.getElementById('page-flip-sound');
          if (sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log('Ph√°t √¢m thanh l·∫≠t trang th·∫•t b·∫°i:', e));
          }

          this.currentTalentPage = pageIndex;

          const container = document.getElementById('book-pages-container');

          if (container) {

            const containerWidth = container.offsetWidth;

            container.style.transform = `translateX(-${pageIndex * containerWidth}px)`;
          }

          this.updatePageIndicator();

          this.updatePageButtons();

          this.updateCurrentPageOptions();
        }

        prevTalentPage() {
          if (this.currentTalentPage > 0) {
            const sound = document.getElementById('page-flip-sound');
            if (sound) {
              sound.currentTime = 0;
              sound.play().catch(e => console.log('Ph√°t √¢m thanh l·∫≠t trang th·∫•t b·∫°i:', e));
            }
            this.goToTalentPage(this.currentTalentPage - 1);
          }
        }

        nextTalentPage() {
          if (this.currentTalentPage < this.talentPageTitles.length - 1) {
            const nextPage = this.currentTalentPage + 1;

            const nextLevel = this.getLevelByPageIndex(nextPage);

            if (nextLevel && !this.isLevelUnlocked(nextLevel)) {
              const previousLevel = this.getPreviousLevel(nextLevel);

              const previousLevelChinese = this.getLevelChineseName(previousLevel);

              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage(
                  `Kh√¥ng th·ªÉ truy c·∫≠p c·∫•p b·∫≠c n√†y! C·∫ßn ho√†n th√†nh l·ª±a ch·ªçn Thi√™n ph√∫ c·∫•p b·∫≠c ${previousLevelChinese} tr∆∞·ªõc. Vui l√≤ng quay l·∫°i trang tr∆∞·ªõc ƒë·ªÉ ch·ªçn Thi√™n ph√∫.`,
                );
              }

              return;
            }
            const sound = document.getElementById('page-flip-sound');
            if (sound) {
              sound.currentTime = 0;
              sound.play().catch(e => console.log('Ph√°t √¢m thanh l·∫≠t trang th·∫•t b·∫°i:', e));
            }
            this.goToTalentPage(nextPage);
          }
        }

        updatePageIndicator() {
          const titleElement = document.getElementById('current-page-title');

          const numberElement = document.getElementById('page-number');

          if (titleElement) {
            titleElement.textContent = this.talentPageTitles[this.currentTalentPage];
          }

          if (numberElement) {
            numberElement.textContent = `Trang ${this.currentTalentPage + 1} / T·ªïng ${this.talentPageTitles.length} trang`;
          }
        }

        updatePageButtons() {
          const prevBtn = document.getElementById('prev-page-btn');

          const nextBtn = document.getElementById('next-page-btn');

          if (prevBtn) {
            prevBtn.disabled = this.currentTalentPage === 0;

            prevBtn.style.opacity = this.currentTalentPage === 0 ? '0.5' : '1';
          }

          if (nextBtn) {
            const nextPage = this.currentTalentPage + 1;

            const nextLevel = this.getLevelByPageIndex(nextPage);

            const isNextLevelUnlocked = !nextLevel || this.isLevelUnlocked(nextLevel);

            const isLastPage = this.currentTalentPage === this.talentPageTitles.length - 1;

            nextBtn.disabled = isLastPage || !isNextLevelUnlocked;

            nextBtn.style.opacity = isLastPage || !isNextLevelUnlocked ? '0.5' : '1';

            if (!isLastPage && !isNextLevelUnlocked) {
              nextBtn.title = `C·∫ßn ho√†n th√†nh c·∫•p b·∫≠c ${this.getLevelChineseName(this.getPreviousLevel(nextLevel))} tr∆∞·ªõc`;
            } else {
              nextBtn.title = '';
            }
          }
        }

        addKeyboardListeners() {
          this.keyboardHandler = e => {
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
              e.preventDefault();

              this.prevTalentPage();
            } else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
              e.preventDefault();

              this.nextTalentPage();
            } else if (e.key === 'Escape') {
              e.preventDefault();

              this.closeTalentsModal();
            }
          };

          document.addEventListener('keydown', this.keyboardHandler);
        }

        removeKeyboardListeners() {
          if (this.keyboardHandler) {
            document.removeEventListener('keydown', this.keyboardHandler);

            this.keyboardHandler = null;
          }
        }

        addResizeListener() {
          this.resizeHandler = () => {

            const container = document.getElementById('book-pages-container');

            if (container) {
              const containerWidth = container.offsetWidth;

              container.style.transform = `translateX(-${this.currentTalentPage * containerWidth}px)`;
            }
          };

          window.addEventListener('resize', this.resizeHandler);
        }

        removeResizeListener() {
          if (this.resizeHandler) {
            window.removeEventListener('resize', this.resizeHandler);

            this.resizeHandler = null;
          }
        }

        closeTalentsModal() {
          const modal = document.getElementById('talents-modal');

          if (modal) {
            modal.style.display = 'none';

            modal.style.justifyContent = '';

            modal.style.alignItems = '';

            this.removeKeyboardListeners();

            this.removeResizeListener();
          }
        }

        async testMvuInjection() {
          try {
            console.log('üß™ Ki·ªÉm tra ch·ª©c nƒÉng ti√™m MVU...');

            if (typeof Mvu !== 'undefined' && Mvu.setMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              if (!mvuData || !mvuData.stat_data) {
                console.error('‚ùå D·ªØ li·ªáu MVU kh√¥ng h·ª£p l·ªá');
                return;
              }
              if (!mvuData.display_data) {
                mvuData.display_data = {};
              }
              if (!mvuData.delta_data) {
                mvuData.delta_data = {};
              }
              if (!mvuData.stat_data.$internal) {
                mvuData.stat_data.$internal = {
                  display_data: mvuData.display_data,
                  delta_data: mvuData.delta_data,
                };
                console.log('‚úÖ ƒê√£ kh·ªüi t·∫°o thu·ªôc t√≠nh $internal');
              } else {
                mvuData.stat_data.$internal.display_data = mvuData.display_data;
                mvuData.stat_data.$internal.delta_data = mvuData.delta_data;
              }

              await Mvu.setMvuVariable(mvuData, 'trainer.talent.minorTalent.sprout', 'Thi√™n ph√∫ th·ª≠ nghi·ªám', {
                reason: 'Ti√™m th·ª≠ nghi·ªám',

                is_recursive: true,
              });

              await Mvu.replaceMvuData(mvuData, { type: 'chat' });

              console.log('‚úÖ Ki·ªÉm tra ti√™m MVU th√†nh c√¥ng!');

              alert('Ki·ªÉm tra ti√™m MVU th√†nh c√¥ng! Vui l√≤ng ki·ªÉm tra giao di·ªán Thi√™n ph√∫');
            } else {
              console.warn('‚ö†Ô∏è API MVU kh√¥ng kh·∫£ d·ª•ng');

              alert('API MVU kh√¥ng kh·∫£ d·ª•ng');
            }
          } catch (error) {
            console.error('‚ùå Ki·ªÉm tra ti√™m MVU th·∫•t b·∫°i:', error);

            alert('Ki·ªÉm tra ti√™m MVU th·∫•t b·∫°i: ' + error.message);
          }
        }

        checkMvuStatus() {
          console.log('üîç Ki·ªÉm tra tr·∫°ng th√°i MVU...');

          console.log('üìä ƒê·ªëi t∆∞·ª£ng MVU:', typeof Mvu);

          if (typeof Mvu !== 'undefined') {
            console.log('‚úÖ ƒê·ªëi t∆∞·ª£ng MVU t·ªìn t·∫°i');

            console.log('üìã H√†m MVU:', {
              getMvuData: typeof Mvu.getMvuData,

              setMvuVariable: typeof Mvu.setMvuVariable,

              replaceMvuData: typeof Mvu.replaceMvuData,

              getMvuVariable: typeof Mvu.getMvuVariable,
            });
          } else {
            console.error('‚ùå ƒê·ªëi t∆∞·ª£ng MVU kh√¥ng t·ªìn t·∫°i');
          }

          try {
            const mvuData = Mvu.getMvuData({ type: 'chat' });

            console.log('üìä L·∫•y d·ªØ li·ªáu MVU:', mvuData ? 'Th√†nh c√¥ng' : 'Th·∫•t b·∫°i');

            console.log('üìã N·ªôi dung d·ªØ li·ªáu MVU:', mvuData);
          } catch (error) {
            console.error('‚ùå L·∫•y d·ªØ li·ªáu MVU th·∫•t b·∫°i:', error);
          }

          try {
            const mvuData = Mvu.getMvuData({ type: 'chat' });

            const crystals = Mvu.getMvuVariable(mvuData, 'trainer.twistedAffectionCrystals', { default_value: 0 });

            console.log('üíé S·ªë l∆∞·ª£ng k·∫øt tinh hi·ªán t·∫°i:', crystals);
          } catch (error) {
            console.error('‚ùå L·∫•y s·ªë l∆∞·ª£ng k·∫øt tinh th·∫•t b·∫°i:', error);
          }

          alert('Ki·ªÉm tra tr·∫°ng th√°i MVU ho√†n t·∫•t, vui l√≤ng xem console');
        }
        setupEnterToSend() {
          const actionInput = document.getElementById('action-input');
          if (!actionInput) return;
          if (actionInput._enterToSendHandler) {
            $(actionInput).off('keydown', actionInput._enterToSendHandler);
            actionInput._enterToSendHandler = null;
          }
          const enterToSend = localStorage.getItem('teresen_enter_to_send') === 'true';

          if (enterToSend) {
            actionInput._enterToSendHandler = e => {
              if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                $('#btn-send-action').click();
              }
            };
            $(actionInput).on('keydown', actionInput._enterToSendHandler);
          }
        }
        initQuickActionModal() {
          const modal = document.getElementById('quick-action-modal');
          if (!modal) {
            console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ c·ª≠a s·ªï ch·ª©c nƒÉng nhanh');
            return;
          }
          $(document).on('click', '#quick-action-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.openQuickActionModal();
          });

          $(document).on('click', '#quick-action-modal-close-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.closeQuickActionModal();
          });

          $(document).on('click', '#quick-action-modal', e => {
            if (e.target.id === 'quick-action-modal') {
              this.closeQuickActionModal();
            }
          });
          $(document).on('click', '.quick-action-modal-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            const action = $(e.currentTarget).data('action');
            if (action) {
              this.handleQuickAction(action);
              this.closeQuickActionModal();
            }
          });

          console.log('‚úÖ C·ª≠a s·ªï ch·ª©c nƒÉng nhanh ƒë√£ kh·ªüi t·∫°o');
        }
        openQuickActionModal() {
          const modal = document.getElementById('quick-action-modal');
          if (!modal) return;
          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay && modal.parentNode !== overlay) {
            modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
            overlay.appendChild(modal);
            console.log('‚úÖ quick-action-modal ƒë√£ di chuy·ªÉn v√†o b√™n trong l·ªõp ph·ªß');
          }

          modal.style.display = 'flex';
          modal.style.justifyContent = 'center';
          modal.style.alignItems = 'center';
        }
        closeQuickActionModal() {
          const modal = document.getElementById('quick-action-modal');
          if (!modal) return;

          modal.style.display = 'none';
          modal.style.justifyContent = '';
          modal.style.alignItems = '';
        }
        initQuickPositionModal() {
          const modal = document.getElementById('quick-position-modal');
          if (!modal) {
            console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ c·ª≠a s·ªï t∆∞ th·∫ø nhanh');
            return;
          }
          $(document).on('click', '#quick-position-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.openQuickPositionModal();
          });

          $(document).on('click', '#quick-position-modal-close-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.closeQuickPositionModal();
          });

          $(document).on('click', '#quick-position-modal', e => {
            if (e.target.id === 'quick-position-modal') {
              this.closeQuickPositionModal();
            }
          });
          $(document).on('click', '.position-category-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            const category = $(e.currentTarget).data('category');
            if (category) {
              this.showPositionSubcategory(category);
            }
          });
          $(document).on('click', '.position-back-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.showPositionCategoryList();
          });
          $(document).on('click', '.quick-position-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            const position = $(e.currentTarget).data('position');
            if (position) {
              this.handleQuickPosition(position);
              this.closeQuickPositionModal();
            }
          });

          console.log('‚úÖ C·ª≠a s·ªï t∆∞ th·∫ø nhanh ƒë√£ kh·ªüi t·∫°o');
        }
        openQuickPositionModal() {
          const modal = document.getElementById('quick-position-modal');
          if (!modal) return;
          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay && modal.parentNode !== overlay) {
            modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
            overlay.appendChild(modal);
            console.log('‚úÖ quick-position-modal ƒë√£ di chuy·ªÉn v√†o b√™n trong l·ªõp ph·ªß');
          }
          this.showPositionCategoryList();
          modal.style.display = 'flex';
          modal.style.justifyContent = 'center';
          modal.style.alignItems = 'center';
        }
        closeQuickPositionModal() {
          const modal = document.getElementById('quick-position-modal');
          if (!modal) return;

          modal.style.display = 'none';
          modal.style.justifyContent = '';
          modal.style.alignItems = '';
        }
        showPositionCategoryList() {
          const modal = document.getElementById('quick-position-modal');
          if (!modal) return;

          const categoryList = modal.querySelector('.position-category-list');
          const subcategoryList = modal.querySelector('.position-subcategory-list');

          if (categoryList) categoryList.style.display = 'block';
          if (subcategoryList) subcategoryList.style.display = 'none';
        }
        showPositionSubcategory(category) {
          const modal = document.getElementById('quick-position-modal');
          if (!modal) return;

          const categoryList = modal.querySelector('.position-category-list');
          const subcategoryList = modal.querySelector('.position-subcategory-list');

          if (categoryList) categoryList.style.display = 'none';
          if (subcategoryList) {
            subcategoryList.style.display = 'block';
            const allSubcategories = subcategoryList.querySelectorAll('.position-subcategory');
            allSubcategories.forEach(sub => {
              if (sub.dataset.category === category) {
                sub.style.display = 'block';
              } else {
                sub.style.display = 'none';
              }
            });
          }
        }
        handleQuickPosition(position) {
          console.log('üíï T∆∞ th·∫ø nhanh:', position);
          const actionInput = document.getElementById('action-input');
          if (actionInput) {
            actionInput.value = `Y√™u c·∫ßu t∆∞ th·∫ø ${position}`;
            actionInput.dispatchEvent(new Event('input', { bubbles: true }));
            setTimeout(() => {
              const sendBtn = document.getElementById('btn-send-action');
              if (sendBtn) {
                sendBtn.click();
              }
            }, 100);
          }
        }
        handleQuickAction(action) {
          console.log('‚ö° Ch·ª©c nƒÉng nhanh:', action);
          const actionNames = {
            meal: 'ƒÇn th√™m',
            borrow: 'M∆∞·ª£n ti·ªÅn',
            game: 'Ch∆°i game',
            chat: 'Tr√≤ chuy·ªán',
            rest: 'Ngh·ªâ ng∆°i ƒë·∫øn tu·∫ßn sau',
            train: 'Hu·∫•n luy·ªán Uma Musume',
            schedule: 'Xem l·ªãch thi ƒë·∫•u',
            gacha: 'ƒêi Gacha',
            phone: 'Li√™n l·∫°c ƒëi·ªán tho·∫°i',
            rules: 'Ki·ªÉm tra quy t·∫Øc',
          };

          const actionName = actionNames[action] || action;
          const actionInput = document.getElementById('action-input');
          if (actionInput) {
            let message = '';
            switch (action) {
              case 'meal':
                message = 'Y√™u c·∫ßu ƒÉn th√™m';
                break;
              case 'borrow':
                message = 'Y√™u c·∫ßu m∆∞·ª£n ti·ªÅn';
                break;
              case 'game':
                message = 'Y√™u c·∫ßu ch∆°i game';
                break;
              case 'chat':
                message = 'Y√™u c·∫ßu tr√≤ chuy·ªán';
                break;
              case 'rest':
                message = 'Ngh·ªâ ng∆°i ƒë·∫øn tu·∫ßn sau';
                break;
              case 'train':
                message = 'Hu·∫•n luy·ªán Uma Musume';
                break;
              case 'schedule':
                message = 'Xem l·ªãch thi ƒë·∫•u';
                break;
              case 'gacha':
                message = 'ƒêi Gacha';
                break;
              case 'phone':
                message = 'Li√™n l·∫°c ƒëi·ªán tho·∫°i';
                break;
              case 'rules':
                message = 'Ki·ªÉm tra quy t·∫Øc';
                break;
              default:
                message = actionName;
            }

            actionInput.value = message;
            actionInput.dispatchEvent(new Event('input', { bubbles: true }));
            setTimeout(() => {
              const sendBtn = document.getElementById('btn-send-action');
              if (sendBtn) {
                sendBtn.click();
              }
            }, 100);
          }
        }
        startQuickActionSelection(actionType) {
          const actionNames = {
            meal: 'ƒÇn th√™m',
            borrow: 'M∆∞·ª£n ti·ªÅn',
            game: 'Ch∆°i game',
            chat: 'Tr√≤ chuy·ªán',
          };
          const actionName = actionNames[actionType] || actionType;
          $('.quick-action-selection-hint').remove();
          const hint = $('<div class="quick-action-selection-hint gift-selection-hint">').html(`
            <div class="hint-content">
              <span class="hint-icon">${actionType === 'meal' ? 'üçΩÔ∏è' : actionType === 'borrow' ? 'üí∞' : actionType === 'game' ? 'üéÆ' : 'üí¨'}</span>
              <span class="hint-text">Vui l√≤ng nh·∫•p v√†o th·∫ª Uma Musume mu·ªën ${actionName}</span>
              <button class="hint-close" onclick="$(this).closest('.quick-action-selection-hint').remove(); if (window.quickActionSelectionMode) window.quickActionSelectionMode = null;">√ó</button>
            </div>
          `);
          $('body').append(hint);
          if (typeof highlightCharacterCards === 'function') {
            highlightCharacterCards();
          }
          window.quickActionSelectionMode = {
            active: true,
            actionType: actionType,
            actionName: actionName,
            startTime: Date.now(),
          };
          setTimeout(() => {
            if (window.quickActionSelectionMode?.active) {
              this.cancelQuickActionSelection();
            }
          }, 30000);
        }
        cancelQuickActionSelection() {
          $('.quick-action-selection-hint').remove();
          window.quickActionSelectionMode = null;
          $('.gift-selectable, .uma-item, .character-card').removeClass('gift-selectable skill-selectable');
        }
        executeQuickAction(actionType, characterName, characterId) {
          const actionData = {
            characterName: characterName,
            characterId: characterId,
          };
          let actionCommand = '';
          switch (actionType) {
            case 'meal':
              actionCommand = 'ƒÇn th√™m';
              break;
            case 'borrow':
              actionCommand = 'M∆∞·ª£n ti·ªÅn';
              break;
            case 'game':
              actionCommand = 'Ch∆°i game';
              break;
            case 'chat':
              actionCommand = 'Tr√≤ chuy·ªán';
              break;
          }

          if (typeof addPendingAction === 'function' && actionCommand) {
            addPendingAction(actionType, actionCommand, actionData);
            console.log(`‚úÖ ƒê√£ th√™m ch·ªâ th·ªã ${actionCommand}: ${characterName}`);
          }
        }
        handleRestToNextWeek() {
          if (typeof addPendingAction === 'function') {
            addPendingAction('rest', 'Ngh·ªâ ng∆°i ƒë·∫øn tu·∫ßn sau', {
              description: 'Hu·∫•n luy·ªán vi√™n quy·∫øt ƒë·ªãnh ngh·ªâ ng∆°i ƒë·∫øn tu·∫ßn sau',
            });
            console.log('‚úÖ ƒê√£ th√™m ch·ªâ th·ªã ngh·ªâ ng∆°i ƒë·∫øn tu·∫ßn sau');
          }
        }
        handleGoOut() {
          if (this.openQuickMap) {
            this.openQuickMap();
          } else if (typeof window.TavernHelper !== 'undefined' && window.TavernHelper.openQuickMap) {
            window.TavernHelper.openQuickMap();
          } else {
            console.warn('Ch·ª©c nƒÉng b·∫£n ƒë·ªì nhanh kh√¥ng kh·∫£ d·ª•ng');
          }
        }

        async rerollAIResponse() {
          try {
            if (!this.lastSentPrompt) {
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage('Kh√¥ng t√¨m th·∫•y ch·ªâ th·ªã tr∆∞·ªõc ƒë√≥!');
              }

              return;
            }

            const autoSaveData = localStorage.getItem('teresen_auto_save');

            if (autoSaveData) {
              const saveData = JSON.parse(autoSaveData);

              if (saveData.mvu_data) {
                this.currentMvuState = saveData.mvu_data;
                this.renderUI(this.currentMvuState.stat_data);
              }
            }

            const actionInput = document.getElementById('action-input');

            if (actionInput) {
              actionInput.value = this.lastSentPrompt;

              await this.handleActionSubmit();
            }

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('ƒêang t·∫°o l·∫°i c√¢u tr·∫£ l·ªùi AI...');
            }
          } catch (error) {
            console.error('T·∫°o l·∫°i th·∫•t b·∫°i:', error);

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('T·∫°o l·∫°i th·∫•t b·∫°i!');
            }
          }
        }
        appendModalToCorrectParent(html) {
          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay) {
            overlay.insertAdjacentHTML('beforeend', html);
            console.log('‚úÖ C·ª≠a s·ªï ƒë√£ ƒë∆∞·ª£c th√™m v√†o b√™n trong l·ªõp ph·ªß to√†n m√†n h√¨nh');
          } else {
            document.body.insertAdjacentHTML('beforeend', html);
            console.log('‚úÖ C·ª≠a s·ªï ƒë√£ ƒë∆∞·ª£c th√™m v√†o body');
          }
        }
        moveModalsToOverlay(overlay) {
          const modalSelectors = [
            '#rules-modal',
            '#load-modal',
            '.danger-modal',
            '#command-modal',
            '#talents-modal',
            '#saveManagerModal',
            '#world-map-modal',
            '#tarot-modal',
            '#shrine-modal',
            '#achievement-modal',
            '#achievements-modal',
            '#achievement-detail-modal',
            '.item-detail-popup',
            '#roster-modal',
            '#roster-detail-modal',
            '#location-detail-panel',
            '#quick-map-modal',
            '#quick-action-modal',
            '#quick-position-modal',
            '#music-player-modal',
            '#location-confirm-modal',
            '#settings-modal',
            '#history-menu-modal',
            '#chat-history-modal',
            '#avatar-selector-modal',
          ];

          modalSelectors.forEach(selector => {
            const modals = document.querySelectorAll(selector);
            modals.forEach(modal => {
              if (modal && modal.parentNode !== overlay) {
                modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
                overlay.appendChild(modal);
                console.log(`‚úÖ C·ª≠a s·ªï ${selector} ƒë√£ di chuy·ªÉn v√†o b√™n trong l·ªõp ph·ªß`);
              }
            });
          });
        }
        ensureModalInOverlay(modalElement) {
          if (!modalElement) return;

          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay && modalElement.parentNode !== overlay) {
            if (!modalElement.dataset.originalParent) {
              modalElement.dataset.originalParent = modalElement.parentNode?.tagName || 'BODY';
            }
            overlay.appendChild(modalElement);
            console.log(`‚úÖ C·ª≠a s·ªï ƒë√£ di chuy·ªÉn v√†o b√™n trong l·ªõp ph·ªß: ${modalElement.id || modalElement.className}`);
          }
        }
        restoreModalsToOriginalPosition() {
          const modalSelectors = [
            '#rules-modal',
            '#load-modal',
            '.danger-modal',
            '#command-modal',
            '#talents-modal',
            '#saveManagerModal',
            '#world-map-modal',
            '#tarot-modal',
            '#shrine-modal',
            '#achievement-modal',
            '#achievements-modal',
            '#achievement-detail-modal',
            '.item-detail-popup',
            '#roster-modal',
            '#roster-detail-modal',
            '#location-detail-panel',
            '#quick-map-modal',
            '#quick-action-modal',
            '#quick-position-modal',
            '#music-player-modal',
            '#location-confirm-modal',
            '#settings-modal',
            '#history-menu-modal',
            '#chat-history-modal',
            '#avatar-selector-modal',
          ];

          modalSelectors.forEach(selector => {
            const modals = document.querySelectorAll(selector);
            modals.forEach(modal => {
              if (modal && modal.dataset.originalParent) {
                const originalParent =
                  modal.dataset.originalParent === 'BODY'
                    ? document.body
                    : document.querySelector(modal.dataset.originalParent);

                if (originalParent && modal.parentNode !== originalParent) {
                  originalParent.appendChild(modal);
                  delete modal.dataset.originalParent;
                  console.log(`‚úÖ C·ª≠a s·ªï ${selector} ƒë√£ di chuy·ªÉn v·ªÅ v·ªã tr√≠ c≈©`);
                }
              }
            });
          });
        }
        openSaveManagerModal_DELETED() {
          const modalId = 'saveManagerModal';

          if (document.getElementById(modalId)) {
            return; 
          }

          const html = `

              <div id="${modalId}" class="rules-modal" style="display: flex;">

                <div class="rules-modal-content" style="max-width: 900px; width: 95%; max-height: 80vh;">

                  <div class="rules-modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid rgba(139, 105, 20, 0.3);">

                    <h2 class="rules-title" style="margin: 0;">H·ªçc Vi·ªán Tracen ¬∑ Qu·∫£n L√Ω L∆∞u Tr·ªØ</h2>

                    <div style="display: flex; gap: 10px; align-items: center;">
                      <button id="importSaveBtn" class="interaction-btn" style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #2d1b1b, #3d2b2b); border: 1px solid #8b0000; color: #e8d5d5;">Nh·∫≠p l∆∞u tr·ªØ</button>
                      <button id="clearAllSavesBtn" class="interaction-btn" style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #8b0000, #a00000); border: 1px solid #8b0000; color: #e8d5d5;">X√≥a t·∫•t c·∫£ l∆∞u tr·ªØ</button>
                    <button class="close-rules-btn" id="closeSaveManager">√ó</button>
                    </div>

                  </div>

                  <div class="rules-modal-body">

                    <div class="save-manager-sections" style="display: flex; flex-direction: column; gap: 20px;">

                      <div class="save-manager-section" style="background: rgba(139, 105, 20, 0.05); border: 1px solid rgba(139, 105, 20, 0.2); border-radius: 6px; padding: 15px;">

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                          <h3 class="rules-section-title" style="margin: 0;">üîÑ L∆∞u T·ª± ƒê·ªông</h3>
                          <label style="display: flex; align-items: center; gap: 8px; color: #e0dcd1; font-size: 14px; cursor: pointer;">
                            <input type="checkbox" id="auto-save-enabled-checkbox" style="width: 18px; height: 18px; cursor: pointer;" checked>
                            <span>B·∫≠t l∆∞u t·ª± ƒë·ªông</span>
                          </label>
                    </div>

                        <div id="auto-save-slot-container" class="save-manager-list" style="max-height: 200px; overflow-y: auto; border: 1px solid rgba(139, 105, 20, 0.3); border-radius: 6px; padding: 10px; background: rgba(139, 105, 20, 0.05);"></div>

                      </div>

                      <div class="save-manager-section" style="background: rgba(139, 105, 20, 0.05); border: 1px solid rgba(139, 105, 20, 0.2); border-radius: 6px; padding: 15px;">

                        <h3 class="rules-section-title">üíæ L∆∞u Th·ªß C√¥ng</h3>

                        <div id="save-slots-container" class="save-manager-list" style="max-height: 400px; overflow-y: auto; border: 1px solid rgba(139, 105, 20, 0.3); border-radius: 6px; padding: 10px; background: rgba(139, 105, 20, 0.05);"></div>

                      </div>

                    </div>

                  </div>

                </div>

              </div>

            `;

          this.appendModalToCorrectParent(html);

          document.getElementById('closeSaveManager').addEventListener('click', () => {
            document.getElementById(modalId).remove();
          });

          document.getElementById(modalId).addEventListener('click', e => {
            if (e.target.id === modalId) {
              document.getElementById(modalId).remove();
            }
          });
          document.getElementById('importSaveBtn').addEventListener('click', async () => {
            await this.loadSaveFromFile();
          });
          document.getElementById('clearAllSavesBtn').addEventListener('click', async () => {
            const ok = await this.showFullscreenConfirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ l∆∞u tr·ªØ kh√¥ng? Thao t√°c n√†y kh√¥ng th·ªÉ kh√¥i ph·ª•c!', {
              title: 'X√≥a t·∫•t c·∫£ l∆∞u tr·ªØ',
              icon: 'üóëÔ∏è',
              confirmText: 'X√≥a',
              cancelText: 'H·ªßy',
              danger: true,
            });
            if (!ok) return;
            localStorage.removeItem('teresen_multi_save_data');
            await this.showFullscreenAlert('T·∫•t c·∫£ l∆∞u tr·ªØ ƒë√£ b·ªã x√≥a!', { title: 'Ho√†n t·∫•t', icon: '‚úÖ' });
            this.showSaveLoadManager(); 
            setTimeout(() => {
              this.bindSaveSlotListeners();
            }, 100);
          });
          const autoSaveCheckbox = document.getElementById('auto-save-enabled-checkbox');
          if (autoSaveCheckbox) {
            const savedState = localStorage.getItem('teresen_auto_save_enabled');
            autoSaveCheckbox.checked = savedState !== 'false'; 

            autoSaveCheckbox.addEventListener('change', e => {
              const isEnabled = e.target.checked;
              localStorage.setItem('teresen_auto_save_enabled', isEnabled.toString());
              this.isAutoSaveEnabled = isEnabled;
              console.log(`L∆∞u t·ª± ƒë·ªông ƒë√£ ${isEnabled ? 'B·∫≠t' : 'T·∫Øt'}`);
            });
            this.isAutoSaveEnabled = autoSaveCheckbox.checked;
          }
          this.showSaveLoadManager();
          setTimeout(() => {
            this.bindSaveSlotListeners();
          }, 100);
        }
        async exportCurrentChatHistory() {
          try {
            console.log('üì§ B·∫Øt ƒë·∫ßu xu·∫•t l·ªãch s·ª≠ tr√≤ chuy·ªán...');
            const chatHistory = await this.getChatHistory();

            if (!chatHistory || chatHistory.length === 0) {
              alert('T·∫°m kh√¥ng c√≥ l·ªãch s·ª≠ tr√≤ chuy·ªán ƒë·ªÉ xu·∫•t');
              return;
            }
            const currentVariables = this.getAllVariables();
            const exportData = {
              exportTime: new Date().toLocaleString('zh-CN'),
              gameTitle: 'H·ªçc vi·ªán Tracen: Chuy·ªán l·∫°',
              version: '2.0',
              totalMessages: chatHistory.length,
              gameState: currentVariables,
              chatHistory: chatHistory.map(msg => ({
                type: msg.is_user || msg.role === 'user' ? 'user' : 'ai',
                time: msg.send_date || (msg.timestamp ? new Date(msg.timestamp).toLocaleString('zh-CN') : ''),
                content: msg.content || msg.mes || msg.message || '',
              })),
            };
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `ChuyenLaHocVienTracen_LichSuTroChuyen_${new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            console.log('‚úÖ Xu·∫•t l·ªãch s·ª≠ tr√≤ chuy·ªán th√†nh c√¥ng');
            alert('Xu·∫•t l·ªãch s·ª≠ tr√≤ chuy·ªán th√†nh c√¥ng!');
          } catch (error) {
            console.error('‚ùå Xu·∫•t l·ªãch s·ª≠ tr√≤ chuy·ªán th·∫•t b·∫°i:', error);
            alert('Xu·∫•t th·∫•t b·∫°i: ' + error.message);
          }
        }
        async loadSaveFromFile() {
          try {
            console.log('üìÅ B·∫Øt ƒë·∫ßu ƒë·ªçc l∆∞u tr·ªØ t·ª´ t·ªáp...');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';

            input.onchange = async event => {
              const file = event.target.files[0];
              if (!file) return;

              try {
                const text = await file.text();
                const saveData = JSON.parse(text);
                if (!saveData.snapshot_data && !saveData.mvu_data && !saveData.gameState) {
                  throw new Error('T·ªáp l∆∞u tr·ªØ kh√¥ng h·ª£p l·ªá: Thi·∫øu d·ªØ li·ªáu tr·∫°ng th√°i tr√≤ ch∆°i');
                }
                const saveName = saveData.save_name || file.name;
                const confirmLoad = await this.showFullscreenConfirm(
                  `X√°c nh·∫≠n ƒë·ªçc l∆∞u tr·ªØ kh√¥ng?\nT√™n l∆∞u tr·ªØ: ${saveName}\nThao t√°c n√†y s·∫Ω ghi ƒë√® tr·∫°ng th√°i tr√≤ ch∆°i hi·ªán t·∫°i.`,
                  {
                    title: 'ƒê·ªçc l∆∞u tr·ªØ',
                    icon: 'üìñ',
                    confirmText: 'ƒê·ªçc',
                    cancelText: 'H·ªßy',
                  },
                );
                if (!confirmLoad) return;
                if (saveData.timeline_history || saveData.snapshot_data) {
                  const allSaves = this.getSavesFromStorage();
                  const tempSlotId = `imported_${Date.now()}`;
                  allSaves[tempSlotId] = saveData;
                  localStorage.setItem('teresen_multi_save_data', JSON.stringify(allSaves));
                  await this.loadGame(tempSlotId);
                  delete allSaves[tempSlotId];
                  localStorage.setItem('teresen_multi_save_data', JSON.stringify(allSaves));
                } else {
                  const variablesToApply = saveData.mvu_data || saveData.gameState;
                  if (typeof setVariable === 'function' && variablesToApply) {
                    for (const [key, value] of Object.entries(variablesToApply)) {
                      try {
                        await setVariable(key, value);
                        console.log(`‚úÖ Thi·∫øt l·∫≠p bi·∫øn: ${key}`);
                      } catch (e) {
                        console.warn(`‚ö†Ô∏è Thi·∫øt l·∫≠p bi·∫øn th·∫•t b·∫°i: ${key}`, e);
                      }
                    }
                  }
                  await this.updateInterface();
                }

                console.log('‚úÖ ƒê·ªçc l∆∞u tr·ªØ th√†nh c√¥ng');
                await this.showFullscreenAlert('ƒê·ªçc l∆∞u tr·ªØ th√†nh c√¥ng!', { title: 'Ho√†n t·∫•t', icon: '‚úÖ' });
                const modal = document.getElementById('saveManagerModal');
                if (modal) modal.remove();
              } catch (error) {
                console.error('‚ùå ƒê·ªçc l∆∞u tr·ªØ th·∫•t b·∫°i:', error);
                await this.showFullscreenAlert('ƒê·ªçc l∆∞u tr·ªØ th·∫•t b·∫°i: ' + error.message, { title: 'ƒê·ªçc l∆∞u tr·ªØ th·∫•t b·∫°i', icon: '‚ùå' });
              }
            };

            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
          } catch (error) {
            console.error('‚ùå T·∫°o b·ªô ch·ªçn t·ªáp th·∫•t b·∫°i:', error);
            await this.showFullscreenAlert('Ch·ª©c nƒÉng ƒë·ªçc l∆∞u tr·ªØ g·∫∑p l·ªói: ' + error.message, { title: 'L·ªói', icon: '‚ùå' });
          }
        }

        async createSaveWithPrompt() {
          const saveName = prompt('Vui l√≤ng nh·∫≠p t√™n l∆∞u tr·ªØ:');

          if (!saveName) return;

          try {
            const currentVariables = this.getAllVariables();

            const chatMessages = await getChatMessages(0);

            const currentMessage = chatMessages && chatMessages.length > 0 ? chatMessages[0].message : '';
            const chatHistory = await this.getChatHistory();

            const timestamp = Date.now();
            const saveData = {
              timestamp: timestamp,
              save_name: saveName,
              mvu_data: currentVariables,
              message_content: currentMessage,
              chat_history: chatHistory,
              user_input: '',
              type: 'manual',
              version: '2.0', 
            };

            const saveId = `save_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            localStorage.setItem(`teresen_save_${saveId}`, JSON.stringify(saveData));

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('L∆∞u tr·ªØ th√†nh c√¥ng!');
            }
          } catch (error) {
            console.error('L∆∞u tr·ªØ th·∫•t b·∫°i:', error);

            alert('L∆∞u tr·ªØ th·∫•t b·∫°i!');
          }
        }

        loadSaveList() {
          this.loadAutoSaveList();

          this.loadManualSaveList();
        }

        loadAutoSaveList() {
          const container = document.getElementById('auto-save-container');

          if (!container) return;

          const autoSaves = [];

          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);

            if (key && key.startsWith('teresen-auto-save-')) {
              try {
                const saveData = JSON.parse(localStorage.getItem(key));

                autoSaves.push({ key, data: saveData });
              } catch (e) {
                console.warn('Ph√¢n t√≠ch l∆∞u t·ª± ƒë·ªông th·∫•t b·∫°i:', key, e);
              }
            }
          }

          autoSaves.sort((a, b) => b.data.timestamp - a.data.timestamp);

          const recentSaves = autoSaves.slice(0, 5);

          let html = '';

          if (recentSaves.length > 0) {
            html = recentSaves

              .map((save, index) => {
                const date = new Date(save.data.timestamp).toLocaleString('zh-CN');

                const summary = this._getDisplayText(save.data.message_content)

                  .replace(/[\n\r]+/g, ' ')

                  .trim();

                return `

                <div class="save-manager-item save-manager-auto-item" style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px; padding: 12px; margin-bottom: 8px; transition: all 0.2s;">

                  <div class="save-manager-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">

                    <div class="save-manager-title" style="display: flex; align-items: center; gap: 8px;">

                      <span style="color: #22c55e; font-size: 16px;">üîÑ</span>

                      <span style="font-weight: bold; color: #ffffff; font-size: 14px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">L∆∞u T·ª± ƒê·ªông #${index + 1}</span>

                    </div>

                    <div class="save-manager-time" style="color: #ffffff; font-size: 11px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">${date}</div>

                  </div>

                  <div class="save-manager-content" style="margin-bottom: 10px;">

                    <div class="save-manager-summary" style="color: #ffffff; font-size: 12px; line-height: 1.4; background: rgba(0,0,0,0.4); padding: 8px; border-radius: 4px; max-height: 60px; overflow: hidden; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">

                      ${summary ? summary : 'Kh√¥ng c√≥ ghi ch√©p ch√≠nh vƒÉn'}

                    </div>

                  </div>

                  <div class="save-manager-actions" style="display: flex; gap: 6px; justify-content: flex-end;">

                    <button class="save-button" onclick="n.loadAutoSave('${save.key}')" style="background: linear-gradient(135deg, #22c55e, #16a34a); border: 1px solid #22c55e; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">üìñ</span>

                      <span>ƒê·ªçc</span>

                    </button>

                    <button class="save-button" onclick="n.viewSaveDetails('auto', '${save.key}')" style="background: linear-gradient(135deg, #3b82f6, #2563eb); border: 1px solid #3b82f6; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">üëÅÔ∏è</span>

                      <span>Chi ti·∫øt</span>

                    </button>

                  </div>

                </div>

              `;
              })

              .join('');
          } else {
            html =
              '<div class="save-manager-empty" style="text-align: center; color: #8b4513; padding: 1rem; font-size: 0.875rem; font-style: italic;">T·∫°m kh√¥ng c√≥ l∆∞u t·ª± ƒë·ªông</div>';
          }

          container.innerHTML = html;
        }

        loadManualSaveList() {
          const container = document.getElementById('manual-save-container');

          if (!container) return;

          const saves = [];

          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);

            if (key && key.startsWith('teresen_save_')) {
              try {
                const saveData = JSON.parse(localStorage.getItem(key));

                saves.push({ key, data: saveData });
              } catch (e) {
                console.warn('Ph√¢n t√≠ch l∆∞u tr·ªØ th·∫•t b·∫°i:', key, e);
              }
            }
          }

          saves.sort((a, b) => b.data.timestamp - a.data.timestamp);

          let html = '';

          if (saves.length > 0) {
            html = saves

              .map(save => {
                const date = new Date(save.data.timestamp).toLocaleString('zh-CN');

                const summary = this._getDisplayText(save.data.message_content)

                  .replace(/[\n\r]+/g, ' ')

                  .trim();

                return `

                <div class="save-manager-item save-manager-manual-item" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; padding: 12px; margin-bottom: 8px; transition: all 0.2s;">

                  <div class="save-manager-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">

                    <div class="save-manager-title" style="display: flex; align-items: center; gap: 8px;">

                      <span style="color: #3b82f6; font-size: 16px;">üíæ</span>

                      <span style="font-weight: bold; color: #ffffff; font-size: 14px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">${save.data.save_name}</span>

                    </div>

                    <div class="save-manager-time" style="color: #ffffff; font-size: 11px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">${date}</div>

                  </div>

                  <div class="save-manager-content" style="margin-bottom: 10px;">

                    <div class="save-manager-summary" style="color: #ffffff; font-size: 12px; line-height: 1.4; background: rgba(0,0,0,0.4); padding: 8px; border-radius: 4px; max-height: 60px; overflow: hidden; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">

                      ${summary ? summary : 'Kh√¥ng c√≥ ghi ch√©p ch√≠nh vƒÉn'}

                    </div>

                  </div>

                  <div class="save-manager-actions" style="display: flex; gap: 6px; justify-content: flex-end; flex-wrap: wrap;">

                    <button class="save-button" onclick="n.loadManualSave('${save.key}')" style="background: linear-gradient(135deg, #22c55e, #16a34a); border: 1px solid #22c55e; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">üìñ</span>

                      <span>ƒê·ªçc</span>

                    </button>

                    <button class="save-button" onclick="n.renameSave('${save.key}', '${save.data.save_name}')" style="background: linear-gradient(135deg, #f59e0b, #d97706); border: 1px solid #f59e0b; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">‚úèÔ∏è</span>

                      <span>ƒê·ªïi t√™n</span>

                    </button>

                    <button class="save-button" onclick="n.viewSaveDetails('manual', '${save.key}')" style="background: linear-gradient(135deg, #3b82f6, #2563eb); border: 1px solid #3b82f6; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">üëÅÔ∏è</span>

                      <span>Chi ti·∫øt</span>

                    </button>

                    <button class="save-button" onclick="n.deleteManualSave('${save.key}')" style="background: linear-gradient(135deg, #ef4444, #dc2626); border: 1px solid #ef4444; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">üóëÔ∏è</span>

                      <span>X√≥a</span>

                    </button>

                  </div>

                </div>

              `;
              })

              .join('');
          } else {
            html =
              '<div class="save-manager-empty" style="text-align: center; color: #8b4513; padding: 1rem; font-size: 0.875rem; font-style: italic;">T·∫°m kh√¥ng c√≥ l∆∞u th·ªß c√¥ng</div>';
          }

          container.innerHTML = html;
        }

        async loadAutoSave() {
          try {
            const autoSaveData = localStorage.getItem('teresen_auto_save');

            if (!autoSaveData) {
              alert('Kh√¥ng c√≥ l∆∞u t·ª± ƒë·ªông!');

              return;
            }

            const saveData = JSON.parse(autoSaveData);

            await this.restoreSaveData(saveData);

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('T·∫£i l∆∞u t·ª± ƒë·ªông th√†nh c√¥ng!');
            }

            document.getElementById('saveManagerModal').remove();
          } catch (error) {
            console.error('T·∫£i l∆∞u t·ª± ƒë·ªông th·∫•t b·∫°i:', error);

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('T·∫£i l∆∞u t·ª± ƒë·ªông th·∫•t b·∫°i!');
            }
          }
        }

        async loadManualSave(saveKey) {
          try {
            const savedData = localStorage.getItem(saveKey);

            if (!savedData) {
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage('L∆∞u tr·ªØ kh√¥ng t·ªìn t·∫°i!');
              }

              return;
            }

            const saveData = JSON.parse(savedData);

            await this.restoreSaveData(saveData);

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('T·∫£i l∆∞u th·ªß c√¥ng th√†nh c√¥ng!');
            }

            document.getElementById('saveManagerModal').remove();
          } catch (error) {
            console.error('T·∫£i l∆∞u th·ªß c√¥ng th·∫•t b·∫°i:', error);

            alert('T·∫£i l∆∞u th·ªß c√¥ng th·∫•t b·∫°i!');
          }
        }

        async deleteManualSave(saveKey) {
          const ok = await this.showFullscreenConfirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a l∆∞u tr·ªØ n√†y kh√¥ng?', {
            title: 'X√≥a l∆∞u tr·ªØ',
            icon: 'üóëÔ∏è',
            confirmText: 'X√≥a',
            cancelText: 'H·ªßy',
            danger: true,
          });
          if (!ok) return;

          try {
            localStorage.removeItem(saveKey);

            await this.showFullscreenAlert('X√≥a th√†nh c√¥ng!', { title: 'Ho√†n t·∫•t', icon: '‚úÖ' });

            this.loadManualSaveList();
          } catch (error) {
            console.error('X√≥a th·∫•t b·∫°i:', error);

            await this.showFullscreenAlert('X√≥a th·∫•t b·∫°i!', { title: 'L·ªói', icon: '‚ùå' });
          }
        }

        async restoreSaveData(saveData) {
          console.log('üîÑ B·∫Øt ƒë·∫ßu kh√¥i ph·ª•c d·ªØ li·ªáu l∆∞u tr·ªØ...', saveData);

          if (saveData.mvu_data) {

            this.currentMvuState = saveData.mvu_data;

            this.renderUI(this.currentMvuState.stat_data);

            console.log('‚úÖ Tr·∫°ng th√°i tr√≤ ch∆°i ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c');
          }

          if (saveData.chat_history && Array.isArray(saveData.chat_history) && saveData.chat_history.length > 0) {
            console.log('üîÑ Kh√¥i ph·ª•c l·ªãch s·ª≠ tr√≤ chuy·ªán ƒë·∫ßy ƒë·ªß (' + saveData.chat_history.length + ' tin nh·∫Øn)...');

            if (
              'function' == typeof getChatMessages &&
              'undefined' != typeof TavernHelper &&
              TavernHelper.setChatMessages
            ) {

              await TavernHelper.setChatMessages(saveData.chat_history, { refresh: 'none' });

              console.log('‚úÖ L·ªãch s·ª≠ tr√≤ chuy·ªán ƒë·∫ßy ƒë·ªß ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c (' + saveData.chat_history.length + ' tin nh·∫Øn)');
            }
          }
          else if (saveData.message_content) {
            console.log('‚ö†Ô∏è S·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng l∆∞u tr·ªØ phi√™n b·∫£n c≈©, ch·ªâ kh√¥i ph·ª•c tin nh·∫Øn ƒë∆°n l·∫ª');

            const chatMessages = await getChatMessages(0);

            if (chatMessages && chatMessages.length > 0) {
              const firstMessage = chatMessages[0];
              if (!firstMessage.extra) {
                firstMessage.extra = {};
              }
              firstMessage.extra.teresen_chat = [
                {
                  role: 'assistant',
                  content: saveData.message_content || '',
                  id: 'load_' + Date.now(),
                  timestamp: Date.now(),
                  variableState: saveData.mvu_data || null,
                },
              ];
              firstMessage.data = saveData.mvu_data;

              if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
                await SillyTavern.saveChat();
                console.log('‚úÖ Tin nh·∫Øn ƒë∆°n l·∫ª ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c v√†o extra.teresen_chat (ƒë·ªãnh d·∫°ng phi√™n b·∫£n c≈©)');
              } else {
                await TavernHelper.setChatMessages([firstMessage], { refresh: 'none' });
                console.log('‚úÖ Tin nh·∫Øn ƒë∆°n l·∫ª ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c v√†o extra.teresen_chat (ch∆∞a c·∫≠p nh·∫≠t tr∆∞·ªùng message)');
              }
            }
          }

          await this.updateDynamicData();

          console.log('‚úÖ Kh√¥i ph·ª•c d·ªØ li·ªáu l∆∞u tr·ªØ ho√†n t·∫•t');
        }

        async viewSaveDetails(type, saveKey = null) {
          try {
            let saveData;

            if (type === 'auto') {
              if (saveKey && saveKey.startsWith('teresen-auto-save-')) {
                const savedData = localStorage.getItem(saveKey);
                if (!savedData) {
                  alert('L∆∞u T·ª± ƒê·ªông kh√¥ng t·ªìn t·∫°i!');
                  return;
                }
                saveData = JSON.parse(savedData);
              } else {
                const autoSaveData = localStorage.getItem('teresen_auto_save');
                if (!autoSaveData) {
                  alert('Kh√¥ng c√≥ L∆∞u T·ª± ƒê·ªông!');
                  return;
                }
                saveData = JSON.parse(autoSaveData);
              }
            } else {
              const savedData = localStorage.getItem(saveKey);
              if (!savedData) {
                if (typeof showTemporaryMessage === 'function') {
                  showTemporaryMessage('L∆∞u tr·ªØ kh√¥ng t·ªìn t·∫°i!');
                }
                return;
              }
              saveData = JSON.parse(savedData);
            }

            const date = new Date(saveData.timestamp).toLocaleString('zh-CN');

            const summary = this._getDisplayText(saveData.message_content);

            let chatHistoryInfo = '';

            let contentToShow = summary || 'Kh√¥ng c√≥ n·ªôi dung';

            if (saveData.chat_history && Array.isArray(saveData.chat_history)) {
              chatHistoryInfo = `

                <div style="margin-bottom: 10px;">

                  <strong style="color: #e0e0e0;">üí≠ L·ªãch s·ª≠ tr√≤ chuy·ªán:</strong> 

                  <span style="color: #c0c0c0;">${saveData.chat_history.length} tin nh·∫Øn</span>

                </div>

              `;

              contentToShow = saveData.chat_history
                .map((msg, index) => {
                  const msgText = typeof msg === 'string' ? msg : msg.message || msg.content || JSON.stringify(msg);

                  return `[${index + 1}] ${msgText}`;
                })
                .join('\n\n');
            } else if (saveData.message_content) {
              chatHistoryInfo = `

                <div style="margin-bottom: 10px;">

                  <strong style="color: #e0e0e0;">üí≠ L·ªãch s·ª≠ tr√≤ chuy·ªán:</strong> 

                  <span style="color: #c0c0c0;">1 tin nh·∫Øn (ƒê·ªãnh d·∫°ng c≈©)</span>

                </div>

              `;
            }

            const detailsContent = `

                <div style="background: rgba(139, 69, 19, 0.15); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(139, 69, 19, 0.4);">

                  <div style="margin-bottom: 15px;">

                    <strong style="color: #e0e0e0; font-size: 14px;">üìù T√™n l∆∞u tr·ªØ:</strong> 

                    <span style="color: #c0c0c0; margin-left: 8px;">${saveData.save_name || 'L∆∞u T·ª± ƒê·ªông'}</span>

                  </div>

                  <div style="margin-bottom: 15px;">

                    <strong style="color: #e0e0e0; font-size: 14px;">üïê Th·ªùi gian l∆∞u:</strong> 

                    <span style="color: #c0c0c0; margin-left: 8px;">${date}</span>

                  </div>

                  <div style="margin-bottom: 15px;">

                    <strong style="color: #e0e0e0; font-size: 14px;">üè∑Ô∏è Lo·∫°i l∆∞u tr·ªØ:</strong> 

                    <span style="color: #c0c0c0; margin-left: 8px;">${type === 'auto' ? 'L∆∞u T·ª± ƒê·ªông' : 'L∆∞u th·ªß c√¥ng'}</span>

                  </div>

                  ${chatHistoryInfo}

                </div>

                <div style="background: rgba(139, 69, 19, 0.15); padding: 20px; border-radius: 8px; border: 1px solid rgba(139, 69, 19, 0.4);">

                  <strong style="color: #e0e0e0; display: block; margin-bottom: 15px; font-size: 14px;">üí¨ N·ªôi dung ƒë·ªëi tho·∫°i:</strong>

                  <textarea readonly style="width: 100%; box-sizing: border-box; height: 300px; color: #c0c0c0; line-height: 1.5; background: rgba(0,0,0,0.4); padding: 15px; border-radius: 6px; font-size: 13px; border: 1px solid rgba(139, 105, 20, 0.3); resize: none; scrollbar-width: thin; scrollbar-color: #8b4513 rgba(0,0,0,0.3); font-family: inherit;">${contentToShow}</textarea>

                </div>

            `;

            const detailModalId = 'saveDetailModal';

            if (document.getElementById(detailModalId)) {
              document.getElementById(detailModalId).remove();
            }

            const detailModalHtml = `

              <div id="${detailModalId}" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 10001; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(2px);">

                <div style="max-width: 600px; width: 90%; max-height: 80vh; background: linear-gradient(135deg, #1a1a1a, #2d1b1b); border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7); overflow: hidden; border: 2px solid #8b4513;">

                  <div style="background: linear-gradient(135deg, #2d1b1b, #3d2b2b); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #8b4513; position: sticky; top: 0; z-index: 1;">

                    <h2 style="color: #e0e0e0; margin: 0; font-size: 18px; font-weight: bold;">üìã Chi ti·∫øt l∆∞u tr·ªØ</h2>

                    <button onclick="document.getElementById('${detailModalId}').remove()" style="background: #8b0000; border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.3);" onmouseover="this.style.background='#a00000'" onmouseout="this.style.background='#8b0000'">√ó</button>

                  </div>

                  <div id="${detailModalId}_content" style="padding: 25px; overflow-y: auto; max-height: calc(80vh - 80px); color: #e0e0e0; scrollbar-width: thin; scrollbar-color: #8b4513 rgba(0,0,0,0.3);">

                  </div>

                </div>

              </div>

            `;

            this.appendModalToCorrectParent(detailModalHtml);

            const contentDiv = document.getElementById(detailModalId + '_content');

            contentDiv.innerHTML = detailsContent;

            const scrollStyle = document.createElement('style');

            scrollStyle.textContent = `

              #${detailModalId} *::-webkit-scrollbar {

                width: 8px;

                height: 8px;

              }

              #${detailModalId} *::-webkit-scrollbar-track {

                background: rgba(0, 0, 0, 0.3);

                border-radius: 4px;

              }

              #${detailModalId} *::-webkit-scrollbar-thumb {

                background: #8b4513;

                border-radius: 4px;

                border: 1px solid rgba(0, 0, 0, 0.2);

              }

              #${detailModalId} *::-webkit-scrollbar-thumb:hover {

                background: #a0522d;

              }

              #${detailModalId} *::-webkit-scrollbar-corner {

                background: rgba(0, 0, 0, 0.3);

              }

            `;

            document.head.appendChild(scrollStyle);

            document.getElementById(detailModalId).addEventListener('click', e => {
              if (e.target.id === detailModalId) {
                document.getElementById(detailModalId).remove();

                if (scrollStyle && scrollStyle.parentNode) {
                  scrollStyle.parentNode.removeChild(scrollStyle);
                }
              }
            });

            const closeBtn = document.querySelector(`#${detailModalId} button`);

            if (closeBtn) {
              const originalOnClick = closeBtn.onclick;

              closeBtn.onclick = function () {

                if (scrollStyle && scrollStyle.parentNode) {
                  scrollStyle.parentNode.removeChild(scrollStyle);
                }

                originalOnClick.call(this);
              };
            }
          } catch (error) {
            console.error('Xem chi ti·∫øt l∆∞u tr·ªØ th·∫•t b·∫°i:', error);

            alert('Xem chi ti·∫øt l∆∞u tr·ªØ th·∫•t b·∫°i!');
          }
        }

        async renameSave(saveKey, currentName) {
          try {
            const newName = prompt('Vui l√≤ng nh·∫≠p t√™n l∆∞u tr·ªØ m·ªõi:', currentName);

            if (!newName || newName === currentName) return;

            const savedData = localStorage.getItem(saveKey);

            if (!savedData) {
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage('L∆∞u tr·ªØ kh√¥ng t·ªìn t·∫°i!');
              }

              return;
            }

            const saveData = JSON.parse(savedData);

            saveData.save_name = newName;

            localStorage.setItem(saveKey, JSON.stringify(saveData));

            alert('ƒê·ªïi t√™n th√†nh c√¥ng!');

            this.loadSaveList();
          } catch (error) {
            console.error('ƒê·ªïi t√™n l∆∞u tr·ªØ th·∫•t b·∫°i:', error);

            alert('ƒê·ªïi t√™n th·∫•t b·∫°i!');
          }
        }

        _getDisplayText(text) {
          if (!text) return '';

          let cleanText = text.replace(/<[^>]*>/g, '');

          cleanText = cleanText.replace(/\s+/g, ' ').trim();

          if (cleanText.length > 200) {
            cleanText = cleanText.substring(0, 200) + '...';
          }

          return cleanText;
        }
        async performReroll() {
          try {
            const chatHistory = await this.loadChatHistoryFromExtra();
            if (chatHistory.length <= 1) {
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage('Tin nh·∫Øn ƒë·∫ßu ti√™n c·ªßa v√°n game, kh√¥ng th·ªÉ t·∫°o l·∫°i');
              }
              return;
            }
            const lastMessage = chatHistory[chatHistory.length - 1];
            if (lastMessage.role !== 'assistant') {
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage('Tin nh·∫Øn cu·ªëi c√πng kh√¥ng ph·∫£i l√† ph·∫£n h·ªìi c·ªßa AI, kh√¥ng th·ªÉ t·∫°o l·∫°i');
              }
              return;
            }
            let lastUserInput = null;
            for (let i = chatHistory.length - 2; i >= 0; i--) {
              if (chatHistory[i].role === 'user') {
                lastUserInput = chatHistory[i].content;
                break;
              }
            }

            if (!lastUserInput) {
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage('Kh√¥ng t√¨m th·∫•y ƒë·∫ßu v√†o c·ªßa ng∆∞·ªùi d√πng tr∆∞·ªõc ƒë√≥');
              }
              return;
            }
            const updatedHistory = chatHistory.slice(0, -1);
            await this._syncStateWithHistory(updatedHistory);
            const newLastMessage = updatedHistory[updatedHistory.length - 1];
            if (newLastMessage && newLastMessage.variableState) {
              this.currentMvuState = JSON.parse(JSON.stringify(newLastMessage.variableState));
              if (newLastMessage.variableState.stat_data) {
                this.renderUI(newLastMessage.variableState.stat_data);
              }
            }
            await this.updateInterface();
            const actionInput = document.getElementById('action-input');
            if (actionInput) {
              let userInputContent = lastUserInput;
              const contentMatch = lastUserInput.match(/<content>([\s\S]*?)<\/content>/s);
              if (contentMatch) {
                userInputContent = contentMatch[1].trim();
              }
              actionInput.value = userInputContent;
            }
            await this.handleActionSubmit();

            console.log('‚úÖ T·∫°o l·∫°i ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t');
            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('ƒêang t·∫°o l·∫°i c√¢u tr·∫£ l·ªùi AI...');
            }
          } catch (error) {
            console.error('T·∫°o l·∫°i th·∫•t b·∫°i:', error);
            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('T·∫°o l·∫°i th·∫•t b·∫°i: ' + error.message);
            }
          }
        }
        setupStoryActionButtons() {
          const btnSummary = document.getElementById('btn-summary');
          if (btnSummary) {
            btnSummary.addEventListener('click', async () => {
              if (typeof window.TavernHelper !== 'undefined' && window.TavernHelper.summarizeChat) {
                window.TavernHelper.summarizeChat();
              } else {
                console.log('üìù Ch·ª©c nƒÉng t√≥m t·∫Øt ch∆∞a ƒë∆∞·ª£c th·ª±c hi·ªán');
                if (window.teresenDebug && typeof window.teresenDebug.showFullscreenAlert === 'function') {
                  await window.teresenDebug.showFullscreenAlert('Ch·ª©c nƒÉng t√≥m t·∫Øt ch∆∞a ƒë∆∞·ª£c th·ª±c hi·ªán', { title: 'G·ª£i √Ω', icon: 'üìù' });
                } else if (typeof showTemporaryMessage === 'function') {
                  showTemporaryMessage('Ch·ª©c nƒÉng t√≥m t·∫Øt ch∆∞a ƒë∆∞·ª£c th·ª±c hi·ªán');
                } else {
                  alert('Ch·ª©c nƒÉng t√≥m t·∫Øt ch∆∞a ƒë∆∞·ª£c th·ª±c hi·ªán');
                }
              }
            });
          }
          const btnBack = document.getElementById('btn-back');
          if (btnBack) {
            this.updateBackRerollButtonsState();

            btnBack.addEventListener('click', async () => {
              try {
                const chatHistory = await this.loadChatHistoryFromExtra();
                if (chatHistory.length <= 1) {
                  if (typeof showTemporaryMessage === 'function') {
                    showTemporaryMessage('Tin nh·∫Øn ƒë·∫ßu ti√™n c·ªßa v√°n game, kh√¥ng th·ªÉ quay l·∫°i');
                  }
                  return;
                }
                const updatedHistory = chatHistory.slice(0, -1);
                await this._syncStateWithHistory(updatedHistory);
                const lastMessage = updatedHistory[updatedHistory.length - 1];
                if (lastMessage && lastMessage.variableState) {
                  this.currentMvuState = JSON.parse(JSON.stringify(lastMessage.variableState));
                  if (lastMessage.variableState.stat_data) {
                    this.renderUI(lastMessage.variableState.stat_data);
                  }
                }
                await this.updateInterface();

                console.log('‚úÖ ƒê√£ quay l·∫°i b∆∞·ªõc tr∆∞·ªõc, x√≥a tin nh·∫Øn AI cu·ªëi c√πng');
                if (typeof showTemporaryMessage === 'function') {
                  showTemporaryMessage('ƒê√£ quay l·∫°i b∆∞·ªõc tr∆∞·ªõc');
                }
              } catch (error) {
                console.error('Quay l·∫°i th·∫•t b·∫°i:', error);
                if (typeof showTemporaryMessage === 'function') {
                  showTemporaryMessage('Quay l·∫°i th·∫•t b·∫°i: ' + error.message);
                }
              }
            });
          }
          const btnReroll = document.getElementById('btn-reroll');
          if (btnReroll) {
            btnReroll.addEventListener('click', async () => {
              await this.performReroll();
            });
          }
        }

        
        async updateBackRerollButtonsState() {
          try {
            const chatHistory = await this.loadChatHistoryFromExtra();
            const btnBack = document.getElementById('btn-back');
            const btnReroll = document.getElementById('btn-reroll');
            const isFirstMessage = chatHistory.length <= 1;

            if (btnBack) {
              if (isFirstMessage) {
                btnBack.disabled = true;
                btnBack.style.opacity = '0.5';
                btnBack.style.cursor = 'not-allowed';
                btnBack.title = 'Tin nh·∫Øn ƒë·∫ßu ti√™n c·ªßa v√°n game, kh√¥ng th·ªÉ quay l·∫°i';
              } else {
                btnBack.disabled = false;
                btnBack.style.opacity = '1';
                btnBack.style.cursor = 'pointer';
                btnBack.title = 'Quay l·∫°i';
              }
            }

            if (btnReroll) {
              if (isFirstMessage) {
                btnReroll.disabled = true;
                btnReroll.style.opacity = '0.5';
                btnReroll.style.cursor = 'not-allowed';
                btnReroll.title = 'Tin nh·∫Øn ƒë·∫ßu ti√™n c·ªßa v√°n game, kh√¥ng th·ªÉ t·∫°o l·∫°i';
              } else {
                btnReroll.disabled = false;
                btnReroll.style.opacity = '1';
                btnReroll.style.cursor = 'pointer';
                btnReroll.title = 'T·∫°o l·∫°i';
              }
            }
          } catch (error) {
            console.error('C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t th·∫•t b·∫°i:', error);
          }
        }
      })();

      if ('undefined' != typeof eventOn && void 0 !== window.tavern_events) {
        const e = window.tavern_events;

        eventOn(e.APP_READY, () => {
          (console.log('üéØ M√¥i tr∆∞·ªùng Tavern ƒë√£ s·∫µn s√†ng, b·∫Øt ƒë·∫ßu kh·ªüi t·∫°o giao di·ªán Tracen...'),
            n.init(),
            setTimeout(() => n.initSexPositionSection(), 100));
        });
      } else
        (console.warn('‚ö†Ô∏è API s·ª± ki·ªán Tavern kh√¥ng kh·∫£ d·ª•ng, s·ª≠ d·ª•ng ph∆∞∆°ng th·ª©c kh·ªüi t·∫°o truy·ªÅn th·ªëng'),
          setTimeout(() => {
            n.init();
          }, 2e3));
    </script>

    <script>
      class MobileDetector {
        constructor() {
          this.isMobile = this.detectMobile();
          this.init();
        }

        detectMobile() {
          const userAgent = navigator.userAgent.toLowerCase();
          const mobileKeywords = [
            'mobile',
            'android',
            'iphone',
            'ipad',
            'ipod',
            'blackberry',
            'windows phone',
            'opera mini',
          ];
          const isMobileUA = mobileKeywords.some(keyword => userAgent.includes(keyword));
          const isSmallScreen = window.innerWidth <= 768;
          const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

          console.log('üîç K·∫øt qu·∫£ ki·ªÉm tra thi·∫øt b·ªã:', {
            userAgent: userAgent,
            isMobileUA: isMobileUA,
            screenWidth: window.innerWidth,
            isSmallScreen: isSmallScreen,
            isTouchDevice: isTouchDevice,
          });

          return isMobileUA || (isSmallScreen && isTouchDevice);
        }

        init() {
          if (this.isMobile) {
            console.log('üì± Ph√°t hi·ªán thi·∫øt b·ªã di ƒë·ªông, b·∫≠t th√≠ch ·ª©ng di ƒë·ªông');
            console.log('üéØ B·ªë c·ª•c di ƒë·ªông: N·ªôi dung vƒÉn b·∫£n ‚Üí Th·∫ª Uma Musume ‚Üí Ch·ª©c nƒÉng kh√°c');
            document.documentElement.classList.add('mobile-device');
            document.documentElement.classList.remove('desktop-device');
            this.applyMobileStyles();
            this.addMobileLayoutIndicator();
          } else {
            console.log('üíª Ph√°t hi·ªán thi·∫øt b·ªã m√°y t√≠nh, s·ª≠ d·ª•ng ki·ªÉu m·∫∑c ƒë·ªãnh');
            document.documentElement.classList.add('desktop-device');
            document.documentElement.classList.remove('mobile-device');
            this.removeMobileLayoutIndicator();
          }
          let resizeTimeout;
          window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
              const newIsMobile = this.detectMobile();
              if (newIsMobile !== this.isMobile) {
                console.log(
                  `üîÑ Lo·∫°i thi·∫øt b·ªã thay ƒë·ªïi: ${this.isMobile ? 'Di ƒë·ªông' : 'M√°y t√≠nh'} ‚Üí ${newIsMobile ? 'Di ƒë·ªông' : 'M√°y t√≠nh'}`,
                );
                this.isMobile = newIsMobile;
                location.reload(); 
              }
            }, 300); 
          });
        }

        addMobileLayoutIndicator() {
          const indicator = document.createElement('div');
          indicator.id = 'mobile-layout-indicator';
          indicator.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 10000;
            pointer-events: none;
            font-family: system-ui, -apple-system, sans-serif;
          `;
          indicator.textContent = 'üì± Ch·∫ø ƒë·ªô di ƒë·ªông';
          document.body.appendChild(indicator);
          setTimeout(() => {
            if (indicator && indicator.parentNode) {
              indicator.style.opacity = '0';
              indicator.style.transition = 'opacity 0.5s';
              setTimeout(() => {
                if (indicator.parentNode) {
                  indicator.parentNode.removeChild(indicator);
                }
              }, 500);
            }
          }, 3000);
        }

        removeMobileLayoutIndicator() {
          const indicator = document.getElementById('mobile-layout-indicator');
          if (indicator && indicator.parentNode) {
            indicator.parentNode.removeChild(indicator);
          }
        }

        applyMobileStyles() {
          const mobileStyles = `
            <style id="mobile-adaptive-styles">
              
              .mobile-device {
                font-size: 26px;
              }
              
              
              .mobile-device .connected-panels {
                display: flex !important;
                flex-direction: column !important;
                grid-template-columns: none !important;
                grid-template-rows: none !important;
                height: auto !important;
                min-height: 100vh !important;
                max-width: 100% !important;
                width: 100% !important;
                gap: 1px !important;
                padding: 0 !important;
                margin: 0 !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                box-sizing: border-box !important;
              }
              
              
              .mobile-device .center-panel {
                order: 1 !important;
                width: 100% !important;
                margin-bottom: 0 !important;
                min-height: 400px !important;
              }
              
              .mobile-device .left-panel {
                order: 2 !important;
                width: 100% !important;
                margin-bottom: 0 !important;
                grid-area: unset !important;
                position: relative !important;
              }
              
              .mobile-device .right-panel {
                order: 3 !important;
                width: 100% !important;
                grid-area: unset !important;
              }
              
              
              .mobile-device .panel-content {
                padding: 5px !important;
                max-height: none !important;
                overflow: visible !important;
              }
              
              
              .mobile-device .panel-divider {
                display: none !important;
              }
              
              
              .mobile-device .character-panel {
                width: 100% !important;
                max-width: none !important;
                margin-bottom: 20px !important;
              }
              
              .mobile-device .character-info {
                flex-direction: column !important;
                gap: 8px !important;
              }
              
              .mobile-device .character-avatar {
                width: 80px !important;
                height: 80px !important;
              }
              
              .mobile-device .character-stats {
                grid-template-columns: 1fr !important;
                gap: 6px !important;
                display: flex !important;
                flex-direction: column !important;
              }
              
              
              .mobile-device .character-stats .stat-item,
              .mobile-device .character-stats .currency-section {
                width: 100% !important;
                margin-bottom: 0 !important;
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                padding: 10px 12px !important;
                background: rgba(255, 255, 255, 0.9) !important;
                border: 1px solid rgba(139, 105, 20, 0.3) !important;
                border-radius: 6px !important;
                font-size: 14px !important;
              }
              
              
              .mobile-device .action-buttons {
                flex-direction: column !important;
                gap: 4px !important;
              }
              
              .mobile-device .action-button {
                width: 100% !important;
                padding: 8px !important;
                font-size: 16px !important;
              }
              
              
              .mobile-device .status-effects {
                grid-template-columns: repeat(2, 1fr) !important;
              }
              
              
              .mobile-device .inventory-grid {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 8px !important;
              }
              
              
              .mobile-device .chat-container {
                height: 300px !important;
              }
              
              
              .mobile-device .input-area {
                flex-direction: column !important;
                gap: 10px !important;
              }
              
              .mobile-device .input-area input,
              .mobile-device .input-area textarea {
                width: 100% !important;
                margin-bottom: 10px !important;
                box-sizing: border-box !important;
              }
              
              .mobile-device .input-area button {
                width: 100% !important;
                padding: 12px !important;
              }
              
              
              .mobile-device .input-controls {
                display: flex !important;
                flex-direction: row !important;
                gap: 0 !important;
                flex-shrink: 0 !important;
              }
              
              
              .mobile-device .story-container {
                padding: 8px !important;
              }
              
              .mobile-device .story-content {
                font-size: 20px !important;
                line-height: 1.6 !important;
                padding: 10px !important;
              }

              
              #quick-action-modal {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                z-index: 10000 !important;
                display: none;
                align-items: center;
                justify-content: center;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(2px);
              }

              #quick-action-modal .quick-action-modal-btn {
                transition: all 0.2s ease;
              }

              #quick-action-modal .quick-action-modal-btn:hover {
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.18), rgba(139, 105, 20, 0.1)) !important;
                border-color: rgba(139, 105, 20, 0.4) !important;
                transform: translateY(-2px);
                box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
              }

              #quick-action-modal .quick-action-modal-btn:active {
                transform: translateY(0);
              }

              
              #quick-position-modal {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                z-index: 10000 !important;
                display: none;
                align-items: center;
                justify-content: center;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(2px);
              }

              #quick-position-modal .quick-position-btn {
                transition: all 0.2s ease;
              }

              #quick-position-modal .quick-position-btn:hover {
                background: linear-gradient(135deg, rgba(233, 30, 99, 0.15), rgba(233, 30, 99, 0.08)) !important;
                border-color: rgba(233, 30, 99, 0.4) !important;
                transform: translateY(-2px);
                box-shadow: 0 3px 6px rgba(233, 30, 99, 0.2);
              }

              #quick-position-modal .quick-position-btn:active {
                transform: translateY(0);
              }

              
              .position-category-btn:hover {
                background: linear-gradient(135deg, rgba(233, 30, 99, 0.2), rgba(233, 30, 99, 0.1)) !important;
                border-color: rgba(233, 30, 99, 0.5) !important;
                transform: translateY(-3px);
                box-shadow: 0 4px 8px rgba(233, 30, 99, 0.2) !important;
              }

              .position-category-btn:active {
                transform: translateY(-1px);
              }

              .position-back-btn:hover {
                background: rgba(139, 105, 20, 0.2) !important;
                border-color: rgba(139, 105, 20, 0.5) !important;
                transform: translateX(-3px);
              }

              .position-back-btn:active {
                transform: translateX(0);
              }

              
              #quick-action-modal .rules-modal-body::-webkit-scrollbar {
                width: 8px;
              }
              #quick-action-modal .rules-modal-body::-webkit-scrollbar-track {
                background: rgba(139, 105, 20, 0.05);
                border-radius: 4px;
              }
              #quick-action-modal .rules-modal-body::-webkit-scrollbar-thumb {
                background: rgba(139, 105, 20, 0.3);
                border-radius: 4px;
              }
              #quick-action-modal .rules-modal-body::-webkit-scrollbar-thumb:hover {
                background: rgba(139, 105, 20, 0.5);
              }

              
              #quick-position-modal .rules-modal-body::-webkit-scrollbar {
                width: 8px;
              }
              #quick-position-modal .rules-modal-body::-webkit-scrollbar-track {
                background: rgba(139, 105, 20, 0.05);
                border-radius: 4px;
              }
              #quick-position-modal .rules-modal-body::-webkit-scrollbar-thumb {
                background: rgba(139, 105, 20, 0.3);
                border-radius: 4px;
              }
              #quick-position-modal .rules-modal-body::-webkit-scrollbar-thumb:hover {
                background: rgba(139, 105, 20, 0.5);
              }
              
              
              .mobile-device .uma-musume-section {
                margin-bottom: 20px !important;
              }
              
              .mobile-device .uma-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
              }
              
              .mobile-device .uma-card {
                width: 100% !important;
                max-width: none !important;
              }
              
              
              .mobile-device .rules-buttons-container {
                display: flex !important;
                gap: 8px !important;
                margin-bottom: 15px !important;
              }
              
              .mobile-device .rules-section {
                flex: 1 !important;
                margin-bottom: 0 !important;
              }
              
              .mobile-device .view-rules-button {
                flex: 1 !important;
                width: 100% !important;
                padding: 6px 10px !important;
                font-size: 11px !important;
                min-height: 24px !important;
              }
              
              .mobile-device .view-rules-button .icon {
                width: 12px !important;
                height: 12px !important;
              }
              
              .mobile-device .view-rules-button span {
                font-size: 12px !important;
              }
              
              
              .mobile-device .save-section {
                display: flex !important;
                gap: 8px !important;
                margin-bottom: 15px !important;
                position: static !important;
                order: 3 !important;
              }
              
              .mobile-device .save-button,
              .mobile-device #fullscreen-btn {
                flex: 1 !important;
                width: 100% !important;
                padding: 10px 12px !important;
                font-size: 13px !important;
                min-height: 36px !important;
                margin-bottom: 4px !important;
                line-height: 1.2 !important;
                touch-action: manipulation !important;
              }
              
              .mobile-device .save-button .icon,
              .mobile-device #fullscreen-btn .icon {
                width: 12px !important;
                height: 12px !important;
              }
              
              
              .mobile-device .talent-management {
                order: 2 !important;
              }
              
              
              
              .mobile-device .profile-journey-container {
                display: flex !important;
                flex-direction: column !important;
                gap: 8px !important;
                margin-bottom: 8px !important;
              }
              
              .mobile-device .profile-section,
              .mobile-device .journey-section {
                width: 100% !important;
                margin-bottom: 0 !important;
                min-width: 0 !important;
              }
              
              .mobile-device .section-header {
                padding: 4px !important;
                font-size: 10px !important;
                margin-bottom: 4px !important;
              }
              
              .mobile-device .section-header h3 {
                font-size: 11px !important;
                margin: 2px 0 !important;
              }
              
              .mobile-device .section-header .icon {
                width: 12px !important;
                height: 12px !important;
              }
              
              .mobile-device .profile-basic,
              .mobile-device .journey-basic {
                font-size: 9px !important;
                padding: 2px !important;
              }
              
              
              .mobile-device .status-section {
                margin-bottom: 4px !important;
              }
              
              .mobile-device .status-header {
                margin-bottom: 2px !important;
              }
              
              .mobile-device .status-label {
                font-size: 10px !important;
              }
              
              .mobile-device .status-value {
                font-size: 10px !important;
              }
              
              .mobile-device .progress-bar {
                height: 8px !important;
              }
              
              
              .mobile-device .status-item {
                flex: 1 !important;
                margin-bottom: 0 !important;
                margin-right: 4px !important;
                font-size: 14px !important;
              }
              
              .mobile-device .status-item:last-child {
                margin-right: 0 !important;
              }
              
              .mobile-device .status-item .progress-bar {
                width: 100% !important;
                min-width: 60px !important;
                height: 10px !important;
              }
              
              .mobile-device .journey-timeline {
                padding: 10px !important;
              }
              
              
              .mobile-device .inventory-section {
                margin-bottom: 20px !important;
              }
              
              .mobile-device .inventory-container {
                padding: 10px !important;
              }
              
              
              .mobile-device .skills-section {
                margin-bottom: 15px !important;
              }
              
              .mobile-device .skill-button {
                width: 100% !important;
                margin-bottom: 8px !important;
                padding: 12px !important;
                font-size: 16px !important;
              }
              
              
              .mobile-device .danger-button {
                width: auto !important;
                padding: 6px 8px !important;
                font-size: 11px !important;
                margin-bottom: 0 !important;
                min-height: 26px !important;
                flex-shrink: 0 !important;
                white-space: nowrap !important;
              }
              
              
              .mobile-device .input-header {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                gap: 6px !important;
                margin-bottom: 0px !important;
              }
              
              .mobile-device .time-display {
                font-size: 13px !important;
                margin-bottom: 0 !important;
                text-align: left !important;
                flex: 1 !important;
                min-width: 60% !important;
              }
              
              .mobile-device .time-display .icon {
                width: 13px !important;
                height: 13px !important;
              }
              
              
              .mobile-device .input-prompt {
                font-size: 18px !important;
                margin-right: 10px !important;
              }
              
              
              .mobile-device .detail-card {
                padding: 15px !important;
                margin-bottom: 15px !important;
              }
              
              .mobile-device .detail-item {
                padding: 8px 0 !important;
                font-size: 16px !important;
              }
              
              
              .mobile-device.fullscreen-active .connected-panels {
                padding: 0 !important;
                gap: 1px !important;
                grid-template-rows: auto auto 1fr auto !important;
                height: 100vh !important;
              }
              
              
              .mobile-device.fullscreen-active .left-panel {
                max-height: 15vh !important;
                min-height: 50px !important;
                overflow-y: auto !important;
                border-bottom: 1px solid rgba(139, 105, 20, 0.3) !important;
              }
              
              .mobile-device.fullscreen-active .right-panel {
                max-height: 15vh !important;
                min-height: 50px !important;
                overflow-y: auto !important;
                border-bottom: 1px solid rgba(139, 105, 20, 0.3) !important;
              }
              
              .mobile-device.fullscreen-active .center-panel {
                min-height: 55vh !important;
                max-height: 55vh !important;
                flex: 1 !important;
                overflow-y: auto !important;
              }
              
              .mobile-device.fullscreen-active .bottom-panel {
                min-height: 15vh !important;
                max-height: 15vh !important;
                padding: 4px 8px !important;
                overflow-y: auto !important;
              }
              
              
              .mobile-device.fullscreen-active .save-button {
                padding: 6px 8px !important;
                font-size: 11px !important;
                min-height: 28px !important;
                margin: 1px !important;
              }
              
              .mobile-device.fullscreen-active .page-btn {
                padding: 3px 6px !important;
                font-size: 10px !important;
                min-height: 24px !important;
              }
              
              .mobile-device.fullscreen-active .music-btn {
                padding: 2px 4px !important;
                font-size: 9px !important;
                min-height: 20px !important;
              }
              
              
              .mobile-device.fullscreen-active .panel-header {
                padding: 4px 8px !important;
                min-height: 32px !important;
              }
              
              .mobile-device.fullscreen-active .panel-title {
                font-size: 12px !important;
              }
              
              .mobile-device.fullscreen-active .story-container {
                padding: 8px !important;
              }
              
              .mobile-device.fullscreen-active .story-content {
                font-size: 14px !important;
                line-height: 1.5 !important;
                padding-bottom: 10px !important;
              }
              
              
              .mobile-device.fullscreen-active .status-section {
                margin-bottom: 4px !important;
                gap: 4px !important;
              }
              
              .mobile-device.fullscreen-active .progress-bar {
                height: 8px !important;
              }
              
              
              
              @media (max-width: 480px) {
                .mobile-device {
                  font-size: 15px !important;
                }
                
                .mobile-device .story-content {
                  font-size: 16px !important;
                }
                
                .mobile-device .section-header h3 {
                  font-size: 17px !important;
                }
              }
              
              
              @media (orientation: landscape) and (max-height: 600px) {
                .mobile-device .connected-panels {
                  min-height: auto !important;
                }
                
                .mobile-device .center-panel {
                  min-height: 300px !important;
                }
              }
              
              
              .game-viewport {
                width: 300vw !important;
                height: 100vh !important;
                display: flex !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
                scroll-snap-type: x mandatory !important;
                -webkit-overflow-scrolling: touch !important;
                scrollbar-width: thin !important;
                scrollbar-color: rgba(139, 105, 20, 0.5) transparent !important;
              }
              
              .game-viewport::-webkit-scrollbar {
                height: 8px !important;
              }
              
              .game-viewport::-webkit-scrollbar-track {
                background: transparent !important;
              }
              
              .game-viewport::-webkit-scrollbar-thumb {
                background: rgba(139, 105, 20, 0.5) !important;
                border-radius: 4px !important;
              }
              
              .game-viewport::-webkit-scrollbar-thumb:hover {
                background: rgba(139, 105, 20, 0.7) !important;
              }
              
              .game-panel {
                width: 100vw !important;
                height: 100vh !important;
                scroll-snap-align: start !important;
                flex-shrink: 0 !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                padding: 10px !important;
                box-sizing: border-box !important;
              }
              
              
              .mobile-device .modal-content,
              .mobile-device .rules-modal-content,
              .mobile-device .danger-modal-content,
              .mobile-device .tarot-modal-content {
                width: 98% !important;
                max-width: none !important;
                max-height: 95vh !important;
                margin: 2vh auto !important;
                padding: 6px !important;
                border-radius: 6px !important;
                overflow-y: auto !important;
              }
              
              .mobile-device .modal-body,
              .mobile-device .rules-modal-body {
                max-height: 80vh !important;
                overflow-y: auto !important;
                padding: 6px !important;
              }
              
              .mobile-device .modal-header,
              .mobile-device .rules-modal-header {
                padding: 4px 8px !important;
                min-height: 32px !important;
              }
              
              .mobile-device .modal-title,
              .mobile-device .rules-title {
                font-size: 14px !important;
                margin: 0 !important;
                line-height: 1.2 !important;
              }
              
              .mobile-device .close-rules-btn {
                font-size: 16px !important;
                padding: 2px 6px !important;
                min-height: 24px !important;
                width: 24px !important;
              }
              
              
              .mobile-device button {
                min-height: 28px !important;
                padding: 4px 8px !important;
                font-size: 11px !important;
                touch-action: manipulation !important;
                margin: 2px !important;
              }
              
              
              .mobile-device .save-manager-actions .save-button {
                padding: 8px 10px !important;
                font-size: 13px !important;
                min-height: 32px !important;
                margin-bottom: 4px !important;
                flex: 1 !important;
                min-width: 60px !important;
              }
              
              .mobile-device .save-manager-actions {
                gap: 6px !important;
                flex-wrap: wrap !important;
              }
              
              .mobile-device .save-manager-toolbar {
                flex-direction: column !important;
                gap: 8px !important;
              }
              
              .mobile-device .save-manager-toolbar .save-button {
                width: 100% !important;
                justify-content: center !important;
                min-height: 38px !important;
              }
              
              .mobile-device .music-btn {
                padding: 3px 6px !important;
                font-size: 10px !important;
                min-height: 24px !important;
              }
              
              .mobile-device .page-btn {
                padding: 4px 8px !important;
                font-size: 11px !important;
                min-height: 28px !important;
              }
              
              
              .mobile-device .text-content {
                line-height: 1.4 !important;
                font-size: 14px !important;
              }
              
              
              .mobile-device .container,
              .mobile-device .row,
              .mobile-device .col {
                padding: 4px !important;
                margin: 1px 0 !important;
              }
              
              .mobile-device .card,
              .mobile-device .panel {
                padding: 8px !important;
                margin: 4px 0 !important;
              }
              
              .mobile-device .form-group {
                margin-bottom: 6px !important;
              }
              
              
              @media (max-width: 767px) {
                .talents-modal-content {
                  max-width: 95% !important;
                  width: 95% !important;
                  margin: 10px auto !important;
                  max-height: 85vh !important;
                }
                
                .talents-grid {
                  grid-template-columns: repeat(2, 1fr) !important;
                  gap: 8px !important;
                  padding: 8px !important;
                }
                
                .talent-card {
                  padding: 8px !important;
                  font-size: 12px !important;
                  min-height: auto !important;
                }
                
                .talent-card h4 {
                  font-size: 13px !important;
                  margin-bottom: 4px !important;
                  line-height: 1.2 !important;
                }
                
                .talent-card p {
                  font-size: 11px !important;
                  line-height: 1.3 !important;
                  margin-bottom: 4px !important;
                }
                
                .talent-effects {
                  font-size: 10px !important;
                  line-height: 1.2 !important;
                }
                
                .rules-modal-header {
                  padding: 8px 12px !important;
                  flex-shrink: 0 !important;
                }
                
                .rules-modal-body {
                  max-height: calc(85vh - 120px) !important;
                  overflow-y: auto !important;
                  padding: 8px !important;
                }
                
                .close-rules-btn {
                  font-size: 18px !important;
                  padding: 4px 8px !important;
                  min-height: 32px !important;
                  width: 32px !important;
                }
                
                .rules-title {
                  font-size: 16px !important;
                  margin: 0 !important;
                }
              }
              
              .mobile-device .input-group {
                margin: 2px 0 !important;
              }
              
              
              .mobile-device h1 { font-size: 18px !important; margin: 8px 0 !important; }
              .mobile-device h2 { font-size: 16px !important; margin: 6px 0 !important; }
              .mobile-device h3 { font-size: 14px !important; margin: 4px 0 !important; }
              .mobile-device h4 { font-size: 13px !important; margin: 3px 0 !important; }
              .mobile-device h5 { font-size: 12px !important; margin: 2px 0 !important; }
              .mobile-device h6 { font-size: 11px !important; margin: 2px 0 !important; }
              
              .mobile-device p {
                font-size: 14px !important;
                line-height: 1.4 !important;
                margin: 4px 0 !important;
              }
              
              .mobile-device label {
                font-size: 11px !important;
                margin-bottom: 2px !important;
              }
              
              .mobile-device input,
              .mobile-device textarea,
              .mobile-device select {
                font-size: 14px !important;
                padding: 8px 10px !important;
                min-height: 44px !important;
              }
              
              .mobile-device .input-container {
                flex-direction: row !important;
                align-items: flex-end !important;
                gap: 4px !important;
                margin-top: 1px !important;
              }
              
              .mobile-device .action-input {
                flex: 1 !important;
                min-width: 0 !important;
              }
              
              
              .mobile-device .connected-panels {
                grid-template-columns: 1fr !important;
                grid-template-rows: auto auto 1fr auto !important;
                height: auto !important;
                min-height: 100vh !important;
                max-width: 100% !important;
                margin: 0 !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                gap: 1px !important;
              }
              
              
              .mobile-device .left-panel {
                grid-area: 1 / 1 / 2 / 2 !important;
                height: auto !important;
                max-height: 45vh !important;
                overflow-y: auto !important;
                border-bottom: 1px solid rgba(139, 105, 20, 0.4) !important;
                scrollbar-width: thin !important;
                scrollbar-color: rgba(139, 105, 20, 0.6) rgba(139, 105, 20, 0.1) !important;
              }
              
              
              .mobile-device .left-panel::-webkit-scrollbar {
                width: 6px !important;
              }
              
              .mobile-device .left-panel::-webkit-scrollbar-track {
                background: rgba(139, 105, 20, 0.1) !important;
                border-radius: 3px !important;
              }
              
              .mobile-device .left-panel::-webkit-scrollbar-thumb {
                background: rgba(139, 105, 20, 0.6) !important;
                border-radius: 3px !important;
              }
              
              .mobile-device .left-panel::-webkit-scrollbar-thumb:hover {
                background: rgba(139, 105, 20, 0.8) !important;
              }
              
              .mobile-device .right-panel {
                grid-area: 2 / 1 / 3 / 2 !important;
                height: auto !important;
                max-height: 30vh !important;
                overflow-y: auto !important;
                border-bottom: 1px solid rgba(139, 105, 20, 0.4) !important;
              }
              
              .mobile-device .center-panel {
                grid-area: 3 / 1 / 4 / 2 !important;
                height: auto !important;
                min-height: 50vh !important;
                flex: 1 !important;
              }
              
              .mobile-device .bottom-panel {
                order: 4 !important;
                height: auto !important;
                min-height: 50px !important;
                flex-wrap: wrap !important;
                gap: 8px !important;
                padding: 8px !important;
                width: 100% !important;
                display: flex !important;
              }
              
              
              .mobile-device .panel-divider {
                display: none !important;
              }
              
              
              .mobile-device .left-panel,
              .mobile-device .right-panel {
                transition: max-height 0.3s ease !important;
              }
              
              .mobile-device .left-panel.collapsed {
                max-height: 60px !important;
                overflow: hidden !important;
              }
              
              .mobile-device .right-panel.collapsed {
                max-height: 60px !important;
                overflow: hidden !important;
              }
              
              
              .mobile-device .panel-header {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                padding: 8px 12px !important;
                background: linear-gradient(135deg, #f5f0e8, #e8d5c4) !important;
                border-bottom: 1px solid #8b6914 !important;
                cursor: pointer !important;
                user-select: none !important;
              }
              
              .mobile-device .panel-title {
                font-size: 14px !important;
                font-weight: 600 !important;
                color: #2d2d2d !important;
                margin: 0 !important;
              }
              
              .mobile-device .panel-toggle {
                color: #8b6914 !important;
                font-size: 16px !important;
                transition: transform 0.3s ease !important;
                cursor: pointer !important;
              }
              
              .mobile-device .panel-toggle.collapsed {
                transform: rotate(180deg) !important;
              }
              
              
              .mobile-device .story-container {
                padding: 12px !important;
                overflow-y: auto !important;
              }
              
              .mobile-device .story-content {
                font-size: 15px !important;
                line-height: 1.6 !important;
                padding-bottom: 20px !important;
              }
              
              
              .mobile-device .status-section {
                display: flex !important;
                flex-direction: row !important;
                gap: 4px !important;
                margin-bottom: 6px !important;
                justify-content: space-between !important;
              }
              
              
              .mobile-device .progress-bar {
                height: 10px !important;
              }
              
              
              .mobile-device .rules-section {
                flex: 1 !important;
                margin-bottom: 8px !important;
              }
              
              .mobile-device .view-rules-button {
                flex: 1 !important;
                padding: 6px 10px !important;
                font-size: 11px !important;
                min-height: 24px !important;
              }
              
              
              .mobile-device .inventory-container,
              .mobile-device .uma-list {
                max-height: 25vh !important;
                overflow-y: auto !important;
              }
              
              .mobile-device .inventory-item,
              .mobile-device .uma-item {
                padding: 6px !important;
                margin-bottom: 4px !important;
                font-size: 12px !important;
              }
              
              
              .mobile-device .journey-list {
                max-height: 20vh !important;
                overflow-y: auto !important;
              }
              
              .mobile-device .journey-entry {
                padding: 6px !important;
                margin-bottom: 4px !important;
                font-size: 11px !important;
              }
              
              
              .mobile-device .input-section {
                padding: 4px !important;
                background-color: #fdfbf7 !important;
                border-top: 1px solid rgba(139, 105, 20, 0.3) !important;
                position: sticky !important;
                bottom: 0 !important;
                z-index: 100 !important;
                box-shadow: 0 -4px 12px rgba(139, 105, 20, 0.2) !important;
                margin-top: 8px !important; 
              }
              
              .mobile-device .input-header {
                flex-wrap: wrap !important;
                gap: 4px !important;
                margin-bottom: 0px !important;
              }
              
              .mobile-device .time-display {
                font-size: 12px !important;
                order: 1 !important;
              }
              
              .mobile-device .skills-section {
                order: 3 !important;
                width: 100% !important;
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 6px !important;
                margin-top: 8px !important;
              }
              
              .mobile-device .skill-button {
                flex: 1 !important;
                min-width: calc(50% - 3px) !important;
                font-size: 10px !important;
                padding: 6px 8px !important;
                min-height: 32px !important;
              }
              
              .mobile-device .input-container {
                background-color: #f5f0e8 !important;
                border: 2px solid #8b6914 !important;
                border-radius: 8px !important;
                padding: 4px !important;
                box-shadow: inset 0 2px 4px rgba(139, 105, 20, 0.1) !important;
                margin-top: 1px !important;
              }
              
              .mobile-device .input-prompt {
                font-size: 16px !important;
                color: #8b4513 !important;
                margin-bottom: 8px !important;
                display: block !important;
              }
              
              .mobile-device .action-input {
                min-height: 36px !important;
                max-height: 60px !important;
                font-size: 16px !important;
                line-height: 1.4 !important;
                padding: 8px !important;
                border: 1px solid #d4af37 !important;
                border-radius: 6px !important;
                background-color: #ffffff !important;
                resize: vertical !important;
              }
              
              .mobile-device .input-controls {
                margin-top: 0 !important;
                justify-content: flex-end !important;
              }
              
              .mobile-device .send-button {
                width: auto !important;
                max-width: none !important;
                padding: 8px 16px !important;
                flex-shrink: 0 !important;
                font-size: 16px !important;
                font-weight: 600 !important;
                min-height: 48px !important;
                border-radius: 8px !important;
                box-shadow: 0 4px 8px rgba(139, 105, 20, 0.3) !important;
              }
              
              
              .mobile-device .nav-tabs {
                padding: 2px !important;
              }
              
              .mobile-device .nav-tabs li {
                margin: 1px !important;
              }
              
              .mobile-device .nav-tabs a {
                padding: 4px 8px !important;
                font-size: 11px !important;
              }
              
              .mobile-device .table {
                font-size: 11px !important;
              }
              
              .mobile-device .table th,
              .mobile-device .table td {
                padding: 3px 4px !important;
              }
              
              .mobile-device .alert {
                padding: 6px 8px !important;
                margin: 4px 0 !important;
                font-size: 11px !important;
              }
              
              .mobile-device .badge {
                font-size: 9px !important;
                padding: 2px 4px !important;
              }
              
              
              .mobile-device ul, .mobile-device ol {
                padding-left: 16px !important;
                margin: 4px 0 !important;
              }
              
              .mobile-device li {
                margin: 2px 0 !important;
                font-size: 12px !important;
                line-height: 1.3 !important;
              }
              
              
              .mobile-device .scrollable {
                -webkit-overflow-scrolling: touch !important;
              }
              
              
              .mobile-device .status-animation-container {
                font-size: 14px !important;
              }
              
              .mobile-device .status-animation-text {
                font-size: 18px !important;
                padding: 15px !important;
              }
            </style>
          `;

          document.head.insertAdjacentHTML('beforeend', mobileStyles);
        }
      }
      document.addEventListener('DOMContentLoaded', () => {
        window.mobileDetector = new MobileDetector();
      });
      if (typeof window !== 'undefined') {
        const quickDetect = () => {
          const userAgent = navigator.userAgent.toLowerCase();
          const isMobile =
            /mobile|android|iphone|ipad|ipod|blackberry|windows phone|opera mini/.test(userAgent) ||
            (window.innerWidth <= 768 && ('ontouchstart' in window || navigator.maxTouchPoints > 0));

          if (isMobile) {
            document.documentElement.classList.add('mobile-device');
          } else {
            document.documentElement.classList.add('desktop-device');
          }
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', quickDetect);
        } else {
          quickDetect();
        }
      }
    </script>

    <style>
      

      
      .status-animation-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.5s ease;
      }

      .status-animation-container.show {
        opacity: 1;
      }

      .status-animation {
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border: 2px solid #d4af37;
        border-radius: 1rem;
        padding: 2rem;
        text-align: center;
        color: white;
        box-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
        max-width: 500px;
        transform: scale(0.8);
        transition: transform 0.5s ease;
      }

      .status-animation-container.show .status-animation {
        transform: scale(1);
      }

      .status-title {
        font-size: 2rem;
        font-weight: bold;
        color: #d4af37;
        margin-bottom: 1rem;
        text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
      }

      .status-content {
        margin-bottom: 1rem;
      }

      .status-message {
        font-size: 1rem;
        color: #e5e7eb;
        margin-top: 1rem;
        font-style: italic;
      }

      .status-hint {
        font-size: 0.9rem;
        color: #d4af37;
        margin-top: 0.5rem;
        font-style: italic;
        opacity: 0.8;
      }

      
      .status-animation-container.critical .status-animation {
        border-color: #dc2626;
        box-shadow: 0 0 40px rgba(220, 38, 38, 0.6);
        animation: criticalShake 0.5s ease-in-out infinite;
      }

      .status-animation-container.stamina .status-animation {
        border-color: #ef4444;
        box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
      }

      .status-animation-container.sanity .status-animation {
        border-color: #8b5cf6;
        box-shadow: 0 0 30px rgba(139, 92, 246, 0.5);
      }

      @keyframes criticalShake {
        0%,
        100% {
          transform: scale(1) rotate(0deg);
        }
        25% {
          transform: scale(1.02) rotate(-1deg);
        }
        75% {
          transform: scale(1.02) rotate(1deg);
        }
      }

      
      .buff-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border: 2px solid #d4af37;
        border-radius: 1rem;
        padding: 1.5rem;
        color: white;
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        z-index: 10000;
        max-width: 350px;
        transform: translateX(100%);
        transition: transform 0.5s ease;
      }

      .buff-notification.show {
        transform: translateX(0);
      }

      .buff-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #d4af37;
        margin-bottom: 1rem;
        text-align: center;
      }

      .buff-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .buff-item {
        padding: 0.5rem;
        border-radius: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .buff-item.courage {
        border-left: 3px solid #ef4444;
      }
      .buff-item.skill {
        border-left: 3px solid #3b82f6;
      }
      .buff-item.intuition {
        border-left: 3px solid #8b5cf6;
      }
      .buff-item.fertility {
        border-left: 3px solid #10b981;
      }
      .buff-item.authority {
        border-left: 3px solid #f59e0b;
      }
      .buff-item.harmony {
        border-left: 3px solid #06b6d4;
      }
      .buff-item.victory {
        border-left: 3px solid #dc2626;
      }
      .buff-item.strength {
        border-left: 3px solid #ea580c;
      }
      .buff-item.wisdom {
        border-left: 3px solid #7c3aed;
      }
      .buff-item.fortune {
        border-left: 3px solid #fbbf24;
      }

      .buff-name {
        display: block;
        font-weight: bold;
        color: #d4af37;
        margin-bottom: 0.25rem;
      }

      .buff-effect {
        display: block;
        font-size: 0.9rem;
        color: #e5e7eb;
        margin-bottom: 0.25rem;
      }

      .buff-duration {
        display: block;
        font-size: 0.8rem;
        color: #9ca3af;
      }

      .tarot-result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #d4af37;
        padding-bottom: 1rem;
      }

      .tarot-result-header h2 {
        color: #d4af37;
        margin: 0;
      }

      .tarot-result-header button {
        background: none;
        border: none;
        color: #d4af37;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s;
      }

      .tarot-result-header button:hover {
        background: rgba(212, 175, 55, 0.2);
      }

      .tarot-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .tarot-card {
        background: linear-gradient(135deg, #2d3748, #4a5568);
        border: 1px solid #d4af37;
        border-radius: 0.5rem;
        padding: 1rem;
        text-align: center;
        transition: transform 0.2s;
      }

      .tarot-card:hover {
        transform: translateY(-5px);
      }

      .tarot-card.reversed {
        border-color: #ef4444;
      }

      .card-name {
        font-size: 1.1rem;
        font-weight: bold;
        color: #d4af37;
        margin-bottom: 0.5rem;
      }

      .card-meaning {
        font-size: 0.9rem;
        color: #e5e7eb;
        margin-bottom: 0.5rem;
        line-height: 1.4;
      }

      .card-position {
        font-size: 0.8rem;
        color: #9ca3af;
        font-style: italic;
      }

      .tarot-advice {
        background: rgba(212, 175, 55, 0.1);
        border: 1px solid #d4af37;
        border-radius: 0.5rem;
        padding: 1rem;
      }

      .tarot-advice h3 {
        color: #d4af37;
        margin: 0 0 0.5rem 0;
      }

      .tarot-advice p {
        color: #e5e7eb;
        margin: 0;
        line-height: 1.5;
      }

      
      .tarot-buffs-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .tarot-buffs-modal.show {
        opacity: 1;
      }

      .tarot-buffs-content {
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border: 2px solid #d4af37;
        border-radius: 1rem;
        padding: 2rem;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        transform: scale(0.8);
        transition: transform 0.3s ease;
      }

      .tarot-buffs-modal.show .tarot-buffs-content {
        transform: scale(1);
      }

      .tarot-buffs-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #d4af37;
        padding-bottom: 1rem;
      }

      .tarot-buffs-header h2 {
        color: #d4af37;
        margin: 0;
      }

      .tarot-buffs-header button {
        background: none;
        border: none;
        color: #d4af37;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s;
      }

      .tarot-buffs-header button:hover {
        background: rgba(212, 175, 55, 0.2);
      }

      .tarot-buffs-body {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .tarot-buffs-body .buff-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.5rem;
        padding: 1rem;
      }

      .buff-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }

      .buff-remaining {
        font-size: 0.8rem;
        color: #9ca3af;
        font-style: italic;
      }

      .buff-source {
        font-size: 0.8rem;
        color: #6b7280;
        font-style: italic;
        margin-top: 0.5rem;
      }

      

      @layer properties {
        @supports ((-webkit-hyphens: none) and (not (margin-trim: inline))) or
          ((-moz-orient: inline) and (not (color: rgb(from red r g b)))) {
          *,
          :before,
          :after,
          ::backdrop {
            --tw-rotate-x: initial;

            --tw-rotate-y: initial;

            --tw-rotate-z: initial;

            --tw-skew-x: initial;

            --tw-skew-y: initial;

            --tw-border-style: solid;

            --tw-shadow: 0 0 #0000;

            --tw-shadow-color: initial;

            --tw-shadow-alpha: 100%;

            --tw-inset-shadow: 0 0 #0000;

            --tw-inset-shadow-color: initial;

            --tw-inset-shadow-alpha: 100%;

            --tw-ring-color: initial;

            --tw-ring-shadow: 0 0 #0000;

            --tw-inset-ring-color: initial;

            --tw-inset-ring-shadow: 0 0 #0000;

            --tw-ring-inset: initial;

            --tw-ring-offset-width: 0px;

            --tw-ring-offset-color: #fff;

            --tw-ring-offset-shadow: 0 0 #0000;

            --tw-outline-style: solid;

            --tw-backdrop-blur: initial;

            --tw-backdrop-brightness: initial;

            --tw-backdrop-contrast: initial;

            --tw-backdrop-grayscale: initial;

            --tw-backdrop-hue-rotate: initial;

            --tw-backdrop-invert: initial;

            --tw-backdrop-opacity: initial;

            --tw-backdrop-saturate: initial;

            --tw-backdrop-sepia: initial;
          }
        }
      }

      .absolute {
        position: absolute;
      }

      .fixed {
        position: fixed;
      }

      .block {
        display: block;
      }

      .flex {
        display: flex;
      }

      .hidden {
        display: none;
      }

      .flex-shrink {
        flex-shrink: 1;
      }

      .transform {
        transform: var(--tw-rotate-x,) var(--tw-rotate-y,) var(--tw-rotate-z,) var(--tw-skew-x,) var(--tw-skew-y,);
      }

      .resize {
        resize: both;
      }

      .flex-wrap {
        flex-wrap: wrap;
      }

      .border {
        border-style: var(--tw-border-style);

        border-width: 1px;
      }

      .ring {
        --tw-ring-shadow: var(--tw-ring-inset,) 0 0 0 calc(1px + var(--tw-ring-offset-width))
          var(--tw-ring-color, currentcolor);

        box-shadow:
          var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow),
          var(--tw-shadow);
      }

      .outline {
        outline-style: var(--tw-outline-style);

        outline-width: 1px;
      }

      .backdrop-filter {
        backdrop-filter: var(--tw-backdrop-blur,) var(--tw-backdrop-brightness,) var(--tw-backdrop-contrast,)
          var(--tw-backdrop-grayscale,) var(--tw-backdrop-hue-rotate,) var(--tw-backdrop-invert,)
          var(--tw-backdrop-opacity,) var(--tw-backdrop-saturate,) var(--tw-backdrop-sepia,);
      }

      .transition {
        transition-property:
          color, background-color, border-color, outline-color, text-decoration-color, fill, stroke, --tw-gradient-from,
          --tw-gradient-via, --tw-gradient-to, opacity, box-shadow, transform, translate, scale, rotate, filter,
          backdrop-filter, display, visibility, content-visibility, overlay, pointer-events;

        transition-timing-function: var(--tw-ease, ease);

        transition-duration: var(--tw-duration, 0s);
      }

      @layer base {
        html {
          font-family:
            Noto Sans SC,
            Georgia,
            Times New Roman,
            serif;
        }

        body {
          color: #2d2d2d;

          background: linear-gradient(135deg, #f8f2e6 0%, #f2e8d8 25%, #ecddc7 50%, #e6d3b6 75%, #e0c8a5 100%) fixed;

          margin: 0;

          padding: 0;

          font-family:
            'WenQuanYi Micro Hei', 'Microsoft YaHei', 'PingFang SC', 'Hiragino Sans GB', 'Helvetica Neue', Arial,
            sans-serif;

          font-weight: 400;

          line-height: 1.6;
        }
      }

      @layer components {
        .leather-journal {
          background: linear-gradient(145deg, #faf6f0 0%, #f5f0e8 50%, #f0eae0 100%);

          border: 2px solid #8b6914;

          min-height: 600px;

          position: relative;

          box-shadow:
            inset 0 0 20px #8b691433,
            0 4px 8px #0000004d;
        }

        .leather-journal:before {
          content: '';

          pointer-events: none;

          background-image:
            radial-gradient(circle at 15% 25%, #8b691414 1px, #0000 2px),
            radial-gradient(circle at 85% 75%, #6543210f 1px, #0000 2px),
            radial-gradient(circle at 45% 60%, #a086590a 1px, #0000 2px);

          background-size:
            40px 40px,
            60px 60px,
            80px 80px;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;
        }

        .connected-panels {
          z-index: 2;

          border-radius: 8px;

          grid-template-rows: auto 1fr auto;

          grid-template-columns: 250px 1fr 200px;

          gap: 0;

          width: 100%;

          max-width: 1600px;

          height: 750px;

          margin: auto;

          transition: all 0.3s;

          display: grid;

          position: relative;

          overflow: hidden;

          box-shadow: 0 8px 16px #00000080;
        }

        .connected-panels.fullscreen-active {
          z-index: 9999;

          border-radius: 0;

          width: 100vw;

          max-width: none;

          height: 100vh;

          margin: 0;

          position: fixed;

          top: 0;

          left: 0;
        }

        .connected-panels.fullscreen-active .panel-content {
          z-index: 10000;
        }

        .connected-panels.fullscreen-active .save-section {
          z-index: 10001;

          position: relative;
        }

        .connected-panels.fullscreen-active ~ .rules-modal {
          z-index: 10002;
        }

        .connected-panels.fullscreen-active ~ .rules-modal .rules-modal-content {
          z-index: 10003;
        }

        .connected-panels.fullscreen-active ~ .danger-modal,
        .connected-panels.fullscreen-active ~ #load-modal,
        .connected-panels.fullscreen-active ~ #rules-modal,
        .connected-panels.fullscreen-active ~ #command-modal {
          z-index: 10002;
        }

        
        #teresen-fullscreen-overlay .rules-modal,
        #teresen-fullscreen-overlay .danger-modal,
        #teresen-fullscreen-overlay #load-modal,
        #teresen-fullscreen-overlay #rules-modal,
        #teresen-fullscreen-overlay #command-modal,
        #teresen-fullscreen-overlay #talents-modal,
        #teresen-fullscreen-overlay #saveManagerModal,
        #teresen-fullscreen-overlay #world-map-modal,
        #teresen-fullscreen-overlay #tarot-modal,
        #teresen-fullscreen-overlay #shrine-modal,
        #teresen-fullscreen-overlay #achievement-modal,
        #teresen-fullscreen-overlay #achievements-modal,
        #teresen-fullscreen-overlay #achievement-detail-modal,
        #teresen-fullscreen-overlay .item-detail-popup,
        #teresen-fullscreen-overlay #roster-modal,
        #teresen-fullscreen-overlay .roster-modal,
        #teresen-fullscreen-overlay #roster-detail-modal,
        #teresen-fullscreen-overlay #location-detail-panel,
        #teresen-fullscreen-overlay #quick-map-modal,
        #teresen-fullscreen-overlay #quick-action-modal,
        #teresen-fullscreen-overlay #quick-position-modal,
        #teresen-fullscreen-overlay #music-player-modal,
        #teresen-fullscreen-overlay #location-confirm-modal,
        #teresen-fullscreen-overlay #settings-modal,
        #teresen-fullscreen-overlay #card-display-modal {
          position: fixed !important;
          z-index: 100001 !important; 
          top: 0 !important;
          left: 0 !important;
          width: 100vw !important;
          height: 100vh !important;
          padding: 20px !important; 
          box-sizing: border-box !important;
        }

        
        #teresen-fullscreen-overlay #card-display-modal .rules-modal-content {
          width: 100% !important;
          max-width: calc(100vw - 40px) !important; 
          max-height: calc(100vh - 40px) !important; 
          margin: 0 !important;
          border-radius: 16px !important;
          box-shadow:
            0 25px 50px rgba(0, 0, 0, 0.4),
            0 0 0 1px rgba(139, 105, 20, 0.1) !important;
        }

        
        #teresen-fullscreen-overlay .item-detail-popup {
          width: auto !important;
          height: auto !important;
        }

        .danger-modal,
        #load-modal,
        #rules-modal {
          z-index: 10000;
        }

        
        .rules-modal,
        .danger-modal,
        #load-modal,
        #rules-modal,
        #command-modal,
        #talents-modal,
        #saveManagerModal {
          position: fixed !important;
        }

        .parchment-page {
          color: #2d2d2d;

          background-color: #fdfbf7;

          border: 1px solid #8b6914;

          flex-direction: column;

          display: flex;

          position: relative;

          box-shadow: inset 0 0 20px #8b69141a;
        }

        .parchment-page:before {
          content: '';

          pointer-events: none;

          background-image:
            radial-gradient(circle at 20% 30%, #8b69140d 2px, #0000 4px),
            radial-gradient(circle at 80% 70%, #a086590a 1px, #0000 3px);

          background-size:
            60px 60px,
            40px 40px;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;
        }

        .left-panel {
          grid-area: 1/1/3;

          width: 100%;

          height: 100%;

          overflow: hidden auto;
        }

        .center-panel {
          flex-direction: column;

          grid-area: 1/2/3;

          width: 100%;

          height: 100%;

          display: flex;

          overflow: hidden auto;
        }

        .right-panel {
          flex-direction: column;

          grid-area: 1/3/3;

          gap: 0.75rem;

          width: 100%;

          height: 100%;

          display: flex;

          overflow: hidden auto;
        }

        .panel-content {
          z-index: 1;

          flex-direction: column;

          height: 100%;

          padding: 0.75rem;

          font-size: 1rem;

          display: flex;

          position: relative;

          overflow-y: auto;
        }

        .panel-divider {
          background: linear-gradient(#8b6914, #a0865a, #8b6914);

          width: 3px;

          height: 100%;

          position: relative;

          box-shadow:
            inset 0 0 4px #0000004d,
            0 0 8px #8b691433;
        }

        .panel-divider:before {
          content: '';

          background: linear-gradient(#0000 0%, #ffffff1a 50%, #0000 100%);

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;
        }

        .panel-divider:after {
          content: '';

          background: radial-gradient(circle, #a0865a, #8b6914);

          border-radius: 50%;

          width: 8px;

          height: 8px;

          position: absolute;

          top: 50%;

          left: 50%;

          transform: translate(-50%, -50%);

          box-shadow: 0 0 4px #0000004d;

          display: none; 
        }

        .section-header {
          border-bottom: 1px solid #8b69144d;

          align-items: center;

          gap: 0.5rem;

          margin-bottom: 0.75rem;

          padding-bottom: 0.375rem;

          display: flex;
        }

        .section-header h3 {
          color: #2d2d2d;

          margin: 0;

          font-size: 0.9rem;

          font-weight: 600;

          flex: 1;
        }

        .icon {
          color: #8b4513;

          width: 1rem;

          height: 1rem;
        }

        
        .view-rules-button .icon {
          width: 1rem;
          height: 1rem;
        }

        .roster-btn {
          cursor: pointer;

          background: 0 0;

          border: none;

          border-radius: 0.25rem;

          margin-left: auto;

          padding: 0.25rem;

          font-size: 1rem;

          color: #8b4513;

          transition: all 0.2s ease;
        }

        .roster-btn:hover {
          background-color: #8b69141a;

          transform: scale(1.1);
        }

        
        .roster-modal {
          z-index: 1000;
          backdrop-filter: blur(4px);
          background: #000000b3;
          justify-content: center;
          align-items: center;
          width: 100%;
          height: 100%;
          display: flex;
          position: fixed;
          top: 0;
          left: 0;
        }

        .roster-content {
          background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 100%);
          border: 3px solid #8b6914;
          border-radius: 1rem;
          max-width: 600px;
          height: auto;
          max-height: calc(100vh - 40px);
          width: 90%;
          overflow: visible;
          box-shadow: 0 20px 40px #0000004d;
          position: relative;
          display: flex;
          flex-direction: column;
        }

        .roster-content:before {
          content: '';
          pointer-events: none;
          background-image:
            radial-gradient(circle at 20% 30%, #8b69140d 2px, #0000 4px),
            radial-gradient(circle at 80% 70%, #a086590a 1px, #0000 3px);
          background-size:
            60px 60px,
            40px 40px;
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
        }

        .roster-header {
          background: linear-gradient(135deg, #8b6914, #a0865a);
          color: #fdfbf7;
          padding: 1rem 1.5rem;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: 2px solid #654321;
        }

        .roster-header h2 {
          margin: 0;
          font-size: 1.2rem;
          font-weight: 600;
        }

        .roster-close-btn {
          background: none;
          border: none;
          color: white;
          font-size: 1.5rem;
          cursor: pointer;
          padding: 0;
          width: 30px;
          height: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
          transition: background-color 0.2s;
        }

        .roster-close-btn:hover {
          background-color: rgba(255, 255, 255, 0.2);
        }

        .roster-body {
          flex: 1;
          min-height: 0;
          padding: 1.5rem;
          overflow-y: auto;
          max-height: calc(100vh - 120px);
        }

        .empty-roster {
          text-align: center;
          color: #8b4513;
          font-style: italic;
          padding: 2rem;
        }

        .roster-list {
          display: flex;
          flex-direction: column;
          gap: 1rem;
        }

        .roster-item {
          background: white;
          border: 1px solid #d4af37;
          border-radius: 6px;
          padding: 1rem;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .roster-item-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 0.5rem;
          border-bottom: 1px solid #f0f0f0;
          padding-bottom: 0.5rem;
        }

        .roster-item-header h3 {
          margin: 0;
          color: #8b4513;
          font-size: 1.1rem;
          font-weight: 600;
        }

        .encounter-count {
          background: #8b4513;
          color: white;
          padding: 0.25rem 0.5rem;
          border-radius: 12px;
          font-size: 0.8rem;
          font-weight: 500;
        }

        .roster-item-details {
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
        }

        .roster-detail {
          color: #2d2d2d;
          font-size: 0.9rem;
          line-height: 1.4;
        }

        .roster-detail strong {
          color: #8b4513;
          font-weight: 600;
        }

        .expand-btn {
          cursor: pointer;

          background: 0 0;

          border: none;

          border-radius: 0.25rem;

          margin-left: auto;

          padding: 0.25rem;

          transition: background-color 0.2s;
        }

        .expand-btn:hover {
          background-color: #8b69141a;
        }

        .save-section {
          gap: 0.5rem;

          margin-bottom: 1.5rem;

          display: flex;
        }

        .save-section .save-button {
          flex: 1;

          min-width: 0;

          padding: 0.375rem;

          font-size: 0.7rem;
        }

        .save-button {
          color: #e8d5d5;

          cursor: pointer;

          text-shadow: 0 1px 2px #00000080;

          background: linear-gradient(135deg, #2d1b1b, #3d2b2b);

          border: 1px solid #8b0000;

          border-radius: 0.25rem;

          justify-content: center;

          align-items: center;

          gap: 0.5rem;

          width: 100%;

          padding: 0.5rem;

          font-size: 0.75rem;

          font-weight: 500;

          transition: all 0.2s;

          display: flex;

          position: relative;

          box-shadow:
            inset 0 1px #ffffff1a,
            0 2px 4px #0006;
        }

        .save-button:before {
          content: '';

          opacity: 0;

          background: linear-gradient(135deg, #8b00001a, #0000);

          transition: opacity 0.2s;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;
        }

        .save-button:hover:before {
          opacity: 1;
        }

        .save-button:hover {
          color: #f0e0e0;

          background: linear-gradient(135deg, #3d2b2b, #4d3b3b);

          border-color: #a00000;

          box-shadow:
            inset 0 1px #ffffff26,
            0 3px 6px #00000080;
        }

        .save-button:active {
          background: linear-gradient(135deg, #1d0b0b, #2d1b1b);

          box-shadow:
            inset 0 2px 4px #0009,
            0 1px 2px #0000004d;
        }

        .status-section {
          margin-bottom: 0.5rem;
        }

        .status-item {
          margin-bottom: 0.3rem;
        }

        .status-header {
          justify-content: space-between;

          align-items: center;

          margin-bottom: 0.25rem;

          display: flex;
        }

        .status-label {
          color: #2d2d2d;

          font-size: 0.75rem;

          font-weight: 500;
        }

        .status-value {
          color: #8b4513;

          font-size: 0.75rem;

          font-weight: 600;
        }

        .progress-bar {
          background-color: #8b691433;

          border-radius: 9999px;

          height: 0.5rem;

          position: relative;

          overflow: hidden;
        }

        .progress-fill {
          background: linear-gradient(90deg, #059669 0%, #10b981 100%);

          border-radius: 9999px;

          height: 100%;

          transition: width 0.5s;
        }

        .progress-fill.danger {
          background: linear-gradient(90deg, #dc2626 0%, #ef4444 100%);

          animation: 3s ease-in-out infinite subtle-pulse;
        }

        .progress-fill.warning {
          background: linear-gradient(90deg, #d97706 0%, #f59e0b 100%);
        }

        .profile-section,
        .journey-section,
        .inventory-section {
          margin-bottom: 1rem;
        }

        .profile-basic,
        .journey-basic {
          font-size: 0.75rem;
        }

        .profile-item,
        .detail-item {
          justify-content: space-between;

          margin-bottom: 0.25rem;

          display: flex;
        }

        .label {
          color: #6b7280;

          font-weight: 400;
        }

        .value {
          color: #2d2d2d;

          font-weight: 500;
        }

        .status-excellent {
          color: #059669;

          font-weight: 600;

          text-shadow: 0 0 5px rgba(5, 150, 105, 0.3);
        }

        .status-good {
          color: #d97706;

          font-weight: 600;

          text-shadow: 0 0 5px rgba(217, 119, 6, 0.3);
        }

        .status-normal {
          color: #6b7280;

          font-weight: 500;
        }

        .status-bad {
          color: #dc2626;

          font-weight: 600;

          text-shadow: 0 0 5px rgba(220, 38, 38, 0.3);
        }

        .status-terrible {
          color: #7f1d1d;

          font-weight: 700;

          text-shadow: 0 0 8px rgba(127, 29, 29, 0.5);

          animation: 2s ease-in-out infinite subtle-pulse;
        }

        .profile-detail,
        .journey-detail {
          font-size: 0.75rem;
        }

        .profile-current-song {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 12px;
          margin-bottom: 12px;
          background: linear-gradient(135deg, rgba(139, 69, 19, 0.15), rgba(139, 105, 20, 0.1));
          border: 1px solid rgba(139, 69, 19, 0.3);
          border-radius: 6px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          animation: fadeIn 0.3s ease-in;
        }

        .profile-current-song .label {
          font-size: 0.85rem;
          color: #8b6914;
          font-weight: 600;
        }

        .profile-current-song .value {
          font-size: 0.85rem;
          color: #a0522d;
          font-weight: 500;
          max-width: 200px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(-5px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .detail-card {
          background-color: #8b69141a;

          border: 1px solid #8b6914;

          border-radius: 0.375rem;

          margin-bottom: 0.75rem;

          padding: 0.75rem;
        }

        .anomaly-card {
          background: linear-gradient(45deg, #8b00001a, #8b000033);

          border: 1px solid #8b0000;

          border-radius: 0.375rem;

          padding: 0.75rem;
        }

        .anomaly-card h4 {
          margin: 0 0 0.5rem;

          font-size: 0.875rem;
        }

        .anomaly-list {
          flex-direction: column;

          gap: 0.25rem;

          display: flex;
        }

        .anomaly-item {
          font-size: 0.75rem;
        }

        .profile-link,
        .journey-link {
          color: #8b4513;

          cursor: pointer;

          font-size: 0.75rem;
        }

        .journey-list {
          flex-direction: column;

          gap: 0.5rem;

          max-height: 200px;

          display: flex;

          overflow-y: auto;
        }

        .journey-entry {
          background-color: #8b69141a;

          border-left: 2px solid #8b6914;

          border-radius: 0.25rem;

          padding: 0.5rem;
        }

        .journey-header {
          justify-content: space-between;

          align-items: flex-start;

          margin-bottom: 0.25rem;

          display: flex;
        }

        .journey-day {
          color: #2d2d2d;

          font-weight: 600;
        }

        .journey-status {
          border-radius: 0.125rem;

          padding: 0.125rem 0.25rem;

          font-size: 0.625rem;

          font-weight: 600;
        }

        .journey-status.normal {
          color: #059669;

          background-color: #05966933;
        }

        .journey-status.confused {
          color: #d97706;

          background-color: #d9770633;
        }

        .journey-event {
          color: #8b4513;

          margin-bottom: 0.125rem;

          font-weight: 500;
        }

        .journey-desc {
          color: #654321;

          font-size: 0.625rem;
        }

        .sanity-change {
          margin-top: 0.25rem;

          font-size: 0.625rem;
        }

        .inventory-container {
          max-height: 200px;

          overflow-y: auto;
        }

        .empty-inventory,
        .empty-rules,
        .loading-uma {
          text-align: center;

          color: #8b4513;

          padding: 1rem;

          font-size: 0.75rem;
        }

        .empty-uma {
          text-align: center;
          color: #8b4513;
          padding: 1rem 0.75rem;
          font-size: 0.85rem;
          font-weight: 500;
          background: linear-gradient(135deg, rgba(244, 241, 232, 0.9), rgba(255, 250, 240, 0.9));
          border: 1px dashed #d4af37;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(139, 69, 19, 0.1);
          position: relative;
          font-family: 'Noto Serif SC', serif;
        }

        .empty-uma::before {
          content: 'üêé';
          display: inline-block;
          font-size: 1.5rem;
          margin-right: 0.5rem;
          opacity: 0.7;
          vertical-align: middle;
        }

        .story-container {
          flex: 1;

          padding: 1.5rem;

          overflow-y: auto;
        }

        .story-content {
          color: #2d2d2d;

          white-space: pre-wrap;

          font-family:
            Georgia,
            Times New Roman,
            serif;

          font-size: 1rem;

          line-height: 1.8;

          min-height: 200px;

          position: relative;
        }

        .story-text {
          margin: 0;
        }

        .input-section {
          background-color: #fdfbf7;

          border-top: 2px solid #8b6914;

          padding: 0.75rem;
        }

        .input-header {
          justify-content: flex-start;

          align-items: center;

          margin-bottom: 0.75rem;

          display: flex;

          flex-wrap: wrap;

          gap: 0.5rem;
        }

        .time-display {
          color: #8b4513;

          align-items: center;

          gap: 0.5rem;

          font-size: 0.75rem;

          font-weight: 600;

          display: flex;
        }

        .time-display.compact {
          font-size: 0.75rem;

          gap: 0.5rem;
        }

        .time-display.compact .icon {
          width: 0.8rem;

          height: 0.8rem;
        }

        .compact-button {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.1), rgba(139, 105, 20, 0.05));

          border: 1px solid rgba(139, 105, 20, 0.3);

          border-radius: 0.25rem;

          padding: 0.25rem 0.5rem;

          color: #8b4513;

          cursor: pointer;

          transition: all 0.2s;

          display: flex;

          align-items: center;

          gap: 0.25rem;

          font-size: 0.7rem;

          font-weight: 600;
        }

        .compact-button:hover {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.2), rgba(139, 105, 20, 0.1));

          transform: translateY(-1px);

          box-shadow: 0 2px 4px rgba(139, 69, 19, 0.2);

          border-color: rgba(139, 105, 20, 0.5);
        }

        .compact-button .icon {
          width: 14px;

          height: 14px;
        }

        .streaming-toggle.compact {
          font-size: 0.7rem;
          gap: 0.15rem;
        }

        .streaming-toggle.compact .toggle-label {
          font-size: 0.7rem;
        }

        .danger-button.compact {
          padding: 0.25rem 0.5rem;

          font-size: 0.7rem;

          border-radius: 0.25rem;
        }

        .danger-level {
          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: inline-flex;
        }

        .danger-details {
          color: #78350f;

          white-space: pre-line;

          background: #fef3c7e6;

          border: 1px solid #f59e0b;

          border-radius: 0.5rem;

          margin-top: 0.5rem;

          padding: 1rem;

          font-size: 0.8rem;

          line-height: 1.6;
        }

        .danger-modal {
          z-index: 1000;

          backdrop-filter: blur(4px);

          background: #000000b3;

          justify-content: center;

          align-items: center;

          width: 100%;

          height: 100%;

          display: flex;

          position: fixed;

          top: 0;

          left: 0;
        }

        .danger-modal-content {
          background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 100%);

          border: 3px solid #8b6914;

          border-radius: 1rem;

          width: 90%;

          max-width: 600px;

          max-height: 80vh;

          position: relative;

          overflow: hidden;

          box-shadow: 0 20px 40px #0000004d;
        }

        .danger-modal-content:before {
          content: '';

          pointer-events: none;

          background-image:
            radial-gradient(circle at 20% 30%, #8b69140d 2px, #0000 4px),
            radial-gradient(circle at 80% 70%, #a086590a 1px, #0000 3px);

          background-size:
            60px 60px,
            40px 40px;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;
        }

        .danger-modal-header {
          color: #fdfbf7;

          background: linear-gradient(135deg, #8b6914, #a0865a);

          border-bottom: 2px solid #654321;

          justify-content: space-between;

          align-items: center;

          padding: 1rem 1.5rem;

          display: flex;
        }

        .danger-modal-header h3 {
          text-shadow: 0 2px 4px #0000004d;

          margin: 0;

          font-family:
            Brush Script MT,
            cursive;

          font-size: 1.5rem;

          font-weight: 700;

          transform: rotate(-1deg);
        }

        .danger-modal-close {
          color: #fdfbf7;

          cursor: pointer;

          background: 0 0;

          border: none;

          border-radius: 0.25rem;

          padding: 0.25rem 0.5rem;

          font-size: 1.5rem;

          transition: all 0.2s;
        }

        .danger-modal-close:hover {
          background: #fff3;
        }

        .danger-modal-body {
          max-height: 60vh;

          padding: 1.5rem;

          overflow-y: auto;
        }

        .danger-current-period {
          text-align: center;

          color: #8b4513;

          background: #8b69141a;

          border: 2px solid #8b6914;

          border-radius: 0.5rem;

          margin-bottom: 1.5rem;

          padding: 1rem;

          font-family:
            Brush Script MT,
            cursive;

          font-size: 1.1rem;

          font-weight: 600;
        }

        .danger-details-content {
          color: #654321;

          white-space: pre-line;

          background: #fff6;

          border: 1px solid #8b691433;

          border-radius: 0.75rem;

          padding: 1.5rem;

          font-family:
            Georgia,
            Times New Roman,
            serif;

          font-size: 0.9rem;

          line-height: 1.8;

          box-shadow: inset 0 2px 4px #0000001a;
        }

        .danger-details-content strong {
          color: #8b4513;

          font-weight: 600;
        }

        .danger-details-content .danger-stars {
          color: #d4af37;

          margin: 0.5rem 0;

          font-size: 1.1rem;
        }

        .danger-details-content .danger-suggestion {
          background: #8b69141a;

          border-left: 3px solid #8b6914;

          border-radius: 0.25rem;

          margin: 0.75rem 0;

          padding: 0.75rem;
        }

        .danger-level.safe {
          color: #059669;

          background: linear-gradient(135deg, #0596691a, #10b9811a);

          border: 1px solid #059669;
        }

        .danger-level.low {
          color: #d97706;

          background: linear-gradient(135deg, #d977061a, #f59e0b1a);

          border: 1px solid #d97706;
        }

        .danger-level.medium {
          color: #ea580c;

          background: linear-gradient(135deg, #ea580c1a, #fb923c1a);

          border: 1px solid #ea580c;
        }

        .danger-level.high {
          color: #dc2626;

          background: linear-gradient(135deg, #dc26261a, #ef44441a);

          border: 1px solid #dc2626;
        }

        .danger-level.extreme {
          color: #1f2937;

          background: linear-gradient(135deg, #1f29371a, #3741511a);

          border: 1px solid #1f2937;
        }

        .danger-button {
          color: #8b0000;

          cursor: pointer;

          background-color: #8b00001a;

          border: 1px solid #8b0000;

          border-radius: 0.375rem;

          padding: 0.5rem 1rem;

          font-size: 0.75rem;

          font-weight: 600;

          transition: all 0.2s;
        }

        .danger-button:hover {
          background-color: #8b000033;
        }

        .input-container {
          background-color: #8b69141a;

          border: 1px solid #8b6914;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          padding: 0.75rem;

          display: flex;
        }

        .input-prompt {
          color: #8b4513;

          font-size: 1.125rem;

          font-weight: 700;
        }

        .action-input {
          color: #2d2d2d;

          resize: vertical;

          background: 0 0;

          border: none;

          outline: none;

          flex: 1;

          min-height: 40px;

          max-height: 120px;

          font-family:
            Georgia,
            Times New Roman,
            serif;

          font-size: 0.875rem;

          font-weight: 500;

          line-height: 1.5;
        }

        .input-controls {
          align-items: center;

          gap: 0.5rem;

          margin-top: 0.5rem;

          display: flex;
        }

        .send-button {
          color: #fdfbf7;

          cursor: pointer;

          background: linear-gradient(135deg, #8b6914, sienna);

          border: none;

          border-radius: 0.375rem;

          padding: 0.5rem 1rem;

          font-size: 0.875rem;

          font-weight: 600;

          transition: all 0.2s;

          box-shadow: 0 2px 4px #0003;
        }

        .send-button:hover {
          background: linear-gradient(135deg, sienna, #8b6914);

          transform: translateY(-1px);

          box-shadow: 0 4px 8px #0000004d;
        }

        .send-button:active {
          transform: translateY(0);

          box-shadow: 0 2px 4px #0003;
        }

        .action-input::placeholder {
          color: #8b4513;
        }

        .rules-section,
        .uma-section {
          margin-bottom: 1rem;
        }

        .uma-section-header {
          cursor: pointer;

          background: #8b69140d;

          border-bottom: 1px solid #8b6914;

          border-radius: 0.25rem;

          justify-content: space-between;

          align-items: center;

          margin-bottom: 0.5rem;

          padding: 0.5rem;

          display: flex;
        }

        .uma-section-header:hover {
          background-color: #8b69141a;

          border-radius: 0.25rem;
        }

        .uma-section-title {
          color: #2d2d2d;

          font-size: 0.875rem;

          font-weight: 600;
        }

        .uma-toggle {
          color: #8b6914;

          font-size: 0.75rem;

          transition: transform 0.2s;
        }

        .uma-content {
          max-height: 300px;

          margin-top: 0.5rem;

          overflow: hidden auto;
        }

        .rules-list,
        .uma-list {
          flex-direction: column;

          gap: 0.5rem;

          display: flex;
        }

        .rule-item {
          background: #fff9;

          border-left: 3px solid #d4af37;

          border-radius: 0.5rem;

          margin-bottom: 0.5rem;

          padding: 0.5rem;

          font-size: 0.75rem;

          line-height: 1.3;

          transition: all 0.3s;

          box-shadow: 0 2px 4px #0000001a;
        }

        .rule-item:hover {
          box-shadow: 0 4px 8px #00000026;
        }

        .rule-item.dangerous-rule {
          background: linear-gradient(135deg, #8b00001a, #8b000033);

          border-left: 3px solid #8b0000;

          box-shadow: 0 2px 8px #8b000033;
        }

        .rule-item.dangerous-rule:hover {
          box-shadow: 0 4px 12px #8b00004d;
        }

        .rule-number {
          color: #8b6914;

          text-shadow: 0 1px 2px #0000001a;

          margin-right: 0.75rem;

          font-size: 0.9rem;

          font-weight: 700;
        }

        .rule-text {
          color: #2d2d2d;

          font-weight: 500;

          line-height: 1.3;
        }

        .dangerous-rule .rule-number {
          color: #8b0000;

          text-shadow: 0 1px 3px #8b00004d;
        }

        .dangerous-rule .rule-text {
          color: #8b0000;

          text-shadow: 0 0 2px #8b000033;
        }

        .fixed-rule {
          background: linear-gradient(135deg, #8b69141a, #d4af371a);

          border-left: 3px solid #8b6914;

          border-radius: 0.5rem;

          margin-bottom: 0.5rem;

          padding: 0.5rem;

          font-size: 0.75rem;

          line-height: 1.3;

          transition: all 0.3s;

          box-shadow: 0 2px 4px #0000001a;
        }

        .fixed-rule:hover {
          background: linear-gradient(135deg, #8b691426, #d4af3726);

          box-shadow: 0 4px 8px #00000026;
        }

        .fixed-rule .rule-number {
          color: #8b6914;

          text-shadow: 0 1px 2px #0000001a;

          margin-right: 0.75rem;

          font-size: 0.9rem;

          font-weight: 700;
        }

        .fixed-rule .rule-text {
          color: #2d2d2d;

          font-weight: 500;

          line-height: 1.3;
        }

        .view-rules-button {
          color: #e8d5d5;

          cursor: pointer;

          text-shadow: 0 1px 2px #00000080;

          background: linear-gradient(135deg, #2d1b1b, #3d2b2b);

          border: 1px solid #8b0000;

          border-radius: 0.2rem;

          justify-content: center;

          align-items: center;

          gap: 0.15rem;

          width: 100%;

          padding: 0.15rem 0.25rem;

          font-size: 0.45rem;

          font-weight: 500;

          transition: all 0.2s;

          display: flex;

          position: relative;

          box-shadow:
            inset 0 1px #ffffff1a,
            0 2px 4px #0006;
        }

        .view-rules-button:before {
          content: '';

          opacity: 0;

          background: linear-gradient(135deg, #8b00001a, #0000);

          transition: opacity 0.2s;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;
        }

        .view-rules-button:hover:before {
          opacity: 1;
        }

        .view-rules-button:hover {
          color: #f0e0e0;

          background: linear-gradient(135deg, #3d2b2b, #4d3b3b);

          border-color: #a00000;

          box-shadow:
            inset 0 1px #ffffff26,
            0 3px 6px #00000080;
        }

        .view-rules-button:active {
          background: linear-gradient(135deg, #1d0b0b, #2d1b1b);

          box-shadow:
            inset 0 2px 4px #0009,
            0 1px 2px #0000004d;
        }

        .rules-modal {
          z-index: 1000;

          backdrop-filter: blur(4px);

          background: #000000b3;

          justify-content: center;

          align-items: center;

          width: 100%;

          height: 100%;

          display: flex;

          position: fixed;

          top: 0;

          left: 0;
        }

        .rules-modal-content {
          background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 100%);

          border: 3px solid #8b6914;

          border-radius: 1rem;

          width: 90%;

          max-width: 600px;

          max-height: 80vh;

          position: relative;

          overflow: hidden;

          box-shadow: 0 20px 40px #0000004d;
        }

        
        .card-display-section {
          margin-top: 0.75rem;
        }

        .card-display-icon {
          color: #8b6914;
          filter: drop-shadow(0 1px 2px rgba(139, 105, 20, 0.3));
          transition: all 0.3s ease;
          position: relative;
        }

        .card-display-icon::after {
          content: 'üÉè';
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-size: 0.6em;
          opacity: 0.6;
          pointer-events: none;
        }

        .card-display-section:hover .card-display-icon {
          color: #a08659;
          transform: scale(1.1);
          filter: drop-shadow(0 2px 4px rgba(139, 105, 20, 0.5));
        }

        .card-display-section:hover .card-display-icon::after {
          opacity: 0.8;
          transform: translate(-50%, -50%) rotate(15deg);
        }

        
        .card-display-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
          gap: 18px; 
          padding: 25px; 
          max-height: 70vh;
          overflow-y: auto;
          background: rgba(253, 251, 247, 0.3); 
          border-radius: 12px;
          margin: 15px;
        }

        
        .card-display-grid::-webkit-scrollbar {
          width: 8px;
        }

        .card-display-grid::-webkit-scrollbar-track {
          background: rgba(139, 105, 20, 0.1);
          border-radius: 4px;
        }

        
        .uma-expression-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
          gap: 20px;
          padding: 10px;
          max-height: 60vh;
          overflow-y: auto;
        }

        .uma-expression-grid::-webkit-scrollbar {
          width: 8px;
        }

        .uma-expression-grid::-webkit-scrollbar-track {
          background: rgba(139, 105, 20, 0.1);
          border-radius: 4px;
        }

        .uma-expression-grid::-webkit-scrollbar-thumb {
          background: rgba(139, 105, 20, 0.3);
          border-radius: 4px;
        }

        .uma-expression-grid::-webkit-scrollbar-thumb:hover {
          background: rgba(139, 105, 20, 0.5);
        }

        .uma-expression-item {
          display: flex;
          justify-content: center;
          align-items: center;
        }

        .uma-expression-card {
          background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(244, 241, 232, 0.95) 100%);
          border: 2px solid #8b4513;
          border-radius: 12px;
          padding: 15px;
          text-align: center;
          transition: all 0.3s ease;
          box-shadow: 0 2px 8px rgba(139, 69, 19, 0.15);
          width: 100%;
          max-width: 200px;
        }

        .uma-expression-card:hover {
          transform: translateY(-5px) scale(1.02);
          box-shadow: 0 6px 16px rgba(139, 69, 19, 0.3);
          border-color: #d4af37;
        }

        .uma-expression-name {
          font-size: 1em;
          font-weight: bold;
          color: #8b4513;
          margin-bottom: 8px;
          text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.1);
        }

        .uma-expression-status {
          font-size: 0.85em;
          color: #654321;
          margin-bottom: 10px;
          opacity: 0.8;
        }

        .uma-expression-image {
          width: 100%;
          max-width: 150px;
          height: auto;
          border: 2px solid #d4af37;
          border-radius: 8px;
          box-shadow: 0 2px 6px rgba(139, 69, 19, 0.2);
          background: rgba(255, 255, 255, 0.5);
          object-fit: contain;
          transition:
            transform 0.3s ease,
            box-shadow 0.3s ease;
        }

        .uma-expression-card:hover .uma-expression-image {
          transform: scale(1.05);
          box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
        }

        .card-display-grid::-webkit-scrollbar-thumb {
          background: rgba(139, 105, 20, 0.3);
          border-radius: 4px;
        }

        .card-display-grid::-webkit-scrollbar-thumb:hover {
          background: rgba(139, 105, 20, 0.5);
        }

        .card-display-item {
          position: relative;
          aspect-ratio: 1;
          border-radius: 12px; 
          overflow: hidden;
          cursor: pointer;
          transition:
            transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
            box-shadow 0.3s ease,
            border-color 0.3s ease; 
          background: #fff;
          border: 2px solid rgba(139, 105, 20, 0.2); 
          box-shadow:
            0 4px 12px rgba(0, 0, 0, 0.1),
            0 2px 4px rgba(139, 105, 20, 0.08); 
        }

        .card-display-item:hover {
          transform: translateY(-4px) scale(1.03); 
          box-shadow:
            0 8px 24px rgba(139, 105, 20, 0.25),
            0 4px 8px rgba(0, 0, 0, 0.15); 
          border-color: rgba(139, 105, 20, 0.5); 
        }

        .card-display-item img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: block;
          transition: transform 0.3s ease;
        }

        .card-display-item:hover img {
          transform: scale(1.05); 
        }

        
        #card-display-modal .rules-modal-content {
          max-width: 90%;
          width: 1200px;
          max-height: 90vh;
          background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 50%, #ede8dd 100%); 
          border: 3px solid #8b6914;
          border-radius: 16px; 
          box-shadow:
            0 25px 50px rgba(0, 0, 0, 0.3),
            0 0 0 1px rgba(139, 105, 20, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.5); 
          position: relative;
          overflow: hidden;
        }

        
        #card-display-modal .rules-modal-content::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 4px;
          background: linear-gradient(
            90deg,
            rgba(139, 105, 20, 0.8) 0%,
            rgba(160, 130, 105, 0.9) 50%,
            rgba(139, 105, 20, 0.8) 100%
          );
          z-index: 1;
        }

        #card-display-modal .rules-modal-body {
          padding: 0;
          overflow: hidden;
        }

        
        #teresen-fullscreen-overlay #card-display-modal {
          
          backdrop-filter: none !important;
        }

        #teresen-fullscreen-overlay #card-display-modal .rules-modal-content {
          max-width: 95%;
          width: 1400px;
          max-height: 95vh;
          
          will-change: transform;
          transform: translateZ(0);
        }

        #teresen-fullscreen-overlay #card-display-modal .card-display-grid {
          grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
          gap: 20px;
          max-height: 85vh;
          
          will-change: scroll-position;
          transform: translateZ(0);
        }

        
        .card-image-viewer {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.95);
          z-index: 10001;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          
          will-change: opacity;
          transform: translateZ(0);
          backface-visibility: hidden;
          
          contain: layout style paint;
        }

        
        .connected-panels.fullscreen-active ~ .card-image-viewer,
        #teresen-fullscreen-overlay .card-image-viewer {
          z-index: 100002 !important; 
        }

        .card-image-viewer img {
          max-width: 90%;
          max-height: 90%;
          object-fit: contain;
          border-radius: 8px;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
          
          will-change: transform;
          transform: translateZ(0);
          image-rendering: -webkit-optimize-contrast;
          image-rendering: crisp-edges;
        }

        
        .card-image-viewer img[data-loading='true'] {
          opacity: 0;
          transition: opacity 0.3s ease;
        }

        .card-image-viewer img[data-loaded='true'] {
          opacity: 1;
        }

        .card-image-viewer .close-viewer {
          position: absolute;
          top: 20px;
          right: 20px;
          background: rgba(255, 255, 255, 0.2);
          border: 2px solid rgba(255, 255, 255, 0.5);
          color: white;
          font-size: 30px;
          width: 50px;
          height: 50px;
          border-radius: 50%;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          
          transition: background-color 0.3s ease;
          will-change: transform, background-color;
          transform: translateZ(0);
        }

        .card-image-viewer .close-viewer:hover {
          background: rgba(255, 255, 255, 0.3);
          transform: translateZ(0) rotate(90deg);
        }

        

        #talents-modal .current-talents::-webkit-scrollbar,
        #talents-modal .upgrade-options::-webkit-scrollbar {
          width: 8px;
        }

        #talents-modal .current-talents::-webkit-scrollbar-track,
        #talents-modal .upgrade-options::-webkit-scrollbar-track {
          background: rgba(139, 69, 19, 0.1);

          border-radius: 4px;
        }

        #talents-modal .current-talents::-webkit-scrollbar-thumb,
        #talents-modal .upgrade-options::-webkit-scrollbar-thumb {
          background: rgba(139, 69, 19, 0.3);

          border-radius: 4px;
        }

        #talents-modal .current-talents::-webkit-scrollbar-thumb:hover,
        #talents-modal .upgrade-options::-webkit-scrollbar-thumb:hover {
          background: rgba(139, 69, 19, 0.5);
        }

        

        ::-webkit-scrollbar {
          width: 4px;
        }

        ::-webkit-scrollbar-track {
          background: rgba(240, 240, 240, 0.3);

          border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb {
          background: rgba(180, 180, 180, 0.4);

          border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb:hover {
          background: rgba(160, 160, 160, 0.6);
        }

        .rules-modal-content:before {
          content: '';

          pointer-events: none;

          background-image:
            radial-gradient(circle at 20% 30%, #8b69140d 2px, #0000 4px),
            radial-gradient(circle at 80% 70%, #a086590a 1px, #0000 3px);

          background-size:
            60px 60px,
            40px 40px;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;
        }

        .rules-modal-header {
          color: #fdfbf7;

          background: linear-gradient(135deg, #8b6914, #a0865a);

          border-bottom: 2px solid #654321;

          justify-content: space-between;

          align-items: center;

          padding: 1rem 1.5rem;

          display: flex;
        }

        .rules-title {
          text-shadow: 0 2px 4px #0000004d;

          margin: 0;

          font-family:
            Brush Script MT,
            cursive;

          font-size: 1.5rem;

          font-weight: 700;

          transform: rotate(-1deg);
        }

        .close-rules-btn {
          color: #fdfbf7;

          cursor: pointer;

          background: 0 0;

          border: none;

          border-radius: 0.25rem;

          padding: 0.25rem 0.5rem;

          font-size: 1.5rem;

          transition: all 0.2s;
        }

        .close-rules-btn:hover {
          background: #fff3;
        }

        .rules-modal-body {
          max-height: 60vh;

          padding: 1.5rem;

          overflow-y: auto;
        }

        .book-tab:hover {
          transform: translateY(-3px) !important;

          box-shadow: 0 -4px 16px rgba(139, 105, 20, 0.4) !important;
        }

        .book-page-content {
          position: relative;

          overflow: hidden;
        }

        .book-page-content::before {
          content: '';

          position: absolute;

          top: 0;

          left: 0;

          right: 0;

          height: 1px;

          background: linear-gradient(90deg, transparent, rgba(139, 105, 20, 0.3), transparent);
        }

        .book-page-content::after {
          content: '';

          position: absolute;

          bottom: 0;

          left: 0;

          right: 0;

          height: 1px;

          background: linear-gradient(90deg, transparent, rgba(139, 105, 20, 0.3), transparent);
        }

        .rules-section-fixed,
        .rules-section-random {
          margin-bottom: 2rem;
        }

        .rules-section-title {
          color: #8b4513;

          border-bottom: 2px solid #d4af37;

          margin-bottom: 1rem;

          padding-bottom: 0.5rem;

          font-family:
            Brush Script MT,
            cursive;

          font-size: 1.2rem;

          font-weight: 700;

          transform: rotate(1deg);
        }

        .rules-list-handwritten {
          color: #2d2d2d;

          text-shadow: 0 1px 1px #fffc;

          font-family:
            Segoe Script,
            Brush Script MT,
            Georgia,
            serif;

          font-size: 0.95rem;

          font-weight: 500;

          line-height: 1.7;
        }

        .rule-item-handwritten {
          background: #fff9;

          border-left: 3px solid #d4af37;

          border-radius: 0.25rem;

          gap: 0.75rem;

          margin-bottom: 0.75rem;

          padding: 0.5rem;

          transition: all 0.3s;

          display: flex;
        }

        .rule-item-handwritten:hover {
          background: #fffc;

          transform: translate(4px);
        }

        .rule-number-handwritten {
          color: #8b6914;

          min-width: 1.5rem;

          font-size: 1rem;

          font-weight: 700;
        }

        .rule-text-handwritten {
          flex: 1;

          font-style: normal;

          font-weight: 500;
        }

        
        .rules-record-controls {
          display: flex;
          gap: 0.5rem;
          margin-bottom: 1rem;
        }

        .add-rule-btn,
        .clear-rules-btn {
          background: linear-gradient(135deg, #8b4513, #a0522d);
          color: white;
          border: 1px solid #d4af37;
          border-radius: 0.25rem;
          padding: 0.25rem 0.75rem;
          font-size: 0.8rem;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          font-family: 'Segoe Script', cursive;
        }

        .add-rule-btn:hover,
        .clear-rules-btn:hover {
          background: linear-gradient(135deg, #a0522d, #cd853f);
          transform: translateY(-1px);
          box-shadow: 0 2px 4px rgba(139, 69, 19, 0.3);
        }

        .clear-rules-btn {
          background: linear-gradient(135deg, #dc2626, #ef4444);
        }

        .clear-rules-btn:hover {
          background: linear-gradient(135deg, #ef4444, #f87171);
        }

        .rule-item-editable {
          position: relative;
          padding-right: 2rem;
        }

        .rule-edit-btn,
        .rule-delete-btn {
          position: absolute;
          right: 0.25rem;
          top: 50%;
          transform: translateY(-50%);
          background: none;
          border: none;
          color: #8b4513;
          cursor: pointer;
          font-size: 0.8rem;
          padding: 0.1rem;
          border-radius: 0.2rem;
          transition: all 0.2s;
        }

        .rule-edit-btn {
          right: 1.5rem;
        }

        .rule-edit-btn:hover,
        .rule-delete-btn:hover {
          background: rgba(139, 69, 19, 0.1);
          color: #a0522d;
        }

        .rule-delete-btn:hover {
          color: #dc2626;
        }

        .rule-input {
          width: 100%;
          background: #fff9;
          border: 1px solid #d4af37;
          border-radius: 0.25rem;
          padding: 0.25rem 0.5rem;
          font-family: 'Segoe Script', cursive;
          font-size: 0.9rem;
          color: #2d2d2d;
          resize: vertical;
          min-height: 2rem;
        }

        .rule-input:focus {
          outline: none;
          border-color: #8b4513;
          background: #fffc;
        }

        .empty-rules {
          color: #8b4513;
          font-style: italic;
          text-align: center;
          padding: 1rem;
          background: rgba(139, 69, 19, 0.1);
          border-radius: 0.25rem;
          border: 1px dashed #d4af37;
        }
        .location-display {
          color: #059669;

          background: linear-gradient(135deg, #0596691a, #10b9811a);

          border: 1px solid #059669;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;
        }

        .inventory-item {
          background: linear-gradient(145deg, #ffffffb3, #8b69141a);

          border: 1px solid #d4af37;

          border-radius: 0.5rem;

          margin-bottom: 0.5rem;

          padding: 0.5rem;

          transition: all 0.3s;

          position: relative;

          box-shadow: 0 2px 6px #0000001a;

          display: flex;

          align-items: center;

          gap: 0.5rem;
        }

        .item-icon {
          font-size: 1.5rem;

          line-height: 1;

          flex-shrink: 0;

          display: inline-block;
        }

        .item-header {
          display: flex;

          align-items: center;

          gap: 0.5rem;

          width: 100%;
        }

        .inventory-item:before {
          content: '';

          opacity: 0.6;

          background: linear-gradient(90deg, #d4af37, gold, #d4af37);

          height: 2px;

          position: absolute;

          top: 0;

          left: 0;

          right: 0;
        }

        .inventory-item:hover {
          border-color: gold;

          box-shadow: 0 4px 10px #00000026;
        }

        .uma-item {
          background:
            linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(139, 105, 20, 0.1)),
            radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.15) 0%, transparent 60%),
            radial-gradient(circle at 20% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 60%),
            linear-gradient(45deg, transparent 30%, rgba(212, 175, 55, 0.05) 50%, transparent 70%) !important;

          background-color: transparent !important;

          border: 1px solid #d4af37 !important;

          border-radius: 0.5rem;

          margin-bottom: 0.75rem;

          padding: 0.75rem;

          transition: all 0.3s;

          position: relative;

          overflow: visible;

          box-shadow:
            0 2px 8px rgba(0, 0, 0, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.2),
            inset 0 -1px 0 rgba(0, 0, 0, 0.05) !important;
        }

        

        .uma-item[style*='background'] {
          background:
            linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(139, 105, 20, 0.1)),
            radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.15) 0%, transparent 60%),
            radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 60%),
            linear-gradient(45deg, transparent 30%, rgba(212, 175, 55, 0.05) 50%, transparent 70%) !important;
        }

        

        div.uma-item,
        .uma-item,
        .uma-item[style],
        .parchment-page .uma-item,
        .panel-content .uma-item {
          background:
            linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(139, 105, 20, 0.1)),
            radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.15) 0%, transparent 60%),
            radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 60%),
            linear-gradient(45deg, transparent 30%, rgba(212, 175, 55, 0.05) 50%, transparent 70%) !important;

          background-color: transparent !important;
        }

        .uma-item:before {
          content: '';

          opacity: 0.7;

          background: linear-gradient(90deg, #d4af37, gold, #d4af37);

          height: 2px;

          position: absolute;

          top: 0;

          left: 0;

          right: 0;
        }

        
        .tarot-divination {
          color: #8b6914;
          background: #ffffffe6;
          border: 1px solid #d4af37;
          border-radius: 0.375rem;
          align-items: center;
          gap: 0.5rem;
          min-width: -moz-fit-content;
          min-width: fit-content;
          padding: 0.25rem 0.75rem;
          font-size: 0.8rem;
          font-weight: 600;
          display: flex;
          cursor: pointer;
          transition: all 0.3s;
          box-shadow: 0 1px 2px rgba(139, 69, 19, 0.3);
        }

        .tarot-divination:hover {
          background: #ffffff;
          transform: translateY(-1px);
          box-shadow: 0 4px 8px rgba(139, 69, 19, 0.3);
          border-color: #8b6914;
        }

        .tarot-modal-content {
          max-width: 800px;
          max-height: 90vh;
        }

        .tarot-info {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.1), rgba(139, 105, 20, 0.05));
          border: 1px solid rgba(139, 105, 20, 0.3);
          border-radius: 0.375rem;
          padding: 1rem;
          margin-bottom: 1rem;
          color: #8b4513;
        }

        .tarot-info p {
          margin: 0.25rem 0;
          font-weight: 600;
        }

        .spread-buttons {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1rem;
          margin-bottom: 1.5rem;
        }

        .spread-btn {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.1), rgba(139, 105, 20, 0.05));
          border: 1px solid rgba(139, 105, 20, 0.3);
          border-radius: 0.375rem;
          padding: 1rem;
          cursor: pointer;
          transition: all 0.3s;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 0.5rem;
          color: #8b4513;
          font-weight: 600;
          position: relative;
        }

        .spread-btn:hover:not(.disabled) {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.2), rgba(139, 105, 20, 0.1));
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(139, 69, 19, 0.3);
          border-color: rgba(139, 105, 20, 0.5);
        }

        .spread-btn.disabled {
          opacity: 0.5;
          cursor: not-allowed;
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.05), rgba(139, 105, 20, 0.02));
        }

        .spread-btn.advanced {
          background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
          border-color: rgba(34, 197, 94, 0.3);
          color: #22c55e;
        }

        .spread-btn.advanced:hover:not(.disabled) {
          background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
          box-shadow: 0 4px 8px rgba(34, 197, 94, 0.3);
          border-color: rgba(34, 197, 94, 0.5);
        }

        .spread-icon {
          font-size: 1.5rem;
        }

        .spread-name {
          font-size: 0.9rem;
          font-weight: 700;
        }

        .spread-cost {
          font-size: 0.8rem;
          color: #6b7280;
        }

        .spread-requirement {
          font-size: 0.7rem;
          color: #f59e0b;
          font-weight: 600;
        }

        .tarot-result {
          background: linear-gradient(135deg, #4c1d951a, #7c3aed1a);
          border: 1px solid #a855f7;
          border-radius: 0.5rem;
          padding: 1rem;
          margin-top: 1rem;
        }

        .tarot-cards {
          display: flex;
          flex-wrap: wrap;
          gap: 1rem;
          margin-bottom: 1rem;
        }

        .tarot-card {
          background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
          border: 2px solid #d1d5db;
          border-radius: 0.5rem;
          padding: 1rem;
          min-width: 120px;
          text-align: center;
          position: relative;
          cursor: pointer;
          transition: all 0.3s;
        }

        .tarot-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .tarot-card.reversed {
          transform: rotate(180deg);
        }

        .tarot-card-name {
          font-weight: 700;
          color: #374151;
          margin-bottom: 0.5rem;
        }

        .tarot-card-meaning {
          font-size: 0.8rem;
          color: #6b7280;
        }

        .tarot-interpretation {
          background: #f9fafb;
          border: 1px solid #e5e7eb;
          border-radius: 0.5rem;
          padding: 1rem;
          margin-bottom: 1rem;
          color: #374151;
        }

        .tarot-effects {
          background: linear-gradient(135deg, #fef3c7, #fde68a);
          border: 1px solid #f59e0b;
          border-radius: 0.5rem;
          padding: 1rem;
          color: #92400e;
        }

        .tarot-effects h4 {
          margin: 0 0 0.5rem 0;
          color: #92400e;
        }

        .tarot-effects ul {
          margin: 0;
          padding-left: 1.5rem;
        }

        .tarot-effects li {
          margin: 0.25rem 0;
        }

        
        .omikuji-container {
          background: linear-gradient(135deg, #fffaf0, #fef5e7);
          border: 2px solid #8b6914;
          border-radius: 10px;
          padding: 20px;
          margin-bottom: 15px;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
          color: #2d2d2d;
          text-align: center;
        }

        .omikuji-fortune {
          font-size: 2.5em;
          font-weight: bold;
          color: #8b6914;
          border-bottom: 2px dashed rgba(139, 105, 20, 0.3);
          padding-bottom: 10px;
          margin-bottom: 10px;
        }

        .omikuji-desc {
          font-style: italic;
          color: #8b6914;
          margin-bottom: 20px;
          font-size: 1.1rem;
        }

        .omikuji-items {
          list-style: none;
          padding: 0;
          text-align: left;
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px;
        }

        .omikuji-items li {
          background: rgba(139, 105, 20, 0.1);
          padding: 8px;
          border-radius: 6px;
          border: 1px solid rgba(139, 105, 20, 0.2);
        }

        .omikuji-items li strong {
          color: #8b6914;
        }

        .shrine-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .shrine-btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
          transform: none !important;
        }

        .uma-item::after {
          content: '';

          position: absolute;

          top: 0;

          left: 0;

          right: 0;

          bottom: 0;

          background:
            radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.08) 0%, transparent 50%),
            radial-gradient(circle at 70% 80%, rgba(212, 175, 55, 0.06) 0%, transparent 50%),
            linear-gradient(45deg, transparent 40%, rgba(255, 255, 255, 0.02) 50%, transparent 60%);

          pointer-events: none;

          z-index: 1;
        }

        .uma-item:hover {
          border-color: gold;

          box-shadow:
            0 4px 12px rgba(0, 0, 0, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.3),
            inset 0 -1px 0 rgba(0, 0, 0, 0.1);

          transform: translateY(-1px);
        }

        .uma-header {
          justify-content: space-between;

          align-items: center;

          margin-bottom: 0.5rem;

          display: flex;

          position: relative;

          z-index: 2;
        }

        .uma-info {
          align-items: center;

          gap: 0.5rem;

          display: flex;
        }

        .uma-name {
          color: #dc2626;

          text-shadow: 0 1px 2px #00000040;

          letter-spacing: 0.5px;

          font-size: 1rem;

          font-weight: 700;

          margin-bottom: 0.2rem;
        }

        .uma-text-info {
          display: flex;

          flex-direction: column;

          gap: 0.15rem;

          justify-content: center;
        }

        .uma-name {
          font-size: 1rem;

          font-weight: 600;

          line-height: 1.2;

          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .uma-status-text {
          font-size: 0.7rem;

          font-weight: 400;

          opacity: 0.9;

          transition: all 0.3s ease;

          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);

          border-radius: 0.3rem;

          padding: 0.1rem 0.3rem;

          background: rgba(255, 255, 255, 0.85);

          backdrop-filter: blur(3px);

          border: 1px solid rgba(212, 175, 55, 0.2);

          color: #ff69b4 !important;

          letter-spacing: 0.2px;

          box-shadow: 0 1px 3px rgba(212, 175, 55, 0.15);
        }

        
        .uma-status-text[style*='color: #059669'] {
          background: linear-gradient(135deg, rgba(5, 150, 105, 0.12), rgba(5, 150, 105, 0.08));

          border-color: rgba(5, 150, 105, 0.25);

          color: #059669 !important;

          box-shadow: 0 1px 3px rgba(5, 150, 105, 0.15);
        }

        .uma-status-text[style*='color: #8b0000'] {
          background: linear-gradient(135deg, rgba(139, 0, 0, 0.12), rgba(139, 0, 0, 0.08));

          border-color: rgba(139, 0, 0, 0.25);

          color: #8b0000 !important;

          box-shadow: 0 1px 3px rgba(139, 0, 0, 0.15);
        }

        .uma-status-text[style*='color: #6b7280'] {
          background: linear-gradient(135deg, rgba(107, 114, 128, 0.12), rgba(107, 114, 128, 0.08));

          border-color: rgba(107, 114, 128, 0.25);

          color: #6b7280 !important;

          box-shadow: 0 1px 3px rgba(107, 114, 128, 0.15);
        }

        .uma-status-text[style*='color: #f59e0b'] {
          background: linear-gradient(135deg, rgba(245, 158, 11, 0.12), rgba(245, 158, 11, 0.08));

          border-color: rgba(245, 158, 11, 0.25);

          color: #dc2626 !important;

          box-shadow: 0 1px 3px rgba(245, 158, 11, 0.15);
        }

        .uma-status-text[style*='color: #ef4444'] {
          background: linear-gradient(135deg, rgba(239, 68, 68, 0.12), rgba(239, 68, 68, 0.08));

          border-color: rgba(239, 68, 68, 0.25);

          color: #ef4444 !important;

          box-shadow: 0 1px 3px rgba(239, 68, 68, 0.15);
        }

        .uma-status-text[style*='color: #dc2626'] {
          background: linear-gradient(135deg, rgba(220, 38, 38, 0.15), rgba(185, 28, 28, 0.1));

          border-color: rgba(220, 38, 38, 0.3);

          color: #dc2626 !important;

          box-shadow: 0 1px 4px rgba(220, 38, 38, 0.2);
        }

        
        .uma-status-text:hover {
          transform: translateY(-0.5px);

          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);

          transition: all 0.3s ease;
        }

        .uma-avatar-container {
          position: relative;

          display: inline-block;
        }

        .uma-avatar {
          width: 3rem;

          height: 3rem;

          border-radius: 50%;

          object-fit: cover;

          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .avatar-decoration {
          position: absolute;

          top: -0.5rem;

          right: -0.5rem;

          display: flex;

          align-items: center;

          justify-content: center;

          width: 1.2rem;

          height: 1.2rem;

          font-size: 0.8rem;

          border-radius: 50%;

          background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));

          backdrop-filter: blur(5px);

          border: 1px solid rgba(255, 255, 255, 0.3);

          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);

          z-index: 10;

          animation: decorationFloat 2s ease-in-out infinite;
        }

        .uma-status-decoration {
          position: absolute;

          top: 0.5rem;

          right: 0.5rem;

          display: flex;

          align-items: center;

          justify-content: center;

          width: 1.5rem;

          height: 1.5rem;

          font-size: 1rem;

          border-radius: 50%;

          background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));

          backdrop-filter: blur(10px);

          border: 1px solid rgba(255, 255, 255, 0.3);

          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);

          transition: all 0.3s ease;

          animation: decorationFloat 3s ease-in-out infinite;

          z-index: 10;
        }

        .uma-status-decoration:hover {
          transform: scale(1.1) rotate(5deg);

          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        @keyframes decorationFloat {
          0%,
          100% {
            transform: translateY(0px);
          }

          50% {
            transform: translateY(-3px);
          }
        }

        
        .uma-avatar-container.normal .avatar-decoration {
          background: linear-gradient(135deg, rgba(5, 150, 105, 0.9), rgba(5, 150, 105, 0.7));

          border-color: rgba(5, 150, 105, 0.3);

          color: #059669;
        }

        .uma-avatar-container.possessed .avatar-decoration {
          background: linear-gradient(135deg, rgba(139, 0, 0, 0.9), rgba(139, 0, 0, 0.7));

          border-color: rgba(139, 0, 0, 0.3);

          color: #8b0000;

          animation:
            decorationFloat 2s ease-in-out infinite,
            possessedGlow 1.5s ease-in-out infinite alternate;
        }

        .uma-avatar-container.missing .avatar-decoration {
          background: linear-gradient(135deg, rgba(107, 114, 128, 0.9), rgba(107, 114, 128, 0.7));

          border-color: rgba(107, 114, 128, 0.3);

          color: #6b7280;
        }

        .uma-avatar-container.confused .avatar-decoration {
          background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(245, 158, 11, 0.7));

          border-color: rgba(245, 158, 11, 0.3);

          color: #f59e0b;

          animation:
            decorationFloat 1.5s ease-in-out infinite,
            confusedSpin 3s linear infinite;
        }

        .uma-avatar-container.alert .avatar-decoration {
          background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(239, 68, 68, 0.7));

          border-color: rgba(239, 68, 68, 0.3);

          color: #ef4444;

          animation:
            decorationFloat 1s ease-in-out infinite,
            alertPulse 0.8s ease-in-out infinite;
        }

        .uma-avatar-container.yandere .avatar-decoration {
          background: linear-gradient(135deg, rgba(220, 38, 38, 0.9), rgba(185, 28, 28, 0.8));

          border-color: rgba(220, 38, 38, 0.4);

          color: #dc2626;

          animation:
            decorationFloat 0.8s ease-in-out infinite,
            yandereShake 0.5s ease-in-out infinite;
        }

        
        .uma-status-decoration.normal {
          background: linear-gradient(135deg, rgba(5, 150, 105, 0.2), rgba(5, 150, 105, 0.1));

          border-color: rgba(5, 150, 105, 0.3);

          color: #059669;
        }

        .uma-status-decoration.possessed {
          background: linear-gradient(135deg, rgba(139, 0, 0, 0.2), rgba(139, 0, 0, 0.1));

          border-color: rgba(139, 0, 0, 0.3);

          color: #8b0000;

          animation:
            decorationFloat 2s ease-in-out infinite,
            possessedGlow 1.5s ease-in-out infinite alternate;
        }

        .uma-status-decoration.missing {
          background: linear-gradient(135deg, rgba(107, 114, 128, 0.2), rgba(107, 114, 128, 0.1));

          border-color: rgba(107, 114, 128, 0.3);

          color: #6b7280;
        }

        .uma-status-decoration.confused {
          background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));

          border-color: rgba(245, 158, 11, 0.3);

          color: #f59e0b;

          animation:
            decorationFloat 1.5s ease-in-out infinite,
            confusedSpin 3s linear infinite;
        }

        .uma-status-decoration.alert {
          background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));

          border-color: rgba(239, 68, 68, 0.3);

          color: #ef4444;

          animation:
            decorationFloat 1s ease-in-out infinite,
            alertPulse 0.8s ease-in-out infinite;
        }

        .uma-status-decoration.yandere {
          background: linear-gradient(135deg, rgba(220, 38, 38, 0.3), rgba(185, 28, 28, 0.2));

          border-color: rgba(220, 38, 38, 0.4);

          color: #dc2626;

          animation:
            decorationFloat 0.8s ease-in-out infinite,
            yandereShake 0.5s ease-in-out infinite;
        }

        
        @keyframes possessedGlow {
          0%,
          100% {
            box-shadow: 0 2px 8px rgba(139, 0, 0, 0.3);
          }

          50% {
            box-shadow: 0 2px 16px rgba(139, 0, 0, 0.6);
          }
        }

        @keyframes confusedSpin {
          0% {
            transform: translateY(0px) rotate(0deg);
          }

          50% {
            transform: translateY(-3px) rotate(180deg);
          }

          100% {
            transform: translateY(0px) rotate(360deg);
          }
        }

        @keyframes alertPulse {
          0%,
          100% {
            transform: scale(1);
          }

          50% {
            transform: scale(1.1);
          }
        }

        @keyframes yandereShake {
          0%,
          100% {
            transform: translateX(0px);
          }

          25% {
            transform: translateX(-2px);
          }

          75% {
            transform: translateX(2px);
          }
        }

        .uma-status-badge {
          text-transform: uppercase;

          letter-spacing: 0.5px;

          border-radius: 0.75rem;

          padding: 0.25rem 0.5rem;

          font-size: 0.7rem;

          font-weight: 600;

          box-shadow: 0 1px 3px #0003;

          transition: all 0.3s ease;
        }

        .uma-status {
          text-transform: uppercase;

          letter-spacing: 0.5px;

          border-radius: 0.75rem;

          padding: 0.25rem 0.5rem;

          font-size: 0.7rem;

          font-weight: 600;

          box-shadow: 0 1px 3px #0003;
        }

        .uma-status-badge.normal {
          color: #fff;

          background: linear-gradient(135deg, #059669cc, #05966999);

          border: 1px solid #0596694d;
        }

        .uma-status-badge.possessed {
          color: #fff;

          background: linear-gradient(135deg, #8b0000cc, #8b000099);

          border: 1px solid #8b00004d;
        }

        .uma-status-badge.missing {
          color: #fff;

          background: linear-gradient(135deg, #6b7280cc, #6b728099);

          border: 1px solid #6b72804d;
        }

        .uma-status-badge.confused {
          color: #fff;

          background: linear-gradient(135deg, #f59e0bcc, #f59e0b99);

          border: 1px solid #f59e0b4d;
        }

        .uma-status-badge.alert {
          color: #fff;

          background: linear-gradient(135deg, #ef4444cc, #ef444499);

          border: 1px solid #ef44444d;
        }

        .uma-status-badge.yandere {
          color: #fff;

          text-shadow: 0 1px 2px #00000080;

          background: linear-gradient(135deg, #dc2626e6, #b91c1ccc);

          border: 2px solid #dc262680;

          font-weight: 700;

          animation: 2s ease-in-out infinite yanderePulse;

          box-shadow: 0 0 10px #dc262666;
        }

        @keyframes yanderePulse {
          0%,
          to {
            box-shadow: 0 0 10px #dc262666;
          }

          50% {
            box-shadow:
              0 0 20px #dc2626b3,
              0 0 30px #dc26264d;
          }
        }

        @keyframes bloodGlow {
          0% {
            transform: rotate(0);

            box-shadow:
              0 0 20px #f00c,
              0 0 40px #f006,
              0 0 60px #f003;
          }

          25% {
            transform: rotate(90deg);

            box-shadow:
              0 0 25px #ff0000e6,
              0 0 50px #ff000080,
              0 0 75px #ff00004d;
          }

          50% {
            transform: rotate(180deg);

            box-shadow:
              0 0 20px #f00c,
              0 0 40px #f006,
              0 0 60px #f003;
          }

          75% {
            transform: rotate(270deg);

            box-shadow:
              0 0 25px #ff0000e6,
              0 0 50px #ff000080,
              0 0 75px #ff00004d;
          }

          to {
            transform: rotate(360deg);

            box-shadow:
              0 0 20px #f00c,
              0 0 40px #f006,
              0 0 60px #f003;
          }
        }

        .uma-status.worried {
          color: #fff;

          background: linear-gradient(135deg, #a855f7cc, #a855f799);

          border: 1px solid #a855f74d;
        }

        .uma-status.protect {
          color: #fff;

          background: linear-gradient(135deg, #22c55ecc, #22c55e99);

          border: 1px solid #22c55e4d;
        }

        .uma-desc {
          color: #654321;

          text-shadow: 0 1px 1px #ffffff80;

          margin: 0.5rem 0;

          font-size: 0.8rem;

          font-style: italic;

          line-height: 1.4;

          position: relative;

          z-index: 2;
        }

        .uma-hearts {
          justify-content: center;

          gap: 0.25rem;

          margin-top: 0.5rem;

          display: flex;

          position: relative;

          z-index: 2;
        }

        .heart {
          color: #dc2626;

          text-shadow: 0 2px 4px #dc26264d;

          font-size: 1rem;

          animation: 2s ease-in-out infinite heartBeat;

          display: inline-block;
        }

        .heart:nth-child(2) {
          animation-delay: 0.2s;
        }

        .heart:nth-child(3) {
          animation-delay: 0.4s;
        }

        .heart:nth-child(4) {
          animation-delay: 0.6s;
        }

        .heart:nth-child(5) {
          animation-delay: 0.8s;
        }

        @keyframes heartBeat {
          0%,
          to {
            transform: scale(1);
          }

          50% {
            transform: scale(1.1);
          }
        }

        .twisted-love-accent {
          color: #8b0000;

          text-shadow: 0 0 3px #8b000066;

          font-weight: 700;
        }

        .horror-glow {
          color: #8b0000;

          text-shadow: 0 0 4px #8b000099;
        }

        .typewriter-cursor {
          color: #8b0000;

          animation: 1.2s infinite blink;
        }

        @keyframes blink {
          0%,
          50% {
            opacity: 1;
          }

          51%,
          to {
            opacity: 0;
          }
        }

        @keyframes subtle-pulse {
          0%,
          to {
            opacity: 0.8;

            transform: scale(1);
          }

          50% {
            opacity: 1;

            transform: scale(1.02);
          }
        }

        .subtle-hover {
          transition: all 0.2s;
        }

        .subtle-hover:hover {
          transform: translateY(-1px);

          box-shadow: 0 2px 4px #0000004d;
        }

        .inventory-item {
          background: #ffffffb3;

          border: 1px solid #d4af37;

          border-radius: 0.375rem;

          margin-bottom: 0.5rem;

          padding: 0.5rem;

          box-shadow: 0 2px 4px #0000001a;
        }

        .item-header {
          cursor: pointer;

          z-index: 10;

          -webkit-user-select: none;

          user-select: none;

          justify-content: space-between;

          align-items: center;

          padding: 0.25rem 0;

          display: flex;

          position: relative;
        }

        .item-header:hover {
          background-color: #d4af371a;

          border-radius: 0.25rem;
        }

        .item-toggle {
          color: #8b6914;

          font-size: 0.75rem;

          transition: transform 0.2s;
        }

        .item-name {
          color: #8b6914;

          flex: 1;

          font-size: 0.875rem;

          font-weight: 600;
        }

        .item-details {
          border-top: 1px solid #d4af374d;

          margin-top: 0.5rem;

          padding-top: 0.5rem;
        }

        .item-detail-popup {
          z-index: 100;

          background: #fffffff2;

          border: 1px solid #d4af37;

          border-radius: 0.375rem;

          min-width: 180px;

          max-width: 250px;

          padding: 0.75rem;

          font-size: 0.75rem;

          position: absolute;

          top: -10px;

          left: 0;

          box-shadow: 0 2px 8px #0003;
        }

        .skill-detail-popup {
          z-index: 100;

          background: #fffffff2;

          border: 1px solid #805ad5;

          border-radius: 0.375rem;

          min-width: 150px;

          max-width: 200px;

          padding: 0.5rem;

          font-size: 0.75rem;

          position: absolute;

          top: -10px;

          left: 0;

          box-shadow: 0 2px 8px #0003;
        }

        .skill-popup:after {
          content: '';

          border-top: 5px solid #805ad5;

          border-left: 5px solid #0000;

          border-right: 5px solid #0000;

          width: 0;

          height: 0;

          position: absolute;

          top: 100%;

          left: 1rem;
        }

        .skill-desc {
          color: #654321;

          text-shadow: 0 1px 1px #ffffff80;

          margin-bottom: 0.5rem;

          font-size: 0.8rem;

          font-style: italic;

          line-height: 1.4;
        }

        .skill-header {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 12px;
          padding-bottom: 8px;
          border-bottom: 1px solid rgba(139, 69, 19, 0.2);
        }

        .skill-title {
          font-size: 16px;
          font-weight: bold;
          color: #8b4513;
        }

        .skill-use-btn {
          background: linear-gradient(135deg, #805ad5, #6b46c1);

          color: white;

          border: none;

          border-radius: 0.25rem;

          padding: 0.25rem 0.5rem;

          font-size: 0.7rem;

          cursor: pointer;

          margin: 0.25rem 0.25rem 0 0;

          transition: all 0.2s;
        }

        .skill-use-btn:hover {
          background: linear-gradient(135deg, #6b46c1, #553c9a);

          transform: translateY(-1px);
        }

        .item-popup.show {
          display: block;
        }

        .item-popup:after {
          content: '';

          border-top: 5px solid #d4af37;

          border-left: 5px solid #0000;

          border-right: 5px solid #0000;

          width: 0;

          height: 0;

          position: absolute;

          top: 100%;

          left: 1rem;
        }

        .item-desc {
          color: #654321;

          text-shadow: 0 1px 1px #ffffff80;

          margin-bottom: 0.75rem;

          font-size: 0.8rem;

          font-style: italic;

          line-height: 1.5;
        }

        .item-effect {
          color: #059669;

          text-shadow: 0 1px 1px #ffffff80;

          margin-bottom: 0.5rem;

          font-size: 0.8rem;

          font-weight: 600;
        }

        .item-rarity {
          border-radius: 0.375rem;

          padding: 0.25rem 0.5rem;

          font-size: 0.75rem;

          font-weight: 600;

          display: inline-block;

          text-align: center;
        }

        

        .rarity-Ph·ªï Th√¥ng {
          color: #696969;

          background: linear-gradient(135deg, #f5f5f5, #e0e0e0);

          border: 2px solid #b0b0b0;

          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .rarity-Hi·∫øm {
          color: #2563eb;

          background: linear-gradient(135deg, #dbeafe, #bfdbfe);

          border: 2px solid #3b82f6;

          box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);

          text-shadow: 0 1px 2px rgba(59, 130, 246, 0.2);
        }

        .rarity-S·ª≠ Thi {
          color: #7c3aed;

          background: linear-gradient(135deg, #ede9fe, #ddd6fe);

          border: 2px solid #8b5cf6;

          box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);

          text-shadow: 0 1px 2px rgba(139, 92, 246, 0.2);
        }

        .rarity-Truy·ªÅn Thuy·∫øt {
          color: #d97706;

          background: linear-gradient(135deg, #fef3c7, #fde68a);

          border: 2px solid #f59e0b;

          box-shadow: 0 2px 12px rgba(245, 158, 11, 0.4);

          text-shadow: 0 1px 3px rgba(217, 119, 6, 0.3);

          animation: legendary-glow 2s ease-in-out infinite alternate;
        }

        @keyframes legendary-glow {
          from {
            box-shadow: 0 2px 12px rgba(245, 158, 11, 0.4);
          }

          to {
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.6);
          }
        }

        .rules-section-header {
          cursor: pointer;

          border-bottom: 1px solid #d4af37;

          justify-content: space-between;

          align-items: center;

          margin: 0.75rem 0 0.5rem;

          padding: 0.5rem 0;

          display: flex;
        }

        .rules-section-header:hover {
          background-color: #d4af371a;

          border-radius: 0.25rem;
        }

        .rules-section-title {
          color: #8b6914;

          font-size: 0.875rem;

          font-weight: 600;
        }

        .rules-toggle {
          color: #8b6914;

          font-size: 0.75rem;

          transition: transform 0.2s;
        }

        .rules-content {
          margin-top: 0.5rem;
        }

        .currency-section {
          color: #8b6914;

          background: #ffffffe6;

          border: 1px solid #d4af37;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;
        }

        .bottom-panel {
          white-space: nowrap;

          background-color: #fdfbf7;

          border-top: 2px solid #8b6914;

          flex-wrap: nowrap;

          grid-area: 3/1/4/4;

          justify-content: space-between;

          align-items: center;

          gap: 1rem;

          height: 40px;

          padding: 0.5rem;

          display: flex;

          overflow: hidden;
        }

        .bottom-group {
          flex-shrink: 0;

          align-items: center;

          gap: 0.5rem;

          display: flex;
        }

        .festival-notice {
          color: #b8860b;

          background: linear-gradient(135deg, #ffd7001a, #ffc1071a);

          border: 1px solid gold;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;
        }

        .rules-countdown {
          color: #dc2626;

          background: linear-gradient(135deg, #8b00001a, #dc26261a);

          border: 1px solid #dc2626;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;
        }

        .reply-timer {
          color: #16a34a;

          background: linear-gradient(135deg, #22c55e1a, #16a34a1a);

          border: 1px solid #16a34a;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          transition: all 0.3s;

          display: flex;
        }

        .reply-timer.warning {
          color: #d97706;

          background: linear-gradient(135deg, #f59e0b1a, #d977061a);

          border-color: #d97706;
        }

        .reply-timer.danger {
          color: #dc2626;

          background: linear-gradient(135deg, #ef44441a, #dc26261a);

          border-color: #dc2626;

          animation: 1s ease-in-out infinite pulse;
        }

        @keyframes pulse {
          0%,
          to {
            opacity: 1;
          }

          50% {
            opacity: 0.7;
          }
        }

        .gacha-coin {
          color: #b8860b;

          background: linear-gradient(135deg, #b8860b1a, #ffd7001a);

          border: 1px solid #b8860b;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;
        }

        
        .input-toolbar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.5rem 0;
          margin-bottom: 0.5rem;
          border-bottom: 1px solid rgba(139, 105, 20, 0.2);
        }

        .toolbar-left {
          display: flex;
          gap: 0.5rem;
        }

        .toolbar-right {
          display: flex;
          align-items: center;
        }

        .toolbar-button {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.1), rgba(139, 105, 20, 0.05));
          border: 1px solid rgba(139, 105, 20, 0.3);
          border-radius: 0.375rem;
          padding: 0.5rem 0.75rem;
          color: #8b4513;
          cursor: pointer;
          transition: all 0.2s;
          display: flex;
          align-items: center;
          gap: 0.375rem;
          font-size: 0.8rem;
          font-weight: 600;
        }

        .toolbar-button:hover {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.2), rgba(139, 105, 20, 0.1));
          transform: translateY(-1px);
          box-shadow: 0 2px 4px rgba(139, 69, 19, 0.2);
          border-color: rgba(139, 105, 20, 0.5);
        }

        .toolbar-button .icon {
          width: 16px;
          height: 16px;
        }

        .streaming-toggle {
          display: flex;
          align-items: center;
          gap: 0.25rem;
          cursor: pointer;
          color: #8b4513;
          font-size: 0.8rem;
          font-weight: 600;
        }

        .streaming-toggle input[type='checkbox'] {
          width: 16px;
          height: 16px;
          accent-color: #8b4513;
          cursor: pointer;
        }

        .toggle-label {
          user-select: none;
        }

        
        .bottom-button {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.1), rgba(139, 105, 20, 0.05));
          border: 1px solid rgba(139, 105, 20, 0.3);
          border-radius: 0.375rem;
          padding: 0.375rem;
          color: #8b4513;
          cursor: pointer;
          transition: all 0.2s;
          display: flex;
          align-items: center;
          justify-content: center;
          width: 32px;
          height: 32px;
        }

        .bottom-button:hover {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.2), rgba(139, 105, 20, 0.1));
          transform: translateY(-1px);
          box-shadow: 0 2px 4px rgba(139, 69, 19, 0.2);
          border-color: rgba(139, 105, 20, 0.5);
        }

        .bottom-button .icon {
          width: 16px;
          height: 16px;
        }

        
        .currency-row {
          display: flex;
          gap: 1rem;
          margin-top: 0.5rem;
          padding-top: 0.5rem;
          border-top: 1px solid rgba(139, 105, 20, 0.2);
        }

        .currency-item {
          flex: 1;
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.04));
          border: 1px solid rgba(139, 105, 20, 0.2);
          border-radius: 0.375rem;
          padding: 0.5rem;
          margin-bottom: 0;
        }

        .currency-item .label {
          color: #8b6914;
          font-weight: 600;
        }

        .currency-item .value {
          color: #8b4513;
          font-weight: 700;
        }

        .hot-spring-ticket {
          color: #059669;

          background: linear-gradient(135deg, #0596691a, #10b9811a);

          border: 1px solid #059669;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;
        }

        .save-button,
        .view-rules-button {
          color: #2d2d2d;

          cursor: pointer;

          background: linear-gradient(135deg, #f5f0e8, #e8d5c4);

          border: 2px solid #8b4513;

          border-radius: 0.3rem;

          padding: 0.4rem 0.8rem;

          font-size: 0.75rem;

          font-weight: 600;

          transition: all 0.3s;

          position: relative;

          overflow: hidden;
        }

        .save-button:before,
        .view-rules-button:before {
          content: '';

          opacity: 0;

          border-radius: inherit;

          background: linear-gradient(135deg, #8b00001a, #0000);

          transition: opacity 0.3s;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;
        }

        .save-button:after,
        .view-rules-button:after {
          content: '';

          background: radial-gradient(circle, #8b00004d 0%, #0000 70%);

          border-radius: 50%;

          width: 0;

          height: 0;

          transition: all 0.4s;

          position: absolute;

          top: 50%;

          left: 50%;

          transform: translate(-50%, -50%);
        }

        .save-button:hover,
        .view-rules-button:hover {
          transform: translateY(-2px);

          box-shadow: 0 4px 12px #8b00004d;
        }

        .save-button:hover:before,
        .view-rules-button:hover:before {
          opacity: 1;
        }

        .save-button:hover:after,
        .view-rules-button:hover:after {
          width: 200px;

          height: 200px;
        }

        .save-button:active,
        .view-rules-button:active {
          transform: translateY(0);

          box-shadow: 0 2px 8px #8b000066;
        }

        .save-button:active:after,
        .view-rules-button:active:after {
          background: radial-gradient(circle, #8b000080 0%, #0000 60%);

          width: 300px;

          height: 300px;
        }
      }

      @property --tw-rotate-x {
        syntax: '*';

        inherits: false;
      }

      @property --tw-rotate-y {
        syntax: '*';

        inherits: false;
      }

      @property --tw-rotate-z {
        syntax: '*';

        inherits: false;
      }

      @property --tw-skew-x {
        syntax: '*';

        inherits: false;
      }

      @property --tw-skew-y {
        syntax: '*';

        inherits: false;
      }

      @property --tw-border-style {
        syntax: '*';

        inherits: false;

        initial-value: solid;
      }

      @property --tw-shadow {
        syntax: '*';

        inherits: false;

        initial-value: 0 0 #0000;
      }

      @property --tw-shadow-color {
        syntax: '*';

        inherits: false;
      }

      @property --tw-shadow-alpha {
        syntax: '<percentage>';

        inherits: false;

        initial-value: 100%;
      }

      @property --tw-inset-shadow {
        syntax: '*';

        inherits: false;

        initial-value: 0 0 #0000;
      }

      @property --tw-inset-shadow-color {
        syntax: '*';

        inherits: false;
      }

      @property --tw-inset-shadow-alpha {
        syntax: '<percentage>';

        inherits: false;

        initial-value: 100%;
      }

      @property --tw-ring-color {
        syntax: '*';

        inherits: false;
      }

      @property --tw-ring-shadow {
        syntax: '*';

        inherits: false;

        initial-value: 0 0 #0000;
      }

      @property --tw-inset-ring-color {
        syntax: '*';

        inherits: false;
      }

      @property --tw-inset-ring-shadow {
        syntax: '*';

        inherits: false;

        initial-value: 0 0 #0000;
      }

      @property --tw-ring-inset {
        syntax: '*';

        inherits: false;
      }

      @property --tw-ring-offset-width {
        syntax: '<length>';

        inherits: false;

        initial-value: 0;
      }

      @property --tw-ring-offset-color {
        syntax: '*';

        inherits: false;

        initial-value: #fff;
      }

      @property --tw-ring-offset-shadow {
        syntax: '*';

        inherits: false;

        initial-value: 0 0 #0000;
      }

      @property --tw-outline-style {
        syntax: '*';

        inherits: false;

        initial-value: solid;
      }

      @property --tw-backdrop-blur {
        syntax: '*';

        inherits: false;
      }

      @property --tw-backdrop-brightness {
        syntax: '*';

        inherits: false;
      }

      @property --tw-backdrop-contrast {
        syntax: '*';

        inherits: false;
      }

      @property --tw-backdrop-grayscale {
        syntax: '*';

        inherits: false;
      }

      @property --tw-backdrop-hue-rotate {
        syntax: '*';

        inherits: false;
      }

      @property --tw-backdrop-invert {
        syntax: '*';

        inherits: false;
      }

      @property --tw-backdrop-opacity {
        syntax: '*';

        inherits: false;
      }

      @property --tw-backdrop-saturate {
        syntax: '*';

        inherits: false;
      }

      
      body,
      .story-text,
      .story-content {
        color: #000000 !important;
      }

      .dialogue-text {
        color: #000000 !important;
      }

      .psychology-text {
        color: #000000 !important;
      }

      .scenery-text {
        color: #000000 !important;
      }

      
      .variable-update-decoration {
        position: relative;
        overflow: hidden;
      }

      
      .variable-update-decoration.updating {
        animation: variableUpdating 1.5s ease-in-out infinite;
      }

      .variable-update-decoration.updating::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(139, 105, 20, 0.2), transparent);
        animation: shimmer 2s ease-in-out infinite;
      }

      .variable-update-decoration.updating svg {
        animation: rotateIcon 2s linear infinite;
      }

      .variable-update-text {
        color: #8b4513 !important;
        font-style: italic;
        text-shadow: 0 1px 2px rgba(139, 105, 20, 0.1);
      }

      .variable-update-decoration.updating .variable-update-text {
        animation: pulseText 1.5s ease-in-out infinite;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes variableUpdating {
        0%,
        100% {
          border-left-color: rgba(139, 105, 20, 0.5);
          box-shadow: 0 1px 3px rgba(139, 105, 20, 0.1);
        }
        50% {
          border-left-color: rgba(139, 105, 20, 0.8);
          box-shadow: 0 2px 8px rgba(139, 105, 20, 0.3);
        }
      }

      @keyframes shimmer {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      @keyframes rotateIcon {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes pulseText {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      @property --tw-backdrop-sepia {
        syntax: '*';

        inherits: false;
      }

      @keyframes shimmer {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }
    </style>
  </head>

  <body>
    <div class="connected-panels">

      <div class="parchment-page left-panel">
        <div class="panel-content">
          <div class="profile-journey-container">
            <div class="profile-section">
              <div class="section-header">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" />
                </svg>

                <h3>H·ªì s∆° c√° nh√¢n</h3>

                <button class="expand-btn" id="profile-expand">
                  <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                  </svg>
                </button>
              </div>

              <div class="profile-basic" id="profile-basic" style="display: none">
                <div class="profile-link">Nh·∫•p ƒë·ªÉ xem h·ªì s∆° ƒë·∫ßy ƒë·ªß...</div>
              </div>

              <div class="profile-detail" id="profile-detail" style="display: block">
                <div class="detail-card">
                  <div
                    class="detail-item"
                    style="
                      display: flex;
                      align-items: center;
                      gap: 15px;
                      margin-bottom: 15px;
                      padding-bottom: 15px;
                      border-bottom: 1px solid rgba(139, 105, 20, 0.2);
                    "
                  >
                    <div style="flex-shrink: 0">
                      <img
                        id="profile-avatar"
                        src="https://i.ibb.co/0VzNGcfs/116.gif"
                        alt="Avatar"
                        style="
                          width: 80px;
                          height: 80px;
                          border-radius: 8px;
                          object-fit: cover;
                          border: 2px solid rgba(139, 105, 20, 0.3);
                          cursor: pointer;
                          transition: all 0.2s;
                        "
                        title="Nh·∫•p ƒë·ªÉ ƒë·ªïi Avatar"
                      />
                    </div>
                    <div style="flex: 1">
                      <div style="font-size: 0.9em; color: #8b6914; margin-bottom: 5px">Avatar</div>
                      <div style="font-size: 0.8em; color: #666">Nh·∫•p v√†o Avatar ƒë·ªÉ thay ƒë·ªïi</div>
                    </div>
                  </div>

                  <div id="profile-current-song" class="profile-current-song" style="display: none">
                    <span class="label">üéµ ƒêang ph√°t:</span>
                    <span class="value" id="profile-song-name">-</span>
                  </div>

                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px">
                    <div>
                      <div class="detail-item">
                        <span class="label">Th√¢n ph·∫≠n:</span>
                        <span class="value">Hu·∫•n luy·ªán vi√™n</span>
                      </div>
                      <div class="detail-item">
                        <span class="label">Xu·∫•t th√¢n:</span>
                        <span class="value" id="trainer-background">Kh√¥ng</span>
                      </div>
                      <div class="detail-item">
                        <span class="label">Tr·∫°ng th√°i:</span>
                        <span class="value" id="trainer-status">B√¨nh th∆∞·ªùng</span>
                      </div>
                      <div class="detail-item">
                        <span class="label">Danh hi·ªáu:</span>
                        <span
                          class="value"
                          id="trainer-title"
                          style="color: #b8860b; font-weight: 500; display: inline-block"
                          >B∆∞·ªõc ch√¢n ƒë·∫ßu ƒë·ªùi</span
                        >
                      </div>
                      <div class="detail-item">
                        <span class="label" style="font-weight: 600; color: #8b4513">Xu Gacha:</span>
                        <span class="value" id="profile-gacha-coin">0</span>
                      </div>
                      <div class="detail-item">
                        <span class="label" style="font-weight: 600; color: #8b4513">ƒêi·ªÉm th·ª±c nghi·ªám:</span>
                        <span class="value" id="profile-currency-value">0</span>
                      </div>
                    </div>

                    <div>
                      <div class="detail-item" style="margin-bottom: 0.25rem">
                        <span class="label">L√Ω tr√≠:</span>
                        <span class="value" id="sanity-value">0</span>
                      </div>
                      <div
                        class="progress-bar"
                        style="
                          height: 8px;
                          margin-bottom: 0.5rem;
                          background: rgba(139, 105, 20, 0.1);
                          border-radius: 4px;
                          overflow: hidden;
                        "
                      >
                        <div
                          class="progress-fill"
                          id="sanity-bar"
                          style="
                            width: 0%;
                            height: 100%;
                            background: linear-gradient(90deg, #3b82f6, #2563eb);
                            border-radius: 4px;
                            transition: width 0.3s ease;
                          "
                        ></div>
                      </div>
                      <div class="detail-item" style="margin-bottom: 0.25rem">
                        <span class="label">Th·ªÉ l·ª±c:</span>
                        <span class="value" id="stamina-value">0</span>
                      </div>
                      <div
                        class="progress-bar"
                        style="
                          height: 8px;
                          margin-bottom: 0.5rem;
                          background: rgba(139, 105, 20, 0.1);
                          border-radius: 4px;
                          overflow: hidden;
                        "
                      >
                        <div
                          class="progress-fill"
                          id="stamina-bar"
                          style="
                            width: 0%;
                            height: 100%;
                            background: linear-gradient(90deg, #10b981, #059669);
                            border-radius: 4px;
                            transition: width 0.3s ease;
                          "
                        ></div>
                      </div>
                      <div class="detail-item" style="margin-bottom: 0.25rem">
                        <span class="label">T·ª± ch·ªß:</span>
                        <span class="value" id="self-control-value">0</span>
                      </div>
                      <div
                        class="progress-bar"
                        style="
                          height: 8px;
                          margin-bottom: 0.5rem;
                          background: rgba(139, 105, 20, 0.1);
                          border-radius: 4px;
                          overflow: hidden;
                        "
                      >
                        <div
                          class="progress-fill"
                          id="self-control-bar"
                          style="
                            width: 0%;
                            height: 100%;
                            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
                            border-radius: 4px;
                            transition: width 0.3s ease;
                          "
                        ></div>
                      </div>
                      <div
                        class="detail-item"
                        style="margin-bottom: 0.5rem; display: flex; gap: 0.5rem; align-items: center"
                      >
                        <span class="label">L·ª±c:</span>
                        <span class="value" id="power-value" style="color: #dc2626; font-weight: 600">0</span>
                        <span class="label" style="margin-left: 0.75rem">K·ªπ:</span>
                        <span class="value" id="skill-value" style="color: #9333ea; font-weight: 600">0</span>
                      </div>
                    </div>
                  </div>

                  <div style="grid-column: 1 / -1; margin-top: 0.5rem">
                    <div class="detail-item" style="margin-bottom: 0.25rem">
                      <span class="label">May m·∫Øn:</span>
                      <span class="value" id="luck-value" style="color: #ff8c00; font-weight: 600">0</span>
                    </div>
                    <div
                      class="progress-bar"
                      style="
                        height: 8px;
                        margin-bottom: 0;
                        background: rgba(139, 105, 20, 0.1);
                        border-radius: 4px;
                        overflow: hidden;
                      "
                    >
                      <div
                        class="progress-fill"
                        id="luck-bar"
                        style="
                          width: 0%;
                          height: 100%;
                          background: linear-gradient(90deg, #ff8c00, #ffa500);
                          border-radius: 4px;
                          transition: width 0.3s ease;
                        "
                      ></div>
                    </div>
                  </div>

                  <div
                    style="
                      display: flex;
                      gap: 8px;
                      align-items: center;
                      margin-top: 0.5rem;
                      padding-top: 0.5rem;
                      border-top: 1px solid rgba(139, 105, 20, 0.2);
                    "
                  >
                    <button
                      id="view-rules-btn"
                      class="profile-icon-btn"
                      title="Xem quy t·∫Øc"
                      style="
                        background: linear-gradient(135deg, rgba(139, 69, 19, 0.15), rgba(139, 69, 19, 0.08));
                        border: 1px solid rgba(139, 69, 19, 0.3);
                        border-radius: 6px;
                        padding: 6px;
                        color: #8b4513;
                        cursor: pointer;
                        transition: all 0.2s;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 32px;
                        height: 32px;
                        flex-shrink: 0;
                      "
                      onmouseover="this.style.background='linear-gradient(135deg, rgba(139, 69, 19, 0.25), rgba(139, 69, 19, 0.15)'; this.style.transform='translateY(-1px)'"
                      onmouseout="this.style.background='linear-gradient(135deg, rgba(139, 69, 19, 0.15), rgba(139, 69, 19, 0.08)'; this.style.transform='translateY(0)'"
                    >
                      <svg class="icon" fill="currentColor" viewBox="0 0 20 20" style="width: 18px; height: 18px">
                        <path
                          d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"
                        />
                      </svg>
                    </button>
                    <button
                      id="manage-talents-btn-inner"
                      class="profile-icon-btn"
                      title="Qu·∫£n l√Ω Thi√™n ph√∫"
                      style="
                        background: linear-gradient(135deg, rgba(139, 69, 19, 0.15), rgba(139, 69, 19, 0.08));
                        border: 1px solid rgba(139, 69, 19, 0.3);
                        border-radius: 6px;
                        padding: 6px;
                        color: #8b4513;
                        cursor: pointer;
                        transition: all 0.2s;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 32px;
                        height: 32px;
                        flex-shrink: 0;
                      "
                      onmouseover="this.style.background='linear-gradient(135deg, rgba(139, 69, 19, 0.25), rgba(139, 69, 19, 0.15)'; this.style.transform='translateY(-1px)'"
                      onmouseout="this.style.background='linear-gradient(135deg, rgba(139, 69, 19, 0.15), rgba(139, 69, 19, 0.08)'; this.style.transform='translateY(0)'"
                    >
                      <svg class="icon" fill="currentColor" viewBox="0 0 20 20" style="width: 18px; height: 18px">
                        <path
                          d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
                        />
                      </svg>
                    </button>
                    <button
                      id="achievements-btn-inner"
                      class="profile-icon-btn"
                      title="Th√†nh t·ª±u"
                      onclick="if(window.achievementSystem) window.achievementSystem.openAchievementModal()"
                      style="
                        background: linear-gradient(135deg, rgba(139, 69, 19, 0.15), rgba(139, 69, 19, 0.08));
                        border: 1px solid rgba(139, 69, 19, 0.3);
                        border-radius: 6px;
                        padding: 6px;
                        color: #8b4513;
                        cursor: pointer;
                        transition: all 0.2s;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 32px;
                        height: 32px;
                        flex-shrink: 0;
                      "
                      onmouseover="this.style.background='linear-gradient(135deg, rgba(139, 69, 19, 0.25), rgba(139, 69, 19, 0.15)'; this.style.transform='translateY(-1px)'"
                      onmouseout="this.style.background='linear-gradient(135deg, rgba(139, 69, 19, 0.15), rgba(139, 69, 19, 0.08)'; this.style.transform='translateY(0)'"
                    >
                      <svg class="icon" fill="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px">
                        <path
                          d="M12 2C8.13 2 5 5.13 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.87-3.13-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6C7.8 12.16 7 10.63 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"
                        />
                        <path d="M8 20h8v-2H8v2z" />
                      </svg>
                    </button>
                    <div class="detail-item" style="margin-left: auto; display: flex; align-items: center; gap: 4px">
                      <span class="label" style="font-weight: 600; color: #8b4513">S·ªë ng√†y ·ªü tr∆∞·ªùng:</span>
                      <span class="value" id="days-in-park">0 ng√†y</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div style="margin-top: 0.75rem; margin-bottom: 0.75rem">
              <div style="text-align: center; margin-bottom: 10px">
                <div style="font-size: 0.9em; color: #8b6914; margin-bottom: 8px; font-weight: 600">ƒê·ªãa ƒëi·ªÉm hi·ªán t·∫°i</div>
                <div
                  id="location-image-display"
                  style="
                    width: 100%;
                    max-height: 200px;
                    border-radius: 8px;
                    overflow: hidden;
                    border: 2px solid rgba(139, 105, 20, 0.2);
                    background: rgba(139, 105, 20, 0.05);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                  "
                >
                  <img
                    id="location-image"
                    src=""
                    alt="·∫¢nh ƒë·ªãa ƒëi·ªÉm"
                    style="width: 100%; height: auto; max-height: 200px; object-fit: cover; display: none"
                    loading="lazy"
                  />
                  <div
                    id="location-image-placeholder"
                    style="color: #8b6914; font-size: 0.85em; padding: 20px; text-align: center"
                  >
                    T·∫°m kh√¥ng c√≥ ·∫£nh ƒë·ªãa ƒëi·ªÉm
                  </div>
                </div>
              </div>
            </div>

            <div class="task-list-section" style="margin-top: 0.75rem">
              <div class="section-header">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20" style="color: #8b6914">
                  <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                  <path
                    fill-rule="evenodd"
                    d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z"
                    clip-rule="evenodd"
                  />
                </svg>
                <h3>Danh s√°ch nhi·ªám v·ª•</h3>
                <button class="expand-btn" id="task-list-expand" title="M·ªü r·ªông danh s√°ch nhi·ªám v·ª•">
                  <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                  </svg>
                </button>
              </div>

              <div class="task-list-basic" id="task-list-basic" style="display: block">
                <div class="task-list-link" style="color: #8b4513; cursor: pointer; font-size: 0.75rem; padding: 4px 0">
                  Nh·∫•p ƒë·ªÉ xem danh s√°ch nhi·ªám v·ª•...
                </div>
              </div>

              <div
                class="task-list-detail"
                id="task-list-detail"
                style="
                  display: none;
                  margin-top: 10px;
                  padding: 15px;
                  background:
                    linear-gradient(135deg, rgba(244, 241, 232, 0.6) 0%, rgba(232, 224, 208, 0.6) 100%),
                    repeating-linear-gradient(
                      45deg,
                      transparent,
                      transparent 10px,
                      rgba(139, 105, 20, 0.03) 10px,
                      rgba(139, 105, 20, 0.03) 20px
                    );
                  border: 1px solid rgba(139, 105, 20, 0.2);
                  border-radius: 8px;
                  box-shadow:
                    inset 0 2px 4px rgba(139, 105, 20, 0.1),
                    0 1px 2px rgba(139, 105, 20, 0.1);
                  position: relative;
                  overflow: hidden;
                "
              >
                <div
                  style="
                    position: absolute;
                    top: -50%;
                    right: -50%;
                    width: 200%;
                    height: 200%;
                    background: radial-gradient(circle, rgba(212, 175, 55, 0.05) 0%, transparent 70%);
                    pointer-events: none;
                  "
                ></div>
                <div id="task-list-content" style="position: relative; z-index: 1">
                  <div style="color: #8b4513; font-size: 0.85em; text-align: center; padding: 20px">T·∫°m kh√¥ng c√≥ nhi·ªám v·ª•</div>
                </div>
              </div>
            </div>
          </div>

          <div class="inventory-section">
            <div class="section-header">
              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" />
              </svg>

              <h3>T√∫i ƒë·ªì</h3>

              <div class="command-manager-dot" id="command-manager-dot" style="display: none">
                <span class="dot-icon">üìã</span>

                <span class="dot-count">0</span>
              </div>
            </div>

            <div class="inventory-container" id="inventory-list">
              <div class="empty-inventory">T√∫i ƒë·ªì tr·ªëng</div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel-divider"></div>

      <div class="parchment-page center-panel">
        <div class="story-container">
          <div
            class="story-actions-bar"
            id="story-actions-bar"
            style="
              display: flex;
              align-items: center;
              justify-content: space-between;
              gap: 6px;
              padding: 8px 12px;
              margin-bottom: 8px;
              background: rgba(244, 241, 232, 0.3);
              border-radius: 6px;
              border: 1px solid rgba(139, 105, 20, 0.15);
            "
          >
            <div style="display: flex; align-items: center; gap: 6px">
              <button
                id="fullscreen-btn"
                class="story-action-btn"
                title="To√†n m√†n h√¨nh"
                style="
                  width: 32px;
                  height: 32px;
                  padding: 0;
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  background: rgba(139, 105, 20, 0.1);
                  color: #8b4513;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  transition: all 0.2s;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 11-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z"
                  />
                </svg>
              </button>

              <label
                class="chat-history-toggle"
                style="
                  display: flex;
                  align-items: center;
                  gap: 6px;
                  padding: 6px 12px;
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  background: rgba(139, 105, 20, 0.1);
                  color: #8b4513;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-size: 12px;
                  font-weight: 500;
                  margin-left: 4px;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                <input
                  type="checkbox"
                  id="chat-history-checkbox"
                  style="width: 16px; height: 16px; cursor: pointer; accent-color: #8b4513"
                />
                <span class="toggle-label" style="user-select: none">Tr√≤ chuy·ªán</span>
              </label>
            </div>
            <div style="display: flex; align-items: center; gap: 6px">
              <button
                id="btn-summary"
                class="story-action-btn"
                title="T√≥m t·∫Øt"
                style="
                  width: 32px;
                  height: 32px;
                  padding: 0;
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  background: rgba(139, 105, 20, 0.1);
                  color: #8b4513;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  transition: all 0.2s;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
              <button
                id="btn-back"
                class="story-action-btn"
                title="Quay l·∫°i"
                style="
                  width: 32px;
                  height: 32px;
                  padding: 0;
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  background: rgba(139, 105, 20, 0.1);
                  color: #8b4513;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  transition: all 0.2s;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
              <button
                id="btn-reroll"
                class="story-action-btn"
                title="T·∫°o l·∫°i"
                style="
                  width: 32px;
                  height: 32px;
                  padding: 0;
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  background: rgba(139, 105, 20, 0.1);
                  color: #8b4513;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  transition: all 0.2s;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
          </div>

          <div class="story-content" id="story-content" style="margin-bottom: 0; position: relative">
            <p class="story-text">ƒêang t·∫£i n·ªôi dung c√¢u chuy·ªán...</p>
          </div>

          <div
            id="chat-history-panel"
            style="
              display: none;
              margin-top: 20px;
              border-top: 2px solid rgba(139, 105, 20, 0.3);
              padding-top: 15px;
              max-height: 400px;
              overflow-y: auto;
              background: rgba(255, 255, 255, 0.5);
              border-radius: 4px;
              padding: 15px;
            "
          >
            <div
              style="
                font-size: 14px;
                font-weight: bold;
                color: #8b4513;
                margin-bottom: 10px;
                padding-bottom: 8px;
                border-bottom: 1px solid rgba(139, 105, 20, 0.2);
              "
            >
              L·ªãch s·ª≠ tr√≤ chuy·ªán
            </div>
            <div id="chat-history-content-list" style="color: #654321; line-height: 1.8; font-size: 13px">
              ƒêang t·∫£i...
            </div>
          </div>

          <div
            id="variable-update-decoration"
            class="variable-update-decoration"
            style="
              margin-top: 15px;
              margin-bottom: 15px;
              padding: 8px 12px;
              background:
                linear-gradient(135deg, rgba(139, 105, 20, 0.1), rgba(139, 105, 20, 0.15)),
                repeating-linear-gradient(
                  45deg,
                  transparent,
                  transparent 8px,
                  rgba(139, 105, 20, 0.02) 8px,
                  rgba(139, 105, 20, 0.02) 16px
                );
              border-left: 3px solid rgba(139, 105, 20, 0.5);
              border-radius: 4px;
              display: none;
              position: static;
              animation: fadeIn 0.3s ease-in;
              box-shadow: 0 1px 3px rgba(139, 105, 20, 0.1);
            "
          >
            <div
              style="
                display: flex;
                align-items: center;
                gap: 8px;
                color: #8b4513;
                font-size: 0.85em;
                font-weight: 500;
                font-style: italic;
              "
            >
              <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20" style="flex-shrink: 0; opacity: 0.7">
                <path
                  fill-rule="evenodd"
                  d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                  clip-rule="evenodd"
                />
              </svg>
              <span id="variable-update-text" class="variable-update-text" style="flex: 1; line-height: 1.4"></span>
            </div>
          </div>

          <div
            class="action-options-container"
            id="action-options-container"
            style="
              margin-top: 20px;
              padding: 15px;
              background:
                linear-gradient(135deg, rgba(244, 241, 232, 0.6) 0%, rgba(232, 224, 208, 0.6) 100%),
                repeating-linear-gradient(
                  45deg,
                  transparent,
                  transparent 10px,
                  rgba(139, 105, 20, 0.03) 10px,
                  rgba(139, 105, 20, 0.03) 20px
                );
              border: 1px solid rgba(139, 105, 20, 0.2);
              border-radius: 8px;
              box-shadow:
                inset 0 2px 4px rgba(139, 105, 20, 0.1),
                0 1px 2px rgba(139, 105, 20, 0.1);
              display: none;
            "
          >
            <div
              style="
                font-weight: 600;
                color: #8b4513;
                font-size: 0.9em;
                margin-bottom: 12px;
                display: flex;
                align-items: center;
                gap: 8px;
              "
            >
              <span style="font-size: 1.2em">üéØ</span>
              <span>T√πy ch·ªçn h√†nh ƒë·ªông</span>
            </div>
            <div id="action-options-list" style="display: flex; flex-direction: column; gap: 10px"></div>
          </div>
        </div>

        <div class="input-section ruled-paper">
          <div class="input-header">
            <div class="time-display compact">
              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                />
              </svg>

              <span id="current-time">ƒêang t·∫£i th·ªùi gian...</span>
            </div>

            <div class="skills-section" id="skills-section" style="display: none">
            </div>

            <div style="margin-left: auto; display: flex; align-items: center; gap: 2px">
              <button
                id="quickmap-btn"
                class="story-action-btn"
                title="B·∫£n ƒë·ªì nhanh"
                style="
                  width: 32px;
                  height: 32px;
                  padding: 0;
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  background: rgba(139, 105, 20, 0.1);
                  color: #8b4513;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  transition: all 0.2s;
                  position: relative;
                  z-index: 1000;
                  pointer-events: auto;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="pointer-events: none">
                  <path
                    fill-rule="evenodd"
                    d="M12 1.586l-4 4v12.828l4-4V1.586zM3.707 3.293A1 1 0 002 4v10a1 1 0 00.293.707L6 18.414V5.586L3.707 3.293zM17.707 5.293L14 1.586v12.828l2.293 2.293A1 1 0 0018 16V6a1 1 0 00-.293-.707z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>

              <button
                id="quick-action-btn"
                class="story-action-btn"
                title="Ch·ª©c nƒÉng nhanh"
                style="
                  width: 32px;
                  height: 32px;
                  padding: 0;
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  background: rgba(139, 105, 20, 0.1);
                  color: #8b4513;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  transition: all 0.2s;
                  position: relative;
                  z-index: 1000;
                  pointer-events: auto;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="pointer-events: none">
                  <path
                    fill-rule="evenodd"
                    d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
              <button
                id="quick-position-btn"
                class="story-action-btn"
                title="T∆∞ th·∫ø nhanh"
                style="
                  width: 32px;
                  height: 32px;
                  padding: 0;
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  background: rgba(139, 105, 20, 0.1);
                  color: #e91e63;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  transition: all 0.2s;
                  position: relative;
                  z-index: 1000;
                  pointer-events: auto;
                "
                onmouseover="this.style.background='rgba(233, 30, 99, 0.2)'; this.style.borderColor='rgba(233, 30, 99, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="pointer-events: none">
                  <path
                    fill-rule="evenodd"
                    d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
          </div>

          <div class="input-container">
            <span class="input-prompt">{">"}</span>

            <textarea id="action-input" placeholder="Nh·∫≠p h√†nh ƒë·ªông c·ªßa b·∫°n..." class="action-input"></textarea>

            <div class="input-controls">
              <button id="btn-send-action" class="send-button">G·ª≠i</button>
            </div>
          </div>
        </div>
      </div>

      <div class="panel-divider"></div>

      <div class="parchment-page right-panel" id="right-panel-container" style="position: relative">
        <div class="panel-content">
          <div
            id="right-panel-top-controls"
            style="
              display: flex;
              align-items: center;
              justify-content: space-between;
              gap: 10px;
              padding: 8px 12px;
              margin-bottom: 10px;
              background: rgba(244, 241, 232, 0.3);
              border-radius: 6px;
              border: 1px solid rgba(139, 105, 20, 0.15);
            "
          >
            <button
              id="fullscreen-btn-right"
              title="To√†n m√†n h√¨nh"
              style="
                cursor: pointer;
                background: rgba(139, 105, 20, 0.1);
                border: 1px solid rgba(139, 105, 20, 0.3);
                border-radius: 4px;
                padding: 6px;
                font-size: 1rem;
                color: #8b4513;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 32px;
                height: 32px;
              "
              onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
              onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
            >
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 11-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z"
                />
              </svg>
            </button>
            <div id="zoom-controls-inline" style="display: flex; align-items: center; gap: 4px; margin-left: auto">
              <button
                id="zoom-out-btn-inline"
                title="Thu nh·ªè"
                style="
                  cursor: pointer;
                  background: rgba(139, 105, 20, 0.1);
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  padding: 6px;
                  color: #8b4513;
                  transition: all 0.2s ease;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 18px;
                  font-weight: bold;
                  width: 32px;
                  height: 32px;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                ‚àí
              </button>
              <button
                id="zoom-reset-btn-inline"
                title="ƒê·∫∑t l·∫°i"
                style="
                  cursor: pointer;
                  background: rgba(139, 105, 20, 0.1);
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  padding: 6px;
                  color: #8b4513;
                  transition: all 0.2s ease;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 16px;
                  width: 32px;
                  height: 32px;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                ‚åÇ
              </button>
              <button
                id="zoom-in-btn-inline"
                title="Ph√≥ng to"
                style="
                  cursor: pointer;
                  background: rgba(139, 105, 20, 0.1);
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  padding: 6px;
                  color: #8b4513;
                  transition: all 0.2s ease;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 18px;
                  font-weight: bold;
                  width: 32px;
                  height: 32px;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                +
              </button>
            </div>
          </div>

          <div class="uma-section">
            <div class="section-header">
              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
                />
              </svg>

              <h3>Tr·∫°ng th√°i Uma Musume</h3>
            </div>

            <div class="uma-list" id="uma-status" style="display: block">
              <div class="loading-uma">ƒêang t·∫£i tr·∫°ng th√°i...</div>
            </div>
          </div>

          <div class="card-display-section">
            <div class="section-header">
              <svg class="icon card-display-icon" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"
                  clip-rule="evenodd"
                />
              </svg>
              <h3>Hi·ªÉn th·ªã th·∫ª b√†i</h3>
              <button class="expand-btn" id="card-display-btn" title="Xem th·∫ª b√†i">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                </svg>
              </button>
            </div>
          </div>

          <div
            class="uma-expression-section"
            id="main-uma-expression-section"
            style="
              margin-top: 2px;
              padding: 15px;
              background:
                linear-gradient(135deg, rgba(244, 241, 232, 0.6) 0%, rgba(232, 224, 208, 0.6) 100%),
                repeating-linear-gradient(
                  45deg,
                  transparent,
                  transparent 10px,
                  rgba(139, 105, 20, 0.03) 10px,
                  rgba(139, 105, 20, 0.03) 20px
                );
              border: 1px solid rgba(139, 105, 20, 0.2);
              border-radius: 8px;
              box-shadow:
                inset 0 2px 4px rgba(139, 105, 20, 0.1),
                0 1px 2px rgba(139, 105, 20, 0.1);
              position: relative;
              overflow: hidden;
            "
          >
            <div
              style="
                position: absolute;
                top: -50%;
                right: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(circle, rgba(212, 175, 55, 0.05) 0%, transparent 70%);
                pointer-events: none;
              "
            ></div>
            <div id="main-uma-expression-grid" style="text-align: center; position: relative; z-index: 1"></div>
          </div>

          <div class="sex-position-section" style="margin-top: 0.75rem">
            <div class="section-header">
              <svg class="icon" fill="currentColor" viewBox="0 0 20 20" style="color: #8b6914">
                <path
                  fill-rule="evenodd"
                  d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"
                  clip-rule="evenodd"
                />
              </svg>
              <h3>H√¨nh ·∫£nh t∆∞ th·∫ø</h3>
              <button class="expand-btn" id="sex-position-expand" title="M·ªü r·ªông h√¨nh ·∫£nh t∆∞ th·∫ø">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                </svg>
              </button>
            </div>

            <div class="sex-position-basic" id="sex-position-basic" style="display: block">
              <div
                class="sex-position-link"
                style="color: #8b4513; cursor: pointer; font-size: 0.75rem; padding: 4px 0"
              >
                Nh·∫•p ƒë·ªÉ xem h√¨nh ·∫£nh t∆∞ th·∫ø...
              </div>
            </div>

            <div
              class="sex-position-detail"
              id="sex-position-detail"
              style="
                display: none;
                margin-top: 10px;
                padding: 15px;
                background:
                  linear-gradient(135deg, rgba(244, 241, 232, 0.6) 0%, rgba(232, 224, 208, 0.6) 100%),
                  repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(139, 105, 20, 0.03) 10px,
                    rgba(139, 105, 20, 0.03) 20px
                  );
                border: 1px solid rgba(139, 105, 20, 0.2);
                border-radius: 8px;
                box-shadow:
                  inset 0 2px 4px rgba(139, 105, 20, 0.1),
                  0 1px 2px rgba(139, 105, 20, 0.1);
                position: relative;
                overflow: hidden;
              "
            >
              <div
                style="
                  position: absolute;
                  top: -50%;
                  right: -50%;
                  width: 200%;
                  height: 200%;
                  background: radial-gradient(circle, rgba(212, 175, 55, 0.05) 0%, transparent 70%);
                  pointer-events: none;
                "
              ></div>
              <div style="text-align: center; position: relative; z-index: 1">
                <div
                  id="sex-position-text"
                  style="font-size: 0.95em; font-weight: 600; color: #8b4513; margin-bottom: 10px; text-align: center"
                ></div>
                <div
                  style="
                    width: 100%;
                    max-height: 300px;
                    border-radius: 8px;
                    overflow: hidden;
                    border: 2px solid rgba(139, 105, 20, 0.3);
                    background: rgba(139, 105, 20, 0.05);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                  "
                >
                  <img
                    id="sex-position-image"
                    src=""
                    alt="H√¨nh ·∫£nh t∆∞ th·∫ø quan h·ªá t√¨nh d·ª•c"
                    style="width: 100%; height: auto; max-height: 300px; object-fit: contain; display: none"
                    loading="lazy"
                  />
                  <div
                    id="sex-position-placeholder"
                    style="color: #8b4513; font-size: 0.85em; padding: 40px; text-align: center"
                  >
                    T·∫°m kh√¥ng c√≥ h√¨nh ·∫£nh t∆∞ th·∫ø
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="qte-section" id="qte-section" style="display: none">
            <div class="section-header">
              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z" />
              </svg>

              <h3>T√πy ch·ªçn gi√£y gi·ª•a</h3>
            </div>

            <div class="qte-container">
              <div class="qte-info">
                <p class="qte-description">B·∫°n b·ªã Uma Musume tr√≥i bu·ªôc!</p>

                <p class="qte-subtitle">Ch·ªçn h√†nh ƒë·ªông c·ªßa b·∫°n...</p>
              </div>

              <div class="qte-options">
                <button
                  class="qte-btn struggle-btn"
                  id="qte-struggle-btn"
                  onclick="window.teresenDebug.triggerQTE('struggle')"
                >
                  <span class="qte-icon">üí™</span>

                  <span class="qte-text">C·ªë g·∫Øng gi√£y gi·ª•a</span>

                  <span class="qte-desc">Th·ª≠ tho√°t kh·ªèi tr√≥i bu·ªôc</span>
                </button>

                <button
                  class="qte-btn submit-btn"
                  id="qte-submit-btn"
                  onclick="window.teresenDebug.triggerQTE('submit')"
                >
                  <span class="qte-icon">üòå</span>

                  <span class="qte-text">Kh√¥ng ph·∫£n kh√°ng</span>

                  <span class="qte-desc">Ch·∫•p nh·∫≠n hi·ªán tr·∫°ng</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="bottom-panel">

        <div class="bottom-group">
          <button id="settings-btn" class="bottom-button" title="C√†i ƒë·∫∑t">
            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                clip-rule="evenodd"
              />
            </svg>
          </button>

          <button id="world-map-btn" class="bottom-button" title="B·∫£n ƒë·ªì th·∫ø gi·ªõi">
            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M12 1.586l-4 4v12.828l4-4V1.586zM3.707 3.293A1 1 0 002 4v10a1 1 0 00.293.707L6 18.414V5.586L3.707 3.293zM17.707 5.293L14 1.586v12.828l2.293 2.293A1 1 0 0018 16V6a1 1 0 00-.293-.707z"
                clip-rule="evenodd"
              />
            </svg>
          </button>

          <button id="music-player-btn" class="bottom-button" title="Tr√¨nh ph√°t nh·∫°c">
            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.369 4.369 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"
                clip-rule="evenodd"
              />
            </svg>
          </button>

          <button id="tarot-divination" class="bottom-button" title="B√≥i Tarot">
            <span>üîÆ</span>
          </button>

          <button id="shrine-btn" class="bottom-button" title="ƒê·ªÅn th·ªù c·∫ßu ph√∫c">
            <span>‚õ©Ô∏è</span>
          </button>
        </div>

        <div class="bottom-group">
          <div class="festival-notice" id="festival-notice" style="display: none">
            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
              <path
                d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
              />
            </svg>

            <span id="festival-text">Th√¥ng b√°o l·ªÖ h·ªôi</span>
          </div>

          <div class="reply-timer" id="reply-timer">
            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
              />
            </svg>

            <span id="reply-timer-text">Th·ªùi gian ph·∫£n h·ªìi: --:--</span>
          </div>
        </div>
      </div>
    </div>

    <div
      id="quick-action-modal"
      class="rules-modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        align-items: center;
        justify-content: center;
      "
    >
      <div class="rules-modal-content" style="max-width: 500px; width: 90%; max-height: 90vh">
        <div class="rules-modal-header">
          <h2 class="rules-title">‚ö° Ch·ª©c nƒÉng nhanh</h2>
          <button id="quick-action-modal-close-btn" class="close-rules-btn">√ó</button>
        </div>
        <div
          class="rules-modal-body"
          style="
            padding: 12px;
            overflow-y: auto;
            max-height: calc(90vh - 60px);
            scrollbar-width: thin;
            scrollbar-color: rgba(139, 105, 20, 0.3) transparent;
          "
        >
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px">
            <button
              class="quick-action-modal-btn"
              data-action="meal"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">üçΩÔ∏è</span>
              <span style="line-height: 1.2">ƒÇn th√™m</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="borrow"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">üí∞</span>
              <span style="line-height: 1.2">M∆∞·ª£n ti·ªÅn</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="game"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">üéÆ</span>
              <span style="line-height: 1.2">Ch∆°i game</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="chat"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">üí¨</span>
              <span style="line-height: 1.2">Tr√≤ chuy·ªán</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="rest"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">üò¥</span>
              <span style="line-height: 1.2">Ngh·ªâ ng∆°i ƒë·∫øn tu·∫ßn sau</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="train"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">üèÉ</span>
              <span style="line-height: 1.2">Hu·∫•n luy·ªán Uma Musume</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="schedule"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">üìÖ</span>
              <span style="line-height: 1.2">Xem l·ªãch thi ƒë·∫•u</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="gacha"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">üé∞</span>
              <span style="line-height: 1.2">ƒêi Gacha</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="phone"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">üì±</span>
              <span style="line-height: 1.2">Li√™n l·∫°c ƒëi·ªán tho·∫°i</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="rules"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">üìã</span>
              <span style="line-height: 1.2">Ki·ªÉm tra quy t·∫Øc</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="quick-position-modal"
      class="rules-modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        align-items: center;
        justify-content: center;
      "
    >
      <div class="rules-modal-content" style="max-width: 700px; width: 90%; max-height: 90vh">
        <div class="rules-modal-header">
          <h2 class="rules-title">üíï T∆∞ th·∫ø nhanh</h2>
          <button id="quick-position-modal-close-btn" class="close-rules-btn">√ó</button>
        </div>
        <div
          class="rules-modal-body"
          style="
            padding: 12px;
            overflow-y: auto;
            max-height: calc(90vh - 60px);
            scrollbar-width: thin;
            scrollbar-color: rgba(139, 105, 20, 0.3) transparent;
          "
        >
          <div class="position-category-list" style="display: block">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px">
              <button
                class="position-category-btn"
                data-category="basic"
                style="
                  padding: 16px;
                  border: 1px solid rgba(233, 30, 99, 0.3);
                  border-radius: 8px;
                  background: linear-gradient(135deg, rgba(233, 30, 99, 0.12), rgba(233, 30, 99, 0.05));
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.3s;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  gap: 8px;
                  box-shadow: 0 2px 4px rgba(233, 30, 99, 0.1);
                "
              >
                <svg width="32" height="32" fill="currentColor" viewBox="0 0 20 20" style="color: #e91e63">
                  <path
                    fill-rule="evenodd"
                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span style="font-size: 14px; font-weight: 600">T∆∞∆°ng t√°c c∆° b·∫£n v√† t√°n t·ªânh</span>
              </button>

              <button
                class="position-category-btn"
                data-category="partial"
                style="
                  padding: 16px;
                  border: 1px solid rgba(233, 30, 99, 0.3);
                  border-radius: 8px;
                  background: linear-gradient(135deg, rgba(233, 30, 99, 0.12), rgba(233, 30, 99, 0.05));
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.3s;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  gap: 8px;
                  box-shadow: 0 2px 4px rgba(233, 30, 99, 0.1);
                "
              >
                <svg width="32" height="32" fill="currentColor" viewBox="0 0 20 20" style="color: #e91e63">
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span style="font-size: 14px; font-weight: 600">H√†nh vi t√¨nh d·ª•c c·ª•c b·ªô</span>
              </button>

              <button
                class="position-category-btn"
                data-category="normal"
                style="
                  padding: 16px;
                  border: 1px solid rgba(233, 30, 99, 0.3);
                  border-radius: 8px;
                  background: linear-gradient(135deg, rgba(233, 30, 99, 0.12), rgba(233, 30, 99, 0.05));
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.3s;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  gap: 8px;
                  box-shadow: 0 2px 4px rgba(233, 30, 99, 0.1);
                "
              >
                <svg width="32" height="32" fill="currentColor" viewBox="0 0 20 20" style="color: #e91e63">
                  <path
                    d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"
                  />
                </svg>
                <span style="font-size: 14px; font-weight: 600">T∆∞ th·∫ø ch√≠nh th·ª©c - Th√¥ng th∆∞·ªùng</span>
              </button>

              <button
                class="position-category-btn"
                data-category="anal"
                style="
                  padding: 16px;
                  border: 1px solid rgba(233, 30, 99, 0.3);
                  border-radius: 8px;
                  background: linear-gradient(135deg, rgba(233, 30, 99, 0.12), rgba(233, 30, 99, 0.05));
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.3s;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  gap: 8px;
                  box-shadow: 0 2px 4px rgba(233, 30, 99, 0.1);
                "
              >
                <svg width="32" height="32" fill="currentColor" viewBox="0 0 20 20" style="color: #e91e63">
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span style="font-size: 14px; font-weight: 600">T∆∞ th·∫ø ch√≠nh th·ª©c - Anal</span>
              </button>
            </div>
          </div>

          <div class="position-subcategory-list" style="display: none">
            <button
              class="position-back-btn"
              style="
                margin-bottom: 12px;
                padding: 8px 16px;
                border: 1px solid rgba(139, 105, 20, 0.3);
                border-radius: 6px;
                background: rgba(139, 105, 20, 0.1);
                color: #8b4513;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 6px;
                font-size: 13px;
                transition: all 0.2s;
              "
            >
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                  clip-rule="evenodd"
                />
              </svg>
              <span>Quay l·∫°i ph√¢n lo·∫°i</span>
            </button>

            <div class="position-subcategory" data-category="basic" style="display: none">
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px">
                <button
                  class="quick-position-btn"
                  data-position="Tr√≤ chuy·ªán"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üí¨ Tr√≤ chuy·ªán
                </button>
                <button
                  class="quick-position-btn"
                  data-position="T√°n t·ªânh"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üòò T√°n t·ªânh
                </button>
                <button
                  class="quick-position-btn"
                  data-position="H√¥n"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üíã H√¥n
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Vu·ªët ve tai"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üëÇ Vu·ªët ve tai
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Vu·ªët ve ƒë√πi"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ü¶µ Vu·ªët ve ƒë√πi
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Vu·ªët ve ƒëu√¥i"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üê¥ Vu·ªët ve ƒëu√¥i
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Vu·ªët ve ng·ª±c"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üíï Vu·ªët ve ng·ª±c
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Vu·ªët ve √¢m v·∫≠t"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üå∏ Vu·ªët ve √¢m v·∫≠t
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Ng√≥n tay th√¢m nh·∫≠p"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üëÜ Ng√≥n tay th√¢m nh·∫≠p
                </button>
              </div>
            </div>

            <div class="position-subcategory" data-category="partial" style="display: none">
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px">
                <button
                  class="quick-position-btn"
                  data-position="Handjob"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ‚úã Handjob
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Oral sex"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üëÑ Oral sex
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Deepthroat"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üîΩ Deepthroat
                </button>
                <button
                  class="quick-position-btn"
                  data-position="D√πng l∆∞·ª°i"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üëÖ D√πng l∆∞·ª°i
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Paizuri"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üçº Paizuri
                </button>
                <button
                  class="quick-position-btn"
                  data-position="K·∫πp ng·ª±c Oral"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üíù K·∫πp ng·ª±c Oral
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Footjob"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ü¶∂ Footjob
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Sumata"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ü¶µ Sumata
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Li·∫øm h·∫≠u m√¥n"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üëÖ Li·∫øm h·∫≠u m√¥n
                </button>
              </div>
            </div>

            <div class="position-subcategory" data-category="normal" style="display: none">
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px">
                <button
                  class="quick-position-btn"
                  data-position="T∆∞ th·∫ø truy·ªÅn th·ªëng"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üõèÔ∏è T∆∞ th·∫ø truy·ªÅn th·ªëng
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Doggy style"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üîô Doggy style
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Ng·ªìi ƒë·ªëi m·∫∑t"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ü™ë Ng·ªìi ƒë·ªëi m·∫∑t
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Ng·ªìi quay l∆∞ng"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ü™ë Ng·ªìi quay l∆∞ng
                </button>
                <button
                  class="quick-position-btn"
                  data-position="ƒê·ª©ng ƒë·ªëi m·∫∑t"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üö∂ ƒê·ª©ng ƒë·ªëi m·∫∑t
                </button>
                <button
                  class="quick-position-btn"
                  data-position="ƒê·ª©ng quay l∆∞ng"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üö∂ ƒê·ª©ng quay l∆∞ng
                </button>
                <button
                  class="quick-position-btn"
                  data-position="T∆∞ th·∫ø 69"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  69 T∆∞ th·∫ø 69
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Cowgirl"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üëÜ Cowgirl
                </button>
              </div>
            </div>

            <div class="position-subcategory" data-category="anal" style="display: none">
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px">
                <button
                  class="quick-position-btn"
                  data-position="Anal truy·ªÅn th·ªëng"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üõèÔ∏è Anal truy·ªÅn th·ªëng
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Anal Doggy"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üîô Anal Doggy
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Anal ng·ªìi ƒë·ªëi m·∫∑t"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ü™ë Anal ng·ªìi ƒë·ªëi m·∫∑t
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Anal ng·ªìi quay l∆∞ng"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ü™ë Anal ng·ªìi quay l∆∞ng
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Anal ƒë·ª©ng ƒë·ªëi m·∫∑t"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üö∂ Anal ƒë·ª©ng ƒë·ªëi m·∫∑t
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Anal ƒë·ª©ng quay l∆∞ng"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üö∂ Anal ƒë·ª©ng quay l∆∞ng
                </button>
                <button
                  class="quick-position-btn"
                  data-position="Anal cowgirl"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  üëÜ Anal cowgirl
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="settings-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content" style="max-width: 600px; width: 90%">
        <div class="rules-modal-header">
          <h2 class="rules-title">‚öôÔ∏è C√†i ƒë·∫∑t</h2>
          <button id="teresen-settings-close-btn" class="close-rules-btn">√ó</button>
        </div>
        <div class="rules-modal-body">
          <div style="margin-bottom: 25px">
            <h3 style="color: #8b6914; margin-bottom: 15px; font-size: 1.1rem; font-weight: 600">C√†i ƒë·∫∑t ph√¥ng ch·ªØ</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px">
              <button
                class="font-option-btn"
                data-font="'Source Han Serif', 'ÊÄùÊ∫êÂÆã‰Ωì', serif"
                style="
                  padding: 15px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-family: 'Source Han Serif', 'ÊÄùÊ∫êÂÆã‰Ωì', serif;
                "
              >
                <div style="font-size: 0.85em; color: #666">ÊÄùÊ∫êÂÆã‰Ωì</div>
              </button>
              <button
                class="font-option-btn"
                data-font="'Source Han Sans', 'ÊÄùÊ∫êÈªë‰Ωì', sans-serif"
                style="
                  padding: 15px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-family: 'Source Han Sans', 'ÊÄùÊ∫êÈªë‰Ωì', sans-serif;
                "
              >
                <div style="font-size: 0.85em; color: #666">ÊÄùÊ∫êÈªë‰Ωì</div>
              </button>
              <button
                class="font-option-btn"
                data-font="'Source Han Font', 'Ê∫êÊ±âÂ≠ó‰Ωì', sans-serif"
                style="
                  padding: 15px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-family: 'Source Han Font', 'Ê∫êÊ±âÂ≠ó‰Ωì', sans-serif;
                "
              >
                <div style="font-size: 0.85em; color: #666">Ê∫êÊ±âÂ≠ó‰Ωì</div>
              </button>
              <button
                class="font-option-btn"
                data-font="'KaiTi', 'Ê•∑‰Ωì', serif"
                style="
                  padding: 15px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-family: 'KaiTi', 'Ê•∑‰Ωì', serif;
                "
              >
                <div style="font-size: 0.85em; color: #666">Ê•∑‰Ωì</div>
              </button>
            </div>
          </div>

          <div style="margin-bottom: 25px">
            <h3 style="color: #8b6914; margin-bottom: 15px; font-size: 1.1rem; font-weight: 600">K√≠ch th∆∞·ªõc ph√¥ng ch·ªØ</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap">
              <button
                class="font-size-btn"
                data-size="0.9"
                style="
                  padding: 12px 20px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-size: 0.9em;
                "
              >
                <div style="font-size: 0.8em; color: #666">Nh·ªè</div>
              </button>
              <button
                class="font-size-btn"
                data-size="1"
                style="
                  padding: 12px 20px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-size: 1em;
                "
              >
                <div style="font-size: 0.8em; color: #666">V·ª´a</div>
              </button>
              <button
                class="font-size-btn"
                data-size="1.15"
                style="
                  padding: 12px 20px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-size: 1.15em;
                "
              >
                <div style="font-size: 0.8em; color: #666">L·ªõn</div>
              </button>
              <button
                class="font-size-btn"
                data-size="1.3"
                style="
                  padding: 12px 20px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-size: 1.3em;
                "
              >
                <div style="font-size: 0.8em; color: #666">R·∫•t l·ªõn</div>
              </button>
            </div>
          </div>

          <div style="margin-bottom: 25px">
            <h3 style="color: #8b6914; margin-bottom: 15px; font-size: 1.1rem; font-weight: 600">Text Streaming</h3>
            <label
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 12px;
                border: 1px solid rgba(139, 105, 20, 0.3);
                border-radius: 8px;
                background: rgba(139, 105, 20, 0.05);
                cursor: pointer;
                transition: all 0.2s;
              "
              onmouseover="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
              onmouseout="this.style.background='rgba(139, 105, 20, 0.05)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
            >
              <input
                type="checkbox"
                id="streaming-checkbox"
                checked
                style="width: 18px; height: 18px; cursor: pointer; accent-color: #8b4513"
              />
              <span style="color: #2d2d2d; font-size: 0.95rem; user-select: none">B·∫≠t Text Streaming (Hi·ªÉn th·ªã real-time ph·∫£n h·ªìi AI)</span>
            </label>
          </div>

          <div style="margin-bottom: 25px">
            <h3 style="color: #8b6914; margin-bottom: 15px; font-size: 1.1rem; font-weight: 600">Hi·ªáu ·ª©ng xem tr∆∞·ªõc</h3>
            <div
              id="font-preview"
              style="
                padding: 20px;
                background: rgba(139, 105, 20, 0.05);
                border: 1px solid rgba(139, 105, 20, 0.3);
                border-radius: 8px;
                min-height: 120px;
                color: #2d2d2d;
                line-height: 1.6;
              "
            >
              <p style="margin: 0">ƒê√¢y l√† vƒÉn b·∫£n xem tr∆∞·ªõc, d√πng ƒë·ªÉ hi·ªÉn th·ªã hi·ªáu ·ª©ng ph√¥ng ch·ªØ v√† k√≠ch th∆∞·ªõc ph√¥ng ch·ªØ hi·ªán t·∫°i.</p>
            </div>
          </div>

          <div style="margin-bottom: 25px">
            <h3 style="color: #8b6914; margin-bottom: 15px; font-size: 1.1rem; font-weight: 600">H√¨nh n·ªÅn to√†n m√†n h√¨nh</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 15px">
              <button
                id="bg-black-btn"
                class="bg-option-btn"
                data-bg-type="black"
                style="
                  padding: 12px 20px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(0, 0, 0, 0.85);
                  color: #fff;
                  cursor: pointer;
                  transition: all 0.2s;
                  flex: 1;
                "
              >
                Vi·ªÅn ƒëen
              </button>
              <button
                id="bg-image-btn"
                class="bg-option-btn"
                data-bg-type="image"
                style="
                  padding: 12px 20px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  flex: 1;
                "
              >
                H√¨nh n·ªÅn
              </button>
            </div>
            <div id="bg-image-upload" style="display: none">
              <div style="margin-bottom: 15px">
                <h4 style="color: #8b6914; margin-bottom: 10px; font-size: 0.95rem; font-weight: 600">H√¨nh ·∫£nh c√†i s·∫µn</h4>
                <div
                  id="preset-images-grid"
                  style="
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                    gap: 10px;
                    max-height: 300px;
                    overflow-y: auto;
                    padding: 10px;
                    background: rgba(139, 105, 20, 0.03);
                    border-radius: 8px;
                    border: 1px solid rgba(139, 105, 20, 0.2);
                  "
                ></div>
              </div>

              <div style="margin-bottom: 10px">
                <h4 style="color: #8b6914; margin-bottom: 10px; font-size: 0.95rem; font-weight: 600">URL h√¨nh ·∫£nh t√πy ch·ªânh</h4>
                <div style="display: flex; gap: 10px">
                  <input
                    type="text"
                    id="bg-image-url"
                    placeholder="Nh·∫≠p URL h√¨nh ·∫£nh"
                    style="
                      flex: 1;
                      padding: 8px;
                      border: 1px solid rgba(139, 105, 20, 0.3);
                      border-radius: 6px;
                      background: rgba(139, 105, 20, 0.05);
                      color: #2d2d2d;
                    "
                  />
                  <button
                    id="bg-image-load-btn"
                    style="
                      padding: 8px 16px;
                      border: 1px solid rgba(139, 105, 20, 0.3);
                      border-radius: 6px;
                      background: rgba(139, 105, 20, 0.2);
                      color: #2d2d2d;
                      cursor: pointer;
                    "
                  >
                    T·∫£i
                  </button>
                </div>
              </div>

              <div
                id="bg-image-preview"
                style="
                  margin-top: 10px;
                  max-height: 200px;
                  border-radius: 8px;
                  overflow: hidden;
                  display: none;
                  position: relative;
                "
              >
                <img id="bg-preview-img" src="" style="width: 100%; height: auto; display: block" />
                <button
                  id="bg-image-delete-btn"
                  style="
                    position: absolute;
                    top: 5px;
                    right: 5px;
                    padding: 5px 10px;
                    background: rgba(220, 38, 38, 0.9);
                    border: 1px solid rgba(220, 38, 38, 1);
                    border-radius: 4px;
                    color: #fff;
                    cursor: pointer;
                    font-size: 12px;
                    z-index: 10;
                  "
                >
                  X√≥a
                </button>
              </div>
            </div>
          </div>

          <div
            style="
              margin-bottom: 25px;
              padding: 15px;
              background: rgba(139, 105, 20, 0.05);
              border-radius: 8px;
              border: 1px solid rgba(139, 105, 20, 0.2);
            "
          >
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer">
              <input
                type="checkbox"
                id="auto-fullscreen-checkbox"
                style="width: 18px; height: 18px; cursor: pointer; accent-color: #8b6914"
              />
              <span style="color: #2d2d2d; font-size: 1rem; font-weight: 500"
                >M√†n h√¨nh t·∫£i to√†n m√†n h√¨nh (PC t·ª± ƒë·ªông thu ph√≥ng to√†n m√†n h√¨nh khi t·∫£i)</span
              >
            </label>
            <p style="margin: 8px 0 0 28px; color: #666; font-size: 0.85em; line-height: 1.4">
              Sau khi ch·ªçn, khi t·∫£i trang tr√™n PC s·∫Ω t·ª± ƒë·ªông v√†o ch·∫ø ƒë·ªô thu ph√≥ng to√†n m√†n h√¨nh
            </p>
          </div>

          <div
            style="
              margin-bottom: 25px;
              padding: 15px;
              background: rgba(139, 105, 20, 0.05);
              border-radius: 8px;
              border: 1px solid rgba(139, 105, 20, 0.2);
            "
          >
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer">
              <input
                type="checkbox"
                id="enter-to-send-checkbox"
                style="width: 18px; height: 18px; cursor: pointer; accent-color: #8b6914"
              />
              <span style="color: #2d2d2d; font-size: 1rem; font-weight: 500">Enter g·ª≠i tin nh·∫Øn</span>
            </label>
            <p style="margin: 8px 0 0 28px; color: #666; font-size: 0.85em; line-height: 1.4">
              Sau khi ch·ªçn, nh·∫•n ph√≠m Enter trong √¥ nh·∫≠p li·ªáu ƒë·ªÉ g·ª≠i tin nh·∫Øn cho AI (m·∫∑c ƒë·ªãnh t·∫Øt)
            </p>
          </div>

          <div
            style="
              margin-bottom: 25px;
              padding: 15px;
              background: rgba(220, 38, 38, 0.05);
              border-radius: 8px;
              border: 1px solid rgba(220, 38, 38, 0.3);
            "
          >
            <h3 style="color: #dc2626; margin-bottom: 15px; font-size: 1.1rem; font-weight: 600">üóëÔ∏è X√≥a b·ªô nh·ªõ ƒë·ªám</h3>
            <p style="margin: 0 0 15px 0; color: #666; font-size: 0.9em; line-height: 1.5">
              X√≥a t·∫•t c·∫£ d·ªØ li·ªáu b·ªô nh·ªõ ƒë·ªám ƒë∆∞·ª£c l∆∞u tr·ªØ c·ª•c b·ªô, bao g·ªìm c√†i ƒë·∫∑t, l·ªãch s·ª≠ ghi ch√©p, v.v. Thao t√°c n√†y kh√¥ng th·ªÉ kh√¥i ph·ª•c, vui l√≤ng th·∫≠n tr·ªçng.
            </p>
            <button
              id="clear-cache-btn"
              style="
                padding: 12px 24px;
                background: linear-gradient(135deg, #dc2626, #b91c1c);
                border: none;
                border-radius: 8px;
                color: #fff;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                width: 100%;
                box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
              "
              onmouseover="this.style.background='linear-gradient(135deg, #b91c1c, #991b1b)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(220, 38, 38, 0.3)'"
              onmouseout="this.style.background='linear-gradient(135deg, #dc2626, #b91c1c)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(220, 38, 38, 0.2)'"
            >
              X√≥a t·∫•t c·∫£ b·ªô nh·ªõ ƒë·ªám
            </button>
            <div
              id="clear-cache-result"
              style="margin-top: 10px; padding: 10px; border-radius: 6px; display: none; font-size: 0.9em"
            ></div>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 20px">
            <button
              id="apply-settings-btn"
              style="
                flex: 1;
                padding: 12px 24px;
                background: linear-gradient(135deg, #10b981, #059669);
                border: none;
                border-radius: 8px;
                color: #fff;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
              "
            >
              √Åp d·ª•ng c√†i ƒë·∫∑t
            </button>
            <button
              id="reset-settings-btn"
              style="
                flex: 1;
                padding: 12px 24px;
                background: rgba(139, 105, 20, 0.1);
                border: 1px solid rgba(139, 105, 20, 0.3);
                border-radius: 8px;
                color: #2d2d2d;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
              "
            >
              Reset m·∫∑c ƒë·ªãnh
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="rules-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content">
        <div class="rules-modal-header">
          <h2 class="rules-title">H·ªçc vi·ªán Tracen: Chuy·ªán l·∫°</h2>

          <div class="music-controls" style="display: flex; align-items: center; gap: 10px; margin-right: 10px">
            <button
              id="music-controller"
              class="music-btn"
              style="
                background: rgba(139, 105, 20, 0.8);
                border: 1px solid #8b6914;
                color: #fdfbf7;
                padding: 5px 10px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
              "
              title="Nh·∫•p ƒë·ªÉ chuy·ªÉn nh·∫°c (T·ªïng 2 b√†i, nh·∫•p l·∫ßn 3 ƒë·ªÉ t·∫Øt)"
            >
              üéµ ƒêi·ªÅu khi·ªÉn nh·∫°c
            </button>
          </div>

          <button id="close-rules-btn" class="close-rules-btn">√ó</button>
        </div>

        <div class="rules-modal-body">
          <div
            class="rules-section-danger"
            style="
              margin-bottom: 20px;
              padding: 15px;
              background: rgba(139, 105, 20, 0.05);
              border: 1px solid rgba(139, 105, 20, 0.2);
              border-radius: 8px;
            "
          >
            <h3 class="rules-section-title" style="margin-bottom: 10px">Giai ƒëo·∫°n r·ªßi ro hi·ªán t·∫°i</h3>
            <div id="danger-period-display" style="font-size: 16px; color: #8b4513; font-weight: 500">
              <span id="danger-period-text">--</span>
            </div>
          </div>

          <div class="rules-section-fixed">
            <h3 class="rules-section-title">Quy t·∫Øc sinh t·ªìn</h3>

            <div id="fixed-rules-list" class="rules-list-handwritten"></div>
          </div>

          <div class="rules-section-random">
            <h3 class="rules-section-title">Ghi ch√©p quy t·∫Øc</h3>
            <div class="rules-record-controls">
              <button id="add-rule-btn" class="add-rule-btn">+ Th√™m quy t·∫Øc</button>
              <button id="clear-rules-btn" class="clear-rules-btn">X√≥a ghi ch√©p</button>
            </div>
            <div id="random-rules-list" class="rules-list-handwritten"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="load-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content">
        <div class="rules-modal-header">
          <h2 class="rules-title">ƒê·ªçc l∆∞u tr·ªØ</h2>

          <button id="close-load-btn" class="close-rules-btn">√ó</button>
        </div>

        <div class="rules-modal-body">
          <div class="load-section">
            <h3 class="rules-section-title">L∆∞u tr·ªØ c·ª•c b·ªô (localStorage)</h3>

            <div id="local-saves-list" class="saves-list"></div>

            <h3 class="rules-section-title">L∆∞u tr·ªØ S√°ch th·∫ø gi·ªõi (TavernHelper)</h3>

            <div id="worldbook-saves-list" class="saves-list"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="history-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content">
        <div class="rules-modal-header">
          <h2 class="rules-title">L·ªãch s·ª≠ ghi ch√©p</h2>

          <button id="close-history-btn" class="close-rules-btn">√ó</button>
        </div>

        <div class="rules-modal-body">
          <div class="history-section">
            <h3 class="rules-section-title">H√†nh tr√¨nh nh√¢n v·∫≠t</h3>

            <div id="current-journey-list" class="journey-list"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="card-display-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content" style="max-width: 90%; width: 1200px">
        <div class="rules-modal-header">
          <h2 class="rules-title">üÉè Hi·ªÉn th·ªã th·∫ª b√†i</h2>
          <button id="close-card-display-btn" class="close-rules-btn">√ó</button>
        </div>
        <div class="rules-modal-body">
          <div id="card-display-grid" class="card-display-grid"></div>

          <div
            class="uma-expression-section"
            style="
              margin-top: 30px;
              padding: 20px;
              background: linear-gradient(135deg, rgba(244, 241, 232, 0.9) 0%, rgba(232, 224, 208, 0.9) 100%);
              border: 2px solid #8b4513;
              border-radius: 12px;
              box-shadow: 0 4px 12px rgba(139, 69, 19, 0.2);
            "
          >
            <div
              style="
                font-size: 1.2em;
                font-weight: bold;
                color: #8b4513;
                margin-bottom: 20px;
                text-align: center;
                text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.2);
              "
            >
              üí≠ Bi·ªÉu c·∫£m nh√¢n v·∫≠t
            </div>
            <div id="uma-expression-grid" class="uma-expression-grid"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="tarot-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content tarot-modal-content">
        <div class="rules-modal-header">
          <h2 class="rules-title">B√≥i Tarot H·ªçc vi·ªán Tracen</h2>
          <button id="close-tarot-btn" class="close-rules-btn">√ó</button>
        </div>
        <div class="rules-modal-body">
          <div class="tarot-section">
            <div class="tarot-info">
              <p>S·ªë l·∫ßn b√≥i c√≤n l·∫°i h√¥m nay: <span id="tarot-remaining">3</span></p>
              <p>L√Ω tr√≠ hi·ªán t·∫°i: <span id="tarot-sanity">--</span></p>
            </div>

            <div class="tarot-spreads">
              <h3 class="rules-section-title">B√≥i c∆° b·∫£n</h3>
              <div class="spread-buttons">
                <button class="spread-btn" data-spread="single" data-cost="5">
                  <span class="spread-icon">üîÆ</span>
                  <span class="spread-name">B√≥i m·ªôt l√°</span>
                  <span class="spread-cost">Ti√™u hao 5 l√Ω tr√≠</span>
                </button>
                <button class="spread-btn" data-spread="timeline" data-cost="10">
                  <span class="spread-icon">‚è∞</span>
                  <span class="spread-name">D√≤ng th·ªùi gian</span>
                  <span class="spread-cost">Ti√™u hao 10 l√Ω tr√≠</span>
                </button>
                <button class="spread-btn" data-spread="choice" data-cost="8">
                  <span class="spread-icon">‚öñÔ∏è</span>
                  <span class="spread-name">Ch·ªçn m·ªôt trong hai</span>
                  <span class="spread-cost">Ti√™u hao 8 l√Ω tr√≠</span>
                </button>
              </div>

              <h3 class="rules-section-title">B√≥i cao c·∫•p</h3>
              <div class="spread-buttons">
                <button class="spread-btn advanced" data-spread="hexagram" data-cost="15" data-requirement="7">
                  <span class="spread-icon">‚≠ê</span>
                  <span class="spread-name">B√≥i L·ª•c Mang Tinh</span>
                  <span class="spread-cost">Ti√™u hao 15 l√Ω tr√≠</span>
                  <span class="spread-requirement">C·∫ßn s·ªë ng√†y ·ªü tr∆∞·ªùng ‚â•7</span>
                </button>
                <button class="spread-btn advanced" data-spread="celtic" data-cost="20" data-requirement="14">
                  <span class="spread-icon">üïØÔ∏è</span>
                  <span class="spread-name">Th·∫≠p T·ª± Celtic</span>
                  <span class="spread-cost">Ti√™u hao 20 l√Ω tr√≠</span>
                  <span class="spread-requirement">C·∫ßn s·ªë ng√†y ·ªü tr∆∞·ªùng ‚â•14</span>
                </button>
                <button class="spread-btn advanced" data-spread="zodiac" data-cost="25" data-requirement="21">
                  <span class="spread-icon">üåü</span>
                  <span class="spread-name">M∆∞·ªùi Hai Cung Ho√†ng ƒê·∫°o</span>
                  <span class="spread-cost">Ti√™u hao 25 l√Ω tr√≠</span>
                  <span class="spread-requirement">C·∫ßn s·ªë ng√†y ·ªü tr∆∞·ªùng ‚â•21</span>
                </button>
              </div>
            </div>

            <div class="tarot-result" id="tarot-result" style="display: none">
              <h3 class="rules-section-title">K·∫øt qu·∫£ b√≥i</h3>
              <div id="tarot-cards" class="tarot-cards"></div>
              <div id="tarot-interpretation" class="tarot-interpretation"></div>
              <div id="tarot-effects" class="tarot-effects"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="shrine-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content" style="max-width: 600px; width: 90%">
        <div class="rules-modal-header">
          <h2 class="rules-title">‚õ©Ô∏è ƒê·ªÅn Th·ªù T√¢m H·ªìn</h2>
          <button id="close-shrine-btn" class="close-rules-btn">√ó</button>
        </div>
        <div class="rules-modal-body">
          <div id="omikuji-result-display" class="omikuji-container" style="display: none">
            <div class="omikuji-fortune"></div>
            <div class="omikuji-desc"></div>
            <ul class="omikuji-items"></ul>
          </div>

          <div id="shrine-prompt" style="text-align: center; color: #8b6914; margin: 30px 0; font-size: 1.1rem">
            Vui l√≤ng c√πng c·ªông s·ª± ƒë·∫øn tham b√°i tr∆∞·ªõc.
          </div>

          <div style="display: flex; gap: 10px; margin-bottom: 15px">
            <button
              id="shrine-pray-btn"
              class="shrine-btn"
              style="
                flex: 1;
                padding: 12px 20px;
                background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(37, 99, 235, 0.8));
                border: none;
                border-radius: 8px;
                color: #fff;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
              "
            >
              C√πng nhau tham b√°i
            </button>
            <button
              id="shrine-draw-btn"
              class="shrine-btn"
              style="
                flex: 1;
                padding: 12px 20px;
                background: linear-gradient(135deg, rgba(168, 85, 247, 0.8), rgba(147, 51, 234, 0.8));
                border: none;
                border-radius: 8px;
                color: #fff;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
              "
              disabled
            >
              L·∫Øc ·ªëng xƒÉm
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="world-map-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content" style="max-width: 95%; max-height: 95%; width: 900px">
        <div class="rules-modal-header">
          <h2 class="rules-title">B·∫£n ƒë·ªì th·∫ø gi·ªõi Tracen</h2>
          <button id="close-world-map-btn" class="close-rules-btn">√ó</button>
        </div>
        <div class="rules-modal-body" style="padding: 0">
          <div class="world-map-container">
            <div
              class="map-wrapper"
              style="
                position: relative;
                overflow: auto;
                max-height: 70vh;
                border: 2px solid #8b4513;
                border-radius: 8px;
              "
            >
              <img
                id="world-map-image"
                src="https://i.ibb.co/B2hJkB5J/image.png"
                alt="B·∫£n ƒë·ªì th·∫ø gi·ªõi Tracen"
                style="width: 100%; height: auto; display: block"
              />
              <div
                id="map-markers-container"
                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none"
              ></div>
            </div>
            <div
              class="map-legend"
              style="
                margin-top: 15px;
                padding: 15px;
                background: rgba(139, 105, 20, 0.1);
                border: 1px solid rgba(139, 105, 20, 0.3);
                border-radius: 6px;
              "
            >
              <h4 style="margin: 0 0 10px 0; color: #8b4513">Ch√∫ gi·∫£i lo·∫°i ƒë·ªãa ƒëi·ªÉm:</h4>
              <div style="display: flex; flex-wrap: wrap; gap: 15px; font-size: 12px">
                <div style="display: flex; align-items: center; gap: 5px">
                  <div style="width: 12px; height: 12px; background: #dc3545; border-radius: 50%"></div>
                  <span>Tr∆∞·ªùng ƒëua</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px">
                  <div style="width: 12px; height: 12px; background: #007bff; border-radius: 50%"></div>
                  <span>Th√†nh ph·ªë</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px">
                  <div style="width: 12px; height: 12px; background: #28a745; border-radius: 50%"></div>
                  <span>Danh lam th·∫Øng c·∫£nh</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px">
                  <div style="width: 12px; height: 12px; background: #6f42c1; border-radius: 50%"></div>
                  <span>Ki·∫øn tr√∫c ƒë·ªãa danh</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px">
                  <div style="width: 12px; height: 12px; background: #fd7e14; border-radius: 50%"></div>
                  <span>C∆° s·ªü v·∫≠t ch·∫•t</span>
                </div>
              </div>
            </div>
          </div>
          <div
            id="location-detail-panel"
            style="
              display: none;
              margin-top: 15px;
              padding: 15px;
              background: rgba(139, 105, 20, 0.1);
              border: 1px solid rgba(139, 105, 20, 0.3);
              border-radius: 6px;
            "
          >
            <h4 id="location-detail-name" style="margin: 0 0 8px 0; color: #8b4513"></h4>
            <div id="location-detail-type" style="font-size: 12px; color: #8b4513; margin-bottom: 8px"></div>
            <div id="location-detail-description" style="color: #654321; line-height: 1.4"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="quick-map-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content" style="max-width: 90%; max-height: 95%; width: 800px; height: 90vh">
        <button
          id="close-quick-map-btn"
          class="close-rules-btn"
          style="
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 1000;
            font-size: 18px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            padding: 0;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
          "
        >
          √ó
        </button>
        <div
          id="map-container"
          style="
            position: relative;
            width: 100%;
            height: 90vh;
            overflow: auto;
            transform-origin: center center;
            transition: transform 0.2s ease;
          "
        >
          <img
            id="quick-map-image"
            src="https://i.ibb.co/DDNP3GzH/image.png"
            alt="B·∫£n ƒë·ªì H·ªçc vi·ªán Tracen"
            style="width: 150%; height: auto; display: block; user-select: none; pointer-events: none"
          />
          <div
            id="quick-map-markers-container"
            style="
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              pointer-events: none;
              transform-origin: center center;
            "
          ></div>
          <div
            class="map-zoom-controls"
            style="
              position: absolute;
              top: 10px;
              left: 10px;
              display: flex;
              flex-direction: column;
              gap: 3px;
              z-index: 100;
            "
          >
            <button
              id="zoom-in-btn"
              class="compact-button"
              style="width: 30px; height: 30px; padding: 0; font-size: 16px; background: rgba(255, 255, 255, 0.9)"
            >
              +
            </button>
            <button
              id="zoom-out-btn"
              class="compact-button"
              style="width: 30px; height: 30px; padding: 0; font-size: 16px; background: rgba(255, 255, 255, 0.9)"
            >
              ‚àí
            </button>
            <button
              id="zoom-reset-btn"
              class="compact-button"
              style="width: 30px; height: 30px; padding: 0; font-size: 12px; background: rgba(255, 255, 255, 0.9)"
            >
              ‚åÇ
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="achievement-modal" class="rules-modal" style="display: none; z-index: 10001">
      <div
        class="rules-modal-content"
        style="
          max-width: 1000px;
          width: 90%;
          max-height: 90vh;
          border-radius: 16px;
          box-shadow:
            0 20px 60px rgba(0, 0, 0, 0.4),
            0 0 0 1px rgba(212, 175, 55, 0.2);
          background: linear-gradient(135deg, #fff9e6 0%, #f5ead5 50%, #ede4d3 100%);
          border: 3px solid #d4af37;
          display: flex;
          flex-direction: column;
          position: relative;
          overflow: hidden;
        "
      >
        <div
          style="
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #d4af37 0%, #ffd700 50%, #d4af37 100%);
            z-index: 1;
          "
        ></div>
        <div
          class="rules-modal-header"
          style="
            padding: 25px 30px;
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 50%, #d4af37 100%);
            border-radius: 16px 16px 0 0;
            color: #2c1810;
            flex-shrink: 0;
            position: relative;
            border-bottom: 3px solid rgba(139, 105, 20, 0.3);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          "
        >
          <h2
            class="rules-title"
            style="
              margin: 0;
              font-size: 24px;
              display: flex;
              align-items: center;
              gap: 10px;
              font-weight: bold;
              text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            "
          >
            üèÜ H·ªá th·ªëng th√†nh t·ª±u
          </h2>
          <button
            id="close-achievement-btn"
            class="close-rules-btn"
            style="
              color: #2c1810;
              font-size: 24px;
              font-weight: bold;
              background: rgba(44, 24, 16, 0.15);
              border: 2px solid rgba(44, 24, 16, 0.2);
              border-radius: 50%;
              width: 36px;
              height: 36px;
              display: flex;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              transition: all 0.2s;
            "
            onmouseover="this.style.background='rgba(44, 24, 16, 0.3)'; this.style.transform='rotate(90deg)'"
            onmouseout="this.style.background='rgba(44, 24, 16, 0.15)'; this.style.transform='rotate(0deg)'"
          >
            √ó
          </button>
        </div>
        <div
          class="rules-modal-body"
          style="
            padding: 30px;
            flex: 1;
            overflow-y: auto;
            background: linear-gradient(to bottom, rgba(255, 249, 230, 0.3) 0%, transparent 100%);
          "
        >
          <div
            id="achievement-stats"
            style="
              background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(184, 134, 11, 0.1) 100%);
              padding: 20px;
              border-radius: 12px;
              margin-bottom: 25px;
              border: 2px solid rgba(212, 175, 55, 0.4);
              text-align: center;
              box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            "
          >
            <div
              style="
                font-weight: bold;
                color: #8b4513;
                margin-bottom: 10px;
                font-size: 1.1em;
                text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
              "
            >
              Ti·∫øn ƒë·ªô th√†nh t·ª±u
            </div>
            <div id="achievement-progress" style="color: #654321; font-size: 1.05em; font-weight: 600"></div>
          </div>
          <div
            id="achievement-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
              gap: 22px;
              align-content: flex-start;
            "
          >
          </div>
        </div>
      </div>
    </div>

    <div id="achievement-detail-modal" class="rules-modal" style="display: none; z-index: 10002">
      <div
        class="rules-modal-content"
        style="
          max-width: 550px;
          width: 90%;
          border-radius: 16px;
          box-shadow:
            0 20px 60px rgba(0, 0, 0, 0.4),
            0 0 0 1px rgba(212, 175, 55, 0.2);
          background: linear-gradient(135deg, #fff9e6 0%, #f5ead5 50%, #ede4d3 100%);
          border: 3px solid #d4af37;
          position: relative;
          overflow: hidden;
        "
      >
        <div
          style="
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #d4af37 0%, #ffd700 50%, #d4af37 100%);
            z-index: 1;
          "
        ></div>
        <div
          class="rules-modal-header"
          style="
            padding: 22px 28px;
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 50%, #d4af37 100%);
            border-radius: 16px 16px 0 0;
            color: #2c1810;
            position: relative;
            border-bottom: 3px solid rgba(139, 105, 20, 0.3);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          "
        >
          <h2
            class="rules-title"
            style="
              margin: 0;
              font-size: 20px;
              display: flex;
              align-items: center;
              gap: 10px;
              font-weight: bold;
              text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            "
          >
            üèÜ Chi ti·∫øt th√†nh t·ª±u
          </h2>
          <button
            id="close-achievement-detail-btn"
            class="close-rules-btn"
            style="
              color: #2c1810;
              font-size: 22px;
              font-weight: bold;
              background: rgba(44, 24, 16, 0.15);
              border: 2px solid rgba(44, 24, 16, 0.2);
              border-radius: 50%;
              width: 32px;
              height: 32px;
              display: flex;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              transition: all 0.2s;
            "
            onmouseover="this.style.background='rgba(44, 24, 16, 0.3)'; this.style.transform='rotate(90deg)'"
            onmouseout="this.style.background='rgba(44, 24, 16, 0.15)'; this.style.transform='rotate(0deg)'"
          >
            √ó
          </button>
        </div>
        <div
          class="rules-modal-body"
          style="padding: 30px; background: linear-gradient(to bottom, rgba(255, 249, 230, 0.3) 0%, transparent 100%)"
        >
          <div style="text-align: center; margin-bottom: 25px">
            <div
              id="achievement-detail-icon"
              style="font-size: 4em; margin-bottom: 15px; filter: drop-shadow(0 4px 8px rgba(212, 175, 55, 0.4))"
            >
              üèÜ
            </div>
            <div
              id="achievement-detail-name"
              style="
                font-size: 1.6em;
                font-weight: bold;
                color: #8b4513;
                margin-bottom: 12px;
                text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
              "
            ></div>
            <div
              id="achievement-detail-quality"
              style="
                display: inline-block;
                padding: 6px 16px;
                border-radius: 16px;
                font-size: 0.95em;
                font-weight: bold;
                color: white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
              "
            ></div>
          </div>
          <div
            id="achievement-detail-description"
            style="
              margin-bottom: 20px;
              color: #654321;
              text-align: center;
              line-height: 1.6;
              font-size: 1.05em;
              padding: 15px;
              background: rgba(255, 255, 255, 0.5);
              border-radius: 10px;
              border: 1px solid rgba(212, 175, 55, 0.2);
            "
          ></div>
          <div
            id="achievement-detail-requirement"
            style="
              background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(184, 134, 11, 0.1) 100%);
              padding: 18px;
              border-radius: 12px;
              margin-bottom: 18px;
              border: 2px solid rgba(212, 175, 55, 0.4);
              box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            "
          >
            <div
              style="
                font-weight: bold;
                color: #8b4513;
                margin-bottom: 8px;
                font-size: 1.05em;
                text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
              "
            >
              ƒêi·ªÅu ki·ªán ho√†n th√†nh:
            </div>
            <div id="achievement-detail-req-text" style="color: #654321; line-height: 1.5; font-size: 1em"></div>
          </div>
          <div
            id="achievement-detail-reward"
            style="
              background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(184, 134, 11, 0.1) 100%);
              padding: 18px;
              border-radius: 12px;
              border: 2px solid rgba(212, 175, 55, 0.4);
              box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            "
          >
            <div
              style="
                font-weight: bold;
                color: #8b4513;
                margin-bottom: 8px;
                font-size: 1.05em;
                text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
              "
            >
              C·∫£m nghƒ© ho√†n th√†nh:
            </div>
            <div
              id="achievement-detail-completion-text"
              style="color: #654321; font-style: italic; line-height: 1.6; font-size: 1em"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <div id="music-player-modal" class="rules-modal" style="display: none; z-index: 10001">
      <div
        class="rules-modal-content"
        style="
          max-width: 400px;
          width: 90%;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
          background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 100%);
          border: 3px solid #8b6914;
        "
      >
        <div
          class="rules-modal-header"
          style="
            padding: 20px 25px;
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
            border-radius: 12px 12px 0 0;
            color: #2c1810;
          "
        >
          <h2 class="rules-title" style="margin: 0; font-size: 18px; display: flex; align-items: center; gap: 8px">
            üéµ Tr√¨nh ph√°t nh·∫°c
          </h2>
          <button
            id="close-music-player-btn"
            class="close-rules-btn"
            style="
              color: #2c1810;
              font-size: 20px;
              font-weight: bold;
              background: rgba(44, 24, 16, 0.1);
              border: none;
              border-radius: 50%;
              width: 28px;
              height: 28px;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            √ó
          </button>
        </div>
        <div class="rules-modal-body" style="padding: 25px">
          <div id="music-player-content">
            <div style="text-align: center; margin-bottom: 20px">
              <div
                id="current-track-name"
                style="font-size: 16px; font-weight: bold; margin-bottom: 8px; color: #8b4513"
              >
                Ch∆∞a ch·ªçn nh·∫°c
              </div>
              <div id="current-track-time" style="font-size: 12px; color: #666">00:00 / 00:00</div>
            </div>

            <div style="margin-bottom: 20px">
              <input
                type="range"
                id="music-progress-slider"
                min="0"
                max="100"
                value="0"
                style="width: 100%; accent-color: #8b4513; margin-bottom: 5px"
              />
              <div style="display: flex; justify-content: space-between; font-size: 11px; color: #666">
                <span id="current-time-display">00:00</span>
                <span id="total-time-display">00:00</span>
              </div>
            </div>

            <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 25px">
              <button
                id="music-prev-btn"
                class="music-control-btn"
                style="
                  width: 40px;
                  height: 40px;
                  border-radius: 50%;
                  background: rgba(139, 69, 19, 0.1);
                  border: 1px solid rgba(139, 69, 19, 0.3);
                  color: #8b4513;
                  font-size: 16px;
                "
              >
                ‚èÆ
              </button>
              <button
                id="music-play-pause-btn"
                class="music-control-btn"
                style="
                  width: 50px;
                  height: 50px;
                  border-radius: 50%;
                  background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
                  border: none;
                  color: white;
                  font-size: 18px;
                "
              >
                ‚ñ∂
              </button>
              <button
                id="music-next-btn"
                class="music-control-btn"
                style="
                  width: 40px;
                  height: 40px;
                  border-radius: 50%;
                  background: rgba(139, 69, 19, 0.1);
                  border: 1px solid rgba(139, 69, 19, 0.3);
                  color: #8b4513;
                  font-size: 16px;
                "
              >
                ‚è≠
              </button>
            </div>

            <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px">
              <span style="font-size: 12px; color: #666">Ch·∫ø ƒë·ªô ph√°t:</span>
              <button
                id="music-mode-btn"
                class="music-control-btn"
                style="
                  width: 45px;
                  height: 35px;
                  border-radius: 6px;
                  background: rgba(139, 69, 19, 0.1);
                  border: 1px solid rgba(139, 69, 19, 0.3);
                  color: #8b4513;
                  font-size: 18px;
                  cursor: pointer;
                  transition: all 0.2s;
                  position: relative;
                  z-index: 10;
                "
                title="Ph√°t tu·∫ßn t·ª±"
              >
                ‚ñ∂Ô∏è
              </button>
            </div>

            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px">
              <span style="font-size: 14px; color: #8b4513">üîä</span>
              <input
                type="range"
                id="music-volume-slider"
                min="0"
                max="100"
                value="50"
                style="flex: 1; accent-color: #8b4513"
              />
              <span id="volume-display" style="font-size: 12px; color: #666; min-width: 30px">50%</span>
            </div>

            <div
              style="
                background: rgba(139, 69, 19, 0.1);
                border: 1px solid rgba(139, 69, 19, 0.3);
                border-radius: 8px;
                padding: 10px;
              "
            >
              <div
                class="music-track"
                data-src="https://files.catbox.moe/yyq6oj.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">„ÄäKh√∫c nh·∫°c b√°o th·ª©c Hakimi„Äãüê±</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/qfwwgp.flac"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">„Éü„ÉÉ„Éâ„Éä„Ç§„Éà„Éª„Ç®„Éî„É≠„Éº„Ç∞</div>
                <div style="font-size: 11px; color: #666">FLAC</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/jueda8.mp3"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">ƒê·∫°i ti·ªác Uma Musume! Di·ªÖu h√†nh ·∫©m th·ª±c</div>
                <div style="font-size: 11px; color: #666">MP3</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/2izau9.mp3"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">Tracen Ondo (C·ªßa Symboli Kris S)</div>
                <div style="font-size: 11px; color: #666">MP3</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/v0iy0a.mp3"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">V∆∞·ª£t qua (V∆∞·ª£t qua n√†o)</div>
                <div style="font-size: 11px; color: #666">MP3</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/k0r0id.mp3"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">Tracen Ondo (Game Size)</div>
                <div style="font-size: 11px; color: #666">MP3</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/okct8d.mp3"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">U.M.A. NEW WORLD!!</div>
                <div style="font-size: 11px; color: #666">MP3</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/146x8h.mp3"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">GIRLS' LEGEND U</div>
                <div style="font-size: 11px; color: #666">MP3</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/agi8yx.mp3"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">Glorious MomentÔºÅ</div>
                <div style="font-size: 11px; color: #666">MP3</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/umai3u.m4a"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">Nh·∫°c k·ª∑ ni·ªám 1</div>
                <div style="font-size: 11px; color: #666">M4A</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/j0qaqf.m4a"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">Nh·∫°c k·ª∑ ni·ªám 2</div>
                <div style="font-size: 11px; color: #666">M4A</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/wlhqc9.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">123 Em Ha Anh</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/ui1gwf.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">Hakimi Ng·ªçt Ng√†o N√†y„ÄêHakimi Thu·∫ßn Khi·∫øt„Äë</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/34edv0.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">
                  „ÄêHakimi„ÄëConundrum N√≥ Ha kh√≠ r·ªìi, h√¥m qua Ha ƒë·∫•y, nh∆∞ng l·∫° l√†, h√¥m kia n√≥ ƒë√£ ch·∫øt r·ªìi
                </div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/ppchr5.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">Chuy·ªán c≈© ch·ªâ c√≥ th·ªÉ Ha Ki</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/s8c70r.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">Ki Mi M√†u H ·ªì n g</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/dchs4n.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">„ÄêHakimi FM„ÄëKi Mi Tr√™n ƒê·∫ßu L∆∞·ª°i</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/nhrhjl.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">„ÄêQuy·ªÅn Ki Long„ÄëJi MI YOU</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/en0iq0.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">„ÄêHakimi FM„Äë_Hamo</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>

              <div
                class="music-track"
                data-src="https://files.catbox.moe/bq9xsi.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">„ÄêKi N·ªãch„ÄëHuy·ªÅn n·ªãch vang l√™n, Ki Mi l√™n s√†n</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/7zivog.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">
                  „ÄêB√π file„ÄëüéµMambo ùëµùíê ùë¥ùíêùíìùíÜüéµKh√¥ng c√≤n Mambo (B·∫£n ƒë·∫ßy ƒë·ªß)
                </div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/8gc10g.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">„ÄêB·∫£n ƒë·∫ßy ƒë·ªß„ÄëC√∫ Ha cu·ªëi c√πng</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/33d0tw.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">„ÄêNh·∫°c Hakimi„ÄëKh√¥ng th·ªÉ kh√¥ng Ha</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/23dd5p.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">
                  „ÄäB·∫≠t l·ª≠a Ki (Hakimi)„ÄãB·∫£n ƒë·∫ßy ƒë·ªß, Hakimi a ƒê·∫≠u xanh nam b·∫Øc!
                </div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/87jhj8.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">Ki Mi n√≥i b·∫£n ƒë·∫ßy ƒë·ªß</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/6yjali.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">Xu·∫•t s∆°n (Hakimi) b·∫£n ƒë·∫ßy ƒë·ªß</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/xt6sla.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">Lam Li√™n Ha</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/ss1zds.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">Ki Nh·∫£y L·∫ßu</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/o1gorl.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">T√¥i b·ªã k·∫πt ·ªü qu√™ h∆∞∆°ng Haki</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/h3rwx1.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">Hakimi_talking to the moon</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/idekh0.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">Mambo ùëµùíê ùë¥ùíêùíìùíÜ Kh√¥ng c√≤n Mambo (B·∫£n ƒë·∫ßy ƒë·ªß)</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/sudv0z.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">Some Ki Mi just like this</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="location-confirm-modal" class="rules-modal" style="display: none; z-index: 10001">
      <div
        class="rules-modal-content"
        style="
          max-width: 480px;
          width: 95%;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
          background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        "
      >
        <div
          class="rules-modal-header"
          style="
            padding: 20px 25px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border-radius: 12px 12px 0 0;
            color: white;
          "
        >
          <h2 class="rules-title" style="margin: 0; font-size: 20px; display: flex; align-items: center; gap: 8px">
            üó∫Ô∏è ƒêi ƒë·∫øn ƒë·ªãa ƒëi·ªÉm
          </h2>
          <button
            id="close-location-confirm-btn"
            class="close-rules-btn"
            style="
              color: white;
              font-size: 24px;
              font-weight: bold;
              background: rgba(255, 255, 255, 0.2);
              border: none;
              border-radius: 50%;
              width: 30px;
              height: 30px;
            "
          >
            √ó
          </button>
        </div>
        <div class="rules-modal-body" style="padding: 25px">
          <div id="location-confirm-content">
            <div style="margin-bottom: 25px; text-align: center">
              <div
                id="confirm-location-name"
                style="
                  font-weight: bold;
                  font-size: 22px;
                  color: #2c3e50;
                  margin-bottom: 12px;
                  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
                "
              ></div>
              <div
                id="confirm-location-description"
                style="
                  font-size: 15px;
                  color: #495057;
                  line-height: 1.6;
                  max-height: 100px;
                  overflow-y: auto;
                  background: rgba(255, 255, 255, 0.7);
                  padding: 15px;
                  border-radius: 8px;
                  border-left: 4px solid #007bff;
                "
              ></div>
            </div>

            <div style="display: flex; gap: 15px; justify-content: center">
              <button
                id="cancel-location-move"
                class="compact-button"
                style="
                  background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
                  color: white;
                  padding: 12px 24px;
                  font-size: 16px;
                  border-radius: 8px;
                  border: none;
                  box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
                  transition: all 0.3s ease;
                "
              >
                ‚ùå H·ªßy
              </button>
              <button
                id="confirm-location-move"
                class="compact-button"
                style="
                  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                  color: white;
                  padding: 12px 24px;
                  font-size: 16px;
                  border-radius: 8px;
                  border: none;
                  box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                  transition: all 0.3s ease;
                "
              >
                üöÄ ƒêi ƒë·∫øn
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="command-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content">
        <div class="rules-modal-header">
          <h2 class="rules-title">Qu·∫£n l√Ω l·ªánh</h2>

          <button id="close-command-btn" class="close-rules-btn">√ó</button>
        </div>

        <div class="rules-modal-body">
          <div class="command-section">
            <div class="command-list">
            </div>

            <div class="command-footer">
              <button class="clear-all-btn">X√≥a t·∫•t c·∫£</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <audio id="page-flip-sound" preload="auto">
      <source src="https://files.catbox.moe/5ppdp9.mp3" type="audio/mpeg" />
    </audio>

    <audio id="talent-sound" preload="auto">
      <source src="https://files.catbox.moe/5091vt.mp3" type="audio/mpeg" />
    </audio>

    <audio id="tarot-shuffle" preload="auto">
      <source src="https://files.catbox.moe/b4b019.mp3" type="audio/mpeg" />
    </audio>

    <audio id="music-player-audio" preload="auto"></audio>

    <audio id="bgm-track1" class="music-source" src="https://files.catbox.moe/umai3u.m4a" loop preload="auto"></audio>
    <audio id="bgm-track2" class="music-source" src="https://files.catbox.moe/j0qaqf.m4a" loop preload="auto"></audio>

    <audio id="save-load-sound" preload="auto">
      
      <source src="https://files.catbox.moe/vbrvns.mp3" type="audio/mpeg" />
      
    </audio>

    <audio id="danger-rules-sound" preload="auto">
      <source src="https://files.catbox.moe/zxb18s.mp3" type="audio/mpeg" />
    </audio>

    <audio id="item-detail-sound" preload="auto">
      <source src="https://files.catbox.moe/412btp.mp3" type="audio/mpeg" />
    </audio>

    <audio id="uma-roster-sound" preload="auto">
      <source src="https://files.catbox.moe/zxb18s.mp3" type="audio/mpeg" />
    </audio>

    <script>

      let pendingActions = [];

      let giftSelectionMode = null;

      let skillSelectionMode = null;

      window.pendingActions = pendingActions;
      window.giftSelectionMode = giftSelectionMode;
      window.skillSelectionMode = skillSelectionMode;

      $(document).ready(function () {
        loadPendingActions();

        updateActionIcons();

        updateInventoryCommandManager();

        setInterval(function () {
          updateInventoryCommandManager();
        }, 2000);
      });

      function addPendingAction(action, itemName, extraData = {}) {
        const actionObj = {
          action: action,

          itemName: itemName,

          ...extraData,
        };

        pendingActions.push(actionObj);

        savePendingActions();

        updateActionIcons();

        updateInventoryCommandManager();

        window.pendingActions = pendingActions;
      }

      function removeAction(index) {
        pendingActions.splice(index, 1);

        savePendingActions();

        updateActionIcons();

        updateInventoryCommandManager();
      }

      function clearAllActions() {
        if (pendingActions.length === 0) {
          return;
        }
        pendingActions = [];
        window.pendingActions = pendingActions;

        savePendingActions();

        updateActionIcons();

        updateInventoryCommandManager();
      }

      function toggleItemLock(itemName, button) {
        const isLocked = button.text() === 'M·ªü kh√≥a';

        button.text(isLocked ? 'Kh√≥a' : 'M·ªü kh√≥a');

        button.css('background', isLocked ? '#4a5568' : '#e53e3e');

        const discardBtn = button.siblings('.item-discard-btn');

        if (isLocked) {
          discardBtn.prop('disabled', false).css('opacity', '1');
        } else {
          discardBtn.prop('disabled', true).css('opacity', '0.5');
        }
      }

      function startGiftSelection(itemName) {
        showGiftHint();

        highlightCharacterCards();

        giftSelectionMode = {
          active: true,

          itemName: itemName,

          startTime: Date.now(),
        };
        window.giftSelectionMode = giftSelectionMode;

        setTimeout(() => {
          if (giftSelectionMode?.active) {
            cancelGiftSelection();
          }
        }, 30000);
      }

      function showGiftHint() {

        $('.gift-selection-hint').remove();

        const hint = $('<div class="gift-selection-hint">').html(`

            <div class="hint-content">

              <span class="hint-icon">üéÅ</span>

              <span class="hint-text">Vui l√≤ng nh·∫•p v√†o th·∫ª Uma Musume mu·ªën t·∫∑ng qu√†</span>

              <button class="hint-close" onclick="$(this).closest('.gift-selection-hint').remove()">√ó</button>

            </div>

          `);

        $('body').append(hint);

        setTimeout(() => {
          hint.remove();
        }, 3000);
      }

      function highlightCharacterCards() {
        $('.character-card, .uma-item, .character-item').addClass('gift-selectable skill-selectable');
      }
      $(document).on('click', '.gift-selectable, .skill-selectable, .uma-item, .character-card', function (e) {
        if (window.skillSelectionMode && window.skillSelectionMode.active) {
          if (
            $(this).hasClass('skill-selectable') ||
            $(this).hasClass('uma-item') ||
            $(this).hasClass('character-card')
          ) {
            e.stopPropagation();
            e.preventDefault();

            const characterName = getCharacterNameFromCard($(this));
            const characterId = getCharacterIdFromCard($(this));
            const actionText = `[S·ª≠ d·ª•ng k·ªπ nƒÉng: ${window.skillSelectionMode.skillName} l√™n ${characterName}]`;
            const actionInput = document.getElementById('action-input');
            if (actionInput) {
              actionInput.value = actionText;
              actionInput.focus();
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage(`ƒê√£ s·ª≠ d·ª•ng ${window.skillSelectionMode.skillName} l√™n ${characterName}`);
              }
            }

            cancelSkillSelection();
            return false;
          }
        }
        if (window.giftSelectionMode && window.giftSelectionMode.active) {
          if (
            $(this).hasClass('gift-selectable') ||
            $(this).hasClass('uma-item') ||
            $(this).hasClass('character-card')
          ) {
            e.stopPropagation();
            e.preventDefault();

            const characterName = getCharacterNameFromCard($(this));
            const characterId = getCharacterIdFromCard($(this));
            const actionText = `[T·∫∑ng ƒë·∫°o c·ª•: ${window.giftSelectionMode.itemName} cho ${characterName}]`;
            const actionInput = document.getElementById('action-input');
            if (actionInput) {
              actionInput.value = actionText;
              actionInput.focus();
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage(`ƒê√£ ƒëi·ªÅn ${actionText} v√†o √¥ nh·∫≠p`);
              }
            }

            cancelGiftSelection();
            return false;
          }
        }
      });

      function cancelGiftSelection() {
        clearGiftSelectionMode();

        giftSelectionMode = null;
        window.giftSelectionMode = null;
      }

      function clearGiftSelectionMode() {
        $('.gift-selectable').removeClass('gift-selectable');

        $('.skill-selectable').removeClass('skill-selectable');
      }

      function startSkillSelection(skillName, skillType) {
        showSkillHint();

        highlightCharacterCards();

        skillSelectionMode = {
          active: true,

          skillName: skillName,

          skillType: skillType,

          startTime: Date.now(),
        };
        window.skillSelectionMode = skillSelectionMode;

        setTimeout(() => {
          if (skillSelectionMode?.active) {
            cancelSkillSelection();
          }
        }, 30000);
      }

      function showSkillHint() {

        $('.skill-selection-hint').remove();

        const hint = $('<div class="skill-selection-hint gift-selection-hint">').html(`

            <div class="hint-content">

              <span class="hint-icon">‚ö°</span>

              <span class="hint-text">Vui l√≤ng nh·∫•p v√†o m·ª•c ti√™u mu·ªën s·ª≠ d·ª•ng k·ªπ nƒÉng l√™n Uma Musume</span>

              <button class="hint-close" onclick="$(this).closest('.skill-selection-hint').remove(); cancelSkillSelection();">√ó</button>

            </div>

          `);

        $('body').append(hint);

        setTimeout(() => {
          hint.remove();
        }, 3000);
      }

      function cancelSkillSelection() {
        clearSkillSelectionMode();

        skillSelectionMode = null;
        window.skillSelectionMode = null;
      }

      function clearSkillSelectionMode() {
        $('.skill-selectable').removeClass('skill-selectable');
      }

      window.applyCustomSkillTarget = function (skillName, skillType) {
        const customTarget = $('#custom-skill-target').val().trim();

        if (!customTarget) {
          alert('Vui l√≤ng nh·∫≠p m·ª•c ti√™u');

          return;
        }

        addPendingAction('skill', skillName, {
          target: customTarget,

          skillType: skillType,
        });

        $('.skill-selection-hint').remove();

        cancelSkillSelection();
      };

      function getCharacterNameFromCard(card) {
        const nameElement = card.find('.character-name, .uma-name, .name');

        return nameElement.length ? nameElement.text().trim() : 'Nh√¢n v·∫≠t kh√¥ng x√°c ƒë·ªãnh';
      }

      function getCharacterIdFromCard(card) {
        return card.data('character-id') || card.attr('id') || 'unknown';
      }

      function savePendingActions() {
        localStorage.setItem('item_pending_actions', JSON.stringify(pendingActions));
      }

      function loadPendingActions() {
        const saved = localStorage.getItem('item_pending_actions');

        pendingActions = saved ? JSON.parse(saved) : [];
      }

      function updateActionIcons() {
        const timeLocationBar = $('.time-location-bar');

        if (!timeLocationBar.length) return;

        timeLocationBar.find('.action-icons-container').remove();

        if (pendingActions.length === 0) return;

        const actionCounts = {
          use: 0,
          discard: 0,
          gift: 0,
          lock: 0,
          skill: 0,
          move: 0,
          meal: 0,
          borrow: 0,
          game: 0,
          chat: 0,
          rest: 0,
        };

        pendingActions.forEach(action => {
          if (actionCounts.hasOwnProperty(action.action)) {
            actionCounts[action.action]++;
          }
        });

        const icons = [];

        if (actionCounts.use > 0) {
          icons.push(
            `<span class="action-icon use-icon" title="S·ª≠ d·ª•ng ${actionCounts.use} ƒë·∫°o c·ª•"> (${actionCounts.use})</span>`,
          );
        }

        if (actionCounts.discard > 0) {
          icons.push(
            `<span class="action-icon discard-icon" title="V·ª©t b·ªè ${actionCounts.discard} ƒë·∫°o c·ª•">üóëÔ∏è (${actionCounts.discard})</span>`,
          );
        }

        if (actionCounts.gift > 0) {
          icons.push(
            `<span class="action-icon gift-icon" title="T·∫∑ng ${actionCounts.gift} ƒë·∫°o c·ª•">üéÅ (${actionCounts.gift})</span>`,
          );
        }

        if (actionCounts.lock > 0) {
          icons.push(
            `<span class="action-icon lock-icon" title="Kh√≥a ${actionCounts.lock} ƒë·∫°o c·ª•">üîí (${actionCounts.lock})</span>`,
          );
        }

        if (actionCounts.skill > 0) {
          icons.push(
            `<span class="action-icon skill-icon" title="S·ª≠ d·ª•ng ${actionCounts.skill} k·ªπ nƒÉng">‚ö° (${actionCounts.skill})</span>`,
          );
        }

        if (actionCounts.move > 0) {
          icons.push(
            `<span class="action-icon move-icon" title="ƒêi ƒë·∫øn ${actionCounts.move} ƒë·ªãa ƒëi·ªÉm">üó∫Ô∏è (${actionCounts.move})</span>`,
          );
        }

        if (actionCounts.meal > 0) {
          icons.push(
            `<span class="action-icon meal-icon" title="ƒÇn th√™m ${actionCounts.meal} l·∫ßn">üçΩÔ∏è (${actionCounts.meal})</span>`,
          );
        }

        if (actionCounts.borrow > 0) {
          icons.push(
            `<span class="action-icon borrow-icon" title="M∆∞·ª£n ti·ªÅn ${actionCounts.borrow} l·∫ßn">üí∞ (${actionCounts.borrow})</span>`,
          );
        }

        if (actionCounts.game > 0) {
          icons.push(
            `<span class="action-icon game-icon" title="Ch∆°i game ${actionCounts.game} l·∫ßn">üéÆ (${actionCounts.game})</span>`,
          );
        }

        if (actionCounts.chat > 0) {
          icons.push(
            `<span class="action-icon chat-icon" title="Tr√≤ chuy·ªán ${actionCounts.chat} l·∫ßn">üí¨ (${actionCounts.chat})</span>`,
          );
        }

        if (actionCounts.rest > 0) {
          icons.push(`<span class="action-icon rest-icon" title="Ngh·ªâ ng∆°i ƒë·∫øn tu·∫ßn sau">üò¥ (${actionCounts.rest})</span>`);
        }

        if (icons.length > 0) {
          const iconsContainer = $('<div class="action-icons-container">').html(icons.join(''));

          timeLocationBar.find('.current-location').after(iconsContainer);
        }
      }

      function updateInventoryCommandManager() {
        const commandDot = $('#command-manager-dot');

        if (pendingActions.length > 0) {
          commandDot.show();

          commandDot.find('.dot-count').text(pendingActions.length);

          commandDot.off('click').on('click', function () {
            toggleCommandManager();
          });
        } else {
          commandDot.hide();
        }
      }

      function toggleCommandManager() {
        const commandModal = $('#command-modal');

        const isVisible = commandModal.is(':visible');

        if (isVisible) {
          commandModal.hide();
        } else {
          commandModal.show();

          updateCommandList();
        }
      }

      $(document).on('click', '#close-command-btn', function () {
        $('#command-modal').hide();
      });

      $(document).on('click', '#command-modal', function (e) {
        if (e.target === this) {
          $('#command-modal').hide();
        }
      });

      $(document).on('click', '.clear-all-btn', function () {
        clearAllActions();

        updateCommandList();
      });

      function updateCommandList() {
        const commandList = $('#command-modal .command-list');

        if (pendingActions.length === 0) {
          commandList.html('<div class="empty-command">T·∫°m kh√¥ng c√≥ l·ªánh ch·ªù th·ª±c hi·ªán</div>');

          return;
        }

        const commandItems = pendingActions

          .map(
            (action, index) => `

                <div class="command-item">

                  <div class="command-content">

                    <span class="command-icon">${getActionIcon(action.action)}</span>

                    <span class="command-text">${formatActionText(action)}</span>

                  </div>

                  <button class="remove-command-btn" onclick="removeAction(${index}); updateCommandList();">√ó</button>

                </div>

              `,
          )

          .join('');

        commandList.html(commandItems);
      }

      function getActionIcon(action) {
        const icons = {
          use: ' ',

          discard: 'üóëÔ∏è',

          gift: 'üéÅ',

          lock: 'üîí',

          skill: '‚ö°',

          meal: 'üçΩÔ∏è',

          borrow: 'üí∞',

          game: 'üéÆ',

          chat: 'üí¨',

          rest: 'üò¥',

          move: 'üö∂',
        };

        return icons[action] || 'üìù';
      }

      function formatActionText(action) {
        switch (action.action) {
          case 'use':
            let useText = `S·ª≠ d·ª•ng ƒë·∫°o c·ª• [${action.itemName}]`;
            if (action.itemData) {
              useText += `\nHi·ªáu qu·∫£: ${action.itemData.effect || 'Kh√¥ng c√≥ m√¥ t·∫£ hi·ªáu qu·∫£'}`;
              useText += `\nƒê·ªô hi·∫øm: ${action.itemData.rarity || 'Ph·ªï Th√¥ng'}`;
            }
            return useText;

          case 'move':
            let moveText = `ƒêi ƒë·∫øn [${action.itemName}]`;
            if (action.description) {
              moveText += `\nM√¥ t·∫£: ${action.description}`;
            }
            return moveText;

          case 'discard':
            let discardText = `V·ª©t b·ªè ƒë·∫°o c·ª• [${action.itemName}]`;
            if (action.itemData) {
              discardText += `\nM√¥ t·∫£: ${action.itemData.description || 'Kh√¥ng m√¥ t·∫£'}`;
            }
            return discardText;

          case 'gift':
            let giftText = `T·∫∑ng ƒë·∫°o c·ª• [${action.itemName}] cho [${action.characterName || action.target}]`;
            if (action.itemData) {
              giftText += `\nHi·ªáu qu·∫£: ${action.itemData.effect || 'Kh√¥ng c√≥ m√¥ t·∫£ hi·ªáu qu·∫£'}`;
            }
            return giftText;

          case 'lock':
            let lockText = `Kh√≥a ƒë·∫°o c·ª• [${action.itemName}]`;
            if (action.itemData) {
              lockText += `\nM√¥ t·∫£: ${action.itemData.description || 'Kh√¥ng m√¥ t·∫£'}`;
            }
            return lockText;

          case 'skill':
            let skillInfo = '';
            if (action.skillType && action.majorTalent) {
              const skillDetails = {
                defense: { name: 'K·ªπ NƒÉng Ph√≤ng Th·ªß', description: 'NƒÉng l·ª±c ph√≤ng th·ªß d·ª±a tr√™n Thi√™n ph√∫ H·ªá C∆∞·ªùng H√≥a, c√≥ th·ªÉ c∆∞·ªùng h√≥a s·ª©c ph√≤ng th·ªß b·∫£n th√¢n.' },
                rule_enhance: { name: 'Quy T·∫Øc Th·∫•u Th·ªã', description: 'NƒÉng l·ª±c th·∫•u th·ªã d·ª±a tr√™n Thi√™n ph√∫ H·ªá C∆∞·ªùng H√≥a, c√≥ th·ªÉ nh√¨n th·∫•u b·∫£n ch·∫•t c·ªßa quy t·∫Øc.' },
                chain_enhance: { name: 'Ki·ªÉm So√°t Xi·ªÅng X√≠ch', description: 'NƒÉng l·ª±c ki·ªÉm so√°t d·ª±a tr√™n Thi√™n ph√∫ H·ªá C∆∞·ªùng H√≥a, c√≥ th·ªÉ c∆∞·ªùng h√≥a hi·ªáu qu·∫£ tr√≥i bu·ªôc c·ªßa xi·ªÅng x√≠ch.' },
                rule_change: { name: 'S·ª≠a ƒê·ªïi Quy T·∫Øc', description: 'NƒÉng l·ª±c s·ª≠a ƒë·ªïi d·ª±a tr√™n Thi√™n ph√∫ H·ªá Bi·∫øn H√≥a, c√≥ th·ªÉ thay ƒë·ªïi quy t·∫Øc t·∫°m th·ªùi.' },
                emotion: { name: 'Thao T√∫ng T√¨nh C·∫£m', description: 'NƒÉng l·ª±c thao t√∫ng d·ª±a tr√™n Thi√™n ph√∫ H·ªá Bi·∫øn H√≥a, c√≥ th·ªÉ Thao T√∫ng T√¨nh C·∫£m m·ª•c ti√™u.' },
                shadow: { name: 'Thao T√∫ng B√≥ng', description: 'NƒÉng l·ª±c c√°i b√≥ng d·ª±a tr√™n Thi√™n ph√∫ H·ªá Bi·∫øn H√≥a, c√≥ th·ªÉ thao t√∫ng c√°i b√≥ng t·∫•n c√¥ng.' },
                emotion_release: {
                  name: 'Gi·∫£i Ph√≥ng C·∫£m X√∫c',
                  description: 'NƒÉng l·ª±c gi·∫£i ph√≥ng d·ª±a tr√™n Thi√™n ph√∫ H·ªá Ph√≥ng X·∫°, c√≥ th·ªÉ gi·∫£i ph√≥ng nƒÉng l∆∞·ª£ng c·∫£m x√∫c m√£nh li·ªát.',
                },
                sacrifice: { name: 'Hi·∫øn T·∫ø Sinh M·ªánh', description: 'NƒÉng l·ª±c hi·∫øn t·∫ø d·ª±a tr√™n Thi√™n ph√∫ H·ªá Ph√≥ng X·∫°, c√≥ th·ªÉ hy sinh sinh m·ªánh ho·∫∑c k√Ω ·ª©c ƒë·ªÉ c√≥ ƒë∆∞·ª£c s·ª©c m·∫°nh.' },
                phantom: { name: 'C·ª• Th·ªÉ H√≥a Ph√¢n Th√¢n', description: 'NƒÉng l·ª±c ph√¢n th√¢n d·ª±a tr√™n Thi√™n ph√∫ H·ªá Ph√≥ng X·∫°, c√≥ th·ªÉ c·ª• th·ªÉ h√≥a ·∫£o ·∫£nh ph√¢n th√¢n.' },
                suggestion: { name: '√Åm Th·ªã T√¢m L√Ω', description: 'NƒÉng l·ª±c √°m th·ªã t√¢m l√Ω d·ª±a tr√™n Thi√™n ph√∫ H·ªá Thao T√°c, c√≥ th·ªÉ c·∫•y gh√©p t∆∞ t∆∞·ªüng ki·ªÉm so√°t m·ª•c ti√™u.' },
                control: { name: 'Thao T√∫ng Tinh Th·∫ßn', description: 'NƒÉng l·ª±c thao t√∫ng tinh th·∫ßn d·ª±a tr√™n Thi√™n ph√∫ H·ªá Thao T√°c, c√≥ th·ªÉ tr·ª±c ti·∫øp ki·ªÉm so√°t h√†nh ƒë·ªông k·∫ª th√π.' },
                absorption: { name: 'H·∫•p Th·ª• T√¨nh Y√™u', description: 'NƒÉng l·ª±c h·∫•p th·ª• d·ª±a tr√™n Thi√™n ph√∫ H·ªá Thao T√°c, c√≥ th·ªÉ h·∫•p th·ª• t√¨nh y√™u c·ªßa ng∆∞·ªùi kh√°c ƒë·ªÉ c√≥ ƒë∆∞·ª£c s·ª©c m·∫°nh.' },
                armor: { name: '√Åo Gi√°p L√Ω T∆∞·ªüng', description: 'NƒÉng l·ª±c √°o gi√°p d·ª±a tr√™n Thi√™n ph√∫ H·ªá C·ª• Th·ªÉ H√≥a, c√≥ th·ªÉ c·ª• th·ªÉ h√≥a trang b·ªã b·∫£o h·ªô ho√†n h·∫£o.' },
                ring: { name: 'Nh·∫´n Cam K·∫øt', description: 'NƒÉng l·ª±c nh·∫´n d·ª±a tr√™n Thi√™n ph√∫ H·ªá C·ª• Th·ªÉ H√≥a, c√≥ th·ªÉ c·ª• th·ªÉ h√≥a nh·∫´n s·ªü h·ªØu s·ª©c m·∫°nh to l·ªõn.' },
                npc: { name: 'NPC Ho√†n H·∫£o', description: 'NƒÉng l·ª±c NPC d·ª±a tr√™n Thi√™n ph√∫ H·ªá C·ª• Th·ªÉ H√≥a, c√≥ th·ªÉ c·ª• th·ªÉ h√≥a tr·ª£ th·ªß ho√†n h·∫£o.' },
                contract: { name: 'Kh·∫ø ∆Ø·ªõc Qu√°i ƒê√†m', description: 'NƒÉng l·ª±c kh·∫ø ∆∞·ªõc d·ª±a tr√™n Thi√™n ph√∫ H·ªá ƒê·∫∑c Ch·∫•t, c√≥ th·ªÉ k√Ω k·∫øt kh·∫ø ∆∞·ªõc v·ªõi Quy T·∫Øc Qu√°i ƒê√†m.' },
                resonance: { name: 'C·ªông H∆∞·ªüng C·∫£m X√∫c', description: 'NƒÉng l·ª±c c·ªông h∆∞·ªüng d·ª±a tr√™n Thi√™n ph√∫ H·ªá ƒê·∫∑c Ch·∫•t, c√≥ th·ªÉ ti·∫øn h√†nh c·ªông h∆∞·ªüng c·∫£m x√∫c v·ªõi m·ª•c ti√™u.' },
                chaos: { name: 'H·ªón H·ª£p H·ªón Mang', description: 'NƒÉng l·ª±c h·ªón h·ª£p d·ª±a tr√™n Thi√™n ph√∫ H·ªá ƒê·∫∑c Ch·∫•t, c√≥ th·ªÉ h·ªón h·ª£p t√¨nh y√™u kh√°c nhau t·∫°o ra k·ªπ nƒÉng m·ªõi.' },
              };

              const skillDetail = skillDetails[action.skillType];
              if (skillDetail) {
                skillInfo = `S·ª≠ d·ª•ng k·ªπ nƒÉng ƒê·∫°i Thi√™n Ph√∫ [${skillDetail.name}] (${action.majorTalent})\nM√¥ t·∫£ k·ªπ nƒÉng: ${skillDetail.description}`;
              }
            }

            if (action.target === 'self') {
              return `${skillInfo}\nM·ª•c ti√™u s·ª≠ d·ª•ng: B·∫£n th√¢n`;
            } else if (action.target === 'uma' && action.characterName) {
              return `${skillInfo}\nM·ª•c ti√™u s·ª≠ d·ª•ng: ${action.characterName}`;
            } else {
              return `${skillInfo}\nM·ª•c ti√™u s·ª≠ d·ª•ng: Ch∆∞a ch·ªâ ƒë·ªãnh`;
            }

          case 'meal':
            return `ƒÇn th√™m${action.characterName ? ` c√πng [${action.characterName}]` : ''}`;

          case 'borrow':
            return `M∆∞·ª£n ti·ªÅn${action.characterName ? ` t·ª´ [${action.characterName}]` : ''}`;

          case 'game':
            return `Ch∆°i game${action.characterName ? ` c√πng [${action.characterName}]` : ''}`;

          case 'chat':
            return `Tr√≤ chuy·ªán${action.characterName ? ` v·ªõi [${action.characterName}]` : ''}`;

          case 'rest':
            return `Ngh·ªâ ng∆°i ƒë·∫øn tu·∫ßn sau${action.description ? `\n${action.description}` : ''}`;

          default:
            return JSON.stringify(action);
        }
      }

      function showTemporaryMessage(message) {
        const messageDiv = $('<div class="temporary-message">').text(message);

        $('body').append(messageDiv);

        setTimeout(() => {
          messageDiv.remove();
        }, 2000);
      }

      window.getPendingActions = function () {
        return pendingActions;
      };

      window.clearAllPendingActions = function () {
        clearAllActions();
      };

      $(document).on('keydown', function (e) {
        if (e.key === 'Escape' && giftSelectionMode?.active) {
          cancelGiftSelection();
        }

        if (e.key === 'Escape' && skillSelectionMode?.active) {
          cancelSkillSelection();
        }
      });
    </script>

    <style>
      

      .item-info-row {
        display: flex;

        justify-content: space-between;

        align-items: center;

        margin-top: 0.5rem;
      }

      .item-actions {
        display: flex;

        gap: 4px;

        align-items: center;
      }

      .item-use-btn,
      .item-discard-btn,
      .item-lock-btn,
      .item-gift-btn {
        padding: 6px;

        border: none;

        border-radius: 50%;

        font-size: 14px;

        font-weight: bold;

        cursor: pointer;

        transition: all 0.2s;

        width: 28px;

        height: 28px;

        display: flex;

        align-items: center;

        justify-content: center;

        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .item-use-btn:hover,
      .item-discard-btn:hover,
      .item-lock-btn:hover,
      .item-gift-btn:hover {
        transform: scale(1.1);

        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .item-use-btn {
        background: #38a169;

        color: white;
      }

      .item-use-btn:hover {
        background: #2f855a;
      }

      .item-discard-btn {
        background: #e53e3e;

        color: white;
      }

      .item-discard-btn:hover {
        background: #c53030;
      }

      .item-discard-btn:disabled {
        opacity: 0.5;

        cursor: not-allowed;
      }

      .item-lock-btn {
        background: #4a5568;

        color: white;
      }

      .item-lock-btn:hover {
        background: #2d3748;
      }

      .item-gift-btn {
        background: #d69e2e;

        color: white;
      }

      .item-gift-btn:hover {
        background: #b7791f;
      }

      

      .action-icons-container {
        display: flex;

        align-items: center;

        gap: 8px;

        margin: 0 15px;
      }

      .action-icon {
        display: inline-flex;

        align-items: center;

        padding: 3px 6px;

        border-radius: 12px;

        font-size: 11px;

        font-weight: bold;

        cursor: pointer;

        transition: all 0.2s;

        border: 1px solid transparent;
      }

      .action-icon:hover {
        transform: scale(1.1);
      }

      .use-icon {
        background: #38a169;

        color: white;

        border-color: #2f855a;
      }

      .discard-icon {
        background: #e53e3e;

        color: white;

        border-color: #c53030;
      }

      .gift-icon {
        background: #d69e2e;

        color: white;

        border-color: #b7791f;
      }

      .lock-icon {
        background: #4a5568;

        color: white;

        border-color: #2d3748;
      }

      .skill-icon {
        background: #805ad5;

        color: white;

        border-color: #6b46c1;
      }

      

      .gift-selection-hint {
        position: fixed;

        top: 20px;

        right: 20px;

        background: rgba(0, 0, 0, 0.9);

        color: white;

        padding: 15px 20px;

        border-radius: 8px;

        font-size: 14px;

        z-index: 1001;

        animation: fadeInOut 2s ease-in-out;
      }

      .hint-content {
        display: flex;

        align-items: center;

        gap: 10px;
      }

      .hint-icon {
        font-size: 18px;
      }

      .hint-close {
        background: none;

        border: none;

        color: white;

        font-size: 16px;

        cursor: pointer;

        margin-left: 10px;
      }

      

      .skill-selection-hint {
        position: fixed;

        top: 20px;

        right: 20px;

        background: rgba(128, 90, 213, 0.9);

        color: white;

        padding: 15px 20px;

        border-radius: 8px;

        font-size: 14px;

        z-index: 1001;

        animation: fadeInOut 2s ease-in-out;
      }

      

      .skills-section {
        display: flex;

        gap: 8px;

        align-items: center;

        margin: 0 15px;
      }

      .skill-btn {
        display: flex;

        align-items: center;

        justify-content: center;

        padding: 2px 4px;

        border: 1px solid #8b4513;

        border-radius: 4px;

        background: linear-gradient(135deg, #2d1b1b, #1a0f0f);

        color: #ffffff;

        cursor: pointer;

        transition: all 0.3s ease;

        width: 24px;

        height: 24px;

        box-shadow: 0 1px 2px rgba(139, 69, 19, 0.3);
      }

      .skill-btn:hover {
        transform: translateY(-2px);

        box-shadow: 0 4px 16px rgba(139, 69, 19, 0.5);

        border-color: #a0522d;
      }

      .skill-btn:active {
        transform: translateY(0);
      }

      .skill-icon {
        font-size: 12px;

        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
      }

      .no-skills-message {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2px 8px;
        border: 1px solid rgba(139, 69, 19, 0.3);
        border-radius: 4px;
        background: linear-gradient(135deg, rgba(45, 27, 27, 0.6), rgba(26, 15, 15, 0.6));
        color: rgba(139, 69, 19, 0.9);
        font-size: 11px;
        font-style: italic;
        width: 120px;
        height: 24px;
        box-shadow: 0 1px 3px rgba(139, 69, 19, 0.3);
        opacity: 1;
        transition: all 0.3s ease;
      }

      .no-skills-message:hover {
        opacity: 1;
        border-color: rgba(139, 69, 19, 0.5);
        box-shadow: 0 2px 4px rgba(139, 69, 19, 0.3);
      }

      .skill-use-btn {
        background: linear-gradient(135deg, #805ad5, #6b46c1);

        color: white;

        border: none;

        border-radius: 0.25rem;

        padding: 0.25rem 0.5rem;

        font-size: 0.7rem;

        cursor: pointer;

        margin: 0.25rem 0.25rem 0 0;

        transition: all 0.2s;
      }

      .skill-use-btn:hover {
        background: linear-gradient(135deg, #6b46c1, #553c9a);

        transform: translateY(-1px);
      }

      @keyframes fadeInOut {
        0%,
        100% {
          opacity: 0;
        }

        20%,
        80% {
          opacity: 1;
        }
      }

      

      .gift-selectable {
        cursor: pointer;
        border: 3px solid #e91e63 !important;
        box-shadow:
          0 0 15px rgba(233, 30, 99, 0.8),
          inset 0 0 15px rgba(233, 30, 99, 0.3) !important;
        transition: all 0.3s ease;
        animation: gift-pulse 1.5s ease-in-out infinite;
      }

      @keyframes gift-pulse {
        0%,
        100% {
          box-shadow:
            0 0 15px rgba(233, 30, 99, 0.8),
            inset 0 0 15px rgba(233, 30, 99, 0.3);
        }
        50% {
          box-shadow:
            0 0 25px rgba(233, 30, 99, 1),
            inset 0 0 20px rgba(233, 30, 99, 0.5);
        }
      }

      .skill-selectable {
        cursor: pointer;
        border: 3px solid #805ad5 !important;
        box-shadow:
          0 0 15px rgba(128, 90, 213, 0.8),
          inset 0 0 15px rgba(128, 90, 213, 0.3) !important;
        transition: all 0.3s ease;
        animation: skill-pulse 1.5s ease-in-out infinite;
      }

      @keyframes skill-pulse {
        0%,
        100% {
          box-shadow:
            0 0 15px rgba(128, 90, 213, 0.8),
            inset 0 0 15px rgba(128, 90, 213, 0.3);
        }
        50% {
          box-shadow:
            0 0 25px rgba(128, 90, 213, 1),
            inset 0 0 20px rgba(128, 90, 213, 0.5);
        }
      }

      .skill-selectable:hover {
        border-color: #9f7aea !important;
        box-shadow:
          0 0 30px rgba(128, 90, 213, 1),
          inset 0 0 25px rgba(128, 90, 213, 0.6) !important;
      }

      

      .temporary-message {
        position: fixed;

        top: 20px;

        right: 20px;

        background: rgba(0, 0, 0, 0.8);

        color: white;

        padding: 10px 15px;

        border-radius: 6px;

        font-size: 12px;

        z-index: 1002;

        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);

          opacity: 0;
        }

        to {
          transform: translateX(0);

          opacity: 1;
        }
      }

      @keyframes tarotResultFadeIn {
        from {
          opacity: 0;
          transform: scale(0.8) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .tarot-result-card:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 8px 25px rgba(168, 85, 247, 0.5);
      }

      .tarot-result-card.reversed:hover {
        transform: rotate(180deg) translateY(-5px) scale(1.05);
      }

      @keyframes tarotStartPulse {
        0%,
        100% {
          opacity: 0.8;
        }
        50% {
          opacity: 1;
        }
      }

      @keyframes tarotIconFloat {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      @keyframes tarotDotPulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.6;
        }
        50% {
          transform: scale(1.2);
          opacity: 1;
        }
      }

      @keyframes tarotFloat {
        0%,
        100% {
          transform: translateY(0px) rotate(0deg);
          opacity: 0.3;
        }
        50% {
          transform: translateY(-15px) rotate(5deg);
          opacity: 0.6;
        }
      }

      

      .command-manager-dot {
        display: inline-flex;

        align-items: center;

        margin-left: auto;

        cursor: pointer;

        background: #e53e3e;

        color: white;

        border-radius: 12px;

        padding: 2px 6px;

        font-size: 11px;

        font-weight: bold;

        transition: all 0.2s;

        animation: pulse 1.5s infinite;
      }

      .command-manager-dot:hover {
        background: #c53030;

        transform: scale(1.1);
      }

      .dot-icon {
        margin-right: 3px;
      }

      .dot-count {
        font-size: 10px;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }

        50% {
          opacity: 0.7;
        }
      }

      .command-section {
        margin-bottom: 1rem;
      }

      .command-list {
        flex-direction: column;

        gap: 0.5rem;

        max-height: 300px;

        display: flex;

        overflow-y: auto;

        margin-bottom: 1rem;
      }

      .command-item {
        background-color: #8b69141a;

        border-left: 2px solid #8b6914;

        border-radius: 0.25rem;

        padding: 0.5rem;

        display: flex;

        align-items: center;

        justify-content: space-between;
      }

      .command-content {
        display: flex;

        align-items: center;

        flex: 1;
      }

      .command-icon {
        margin-right: 0.5rem;

        font-size: 0.875rem;
      }

      .command-text {
        flex: 1;

        font-size: 0.75rem;

        color: #654321;

        font-weight: 500;
      }

      .remove-command-btn {
        background: #e53e3e;

        color: white;

        border: none;

        width: 16px;

        height: 16px;

        border-radius: 50%;

        cursor: pointer;

        font-size: 10px;

        line-height: 1;

        transition: all 0.2s;

        margin-left: 0.5rem;
      }

      .remove-command-btn:hover {
        background: #c53030;

        transform: scale(1.1);
      }

      .command-footer {
        text-align: center;

        padding-top: 0.5rem;

        margin-top: 0.5rem;

        border-top: 1px solid #8b691433;
      }

      .clear-all-btn {
        background: #e53e3e;

        color: white;

        border: none;

        border-radius: 0.375rem;

        padding: 0.5rem 1rem;

        font-size: 0.875rem;

        font-weight: 600;

        cursor: pointer;

        transition: all 0.2s;
      }

      .clear-all-btn:hover {
        background: #c53030;

        transform: translateY(-1px);
      }

      .empty-command {
        text-align: center;

        color: #8b4513;

        padding: 1rem;

        font-size: 0.75rem;
      }

      

      .save-item {
        background: rgba(139, 105, 20, 0.1);

        border: 1px solid rgba(139, 105, 20, 0.3);

        border-radius: 0.375rem;

        padding: 0.75rem;

        margin-bottom: 0.5rem;

        cursor: pointer;

        transition: all 0.2s;
      }

      .save-item:hover {
        background: rgba(139, 105, 20, 0.2);

        border-color: rgba(139, 105, 20, 0.5);

        transform: translateY(-1px);
      }

      

      .manual-save-item {
        background: rgba(59, 130, 246, 0.1);

        border: 1px solid rgba(59, 130, 246, 0.3);
      }

      .manual-save-item:hover {
        background: rgba(59, 130, 246, 0.2);

        border-color: rgba(59, 130, 246, 0.5);
      }

      

      .auto-save-item {
        background: rgba(34, 197, 94, 0.1);

        border: 1px solid rgba(34, 197, 94, 0.3);

        position: relative;
      }

      .auto-save-item:hover {
        background: rgba(34, 197, 94, 0.2);

        border-color: rgba(34, 197, 94, 0.5);
      }

      

      .worldbook-save-item {
        background: rgba(168, 85, 247, 0.1);

        border: 1px solid rgba(168, 85, 247, 0.3);
      }

      .worldbook-save-item:hover {
        background: rgba(168, 85, 247, 0.2);

        border-color: rgba(168, 85, 247, 0.5);
      }

      .save-type {
        font-size: 0.75rem;

        font-weight: 600;

        margin-top: 0.25rem;
      }

      .manual-save-item .save-type {
        color: #3b82f6;
      }

      .auto-save-item .save-type {
        color: #22c55e;
      }

      .worldbook-save-item .save-type {
        color: #a855f7;
      }

      .save-name {
        font-weight: bold;

        margin-bottom: 0.25rem;

        color: #e0e0e0;
      }

      .save-content {
        font-size: 0.8rem;

        color: #c0c0c0;

        margin-bottom: 0.25rem;

        line-height: 1.3;

        max-height: 2.6rem;

        overflow: hidden;

        text-overflow: ellipsis;

        display: -webkit-box;

        -webkit-line-clamp: 2; 

        line-clamp: 2; 

        -webkit-box-orient: vertical;
      }

      .save-time {
        font-size: 0.75rem;

        color: #a0a0a0;
      }

      .empty-save {
        text-align: center;

        color: #8b4513;

        padding: 1rem;

        font-size: 0.875rem;

        font-style: italic;
      }

      

      .qte-section {
        margin-top: 15px;

        padding: 15px;

        background: rgba(139, 69, 19, 0.05);

        border: 2px dashed rgba(139, 69, 19, 0.3);

        border-radius: 8px;

        animation: qtePulse 2s ease-in-out infinite;
      }

      @keyframes qtePulse {
        0%,
        100% {
          border-color: rgba(139, 69, 19, 0.3);
        }

        50% {
          border-color: rgba(139, 69, 19, 0.6);
        }
      }

      .qte-container {
        text-align: center;
      }

      .qte-info {
        margin-bottom: 15px;
      }

      .qte-description {
        font-size: 1.1em;

        font-weight: bold;

        color: #8b4513;

        margin: 0 0 5px 0;

        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
      }

      .qte-subtitle {
        font-size: 0.9em;

        color: #654321;

        margin: 0;

        font-style: italic;
      }

      .qte-options {
        display: flex;

        gap: 10px;

        justify-content: center;

        flex-wrap: wrap;
      }

      .qte-btn {
        display: flex;

        flex-direction: column;

        align-items: center;

        padding: 12px 16px;

        border: 2px solid #8b4513;

        border-radius: 8px;

        background: rgba(244, 241, 232, 0.9);

        cursor: pointer;

        transition: all 0.3s ease;

        min-width: 100px;

        box-shadow: 0 2px 8px rgba(139, 69, 19, 0.2);
      }

      .qte-btn:hover {
        transform: translateY(-2px);

        box-shadow: 0 4px 12px rgba(139, 69, 19, 0.4);

        background: rgba(244, 241, 232, 1);
      }

      .qte-btn:active {
        transform: translateY(0);
      }

      .qte-icon {
        font-size: 1.5em;

        margin-bottom: 5px;
      }

      .qte-text {
        font-weight: bold;

        color: #8b4513;

        font-size: 0.9em;

        margin-bottom: 3px;
      }

      .qte-desc {
        font-size: 0.75em;

        color: #654321;

        opacity: 0.8;
      }

      .struggle-btn:hover {
        border-color: #dc2626;

        background: rgba(220, 38, 38, 0.1);
      }

      .submit-btn:hover {
        border-color: #059669;

        background: rgba(5, 150, 105, 0.1);
      }
    </style>

    <div id="talents-modal" class="rules-modal" style="display: none; justify-content: center; align-items: center">
      <div
        class="rules-modal-content"
        style="
          max-width: 1200px;
          width: 95%;
          max-height: 90vh;
          background: linear-gradient(135deg, #2d1b1b, #1a0f0f);
          border: 2px solid #8b4513;
        "
      >
        <div
          class="rules-modal-header"
          style="
            background: linear-gradient(135deg, #8b6914, #a0865a);
            padding: 2px 20px;
            border-bottom: 1px solid #654321;
            display: flex;
            justify-content: flex-end;
            position: relative;
            min-height: 30px;
          "
        >
          <button
            id="close-talents-btn"
            class="close-rules-btn"
            style="
              background: rgba(255, 255, 255, 0.15);
              border: 1px solid rgba(255, 255, 255, 0.2);
              color: #ffffff;
              font-size: 14px;
              padding: 3px 6px;
              border-radius: 3px;
              cursor: pointer;
              position: absolute;
              top: 6px;
              right: 20px;
              transition: all 0.2s ease;
            "
          >
            √ó
          </button>
        </div>

        <div
          class="rules-modal-body"
          style="
            padding: 20px 30px 30px 30px;
            background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 100%);
            min-height: 500px;
            max-height: calc(90vh - 80px);
            overflow-y: auto;
          "
        >

          <div
            class="book-controls"
            style="
              position: absolute;
              bottom: 20px;
              left: 50%;
              transform: translateX(-50%);
              display: flex;
              justify-content: center;
              align-items: center;
              gap: 20px;
              z-index: 10;
            "
          >
            <button
              id="prev-page-btn"
              class="page-btn book-tab"
              onclick="window.teresenDebug.prevTalentPage()"
              style="
                background: linear-gradient(135deg, #8b6914, #a0865a);
                border: 2px solid #654321;
                color: #ffffff;
                padding: 8px 16px;
                border-radius: 8px 8px 0 0;
                cursor: pointer;
                font-size: 12px;
                font-weight: bold;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                gap: 6px;
                box-shadow: 0 -2px 8px rgba(139, 105, 20, 0.3);
                transform: translateY(0);
              "
            >
              <span style="font-size: 14px">‚óÄ</span>

              <span>Trang tr∆∞·ªõc</span>
            </button>

            <div
              class="page-indicator book-tab"
              style="
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.15), rgba(160, 134, 90, 0.08));
                border: 2px solid rgba(139, 105, 20, 0.4);
                border-radius: 8px 8px 0 0;
                padding: 8px 16px;
                text-align: center;
                box-shadow: 0 -2px 12px rgba(139, 105, 20, 0.2);
                transform: translateY(0);
              "
            >
              <div
                id="current-page-title"
                style="color: #8b4513; font-size: 13px; font-weight: bold; margin-bottom: 2px"
              >
                üìñ Trang <span id="page-number">1</span>
              </div>

              <div style="color: #666666; font-size: 10px">T·ªïng 7 trang</div>
            </div>

            <button
              id="next-page-btn"
              class="page-btn book-tab"
              onclick="window.teresenDebug.nextTalentPage()"
              style="
                background: linear-gradient(135deg, #8b6914, #a0865a);
                border: 2px solid #654321;
                color: #ffffff;
                padding: 8px 16px;
                border-radius: 8px 8px 0 0;
                cursor: pointer;
                font-size: 12px;
                font-weight: bold;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                gap: 6px;
                box-shadow: 0 -2px 8px rgba(139, 105, 20, 0.3);
                transform: translateY(0);
              "
            >
              <span>Trang sau</span>

              <span style="font-size: 14px">‚ñ∂</span>
            </button>
          </div>

          <div class="book-content" style="position: relative; overflow: hidden; min-height: 600px">
            <div
              id="book-pages-container"
              style="display: flex; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); height: 100%"
            >

              <div class="book-page" style="width: 100%; flex-shrink: 0; padding: 20px">
                <div
                  class="book-page-content"
                  style="
                    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(245, 240, 232, 0.9));
                    border: 2px solid rgba(139, 105, 20, 0.3);
                    border-radius: 16px;
                    padding: 30px;
                    min-height: 500px;
                    box-shadow:
                      0 8px 32px rgba(139, 105, 20, 0.15),
                      inset 0 1px 0 rgba(255, 255, 255, 0.8);
                    max-width: 800px;
                    margin: 0 auto;
                    position: relative;
                  "
                >

                  <div
                    style="
                      position: absolute;
                      top: 15px;
                      right: 15px;
                      width: 20px;
                      height: 20px;
                      background: linear-gradient(135deg, transparent 50%, rgba(139, 105, 20, 0.2) 50%);
                      border-radius: 0 16px 0 0;
                    "
                  ></div>

                  <div
                    style="
                      position: absolute;
                      bottom: 15px;
                      left: 15px;
                      width: 20px;
                      height: 20px;
                      background: linear-gradient(135deg, rgba(139, 105, 20, 0.2) 50%, transparent 50%);
                      border-radius: 0 0 0 16px;
                    "
                  ></div>

                  <h3
                    style="
                      color: #8b4513;
                      font-size: 20px;
                      font-weight: bold;
                      margin-bottom: 25px;
                      text-align: center;
                      text-shadow: 0 2px 4px rgba(139, 105, 20, 0.2);
                      font-family: 'Georgia', serif;
                    "
                  >
                    üåü Thi√™n ph√∫ hi·ªán t·∫°i
                  </h3>

                  <div id="current-talents-list" class="talents-list" style="min-height: 350px"></div>
                </div>
              </div>

              <div class="book-page" style="width: 100%; flex-shrink: 0; padding: 20px">
                <div
                  class="book-page-content"
                  style="
                    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(245, 240, 232, 0.9));
                    border: 2px solid rgba(139, 69, 19, 0.3);
                    border-radius: 16px;
                    padding: 30px;
                    min-height: 500px;
                    box-shadow:
                      0 8px 32px rgba(139, 69, 19, 0.15),
                      inset 0 1px 0 rgba(255, 255, 255, 0.8);
                    max-width: 800px;
                    margin: 0 auto;
                    position: relative;
                  "
                >

                  <div
                    style="
                      position: absolute;
                      top: 15px;
                      right: 15px;
                      width: 20px;
                      height: 20px;
                      background: linear-gradient(135deg, transparent 50%, rgba(139, 69, 19, 0.2) 50%);
                      border-radius: 0 16px 0 0;
                    "
                  ></div>

                  <div
                    style="
                      position: absolute;
                      bottom: 15px;
                      left: 15px;
                      width: 20px;
                      height: 20px;
                      background: linear-gradient(135deg, rgba(139, 69, 19, 0.2) 50%, transparent 50%);
                      border-radius: 0 0 0 16px;
                    "
                  ></div>

                  <h3
                    style="
                      color: #8b4513;
                      font-size: 20px;
                      font-weight: bold;
                      margin-bottom: 25px;
                      text-align: center;
                      text-shadow: 0 2px 4px rgba(139, 69, 19, 0.2);
                      font-family: 'Georgia', serif;
                    "
                  >
                    üå± M·∫ßm M·ªëng (The Seed)
                  </h3>

                  <div style="display: flex; gap: 20px; max-width: 800px; margin: 0 auto">

                    <div
                      style="
                        width: 300px;
                        background: linear-gradient(135deg, rgba(75, 0, 0, 0.12), rgba(50, 0, 0, 0.06));
                        border: 2px solid rgba(75, 0, 0, 0.35);
                        border-radius: 16px;
                        padding: 20px;
                        box-shadow: 0 4px 16px rgba(75, 0, 0, 0.2);
                      "
                    >
                      <h4
                        style="
                          color: #dc2626;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        üìñ B·ªëi C·∫£nh C√¢u Chuy·ªán
                      </h4>

                      <p
                        style="
                          color: #000000;
                          font-size: 13px;
                          line-height: 1.6;
                          text-align: center;
                          font-style: italic;
                          margin: 0;
                          word-wrap: break-word;
                          overflow-wrap: break-word;
                          font-weight: 600;
                          text-shadow: none;
                          letter-spacing: 0.3px;
                        "
                      >
                        "B·∫°n ch·ªâ ƒëang trong tuy·ªát c·∫£nh, v√¥ th·ª©c n·∫Øm l·∫•y c·ªçng r∆°m c·ª©u m·∫°ng. S·ª©c m·∫°nh n√†y y·∫øu ·ªõt, kh√¥ng th·ªÉ ki·ªÉm so√°t, l√† ti·∫øng kh√≥c y·∫øu ·ªõt ƒë·∫ßu ti√™n b·∫°n ph√°t ra trong th·∫ø gi·ªõi k·ª≥ l·∫° n√†y."
                      </p>
                    </div>

                    <div
                      style="
                        flex: 1;
                        max-width: 550px;
                        background: rgba(139, 69, 19, 0.08);
                        border: 2px solid rgba(139, 69, 19, 0.25);
                        border-radius: 16px;
                        padding: 20px;
                      "
                    >
                      <h4
                        style="
                          color: #8b4513;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        üéØ Ch·ªçn con ƒë∆∞·ªùng c·ªßa b·∫°n
                      </h4>

                      <div id="seed-options" style="max-height: 250px; overflow-y: auto"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="book-page" style="min-width: 100%; flex-shrink: 0">
                <div
                  style="
                    background: rgba(139, 69, 19, 0.08);
                    border: 2px solid rgba(139, 69, 19, 0.25);
                    border-radius: 12px;
                    padding: 20px;
                    min-height: 400px;
                    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
                  "
                >
                  <h3
                    style="
                      color: #8b4513;
                      font-size: 18px;
                      font-weight: bold;
                      margin-bottom: 16px;
                      text-align: center;
                      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                    "
                  >
                    üåø Sinh Tr∆∞·ªüng (The Growth)
                  </h3>

                  <div style="display: flex; gap: 20px; max-width: 800px; margin: 0 auto">

                    <div
                      style="
                        width: 300px;
                        background: linear-gradient(135deg, rgba(139, 0, 0, 0.15), rgba(75, 0, 0, 0.08));
                        border: 2px solid rgba(139, 0, 0, 0.4);
                        border-radius: 16px;
                        padding: 20px;
                        box-shadow: 0 4px 16px rgba(139, 0, 0, 0.2);
                      "
                    >
                      <h4
                        style="
                          color: #dc2626;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        üìñ B·ªëi C·∫£nh C√¢u Chuy·ªán
                      </h4>

                      <p
                        style="
                          color: #000000;
                          font-size: 13px;
                          line-height: 1.6;
                          text-align: center;
                          font-style: italic;
                          margin: 0;
                          word-wrap: break-word;
                          overflow-wrap: break-word;
                          font-weight: 600;
                          letter-spacing: 0.3px;
                        "
                      >
                        "B·∫°n b·∫Øt ƒë·∫ßu hi·ªÉu v√† s·ª≠ d·ª•ng s·ª©c m·∫°nh n√†y m·ªôt c√°ch c√≥ √Ω th·ª©c, coi n√≥ nh∆∞ m·ªôt c√¥ng c·ª• gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ. B·∫°n t·ª´ m·ªôt n·∫°n nh√¢n th·ª• ƒë·ªông, chuy·ªÉn th√†nh m·ªôt ng∆∞·ªùi tham gia c√≥ th·ªÉ ƒë·∫∑t c·ªù th·∫≠n tr·ªçng tr√™n b√†n c·ªù."
                      </p>
                    </div>

                    <div
                      style="
                        flex: 1;
                        max-width: 550px;
                        background: rgba(139, 69, 19, 0.08);
                        border: 2px solid rgba(139, 69, 19, 0.25);
                        border-radius: 16px;
                        padding: 20px;
                      "
                    >
                      <h4
                        style="
                          color: #8b4513;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        üéØ Ch·ªçn con ƒë∆∞·ªùng c·ªßa b·∫°n
                      </h4>

                      <div id="growth-options" style="max-height: 250px; overflow-y: auto"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="book-page" style="min-width: 100%; flex-shrink: 0">
                <div
                  style="
                    background: rgba(139, 69, 19, 0.08);
                    border: 2px solid rgba(139, 69, 19, 0.25);
                    border-radius: 12px;
                    padding: 20px;
                    min-height: 400px;
                    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
                  "
                >
                  <h3
                    style="
                      color: #8b4513;
                      font-size: 18px;
                      font-weight: bold;
                      margin-bottom: 16px;
                      text-align: center;
                      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                    "
                  >
                    üåÄ Bi·∫øn D·ªã (The Aberration)
                  </h3>

                  <div style="display: flex; gap: 20px; max-width: 800px; margin: 0 auto">

                    <div
                      style="
                        width: 300px;
                        background: linear-gradient(135deg, rgba(75, 0, 130, 0.18), rgba(45, 0, 80, 0.1));
                        border: 2px solid rgba(75, 0, 130, 0.5);
                        border-radius: 16px;
                        padding: 20px;
                        box-shadow: 0 4px 16px rgba(75, 0, 130, 0.25);
                      "
                    >
                      <h4
                        style="
                          color: #8b5cf6;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        üìñ B·ªëi C·∫£nh C√¢u Chuy·ªán
                      </h4>

                      <p
                        style="
                          color: #000000;
                          font-size: 13px;
                          line-height: 1.6;
                          text-align: center;
                          font-style: italic;
                          margin: 0;
                          word-wrap: break-word;
                          overflow-wrap: break-word;
                          font-weight: 600;
                          letter-spacing: 0.3px;
                        "
                      >
                        "S·ª©c m·∫°nh b·∫Øt ƒë·∫ßu t√°c ƒë·ªông ng∆∞·ª£c l·∫°i t√¢m tr√≠ v√† h√†nh vi c·ªßa b·∫°n. B·∫°n c√≥ ƒë∆∞·ª£c nƒÉng l·ª±c m·∫°nh m·∫Ω h∆°n, nh∆∞ng c≈©ng c·∫£m nh·∫≠n ƒë∆∞·ª£c s·ª± ng·ªçt ng√†o v√† ƒëi√™n cu·ªìng ƒë√°ng s·ª£ ƒë·∫±ng sau n√≥."
                      </p>
                    </div>

                    <div
                      style="
                        flex: 1;
                        max-width: 550px;
                        background: rgba(139, 69, 19, 0.08);
                        border: 2px solid rgba(139, 69, 19, 0.25);
                        border-radius: 16px;
                        padding: 20px;
                      "
                    >
                      <h4
                        style="
                          color: #8b4513;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        üéØ Ch·ªçn con ƒë∆∞·ªùng c·ªßa b·∫°n
                      </h4>

                      <div id="mutation-options" style="max-height: 250px; overflow-y: auto"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="book-page" style="min-width: 100%; flex-shrink: 0">
                <div
                  style="
                    background: rgba(139, 69, 19, 0.08);
                    border: 2px solid rgba(139, 69, 19, 0.25);
                    border-radius: 12px;
                    padding: 20px;
                    min-height: 400px;
                    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
                  "
                >
                  <h3
                    style="
                      color: #8b4513;
                      font-size: 18px;
                      font-weight: bold;
                      margin-bottom: 16px;
                      text-align: center;
                      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                    "
                  >
                    üëë Quy·ªÅn NƒÉng (The Authority)
                  </h3>

                  <div style="display: flex; gap: 20px; max-width: 800px; margin: 0 auto">

                    <div
                      style="
                        width: 300px;
                        background: linear-gradient(135deg, rgba(139, 0, 0, 0.22), rgba(100, 0, 0, 0.12));
                        border: 2px solid rgba(139, 0, 0, 0.6);
                        border-radius: 16px;
                        padding: 20px;
                        box-shadow: 0 4px 16px rgba(139, 0, 0, 0.3);
                      "
                    >
                      <h4
                        style="
                          color: #ef4444;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        üìñ B·ªëi C·∫£nh C√¢u Chuy·ªán
                      </h4>

                      <p
                        style="
                          color: #000000;
                          font-size: 13px;
                          line-height: 1.6;
                          text-align: center;
                          font-style: italic;
                          margin: 0;
                          word-wrap: break-word;
                          overflow-wrap: break-word;
                          font-weight: 600;
                          letter-spacing: 0.3px;
                        "
                      >
                        "Sau khi tr·∫£i qua ƒë·∫•u tranh n·ªôi t√¢m, b·∫°n ƒë√£ ƒë∆∞a ra l·ª±a ch·ªçn. B·∫°n kh√¥ng c√≤n coi n√≥ l√† l·ªùi nguy·ªÅn, m√† b·∫Øt ƒë·∫ßu t·∫≠n h∆∞·ªüng s·ª©c m·∫°nh n√†y, v√† ch·ªß ƒë·ªông r√®n gi≈©a n√≥ th√†nh 'Quy·ªÅn NƒÉng' thu·ªôc v·ªÅ m√¨nh."
                      </p>
                    </div>

                    <div
                      style="
                        flex: 1;
                        max-width: 550px;
                        background: rgba(139, 69, 19, 0.08);
                        border: 2px solid rgba(139, 69, 19, 0.25);
                        border-radius: 16px;
                        padding: 20px;
                      "
                    >
                      <h4
                        style="
                          color: #8b4513;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        üéØ Ch·ªçn con ƒë∆∞·ªùng c·ªßa b·∫°n
                      </h4>

                      <div id="authority-options" style="max-height: 250px; overflow-y: auto"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="book-page" style="min-width: 100%; flex-shrink: 0">
                <div
                  style="
                    background: rgba(139, 69, 19, 0.08);
                    border: 2px solid rgba(139, 69, 19, 0.25);
                    border-radius: 12px;
                    padding: 20px;
                    min-height: 400px;
                    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
                  "
                >
                  <h3
                    style="
                      color: #8b4513;
                      font-size: 18px;
                      font-weight: bold;
                      margin-bottom: 16px;
                      text-align: center;
                      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                    "
                  >
                    üåå V·ª±c Th·∫≥m (The Abyss)
                  </h3>

                  <div style="display: flex; gap: 20px; max-width: 800px; margin: 0 auto">

                    <div
                      style="
                        width: 300px;
                        background: linear-gradient(135deg, rgba(0, 0, 0, 0.25), rgba(20, 20, 20, 0.15));
                        border: 2px solid rgba(0, 0, 0, 0.7);
                        border-radius: 16px;
                        padding: 20px;
                        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
                      "
                    >
                      <h4
                        style="
                          color: #6b7280;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        üìñ B·ªëi C·∫£nh C√¢u Chuy·ªán
                      </h4>

                      <p
                        style="
                          color: #000000;
                          font-size: 13px;
                          line-height: 1.6;
                          text-align: center;
                          font-style: italic;
                          margin: 0;
                          word-wrap: break-word;
                          overflow-wrap: break-word;
                          font-weight: 600;
                          letter-spacing: 0.3px;
                        "
                      >
                        "B·∫°n ƒë√£ ƒëi ƒë·∫øn cu·ªëi con ƒë∆∞·ªùng n√†y. B·∫°n ho√†n to√†n h√≤a l√†m m·ªôt v·ªõi 'T√¨nh y√™u phi ph√†m' ƒë√£ ch·ªçn, tr·ªü th√†nh m·ªôt 'kh√°i ni·ªám' m·ªõi, m·ªôt 'Quy T·∫Øc Qu√°i ƒê√†m' m·ªõi."
                      </p>
                    </div>

                    <div
                      style="
                        flex: 1;
                        max-width: 550px;
                        background: rgba(139, 69, 19, 0.08);
                        border: 2px solid rgba(139, 69, 19, 0.25);
                        border-radius: 16px;
                        padding: 20px;
                      "
                    >
                      <h4
                        style="
                          color: #8b4513;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        üéØ Ch·ªçn con ƒë∆∞·ªùng c·ªßa b·∫°n
                      </h4>

                      <div id="abyss-options" style="max-height: 250px; overflow-y: auto"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="book-page" style="min-width: 100%; flex-shrink: 0">
                <div
                  style="
                    background: rgba(139, 69, 19, 0.08);
                    border: 2px solid rgba(139, 69, 19, 0.25);
                    border-radius: 12px;
                    padding: 20px;
                    min-height: 400px;
                    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
                  "
                >
                  <h3
                    style="
                      color: #8b4513;
                      font-size: 18px;
                      font-weight: bold;
                      margin-bottom: 16px;
                      text-align: center;
                      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                    "
                  >
                    üìö Ghi Ch√©p N√¢ng C·∫•p
                  </h3>

                  <div id="upgrade-history" style="min-height: 300px">
                    <div style="text-align: center; color: #666666; font-style: italic; padding: 50px">
                      T·∫°m kh√¥ng c√≥ ghi ch√©p n√¢ng c·∫•p
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>

      window.savePendingActions = savePendingActions;

      window.updateActionIcons = updateActionIcons;

      window.updateInventoryCommandManager = updateInventoryCommandManager;
    </script>

    <script>

      class SkillSystem {
        constructor() {
          this.currentSkill = null;
          this._skillsUnlocked = false;

          this.skillData = {
            defense: {
              icon: 'üõ°Ô∏è',

              name: 'K·ªπ NƒÉng Ph√≤ng Th·ªß',

              description: 'NƒÉng l·ª±c ph√≤ng th·ªß d·ª±a tr√™n Thi√™n ph√∫ H·ªá C∆∞·ªùng H√≥a, c√≥ th·ªÉ n√¢ng cao s·ª©c ph√≤ng th·ªß c·ªßa b·∫£n th√¢n ho·∫∑c m·ª•c ti√™u.',

              majorTalent: 'H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)',
            },

            rule_enhance: {
              icon: 'üìú',

              name: 'Quy T·∫Øc Th·∫•u Th·ªã',
              description: 'NƒÉng l·ª±c th·∫•u th·ªã quy t·∫Øc d·ª±a tr√™n Thi√™n ph√∫ H·ªá C∆∞·ªùng H√≥a, c√≥ th·ªÉ nh√¨n th·∫•u l·ªó h·ªïng quy t·∫Øc v√† l·ª£i d·ª•ng n√≥.',
              majorTalent: 'H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)',
            },
            chain_enhance: {
              icon: 'üîó',

              name: 'Ki·ªÉm So√°t Xi·ªÅng X√≠ch',
              description: 'NƒÉng l·ª±c Ki·ªÉm So√°t Xi·ªÅng X√≠ch d·ª±a tr√™n Thi√™n ph√∫ H·ªá C∆∞·ªùng H√≥a, c√≥ th·ªÉ tr√≥i bu·ªôc ho·∫∑c kh√≥a m·ª•c ti√™u.',
              majorTalent: 'H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)',
            },
            rule_change: {
              icon: 'üìù',
              name: 'S·ª≠a ƒê·ªïi Quy T·∫Øc',
              description: 'NƒÉng l·ª±c S·ª≠a ƒê·ªïi Quy T·∫Øc d·ª±a tr√™n Thi√™n ph√∫ H·ªá Bi·∫øn H√≥a, c√≥ th·ªÉ t·∫°m th·ªùi thay ƒë·ªïi n·ªôi dung quy t·∫Øc.',
              majorTalent: 'H·ªá Bi·∫øn H√≥a (T√¨nh Y√™u D·ªëi Tr√°)',
            },
            emotion: {
              icon: 'üí≠',
              name: 'Thao T√∫ng T√¨nh C·∫£m',
              description: 'NƒÉng l·ª±c Thao T√∫ng T√¨nh C·∫£m d·ª±a tr√™n Thi√™n ph√∫ H·ªá Bi·∫øn H√≥a, c√≥ th·ªÉ c·ª• th·ªÉ h√≥a l·ªùi n√≥i d·ªëi th√†nh v≈© kh√≠ t√¨nh c·∫£m.',
              majorTalent: 'H·ªá Bi·∫øn H√≥a (T√¨nh Y√™u D·ªëi Tr√°)',
            },
            shadow: {
              icon: 'üë§',
              name: 'Thao T√∫ng B√≥ng',
              description: 'NƒÉng l·ª±c Thao T√∫ng B√≥ng d·ª±a tr√™n Thi√™n ph√∫ H·ªá Bi·∫øn H√≥a, c√≥ th·ªÉ t·∫°o ra v√† ki·ªÉm so√°t b√≥ng gi·∫£.',
              majorTalent: 'H·ªá Bi·∫øn H√≥a (T√¨nh Y√™u D·ªëi Tr√°)',
            },
            emotion_release: {
              icon: 'üíî',
              name: 'Gi·∫£i Ph√≥ng C·∫£m X√∫c',
              description: 'NƒÉng l·ª±c Gi·∫£i Ph√≥ng C·∫£m X√∫c d·ª±a tr√™n Thi√™n ph√∫ H·ªá Ph√≥ng X·∫°, c√≥ th·ªÉ hy sinh t√¨nh c·∫£m ƒë·ªÉ ·∫£nh h∆∞·ªüng k·∫ª th√π.',
              majorTalent: 'H·ªá Ph√≥ng X·∫° (T√¨nh Y√™u Hy Sinh)',
            },
            sacrifice: {
              icon: '‚ö∞Ô∏è',
              name: 'Hi·∫øn T·∫ø Sinh M·ªánh',
              description: 'NƒÉng l·ª±c hi·∫øn t·∫ø d·ª±a tr√™n Thi√™n ph√∫ H·ªá Ph√≥ng X·∫°, c√≥ th·ªÉ hy sinh sinh m·ªánh ho·∫∑c k√Ω ·ª©c ƒë·ªÉ c√≥ ƒë∆∞·ª£c s·ª©c m·∫°nh.',
              majorTalent: 'H·ªá Ph√≥ng X·∫° (T√¨nh Y√™u Hy Sinh)',
            },
            phantom: {
              icon: 'üëª',
              name: 'C·ª• Th·ªÉ H√≥a Ph√¢n Th√¢n',
              description: 'NƒÉng l·ª±c ph√¢n th√¢n d·ª±a tr√™n Thi√™n ph√∫ H·ªá Ph√≥ng X·∫°, c√≥ th·ªÉ c·ª• th·ªÉ h√≥a ·∫£o ·∫£nh ph√¢n th√¢n.',
              majorTalent: 'H·ªá Ph√≥ng X·∫° (T√¨nh Y√™u Hy Sinh)',
            },
            suggestion: {
              icon: 'üèÜ',
              name: '√Åm Th·ªã T√¢m L√Ω',
              description: 'NƒÉng l·ª±c √°m th·ªã t√¢m l√Ω d·ª±a tr√™n Thi√™n ph√∫ H·ªá Thao T√°c, c√≥ th·ªÉ c·∫•y gh√©p t∆∞ t∆∞·ªüng ki·ªÉm so√°t m·ª•c ti√™u.',
              majorTalent: 'H·ªá Thao T√°c (T√¨nh Y√™u Ki·ªÉm So√°t)',
            },
            control: {
              icon: 'üéÆ',
              name: 'Thao T√∫ng Tinh Th·∫ßn',
              description: 'NƒÉng l·ª±c thao t√∫ng tinh th·∫ßn d·ª±a tr√™n Thi√™n ph√∫ H·ªá Thao T√°c, c√≥ th·ªÉ tr·ª±c ti·∫øp ki·ªÉm so√°t h√†nh ƒë·ªông k·∫ª th√π.',
              majorTalent: 'H·ªá Thao T√°c (T√¨nh Y√™u Ki·ªÉm So√°t)',
            },
            absorption: {
              icon: 'üíï',
              name: 'H·∫•p Th·ª• T√¨nh Y√™u',
              description: 'NƒÉng l·ª±c h·∫•p th·ª• d·ª±a tr√™n Thi√™n ph√∫ H·ªá Thao T√°c, c√≥ th·ªÉ h·∫•p th·ª• t√¨nh y√™u c·ªßa ng∆∞·ªùi kh√°c ƒë·ªÉ c√≥ ƒë∆∞·ª£c s·ª©c m·∫°nh.',
              majorTalent: 'H·ªá Thao T√°c (T√¨nh Y√™u Ki·ªÉm So√°t)',
            },
            armor: {
              icon: 'üõ°Ô∏è',
              name: '√Åo Gi√°p L√Ω T∆∞·ªüng',
              description: 'NƒÉng l·ª±c √°o gi√°p d·ª±a tr√™n Thi√™n ph√∫ H·ªá C·ª• Th·ªÉ H√≥a, c√≥ th·ªÉ c·ª• th·ªÉ h√≥a trang b·ªã b·∫£o h·ªô ho√†n h·∫£o.',
              majorTalent: 'H·ªá C·ª• Th·ªÉ H√≥a (T√¨nh Y√™u L√Ω T∆∞·ªüng)',
            },
            ring: {
              icon: 'üèÜ',
              name: 'Nh·∫´n Cam K·∫øt',
              description: 'NƒÉng l·ª±c nh·∫´n d·ª±a tr√™n Thi√™n ph√∫ H·ªá C·ª• Th·ªÉ H√≥a, c√≥ th·ªÉ c·ª• th·ªÉ h√≥a nh·∫´n s·ªü h·ªØu s·ª©c m·∫°nh to l·ªõn.',
              majorTalent: 'H·ªá C·ª• Th·ªÉ H√≥a (T√¨nh Y√™u L√Ω T∆∞·ªüng)',
            },
            npc: {
              icon: 'ü§ñ',
              name: 'NPC Ho√†n H·∫£o',
              description: 'NƒÉng l·ª±c NPC d·ª±a tr√™n Thi√™n ph√∫ H·ªá C·ª• Th·ªÉ H√≥a, c√≥ th·ªÉ c·ª• th·ªÉ h√≥a tr·ª£ th·ªß ho√†n h·∫£o.',
              majorTalent: 'H·ªá C·ª• Th·ªÉ H√≥a (T√¨nh Y√™u L√Ω T∆∞·ªüng)',
            },
            contract: {
              icon: 'üìã',
              name: 'Kh·∫ø ∆Ø·ªõc Qu√°i ƒê√†m',
              description: 'NƒÉng l·ª±c kh·∫ø ∆∞·ªõc d·ª±a tr√™n Thi√™n ph√∫ H·ªá ƒê·∫∑c Ch·∫•t, c√≥ th·ªÉ k√Ω k·∫øt kh·∫ø ∆∞·ªõc v·ªõi Quy T·∫Øc Qu√°i ƒê√†m.',
              majorTalent: 'H·ªá ƒê·∫∑c Ch·∫•t (T√¨nh Y√™u V·∫∑n V·∫πo)',
            },
            resonance: {
              icon: 'üéµ',
              name: 'C·ªông H∆∞·ªüng C·∫£m X√∫c',
              description: 'NƒÉng l·ª±c c·ªông h∆∞·ªüng d·ª±a tr√™n Thi√™n ph√∫ H·ªá ƒê·∫∑c Ch·∫•t, c√≥ th·ªÉ ti·∫øn h√†nh c·ªông h∆∞·ªüng c·∫£m x√∫c v·ªõi m·ª•c ti√™u.',
              majorTalent: 'H·ªá ƒê·∫∑c Ch·∫•t (T√¨nh Y√™u V·∫∑n V·∫πo)',
            },
            chaos: {
              icon: 'üåÄ',
              name: 'H·ªón H·ª£p H·ªón Mang',
              description: 'NƒÉng l·ª±c h·ªón h·ª£p d·ª±a tr√™n Thi√™n ph√∫ H·ªá ƒê·∫∑c Ch·∫•t, c√≥ th·ªÉ h·ªón h·ª£p t√¨nh y√™u kh√°c nhau t·∫°o ra k·ªπ nƒÉng m·ªõi.',
              majorTalent: 'H·ªá ƒê·∫∑c Ch·∫•t (T√¨nh Y√™u V·∫∑n V·∫πo)',
            },
          };

          this.init();
        }

        init() {
          this.bindEvents();

          this.checkSkillUnlock();
        }

        bindEvents() {
          $(document).on('click', '.skill-btn', e => {
            const skillType = $(e.currentTarget).data('skill-type');
            if (skillType) {
              this.showSkillPopup(skillType, e);
            }
          });

          $(document).on('click', e => {
            if (!$(e.target).closest('.skill-detail-popup').length && !$(e.target).closest('.skill-btn').length) {
              this.hideSkillPopup();
            }
          });
        }

        checkSkillUnlock() {
          try {
            $('#skills-section').show();
            this.updateSkillButtons();
            console.log('üéØ H·ªá th·ªëng k·ªπ nƒÉng ƒë√£ hi·ªÉn th·ªã (kh√¥ng gi·ªõi h·∫°n m·ªü kh√≥a)');
          } catch (error) {
            console.error('Hi·ªÉn th·ªã k·ªπ nƒÉng th·∫•t b·∫°i:', error);
            $('#skills-section').hide();
          }
        }

        updateSkillButtons() {
          let majorTalent = 'H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)';
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              console.log('üîç D·ªØ li·ªáu MVU:', mvuData);
              majorTalent = Mvu.getMvuVariable(mvuData, 'trainer.talent.majorTalent.name', { default_value: null });
              console.log('üîç L·∫•y ƒê·∫°i Thi√™n Ph√∫ l·∫ßn 1:', majorTalent, 'Lo·∫°i:', typeof majorTalent);
              if (!majorTalent || majorTalent === '' || majorTalent === 'Kh√¥ng') {
                if (window.teresenDebug && typeof window.teresenDebug.getAllVariables === 'function') {
                  const allVars = window.teresenDebug.getAllVariables();
                  console.log('üîç T·∫•t c·∫£ bi·∫øn:', allVars);
                  majorTalent = window.teresenDebug.getVariable(allVars, 'stat_data.trainer.talent.majorTalent.name', null);
                  console.log('üîç L·∫•y ƒê·∫°i Thi√™n Ph√∫ ph∆∞∆°ng √°n d·ª± ph√≤ng:', majorTalent, 'Lo·∫°i:', typeof majorTalent);
                }
              }
              if (!majorTalent || majorTalent === '' || majorTalent === 'Kh√¥ng') {
                console.warn('‚ö†Ô∏è T·∫•t c·∫£ ph∆∞∆°ng ph√°p ƒë·ªÅu th·∫•t b·∫°i, s·ª≠ d·ª•ng gi√° tr·ªã m·∫∑c ƒë·ªãnh');
                majorTalent = 'H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)';
              }
              if (typeof majorTalent === 'string') {
                majorTalent = majorTalent.trim();
              }

              console.log('üéØ ƒê·∫°i Thi√™n Ph√∫ cu·ªëi c√πng s·ª≠ d·ª•ng:', majorTalent, 'Lo·∫°i:', typeof majorTalent);
            }
          } catch (error) {
            console.warn('L·∫•y ƒê·∫°i Thi√™n Ph√∫ th·∫•t b·∫°i, s·ª≠ d·ª•ng gi√° tr·ªã m·∫∑c ƒë·ªãnh:', error);
          }
          const skills = this.getSkillsByMajorTalent(majorTalent);
          console.log('üéØ K·ªπ nƒÉng l·∫•y ƒë∆∞·ª£c:', skills);
          const container = $('#skills-section');
          container.empty();

          if (skills.length === 0) {
            container.html('<div class="no-skills-message">Ti·ªÅm nƒÉng ch∆∞a th·ª©c t·ªânh, t·∫°m kh√¥ng c√≥ k·ªπ nƒÉng</div>');
          } else {
            skills.forEach(skill => {
              const button = $(`
                <button class="skill-btn" data-skill-type="${skill.type}" title="${skill.name}">
                  <span class="skill-icon">${skill.icon}</span>
                </button>
              `);
              container.append(button);
            });
          }
        }

        getSkillsByMajorTalent(majorTalent) {
          if (typeof majorTalent === 'string') {
            majorTalent = majorTalent.trim();
          }

          const skillMapping = {
            'H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)': [
              { type: 'defense', icon: 'üõ°Ô∏è', name: 'K·ªπ NƒÉng Ph√≤ng Th·ªß' },
              { type: 'rule_enhance', icon: 'üìú', name: 'Quy T·∫Øc Th·∫•u Th·ªã' },
              { type: 'chain_enhance', icon: 'üîó', name: 'Ki·ªÉm So√°t Xi·ªÅng X√≠ch' },
            ],
            'H·ªá Bi·∫øn H√≥a (T√¨nh Y√™u D·ªëi Tr√°)': [
              { type: 'rule_change', icon: 'üìù', name: 'S·ª≠a ƒê·ªïi Quy T·∫Øc' },
              { type: 'emotion', icon: 'üí≠', name: 'Thao T√∫ng T√¨nh C·∫£m' },
              { type: 'shadow', icon: 'üë§', name: 'Thao T√∫ng B√≥ng' },
            ],
            'H·ªá Ph√≥ng X·∫° (T√¨nh Y√™u Hy Sinh)': [
              { type: 'emotion_release', icon: 'üíî', name: 'Gi·∫£i Ph√≥ng C·∫£m X√∫c' },
              { type: 'sacrifice', icon: '‚ö∞Ô∏è', name: 'Hi·∫øn T·∫ø Sinh M·ªánh' },
              { type: 'phantom', icon: 'üëª', name: 'C·ª• Th·ªÉ H√≥a Ph√¢n Th√¢n' },
            ],
            'H·ªá Thao T√°c (T√¨nh Y√™u Ki·ªÉm So√°t)': [
              { type: 'suggestion', icon: 'üß†', name: '√Åm Th·ªã T√¢m L√Ω' },
              { type: 'control', icon: 'üéÆ', name: 'Thao T√∫ng Tinh Th·∫ßn' },
              { type: 'absorption', icon: 'üíï', name: 'H·∫•p Th·ª• T√¨nh Y√™u' },
            ],
            'H·ªá C·ª• Th·ªÉ H√≥a (T√¨nh Y√™u L√Ω T∆∞·ªüng)': [
              { type: 'armor', icon: 'üõ°Ô∏è', name: '√Åo Gi√°p L√Ω T∆∞·ªüng' },
              { type: 'ring', icon: 'üíç', name: 'Nh·∫´n Cam K·∫øt' },
              { type: 'npc', icon: 'ü§ñ', name: 'NPC Ho√†n H·∫£o' },
            ],
            'H·ªá ƒê·∫∑c Ch·∫•t (T√¨nh Y√™u V·∫∑n V·∫πo)': [
              { type: 'contract', icon: 'üìã', name: 'Kh·∫ø ∆Ø·ªõc Qu√°i ƒê√†m' },
              { type: 'resonance', icon: 'üéµ', name: 'C·ªông H∆∞·ªüng C·∫£m X√∫c' },
              { type: 'chaos', icon: 'üåÄ', name: 'H·ªón H·ª£p H·ªón Mang' },
            ],
          };

          console.log('üîç Kh√≥a √°nh x·∫° k·ªπ nƒÉng:', Object.keys(skillMapping));
          console.log('üîç T√¨m ƒê·∫°i Thi√™n Ph√∫:', majorTalent);
          console.log('üîç C√≥ kh·ªõp hay kh√¥ng:', skillMapping.hasOwnProperty(majorTalent));
          if (skillMapping[majorTalent]) {
            console.log('‚úÖ T√¨m th·∫•y k·ªπ nƒÉng kh·ªõp:', skillMapping[majorTalent]);
            return skillMapping[majorTalent];
          }
          for (const key in skillMapping) {
            if (majorTalent.includes(key) || key.includes(majorTalent)) {
              console.log('‚úÖ Kh·ªõp m·ªù th√†nh c√¥ng:', key, '->', skillMapping[key]);
              return skillMapping[key];
            }
          }

          console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y k·ªπ nƒÉng kh·ªõp, s·ª≠ d·ª•ng gi√° tr·ªã m·∫∑c ƒë·ªãnh');
          return skillMapping['H·ªá C∆∞·ªùng H√≥a (T√¨nh Y√™u Chi·∫øm H·ªØu)'];
        }

        showSkillPopup(skillType, event) {
          const skill = this.skillData[skillType];

          if (!skill) return;

          this.currentSkill = skillType;

          $('.skill-detail-popup').remove();

          const popup = $(`

            <div class="skill-detail-popup">

              <div class="skill-header">
                <span class="skill-icon">${skill.icon}</span>
                <span class="skill-title">${skill.name}</span>
              </div>
              <div class="skill-desc">${skill.description}</div>

              <div>

                <button class="skill-use-btn" data-target="self">üë§ D√πng l√™n b·∫£n th√¢n</button>

                <button class="skill-use-btn" data-target="uma">üêé D√πng l√™n Uma Musume</button>

              </div>

            </div>

          `);

          popup.find('.skill-use-btn').on('click', e => {
            const target = $(e.target).data('target');

            this.useSkill(target);
          });

          const button = $(event.target).closest('.skill-btn');

          const buttonOffset = button.offset();

          popup.css({
            position: 'absolute',

            top: buttonOffset.top - popup.outerHeight() - 10,

            left: buttonOffset.left,

            zIndex: 10001,
          });
          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay && overlay.style.display !== 'none') {
            overlay.appendChild(popup[0]);
            console.log('‚úÖ C·ª≠a s·ªï k·ªπ nƒÉng ƒë√£ ƒë∆∞·ª£c th√™m v√†o l·ªõp ph·ªß to√†n m√†n h√¨nh');
          } else {
            $('body').append(popup);
          }

          const skillSound = document.getElementById('item-detail-sound');

          if (skillSound) {
            skillSound.currentTime = 0;

            skillSound.play().catch(e => console.log('Ph√°t √¢m thanh th·∫•t b·∫°i:', e));
          }
        }

        hideSkillPopup() {
          $('.skill-detail-popup').remove();

          this.currentSkill = null;
        }

        useSkill(target) {
          if (!this.currentSkill) return;

          const skill = this.skillData[this.currentSkill];

          if (target === 'self') {
            const actionText = `[S·ª≠ d·ª•ng k·ªπ nƒÉng: ${skill.name}]`;

            const actionInput = document.getElementById('action-input');
            if (actionInput) {
              actionInput.value = actionText;
              actionInput.focus();
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage(`ƒê√£ ƒëi·ªÅn ${actionText} v√†o √¥ nh·∫≠p`);
              }
            } else {
              console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ action-input');
            }

            this.hideSkillPopup();
          } else if (target === 'uma') {

            this.hideSkillPopup();

            startSkillSelection(skill.name, this.currentSkill);
          }
        }

        showTemporaryMessage(message) {
          const messageDiv = $('<div class="temporary-message">')
            .text(message)

            .css({
              position: 'fixed',

              top: '50%',

              left: '50%',

              transform: 'translate(-50%, -50%)',

              background: 'rgba(0, 0, 0, 0.8)',

              color: 'white',

              padding: '10px 20px',

              borderRadius: '8px',

              fontSize: '14px',

              zIndex: 1000,

              animation: 'fadeInOut 2s ease-in-out',
            });

          $('body').append(messageDiv);

          setTimeout(() => {
            messageDiv.remove();
          }, 2000);
        }
      }

      $(document).ready(function () {
        window.skillSystem = new SkillSystem();
        if (window.teresenDebug && window.teresenDebug.updateInterface) {
          const originalUpdateInterface = window.teresenDebug.updateInterface;
          window.teresenDebug.updateInterface = function () {
            originalUpdateInterface.call(this);
            if (window.skillSystem) {
              window.skillSystem.checkSkillUnlock();
            }
          };
        }
        function setupMusicControls() {
          console.log('üéµ Kh·ªüi t·∫°o ƒëi·ªÅu khi·ªÉn nh·∫°c');
          $('#music-controller').on('click', function () {
            console.log('üéµ N√∫t nh·∫°c ƒë∆∞·ª£c nh·∫•p');

            const audio1 = document.getElementById('bgm-track1');
            const audio2 = document.getElementById('bgm-track2');
            if (audio1) audio1.volume = 0.3;
            if (audio2) audio2.volume = 0.3;
            if (audio1 && audio1.paused && audio2 && audio2.paused) {
              audio1
                .play()
                .then(() => {
                  console.log('üéµ B·∫Øt ƒë·∫ßu ph√°t nh·∫°c 1');
                  $(this).text('üéµ ƒêang ph√°t 1');
                })
                .catch(e => console.log('Ph√°t th·∫•t b·∫°i:', e));
            } else if (audio1 && !audio1.paused) {
              audio1.pause();
              audio1.currentTime = 0;
              audio2
                .play()
                .then(() => {
                  console.log('üéµ B·∫Øt ƒë·∫ßu ph√°t nh·∫°c 2');
                  $(this).text('üéµ ƒêang ph√°t 2');
                })
                .catch(e => console.log('Ph√°t th·∫•t b·∫°i:', e));
            } else if (audio2 && !audio2.paused) {
              audio2.pause();
              audio2.currentTime = 0;
              console.log('üéµ D·ª´ng ph√°t');
              $(this).text('üéµ ƒêi·ªÅu khi·ªÉn nh·∫°c');
            }
          });
        }
        setupMusicControls();
      });
      class TarotDivinationSystem {
        constructor() {
          console.log('üé¥ H√†m t·∫°o h·ªá th·ªëng b√≥i Tarot b·∫Øt ƒë·∫ßu');
          this.tarotCards = [
            { name: 'G√£ Kh·ªù', meaning: 'Kh·ªüi ƒë·∫ßu m·ªõi, tinh th·∫ßn m·∫°o hi·ªÉm', reversed: 'H·∫•p t·∫•p, v√¥ tr√°ch nhi·ªám' },
            { name: '·∫¢o Thu·∫≠t Gia', meaning: 'S√°ng t·∫°o, n·∫Øm v·ªØng k·ªπ nƒÉng', reversed: 'K·ªπ nƒÉng kh√¥ng ƒë·ªß, l√£ng ph√≠ c∆° h·ªôi' },
            { name: 'N·ªØ T∆∞ T·∫ø', meaning: 'Tr·ª±c gi√°c, tri th·ª©c b√≠ ·∫©n', reversed: 'S·ª± th·∫≠t ·∫©n gi·∫•u, hi·ªán t∆∞·ª£ng b·ªÅ ngo√†i' },
            { name: 'N·ªØ Ho√†ng', meaning: 'B·ªôi thu, m·∫´u t√≠nh, s√°ng t·∫°o', reversed: 'Ph·ª• thu·ªôc, b·∫£o v·ªá qu√° m·ª©c' },
            { name: 'Ho√†ng ƒê·∫ø', meaning: 'Quy·ªÅn uy, kh·∫£ nƒÉng l√£nh ƒë·∫°o, ·ªïn ƒë·ªãnh', reversed: 'Chuy√™n ch·∫ø, thi·∫øu linh ho·∫°t' },
            { name: 'Gi√°o Ho√†ng', meaning: 'Truy·ªÅn th·ªëng, h∆∞·ªõng d·∫´n tinh th·∫ßn', reversed: 'Gi√°o ƒëi·ªÅu, h·∫°n ch·∫ø' },
            { name: 'T√¨nh Nh√¢n', meaning: 'T√¨nh y√™u, l·ª±a ch·ªçn, h√†i h√≤a', reversed: 'Kh√¥ng h√†i h√≤a, l·ª±a ch·ªçn sai l·∫ßm' },
            { name: 'Chi·∫øn Xa', meaning: 'Chi·∫øn th·∫Øng, √Ω ch√≠, ki·ªÉm so√°t', reversed: 'M·∫•t ki·ªÉm so√°t, th·∫•t b·∫°i' },
            { name: 'S·ª©c M·∫°nh', meaning: 'S·ª©c m·∫°nh n·ªôi t·∫°i, d≈©ng kh√≠', reversed: 'Y·∫øu ƒëu·ªëi, thi·∫øu t·ª± tin' },
            { name: '·∫®n Sƒ©', meaning: 'Tr√≠ tu·ªá, n·ªôi t√¢m, h∆∞·ªõng d·∫´n', reversed: 'C√¥ ƒë·ªôc, t·ª´ ch·ªëi gi√∫p ƒë·ª°' },
            { name: 'B√°nh Xe V·∫≠n M·ªánh', meaning: 'Thay ƒë·ªïi, b∆∞·ªõc ngo·∫∑t v·∫≠n m·ªánh', reversed: 'V·∫≠n xui, ƒë√¨nh tr·ªá' },
            { name: 'C√¥ng L√Ω', meaning: 'C√¥ng b·∫±ng, ch√¢n l√Ω, c√¢n b·∫±ng', reversed: 'B·∫•t c√¥ng, ƒë·ªãnh ki·∫øn' },
            { name: 'Ng∆∞·ªùi Treo Ng∆∞·ª£c', meaning: 'Hy sinh, g√≥c nh√¨n m·ªõi', reversed: 'Hy sinh v√¥ nghƒ©a' },
            { name: 'T·ª≠ Th·∫ßn', meaning: 'K·∫øt th√∫c, chuy·ªÉn bi·∫øn, t√°i sinh', reversed: 'ƒê√¨nh tr·ªá, t·ª´ ch·ªëi thay ƒë·ªïi' },
            { name: 'Ti·∫øt Ch·∫ø', meaning: 'C√¢n b·∫±ng, ch·ª´ng m·ª±c, h√†i h√≤a', reversed: 'Qu√° ƒë·ªô, m·∫•t c√¢n b·∫±ng' },
            { name: '√Åc Qu·ª∑', meaning: 'Tr√≥i bu·ªôc, d·ª•c v·ªçng v·∫≠t ch·∫•t', reversed: 'Tho√°t kh·ªèi tr√≥i bu·ªôc, th·ª©c t·ªânh' },
            { name: 'T√≤a Th√°p', meaning: 'Thay ƒë·ªïi ƒë·ªôt ng·ªôt, kh·∫£i huy·ªÅn', reversed: 'Tr√°nh tai h·ªça, t√°i thi·∫øt' },
            { name: 'Ng√¥i Sao', meaning: 'Hy v·ªçng, c·∫£m h·ª©ng, ni·ªÅm tin', reversed: 'Th·∫•t v·ªçng, thi·∫øu ni·ªÅm tin' },
            { name: 'M·∫∑t TrƒÉng', meaning: 'Tr·ª±c gi√°c, ·∫£o t∆∞·ªüng, s·ª£ h√£i', reversed: 'Gi·∫£i ph√≥ng s·ª£ h√£i, s·ª± th·∫≠t' },
            { name: 'M·∫∑t Tr·ªùi', meaning: 'Th√†nh c√¥ng, vui v·∫ª, s·ª©c s·ªëng', reversed: 'Kh√≥ khƒÉn t·∫°m th·ªùi' },
            { name: 'Ph√°n X√©t', meaning: 'T√°i sinh, ti·∫øng g·ªçi n·ªôi t√¢m', reversed: 'T·ª± nghi ng·ªù, t·ª´ ch·ªëi thay ƒë·ªïi' },
            { name: 'Th·∫ø Gi·ªõi', meaning: 'Ho√†n th√†nh, h√†i h√≤a, th√†nh c√¥ng', reversed: 'Ch∆∞a ho√†n th√†nh, tr√¨ ho√£n' },
          ];

          this.tarotItems = {
            'L√¥ng V≈© Hermes': {
              description: 'M·ªôt chi·∫øc l√¥ng v≈© tr√™n ƒë√¥i c√°nh c·ªßa th·∫ßn ƒë∆∞a tin Hermes, c√≥ th·ªÉ mang l·∫°i may m·∫Øn',
              effect: 'May M·∫Øn +8, m·ªü kh√≥a 1 ƒë·ªëi tho·∫°i ·∫©n',
              rarity: 'Hi·∫øm',
              feature: 'ƒê√¥i c√°nh ƒë∆∞a tin',
            },
            'Su·ªëi Ngu·ªìn Tr√≠ Tu·ªá': {
              description: 'M·ªôt gi·ªçt n∆∞·ªõc t·ª´ Su·ªëi ngu·ªìn tr√≠ tu·ªá trong th·∫ßn tho·∫°i B·∫Øc √Çu',
              effect: 'L√Ω Tr√≠ +10, nh·∫≠n 1 ki·∫øn th·ª©c ƒë·∫∑c bi·ªát',
              rarity: 'Hi·∫øm',
              feature: 'Khai s√°ng tr√≠ tu·ªá',
            },
            'G∆∞∆°ng Thanh T·∫©y': {
              description: 'T·∫•m g∆∞∆°ng b√≠ ·∫©n c√≥ th·ªÉ xua tan nƒÉng l∆∞·ª£ng ti√™u c·ª±c',
              effect: 'Thanh t·∫©y 1 tr·∫°ng th√°i ti√™u c·ª±c, May M·∫Øn +5',
              rarity: 'Hi·∫øm',
              feature: '√Ånh s√°ng thanh t·∫©y',
            },
            'ƒê·ªìng Xu ƒê·ªãnh M·ªánh': {
              description: 'ƒê·ªìng xu b√≠ ·∫©n c√≥ th·ªÉ thay ƒë·ªïi k·∫øt qu·∫£ m·ªôt s·ª± ki·ªán ng·∫´u nhi√™n',
              effect: 'K·∫øt qu·∫£ s·ª± ki·ªán ng·∫´u nhi√™n l·∫ßn sau +20%',
              rarity: 'Hi·∫øm',
              feature: 'ƒê·∫£o ng∆∞·ª£c v·∫≠n m·ªánh',
            },
            'M·∫£nh V·ª° Linh H·ªìn': {
              description: 'M·∫£nh v·ª° nh·ªè t·ª´ linh h·ªìn b√≠ ·∫©n',
              effect: 'ƒê·ªô thi·ªán c·∫£m Uma Musume ng·∫´u nhi√™n +8, L√Ω Tr√≠ +3',
              rarity: 'Hi·∫øm',
              feature: 'C·ªông h∆∞·ªüng linh h·ªìn',
            },
            'H·∫°t C√°t Th·ªùi Gian': {
              description: 'M·ªôt h·∫°t c√°t t·ª´ d√≤ng s√¥ng th·ªùi gian',
              effect: 'S·ªë ng√†y ·ªü tr∆∞·ªùng +1, Th·ªÉ L·ª±c +10',
              rarity: 'Hi·∫øm',
              feature: 'Thao t√∫ng th·ªùi gian',
            },
          };

          this.bindEvents();
          console.log('üé¥ H√†m t·∫°o h·ªá th·ªëng b√≥i Tarot ho√†n t·∫•t');
        }

        bindEvents() {
          console.log('üé¥ R√†ng bu·ªôc s·ª± ki·ªán b√≥i Tarot');
          $(document).on('click', '#tarot-divination', e => {
            console.log('üé¥ N√∫t b√≥i Tarot ƒë∆∞·ª£c nh·∫•p');
            const sound = document.getElementById('tarot-shuffle');
            if (sound) {
              sound.currentTime = 0;
              sound.play().catch(e => console.log('Ph√°t √¢m thanh Tarot th·∫•t b·∫°i:', e));
            }
            e.preventDefault();
            e.stopPropagation();
            this.openTarotModal();
          });
          $(document).on('click', '#close-tarot-btn', e => {
            console.log('üé¥ ƒê√≥ng modal b√≥i Tarot');
            e.preventDefault();
            e.stopPropagation();
            this.closeTarotModal();
          });
          $(document).on('click', '.spread-btn:not(.disabled)', e => {
            console.log('üé¥ N√∫t b√≥i ƒë∆∞·ª£c nh·∫•p');
            e.preventDefault();
            e.stopPropagation();
            const spreadType = $(e.currentTarget).data('spread');
            const cost = $(e.currentTarget).data('cost');
            this.performDivination(spreadType, cost);
          });

          console.log('üé¥ R√†ng bu·ªôc s·ª± ki·ªán b√≥i Tarot ho√†n t·∫•t');
        }

        openTarotModal() {
          console.log('üé¥ M·ªü modal b√≥i Tarot');
          this.updateTarotInfo();
          this.updateSpreadButtons();
          const modal = document.getElementById('tarot-modal');
          if (modal) {
            const overlay = document.getElementById('teresen-fullscreen-overlay');
            if (overlay && modal.parentNode !== overlay) {
              modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
              overlay.appendChild(modal);
            }
          }
          $('#tarot-modal').show();
          console.log('üé¥ Modal b√≥i Tarot ƒë√£ hi·ªÉn th·ªã');
        }

        closeTarotModal() {
          $('#tarot-modal').hide();
          $('#tarot-result').hide();
        }

        updateTarotInfo() {
          console.log('üé¥ C·∫≠p nh·∫≠t th√¥ng tin b√≥i Tarot');
          let sanity = 100;
          let gameDay = 1;
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              sanity = Mvu.getMvuVariable(mvuData, 'trainer.sanity', { default_value: 100 });
              gameDay = Mvu.getMvuVariable(mvuData, 'trainer.daysInSchool', { default_value: 1 });
              console.log('üé¥ L·∫•y gi√° tr·ªã L√Ω tr√≠ t·ª´ MVU th√†nh c√¥ng:', sanity);
              console.log('üé¥ L·∫•y s·ªë ng√†y ch∆°i t·ª´ MVU th√†nh c√¥ng:', gameDay);
            }
          } catch (error) {
            console.warn('üé¥ L·∫•y gi√° tr·ªã L√Ω tr√≠ th·∫•t b·∫°i, s·ª≠ d·ª•ng gi√° tr·ªã m·∫∑c ƒë·ªãnh:', error);
          }

          const remaining = this.getDailyRemaining();
          console.log('üé¥ L√Ω tr√≠:', sanity, 'S·ªë ng√†y ch∆°i:', gameDay, 'S·ªë l·∫ßn c√≤n l·∫°i:', remaining);
          $('#tarot-sanity').text(sanity);
          const remainingText = `Ng√†y th·ª© ${gameDay} trong game - S·ªë l·∫ßn c√≤n l·∫°i: ${remaining}`;
          $('#tarot-remaining').text(remainingText);
          if (remaining === 0) {
            $('#tarot-remaining').append(
              '<br><small style="color: #ef4444; font-size: 0.8rem;">C·∫ßn ƒë·ª£i ƒë·∫øn ng√†y ti·∫øp theo trong game m·ªõi c√≥ th·ªÉ ti·∫øp t·ª•c s·ª≠ d·ª•ng</small>',
            );
          }
        }

        updateSpreadButtons() {
          console.log('üé¥ C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t b√≥i');
          let sanity = 100;
          let schoolDays = 0;
          try {
            const allVars = this.getAllVariables();
            sanity = this.getVariable(allVars, 'stat_data.trainer.sanity', 100);
            schoolDays = this.getVariable(allVars, 'stat_data.trainer.daysInSchool', 1);
            console.log('üé¥ L·∫•y bi·∫øn b·∫±ng getAllVariables th√†nh c√¥ng:', { sanity, schoolDays });
          } catch (error) {
            console.warn('üé¥ L·∫•y bi·∫øn th·∫•t b·∫°i, s·ª≠ d·ª•ng gi√° tr·ªã m·∫∑c ƒë·ªãnh:', error);
          }

          console.log('üé¥ L√Ω tr√≠:', sanity, 'S·ªë ng√†y ·ªü tr∆∞·ªùng:', schoolDays);
          console.log('üé¥ getGameDay() tr·∫£ v·ªÅ:', this.getGameDay());

          $('.spread-btn').each((index, button) => {
            const $btn = $(button);
            const cost = $btn.data('cost');
            const requirement = $btn.data('requirement');

            let disabled = false;
            let reason = '';

            if (sanity < cost) {
              disabled = true;
              reason = 'L√Ω tr√≠ kh√¥ng ƒë·ªß';
            } else if (requirement && schoolDays < requirement) {
              disabled = true;
              reason = 'S·ªë ng√†y ·ªü tr∆∞·ªùng kh√¥ng ƒë·ªß';
            }

            if (disabled) {
              $btn.addClass('disabled');
              $btn.attr('title', reason);
            } else {
              $btn.removeClass('disabled');
              $btn.attr('title', '');
            }
          });
          console.log('üé¥ C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t b√≥i ho√†n t·∫•t');
        }

        async performDivination(spreadType, cost) {
          console.log('üé¥ B·∫Øt ƒë·∫ßu b√≥i:', spreadType, 'Ti√™u hao:', cost);
          console.log('üé¥ Gi·ªõi h·∫°n s·ªë ng√†y b√≥i ƒë√£ b·ªã v√¥ hi·ªáu h√≥a');
          let currentSanity = 100;
          try {
            if (window.teresenDebug && typeof window.teresenDebug.getAllVariables === 'function') {
              const allVars = window.teresenDebug.getAllVariables();
              currentSanity = window.teresenDebug.getVariable(allVars, 'stat_data.trainer.sanity', 100);
              console.log('üé¥ L·∫•y gi√° tr·ªã L√Ω tr√≠ b·∫±ng teresenDebug:', currentSanity);
            } else if (typeof this.getAllVariables === 'function') {
              const allVars = this.getAllVariables();
              currentSanity = this.getVariable(allVars, 'stat_data.trainer.sanity', 100);
              console.log('üé¥ L·∫•y gi√° tr·ªã L√Ω tr√≠ b·∫±ng this.getAllVariables:', currentSanity);
            } else if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              currentSanity = Mvu.getMvuVariable(mvuData, 'trainer.sanity', { default_value: 100 });
              console.log('üé¥ L·∫•y gi√° tr·ªã L√Ω tr√≠ b·∫±ng MVU:', currentSanity);
            }
          } catch (error) {
            console.warn('üé¥ L·∫•y gi√° tr·ªã L√Ω tr√≠ th·∫•t b·∫°i:', error);
          }
          console.log('üé¥ B√≥i kh√¥ng tr·ª´ L√Ω tr√≠ (t·∫°m th·ªùi v√¥ hi·ªáu h√≥a)');
          this.showDivinationStartAnimation(spreadType);
          setTimeout(async () => {
            const result = await this.generateDivinationResult(spreadType);
            $('.tarot-start-animation').fadeOut(500, () => {
              $('.tarot-start-animation').remove();
            });
            this.showTarotResultPopup(result);
          }, 2000);
          this.updateTarotInfo();
          this.updateSpreadButtons();
          this.recordDailyUsage();
        }

        async generateDivinationResult(spreadType) {
          const cards = [];
          const cardCount = this.getCardCount(spreadType);

          for (let i = 0; i < cardCount; i++) {
            const card = this.getRandomCard();
            cards.push(card);
          }

          const result = await this.interpretCards(cards, spreadType);
          return { cards, result };
        }

        getCardCount(spreadType) {
          const counts = {
            single: 1,
            timeline: 3,
            choice: 2,
            hexagram: 6,
            celtic: 10,
            zodiac: 12,
          };
          return counts[spreadType] || 1;
        }

        getRandomCard() {
          const card = this.tarotCards[Math.floor(Math.random() * this.tarotCards.length)];
          const isReversed = Math.random() < 0.3; 
          return {
            ...card,
            reversed: isReversed,
            meaning: isReversed ? card.reversed : card.meaning,
          };
        }

        async interpretCards(cards, spreadType) {
          const result = {
            type: this.determineResultType(cards),
            luckChange: 0,
            reasonChange: 0,
            canGetItem: false,
            affectionChange: 0,
            interpretation: '',
            effects: [],
          };
          switch (spreadType) {
            case 'single':
              result.luckChange = this.calculateLuckChange(cards);
              result.reasonChange = this.calculateReasonChange(cards);
              result.canGetItem = Math.random() < 0.15;
              result.affectionChange = this.calculateAffectionChange(cards);
              break;
            case 'timeline':
              result.luckChange = this.calculateLuckChange(cards) * 1.5;
              result.reasonChange = this.calculateReasonChange(cards) * 1.5;
              result.canGetItem = Math.random() < 0.2;
              result.affectionChange = this.calculateAffectionChange(cards) * 1.5;
              break;
            case 'choice':
              result.luckChange = this.calculateLuckChange(cards) * 0.8;
              result.reasonChange = this.calculateReasonChange(cards) * 0.8;
              result.canGetItem = Math.random() < 0.12;
              result.affectionChange = this.calculateAffectionChange(cards) * 0.8;
              break;
            default:
              result.luckChange = this.calculateLuckChange(cards) * 2;
              result.reasonChange = this.calculateReasonChange(cards) * 2;
              result.canGetItem = Math.random() < 0.25;
              result.affectionChange = this.calculateAffectionChange(cards) * 2;
          }
          result.interpretation = this.generateInterpretation(cards, spreadType);
          console.log('üé¥ Hi·ªáu qu·∫£ b√≥i t·∫°m th·ªùi kh√¥ng √°p d·ª•ng (ƒë√£ v√¥ hi·ªáu h√≥a)');

          return result;
        }

        determineResultType(cards) {
          const positiveCards = cards.filter(card => !card.reversed).length;
          const totalCards = cards.length;
          const positiveRatio = positiveCards / totalCards;

          if (positiveRatio >= 0.8) return 'Th·∫ßn t√≠ch hi·ªÉn hi·ªán';
          if (positiveRatio >= 0.6) return 'Khai s√°ng tr√≠ tu·ªá';
          if (positiveRatio >= 0.4) return 'Bi·∫øn ƒë·ªông v·∫≠n m·ªánh';
          if (positiveRatio >= 0.2) return 'S∆∞∆°ng m√π bao ph·ªß';
          if (positiveRatio >= 0.1) return 'H·ªón mang v·ªçng l·∫°i';
          return 'L·ªùi th√¨ th·∫ßm v·ª±c th·∫≥m';
        }

        calculateLuckChange(cards) {
          let change = 0;
          cards.forEach(card => {
            if (card.reversed) {
              change -= 3 + Math.random() * 5;
            } else {
              change += 3 + Math.random() * 5;
            }
          });
          return Math.round(change / cards.length);
        }

        calculateReasonChange(cards) {
          let change = 0;
          cards.forEach(card => {
            if (card.reversed) {
              change -= 2 + Math.random() * 3;
            } else {
              change += 2 + Math.random() * 3;
            }
          });
          return Math.round(change / cards.length);
        }

        calculateAffectionChange(cards) {
          let change = 0;
          cards.forEach(card => {
            if (card.reversed) {
              change -= 2 + Math.random() * 3;
            } else {
              change += 2 + Math.random() * 3;
            }
          });
          return Math.round(change / cards.length);
        }

        generateInterpretation(cards, spreadType) {
          const spreadNames = {
            single: 'B√≥i m·ªôt l√° b√†i',
            timeline: 'B√≥i d√≤ng th·ªùi gian',
            choice: 'B√≥i ch·ªçn m·ªôt trong hai',
            hexagram: 'B√≥i L·ª•c Mang Tinh',
            celtic: 'B√≥i Th·∫≠p T·ª± Celtic',
            zodiac: 'B√≥i M∆∞·ªùi Hai Cung Ho√†ng ƒê·∫°o',
          };

          const spreadDescriptions = {
            single: 'D∆∞·ªõi √°nh trƒÉng huy·ªÅn b√≠, b·∫°n r√∫t ra l√° b√†i ƒë·ªãnh m·ªánh. L√° b√†i n√†y nh∆∞ sao B·∫Øc ƒê·∫©u trong ƒë√™m, ch·ªâ r√µ ph∆∞∆°ng h∆∞·ªõng cho b·∫°n...',
            timeline: 'D√≤ng s√¥ng th·ªùi gian tr·∫£i r·ªông tr∆∞·ªõc m·∫Øt b·∫°n, qu√° kh·ª©, hi·ªán t·∫°i v√† t∆∞∆°ng lai d·ªát n√™n t·∫•m th·∫£m v·∫≠n m·ªánh. M·ªói l√° b√†i ƒë·ªÅu mang s·ª©c n·∫∑ng c·ªßa th·ªùi gian...',
            choice: 'V·∫≠n m·ªánh b√†y ra tr∆∞·ªõc m·∫Øt b·∫°n hai con ƒë∆∞·ªùng, nh∆∞ s·ª± l·ª±a ch·ªçn ·ªü ng√£ t∆∞ ƒë∆∞·ªùng. M·ªói con ƒë∆∞·ªùng ƒë·ªÅu d·∫´n ƒë·∫øn t∆∞∆°ng lai kh√°c nhau...',
            hexagram: 'K√Ω hi·ªáu c·ªï x∆∞a c·ªßa L·ª•c Mang Tinh nh·∫•p nh√°y trong h∆∞ kh√¥ng, s√°u l√° b√†i s·∫Øp x·∫øp nh∆∞ nh·ªØng v√¨ sao, ti·∫øt l·ªô m·∫≠t m√£ v·∫≠n m·ªánh t·∫ßng s√¢u...',
            celtic: 'Tr√≠ tu·ªá c·ªï x∆∞a c·ªßa Th·∫≠p T·ª± Celtic tr·∫£i r·ªông tr∆∞·ªõc m·∫Øt b·∫°n, m∆∞·ªùi l√° b√†i nh∆∞ c√†nh l√° c·ªßa c√¢y s·ª± s·ªëng, th·ªÉ hi·ªán c·∫•u tr√∫c t·∫ßng s√¢u c·ªßa n·ªôi t√¢m...',
            zodiac: 'Tinh t∆∞·ª£ng c·ªßa M∆∞·ªùi Hai Cung Ho√†ng ƒê·∫°o xoay tr√≤n quanh b·∫°n, m∆∞·ªùi hai l√° b√†i nh∆∞ b·∫£n nh·∫°c h√†i h√≤a c·ªßa v≈© tr·ª•, ph·∫£n chi·∫øu s·ª± c√¢n b·∫±ng c·ªßa tr·ªùi ƒë·∫•t...',
          };

          let interpretation = spreadDescriptions[spreadType] || 'Trong nghi th·ª©c b√≥i to√°n b√≠ ·∫©n, b√≠ m·∫≠t c·ªßa v·∫≠n m·ªánh t·ª´ t·ª´ m·ªü ra tr∆∞·ªõc m·∫Øt b·∫°n...';

          interpretation += '\n\n';

          cards.forEach((card, index) => {
            const cardNumber = index + 1;
            const positionText = card.reversed ? 'Ng∆∞·ª£c' : 'Xu√¥i';
            const positionDesc = card.reversed
              ? 'L√° b√†i n√†y xu·∫•t hi·ªán ·ªü v·ªã tr√≠ ng∆∞·ª£c, √°m ch·ªâ th√°ch th·ª©c v√† c·∫£nh b√°o'
              : 'L√° b√†i n√†y xu·∫•t hi·ªán ·ªü v·ªã tr√≠ xu√¥i, mang l·∫°i l·ªùi ch√∫c ph√∫c v√† ch·ªâ d·∫´n';

            interpretation += `L√° b√†i th·ª© ${cardNumber}: ${card.name} (${positionText})\n`;
            interpretation += `${positionDesc}„ÄÇ${card.meaning}\n\n`;
          });
          const positiveCards = cards.filter(card => !card.reversed).length;
          const totalCards = cards.length;
          const positiveRatio = positiveCards / totalCards;

          if (positiveRatio >= 0.8) {
            interpretation += 'üåü G∆∞∆°ng v·∫≠n m·ªánh hi·ªÉn th·ªã, t∆∞∆°ng lai c·ªßa b·∫°n tr√†n ƒë·∫ßy √°nh s√°ng v√† hy v·ªçng. H√£y d≈©ng c·∫£m ti·∫øn b∆∞·ªõc!';
          } else if (positiveRatio >= 0.6) {
            interpretation += '‚ú® M·∫∑c d√π con ƒë∆∞·ªùng ph√≠a tr∆∞·ªõc c√≥ ch√∫t tr·∫Øc tr·ªü, nh∆∞ng tr√≠ tu·ªá v√† l√≤ng d≈©ng c·∫£m s·∫Ω d·∫´n d·∫Øt b·∫°n ƒë·∫øn th√†nh c√¥ng.';
          } else if (positiveRatio >= 0.4) {
            interpretation += 'üåô B√°nh xe v·∫≠n m·ªánh ƒëang quay, h√£y ki√™n nh·∫´n v√† ki√™n tr√¨, b∆∞·ªõc ngo·∫∑t s·∫Øp ƒë·∫øn.';
          } else if (positiveRatio >= 0.2) {
            interpretation += '‚ö° Th√°ch th·ª©c v√† c∆° h·ªôi c√πng t·ªìn t·∫°i, h√†nh s·ª± th·∫≠n tr·ªçng, tr√≠ tu·ªá s·∫Ω gi√∫p b·∫°n v∆∞·ª£t qua kh√≥ khƒÉn.';
          } else {
            interpretation += 'üîÆ √Ånh sao trong b√≥ng t·ªëi l√† qu√Ω gi√° nh·∫•t, h√£y gi·ªØ hy v·ªçng, v·∫≠n m·ªánh cu·ªëi c√πng s·∫Ω ∆∞u √°i ng∆∞·ªùi d≈©ng c·∫£m.';
          }

          return interpretation;
        }

        async applyDivinationEffects(result) {
          console.log('üé¥ √Åp d·ª•ng hi·ªáu qu·∫£ b√≥i to√°n');
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable && Mvu.setMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              if (!mvuData || !mvuData.stat_data) {
                console.error('‚ùå D·ªØ li·ªáu MVU kh√¥ng h·ª£p l·ªá');
                return;
              }
              if (!mvuData.display_data) {
                mvuData.display_data = {};
              }
              if (!mvuData.delta_data) {
                mvuData.delta_data = {};
              }
              if (!mvuData.stat_data.$internal) {
                mvuData.stat_data.$internal = {
                  display_data: mvuData.display_data,
                  delta_data: mvuData.delta_data,
                };
                console.log('‚úÖ ƒê√£ kh·ªüi t·∫°o thu·ªôc t√≠nh $internal');
              } else {
                mvuData.stat_data.$internal.display_data = mvuData.display_data;
                mvuData.stat_data.$internal.delta_data = mvuData.delta_data;
              }
              const currentLuck = Mvu.getMvuVariable(mvuData, 'trainer.luck', { default_value: 50 });
              const newLuck = Math.max(0, Math.min(100, currentLuck + result.luckChange));
              await Mvu.setMvuVariable(mvuData, 'trainer.luck', newLuck, {
                reason: 'Hi·ªáu qu·∫£ b√≥i Tarot',
                is_recursive: true,
              });
              result.effects.push(`May m·∫Øn ${result.luckChange > 0 ? '+' : ''}${result.luckChange}`);
              const currentReason = Mvu.getMvuVariable(mvuData, 'trainer.sanity', { default_value: 100 });
              const newReason = Math.max(0, Math.min(100, currentReason + result.reasonChange));
              await Mvu.setMvuVariable(mvuData, 'trainer.sanity', newReason, {
                reason: 'Hi·ªáu qu·∫£ b√≥i Tarot',
                is_recursive: true,
              });
              result.effects.push(`L√Ω tr√≠ ${result.reasonChange > 0 ? '+' : ''}${result.reasonChange}`);
              await Mvu.replaceMvuData(mvuData, { type: 'chat' });
              console.log('üé¥ √Åp d·ª•ng hi·ªáu qu·∫£ b√≥i to√°n th√†nh c√¥ng');
            }
          } catch (error) {
            console.error('üé¥ √Åp d·ª•ng hi·ªáu qu·∫£ b√≥i to√°n th·∫•t b·∫°i:', error);
          }
          if (result.canGetItem) {
            const itemCheck = this.canGetTarotItem();
            if (itemCheck.canGet) {
              const item = this.getRandomTarotItem();
              if (item) {
                await this.addTarotItem(item, this.tarotItems[item]);
                result.effects.push(`Nh·∫≠n ƒë∆∞·ª£c v·∫≠t ph·∫©m b√≠ ·∫©n: ${item}`);
                this.recordItemAcquisition();
              }
            }
          }
          if (result.affectionChange !== 0) {
            const affectionResult = await this.affectRandomHorseGirlAffection(result.affectionChange);
            if (affectionResult) {
              result.effects.push(
                `ƒê·ªô thi·ªán c·∫£m ${affectionResult.name} ${result.affectionChange > 0 ? '+' : ''}${result.affectionChange}`,
              );
            }
          }
        }

        showTarotResultPopup(result) {
          console.log('üé¥ Hi·ªÉn th·ªã k·∫øt qu·∫£ b√≥i:', result);
          if (!result || !result.cards || !result.result) {
            console.error('üé¥ C·∫•u tr√∫c d·ªØ li·ªáu result l·ªói:', result);
            alert('T·∫°o d·ªØ li·ªáu b√≥i th·∫•t b·∫°i! result=' + JSON.stringify(result));
            return;
          }
          $('.tarot-result-modal').remove();
          const resultModal = $(`
            <div class="tarot-result-modal" style="
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.8);
              display: flex;
              justify-content: center;
              align-items: center;
              z-index: 10000;
              backdrop-filter: blur(5px);
            ">
              <div class="tarot-result-content" style="
                background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
                border: 2px solid #a855f7;
                border-radius: 20px;
                padding: 30px;
                max-width: 800px;
                max-height: 90vh;
                overflow-y: auto;
                position: relative;
                box-shadow: 0 0 50px rgba(168, 85, 247, 0.5);
                animation: tarotResultFadeIn 0.8s ease-out;
              ">
                <button class="tarot-result-close" style="
                  position: absolute;
                  top: 15px;
                  right: 20px;
                  background: none;
                  border: none;
                  color: #a855f7;
                  font-size: 24px;
                  cursor: pointer;
                  z-index: 10001;
                ">√ó</button>
                
                <div class="tarot-result-header" style="
                  text-align: center;
                  margin-bottom: 25px;
                  padding-bottom: 20px;
                  border-bottom: 2px solid rgba(168, 85, 247, 0.3);
                ">
                  <h2 style="
                    color: #a855f7;
                    font-size: 28px;
                    margin: 0;
                    text-shadow: 0 0 10px rgba(168, 85, 247, 0.5);
                    font-family: 'Times New Roman', serif;
                  ">üîÆ G∆∞∆°ng V·∫≠n M·ªánh üîÆ</h2>
                  <p style="
                    color: #cbd5e1;
                    font-size: 16px;
                    margin: 10px 0 0 0;
                    font-style: italic;
                  ">${result.result.type}</p>
                </div>
                
                <div class="tarot-cards-display" style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                  gap: 15px;
                  margin-bottom: 25px;
                ">
                  ${result.cards
                    .map(
                      (card, index) => `
                    <div class="tarot-result-card ${card.reversed ? 'reversed' : ''}" style="
                      background: linear-gradient(135deg, #2d1b69, #4c1d95);
                      border: 2px solid ${card.reversed ? '#ef4444' : '#a855f7'};
                      border-radius: 12px;
                      padding: 15px;
                      text-align: center;
                      position: relative;
                      transform: ${card.reversed ? 'rotate(180deg)' : 'none'};
                      transition: all 0.3s ease;
                      box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
                    ">
                      <div class="card-number" style="
                        position: absolute;
                        top: 5px;
                        left: 10px;
                        color: #a855f7;
                        font-size: 12px;
                        font-weight: bold;
                      ">${index + 1}</div>
                      <div class="card-name" style="
                        color: #f3f4f6;
                        font-size: 14px;
                        font-weight: bold;
                        margin-bottom: 8px;
                        text-shadow: 0 0 5px rgba(168, 85, 247, 0.5);
                      ">${card.name}</div>
                      <div class="card-meaning" style="
                        color: #cbd5e1;
                        font-size: 12px;
                        line-height: 1.4;
                        font-style: italic;
                      ">${card.meaning}</div>
                      ${card.reversed ? '<div style="position: absolute; top: 5px; right: 10px; color: #ef4444; font-size: 12px;">Ng∆∞·ª£c</div>' : ''}
                    </div>
                  `,
                    )
                    .join('')}
                </div>
                
                <div class="tarot-interpretation-section" style="
                  background: rgba(168, 85, 247, 0.1);
                  border: 1px solid rgba(168, 85, 247, 0.3);
                  border-radius: 12px;
                  padding: 20px;
                  margin-bottom: 25px;
                ">
                  <h3 style="
                    color: #a855f7;
                    font-size: 20px;
                    margin: 0 0 15px 0;
                    text-align: center;
                    font-family: 'Times New Roman', serif;
                  ">üåü Gi·∫£i ƒê·ªôc B√≠ ·∫®n üåü</h3>
                  <div class="interpretation-text" style="
                    color: #e2e8f0;
                    font-size: 14px;
                    line-height: 1.6;
                    text-align: justify;
                    font-family: 'Georgia', serif;
                  ">${result.result.interpretation}</div>
                </div>
                
                <div class="tarot-effects-section" style="
                  background: rgba(34, 197, 94, 0.1);
                  border: 1px solid rgba(34, 197, 94, 0.3);
                  border-radius: 12px;
                  padding: 20px;
                ">
                  <h3 style="
                    color: #22c55e;
                    font-size: 20px;
                    margin: 0 0 15px 0;
                    text-align: center;
                    font-family: 'Times New Roman', serif;
                  ">‚ú® ·∫¢nh H∆∞·ªüng V·∫≠n M·ªánh ‚ú®</h3>
                  <div class="effects-list" style="
                    display: grid;
                    gap: 8px;
                  ">
                    ${result.result.effects
                      .map(
                        effect => `
                      <div class="effect-item" style="
                        background: rgba(34, 197, 94, 0.1);
                        border: 1px solid rgba(34, 197, 94, 0.2);
                        border-radius: 8px;
                        padding: 10px;
                        color: #22c55e;
                        font-size: 14px;
                        text-align: center;
                        font-weight: 500;
                      ">${effect}</div>
                    `,
                      )
                      .join('')}
                  </div>
                </div>
                
                <div style="
                  position: absolute;
                  top: 10px;
                  left: 10px;
                  font-size: 20px;
                  color: rgba(168, 85, 247, 0.3);
                ">üåô</div>
                <div style="
                  position: absolute;
                  top: 10px;
                  right: 50px;
                  font-size: 20px;
                  color: rgba(168, 85, 247, 0.3);
                ">‚≠ê</div>
                <div style="
                  position: absolute;
                  bottom: 10px;
                  left: 10px;
                  font-size: 20px;
                  color: rgba(168, 85, 247, 0.3);
                ">üîÆ</div>
                <div style="
                  position: absolute;
                  bottom: 10px;
                  right: 10px;
                  font-size: 20px;
                  color: rgba(168, 85, 247, 0.3);
                ">‚ú®</div>
              </div>
            </div>
          `);
          resultModal.find('.tarot-result-close').on('click', () => {
            resultModal.fadeOut(300, () => resultModal.remove());
          });
          resultModal.on('click', e => {
            if (e.target === resultModal[0]) {
              resultModal.fadeOut(300, () => resultModal.remove());
            }
          });
          $('body').append(resultModal);
          const tarotSound = document.getElementById('tarot-result-sound');
          if (tarotSound) {
            tarotSound.currentTime = 0;
            tarotSound.play().catch(e => console.log('Ph√°t √¢m thanh th·∫•t b·∫°i:', e));
          }

          console.log('üé¥ C·ª≠a s·ªï k·∫øt qu·∫£ b√≥i ƒë√£ hi·ªÉn th·ªã');
        }

        showDivinationStartAnimation(spreadType) {
          console.log('üé¥ Hi·ªÉn th·ªã ho·∫°t ·∫£nh b·∫Øt ƒë·∫ßu b√≥i');
          $('.tarot-start-animation').remove();

          const spreadNames = {
            single: 'B√≥i m·ªôt l√° b√†i',
            timeline: 'B√≥i d√≤ng th·ªùi gian',
            choice: 'B√≥i ch·ªçn m·ªôt trong hai',
            hexagram: 'B√≥i L·ª•c Mang Tinh',
            celtic: 'B√≥i Th·∫≠p T·ª± Celtic',
            zodiac: 'B√≥i M∆∞·ªùi Hai Cung Ho√†ng ƒê·∫°o',
          };

          const spreadIcons = {
            single: 'üîÆ',
            timeline: '‚è∞',
            choice: '‚öñÔ∏è',
            hexagram: '‚≠ê',
            celtic: 'üïØÔ∏è',
            zodiac: 'üåü',
          };
          const startAnimation = $(`
            <div class="tarot-start-animation" style="
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: radial-gradient(circle, rgba(0,0,0,0.9) 0%, rgba(26,26,46,0.95) 100%);
              display: flex;
              justify-content: center;
              align-items: center;
              z-index: 9999;
              backdrop-filter: blur(10px);
            ">
              <div class="animation-content" style="
                text-align: center;
                color: #a855f7;
                animation: tarotStartPulse 2s ease-in-out infinite;
              ">
                <div class="mystical-icon" style="
                  font-size: 80px;
                  margin-bottom: 20px;
                  text-shadow: 0 0 30px rgba(168, 85, 247, 0.8);
                  animation: tarotIconFloat 3s ease-in-out infinite;
                ">${spreadIcons[spreadType] || 'üîÆ'}</div>
                
                <h2 style="
                  font-size: 32px;
                  margin: 0 0 15px 0;
                  text-shadow: 0 0 20px rgba(168, 85, 247, 0.6);
                  font-family: 'Times New Roman', serif;
                ">${spreadNames[spreadType] || 'B√≥i to√°n b√≠ ·∫©n'}</h2>
                
                <p style="
                  font-size: 18px;
                  margin: 0 0 30px 0;
                  color: #cbd5e1;
                  font-style: italic;
                ">G∆∞∆°ng v·∫≠n m·ªánh ƒëang ti·∫øt l·ªô t∆∞∆°ng lai c·ªßa b·∫°n...</p>
                
                <div class="loading-dots" style="
                  display: flex;
                  justify-content: center;
                  gap: 8px;
                ">
                  <div class="dot" style="
                    width: 12px;
                    height: 12px;
                    background: #a855f7;
                    border-radius: 50%;
                    animation: tarotDotPulse 1.5s ease-in-out infinite;
                  "></div>
                  <div class="dot" style="
                    width: 12px;
                    height: 12px;
                    background: #a855f7;
                    border-radius: 50%;
                    animation: tarotDotPulse 1.5s ease-in-out infinite 0.2s;
                  "></div>
                  <div class="dot" style="
                    width: 12px;
                    height: 12px;
                    background: #a855f7;
                    border-radius: 50%;
                    animation: tarotDotPulse 1.5s ease-in-out infinite 0.4s;
                  "></div>
                </div>
                
                <div style="
                  position: absolute;
                  top: 20%;
                  left: 10%;
                  font-size: 24px;
                  color: rgba(168, 85, 247, 0.3);
                  animation: tarotFloat 4s ease-in-out infinite;
                ">üåô</div>
                <div style="
                  position: absolute;
                  top: 30%;
                  right: 15%;
                  font-size: 20px;
                  color: rgba(168, 85, 247, 0.3);
                  animation: tarotFloat 4s ease-in-out infinite 1s;
                ">‚≠ê</div>
                <div style="
                  position: absolute;
                  bottom: 25%;
                  left: 15%;
                  font-size: 22px;
                  color: rgba(168, 85, 247, 0.3);
                  animation: tarotFloat 4s ease-in-out infinite 2s;
                ">‚ú®</div>
                <div style="
                  position: absolute;
                  bottom: 35%;
                  right: 10%;
                  font-size: 26px;
                  color: rgba(168, 85, 247, 0.3);
                  animation: tarotFloat 4s ease-in-out infinite 3s;
                ">üîÆ</div>
              </div>
            </div>
          `);
          $('body').append(startAnimation);
          const tarotStartSound = document.getElementById('tarot-start-sound');
          if (tarotStartSound) {
            tarotStartSound.currentTime = 0;
            tarotStartSound.play().catch(e => console.log('Ph√°t √¢m thanh th·∫•t b·∫°i:', e));
          }

          console.log('üé¥ Ho·∫°t ·∫£nh b·∫Øt ƒë·∫ßu b√≥i ƒë√£ hi·ªÉn th·ªã');
        }
        canGetTarotItem() {
          const lastItemTime = localStorage.getItem('tarot_last_item_time');
          const itemCount = parseInt(localStorage.getItem('tarot_item_count') || '0');

          if (itemCount >= 3) {
            return { canGet: false, reason: 'ƒê√£ ƒë·∫°t gi·ªõi h·∫°n s·ªë l∆∞·ª£ng v·∫≠t ph·∫©m t·ªëi ƒëa' };
          }

          if (lastItemTime) {
            const hoursSinceLastItem = (Date.now() - parseInt(lastItemTime)) / (1000 * 60 * 60);
            if (hoursSinceLastItem < 24) {
              return { canGet: false, reason: 'V·∫≠t ph·∫©m ƒëang trong th·ªùi gian h·ªìi chi√™u' };
            }
          }

          return { canGet: true };
        }

        getRandomTarotItem() {
          const items = Object.keys(this.tarotItems);
          const rand = Math.random();
          if (rand < 0.15) {
            return items[Math.floor(Math.random() * items.length)];
          }
          return null;
        }

        async addTarotItem(itemName, itemData) {
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable && Mvu.setMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              if (!mvuData || !mvuData.stat_data) {
                console.error('‚ùå D·ªØ li·ªáu MVU kh√¥ng h·ª£p l·ªá');
                return;
              }
              if (!mvuData.display_data) {
                mvuData.display_data = {};
              }
              if (!mvuData.delta_data) {
                mvuData.delta_data = {};
              }
              if (!mvuData.stat_data.$internal) {
                mvuData.stat_data.$internal = {
                  display_data: mvuData.display_data,
                  delta_data: mvuData.delta_data,
                };
                console.log('‚úÖ ƒê√£ kh·ªüi t·∫°o thu·ªôc t√≠nh $internal');
              } else {
                mvuData.stat_data.$internal.display_data = mvuData.display_data;
                mvuData.stat_data.$internal.delta_data = mvuData.delta_data;
              }

              const currentItems = Mvu.getMvuVariable(mvuData, 'trainer.inventory', { default_value: {} });
              currentItems[itemName] = itemData;

              await Mvu.setMvuVariable(mvuData, 'trainer.inventory', currentItems, {
                reason: 'B√≥i Tarot nh·∫≠n v·∫≠t ph·∫©m',
                is_recursive: true,
              });
              await Mvu.replaceMvuData(mvuData, { type: 'chat' });
              console.log('üé¥ Th√™m v·∫≠t ph·∫©m th√†nh c√¥ng:', itemName);
            }
          } catch (error) {
            console.error('üé¥ Th√™m v·∫≠t ph·∫©m th·∫•t b·∫°i:', error);
          }
        }

        recordItemAcquisition() {
          localStorage.setItem('tarot_last_item_time', Date.now().toString());
          localStorage.setItem(
            'tarot_item_count',
            (parseInt(localStorage.getItem('tarot_item_count') || '0') + 1).toString(),
          );
        }
        getExistingHorseGirls() {
          const horseGirls = this.getVariable('umaMusume', {});
          return Object.keys(horseGirls).filter(name => name !== '$meta');
        }

        getRandomExistingHorseGirl() {
          const existingGirls = this.getExistingHorseGirls();
          if (existingGirls.length === 0) return null;
          return existingGirls[Math.floor(Math.random() * existingGirls.length)];
        }

        async affectRandomHorseGirlAffection(affectionChange) {
          const horseGirlName = this.getRandomExistingHorseGirl();
          if (!horseGirlName) return null;

          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable && Mvu.setMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              if (!mvuData || !mvuData.stat_data) {
                console.error('‚ùå D·ªØ li·ªáu MVU kh√¥ng h·ª£p l·ªá');
                return;
              }
              if (!mvuData.display_data) {
                mvuData.display_data = {};
              }
              if (!mvuData.delta_data) {
                mvuData.delta_data = {};
              }
              if (!mvuData.stat_data.$internal) {
                mvuData.stat_data.$internal = {
                  display_data: mvuData.display_data,
                  delta_data: mvuData.delta_data,
                };
                console.log('‚úÖ ƒê√£ kh·ªüi t·∫°o thu·ªôc t√≠nh $internal');
              } else {
                mvuData.stat_data.$internal.display_data = mvuData.display_data;
                mvuData.stat_data.$internal.delta_data = mvuData.delta_data;
              }

              const currentHorseGirls = Mvu.getMvuVariable(mvuData, 'umaMusume', { default_value: {} });
              const currentAffection = currentHorseGirls[horseGirlName]?.affection || 0;
              const newAffection = Math.max(0, Math.min(100, currentAffection + affectionChange));
              if (!currentHorseGirls[horseGirlName]) {
                currentHorseGirls[horseGirlName] = { affection: 0 };
              }
              currentHorseGirls[horseGirlName].affection = newAffection;

              await Mvu.setMvuVariable(mvuData, 'umaMusume', currentHorseGirls, {
                reason: 'B√≥i Tarot thay ƒë·ªïi ƒë·ªô thi·ªán c·∫£m Uma Musume',
                is_recursive: true,
              });
              await Mvu.replaceMvuData(mvuData, { type: 'chat' });

              return {
                name: horseGirlName,
                oldAffection: currentAffection,
                newAffection: newAffection,
                change: affectionChange,
              };
            }
          } catch (error) {
            console.error('üé¥ C·∫≠p nh·∫≠t ƒë·ªô thi·ªán c·∫£m Uma Musume th·∫•t b·∫°i:', error);
          }
          return null;
        }
        getDailyRemaining() {
          try {
            const gameDay = this.getGameDay();
            const lastUsedDay = localStorage.getItem('tarot_last_used_day');
            const gameDayKey = `tarot_usage_day_${gameDay}`;
            const usageCount = parseInt(localStorage.getItem(gameDayKey) || '0');
            const lastUsedDayNum = parseInt(lastUsedDay) || -1;
            if (gameDay < lastUsedDayNum) {
              console.log(`üé¥ Ph√°t hi·ªán v√≤ng m·ªõi: Ng√†y hi·ªán t·∫°i=${gameDay}, Ng√†y l·∫ßn tr∆∞·ªõc=${lastUsedDayNum}`);
              this.resetTarotData();
              return 3;
            }
            if (lastUsedDay !== gameDay.toString()) {
              console.log(`üé¥ Ng√†y game m·ªõi: T·ª´ ng√†y th·ª© ${lastUsedDay} ƒë·∫øn ng√†y th·ª© ${gameDay}`);
              localStorage.setItem('tarot_last_used_day', gameDay.toString());
              this.cleanupOldUsageData();
              return 3;
            }

            return Math.max(0, 3 - usageCount);
          } catch (error) {
            console.warn('üé¥ L·∫•y s·ªë l·∫ßn c√≤n l·∫°i m·ªói ng√†y th·∫•t b·∫°i, s·ª≠ d·ª•ng ph∆∞∆°ng √°n d·ª± ph√≤ng:', error);
            const today = new Date().toDateString();
            const lastUsage = localStorage.getItem('tarot_last_usage');
            const usageCount = parseInt(localStorage.getItem('tarot_usage_count') || '0');

            if (lastUsage !== today) {
              localStorage.setItem('tarot_last_usage', today);
              localStorage.setItem('tarot_usage_count', '0');
              return 3;
            }

            return Math.max(0, 3 - usageCount);
          }
        }
        cleanupOldUsageData() {
          try {
            const currentGameDay = this.getGameDay();
            for (let i = 1; i <= 30; i++) {
              const oldDay = currentGameDay - i;
              if (oldDay > 0) {
                localStorage.removeItem(`tarot_usage_day_${oldDay}`);
              }
            }
            console.log('üé¥ ƒê√£ d·ªçn d·∫πp d·ªØ li·ªáu s·ª≠ d·ª•ng b√≥i Tarot c·ªßa ng√†y c≈©');
          } catch (error) {
            console.warn('üé¥ D·ªçn d·∫πp d·ªØ li·ªáu c≈© th·∫•t b·∫°i:', error);
          }
        }
        resetTarotData() {
          try {
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key && key.startsWith('tarot_')) {
                keysToRemove.push(key);
              }
            }

            keysToRemove.forEach(key => {
              localStorage.removeItem(key);
              console.log(`üé¥ X√≥a d·ªØ li·ªáu b√†i Tarot: ${key}`);
            });

            console.log('üé¥ ƒê√£ ƒë·∫∑t l·∫°i t·∫•t c·∫£ d·ªØ li·ªáu b√†i Tarot (V√°n m·ªõi)');
          } catch (error) {
            console.warn('üé¥ ƒê·∫∑t l·∫°i d·ªØ li·ªáu b√†i Tarot th·∫•t b·∫°i:', error);
          }
        }

        recordDailyUsage() {
          try {
            const gameDay = this.getGameDay();
            const gameDayKey = `tarot_usage_day_${gameDay}`;
            const currentCount = parseInt(localStorage.getItem(gameDayKey) || '0');
            localStorage.setItem(gameDayKey, (currentCount + 1).toString());
            localStorage.setItem('tarot_last_used_day', gameDay.toString());

            console.log(`üé¥ Ghi ch√©p s·ª≠ d·ª•ng b√≥i Tarot: Ng√†y th·ª© ${gameDay} trong game, s·ª≠ d·ª•ng l·∫ßn th·ª© ${currentCount + 1}`);
          } catch (error) {
            console.warn('üé¥ Ghi ch√©p s·ª≠ d·ª•ng b√≥i Tarot th·∫•t b·∫°i, s·ª≠ d·ª•ng ph∆∞∆°ng √°n d·ª± ph√≤ng:', error);
            const today = new Date().toDateString();
            const currentCount = parseInt(localStorage.getItem('tarot_usage_count') || '0');
            localStorage.setItem('tarot_usage_count', (currentCount + 1).toString());
          }
        }
        getGameDay() {
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              const gameDay = Mvu.getMvuVariable(mvuData, 'trainer.daysInSchool', { default_value: 1 });
              const day = parseInt(gameDay) || 1;
              console.log(`üé¥ S·ª≠ d·ª•ng MVU l·∫•y s·ªë ng√†y ·ªü tr∆∞·ªùng: ${gameDay} -> ${day}`);
              return day;
            }
            const allVars = this.getAllVariables();
            const schoolDays = this.getVariable(allVars, 'stat_data.trainer.daysInSchool', 1);
            const day = parseInt(schoolDays) || 1;
            console.log(`üé¥ S·ª≠ d·ª•ng getAllVariables l·∫•y s·ªë ng√†y ·ªü tr∆∞·ªùng: ${schoolDays} -> ${day}`);
            return day;
            const savedDay = localStorage.getItem('game_current_day');
            if (savedDay) {
              return parseInt(savedDay) || 1;
            }
            return 1;
          } catch (error) {
            console.warn('üé¥ L·∫•y s·ªë ng√†y trong game th·∫•t b·∫°i:', error);
            return 1;
          }
        }
        getAllVariables() {
          if (window.teresenDebug && typeof window.teresenDebug.getAllVariables === 'function') {
            return window.teresenDebug.getAllVariables();
          }
          if (typeof getAllVariables === 'function') {
            return getAllVariables();
          }
          console.warn('üé¥ Ph∆∞∆°ng th·ª©c getAllVariables kh√¥ng kh·∫£ d·ª•ng');
          return {};
        }

        getVariable(dataObj, path, defaultValue = null) {
          if (window.teresenDebug && typeof window.teresenDebug.getVariable === 'function') {
            return window.teresenDebug.getVariable(dataObj, path, defaultValue);
          }
          try {
            const keys = path.split(/\.|\[|\]/).filter(k => k !== '');
            let value = dataObj;
            for (const key of keys) {
              if (value == null || typeof value !== 'object') {
                return defaultValue;
              }
              value = value[key];
            }
            return value != null ? value : defaultValue;
          } catch (e) {
            console.warn('L·∫•y bi·∫øn th·∫•t b·∫°i:', path, e);
            return defaultValue;
          }
        }

        setVariable(path, value) {
          try {
            if (typeof Mvu !== 'undefined' && Mvu.setMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              Mvu.setMvuVariable(mvuData, path, value, {
                reason: 'Hi·ªáu qu·∫£ b√≥i Tarot',
                is_recursive: true,
              });
              Mvu.replaceMvuData(mvuData, { type: 'chat' });
            }
          } catch (e) {
            console.error('Thi·∫øt l·∫≠p bi·∫øn th·∫•t b·∫°i:', path, e);
          }
        }
      }
      $(document).ready(function () {
        setTimeout(() => {
          window.tarotSystem = new TarotDivinationSystem();
          console.log('üé¥ Kh·ªüi t·∫°o h·ªá th·ªëng b√≥i Tarot ho√†n t·∫•t');
        }, 100);
      });
      class ShrineSystem {
        constructor() {
          console.log('‚õ©Ô∏è H√†m t·∫°o h·ªá th·ªëng c·∫ßu ph√∫c ƒë·ªÅn th·ªù b·∫Øt ƒë·∫ßu');
          this.fortunes = [
            { name: 'ƒê·∫°i C√°t', rank: 1, desc: 'V·∫≠n th·∫ø t·ªët nh·∫•t. Nh∆∞ng ch√∫ √Ω n·ªó l·ª±c duy tr√¨ hi·ªán tr·∫°ng nh√©.' },
            { name: 'C√°t', rank: 2, desc: 'V·∫≠n may ch·ªâ sau ƒê·∫°i C√°t, c√≥ th·ªÉ y√™n t√¢m m·ªôt th·ªùi gian.' },
            { name: 'Trung C√°t', rank: 3, desc: 'V·∫≠n kh√≠ b·∫±ng m·ªôt n·ª≠a "C√°t", n·ªó l·ª±c c√≥ th·ªÉ n√¢ng cao.' },
            { name: 'Ti·ªÉu C√°t', rank: 4, desc: 'Kh√¥ng t·ªët kh√¥ng x·∫•u, s·∫Ω c√≥ h·∫°nh ph√∫c nho nh·ªè, kh√¥ng n√™n c∆∞·ª°ng c·∫ßu.' },
            { name: 'M·∫°t C√°t', rank: 5, desc: 'Cu·ªëi c√πng trong "C√°t", nh∆∞ng c√≥ nhi·ªÅu kh√¥ng gian thƒÉng ti·∫øn.' },
            { name: 'Hung', rank: 6, desc: 'V·∫≠n th·∫ø kh√¥ng t·ªët, c·∫ßn c·∫©n th·∫≠n d√® d·∫∑t, nh√¨n nh·∫≠n l·∫°i b·∫£n th√¢n.' },
            { name: 'ƒê·∫°i Hung', rank: 7, desc: 'V·∫≠n th·∫ø t·ªá nh·∫•t, nh∆∞ng ƒë√£ kh√¥ng c√≤n ch·ªó ƒë·ªÉ xu·ªëng, ki√™n nh·∫´n ch·ªù c∆° h·ªôi ƒë·ªïi ƒë·ªùi ƒëi.' },
          ];
          this.omikujiItems = ['Nguy·ªán v·ªçng', 'T√¨nh y√™u', 'ƒê·ªëi nh√¢n', 'H√¥n s·ª±', 'Kinh doanh', 'V·∫≠t th·∫•t l·∫°c', 'Nh√† c·ª≠a', 'Xu·∫•t h√†nh', 'S·ª©c kh·ªèe', 'H·ªçc v·∫•n', 'Tranh ch·∫•p'];
          this.itemResults = {
            good: [
              'S·∫Ω th√†nh hi·ªán th·ª±c',
              'S·∫Ω thu·∫≠n bu·ªìm xu√¥i gi√≥',
              'S·∫Ω xu·∫•t hi·ªán',
              'C√≥ l∆∞∆°ng duy√™n',
              'S·∫Ω r·∫•t thu·∫≠n l·ª£i',
              'C√≥ th·ªÉ t√¨m th·∫•y',
              'C√≥ v·∫≠n may t·ªët',
              'S·∫Ω r·∫•t thu·∫≠n l·ª£i',
              'S·∫Ω r·∫•t kh·ªèe m·∫°nh',
              'C√≥ th·ªÉ th√†nh c√¥ng',
              'S·∫Ω th·∫Øng l·ª£i',
            ],
            bad: [
              'Kh√≥ th·ª±c hi·ªán',
              'S·∫Ω c√≥ tr·∫Øc tr·ªü',
              'S·∫Ω kh√¥ng xu·∫•t hi·ªán',
              'Duy√™n ph·∫≠n ch∆∞a t·ªõi',
              'S·∫Ω c√≥ kh√≥ khƒÉn',
              'Kh√¥ng t√¨m th·∫•y n·ªØa',
              'V·∫≠n th·∫ø kh√¥ng t·ªët',
              'T·ªët nh·∫•t n√™n ho√£n l·∫°i',
              'C·∫ßn ch√∫ √Ω',
              'C·∫ßn n·ªó l·ª±c',
              'S·∫Ω th·∫•t b·∫°i',
            ],
          };
          this.bindEvents();
          console.log('‚õ©Ô∏è H√†m t·∫°o h·ªá th·ªëng c·∫ßu ph√∫c ƒë·ªÅn th·ªù ho√†n t·∫•t');
        }

        bindEvents() {
          console.log('‚õ©Ô∏è R√†ng bu·ªôc s·ª± ki·ªán c·∫ßu ph√∫c ƒë·ªÅn th·ªù');
          $(document).on('click', '#shrine-btn', e => {
            console.log('‚õ©Ô∏è N√∫t ƒë·ªÅn th·ªù ƒë∆∞·ª£c nh·∫•p');
            e.preventDefault();
            e.stopPropagation();
            this.openShrineModal();
          });
          $(document).on('click', '#close-shrine-btn', e => {
            console.log('‚õ©Ô∏è ƒê√≥ng modal ƒë·ªÅn th·ªù');
            e.preventDefault();
            e.stopPropagation();
            this.closeShrineModal();
          });
          $(document).on('click', '#shrine-pray-btn', e => {
            console.log('‚õ©Ô∏è N√∫t tham b√°i ƒë∆∞·ª£c nh·∫•p');
            e.preventDefault();
            e.stopPropagation();
            this.pray();
          });
          $(document).on('click', '#shrine-draw-btn', e => {
            console.log('‚õ©Ô∏è N√∫t r√∫t thƒÉm ƒë∆∞·ª£c nh·∫•p');
            e.preventDefault();
            e.stopPropagation();
            this.drawOmikuji();
          });
          $(document).on('click', '#shrine-modal', e => {
            if (e.target.id === 'shrine-modal') {
              this.closeShrineModal();
            }
          });

          console.log('‚õ©Ô∏è R√†ng bu·ªôc s·ª± ki·ªán c·∫ßu ph√∫c ƒë·ªÅn th·ªù ho√†n t·∫•t');
        }

        openShrineModal() {
          console.log('‚õ©Ô∏è M·ªü modal ƒë·ªÅn th·ªù');
          $('#omikuji-result-display').hide();
          $('#shrine-prompt').show().text('Vui l√≤ng c√πng c·ªông s·ª± ƒë·∫øn tham b√°i tr∆∞·ªõc.');
          $('#shrine-draw-btn').prop('disabled', true);
          $('#shrine-modal').show();
          if (window.teresenDebug && window.teresenDebug.ensureModalInOverlay) {
            const modal = document.getElementById('shrine-modal');
            if (modal) {
              window.teresenDebug.ensureModalInOverlay(modal);
            }
          }
          console.log('‚õ©Ô∏è Modal ƒë·ªÅn th·ªù ƒë√£ hi·ªÉn th·ªã');
        }

        closeShrineModal() {
          $('#shrine-modal').hide();
        }

        pray() {
          console.log('‚õ©Ô∏è B·∫Øt ƒë·∫ßu tham b√°i');
          $('#shrine-prompt').text('Mang theo l√≤ng th√†nh k√≠nh, c√πng c·ªông s·ª± truy·ªÅn ƒë·∫°t t√¢m √Ω ƒë·∫øn th·∫ßn linh...');
          $('#omikuji-result-display').hide();
          $('#shrine-prompt').show();
          $('#shrine-draw-btn').prop('disabled', false);
        }

        drawOmikuji() {
          console.log('‚õ©Ô∏è B·∫Øt ƒë·∫ßu r√∫t qu·∫ª');
          const fortune = this.fortunes[Math.floor(Math.random() * this.fortunes.length)];
          $('#shrine-prompt').hide();
          const $display = $('#omikuji-result-display').show();
          $display.find('.omikuji-fortune').text(`„Äê${fortune.name}„Äë`);
          $display.find('.omikuji-desc').text(fortune.desc);
          const $itemsList = $display.find('.omikuji-items').empty();

          this.omikujiItems.forEach(item => {
            const isGood = Math.random() > (fortune.rank - 1) / (this.fortunes.length - 1) - 0.1;
            const itemResult = isGood
              ? this.itemResults.good[Math.floor(Math.random() * this.itemResults.good.length)]
              : this.itemResults.bad[Math.floor(Math.random() * this.itemResults.bad.length)];
            $itemsList.append(`<li><strong>„Äê${item}„Äë</strong> ${itemResult}</li>`);
          });
          $('#shrine-draw-btn').prop('disabled', true);

          console.log('‚õ©Ô∏è R√∫t qu·∫ª ho√†n t·∫•t:', fortune.name);
        }
      }
      $(document).ready(function () {
        setTimeout(() => {
          window.shrineSystem = new ShrineSystem();
          console.log('‚õ©Ô∏è Kh·ªüi t·∫°o h·ªá th·ªëng c·∫ßu ph√∫c ƒë·ªÅn th·ªù ho√†n t·∫•t');
        }, 100);
      });
    </script>

    <script>
      class WorldMapSystem {
        constructor() {
          this.mapData = {
            mapInfo: {
              id: 'treisen_world_map',
              name: 'B·∫£n ƒë·ªì th·∫ø gi·ªõi Tracen',
              imageUrl: 'https://i.ibb.co/B2hJkB5J/image.png',
              originalWidth: 710,
              originalHeight: 480,
            },
            locations: [
              {
                id: 'location_1757318274166',
                name: 'H·ªçc vi·ªán Tracen',
                description: 'N∆°i t·ªça l·∫°c H·ªçc vi·ªán Tracen',
                type: 'racetrack',
                coordinates: { x: 0.7746, y: 0.4104 },
              },
              {
                id: 'location_1757318283780',
                name: 'N√∫i Ph√∫ Sƒ©',
                description: '',
                type: 'scenic',
                coordinates: { x: 0.6423, y: 0.5208 },
              },
              {
                id: 'location_1757318295113',
                name: 'Tokyo',
                description: '',
                type: 'city',
                coordinates: { x: 0.8254, y: 0.4354 },
              },
              {
                id: 'location_1757318321436',
                name: 'N∆°i t·∫≠p hu·∫•n m√πa h√®',
                description: '',
                type: 'facility',
                coordinates: { x: 0.7887, y: 0.5479 },
              },
              {
                id: 'location_1757318364205',
                name: 'Tr∆∞·ªùng ƒëua Chukyo',
                description: '',
                type: 'racetrack',
                coordinates: { x: 0.3366, y: 0.6021 },
              },
              {
                id: 'location_1757318450243',
                name: 'Tr∆∞·ªùng ƒëua Kyoto',
                description: 'N∆°i di·ªÖn ra gi·∫£i Thi√™n Ho√†ng',
                type: 'racetrack',
                coordinates: { x: 0.1141, y: 0.65 },
              },
              {
                id: 'location_1757318469917',
                name: 'Tr∆∞·ªùng ƒëua Hanshin',
                description: '',
                type: 'racetrack',
                coordinates: { x: 0.0493, y: 0.6979 },
              },
              {
                id: 'location_1757318506058',
                name: 'H·ªçc vi·ªán Kasamatsu',
                description: 'N∆°i Oguri Cap t·ª´ng theo h·ªçc',
                type: 'racetrack',
                coordinates: { x: 0.2986, y: 0.5042 },
              },
              {
                id: 'location_1757319664664',
                name: 'Tr∆∞·ªùng ƒëua Nakayama',
                description: '',
                type: 'racetrack',
                coordinates: { x: 0.8915, y: 0.5667 },
              },
              {
                id: 'location_1757319874524',
                name: 'Tr∆∞·ªùng ƒëua Niigata',
                description: '',
                type: 'racetrack',
                coordinates: { x: 0.6845, y: 0.1187 },
              },
              {
                id: 'location_1757319889843',
                name: 'Tr∆∞·ªùng ƒëua Hakodate',
                description: '',
                type: 'racetrack',
                coordinates: { x: 0.8507, y: 0.1521 },
              },
              {
                id: 'location_1757319956272',
                name: 'Tr∆∞·ªùng ƒëua Kokura',
                description: '',
                type: 'racetrack',
                coordinates: { x: 0.1155, y: 0.8479 },
              },
            ],
          };
          this.init();
        }

        init() {
          this.bindEvents();
        }

        bindEvents() {
          $(document).on('click', '#world-map-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.openWorldMap();
          });

          $(document).on('click', '#close-world-map-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.closeWorldMap();
          });

          $(document).on('click', '#world-map-modal', e => {
            if (e.target.id === 'world-map-modal') {
              this.closeWorldMap();
            }
          });

          $(window).on('resize', () => {
            if ($('#world-map-modal').is(':visible')) {
              setTimeout(() => {
                this.renderMapMarkers();
              }, 100);
            }
          });
        }

        openWorldMap() {
          console.log('üóæ M·ªü b·∫£n ƒë·ªì th·∫ø gi·ªõi');
          const modal = document.getElementById('world-map-modal');
          if (modal) {
            const overlay = document.getElementById('teresen-fullscreen-overlay');
            if (overlay && modal.parentNode !== overlay) {
              modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
              overlay.appendChild(modal);
            }
          }
          $('#world-map-modal').show();
          setTimeout(() => {
            this.renderMapMarkers();
          }, 100);
        }

        closeWorldMap() {
          $('#world-map-modal').hide();
          $('#location-detail-panel').hide();
        }

        renderMapMarkers() {
          const container = document.getElementById('map-markers-container');
          const image = document.getElementById('world-map-image');

          if (!container || !image) return;

          container.innerHTML = '';

          const waitForImageLoad = () => {
            if (image.complete && image.naturalHeight !== 0) {
              this.placeMarkers(container, image);
            } else {
              image.onload = () => this.placeMarkers(container, image);
            }
          };

          waitForImageLoad();
        }

        placeMarkers(container, image) {
          const imageRect = image.getBoundingClientRect();
          const containerRect = container.getBoundingClientRect();

          container.style.width = `${image.offsetWidth}px`;
          container.style.height = `${image.offsetHeight}px`;

          this.mapData.locations.forEach(location => {
            const marker = document.createElement('div');
            marker.className = 'map-marker';
            marker.dataset.locationId = location.id;

            const x = location.coordinates.x * image.offsetWidth;
            const y = location.coordinates.y * image.offsetHeight;

            marker.style.cssText = `
              position: absolute;
              left: ${x}px;
              top: ${y}px;
              width: 12px;
              height: 12px;
              border-radius: 50%;
              background: ${this.getTypeColor(location.type)};
              border: 2px solid white;
              cursor: pointer;
              pointer-events: all;
              transform: translate(-50%, -50%);
              transition: all 0.2s;
              z-index: 10;
              box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            `;

            marker.addEventListener('mouseenter', () => {
              marker.style.transform = 'translate(-50%, -50%) scale(1.5)';
              marker.style.zIndex = '20';
            });

            marker.addEventListener('mouseleave', () => {
              marker.style.transform = 'translate(-50%, -50%) scale(1)';
              marker.style.zIndex = '10';
            });

            marker.addEventListener('click', e => {
              e.stopPropagation();
              this.showLocationDetail(location);
            });

            container.appendChild(marker);

            const label = document.createElement('div');
            label.className = 'map-label';
            label.textContent = location.name;
            label.style.cssText = `
              position: absolute;
              left: ${x}px;
              top: ${y}px;
              transform: translate(-50%, -25px);
              font-size: 12px;
              color: #ffffff;
              font-weight: bold;
              white-space: nowrap;
              text-shadow: 2px 2px 4px rgba(0,0,0,0.9), -1px -1px 2px rgba(0,0,0,0.7);
              background: rgba(0,0,0,0.6);
              padding: 2px 6px;
              border-radius: 4px;
              pointer-events: none;
              z-index: 5;
            `;

            container.appendChild(label);
          });
        }

        getTypeColor(type) {
          const colors = {
            racetrack: '#dc3545',
            city: '#007bff',
            scenic: '#28a745',
            landmark: '#6f42c1',
            facility: '#fd7e14',
            event: '#17a2b8',
            other: '#6c757d',
          };
          return colors[type] || colors['other'];
        }

        getTypeLabel(type) {
          const labels = {
            racetrack: 'Tr∆∞·ªùng ƒëua',
            city: 'Th√†nh ph·ªë',
            scenic: 'Danh lam th·∫Øng c·∫£nh',
            landmark: 'Ki·∫øn tr√∫c ƒë·ªãa danh',
            facility: 'C∆° s·ªü v·∫≠t ch·∫•t',
            event: 'ƒê·ªãa ƒëi·ªÉm s·ª± ki·ªán',
            other: 'Kh√°c',
          };
          return labels[type] || type;
        }

        showLocationDetail(location) {
          const panel = document.getElementById('location-detail-panel');
          const nameEl = document.getElementById('location-detail-name');
          const typeEl = document.getElementById('location-detail-type');
          const descEl = document.getElementById('location-detail-description');

          if (nameEl) nameEl.textContent = location.name;
          if (typeEl) typeEl.textContent = this.getTypeLabel(location.type);
          if (descEl) descEl.textContent = location.description || 'T·∫°m kh√¥ng c√≥ m√¥ t·∫£';

          if (panel) {
            panel.style.display = 'block';
          }
        }
      }

      $(document).ready(() => {
        setTimeout(() => {
          window.worldMapSystem = new WorldMapSystem();
          console.log('üóæ Kh·ªüi t·∫°o h·ªá th·ªëng b·∫£n ƒë·ªì th·∫ø gi·ªõi ho√†n t·∫•t');
        }, 100);
      });
    </script>

    <script>
      class MusicPlayerSystem {
        constructor() {
          this.currentTrackIndex = -1;
          this.isPlaying = false;
          this.currentVolume = 0.5;
          this.isDraggingProgress = false; 
          this.playMode = 'sequence'; 
          this.tracks = [
            {
              name: '„Éü„ÉÉ„Éâ„Éä„Ç§„Éà„Éª„Ç®„Éî„É≠„Éº„Ç∞',
              src: 'https://files.catbox.moe/qfwwgp.flac',
              type: 'FLAC',
            },
            {
              name: 'ƒê·∫°i ti·ªác Uma Musume! Di·ªÖu h√†nh ·∫©m th·ª±c',
              src: 'https://files.catbox.moe/jueda8.mp3',
              type: 'MP3',
            },
            {
              name: 'Tracen Ondo (C·ªßa Symboli Kris S)',
              src: 'https://files.catbox.moe/2izau9.mp3',
              type: 'MP3',
            },
            {
              name: 'V∆∞·ª£t qua (V∆∞·ª£t qua n√†o)',
              src: 'https://files.catbox.moe/v0iy0a.mp3',
              type: 'MP3',
            },
            {
              name: 'Tracen Ondo (Game Size)',
              src: 'https://files.catbox.moe/k0r0id.mp3',
              type: 'MP3',
            },
            {
              name: 'U.M.A. NEW WORLD!!',
              src: 'https://files.catbox.moe/okct8d.mp3',
              type: 'MP3',
            },
            {
              name: "GIRLS' LEGEND U",
              src: 'https://files.catbox.moe/146x8h.mp3',
              type: 'MP3',
            },
            {
              name: 'Glorious MomentÔºÅ',
              src: 'https://files.catbox.moe/agi8yx.mp3',
              type: 'MP3',
            },
            {
              name: 'Nh·∫°c k·ª∑ ni·ªám 1',
              src: 'https://files.catbox.moe/umai3u.m4a',
              type: 'M4A',
            },
            {
              name: 'Nh·∫°c k·ª∑ ni·ªám 2',
              src: 'https://files.catbox.moe/j0qaqf.m4a',
              type: 'M4A',
            },
            { name: '123 Em Ha Anh', src: 'https://files.catbox.moe/wlhqc9.mp4', type: 'MP4' },
            { name: 'Hakimi Ng·ªçt Ng√†o N√†y„ÄêHakimi Thu·∫ßn Khi·∫øt„Äë', src: 'https://files.catbox.moe/ui1gwf.mp4', type: 'MP4' },
            {
              name: '„ÄêHakimi„ÄëConundrum N√≥ Ha kh√≠ r·ªìi, h√¥m qua Ha ƒë·∫•y, nh∆∞ng l·∫° l√†, h√¥m kia n√≥ ƒë√£ ch·∫øt r·ªìi',
              src: 'https://files.catbox.moe/34edv0.mp4',
              type: 'MP4',
            },
            { name: 'Chuy·ªán c≈© ch·ªâ c√≥ th·ªÉ Ha Ki', src: 'https://files.catbox.moe/ppchr5.mp4', type: 'MP4' },
            { name: 'Ki Mi M√†u H ·ªì n g', src: 'https://files.catbox.moe/s8c70r.mp4', type: 'MP4' },
            { name: '„ÄêHakimi FM„ÄëKi Mi Tr√™n ƒê·∫ßu L∆∞·ª°i', src: 'https://files.catbox.moe/dchs4n.mp4', type: 'MP4' },
            { name: '„ÄêQuy·ªÅn Ki Long„ÄëJi MI YOU', src: 'https://files.catbox.moe/nhrhjl.mp4', type: 'MP4' },
            { name: '„ÄêHakimi FM„Äë_Hamo', src: 'https://files.catbox.moe/en0iq0.mp4', type: 'MP4' },
            { name: '„ÄäKh√∫c nh·∫°c b√°o th·ª©c Hakimi„Äãüê±', src: 'https://files.catbox.moe/yyq6oj.mp4', type: 'MP4' },
            { name: '„ÄêKi N·ªãch„ÄëHuy·ªÅn n·ªãch vang l√™n, Ki Mi l√™n s√†n', src: 'https://files.catbox.moe/bq9xsi.mp4', type: 'MP4' },
            {
              name: '„ÄêB√π file„ÄëüéµMambo ùëµùíê ùë¥ùíêùíìùíÜüéµKh√¥ng c√≤n Mambo (B·∫£n ƒë·∫ßy ƒë·ªß)',
              src: 'https://files.catbox.moe/7zivog.mp4',
              type: 'MP4',
            },
            { name: '„ÄêB·∫£n ƒë·∫ßy ƒë·ªß„ÄëC√∫ Ha cu·ªëi c√πng', src: 'https://files.catbox.moe/8gc10g.mp4', type: 'MP4' },
            { name: '„ÄêNh·∫°c Hakimi„ÄëKh√¥ng th·ªÉ kh√¥ng Ha', src: 'https://files.catbox.moe/33d0tw.mp4', type: 'MP4' },
            {
              name: '„ÄäB·∫≠t l·ª≠a Ki (Hakimi)„ÄãB·∫£n ƒë·∫ßy ƒë·ªß, Hakimi a ƒê·∫≠u xanh nam b·∫Øc!',
              src: 'https://files.catbox.moe/23dd5p.mp4',
              type: 'MP4',
            },
            { name: 'Ki Mi n√≥i b·∫£n ƒë·∫ßy ƒë·ªß', src: 'https://files.catbox.moe/87jhj8.mp4', type: 'MP4' },
            { name: 'Xu·∫•t s∆°n (Hakimi) b·∫£n ƒë·∫ßy ƒë·ªß', src: 'https://files.catbox.moe/6yjali.mp4', type: 'MP4' },
            { name: 'Lam Li√™n Ha', src: 'https://files.catbox.moe/xt6sla.mp4', type: 'MP4' },
            { name: 'Ki Nh·∫£y L·∫ßu', src: 'https://files.catbox.moe/ss1zds.mp4', type: 'MP4' },
            { name: 'T√¥i b·ªã k·∫πt ·ªü qu√™ h∆∞∆°ng Haki', src: 'https://files.catbox.moe/o1gorl.mp4', type: 'MP4' },
            { name: 'Hakimi_talking to the moon', src: 'https://files.catbox.moe/h3rwx1.mp4', type: 'MP4' },
            { name: 'Mambo ùëµùíê ùë¥ùíêùíìùíÜ Kh√¥ng c√≤n Mambo (B·∫£n ƒë·∫ßy ƒë·ªß)', src: 'https://files.catbox.moe/idekh0.mp4', type: 'MP4' },
            { name: 'Some Ki Mi just like this', src: 'https://files.catbox.moe/sudv0z.mp4', type: 'MP4' },
          ];
          this.audio = null;
          this.init();
        }

        init() {
          this.bindEvents();
          this.audio = document.getElementById('music-player-audio');
          if (this.audio) {
            this.audio.volume = this.currentVolume;
            this.audio.loop = false; 
            this.audio.addEventListener('timeupdate', () => this.updateTimeDisplay());
            this.audio.addEventListener('ended', () => this.onTrackEnded());
            this.audio.addEventListener('play', () => this.updateProfileSongDisplay());
            this.audio.addEventListener('pause', () => this.updateProfileSongDisplay());
          }
          this.updateProfileSongDisplay();
        }

        bindEvents() {
          $(document).on('click', '#music-player-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.openMusicPlayer();
          });

          $(document).on('click', '#close-music-player-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.closeMusicPlayer();
          });

          $(document).on('click', '#music-player-modal', e => {
            if (e.target.id === 'music-player-modal') {
              this.closeMusicPlayer();
            }
          });

          $(document).on('click', '#music-play-pause-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.togglePlayPause();
          });

          $(document).on('click', '#music-prev-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.prevTrack();
          });

          $(document).on('click', '#music-next-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.nextTrack();
          });

          $(document).on('input', '#music-volume-slider', e => {
            this.setVolume(e.target.value / 100);
          });
          $(document).on('input', '#music-progress-slider', e => {
            if (this.audio && this.audio.duration) {
              const seekTime = (e.target.value / 100) * this.audio.duration;
              this.audio.currentTime = seekTime;
            }
          });
          $(document).on('mousedown', '#music-progress-slider', () => {
            this.isDraggingProgress = true;
          });
          $(document).on('mouseup', '#music-progress-slider', () => {
            this.isDraggingProgress = false;
          });

          $(document).on('click', '.music-track', e => {
            const trackSrc = $(e.currentTarget).data('src');
            const trackIndex = this.tracks.findIndex(track => track.src === trackSrc);
            if (trackIndex !== -1) {
              this.playTrack(trackIndex);
            }
          });
          $(document).on('click', '#music-mode-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            console.log('N√∫t chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô ƒë∆∞·ª£c nh·∫•p, ch·∫ø ƒë·ªô hi·ªán t·∫°i:', this.playMode);
            this.togglePlayMode();
            return false;
          });
          const modeBtn = document.getElementById('music-mode-btn');
          if (modeBtn) {
            modeBtn.addEventListener('click', e => {
              e.preventDefault();
              e.stopPropagation();
              console.log('N√∫t chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô ƒë∆∞·ª£c nh·∫•p (r√†ng bu·ªôc tr·ª±c ti·∫øp), ch·∫ø ƒë·ªô hi·ªán t·∫°i:', this.playMode);
              this.togglePlayMode();
              return false;
            });
          }

          $(document).on('mouseenter', '.music-track', function () {
            $(this).css('background', 'rgba(255,255,255,0.1)');
          });

          $(document).on('mouseleave', '.music-track', function () {
            $(this).css('background', 'transparent');
          });
        }

        openMusicPlayer() {
          const modal = document.getElementById('music-player-modal');
          if (modal) {
            const overlay = document.getElementById('teresen-fullscreen-overlay');
            if (overlay && modal.parentNode !== overlay) {
              modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
              overlay.appendChild(modal);
            }
          }
          $('#music-player-modal').fadeIn(200, () => {
            const modeBtn = document.getElementById('music-mode-btn');
            if (modeBtn && !modeBtn.dataset.bound) {
              modeBtn.dataset.bound = 'true';
              modeBtn.addEventListener('click', e => {
                e.preventDefault();
                e.stopPropagation();
                console.log('N√∫t chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô ƒë∆∞·ª£c nh·∫•p (r√†ng bu·ªôc tr·ªÖ), ch·∫ø ƒë·ªô hi·ªán t·∫°i:', this.playMode);
                this.togglePlayMode();
                return false;
              });
            }
          });
          this.updateUI();
        }

        closeMusicPlayer() {
          $('#music-player-modal').fadeOut(200);
        }

        playTrack(index) {
          if (index < 0 || index >= this.tracks.length) return;

          this.currentTrackIndex = index;
          const track = this.tracks[index];

          if (this.audio) {
            this.audio.src = track.src;
            this.audio.load();
            this.audio.addEventListener(
              'loadedmetadata',
              () => {
                const progressSlider = document.getElementById('music-progress-slider');
                if (progressSlider) {
                  progressSlider.value = 0;
                  progressSlider.max = 100;
                }
              },
              { once: true },
            );
            this.audio
              .play()
              .then(() => {
                this.isPlaying = true;
                this.updateUI();
                this.updateProfileSongDisplay();
              })
              .catch(e => {
                console.log('Ph√°t nh·∫°c th·∫•t b·∫°i:', e);
              });
          }
        }

        togglePlayPause() {
          if (!this.audio) return;

          if (this.currentTrackIndex === -1 && this.tracks.length > 0) {
            this.playTrack(0);
            return;
          }

          if (this.isPlaying) {
            this.audio.pause();
            this.isPlaying = false;
          } else {
            this.audio
              .play()
              .then(() => {
                this.isPlaying = true;
              })
              .catch(e => {
                console.log('Ph√°t nh·∫°c th·∫•t b·∫°i:', e);
              });
          }
          this.updateUI();
        }

        prevTrack() {
          if (this.tracks.length === 0) return;

          let prevIndex;
          if (this.playMode === 'random') {
            prevIndex = Math.floor(Math.random() * this.tracks.length);
          } else if (this.playMode === 'repeat') {
            prevIndex = this.currentTrackIndex;
          } else {
            prevIndex = this.currentTrackIndex <= 0 ? this.tracks.length - 1 : this.currentTrackIndex - 1;
          }

          this.playTrack(prevIndex);
        }

        nextTrack() {
          if (this.tracks.length === 0) return;

          let nextIndex;
          if (this.playMode === 'random') {
            nextIndex = Math.floor(Math.random() * this.tracks.length);
          } else if (this.playMode === 'repeat') {
            nextIndex = this.currentTrackIndex;
          } else {
            nextIndex = this.currentTrackIndex >= this.tracks.length - 1 ? 0 : this.currentTrackIndex + 1;
          }

          this.playTrack(nextIndex);
        }

        onTrackEnded() {
          if (this.playMode === 'repeat') {
            if (this.currentTrackIndex >= 0 && this.audio) {
              this.audio.currentTime = 0;
              this.audio
                .play()
                .then(() => {
                  this.isPlaying = true;
                  this.updateUI();
                })
                .catch(e => {
                  console.log('Ph√°t nh·∫°c th·∫•t b·∫°i:', e);
                });
            }
          } else {
            this.nextTrack();
          }
        }

        togglePlayMode() {
          const modes = ['sequence', 'random', 'repeat'];
          const currentModeIndex = modes.indexOf(this.playMode);
          this.playMode = modes[(currentModeIndex + 1) % modes.length];
          console.log('Ch·∫ø ƒë·ªô ph√°t chuy·ªÉn th√†nh:', this.playMode);
          this.updateUI();
        }

        setVolume(volume) {
          this.currentVolume = Math.max(0, Math.min(1, volume));
          if (this.audio) {
            this.audio.volume = this.currentVolume;
          }
          $('#volume-display').text(Math.round(this.currentVolume * 100) + '%');
        }

        updateTimeDisplay() {
          if (!this.audio) return;

          const current = this.formatTime(this.audio.currentTime);
          const total = this.formatTime(this.audio.duration || 0);
          $('#current-track-time').text(`${current} / ${total}`);
          if (this.audio.duration && !isNaN(this.audio.duration)) {
            const progress = (this.audio.currentTime / this.audio.duration) * 100;
            const progressSlider = document.getElementById('music-progress-slider');
            if (progressSlider && !this.isDraggingProgress) {
              progressSlider.value = progress;
            }
            $('#current-time-display').text(current);
            $('#total-time-display').text(total);
          } else {
            $('#current-time-display').text('00:00');
            $('#total-time-display').text('00:00');
          }
        }

        formatTime(seconds) {
          if (isNaN(seconds)) return '00:00';
          const mins = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        updateUI() {
          const playPauseBtn = $('#music-play-pause-btn');
          const trackName = $('#current-track-name');
          const modeBtn = $('#music-mode-btn');

          if (this.isPlaying) {
            playPauseBtn.text('‚è∏');
          } else {
            playPauseBtn.text('‚ñ∂');
          }
          let modeText = '';
          let modeTitle = '';
          switch (this.playMode) {
            case 'sequence':
              modeText = '‚ñ∂Ô∏è';
              modeTitle = 'Ph√°t tu·∫ßn t·ª±';
              break;
            case 'random':
              modeText = 'üîÄ';
              modeTitle = 'Ph√°t ng·∫´u nhi√™n';
              break;
            case 'repeat':
              modeText = 'üîÇ';
              modeTitle = 'Ph√°t v√≤ng l·∫∑p';
              break;
          }
          if (modeBtn.length) {
            modeBtn.text(modeText);
            modeBtn.attr('title', modeTitle);
          }

          if (this.currentTrackIndex >= 0 && this.currentTrackIndex < this.tracks.length) {
            const track = this.tracks[this.currentTrackIndex];
            trackName.text(track.name);

            $('.music-track').css('background', 'transparent');
            $(`.music-track[data-src="${track.src}"]`).css('background', 'rgba(139, 69, 19, 0.3)');
          } else {
            trackName.text('Ch∆∞a ch·ªçn nh·∫°c');
          }
        }

        updateProfileSongDisplay() {
          const profileSongElement = $('#profile-current-song');
          const profileSongName = $('#profile-song-name');

          if (this.isPlaying && this.currentTrackIndex >= 0 && this.currentTrackIndex < this.tracks.length) {
            const track = this.tracks[this.currentTrackIndex];
            profileSongName.text(track.name);
            profileSongElement.show();
          } else {
            profileSongElement.hide();
          }
        }
      }

      class QuickMapSystem {
        constructor() {
          this.mapData = {
            mapInfo: {
              id: 'treisen_map',
              name: 'B·∫£n ƒë·ªì Tracen',
              imageUrl: 'https://files.catbox.moe/psluhm.jpg',
              originalWidth: 800,
              originalHeight: 885,
            },
            locations: [
              {
                id: 'location_1757315796222',
                name: 'S√¢n v·∫≠n ƒë·ªông',
                description:
                  'D√πng ƒë·ªÉ hu·∫•n luy·ªán thi ƒë·∫•u. C√°c h·∫°ng m·ª•c hu·∫•n luy·ªán ƒë∆∞·ª£c thi·∫øt l·∫≠p theo ch·ªâ th·ªã c·ªßa hu·∫•n luy·ªán vi√™n m·ªói ƒë·ªôi. Ngo√†i ra, ƒë∆∞·ªùng ƒëua t·ªï ch·ª©c nhi·ªÅu cu·ªôc thi tuy·ªÉn ch·ªçn h√†ng nƒÉm, l∆∞·ª£ng l·ªõn hu·∫•n luy·ªán vi√™n t·∫≠p trung t·∫°i ƒë√¢y, k·∫øt th√†nh quan h·ªá ƒë·∫£m ƒë∆∞∆°ng v·ªõi Uma Musume ∆∞ng √Ω l·∫´n nhau. ƒê∆∞·ªùng ƒëua bao g·ªìm s√¢n c·ªè, s√¢n ƒë·∫•t, dƒÉm g·ªó v√† d·ªëc.',
                type: 'academy',
                coordinates: { x: 0.4325, y: 0.3186 },
              },
              {
                id: 'location_1757315823108',
                name: 'ƒê∆∞·ªùng',
                description: 'M·ªôt con ƒë∆∞·ªùng d√†i d·∫´n ƒë·∫øn l·ªëi m√≤n y√™n tƒ©nh',
                type: 'academy',
                coordinates: { x: 0.1138, y: 0.3209 },
              },
              {
                id: 'location_1757315838038',
                name: 'C·ªïng s√¢n t·∫≠p',
                description: '',
                type: 'academy',
                coordinates: { x: 0.5075, y: 0.4927 },
              },
              {
                id: 'location_1757315853595',
                name: 'ƒê√†i quan s√°t',
                description: 'C√≥ th·ªÉ quan s√°t to√†n b·ªô s√¢n t·∫≠p',
                type: 'academy',
                coordinates: { x: 0.3588, y: 0.4633 },
              },
              {
                id: 'location_1757315890935',
                name: 'Ph√≤ng b∆°i trong nh√†',
                description: 'B√™n trong c√≥ h·ªì b∆°i v√† b·ª•c nh·∫£y, d√πng ƒë·ªÉ hu·∫•n luy·ªán th·ªÉ l·ª±c Uma Musume',
                type: 'academy',
                coordinates: { x: 0.3975, y: 0.5684 },
              },
              {
                id: 'location_1757316016060',
                name: 'Ph√≤ng thu',
                description: 'Ph√≤ng ph√°t thanh h·ªçc vi·ªán',
                type: 'academy',
                coordinates: { x: 0.3375, y: 0.5831 },
              },
              {
                id: 'location_1757316031219',
                name: 'Ph√≤ng t·∫≠p th·ªÉ h√¨nh',
                description:
                  'Ph√≤ng t·∫≠p th·ªÉ h√¨nh ƒë∆∞·ª£c trang b·ªã nhi·ªÅu thi·∫øt b·ªã t·∫≠p luy·ªán, bao g·ªìm t·∫° ƒë√≤n v√† m√°y ch·∫°y b·ªô, d√πng ƒë·ªÉ r√®n luy·ªán th·ªÉ nƒÉng. Nh·ªØng Uma Musume th√≠ch t·∫≠p luy·ªán th∆∞·ªùng xuy√™n lui t·ªõi ƒë√¢y. Ngo√†i ra, ph√≤ng t·∫≠p c√≤n c√≥ s√¢n ch·∫∑t ng√≥i v√† bao c√°t quy·ªÅn anh.',
                type: 'academy',
                coordinates: { x: 0.3075, y: 0.5718 },
              },
              {
                id: 'location_1757316059582',
                name: 'Gi·∫£ng ƒë∆∞·ªùng ch√≠nh',
                description: 'N∆°i Uma Musume l√™n l·ªõp',
                type: 'academy',
                coordinates: { x: 0.4537, y: 0.7243 },
              },
              {
                id: 'location_1757316081381',
                name: 'ƒê·∫°i s·∫£nh Uma Musume',
                description:
                  'ƒê·∫°i s·∫£nh Uma Musume l√† s·∫£nh cao hai t·∫ßng n·∫±m ·ªü trung t√¢m t√≤a nh√† gi·∫£ng ƒë∆∞·ªùng. C√≥ th·ªÉ ƒëi v√†o b·ªô ph·∫≠n mua s·∫Øm, th∆∞ vi·ªán, b·∫£ng th√¥ng b√°o tr∆∞·ªùng, ph√≤ng hu·∫•n luy·ªán vi√™n, ph√≤ng t∆∞ li·ªáu v√† c√°c ƒë·∫°i s·∫£nh ƒëƒÉng k√Ω thi ƒë·∫•u kh√°c nhau. Khi kh√¥ng c√≥ gi·ªù h·ªçc ho·∫∑c hu·∫•n luy·ªán, c√°c Uma Musume s·∫Ω tr√≤ chuy·ªán tr√™n b√†n v√† gh·∫ø sofa ƒë∆∞·ª£c b·ªë tr√≠ s·∫µn. Trong th·ªùi gian di·ªÖn ra s·ª± ki·ªán, ƒë·∫°i s·∫£nh s·∫Ω ƒë∆∞·ª£c trang tr√≠ r·∫•t ƒë·∫πp.',
                type: 'academy',
                coordinates: { x: 0.4525, y: 0.6621 },
              },
              {
                id: 'location_1757316107919',
                name: 'Ph√≤ng hu·∫•n luy·ªán vi√™n',
                description:
                  'N√≥ l√† m·ªôt t√≤a nh√† ƒë·ªôc l·∫≠p, c√≥ t·ªß kh√≥a c·ª• th·ªÉ ƒë·ªÉ c·∫•t gi·ªØ v·∫≠t d·ª•ng c√° nh√¢n d√πng cho hu·∫•n luy·ªán c·ªßa Uma Musume; n√≥ n·ªëi li·ªÅn tr·ª±c ti·∫øp v·ªõi s·∫£nh v√†o c·ªßa t√≤a nh√† gi·∫£ng ƒë∆∞·ªùng ch√≠nh. Kh√°c v·ªõi ph√≤ng gi√°o vi√™n, ch·ªâ c·∫ßn kh√¥ng kh√≥a c·ª≠a, ngay c·∫£ Uma Musume kh√¥ng ph·∫£i ƒë·∫£m ƒë∆∞∆°ng c≈©ng c√≥ th·ªÉ t·ª± do ra v√†o ph√≤ng hu·∫•n luy·ªán vi√™n. Hu·∫•n luy·ªán vi√™n m·ªói ng√†y t·ª´ cƒÉn h·ªô c·ªßa h·ªç ho·∫∑c n∆°i ·ªü g·∫ßn ƒë√≥ ƒë·∫øn ph√≤ng c·ªßa m√¨nh.',
                type: 'academy',
                coordinates: { x: 0.5563, y: 0.6938 },
              },
              {
                id: 'location_1757316131313',
                name: 'Ph√≤ng t∆∞ li·ªáu',
                description: '',
                type: 'academy',
                coordinates: { x: 0.3488, y: 0.6655 },
              },
              {
                id: 'location_1757316135656',
                name: 'Th∆∞ vi·ªán',
                description: '',
                type: 'academy',
                coordinates: { x: 0.3488, y: 0.6949 },
              },
              {
                id: 'location_1757316143920',
                name: 'ƒê·∫°i s·∫£nh ƒëƒÉng k√Ω thi ƒë·∫•u',
                description: '',
                type: 'academy',
                coordinates: { x: 0.3475, y: 0.7232 },
              },
              {
                id: 'location_1757316184357',
                name: 'Nh√† ƒÉn',
                description:
                  'Th·ª±c ƒë∆°n c√≥ v·∫ª r·∫•t c√¢n b·∫±ng, cung c·∫•p nhi·ªÅu m√≥n ƒÉn c√† r·ªët kh√°c nhau.\nNh√† ƒÉn cung c·∫•p buffet mi·ªÖn ph√≠, mu·ªën ƒÉn bao nhi√™u th√¨ ƒÉn, s·∫Ω kh√¥ng ƒë·ªÉ Uma Musume c√≥ c∆° h·ªôi n√≥i ƒÉn kh√¥ng no.\nNh√† ƒÉn c√≤n c√≥ m·ªôt chi·∫øc TV, nh·ªØng Uma Musume kh√¥ng c√≥ l·ªãch thi ƒë·∫•u g·∫ßn ƒë√¢y c√≥ th·ªÉ xem thi ƒë·∫•u ·ªü ƒë√≥.',
                type: 'academy',
                coordinates: { x: 0.2712, y: 0.6768 },
              },
              {
                id: 'location_1757316261180',
                name: 'K√Ω t√∫c x√° hu·∫•n luy·ªán vi√™n',
                description: 'N∆°i hu·∫•n luy·ªán vi√™n s·ªëng m·ªôt m√¨nh, theo l√Ω thuy·∫øt ch·ªâ c√≥ hu·∫•n luy·ªán vi√™n ƒë∆∞·ª£c v√†o',
                type: 'dormitory',
                coordinates: { x: 0.1412, y: 0.7842 },
              },
              {
                id: 'location_1757316315511',
                name: 'T√≤a nh√† h√†nh ch√≠nh',
                description: 'N∆°i c√≥ vƒÉn ph√≤ng hi·ªáu tr∆∞·ªüng, vƒÉn ph√≤ng gi√°o vi√™n',
                type: 'academy',
                coordinates: { x: 0.2825, y: 0.7864 },
              },
              {
                id: 'location_1757316324398',
                name: 'Ph√≤ng y t·∫ø',
                description: '',
                type: 'academy',
                coordinates: { x: 0.2362, y: 0.8181 },
              },
              {
                id: 'location_1757316354682',
                name: 'T∆∞·ª£ng Ba N·ªØ Th·∫ßn',
                description: 'T·ªça l·∫°c tr∆∞·ªõc t√≤a nh√† gi·∫£ng ƒë∆∞·ªùng, gi·ªØa qu·∫£ng tr∆∞·ªùng trung t√¢m',
                type: 'academy',
                coordinates: { x: 0.455, y: 0.7898 },
              },
              {
                id: 'location_1757316365937',
                name: 'Qu·∫£ng tr∆∞·ªùng trung t√¢m',
                description: '',
                type: 'academy',
                coordinates: { x: 0.455, y: 0.826 },
              },
              {
                id: 'location_1757316382806',
                name: 'B√£i ƒë·∫≠u xe',
                description: 'M·ªôt b√£i ƒë·∫≠u xe r·ªông l·ªõn',
                type: 'academy',
                coordinates: { x: 0.7662, y: 0.513 },
              },
              {
                id: 'location_1757316447437',
                name: 'S√¢n kh·∫•u bi·ªÉu di·ªÖn ngo√†i tr·ªùi',
                description: 'N∆°i bi·ªÉu di·ªÖn s√¢n kh·∫•u chi·∫øn th·∫Øng c·ªßa Uma Musume',
                type: 'academy',
                coordinates: { x: 0.6575, y: 0.6655 },
              },
              {
                id: 'location_1757316464723',
                name: 'Ph√≤ng t·∫≠p nh·∫£y',
                description:
                  'N√≥ ƒë∆∞·ª£c d√πng ƒë·ªÉ luy·ªán t·∫≠p s√¢n kh·∫•u chi·∫øn th·∫Øng. N√≥ c√≤n c√≥ ch·ª©c nƒÉng ki·ªÉm tra gi·ªù gi·ªõi nghi√™m, c√°c Uma Musume lu√¢n phi√™n ph·ª• tr√°ch vi·ªác n√†y, th∆∞·ªùng do Oguri Cap, Hishi Amazon v√† Fuji Kiseki ƒë·∫£m nhi·ªám.\nT∆∞·ªùng l√† m·∫∑t g∆∞∆°ng, ƒë·ªìng th·ªùi c√≤n c√≥ thanh x√† d√πng cho l·ªõp m√∫a ba l√™ c√πng v·ªõi loa.',
                type: 'academy',
                coordinates: { x: 0.6262, y: 0.6983 },
              },
              {
                id: 'location_1757316486267',
                name: 'S√¢n qu·∫ßn v·ª£t',
                description: '',
                type: 'academy',
                coordinates: { x: 0.595, y: 0.896 },
              },
              {
                id: 'location_1757316492058',
                name: 'S√¢n b√≥ng ƒë√°',
                description: '',
                type: 'academy',
                coordinates: { x: 0.25, y: 0.8893 },
              },
              {
                id: 'location_1757316529235',
                name: 'C·ªïng ch√≠nh',
                description: 'C·ªïng ch√≠nh r·ªùi kh·ªèi H·ªçc vi·ªán Tracen',
                type: 'academy',
                coordinates: { x: 0.4537, y: 0.9028 },
              },
              {
                id: 'location_1757316616185',
                name: 'Nh√† thi ƒë·∫•u trong nh√†',
                description: 'B√™n trong c√≥ s√¢n b√≥ng r·ªï, s√¢n v·∫≠n ƒë·ªông trong nh√†',
                type: 'academy',
                coordinates: { x: 0.6225, y: 0.8011 },
              },
              {
                id: 'location_1757316674951',
                name: 'T√≤a nh√† ph·ª• B',
                description: 'T√≤a nh√† ph·ª• B b√™n ph·∫£i gi·∫£ng ƒë∆∞·ªùng ch√≠nh',
                type: 'academy',
                coordinates: { x: 0.5637, y: 0.7831 },
              },
              {
                id: 'location_1757316700900',
                name: 'T√≤a nh√† ph·ª• A',
                description: 'T√≤a nh√† ph·ª• A b√™n tr√°i gi·∫£ng ƒë∆∞·ªùng ch√≠nh',
                type: 'academy',
                coordinates: { x: 0.35, y: 0.7876 },
              },
              {
                id: 'location_1757316880923',
                name: 'H·ªëc c√¢y kh√¥ s√¢n trong',
                description:
                  'H·ªëc c√¢y n·∫±m ·ªü m·ªôt g√≥c s√¢n trong h·ªçc vi·ªán. B√™n trong tr·ªëng r·ªóng m·ªü toang, l√† n∆°i d√πng ƒë·ªÉ m·ªçi ng∆∞·ªùi tr√∫t b·ªè ƒëau kh·ªï v√† h·ªëi h·∫≠n. Ngo√†i ra, c≈©ng c√≥ Uma Musume l·ª£i d·ª•ng n√≥ ƒë·ªÉ tr√∫t b·ªè m·ªôt s·ªë suy nghƒ© kh√¥ng ki·ªÅm ch·∫ø ƒë∆∞·ª£c trong ƒë·∫ßu.',
                type: 'academy',
                coordinates: { x: 0.5112, y: 0.652 },
              },
              {
                id: 'location_1757316897037',
                name: 'R·ª´ng nh·ªè',
                description: 'R·ª´ng nh·ªè b√≠ ·∫©n',
                type: 'academy',
                coordinates: { x: 0.17, y: 0.5198 },
              },
              {
                id: 'location_1757316924958',
                name: 'N√¥ng tr·∫°i c√† r·ªët',
                description: 'N√¥ng tr·∫°i Uma Musume tr·ªìng c√† r·ªët',
                type: 'academy',
                coordinates: { x: 0.2288, y: 0.5299 },
              },
              {
                id: 'location_1757316979646',
                name: 'N√∫i sau',
                description: '·ªû ƒë√¢y c√≥ th·ªÉ v√†o su·ªëi n∆∞·ªõc n√≥ng, c·∫ßn v√© v√†o c·ª≠a v√© su·ªëi n∆∞·ªõc n√≥ng',
                type: 'academy',
                coordinates: { x: 0.7037, y: 0.1322 },
              },
              {
                id: 'location_1757317006073',
                name: 'Ph√≤ng ho·∫°t ƒë·ªông 1',
                description: 'Ph√≤ng ho·∫°t ƒë·ªông nh·ªè c·ªßa Uma Musume',
                type: 'academy',
                coordinates: { x: 0.5288, y: 0.9345 },
              },
              {
                id: 'location_1757317034055',
                name: 'Ph√≤ng ho·∫°t ƒë·ªông 2',
                description: 'Ph√≤ng ho·∫°t ƒë·ªông nh·ªè c·ªßa Uma Musume ph√¢n b·ªë ·ªü g√≥c h·ªçc vi·ªán',
                type: 'academy',
                coordinates: { x: 0.715, y: 0.9345 },
              },
              {
                id: 'location_1757317092573',
                name: 'ƒêi ƒë·∫øn k√Ω t√∫c x√° Uma Musume',
                description: 'Chia l√†m K√Ω t√∫c x√° Miho v√† K√Ω t√∫c x√° Ritto, n·∫±m ngo√†i h·ªçc vi·ªán, ƒë·ªëi di·ªán c·ªïng ch√≠nh h·ªçc vi·ªán',
                type: 'dormitory',
                coordinates: { x: 0.4525, y: 0.9367 },
              },
              {
                id: 'location_1757317305740',
                name: 'T√≤a nh√† ho·∫°t ƒë·ªông',
                description: 'T√≤a nh√† d√†nh cho Uma Musume gi·∫£i tr√≠, ho·∫°t ƒë·ªông ho·∫∑c tham gia ho·∫°t ƒë·ªông c√¢u l·∫°c b·ªô trong gi·ªù ngh·ªâ, c√≥ ph√≤ng m·ªπ thu·∫≠t, ph√≤ng √¢m nh·∫°c, v.v.',
                type: 'academy',
                coordinates: { x: 0.6775, y: 0.8915 },
              },
              {
                id: 'location_1757317376475',
                name: 'ƒêi ƒë·∫øn nh√† ga',
                description: 'B√™n trong c√≥ trung t√¢m th∆∞∆°ng m·∫°i v√† nh√† h√†ng, trung t√¢m giao th√¥ng',
                type: 'event',
                coordinates: { x: 0.8775, y: 0.4497 },
              },
              {
                id: 'location_1757317431673',
                name: 'ƒêi ƒë·∫øn ph·ªë th∆∞∆°ng m·∫°i',
                description: 'Ph·ªë th∆∞∆°ng m·∫°i b√™n ngo√†i h·ªçc vi·ªán, ·ªü ƒë√≥ c√≥ khu vui ch∆°i, m√°y gacha, r·∫°p chi·∫øu phim, Karaoke',
                type: 'event',
                coordinates: { x: 0.9, y: 0.4836 },
              },
              {
                id: 'location_1757317539563',
                name: 'ƒêi ƒë·∫øn ƒë√™ s√¥ng',
                description: 'B·ªù ƒë√™ b√™n s√¥ng ngo√†i h·ªçc vi·ªán, m√¥i tr∆∞·ªùng t∆∞∆°i ƒë·∫πp',
                type: 'academy',
                coordinates: { x: 0.82, y: 0.4576 },
              },
            ],
          };

          this.selectedLocation = null;
          this.zoomLevel = 1;
          this.minZoom = 0.5;
          this.maxZoom = 3;
          this.zoomStep = 0.25;
          this.isDragging = false;
          this.dragStart = { x: 0, y: 0 };
          this.dragOffset = { x: 0, y: 0 };
          this.init();
        }

        init() {
          this.bindEvents();
        }

        bindEvents() {
          $(document).on('click', '#quickmap-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.openQuickMap();
          });

          $(document).on('click', '#close-quick-map-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.closeQuickMap();
          });

          $(document).on('click', '#quick-map-modal', e => {
            if (e.target.id === 'quick-map-modal') {
              this.closeQuickMap();
            }
          });

          $(window).on('resize', () => {
            if ($('#quick-map-modal').is(':visible')) {
              setTimeout(() => {
                this.renderMapMarkers();
              }, 100);
            }
          });

          $(document).on('click', '#close-location-confirm-btn, #cancel-location-move', e => {
            e.preventDefault();
            e.stopPropagation();
            this.closeLocationConfirm();
          });

          $(document).on('click', '#confirm-location-move', e => {
            e.preventDefault();
            e.stopPropagation();
            this.executeMove();
          });

          $(document).on('click', '#location-confirm-modal', e => {
            if (e.target.id === 'location-confirm-modal') {
              this.closeLocationConfirm();
            }
          });

          $(document).on('click', '#zoom-in-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.zoomIn();
          });

          $(document).on('click', '#zoom-out-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.zoomOut();
          });

          $(document).on('click', '#zoom-reset-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.resetZoom();
          });

          $(document).on('mousedown', '#map-container', e => {
            if (this.zoomLevel > 1 && !$(e.target).hasClass('compact-button') && !$(e.target).hasClass('map-marker')) {
              this.isDragging = true;
              this.dragStart.x = e.clientX;
              this.dragStart.y = e.clientY;
              $('#map-container').css('cursor', 'grabbing');
              e.preventDefault();
              e.stopPropagation();
            }
          });

          $(document).on('mousemove', e => {
            if (this.isDragging && this.zoomLevel > 1) {
              const deltaX = e.clientX - this.dragStart.x;
              const deltaY = e.clientY - this.dragStart.y;

              this.dragOffset.x += deltaX;
              this.dragOffset.y += deltaY;

              this.dragStart.x = e.clientX;
              this.dragStart.y = e.clientY;

              this.updateTransform();
              e.preventDefault();
            }
          });

          $(document).on('mouseup', () => {
            if (this.isDragging) {
              this.isDragging = false;
              $('#map-container').css('cursor', this.zoomLevel > 1 ? 'grab' : 'default');
            }
          });

          $(document).on('mouseleave', '#quick-map-modal', () => {
            if (this.isDragging) {
              this.isDragging = false;
              $('#map-container').css('cursor', this.zoomLevel > 1 ? 'grab' : 'default');
            }
          });
        }

        openQuickMap() {
          console.log('üó∫Ô∏è M·ªü b·∫£n ƒë·ªì nhanh');
          const modal = document.getElementById('quick-map-modal');
          if (modal) {
            const overlay = document.getElementById('teresen-fullscreen-overlay');
            if (overlay && modal.parentNode !== overlay) {
              modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
              overlay.appendChild(modal);
            }
          }
          $('#quick-map-modal').show();
          setTimeout(() => {
            this.renderMapMarkers();
          }, 100);
        }

        closeQuickMap() {
          $('#quick-map-modal').hide();
          this.resetZoom();
        }

        renderMapMarkers() {
          const container = document.getElementById('quick-map-markers-container');
          const image = document.getElementById('quick-map-image');

          if (!container || !image) return;

          const waitForImageLoad = () => {
            if (image.complete && image.naturalHeight !== 0) {
              this.placeMarkers(container, image);
            } else {
              image.onload = () => this.placeMarkers(container, image);
            }
          };

          waitForImageLoad();
        }

        placeMarkers(container, image) {
          container.innerHTML = '';

          const imageWidth = image.offsetWidth;
          const imageHeight = image.offsetHeight;

          this.mapData.locations.forEach(location => {
            const marker = document.createElement('div');
            marker.className = 'map-marker';
            marker.dataset.locationId = location.id;

            const x = location.coordinates.x * imageWidth;
            const y = location.coordinates.y * imageHeight;

            marker.style.cssText = `
              position: absolute;
              left: ${x}px;
              top: ${y}px;
              width: 12px;
              height: 12px;
              border-radius: 50%;
              background: ${this.getTypeColor(location.type)};
              border: 2px solid white;
              cursor: pointer;
              pointer-events: all;
              transform: translate(-50%, -50%);
              transition: all 0.2s;
              z-index: 10;
              box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            `;

            marker.addEventListener('mouseenter', () => {
              marker.style.transform = 'translate(-50%, -50%) scale(1.5)';
              marker.style.zIndex = '20';
            });

            marker.addEventListener('mouseleave', () => {
              marker.style.transform = 'translate(-50%, -50%) scale(1)';
              marker.style.zIndex = '10';
            });

            marker.addEventListener('click', e => {
              e.stopPropagation();
              this.confirmMoveTo(location);
            });

            container.appendChild(marker);

            const label = document.createElement('div');
            label.className = 'map-label';
            label.textContent = location.name;
            label.style.cssText = `
              position: absolute;
              left: ${x}px;
              top: ${y}px;
              transform: translate(-50%, -25px);
              font-size: 12px;
              color: #ffffff;
              font-weight: bold;
              white-space: nowrap;
              text-shadow: 2px 2px 4px rgba(0,0,0,0.9), -1px -1px 2px rgba(0,0,0,0.7);
              background: rgba(0,0,0,0.6);
              padding: 2px 6px;
              border-radius: 4px;
              pointer-events: none;
              z-index: 5;
            `;

            container.appendChild(label);
          });
        }

        getTypeColor(type) {
          const colors = {
            academy: '#007bff',
            dormitory: '#28a745',
            event: '#ffc107',
          };
          return colors[type] || '#6c757d';
        }

        confirmMoveTo(location) {
          this.selectedLocation = location;

          $('#confirm-location-name').text(location.name);
          $('#confirm-location-description').text(location.description || 'Kh√¥ng c√≥ m√¥ t·∫£ chi ti·∫øt');
          const modal = document.getElementById('location-confirm-modal');
          if (modal) {
            const overlay = document.getElementById('teresen-fullscreen-overlay');
            if (overlay && modal.parentNode !== overlay) {
              modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
              overlay.appendChild(modal);
            }
          }

          $('#location-confirm-modal').fadeIn(200);
        }

        closeLocationConfirm() {
          $('#location-confirm-modal').fadeOut(200);
          this.selectedLocation = null;
        }

        executeMove() {
          if (!this.selectedLocation) return;
          const actionText = `[ƒêi ƒë·∫øn ${this.selectedLocation.name}]`;
          const actionInput = document.getElementById('action-input');
          if (actionInput) {
            actionInput.value = actionText;
            actionInput.focus();
            console.log(`üó∫Ô∏è ƒê√£ ƒëi·ªÅn l·ªánh di chuy·ªÉn v√†o √¥ nh·∫≠p: ${actionText}`);
            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage(`ƒê√£ ƒëi·ªÅn ${actionText} v√†o √¥ nh·∫≠p`);
            }
          } else {
            console.error('Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ action-input');
          }

          this.closeLocationConfirm();
          this.closeQuickMap();
        }

        zoomIn() {
          if (this.zoomLevel < this.maxZoom) {
            this.zoomLevel = Math.min(this.zoomLevel + this.zoomStep, this.maxZoom);
            this.applyZoom();
          }
        }

        zoomOut() {
          if (this.zoomLevel > this.minZoom) {
            this.zoomLevel = Math.max(this.zoomLevel - this.zoomStep, this.minZoom);
            this.applyZoom();
          }
        }

        resetZoom() {
          this.zoomLevel = 1;
          this.dragOffset.x = 0;
          this.dragOffset.y = 0;
          this.applyZoom();
        }

        updateTransform() {
          const mapContainer = document.getElementById('map-container');
          if (mapContainer) {
            mapContainer.style.transform = `scale(${this.zoomLevel}) translate(${this.dragOffset.x}px, ${this.dragOffset.y}px)`;
          }
        }

        applyZoom() {
          const mapContainer = document.getElementById('map-container');

          if (mapContainer) {
            mapContainer.style.transform = `scale(${this.zoomLevel}) translate(${this.dragOffset.x}px, ${this.dragOffset.y}px)`;
            mapContainer.style.cursor = this.zoomLevel > 1 ? 'grab' : 'default';
          }
        }
      }

      $(document).ready(() => {
        setTimeout(() => {
          window.quickMapSystem = new QuickMapSystem();
          window.musicPlayerSystem = new MusicPlayerSystem();
          window.achievementSystem = new TreisenAchievementSystem();
          window.achievementSystem.init();
          console.log('üó∫Ô∏è Kh·ªüi t·∫°o h·ªá th·ªëng b·∫£n ƒë·ªì nhanh ho√†n t·∫•t');
          console.log('üèÜ Kh·ªüi t·∫°o h·ªá th·ªëng th√†nh t·ª±u Tracen ho√†n t·∫•t');
        }, 200);
      });
    </script>

    <script>
      const TREISEN_ACHIEVEMENTS = [
        {
          id: 'talent_awakened',
          name: 'Th·ª©c T·ªânh Thi√™n Ph√∫',
          description: 'Th·ª©c t·ªânh th√†nh c√¥ng ƒê·∫°i Thi√™n Ph√∫ ƒë·∫ßu ti√™n',
          completionText: 'S·ª©c m·∫°nh s√¢u th·∫≥m trong n·ªôi t√¢m b·∫Øt ƒë·∫ßu th·ª©c t·ªânh',
          quality: 'Hi·∫øm',
          icon: 'üèÜ',
          requirement: { type: 'mvu', key: 'trainer.talent.majorTalent.name', operator: '!=', value: '' },
        },
        {
          id: 'small_talent_unlocked',
          name: 'Khai S√°ng Ti·ªÉu Thi√™n Ph√∫',
          description: 'M·ªü kh√≥a ti·ªÉu thi√™n ph√∫ ƒë·∫ßu ti√™n (C·∫•p b·∫≠c M·∫ßm M·ªëng)',
          completionText: 'B∆∞·ªõc ƒë·∫ßu ti√™n tr√™n con ƒë∆∞·ªùng thi√™n ph√∫',
          quality: 'Ph·ªï Th√¥ng',
          icon: 'üèÜ',
          requirement: { type: 'mvu', key: 'trainer.talent.minorTalent.sprout', operator: '!=', value: null },
        },
        {
          id: 'first_crystal',
          name: 'Thu Ho·∫°ch L·∫ßn ƒê·∫ßu',
          description: 'Nh·∫≠n ƒë∆∞·ª£c Tinh th·ªÉ T√¨nh c·∫£m Bi·∫øn d·ªã ƒë·∫ßu ti√™n',
          completionText: 'Tinh th·ªÉ k·ª≥ l·∫° n√†y t·ªèa ra √°nh s√°ng b√≠ ·∫©n',
          quality: 'Ph·ªï Th√¥ng',
          icon: 'üèÜ',
          requirement: { type: 'mvu', key: 'trainer.twistedAffectionCrystals', operator: '>=', value: 1 },
        },
        {
          id: 'crystal_collector',
          name: 'Nh√† S∆∞u T·∫≠p K·∫øt Tinh',
          description: 'T√≠ch l≈©y 50 Tinh th·ªÉ T√¨nh c·∫£m Bi·∫øn d·ªã',
          completionText: 'Nh·ªØng tinh th·ªÉ n√†y ch·ª©a ƒë·ª±ng s·ª©c m·∫°nh to l·ªõn',
          quality: 'Hi·∫øm',
          icon: 'üèÜ',
          requirement: { type: 'mvu', key: 'trainer.twistedAffectionCrystals', operator: '>=', value: 50 },
        },
        {
          id: 'crystal_hoarder',
          name: 'B·∫≠c Th·∫ßy K·∫øt Tinh',
          description: 'T√≠ch l≈©y 100 Tinh th·ªÉ T√¨nh c·∫£m Bi·∫øn d·ªã',
          completionText: 'B·∫°n ƒë√£ n·∫Øm v·ªØng b√≠ m·∫≠t c·ªßa vi·ªác k·∫øt tinh h√≥a t√¨nh c·∫£m',
          quality: 'S·ª≠ Thi',
          icon: 'üèÜ',
          requirement: { type: 'mvu', key: 'trainer.twistedAffectionCrystals', operator: '>=', value: 100 },
        },
        {
          id: 'sanity_crisis',
          name: 'B√™n B·ªù V·ª±c L√Ω Tr√≠',
          description: 'L√Ω tr√≠ gi·∫£m xu·ªëng d∆∞·ªõi 20 nh∆∞ng v·∫´n s·ªëng s√≥t',
          completionText: 'B√™n b·ªù v·ª±c ƒëi√™n lo·∫°n, b·∫°n v·∫´n ki√™n tr√¨',
          quality: 'S·ª≠ Thi',
          icon: 'üèÜ',
          requirement: { type: 'mvu', key: 'trainer.sanity', operator: '<=', value: 20 },
        },
        {
          id: 'exhausted',
          name: 'Ki·ªát S·ª©c',
          description: 'Th·ªÉ l·ª±c gi·∫£m xu·ªëng d∆∞·ªõi 10',
          completionText: 'M·ªát m·ªèi r√£ r·ªùi, nh∆∞ng √Ω ch√≠ v·∫´n ki√™n ƒë·ªãnh',
          quality: 'Ph·ªï Th√¥ng',
          icon: 'üèÜ',
          requirement: { type: 'mvu', key: 'trainer.stamina', operator: '<=', value: 10 },
        },
        {
          id: 'rule_breaker',
          name: 'K·∫ª N·ªïi Lo·∫°n',
          description: 'Vi ph·∫°m quy t·∫Øc tr√™n 5 l·∫ßn',
          completionText: 'ƒê√¥i khi, l√†m tr√°i quy t·∫Øc c≈©ng l√† m·ªôt l·ª±a ch·ªçn',
          quality: 'Hi·∫øm',
          icon: '‚ö°',
          requirement: { type: 'mvu', key: 'trainer.committedViolationCount', operator: '>=', value: 5 },
        },
        {
          id: 'week_survivor',
          name: 'Ng∆∞·ªùi S·ªëng S√≥t M·ªôt Tu·∫ßn',
          description: 'S·ªëng s√≥t 7 ng√†y trong h·ªçc vi·ªán',
          completionText: 'B·∫°n ƒë√£ th√≠ch nghi v·ªõi cu·ªôc s·ªëng n∆°i ƒë√¢y',
          quality: 'Ph·ªï Th√¥ng',
          icon: 'üìÖ',
          requirement: { type: 'mvu', key: 'trainer.daysInSchool', operator: '>=', value: 7 },
        },
        {
          id: 'month_veteran',
          name: 'H·ªçc Vi√™n K·ª≥ C·ª±u',
          description: 'S·ªëng s√≥t 30 ng√†y trong h·ªçc vi·ªán',
          completionText: 'B·∫°n ƒë√£ l√† tay l√£o luy·ªán ·ªü ƒë√¢y r·ªìi',
          quality: 'Hi·∫øm',
          icon: 'üéì',
          requirement: { type: 'mvu', key: 'trainer.daysInSchool', operator: '>=', value: 30 },
        },
        {
          id: 'lucky_star',
          name: 'Ng√¥i Sao May M·∫Øn',
          description: 'May m·∫Øn ƒë·∫°t tr√™n 80',
          completionText: 'N·ªØ th·∫ßn v·∫≠n m·ªánh ƒëang chi·∫øu c·ªë b·∫°n',
          quality: 'Hi·∫øm',
          icon: 'üçÄ',
          requirement: { type: 'mvu', key: 'trainer.luck', operator: '>=', value: 80 },
        },
        {
          id: 'unlucky_soul',
          name: 'K·∫ª Xui X·∫ªo',
          description: 'May m·∫Øn gi·∫£m xu·ªëng d∆∞·ªõi 20',
          completionText: 'ƒê√¥i khi v·∫≠n xui c≈©ng l√† m·ªôt lo·∫°i tr·∫£i nghi·ªám',
          quality: 'Ph·ªï Th√¥ng',
          icon: 'üòÖ',
          requirement: { type: 'mvu', key: 'trainer.luck', operator: '<=', value: 20 },
        },
        {
          id: 'research_start',
          name: 'Tr·ª£ L√Ω Nghi√™n C·ª©u',
          description: 'Nh·∫≠n ƒë∆∞·ª£c ƒëi·ªÉm d·ªØ li·ªáu th·ª±c nghi·ªám ƒë·∫ßu ti√™n',
          completionText: 'Con ƒë∆∞·ªùng nghi√™n c·ª©u khoa h·ªçc b·∫Øt ƒë·∫ßu t·ª´ ƒë√¢y',
          quality: 'Ph·ªï Th√¥ng',
          icon: 'üî¨',
          requirement: { type: 'mvu', key: 'trainer.experimentDataPoints', operator: '>=', value: 1 },
        },
        {
          id: 'first_gacha',
          name: 'R√∫t Th∆∞·ªüng L·∫ßn ƒê·∫ßu',
          description: 'Nh·∫≠n ƒë∆∞·ª£c Xu Gacha ƒë·∫ßu ti√™n',
          completionText: 'Tr√≤ ch∆°i may r·ªßi s·∫Øp b·∫Øt ƒë·∫ßu',
          quality: 'Ph·ªï Th√¥ng',
          icon: 'üé∞',
          requirement: { type: 'mvu', key: 'trainer.gachaCoin', operator: '>=', value: 1 },
        },
        {
          id: 'second_chance',
          name: 'B·∫Øt ƒê·∫ßu L·∫°i',
          description: 'Tr·∫£i qua lu√¢n h·ªìi l·∫ßn ƒë·∫ßu ti√™n',
          completionText: 'C√°i ch·∫øt kh√¥ng ph·∫£i l√† k·∫øt th√∫c, m√† l√† s·ª± kh·ªüi ƒë·∫ßu m·ªõi',
          quality: 'S·ª≠ Thi',
          icon: 'üîÑ',
          requirement: { type: 'mvu', key: 'trainer.reincarnationCount', operator: '>=', value: 1 },
        },
        {
          id: 'eternal_returner',
          name: 'Ng∆∞·ªùi Lu√¢n H·ªìi Vƒ©nh C·ª≠u',
          description: 'Tr·∫£i qua 3 l·∫ßn lu√¢n h·ªìi',
          completionText: 'B·∫°n ƒë√£ v∆∞·ª£t qua s·ª± tr√≥i bu·ªôc c·ªßa c√°i ch·∫øt',
          quality: 'Truy·ªÅn Thuy·∫øt',
          icon: '‚ôæÔ∏è',
          requirement: { type: 'mvu', key: 'trainer.reincarnationCount', operator: '>=', value: 3 },
        },
        {
          id: 'talent_growth',
          name: 'Thi√™n Ph√∫ Tr∆∞·ªüng Th√†nh',
          description: 'M·ªü kh√≥a ti·ªÉu thi√™n ph√∫ c·∫•p b·∫≠c Sinh Tr∆∞·ªüng',
          completionText: 'Thi√™n ph√∫ c·ªßa b·∫°n ƒëang l·ªõn m·∫°nh',
          quality: 'Ph·ªï Th√¥ng',
          icon: 'üå±',
          requirement: { type: 'mvu', key: 'trainer.talent.minorTalent.growth', operator: '!=', value: null },
        },
        {
          id: 'talent_mutation',
          name: 'Thi√™n Ph√∫ Bi·∫øn D·ªã',
          description: 'M·ªü kh√≥a ti·ªÉu thi√™n ph√∫ c·∫•p b·∫≠c Bi·∫øn d·ªã',
          completionText: 'C√°i gi√° c·ªßa s·ª©c m·∫°nh l√† s·ª± v·∫∑n v·∫πo',
          quality: 'Hi·∫øm',
          icon: 'üß¨',
          requirement: { type: 'mvu', key: 'trainer.talent.minorTalent.mutation', operator: '!=', value: null },
        },
        {
          id: 'talent_authority',
          name: 'N·∫Øm Gi·ªØ Quy·ªÅn NƒÉng',
          description: 'M·ªü kh√≥a ti·ªÉu thi√™n ph√∫ c·∫•p b·∫≠c Quy·ªÅn nƒÉng',
          completionText: 'B·∫°n b·∫Øt ƒë·∫ßu n·∫Øm gi·ªØ quy·ªÅn l·ª±c th·ª±c s·ª±',
          quality: 'S·ª≠ Thi',
          icon: 'üèÜ',
          requirement: { type: 'mvu', key: 'trainer.talent.minorTalent.authority', operator: '!=', value: null },
        },
        {
          id: 'talent_abyss',
          name: 'V·ª±c Th·∫≥m Ng∆∞ng Th·ªã',
          description: 'M·ªü kh√≥a ti·ªÉu thi√™n ph√∫ c·∫•p b·∫≠c V·ª±c th·∫≥m',
          completionText: 'Khi b·∫°n nh√¨n v√†o v·ª±c th·∫≥m, v·ª±c th·∫≥m c≈©ng ƒëang nh√¨n l·∫°i b·∫°n',
          quality: 'Truy·ªÅn Thuy·∫øt',
          icon: 'üï≥Ô∏è',
          requirement: { type: 'mvu', key: 'trainer.talent.minorTalent.abyss', operator: '!=', value: null },
        },
        {
          id: 'critical_sanity',
          name: 'L√Ω Tr√≠ S·ª•p ƒê·ªï',
          description: 'L√Ω tr√≠ gi·∫£m xu·ªëng d∆∞·ªõi 5',
          completionText: 'B·∫°n ƒëang gi√£y gi·ª•a trong v·ª±c th·∫≥m ƒëi√™n lo·∫°n',
          quality: 'Truy·ªÅn Thuy·∫øt',
          icon: 'üíÄ',
          requirement: { type: 'mvu', key: 'trainer.sanity', operator: '<=', value: 5 },
        },
        {
          id: 'near_death',
          name: 'Tr·∫£i Nghi·ªám C·∫≠n T·ª≠',
          description: 'Th·ªÉ l·ª±c gi·∫£m xu·ªëng 1',
          completionText: 'B·∫°n c·∫£m nh·∫≠n ƒë∆∞·ª£c h∆°i th·ªü c·ªßa t·ª≠ th·∫ßn',
          quality: 'S·ª≠ Thi',
          icon: 'üíî',
          requirement: { type: 'mvu', key: 'trainer.stamina', operator: '<=', value: 1 },
        },
        {
          id: 'fortune_favored',
          name: 'Con C∆∞ng C·ªßa Tr·ªùi',
          description: 'May m·∫Øn ƒë·∫°t tr√™n 95',
          completionText: 'B·∫°n ch√≠nh l√† con c∆∞ng c·ªßa tr·ªùi trong truy·ªÅn thuy·∫øt',
          quality: 'Truy·ªÅn Thuy·∫øt',
          icon: 'üèÜ',
          requirement: { type: 'mvu', key: 'trainer.luck', operator: '>=', value: 95 },
        },
        {
          id: 'cursed_soul',
          name: 'Linh H·ªìn B·ªã Nguy·ªÅn R·ªßa',
          description: 'May m·∫Øn gi·∫£m xu·ªëng d∆∞·ªõi 5',
          completionText: 'D∆∞·ªùng nh∆∞ c·∫£ th·∫ø gi·ªõi ƒëang ch·ªëng l·∫°i b·∫°n',
          quality: 'S·ª≠ Thi',
          icon: 'üå©Ô∏è',
          requirement: { type: 'mvu', key: 'trainer.luck', operator: '<=', value: 5 },
        },
        {
          id: 'crystal_master',
          name: 'T√¥ng S∆∞ K·∫øt Tinh',
          description: 'T√≠ch l≈©y 500 Tinh th·ªÉ T√¨nh c·∫£m Bi·∫øn d·ªã',
          completionText: 'B·∫°n ƒë√£ l√† chuy√™n gia tuy·ªát ƒë·ªëi v·ªÅ k·∫øt tinh h√≥a t√¨nh c·∫£m',
          quality: 'Truy·ªÅn Thuy·∫øt',
          icon: 'üí†',
          requirement: { type: 'mvu', key: 'trainer.twistedAffectionCrystals', operator: '>=', value: 500 },
        },
        {
          id: 'mad_scientist',
          name: 'Nh√† Khoa H·ªçc ƒêi√™n',
          description: 'T√≠ch l≈©y 500 ƒëi·ªÉm d·ªØ li·ªáu th·ª±c nghi·ªám',
          completionText: 'V√¨ khoa h·ªçc, c√°i gi√° n√†o c≈©ng x·ª©ng ƒë√°ng',
          quality: 'S·ª≠ Thi',
          icon: '‚öóÔ∏è',
          requirement: { type: 'mvu', key: 'trainer.experimentDataPoints', operator: '>=', value: 500 },
        },
        {
          id: 'gacha_addict',
          name: 'K·∫ª Nghi·ªán Gacha',
          description: 'T√≠ch l≈©y 50 Xu Gacha',
          completionText: 'S·ª©c h·∫•p d·∫´n c·ªßa Gacha khi·∫øn ng∆∞·ªùi ta kh√¥ng th·ªÉ c∆∞·ª°ng l·∫°i',
          quality: 'Hi·∫øm',
          icon: 'üé≤',
          requirement: { type: 'mvu', key: 'trainer.gachaCoin', operator: '>=', value: 50 },
        },
        {
          id: 'item_collector',
          name: 'Nh√† S∆∞u T·∫≠p',
          description: 'S·ªü h·ªØu 5 ƒë·∫°o c·ª• kh√°c nhau trong t√∫i ƒë·ªì',
          completionText: 'B·∫°n b·∫Øt ƒë·∫ßu t√≠ch l≈©y c√°c v·∫≠t ph·∫©m h·ªØu √≠ch',
          quality: 'Ph·ªï Th√¥ng',
          icon: 'üéí',
          requirement: { type: 'mvu', key: 'trainer.inventory', operator: 'count_>=', value: 5 },
        },
        {
          id: 'item_hoarder',
          name: 'K·∫ª T√≠ch Tr·ªØ',
          description: 'S·ªü h·ªØu 15 ƒë·∫°o c·ª• kh√°c nhau trong t√∫i ƒë·ªì',
          completionText: 'Ba l√¥ c·ªßa b·∫°n s·∫Øp kh√¥ng ch·ª©a n·ªïi r·ªìi',
          quality: 'Hi·∫øm',
          icon: 'üì¶',
          requirement: { type: 'mvu', key: 'trainer.inventory', operator: 'count_>=', value: 15 },
        },
        {
          id: 'treasure_hunter',
          name: 'Th·ª£ SƒÉn Kho B√°u',
          description: 'S·ªü h·ªØu 30 ƒë·∫°o c·ª• kh√°c nhau trong t√∫i ƒë·ªì',
          completionText: 'B·∫°n ƒë√£ l√† b·∫≠c th·∫ßy s∆∞u t·∫ßm kho b√°u danh x·ª©ng v·ªõi th·ª±c',
          quality: 'S·ª≠ Thi',
          icon: 'üí∞',
          requirement: { type: 'mvu', key: 'trainer.inventory', operator: 'count_>=', value: 30 },
        },
        {
          id: 'handbook_keeper',
          name: 'Ng∆∞·ªùi B·∫£o V·ªá S·ªï Tay',
          description: 'Lu√¥n gi·ªØ S·ªï tay hu·∫•n luy·ªán vi√™n H·ªçc vi·ªán Tracen',
          completionText: 'Cu·ªën s·ªï tay n√†y l√† ƒëi·ªÉm neo duy nh·∫•t c·ªßa b·∫°n trong th·∫ø gi·ªõi n√†y',
          quality: 'Ph·ªï Th√¥ng',
          icon: 'üìñ',
          requirement: { type: 'mvu', key: 'trainer.inventory.tracenAcademyTrainerManual', operator: 'exists' },
        },
        {
          id: 'first_bond',
          name: 'L·∫ßn ƒê·∫ßu G·∫∑p G·ª°',
          description: 'Thi·∫øt l·∫≠p li√™n k·∫øt v·ªõi Uma Musume ƒë·∫ßu ti√™n',
          completionText: 'T√¨nh b·∫°n m·ªõi b·∫Øt ƒë·∫ßu t·ª´ ƒë√¢y',
          quality: 'Ph·ªï Th√¥ng',
          icon: 'ü§ù',
          requirement: { type: 'mvu', key: 'umaMusume', operator: 'count_>=', value: 1 },
        },
        {
          id: 'popular_trainer',
          name: 'Hu·∫•n Luy·ªán Vi√™n ƒê∆∞·ª£c Y√™u Th√≠ch',
          description: 'Thi·∫øt l·∫≠p li√™n k·∫øt v·ªõi 5 Uma Musume',
          completionText: 'B·∫°n r·∫•t ƒë∆∞·ª£c y√™u th√≠ch trong gi·ªõi Uma Musume',
          quality: 'Hi·∫øm',
          icon: 'üë•',
          requirement: { type: 'mvu', key: 'umaMusume', operator: 'count_>=', value: 5 },
        },
        {
          id: 'harem_master',
          name: 'Vua Harem',
          description: 'Thi·∫øt l·∫≠p li√™n k·∫øt v·ªõi 10 Uma Musume',
          completionText: 'B·∫°n th·ªÉ hi·ªán thi√™n ph√∫ kinh ng∆∞·ªùi trong qu·∫£n l√Ω t√¨nh c·∫£m',
          quality: 'S·ª≠ Thi',
          icon: 'üèÜ',
          requirement: { type: 'mvu', key: 'umaMusume', operator: 'count_>=', value: 10 },
        },
        {
          id: 'beloved_trainer',
          name: 'Hu·∫•n Luy·ªán Vi√™n ƒê∆∞·ª£c Y√™u S√¢u ƒê·∫≠m',
          description: 'ƒê·∫°t ƒê·ªô Thi·ªán C·∫£m tr√™n 80 v·ªõi b·∫•t k·ª≥ Uma Musume n√†o',
          completionText: 'T√¨nh c·∫£m ch√¢n th√†nh v∆∞·ª£t qua m·ªçi gi·ªõi h·∫°n',
          quality: 'Hi·∫øm',
          icon: 'üíï',
          requirement: { type: 'mvu', key: 'umaMusume.*.affection', operator: 'any_>=', value: 80 },
        },
        {
          id: 'perfect_bond',
          name: 'M·ªëi Li√™n K·∫øt Ho√†n H·∫£o',
          description: 'ƒê·∫°t ƒë·ªô thi·ªán c·∫£m t·ªëi ƒëa 100 v·ªõi b·∫•t k·ª≥ Uma Musume n√†o',
          completionText: 'ƒê√¢y l√† m·ªëi quan h·ªá ho√†n h·∫£o nh·∫•t gi·ªØa hu·∫•n luy·ªán vi√™n v√† Uma Musume',
          quality: 'S·ª≠ Thi',
          icon: 'üíñ',
          requirement: { type: 'mvu', key: 'umaMusume.*.affection', operator: 'any_>=', value: 100 },
        },
        {
          id: 'dangerous_obsession',
          name: 'S·ª± M√™ ƒê·∫Øm Nguy Hi·ªÉm',
          description: 'ƒê·ªô ƒë·ªôc chi·∫øm c·ªßa b·∫•t k·ª≥ Uma Musume n√†o ƒë·∫°t tr√™n 80',
          completionText: 'Lo·∫°i t√¨nh c·∫£m n√†y ƒë√£ v∆∞·ª£t qu√° ph·∫°m vi b√¨nh th∆∞·ªùng...',
          quality: 'S·ª≠ Thi',
          icon: 'üîó',
          requirement: { type: 'mvu', key: 'umaMusume.*.possessiveness', operator: 'any_>=', value: 80 },
        },
        {
          id: 'heartbreaker',
          name: 'K·∫ª B·∫°c T√¨nh',
          description: 'Khi·∫øn ƒë·ªô thi·ªán c·∫£m c·ªßa b·∫•t k·ª≥ Uma Musume n√†o gi·∫£m xu·ªëng d∆∞·ªõi 10',
          completionText: 'C√≥ nh·ªØng t·ªïn th∆∞∆°ng m·ªôt khi g√¢y ra th√¨ kh√¥ng th·ªÉ v√£n h·ªìi',
          quality: 'Ph·ªï Th√¥ng',
          icon: 'üíî',
          requirement: { type: 'mvu', key: 'umaMusume.*.affection', operator: 'any_<=', value: 10 },
        },

        {
          id: 'chronic_offender',
          name: 'K·∫ª T√°i Ph·∫°m',
          description: 'S·ªë l·∫ßn vi ph·∫°m ƒë·∫°t 10 l·∫ßn',
          completionText: 'Quy t·∫Øc ƒë·ªëi v·ªõi b·∫°n ch·ªâ l√† l·ªùi khuy√™n',
          quality: 'S·ª≠ Thi',
          icon: 'üî•',
          requirement: { type: 'mvu', key: 'trainer.committedViolationCount', operator: '>=', value: 10 },
        },
        {
          id: 'semester_survivor',
          name: 'Ng∆∞·ªùi S·ªëng S√≥t H·ªçc K·ª≥',
          description: 'S·ªëng s√≥t 90 ng√†y trong h·ªçc vi·ªán',
          completionText: 'B·∫°n ƒë√£ tr·∫£i qua m·ªôt h·ªçc k·ª≥ tr·ªçn v·∫πn',
          quality: 'S·ª≠ Thi',
          icon: 'üìö',
          requirement: { type: 'mvu', key: 'trainer.daysInSchool', operator: '>=', value: 90 },
        },
        {
          id: 'academy_legend',
          name: 'Huy·ªÅn Tho·∫°i H·ªçc Vi·ªán',
          description: 'S·ªëng s√≥t 365 ng√†y trong h·ªçc vi·ªán',
          completionText: 'T√™n c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c ghi nh·ªõ m√£i m√£i trong s·ª≠ s√°ch h·ªçc vi·ªán',
          quality: 'Truy·ªÅn Thuy·∫øt',
          icon: 'üèõÔ∏è',
          requirement: { type: 'mvu', key: 'trainer.daysInSchool', operator: '>=', value: 365 },
        },
      ];

      const ACHIEVEMENT_QUALITIES = {
        'Ph·ªï Th√¥ng': { color: '#8b9dc3', bgColor: 'linear-gradient(135deg, #8b9dc3 0%, #6b7d9c 100%)' },
        'Hi·∫øm': { color: '#4fc3f7', bgColor: 'linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%)' },
        'S·ª≠ Thi': { color: '#ab47bc', bgColor: 'linear-gradient(135deg, #ab47bc 0%, #8e24aa 100%)' },
        'Truy·ªÅn Thuy·∫øt': { color: '#ff9800', bgColor: 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)' },
      };

      class TreisenAchievementSystem {
        constructor() {
          this.achievements = TREISEN_ACHIEVEMENTS;
          this.completedAchievements = [];
        }

        async init() {
          this.bindEvents();
          this.addAnimationStyles();
          try {
            const achievementsData = await this.loadAchievementsFromExtra();
            this.completedAchievements = achievementsData.completed || [];
            console.log(`‚úÖ ƒê√£ t·∫£i ${this.completedAchievements.length} th√†nh t·ª±u ƒë√£ ho√†n th√†nh t·ª´ extra`);
            if (this.completedAchievements.length === 0) {
              const oldData = localStorage.getItem('treisenAchievements');
              if (oldData) {
                try {
                  const oldCompleted = JSON.parse(oldData);
                  if (Array.isArray(oldCompleted) && oldCompleted.length > 0) {
                    console.log('üì¶ Ph√°t hi·ªán d·ªØ li·ªáu th√†nh t·ª±u c≈© trong localStorage, di chuy·ªÉn sang extra...');
                    this.completedAchievements = oldCompleted;
                    await this.saveAchievementsToExtra({
                      completed: this.completedAchievements,
                      custom: [],
                    });
                  }
                } catch (e) {
                  console.warn('‚ö†Ô∏è Di chuy·ªÉn d·ªØ li·ªáu th√†nh t·ª±u localStorage th·∫•t b·∫°i:', e);
                }
              }
            }
            setTimeout(() => {
              const beforeCheck = this.completedAchievements.length;
              this.checkAchievements(true); 
              const afterCheck = this.completedAchievements.length;
              if (afterCheck > beforeCheck) {
                console.log(`üéâ Khi kh·ªüi t·∫°o ph√°t hi·ªán ${afterCheck - beforeCheck} th√†nh t·ª±u m·ªõi`);
              }
            }, 2000);
          } catch (error) {
            console.error('‚ùå Kh·ªüi t·∫°o h·ªá th·ªëng th√†nh t·ª±u th·∫•t b·∫°i:', error);
            this.completedAchievements = JSON.parse(localStorage.getItem('treisenAchievements') || '[]');
          }
        }

        bindEvents() {
          $(document).on('click', '#achievements-btn', () => this.openAchievementModal());
          $(document).on('click', '#achievements-btn-inner', () => this.openAchievementModal());
          $(document).on('click', '#close-achievement-btn', () => this.closeAchievementModal());
          $(document).on('click', '#close-achievement-detail-btn', () => this.closeAchievementDetailModal());
          $(document).on('click', '.achievement-card', e => {
            const achievementId = $(e.currentTarget).data('achievement-id');
            const achievement = this.achievements.find(a => a.id === achievementId);
            if (achievement) this.showAchievementDetail(achievement);
          });
        }

        getMvuValue(key) {
          try {
            const allVars = this.getAllVariables();
            const fullKey = key.startsWith('stat_data.') ? key : `stat_data.${key}`;
            return this.getVariable(allVars, fullKey, null);
          } catch (error) {
            console.warn('ƒê·ªçc bi·∫øn MVU th·∫•t b·∫°i:', key, error);
          }
          return null;
        }

        checkAchievements(delayNotification = false) {
          let newAchievements = [];

          this.achievements.forEach(achievement => {
            if (this.completedAchievements.includes(achievement.id)) return;

            let isCompleted = false;
            const req = achievement.requirement;

            if (req.type === 'mvu') {
              const value = this.getMvuValue(req.key);
              if (value !== null && value !== undefined) {
                switch (req.operator) {
                  case '>=':
                    isCompleted = Number(value) >= req.value;
                    break;
                  case '<=':
                    isCompleted = Number(value) <= req.value;
                    break;
                  case '==':
                    isCompleted = value == req.value;
                    break;
                  case '!=':
                    isCompleted = value != req.value;
                    break;
                  case 'exists':
                    isCompleted = value !== null && value !== undefined;
                    break;
                  case 'count_>=':
                    if (typeof value === 'object' && value !== null) {
                      const count = Object.keys(value).filter(key => !key.startsWith('$')).length;
                      isCompleted = count >= req.value;
                    }
                    break;
                  case 'any_>=':
                    if (typeof value === 'object' && value !== null) {
                      isCompleted = Object.values(value).some(item => {
                        if (typeof item === 'object' && item !== null && item['affection']) {
                          return Number(item['affection']) >= req.value;
                        }
                        return false;
                      });
                    }
                    break;
                  case 'any_<=':
                    if (typeof value === 'object' && value !== null) {
                      isCompleted = Object.values(value).some(item => {
                        if (typeof item === 'object' && item !== null && item['affection']) {
                          return Number(item['affection']) <= req.value;
                        }
                        return false;
                      });
                    }
                    break;
                }
              }
            }

            if (isCompleted) {
              this.completedAchievements.push(achievement.id);
              newAchievements.push(achievement);
              if (delayNotification) {
                setTimeout(
                  () => {
                    this.showAchievementNotification(achievement);
                  },
                  3000 + newAchievements.length * 500,
                ); 
              } else {
                this.showAchievementNotification(achievement);
              }
            }
          });

          if (newAchievements.length > 0) {
            this.saveProgress();
          }
        }

        showAchievementNotification(achievement) {
          const notificationId = `achievement-notification-${Date.now()}`;
          const notification = $(`
              <div class="achievement-notification" id="${notificationId}" style="
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
                color: #2c1810;
                padding: 15px 20px;
                border-radius: 12px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                z-index: 100002;
                display: flex;
                align-items: center;
                gap: 12px;
                max-width: 400px;
                animation: slideInRight 0.5s ease-out;
                border: 2px solid rgba(212, 175, 55, 0.5);
              ">
                <div style="font-size: 2em; flex-shrink: 0;">${achievement.icon}</div>
                <div style="flex: 1;">
                  <div style="font-weight: bold; margin-bottom: 4px; font-size: 1.1em;">üèÜ Th√†nh t·ª±u ƒë·∫°t ƒë∆∞·ª£c!</div>
                  <div style="font-size: 1.2em; margin-bottom: 2px; font-weight: 600;">${achievement.name}</div>
                  <div style="font-size: 0.95em; opacity: 0.9;">${achievement.completionText}</div>
                </div>
                <button class="achievement-notification-close" style="
                  background: rgba(44, 24, 16, 0.2);
                  border: none;
                  border-radius: 50%;
                  width: 28px;
                  height: 28px;
                  color: #2c1810;
                  font-size: 18px;
                  font-weight: bold;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  flex-shrink: 0;
                  transition: all 0.2s;
                  line-height: 1;
                " onmouseover="this.style.background='rgba(44, 24, 16, 0.4)'" onmouseout="this.style.background='rgba(44, 24, 16, 0.2)'">√ó</button>
              </div>
            `);
          notification.find('.achievement-notification-close').on('click', () => {
            notification.fadeOut(300, () => notification.remove());
          });

          $('body').append(notification);
          setTimeout(() => {
            notification.css('animation', 'pulse 1s ease-in-out 3');
          }, 500);
        }

        openAchievementModal() {
          this.checkAchievements();
          this.renderAchievements();
          const modal = document.getElementById('achievement-modal');
          if (modal) {
            const overlay = document.getElementById('teresen-fullscreen-overlay');
            if (overlay && modal.parentNode !== overlay) {
              modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
              overlay.appendChild(modal);
            }
          }
          $('#achievement-modal').show();
        }

        closeAchievementModal() {
          $('#achievement-modal').hide();
        }

        closeAchievementDetailModal() {
          $('#achievement-detail-modal').hide();
        }

        renderAchievements() {
          const completed = this.completedAchievements.length;
          const total = this.achievements.length;
          $('#achievement-progress').text(`ƒê√£ ho√†n th√†nh ${completed}/${total} th√†nh t·ª±u`);

          const grid = $('#achievement-grid');
          grid.empty();

          this.achievements.forEach(achievement => {
            const isCompleted = this.completedAchievements.includes(achievement.id);
            const quality = ACHIEVEMENT_QUALITIES[achievement.quality] || ACHIEVEMENT_QUALITIES['Ph·ªï Th√¥ng'];

            const card = $(`
                <div class="achievement-card ${isCompleted ? 'completed' : 'locked'}" data-achievement-id="${achievement.id}" style="
                  background: ${isCompleted ? 'linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 249, 230, 0.3) 100%)' : 'linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(240, 240, 240, 0.1) 100%)'};
                  border: 3px solid ${isCompleted ? quality.color : 'rgba(139, 105, 20, 0.3)'};
                  border-radius: 14px;
                  padding: 24px 20px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  text-align: center;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  gap: 14px;
                  position: relative;
                  overflow: hidden;
                  ${!isCompleted ? 'opacity: 0.65; filter: grayscale(85%);' : 'box-shadow: 0 6px 20px ' + quality.color + '50, 0 0 0 1px rgba(255,255,255,0.3) inset;'}
                  ${isCompleted ? 'transform: scale(1);' : ''}
                ">
                  ${isCompleted ? '<div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, ' + quality.color + ' 0%, ' + quality.color + '80 100%);"></div>' : ''}
                  <div style="font-size: 3em; ${isCompleted ? 'filter: drop-shadow(0 4px 8px ' + quality.color + '60);' : 'filter: grayscale(100%) drop-shadow(0 2px 4px rgba(0,0,0,0.2));'} transition: transform 0.3s;">${achievement.icon}</div>
                  <div style="font-weight: bold; color: ${isCompleted ? quality.color : '#888'}; font-size: 1.15em; text-shadow: ${isCompleted ? '0 1px 2px rgba(255,255,255,0.5)' : 'none'}; line-height: 1.3;">${achievement.name}</div>
                  <div style="padding: 5px 14px; border-radius: 14px; font-size: 0.88em; font-weight: bold; color: white; background: ${quality.bgColor}; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">${achievement.quality}</div>
                  ${isCompleted ? '<div style="color: #28a745; font-size: 0.95em; font-weight: 600; text-shadow: 0 1px 2px rgba(255,255,255,0.5);">‚úì ƒê√£ ho√†n th√†nh</div>' : '<div style="color: #999; font-size: 0.9em;">Ch∆∞a ho√†n th√†nh</div>'}
                </div>
              `);

            card.hover(
              function () {
                $(this).css('transform', 'translateY(-5px)');
              },
              function () {
                $(this).css('transform', 'translateY(0)');
              },
            );

            grid.append(card);
          });
        }

        showAchievementDetail(achievement) {
          const isCompleted = this.completedAchievements.includes(achievement.id);
          const quality = ACHIEVEMENT_QUALITIES[achievement.quality] || ACHIEVEMENT_QUALITIES['Ph·ªï Th√¥ng'];

          $('#achievement-detail-icon').text(achievement.icon);
          $('#achievement-detail-name').text(achievement.name);
          $('#achievement-detail-quality').css({ background: quality.bgColor }).text(achievement.quality);
          $('#achievement-detail-description').text(achievement.description);

          let reqText = this.getRequirementText(achievement.requirement, isCompleted);
          $('#achievement-detail-req-text').text(reqText);
          $('#achievement-detail-completion-text').text(achievement.completionText);

          const modal = document.getElementById('achievement-detail-modal');
          if (modal) {
            this.ensureModalInOverlay(modal);
          }
          $('#achievement-detail-modal').show();
        }

        getRequirementText(req, isCompleted) {
          if (req.type === 'mvu') {
            const currentValue = this.getMvuValue(req.key);
            const keyName = req.key.split('.').pop().replace('[0]', '');

            let text = '';
            switch (req.operator) {
              case 'exists':
                text = `S·ªü h·ªØu ${keyName}`;
                break;
              case 'count_>=':
                text = `S·ªë l∆∞·ª£ng ${keyName} >= ${req.value}`;
                if (typeof currentValue === 'object' && currentValue !== null) {
                  const count = Object.keys(currentValue).filter(key => !key.startsWith('$')).length;
                  text += ` (Hi·ªán t·∫°i: ${count})`;
                }
                break;
              case 'any_>=':
                text = `ƒê·ªô thi·ªán c·∫£m Uma Musume b·∫•t k·ª≥ >= ${req.value}`;
                if (typeof currentValue === 'object' && currentValue !== null) {
                  const maxFavorability = Math.max(
                    ...Object.values(currentValue).map(item => {
                      if (typeof item === 'object' && item !== null && item['affection']) {
                        return Number(item['affection']);
                      }
                      return 0;
                    }),
                  );
                  text += ` (Cao nh·∫•t: ${maxFavorability})`;
                }
                break;
              case 'any_<=':
                text = `ƒê·ªô thi·ªán c·∫£m Uma Musume b·∫•t k·ª≥ <= ${req.value}`;
                if (typeof currentValue === 'object' && currentValue !== null) {
                  const minFavorability = Math.min(
                    ...Object.values(currentValue).map(item => {
                      if (typeof item === 'object' && item !== null && item['affection']) {
                        return Number(item['affection']);
                      }
                      return 100;
                    }),
                  );
                  text += ` (Th·∫•p nh·∫•t: ${minFavorability})`;
                }
                break;
              default:
                text = `${keyName} ${req.operator} ${req.value}`;
                if (currentValue !== null && currentValue !== undefined) {
                  text += ` (Hi·ªán t·∫°i: ${currentValue})`;
                }
            }

            if (isCompleted) text += ' ‚úì';
            return text;
          }
          return 'ƒêi·ªÅu ki·ªán ch∆∞a bi·∫øt';
        }

        
        async loadAchievementsFromExtra() {
          try {
            if (typeof SillyTavern === 'undefined' || !SillyTavern.chat || SillyTavern.chat.length === 0) {
              console.log('üìù SillyTavern.chat tr·ªëng, tr·∫£ v·ªÅ d·ªØ li·ªáu th√†nh t·ª±u m·∫∑c ƒë·ªãnh');
              return { completed: [], custom: [] };
            }

            const chat = SillyTavern.chat;
            for (let i = chat.length - 1; i >= 0; i--) {
              const msg = chat[i];
              if (msg.extra?.teresen_achievements) {
                const achievements = msg.extra.teresen_achievements;
                console.log(`‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu th√†nh t·ª±u t·ª´ extra.teresen_achievements c·ªßa tin nh·∫Øn th·ª© ${i}`);
                return {
                  completed: Array.isArray(achievements.completed) ? achievements.completed : [],
                  custom: Array.isArray(achievements.custom) ? achievements.custom : [],
                };
              }
            }

            console.log('üìù Kh√¥ng t√¨m th·∫•y extra.teresen_achievements, tr·∫£ v·ªÅ d·ªØ li·ªáu th√†nh t·ª±u m·∫∑c ƒë·ªãnh');
            return { completed: [], custom: [] };
          } catch (error) {
            console.error('‚ùå T·∫£i d·ªØ li·ªáu th√†nh t·ª±u th·∫•t b·∫°i:', error);
            return { completed: [], custom: [] };
          }
        }

        
        async saveAchievementsToExtra(achievements) {
          try {
            if (typeof SillyTavern === 'undefined' || !SillyTavern.chat || SillyTavern.chat.length === 0) {
              console.error('‚ùå Kh√¥ng th·ªÉ l·∫•y b·∫£n ghi tr√≤ chuy·ªán, kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu th√†nh t·ª±u');
              return;
            }

            const lastMessage = SillyTavern.chat[SillyTavern.chat.length - 1];
            if (!lastMessage.extra) {
              lastMessage.extra = {};
            }
            lastMessage.extra.teresen_achievements = {
              completed: Array.isArray(achievements.completed) ? achievements.completed : [],
              custom: Array.isArray(achievements.custom) ? achievements.custom : [],
            };
            if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
              await SillyTavern.saveChat();
              console.log(`‚úÖ ƒê√£ l∆∞u d·ªØ li·ªáu th√†nh t·ª±u v√†o extra.teresen_achievements c·ªßa tin nh·∫Øn cu·ªëi c√πng th√¥ng qua SillyTavern.saveChat()`);
            } else {
              if (typeof TavernHelper !== 'undefined' && TavernHelper.setChatMessages) {
                await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });
                console.log(`‚úÖ ƒê√£ l∆∞u d·ªØ li·ªáu th√†nh t·ª±u v√†o extra.teresen_achievements c·ªßa tin nh·∫Øn cu·ªëi c√πng th√¥ng qua setChatMessages`);
              }
            }
          } catch (error) {
            console.error('‚ùå L∆∞u d·ªØ li·ªáu th√†nh t·ª±u th·∫•t b·∫°i:', error);
          }
        }

        saveProgress() {
          const achievementsData = {
            completed: this.completedAchievements,
            custom: [], 
          };
          this.saveAchievementsToExtra(achievementsData).catch(error => {
            console.error('‚ùå L∆∞u th√†nh t·ª±u v√†o extra th·∫•t b·∫°i, quay l·∫°i localStorage:', error);
            localStorage.setItem('treisenAchievements', JSON.stringify(this.completedAchievements));
          });
        }

        addAnimationStyles() {
          if (!document.getElementById('achievement-animations')) {
            const style = document.createElement('style');
            style.id = 'achievement-animations';
            style.textContent = `
                @keyframes slideInRight {
                  from { transform: translateX(100%); opacity: 0; }
                  to { transform: translateX(0); opacity: 1; }
                }
              `;
            document.head.appendChild(style);
          }
        }
      }
    </script>
  </body>
</html>

